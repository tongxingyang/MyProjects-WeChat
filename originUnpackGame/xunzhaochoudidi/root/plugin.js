	define("__plugin__/wx70d8aa25ec591f7a", function(require, module, exports){			
module.exports = require('wx70d8aa25ec591f7a/index.js'); 
 			});
 		define("__plugin__/wx70d8aa25ec591f7a/index.js", function(require, module, exports){ 			
!function(){"use strict";require("./laya.core.js"),require("./laya.ani.js"),require("./laya.ui.js"),require("./laya.tiledmap.js"),require("./laya.d3.js"),require("./laya.html.js"),require("./laya.particle.js"),require("./laya.physics_o.js")}(); 
 			}); 
		define("__plugin__/wx70d8aa25ec591f7a/laya.ani.js", function(require, module, exports){ 			
!function(){"use strict";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}function e(t,i,a){return(e="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){var a=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=r(t)););return t}(t,e);if(a){var s=Object.getOwnPropertyDescriptor(a,e);return s.get?s.get.call(i):s.value}})(t,i,a||t)}function i(e,i){return!i||"object"!==t(i)&&"function"!=typeof i?a(e):i}function a(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function r(t){return(r=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function s(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&function(t,e){(Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}(t,e)}function n(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function h(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}function l(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}!function(t,n){var o=function t(){l(this,t)};o.Skeleton=null,o.AnimationTemplet=null,o.Templet=null;var u=function t(){l(this,t)},c=function t(){l(this,t)},p=function t(){l(this,t)},_=function(){function t(){l(this,t)}return h(t,null,[{key:"parse",value:function(t,e){var i,a,r,s,h,l,_,d=e.__getBuffer(),f=e.readUTFString();t._aniClassName=f;var y,m=e.readUTFString().split("\n"),g=e.getUint8(),v=e.getUint32(),x=e.getUint32();v>0&&(y=d.slice(v,x));var M=new n.Byte(y);for(x>0&&(t._publicExtData=d.slice(x,d.byteLength)),t._useParent=!!e.getUint8(),t._anis.length=g,i=0;i<g;i++){var D=t._anis[i]=new u;D.nodes=[];var k=D.name=m[e.getUint16()];t._aniMap[k]=i,D.bone3DMap={},D.playTime=e.getFloat32();var I=D.nodes.length=e.getUint8();for(D.totalKeyframeDatasLength=0,a=0;a<I;a++){var A=D.nodes[a]=new c;A.childs=[];var S=e.getInt16();S>=0&&(A.name=m[S],D.bone3DMap[A.name]=a),A.keyFrame=[],A.parentIndex=e.getInt16(),-1==A.parentIndex?A.parent=null:A.parent=D.nodes[A.parentIndex],A.lerpType=e.getUint8();var b=e.getUint32();M.pos=b;var T=A.keyframeWidth=M.getUint16();if(D.totalKeyframeDatasLength+=T,0===A.lerpType||1===A.lerpType)for(A.interpolationMethod=[],A.interpolationMethod.length=T,r=0;r<T;r++)A.interpolationMethod[r]=o.AnimationTemplet.interpolation[M.getUint8()];null!=A.parent&&A.parent.childs.push(A);var C=e.getUint16();C>0&&(A.extenData=d.slice(e.pos,e.pos+C),e.pos+=C);var F=e.getUint16();A.keyFrame.length=F;var w,P=0;for(r=0,s=F;r<s;r++){if((w=A.keyFrame[r]=new p).duration=e.getFloat32(),w.startTime=P,2===A.lerpType){w.interpolationData=[];var L,U=e.getUint8();switch(L=e.getFloat32()){case 254:for(w.interpolationData.length=T,_=0;_<T;_++)w.interpolationData[_]=0;break;case 255:for(w.interpolationData.length=T,_=0;_<T;_++)w.interpolationData[_]=5;break;default:for(w.interpolationData.push(L),l=1;l<U;l++)w.interpolationData.push(e.getFloat32())}}for(w.data=new Float32Array(T),w.dData=new Float32Array(T),w.nextData=new Float32Array(T),h=0;h<T;h++)w.data[h]=e.getFloat32(),w.data[h]>-1e-8&&w.data[h]<1e-8&&(w.data[h]=0);P+=w.duration}w.startTime=D.playTime,A.playTime=D.playTime,t._calculateKeyFrame(A,F,T)}}}}]),t}(),d=function(){function t(){l(this,t)}return h(t,null,[{key:"READ_DATA",value:function(){t._DATA.offset=t._reader.getUint32(),t._DATA.size=t._reader.getUint32()}},{key:"READ_BLOCK",value:function(){for(var e=t._BLOCK.count=t._reader.getUint16(),i=t._BLOCK.blockStarts=[],a=t._BLOCK.blockLengths=[],r=0;r<e;r++)i.push(t._reader.getUint32()),a.push(t._reader.getUint32())}},{key:"READ_STRINGS",value:function(){var e=t._reader.getUint32(),i=t._reader.getUint16(),a=t._reader.pos;t._reader.pos=e+t._DATA.offset;for(var r=0;r<i;r++)t._strings[r]=t._reader.readUTFString();t._reader.pos=a}},{key:"parse",value:function(e,i){t._templet=e,t._reader=i,i.__getBuffer(),t.READ_DATA(),t.READ_BLOCK(),t.READ_STRINGS();for(var a=0,r=t._BLOCK.count;a<r;a++){var s=i.getUint16(),n=t._strings[s],h=t["READ_"+n];if(null==h)throw new Error("model file err,no this function:"+s+" "+n);h.call(null)}}},{key:"READ_ANIMATIONS",value:function(){var e,i,a,r,s=t._reader,n=s.__getBuffer(),h=s.getUint16(),l=[];for(l.length=h,e=0;e<h;e++)l[e]=o.AnimationTemplet.interpolation[s.getByte()];var _=s.getUint8();for(t._templet._anis.length=_,e=0;e<_;e++){var d=t._templet._anis[e]=new u;d.nodes=[];var f=d.name=t._strings[s.getUint16()];t._templet._aniMap[f]=e,d.bone3DMap={},d.playTime=s.getFloat32();var y=d.nodes.length=s.getInt16();for(d.totalKeyframeDatasLength=0,i=0;i<y;i++){var m=d.nodes[i]=new c;m.keyframeWidth=h,m.childs=[];var g=s.getUint16();g>=0&&(m.name=t._strings[g],d.bone3DMap[m.name]=i),m.keyFrame=[],m.parentIndex=s.getInt16(),-1==m.parentIndex?m.parent=null:m.parent=d.nodes[m.parentIndex],d.totalKeyframeDatasLength+=h,m.interpolationMethod=l,null!=m.parent&&m.parent.childs.push(m);var v=s.getUint16();m.keyFrame.length=v;var x=null,M=null;for(a=0,r=v;a<r;a++){(x=m.keyFrame[a]=new p).startTime=s.getFloat32(),M&&(M.duration=x.startTime-M.startTime),x.dData=new Float32Array(h),x.nextData=new Float32Array(h);var D=t._DATA.offset,k=s.getUint32(),I=4*h,A=n.slice(D+k,D+k+I);x.data=new Float32Array(A),M=x}x.duration=0,m.playTime=d.playTime,t._templet._calculateKeyFrame(m,v,h)}}}}]),t}();d._strings=[],d._BLOCK={count:0},d._DATA={offset:0,size:0};var f=function t(){l(this,t)};f.stopped=0,f.paused=1,f.playing=2;var y=function(t){function e(){var t;return l(this,e),(t=i(this,r(e).call(this))).isCache=!0,t.playbackRate=1,t._destroyed=!1,t._currentAnimationClipIndex=-1,t._currentKeyframeIndex=-1,t._currentTime=0,t._overallDuration=Number.MAX_VALUE,t._stopWhenCircleFinish=!1,t._elapsedPlaybackTime=0,t._startUpdateLoopCount=-1,t._cachePlayRate=1,t.cacheFrameRate=60,t.returnToZeroStopped=!1,t}return s(e,n.EventDispatcher),h(e,[{key:"_onTempletLoadedComputeFullKeyframeIndices",value:function(t,e,i){this._templet===i&&this._cachePlayRate===t&&this._cacheFrameRate===e&&this._computeFullKeyframeIndices()}},{key:"_computeFullKeyframeIndices",value:function(){}},{key:"_onAnimationTempletLoaded",value:function(){this.destroyed||this._calculatePlayDuration()}},{key:"_calculatePlayDuration",value:function(){if(this.state!==f.stopped){var t=this._templet.getAniDuration(this._currentAnimationClipIndex);0===this._playEnd&&(this._playEnd=t),this._playEnd>t&&(this._playEnd=t),this._playDuration=this._playEnd-this._playStart}}},{key:"_setPlayParams",value:function(t,e){this._currentTime=t,this._currentKeyframeIndex=Math.floor(this.currentPlayTime/e+.01),this._currentFrameTime=this._currentKeyframeIndex*e}},{key:"_setPlayParamsWhenStop",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;this._currentTime=t;var a=i>0?i:t;this._currentKeyframeIndex=Math.floor(a/e+.01),this._currentKeyframeIndex=Math.floor(t/e+.01),this._currentFrameTime=this._currentKeyframeIndex*e,this._currentAnimationClipIndex=-1}},{key:"_update",value:function(t){if(-1!==this._currentAnimationClipIndex&&!this._paused&&this._templet){var e=this._cacheFrameRateInterval*this._cachePlayRate,i=0;this._startUpdateLoopCount!==n.Stat.loopCount&&(i=t*this.playbackRate,this._elapsedPlaybackTime+=i);var a=this.playDuration;if(i+=this._currentTime,0!==this._overallDuration&&this._elapsedPlaybackTime>=this._overallDuration||0===this._overallDuration&&this._elapsedPlaybackTime>=a||0===this._overallDuration&&i>=this.playEnd)return this._setPlayParamsWhenStop(a,e,this.playEnd),void this.event(n.Event.STOPPED);if(a>0){if(i>=a)return this._stopWhenCircleFinish?(this._setPlayParamsWhenStop(a,e),this._stopWhenCircleFinish=!1,void this.event(n.Event.STOPPED)):(i%=a,this._setPlayParams(i,e),void this.event(n.Event.COMPLETE));this._setPlayParams(i,e)}else{if(this._stopWhenCircleFinish)return this._setPlayParamsWhenStop(a,e),this._stopWhenCircleFinish=!1,void this.event(n.Event.STOPPED);this._currentTime=this._currentFrameTime=this._currentKeyframeIndex=0,this.event(n.Event.COMPLETE)}}}},{key:"_destroy",value:function(){this.offAll(),this._templet=null,this._destroyed=!0}},{key:"play",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2147483647,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;if(!this._templet)throw new Error("AnimationPlayer:templet must not be null,maybe you need to set url.");if(i<0||a<0||r<0)throw new Error("AnimationPlayer:overallDuration,playStart and playEnd must large than zero.");if(0!==r&&a>r)throw new Error("AnimationPlayer:start must less than end.");this._currentTime=0,this._currentFrameTime=0,this._elapsedPlaybackTime=0,this.playbackRate=e,this._overallDuration=i,this._playStart=a,this._playEnd=r,this._paused=!1,this._currentAnimationClipIndex=t,this._currentKeyframeIndex=0,this._startUpdateLoopCount=n.Stat.loopCount,this.event(n.Event.PLAYED),this._calculatePlayDuration(),this._update(0)}},{key:"playByFrame",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2147483647,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=1e3/(arguments.length>5&&void 0!==arguments[5]?arguments[5]:30);this.play(t,e,i,a*s,r*s)}},{key:"stop",value:function(){!(arguments.length>0&&void 0!==arguments[0])||arguments[0]?(this._currentTime=this._currentFrameTime=this._currentKeyframeIndex=0,this._currentAnimationClipIndex=-1,this.event(n.Event.STOPPED)):this._stopWhenCircleFinish=!0}},{key:"destroy",value:function(){}},{key:"templet",get:function(){return this._templet},set:function(t){this.state!==f.stopped&&this.stop(!0),this._templet!==t&&(this._templet=t,this._computeFullKeyframeIndices())}},{key:"playStart",get:function(){return this._playStart}},{key:"playEnd",get:function(){return this._playEnd}},{key:"playDuration",get:function(){return this._playDuration}},{key:"overallDuration",get:function(){return this._overallDuration}},{key:"currentAnimationClipIndex",get:function(){return this._currentAnimationClipIndex}},{key:"currentKeyframeIndex",get:function(){return this._currentKeyframeIndex}},{key:"currentPlayTime",get:function(){return this._currentTime+this._playStart}},{key:"currentFrameTime",get:function(){return this._currentFrameTime}},{key:"cachePlayRate",get:function(){return this._cachePlayRate},set:function(t){this._cachePlayRate!==t&&(this._cachePlayRate=t,this._templet&&this._computeFullKeyframeIndices())}},{key:"cacheFrameRate",get:function(){return this._cacheFrameRate},set:function(t){this._cacheFrameRate!==t&&(this._cacheFrameRate=t,this._cacheFrameRateInterval=1e3/this._cacheFrameRate,this._templet&&this._computeFullKeyframeIndices())}},{key:"currentTime",set:function(t){if(-1!==this._currentAnimationClipIndex&&this._templet){if(t<this._playStart||t>this._playEnd)throw new Error("AnimationPlayer:value must large than playStartTime,small than playEndTime.");this._startUpdateLoopCount=n.Stat.loopCount;var e=this._cacheFrameRateInterval*this._cachePlayRate;this._currentTime=t,this._currentKeyframeIndex=Math.floor(this.currentPlayTime/e),this._currentFrameTime=this._currentKeyframeIndex*e}}},{key:"paused",get:function(){return this._paused},set:function(t){this._paused=t,t&&this.event(n.Event.PAUSED)}},{key:"cacheFrameRateInterval",get:function(){return this._cacheFrameRateInterval}},{key:"state",get:function(){return-1===this._currentAnimationClipIndex?f.stopped:this._paused?f.paused:f.playing}},{key:"destroyed",get:function(){return this._destroyed}}]),e}(),m=function(){function t(){l(this,t)}return h(t,null,[{key:"getBezierRate",value:function(e,i,a,r,s){var n=t._getBezierParamKey(i,a,r,s),h=100*n+e;if(t._bezierResultCache[h])return t._bezierResultCache[h];var l,o,u=t._getBezierPoints(i,a,r,s,n);for(o=u.length,l=0;l<o;l+=2)if(e<=u[l])return t._bezierResultCache[h]=u[l+1],u[l+1];return t._bezierResultCache[h]=1,1}},{key:"_getBezierParamKey",value:function(t,e,i,a){return 100*(100*(100*(100*t+e)+i)+a)}},{key:"_getBezierPoints",value:function(e,i,a,r,s){return t._bezierPointsCache[s]?t._bezierPointsCache[s]:(h=[0,0,e,i,a,r,1,1],l=(new n.Bezier).getBezierPoints(h,100,3),t._bezierPointsCache[s]=l,l);var h,l}}]),t}();m._bezierResultCache={},m._bezierPointsCache={};var g=function(t){function e(){var t;return l(this,e),(t=i(this,r(e).call(this)))._anis=[],t._aniMap={},t.unfixedLastAniIndex=-1,t._fullFrames=null,t._boneCurKeyFrm=[],t}return s(e,n.Resource),h(e,[{key:"parse",value:function(t){var e=new n.Byte(t);this._aniVersion=e.readUTFString(),_.parse(this,e)}},{key:"_calculateKeyFrame",value:function(t,e,i){var a=t.keyFrame;a[e]=a[0];for(var r=0;r<e;r++)for(var s=a[r],n=0;n<i;n++)s.dData[n]=0===s.duration?0:(a[r+1].data[n]-s.data[n])/s.duration,s.nextData[n]=a[r+1].data[n];a.length--}},{key:"_onAsynLoaded",value:function(t){arguments.length>1&&void 0!==arguments[1]&&arguments[1];var e=new n.Byte(t);switch(this._aniVersion=e.readUTFString(),this._aniVersion){case"LAYAANIMATION:02":d.parse(this,e);break;default:_.parse(this,e)}}},{key:"getAnimationCount",value:function(){return this._anis.length}},{key:"getAnimation",value:function(t){return this._anis[t]}},{key:"getAniDuration",value:function(t){return this._anis[t].playTime}},{key:"getNodes",value:function(t){return this._anis[t].nodes}},{key:"getNodeIndexWithName",value:function(t,e){return this._anis[t].bone3DMap[e]}},{key:"getNodeCount",value:function(t){return this._anis[t].nodes.length}},{key:"getTotalkeyframesLength",value:function(t){return this._anis[t].totalKeyframeDatasLength}},{key:"getPublicExtData",value:function(){return this._publicExtData}},{key:"getAnimationDataWithCache",value:function(t,e,i,a){var r=e[i];if(r){var s=r[t];return s?s[a]:null}return null}},{key:"setAnimationDataWithCache",value:function(t,e,i,a,r){var s=e[i]||(e[i]={});(s[t]||(s[t]=[]))[a]=r}},{key:"getNodeKeyFrame",value:function(t,e,i){var a=this._boneCurKeyFrm[e],r=t.length;(null==a||a>=r)&&(a=this._boneCurKeyFrm[e]=0);var s=t[a],n=i-s.startTime;if(0==n||n>0&&s.duration>n)return a;var h=0;if(n>0){for(i+=.01,h=a+1;h<r;h++)if((s=t[h]).startTime<=i&&s.startTime+s.duration>i)return this._boneCurKeyFrm[e]=h,h;return r-1}for(h=0;h<a;h++)if((s=t[h]).startTime<=i&&s.startTime+s.duration>i)return this._boneCurKeyFrm[e]=h,h;return a}},{key:"getOriginalData",value:function(t,i,a,r,s){var n=this._anis[t].nodes,h=this._boneCurKeyFrm;h.length<n.length&&(h.length=n.length);for(var l=0,o=0,u=n.length,c=0;o<u;o++){var p,_=n[o],d=_.keyFrame;p=d[this.getNodeKeyFrame(d,o,s)],_.dataOffset=c;var f=s-p.startTime,y=_.lerpType;if(y)switch(y){case 0:case 1:for(l=0;l<_.keyframeWidth;)l+=_.interpolationMethod[l](_,l,i,c+l,p.data,f,p.dData,p.duration,p.nextData);break;case 2:var m=p.interpolationData,g=m.length,v=0;for(l=0;l<g;){var x=m[l];switch(x){case 6:case 7:l+=e.interpolation[x](_,v,i,c+v,p.data,f,p.dData,p.duration,p.nextData,m,l+1);break;default:l+=e.interpolation[x](_,v,i,c+v,p.data,f,p.dData,p.duration,p.nextData)}v++}}else for(l=0;l<_.keyframeWidth;)l+=_.interpolationMethod[l](_,l,i,c+l,p.data,f,p.dData,p.duration,p.nextData);c+=_.keyframeWidth}}},{key:"getNodesCurrentFrameIndex",value:function(t,e){var i=this._anis[t].nodes;t!==this.unfixedLastAniIndex&&(this.unfixedCurrentFrameIndexes=new Uint32Array(i.length),this.unfixedCurrentTimes=new Float32Array(i.length),this.unfixedLastAniIndex=t);for(var a=0,r=i.length;a<r;a++){var s=i[a];for(e<this.unfixedCurrentTimes[a]&&(this.unfixedCurrentFrameIndexes[a]=0),this.unfixedCurrentTimes[a]=e;this.unfixedCurrentFrameIndexes[a]<s.keyFrame.length&&!(s.keyFrame[this.unfixedCurrentFrameIndexes[a]].startTime>this.unfixedCurrentTimes[a]);)this.unfixedCurrentFrameIndexes[a]++;this.unfixedCurrentFrameIndexes[a]--}return this.unfixedCurrentFrameIndexes}},{key:"getOriginalDataUnfixedRate",value:function(t,i,a){var r=this._anis[t].nodes;t!==this.unfixedLastAniIndex&&(this.unfixedCurrentFrameIndexes=new Uint32Array(r.length),this.unfixedCurrentTimes=new Float32Array(r.length),this.unfixedKeyframes=[],this.unfixedLastAniIndex=t);for(var s=0,n=0,h=r.length,l=0;n<h;n++){var o=r[n];for(a<this.unfixedCurrentTimes[n]&&(this.unfixedCurrentFrameIndexes[n]=0),this.unfixedCurrentTimes[n]=a;this.unfixedCurrentFrameIndexes[n]<o.keyFrame.length&&!(o.keyFrame[this.unfixedCurrentFrameIndexes[n]].startTime>this.unfixedCurrentTimes[n]);)this.unfixedKeyframes[n]=o.keyFrame[this.unfixedCurrentFrameIndexes[n]],this.unfixedCurrentFrameIndexes[n]++;var u=this.unfixedKeyframes[n];o.dataOffset=l;var c=a-u.startTime;if(o.lerpType)switch(o.lerpType){case 0:case 1:for(s=0;s<o.keyframeWidth;)s+=o.interpolationMethod[s](o,s,i,l+s,u.data,c,u.dData,u.duration,u.nextData);break;case 2:var p=u.interpolationData,_=p.length,d=0;for(s=0;s<_;){var f=p[s];switch(f){case 6:case 7:s+=e.interpolation[f](o,d,i,l+d,u.data,c,u.dData,u.duration,u.nextData,p,s+1);break;default:s+=e.interpolation[f](o,d,i,l+d,u.data,c,u.dData,u.duration,u.nextData)}d++}}else for(s=0;s<o.keyframeWidth;)s+=o.interpolationMethod[s](o,s,i,l+s,u.data,c,u.dData,u.duration,u.nextData);l+=o.keyframeWidth}}}],[{key:"_LinearInterpolation_0",value:function(t,e,i,a,r,s,n,h,l){return arguments.length>9&&void 0!==arguments[9]&&arguments[9],i[a]=r[e]+s*n[e],1}},{key:"_QuaternionInterpolation_1",value:function(t,e,i,a,r,s,h,l,o){arguments.length>9&&void 0!==arguments[9]&&arguments[9];var u=0===l?0:s/l;return n.MathUtil.slerpQuaternionArray(r,e,o,e,u,i,a),4}},{key:"_AngleInterpolation_2",value:function(t,e,i,a,r,s,n,h,l){return arguments.length>9&&void 0!==arguments[9]&&arguments[9],0}},{key:"_RadiansInterpolation_3",value:function(t,e,i,a,r,s,n,h,l){return arguments.length>9&&void 0!==arguments[9]&&arguments[9],0}},{key:"_Matrix4x4Interpolation_4",value:function(t,e,i,a,r,s,n,h,l){arguments.length>9&&void 0!==arguments[9]&&arguments[9];for(var o=0;o<16;o++,e++)i[a+o]=r[e]+s*n[e];return 16}},{key:"_NoInterpolation_5",value:function(t,e,i,a,r,s,n,h,l){return arguments.length>9&&void 0!==arguments[9]&&arguments[9],i[a]=r[e],1}},{key:"_BezierInterpolation_6",value:function(t,e,i,a,r,s,n,h,l){var o=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,u=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0;return i[a]=r[e]+(l[e]-r[e])*m.getBezierRate(s/h,o[u],o[u+1],o[u+2],o[u+3]),5}},{key:"_BezierInterpolation_7",value:function(t,e,i,a,r,s,n,h,l){var o=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,u=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0;return i[a]=o[u+4]+o[u+5]*m.getBezierRate((.001*s+o[u+6])/o[u+7],o[u],o[u+1],o[u+2],o[u+3]),9}}]),e}();g.interpolation=[g._LinearInterpolation_0,g._QuaternionInterpolation_1,g._AngleInterpolation_2,g._RadiansInterpolation_3,g._Matrix4x4Interpolation_4,g._NoInterpolation_5,g._BezierInterpolation_6,g._BezierInterpolation_7],o.AnimationTemplet=g;var v=function(t){function e(){return l(this,e),i(this,r(e).apply(this,arguments))}return s(e,n.Graphics),h(e,[{key:"drawSkin",value:function(t,e){this.drawTriangles(t.texture,0,0,t.vertices,t.uvs,t.indexes,t.transform||n.Matrix.EMPTY,e)}}],[{key:"create",value:function(){return e._caches.pop()||new e}},{key:"recycle",value:function(t){t.clear(),e._caches.push(t)}}]),e}();v._caches=[];var x=function(){function t(){l(this,t),this.skX=0,this.skY=0,this.scX=1,this.scY=1,this.x=0,this.y=0,this.skewX=0,this.skewY=0}return h(t,[{key:"initData",value:function(t){null!=t.x&&(this.x=t.x),null!=t.y&&(this.y=t.y),null!=t.skX&&(this.skX=t.skX),null!=t.skY&&(this.skY=t.skY),null!=t.scX&&(this.scX=t.scX),null!=t.scY&&(this.scY=t.scY)}},{key:"getMatrix",value:function(){var t;return(t=this.mMatrix?this.mMatrix:this.mMatrix=new n.Matrix).identity(),t.scale(this.scX,this.scY),(this.skewX||this.skewY)&&this.skew(t,this.skewX*Math.PI/180,this.skewY*Math.PI/180),t.rotate(this.skX*Math.PI/180),t.translate(this.x,this.y),t}},{key:"skew",value:function(t,e,i){var a=Math.sin(i),r=Math.cos(i),s=Math.sin(e),n=Math.cos(e);return t.setTo(t.a*n-t.b*a,t.a*s+t.b*r,t.c*n-t.d*a,t.c*s+t.d*r,t.tx*n-t.ty*a,t.tx*s+t.ty*r),t}}]),t}(),M=function(){function t(){l(this,t),this.length=10,this.resultTransform=new x,this.resultMatrix=new n.Matrix,this.inheritScale=!0,this.inheritRotation=!0,this.d=-1,this._children=[]}return h(t,[{key:"setTempMatrix",value:function(t){this._tempMatrix=t;var e,i=0;for(i=0,e=this._children.length;i<e;i++)this._children[i].setTempMatrix(this._tempMatrix)}},{key:"update",value:function(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(this.rotation=this.transform.skX,e)t=this.resultTransform.getMatrix(),n.Matrix.mul(t,e,this.resultMatrix),this.resultRotation=this.rotation;else if(this.resultRotation=this.rotation+this.parentBone.resultRotation,this.parentBone)if(this.inheritRotation&&this.inheritScale)t=this.resultTransform.getMatrix(),n.Matrix.mul(t,this.parentBone.resultMatrix,this.resultMatrix);else{var i,a,r,s=this.parentBone,h=this.parentBone.resultMatrix;t=this.resultTransform.getMatrix();var l=h.a*t.tx+h.c*t.ty+h.tx,o=h.b*t.tx+h.d*t.ty+h.ty,u=new n.Matrix;this.inheritRotation?(i=Math.atan2(s.resultMatrix.b,s.resultMatrix.a),a=Math.cos(i),r=Math.sin(i),u.setTo(a,r,-r,a,0,0),n.Matrix.mul(this._tempMatrix,u,n.Matrix.TEMP),n.Matrix.TEMP.copyTo(u),t=this.resultTransform.getMatrix(),n.Matrix.mul(t,u,this.resultMatrix),this.resultTransform.scX*this.resultTransform.scY<0&&this.resultMatrix.rotate(.5*Math.PI),this.resultMatrix.tx=l,this.resultMatrix.ty=o):(this.inheritScale,t=this.resultTransform.getMatrix(),n.Matrix.TEMP.identity(),n.Matrix.TEMP.d=this.d,n.Matrix.mul(t,n.Matrix.TEMP,this.resultMatrix),this.resultMatrix.tx=l,this.resultMatrix.ty=o)}else(t=this.resultTransform.getMatrix()).copyTo(this.resultMatrix);var c,p=0;for(p=0,c=this._children.length;p<c;p++)this._children[p].update()}},{key:"updateChild",value:function(){var t,e=0;for(e=0,t=this._children.length;e<t;e++)this._children[e].update()}},{key:"setRotation",value:function(t){this._sprite&&(this._sprite.rotation=180*t/Math.PI)}},{key:"updateDraw",value:function(e,i){t.ShowBones&&!t.ShowBones[this.name]||(this._sprite?(this._sprite.x=e+this.resultMatrix.tx,this._sprite.y=i+this.resultMatrix.ty):(this._sprite=new n.Sprite,this._sprite.graphics.drawCircle(0,0,5,"#ff0000"),this._sprite.graphics.drawLine(0,0,this.length,0,"#00ff00"),this._sprite.graphics.fillText(this.name,0,0,"20px Arial","#00ff00","center"),n.ILaya.stage.addChild(this._sprite),this._sprite.x=e+this.resultMatrix.tx,this._sprite.y=i+this.resultMatrix.ty));var a,r=0;for(r=0,a=this._children.length;r<a;r++)this._children[r].updateDraw(e,i)}},{key:"addChild",value:function(t){this._children.push(t),t.parentBone=this}},{key:"findBone",value:function(t){if(this.name==t)return this;var e,i,a;for(e=0,i=this._children.length;e<i;e++)if(a=this._children[e].findBone(t))return a;return null}},{key:"localToWorld",value:function(t){var e=t[0],i=t[1];t[0]=e*this.resultMatrix.a+i*this.resultMatrix.c+this.resultMatrix.tx,t[1]=e*this.resultMatrix.b+i*this.resultMatrix.d+this.resultMatrix.ty}}]),t}();M.ShowBones={};var D=function(){function t(){l(this,t)}return h(t,null,[{key:"getRelativeUV",value:function(t,e){var i,a,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=t[0],n=t[2]-t[0],h=t[1],l=t[5]-t[1];r||(r=[]),r.length=e.length,a=r.length;var o=1/n,u=1/l;for(i=0;i<a;i+=2)r[i]=(e[i]-s)*o,r[i+1]=(e[i+1]-h)*u;return r}},{key:"getAbsoluteUV",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(0==t[0]&&0==t[1]&&1==t[4]&&1==t[5])return i?(n.Utils.copyArray(i,e),i):e;var a,r,s=t[0],h=t[2]-t[0],l=t[1],o=t[5]-t[1];for(i||(i=[]),i.length=e.length,r=i.length,a=0;a<r;a+=2)i[a]=e[a]*h+s,i[a+1]=e[a+1]*o+l;return i}}]),t}(),k=function(){function t(){l(this,t),this.uvs=new Float32Array([0,0,1,0,1,1,0,1]),this.vertices=new Float32Array([0,0,100,0,100,100,0,100]),this.indexes=new Uint16Array([0,1,3,3,1,2]),this.useUvTransform=!1,this.canvasPadding=1}return h(t,[{key:"getBounds",value:function(){return n.Rectangle._getWrapRec(this.vertices)}}]),t}(),I=function(t){function e(){return l(this,e),i(this,r(e).call(this))}return s(e,k),h(e,[{key:"init2",value:function(t,e,i,a){this.transform&&(this.transform=null);var r=e||[0,1,3,3,1,2];this.texture=t,this.indexes=new Uint16Array(r),this.vertices=new Float32Array(i),this.uvs=new Float32Array(a)}}]),e}(),A=function(){function t(){l(this,t),this.srcDisplayIndex=-1,this.type="src",this.displayIndex=-1,this.originalIndex=-1,this._replaceDic={}}return h(t,[{key:"showSlotData",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.currSlotData=t,e&&(this.displayIndex=this.srcDisplayIndex),this.currDisplayData=null,this.currTexture=null}},{key:"showDisplayByName",value:function(t){this.currSlotData&&this.showDisplayByIndex(this.currSlotData.getDisplayByName(t))}},{key:"replaceDisplayByName",value:function(t,e){var i,a;this.currSlotData&&(i=this.currSlotData.getDisplayByName(t),a=this.currSlotData.getDisplayByName(e),this.replaceDisplayByIndex(i,a))}},{key:"replaceDisplayByIndex",value:function(t,e){this.currSlotData&&(this._replaceDic[t]=e,this.originalIndex==t&&this.showDisplayByIndex(t))}},{key:"showDisplayByIndex",value:function(t){if(this.originalIndex=t,null!=this._replaceDic[t]&&(t=this._replaceDic[t]),this.currSlotData&&t>-1&&t<this.currSlotData.displayArr.length){if(this.displayIndex=t,this.currDisplayData=this.currSlotData.displayArr[t],this.currDisplayData){var e=this.currDisplayData.name;this.currTexture=this.templet.getTexture(e),this.currTexture&&0==this.currDisplayData.type&&this.currDisplayData.uvs&&(this.currTexture=this.currDisplayData.createTexture(this.currTexture))}}else this.displayIndex=-1,this.currDisplayData=null,this.currTexture=null}},{key:"replaceSkin",value:function(t){this._diyTexture=t,this._curDiyUV&&(this._curDiyUV.length=0),this.currDisplayData&&this._diyTexture==this.currDisplayData.texture&&(this._diyTexture=null)}},{key:"setParentMatrix",value:function(t){this._parentMatrix=t}},{key:"getSaveVerticle",value:function(e){return t.useSameMatrixAndVerticle&&this._preGraphicVerticle&&t.isSameArr(e,this._preGraphicVerticle)?e=this._preGraphicVerticle:(e=n.ILaya.Utils.copyArray([],e),this._preGraphicVerticle=e),e}},{key:"getSaveMatrix",value:function(e){if(t.useSameMatrixAndVerticle&&this._preGraphicMatrix&&t.isSameMatrix(e,this._preGraphicMatrix))e=this._preGraphicMatrix;else{var i=e.clone();e=i,this._preGraphicMatrix=e}return e}},{key:"draw",value:function(e,i){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;if((null!=this._diyTexture||null!=this.currTexture)&&null!=this.currDisplayData||this.currDisplayData&&3==this.currDisplayData.type){var s,h=this.currTexture;switch(this._diyTexture&&(h=this._diyTexture),this.currDisplayData.type){case 0:if(e){var l=this.getDisplayMatrix();if(this._parentMatrix){var o=!1;if(l){var u;if(n.Matrix.mul(l,this._parentMatrix,n.Matrix.TEMP),a?(null==this._resultMatrix&&(this._resultMatrix=new n.Matrix),u=this._resultMatrix):u=t._tempResultMatrix,this._diyTexture&&this.currDisplayData.uvs){var c=t._tempMatrix;c.identity(),this.currDisplayData.uvs[1]>this.currDisplayData.uvs[5]&&(c.d=-1),this.currDisplayData.uvs[0]>this.currDisplayData.uvs[4]&&this.currDisplayData.uvs[1]>this.currDisplayData.uvs[5]&&(o=!0,c.rotate(-Math.PI/2)),n.Matrix.mul(c,n.Matrix.TEMP,u)}else n.Matrix.TEMP.copyTo(u);a||(u=this.getSaveMatrix(u)),u._checkTransform(),o?e.drawTexture(h,-this.currDisplayData.height/2,-this.currDisplayData.width/2,this.currDisplayData.height,this.currDisplayData.width,u,r):e.drawTexture(h,-this.currDisplayData.width/2,-this.currDisplayData.height/2,this.currDisplayData.width,this.currDisplayData.height,u,r)}}}break;case 1:if(a?(null==this._skinSprite&&(this._skinSprite=t.createSkinMesh()),s=this._skinSprite):s=t.createSkinMesh(),null==s)return;var p;if(null==this.currDisplayData.bones){var _,d=this.currDisplayData.weights;this.deformData&&(d=this.deformData),this._diyTexture?(this._curDiyUV||(this._curDiyUV=[]),0==this._curDiyUV.length&&(this._curDiyUV=D.getRelativeUV(this.currTexture.uv,this.currDisplayData.uvs,this._curDiyUV),this._curDiyUV=D.getAbsoluteUV(this._diyTexture.uv,this._curDiyUV,this._curDiyUV)),_=this._curDiyUV):_=this.currDisplayData.uvs,this._mVerticleArr=d,this.currDisplayData.triangles.length,p=this.currDisplayData.triangles,this.deformData&&(a||(this._mVerticleArr=this.getSaveVerticle(this._mVerticleArr))),s.init2(h,p,this._mVerticleArr,_);var f,y=this.getDisplayMatrix();this._parentMatrix&&y&&(n.Matrix.mul(y,this._parentMatrix,n.Matrix.TEMP),a?(null==this._resultMatrix&&(this._resultMatrix=new n.Matrix),f=this._resultMatrix):f=t._tempResultMatrix,n.Matrix.TEMP.copyTo(f),a||(f=this.getSaveMatrix(f)),s.transform=f)}else this.skinMesh(i,s);e.drawSkin(s,r);break;case 2:if(a?(null==this._skinSprite&&(this._skinSprite=t.createSkinMesh()),s=this._skinSprite):s=t.createSkinMesh(),null==s)return;this.skinMesh(i,s),e.drawSkin(s,r)}}}},{key:"skinMesh",value:function(e,i){var a,r=this.currTexture,s=this.currDisplayData.bones;this._diyTexture?(r=this._diyTexture,this._curDiyUV||(this._curDiyUV=[]),0==this._curDiyUV.length&&(this._curDiyUV=D.getRelativeUV(this.currTexture.uv,this.currDisplayData.uvs,this._curDiyUV),this._curDiyUV=D.getAbsoluteUV(this._diyTexture.uv,this._curDiyUV,this._curDiyUV)),a=this._curDiyUV):a=this.currDisplayData.uvs;var n,h,l,o,u,c=this.currDisplayData.weights,p=this.currDisplayData.triangles,_=0,d=0,f=0,y=0,m=0,g=0,v=0;if(t._tempVerticleArr.length=0,u=t._tempVerticleArr,this.deformData&&this.deformData.length>0){var x=0;for(g=0,v=s.length;g<v;){for(f=s[g++]+g,_=0,d=0;g<f;g++)h=e[s[g]],l=c[y]+this.deformData[x++],o=c[y+1]+this.deformData[x++],m=c[y+2],_+=(l*h.a+o*h.c+h.tx)*m,d+=(l*h.b+o*h.d+h.ty)*m,y+=3;u.push(_,d)}}else for(g=0,v=s.length;g<v;){for(f=s[g++]+g,_=0,d=0;g<f;g++)h=e[s[g]],l=c[y],o=c[y+1],m=c[y+2],_+=(l*h.a+o*h.c+h.tx)*m,d+=(l*h.b+o*h.d+h.ty)*m,y+=3;u.push(_,d)}this._mVerticleArr=u,n=p,this._mVerticleArr=this.getSaveVerticle(this._mVerticleArr),i.init2(r,n,this._mVerticleArr,a)}},{key:"drawBonePoint",value:function(t){t&&this._parentMatrix&&t.drawCircle(this._parentMatrix.tx,this._parentMatrix.ty,5,"#ff0000")}},{key:"getDisplayMatrix",value:function(){return this.currDisplayData?this.currDisplayData.transform.getMatrix():null}},{key:"getMatrix",value:function(){return this._resultMatrix}},{key:"copy",value:function(){var e=new t;return e.type="copy",e.name=this.name,e.attachmentName=this.attachmentName,e.srcDisplayIndex=this.srcDisplayIndex,e.parent=this.parent,e.displayIndex=this.displayIndex,e.templet=this.templet,e.currSlotData=this.currSlotData,e.currTexture=this.currTexture,e.currDisplayData=this.currDisplayData,e}}],[{key:"createSkinMesh",value:function(){return new I}},{key:"isSameArr",value:function(t,e){if(t.length!=e.length)return!1;var i,a;for(a=t.length,i=0;i<a;i++)if(t[i]!=e[i])return!1;return!0}},{key:"isSameMatrix",value:function(t,e){return t.a==e.a&&t.b==e.b&&t.c==e.c&&t.d==e.d&&Math.abs(t.tx-e.tx)<1e-5&&Math.abs(t.ty-e.ty)<1e-5}}]),t}();A._tempMatrix=new n.Matrix,A._tempResultMatrix=new n.Matrix,A.useSameMatrixAndVerticle=!0,A._tempVerticleArr=[];var S=function t(){l(this,t),this.deformSlotDataList=[]},b=function t(){l(this,t),this.deformSlotDisplayList=[]},T=function(){function t(){l(this,t),this.slotIndex=-1,this.timeList=[],this.vectices=[],this.tweenKeyList=[],this.frameIndex=0}return h(t,[{key:"binarySearch1",value:function(t,e){var i=0,a=t.length-2;if(0==a)return 1;for(var r=a>>>1;;){if(t[Math.floor(r+1)]<=e?i=r+1:a=r,i==a)return i+1;r=i+a>>>1}return 0}},{key:"apply",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;if(t+=.05,!(this.timeList.length<=0)){var a=0;if(!(t<this.timeList[0])){var r=this.vectices[0].length,s=[],n=this.binarySearch1(this.timeList,t);if(this.frameIndex=n,t>=this.timeList[this.timeList.length-1]){var h=this.vectices[this.vectices.length-1];if(i<1)for(a=0;a<r;a++)s[a]+=(h[a]-s[a])*i;else for(a=0;a<r;a++)s[a]=h[a];this.deformData=s}else{var l,o=this.vectices[this.frameIndex-1],u=this.vectices[this.frameIndex],c=this.timeList[this.frameIndex-1],p=this.timeList[this.frameIndex];for(i=this.tweenKeyList[n-1]?(t-c)/(p-c):0,a=0;a<r;a++)l=o[a],s[a]=l+(u[a]-l)*i;this.deformData=s}}}}}]),t}(),C=function t(){l(this,t),this.drawOrder=[]},F=function t(){l(this,t)},w=function(){function t(e,i){l(this,t),this.isSpine=!0,this.isDebug=!1,this._targetBone=i[e.targetBoneIndex],this.isSpine=e.isSpine,null==this._bones&&(this._bones=[]),this._bones.length=0;for(var a=0,r=e.boneIndexs.length;a<r;a++)this._bones.push(i[e.boneIndexs[a]]);this.name=e.name,this.mix=e.mix,this.bendDirection=e.bendDirection}return h(t,[{key:"apply",value:function(){switch(this._bones.length){case 1:this._applyIk1(this._bones[0],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.mix);break;case 2:this.isSpine?this._applyIk2(this._bones[0],this._bones[1],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.bendDirection,this.mix):this._applyIk3(this._bones[0],this._bones[1],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.bendDirection,this.mix)}}},{key:"_applyIk1",value:function(e,i,a,r){var s=e.parentBone,n=1/(s.resultMatrix.a*s.resultMatrix.d-s.resultMatrix.b*s.resultMatrix.c),h=i-s.resultMatrix.tx,l=a-s.resultMatrix.ty,o=(h*s.resultMatrix.d-l*s.resultMatrix.c)*n-e.transform.x,u=(l*s.resultMatrix.a-h*s.resultMatrix.b)*n-e.transform.y,c=Math.atan2(u,o)*t.radDeg-0-e.transform.skX;e.transform.scX<0&&(c+=180),c>180?c-=360:c<-180&&(c+=360),e.transform.skX=e.transform.skY=e.transform.skX+c*r,e.update()}},{key:"updatePos",value:function(t,e){this._sp&&this._sp.pos(t,e)}},{key:"_applyIk2",value:function(e,i,a,r,s,h){if(0!=h){var l,o,u,c=e.resultTransform.x,p=e.resultTransform.y,_=e.transform.scX,d=e.transform.scY,f=i.transform.scX;_<0?(_=-_,l=180,u=-1):(l=0,u=1),d<0&&(d=-d,u=-u),f<0?(f=-f,o=180):o=0;var y,m,g,v=i.resultTransform.x,x=e.resultMatrix.a,M=e.resultMatrix.c,D=e.resultMatrix.b,k=e.resultMatrix.d,I=Math.abs(_-d)<=1e-4;I?(m=x*v+M*(y=i.resultTransform.y)+e.resultMatrix.tx,g=D*v+k*y+e.resultMatrix.ty):(y=0,m=x*v+e.resultMatrix.tx,g=D*v+e.resultMatrix.ty),this.isDebug&&(this._sp||(this._sp=new n.Sprite,n.ILaya.stage.addChild(this._sp)),this._sp.graphics.clear(),this._sp.graphics.drawCircle(a,r,15,"#ffff00"),this._sp.graphics.drawCircle(m,g,15,"#ff00ff")),e.setRotation(Math.atan2(g-e.resultMatrix.ty,m-e.resultMatrix.tx));var A=e.parentBone;x=A.resultMatrix.a,M=A.resultMatrix.c,D=A.resultMatrix.b;var S,b,T=1/(x*(k=A.resultMatrix.d)-M*D),C=a-A.resultMatrix.tx,F=r-A.resultMatrix.ty,w=(C*k-F*M)*T-c,P=(F*x-C*D)*T-p,L=((C=m-A.resultMatrix.tx)*k-(F=g-A.resultMatrix.ty)*M)*T-c,U=(F*x-C*D)*T-p,B=Math.sqrt(L*L+U*U),E=i.length*f;if(I){var R=(w*w+P*P-B*B-(E*=_)*E)/(2*B*E);R<-1?R=-1:R>1&&(R=1),b=Math.acos(R)*s,x=B+E*R,M=E*Math.sin(b),S=Math.atan2(P*x-w*M,w*x+P*M)}else{var N=(x=_*E)*x,O=(M=d*E)*M,V=w*w+P*P,Y=Math.atan2(P,w),K=-2*O*B,X=O-N;if((k=K*K-4*X*(D=O*B*B+N*V-N*O))>0){var W=Math.sqrt(k);K<0&&(W=-W);var z=(W=-(K+W)/2)/X,G=D/W,q=Math.abs(z)<Math.abs(G)?z:G;q*q<=V&&(F=Math.sqrt(V-q*q)*s,S=Y-Math.atan2(F,q),b=Math.atan2(F/d,(q-B)/_))}var H=0,j=Number.MAX_VALUE,Q=0,Z=0,J=0,$=0,tt=0,et=0;(k=(C=B+x)*C)>$&&(J=0,$=k,tt=C),(k=(C=B-x)*C)<j&&(H=Math.PI,j=k,Q=C);var it=Math.acos(-x*B/(N-O));(k=(C=x*Math.cos(it)+B)*C+(F=M*Math.sin(it))*F)<j&&(H=it,j=k,Q=C,Z=F),k>$&&(J=it,$=k,tt=C,et=F),V<=(j+$)/2?(S=Y-Math.atan2(Z*s,Q),b=H*s):(S=Y-Math.atan2(et*s,tt),b=J*s)}var at=Math.atan2(y,v)*u,rt=e.resultTransform.skX;(S=(S-at)*t.radDeg+l-rt)>180?S-=360:S<-180&&(S+=360),e.resultTransform.x=c,e.resultTransform.y=p,e.resultTransform.skX=e.resultTransform.skY=rt+S*h,rt=i.resultTransform.skX,rt%=360,(b=((b+at)*t.radDeg-0)*u+o-rt)>180?b-=360:b<-180&&(b+=360),i.resultTransform.x=v,i.resultTransform.y=y,i.resultTransform.skX=i.resultTransform.skY=i.resultTransform.skY+b*h,e.update()}}},{key:"_applyIk3",value:function(e,i,a,r,s,h){if(0!=h){var l,o,u,c,p,_,d=i.resultMatrix.a*i.length,f=i.resultMatrix.b*i.length,y=d*d+f*f,m=Math.sqrt(y),g=e.resultMatrix.tx,v=e.resultMatrix.ty,x=i.resultMatrix.tx,M=i.resultMatrix.ty,D=x-g,k=M-v,I=D*D+k*k,A=Math.sqrt(I),S=(D=a-e.resultMatrix.tx)*D+(k=r-e.resultMatrix.ty)*k,b=Math.sqrt(S);if(m+A<=b||b+m<=A||b+A<=m){var T;x=g+(T=m+A<=b?1:-1)*(a-g)*A/b,M=v+T*(r-v)*A/b}else{var C=(I-y+S)/(2*S),F=Math.sqrt(I-C*C*S)/b,w=g+D*C,P=v+k*C,L=-k*F,U=D*F;s>0?(x=w-L,M=P-U):(x=w+L,M=P+U)}l=x,o=M,this.isDebug&&(this._sp||(this._sp=new n.Sprite,n.ILaya.stage.addChild(this._sp)),this._sp.graphics.clear(),this._sp.graphics.drawCircle(g,v,15,"#ff00ff"),this._sp.graphics.drawCircle(a,r,15,"#ffff00"),this._sp.graphics.drawCircle(l,o,15,"#ff00ff")),u=Math.atan2(o-e.resultMatrix.ty,l-e.resultMatrix.tx),e.setRotation(u),(c=t._tempMatrix).identity(),c.rotate(u),c.scale(e.resultMatrix.getScaleX(),e.resultMatrix.getScaleY()),c.translate(e.resultMatrix.tx,e.resultMatrix.ty),c.copyTo(e.resultMatrix),e.updateChild(),p=Math.atan2(r-o,a-l),i.setRotation(p),(_=t._tempMatrix).identity(),_.rotate(p),_.scale(i.resultMatrix.getScaleX(),i.resultMatrix.getScaleY()),_.translate(l,o),c.copyTo(i.resultMatrix),i.updateChild()}}}]),t}();w.radDeg=180/Math.PI,w.degRad=Math.PI/180,w._tempMatrix=new n.Matrix;var P=function t(){l(this,t),this.boneNames=[],this.bendDirection=1,this.mix=1,this.isSpine=!0,this.targetBoneIndex=-1,this.boneIndexs=[]},L=function(){function t(e,i){l(this,t),this._debugKey=!1,this._segments=[],this._curves=[],this.data=e,this.position=e.position,this.spacing=e.spacing,this.rotateMix=e.rotateMix,this.translateMix=e.translateMix,this.bones=[];for(var a=this.data.bones,r=0,s=a.length;r<s;r++)this.bones.push(i[a[r]])}return h(t,[{key:"apply",value:function(t,e){if(this.target){var i=this.translateMix,a=this.translateMix,r=a>0,s=this.data.spacingMode,n="length"==s,h=this.data.rotateMode,l="tangent"==h,o="chainScale"==h,u=[],c=this.bones.length,p=l?c:c+1,_=[];this._spaces=_,_[0]=this.position;var d=this.spacing;if(o||n)for(var f=0,y=p-1;f<y;){var m=this.bones[f],g=m.length,v=g*m.resultMatrix.a,x=g*m.resultMatrix.b;g=Math.sqrt(v*v+x*x),o&&(u[f]=g),_[++f]=n?Math.max(0,g+d):d}else for(f=1;f<p;f++)_[f]=d;var M=this.computeWorldPositions(this.target,t,e,p,l,"percent"==this.data.positionMode,"percent"==s);if(this._debugKey){for(f=0;f<M.length;f++)e.drawCircle(M[f++],M[f++],5,"#00ff00");var D=[];for(f=0;f<M.length;f++)D.push(M[f++],M[f++]);e.drawLines(0,0,D,"#ff0000")}var k,I=M[0],A=M[1],S=this.data.offsetRotation,b="chain"==h&&0==S;for(f=0,k=3;f<c;f++,k+=3){(m=this.bones[f]).resultMatrix.tx+=(I-m.resultMatrix.tx)*i,m.resultMatrix.ty+=(A-m.resultMatrix.ty)*i;var T=(v=M[k])-I,C=(x=M[k+1])-A;if(o&&0!=(g=u[f])){var F=(Math.sqrt(T*T+C*C)/g-1)*a+1;m.resultMatrix.a*=F,m.resultMatrix.c*=F}if(I=v,A=x,r){var w,P,L,U=m.resultMatrix.a,B=m.resultMatrix.c,E=m.resultMatrix.b,R=m.resultMatrix.d;w=l?M[k-1]:0==_[f+1]?M[k+2]:Math.atan2(C,T),w-=Math.atan2(E,U)-S/180*Math.PI,b&&(P=Math.cos(w),L=Math.sin(w),I+=((g=m.length)*(P*U-L*E)-T)*a,A+=(g*(L*U+P*E)-C)*a),w>Math.PI?w-=2*Math.PI:w<-Math.PI&&(w+=2*Math.PI),w*=a,P=Math.cos(w),L=Math.sin(w),m.resultMatrix.a=P*U-L*E,m.resultMatrix.c=P*B-L*R,m.resultMatrix.b=L*U+P*E,m.resultMatrix.d=L*B+P*R}}}}},{key:"computeWorldVertices2",value:function(e,i,a,r,s,n){var h,l,o,u=e.currDisplayData.bones,c=e.currDisplayData.weights,p=e.currDisplayData.triangles,_=0,d=0,f=0,y=0,m=0,g=0,v=0,x=0,M=0,D=0;if(null!=u){for(_=0;_<a;_+=2)d+=(y=u[d])+1,f+=y;var k=i;for(m=n,g=3*f;m<r;m+=2){for(v=0,x=0,y=u[d++],y+=d;d<y;d++,g+=3){h=k[u[d]].resultMatrix,M=c[g],D=c[g+1];var I=c[g+2];v+=(M*h.a+D*h.c+h.tx)*I,x+=(M*h.b+D*h.d+h.ty)*I}s[m]=v,s[m+1]=x}}else{var A,S;if(p||(p=c),e.deformData&&(p=e.deformData),A=e.parent,i)for(o=i.length,_=0;_<o;_++)if(i[_].name==A){l=i[_];break}l&&(S=l.resultMatrix),S||(S=t._tempMt);var b=S.tx,T=S.ty,C=S.a,F=S.b,w=S.c,P=S.d;for(l&&(P*=l.d),d=a,m=n;m<r;d+=2,m+=2)M=p[d],D=p[d+1],s[m]=M*C+D*F+b,s[m+1]=-(M*w+D*P+T)}}},{key:"computeWorldPositions",value:function(t,e,i,a,r,s,n){t.currDisplayData.bones,t.currDisplayData.weights,t.currDisplayData.triangles;var h,l,o,u,c,p,_,d,f=[],y=0,m=t.currDisplayData.verLen,g=this.position,v=this._spaces,x=[],M=m/6,D=-1;if(M--,m-=4,this.computeWorldVertices2(t,e,2,m,f,0),this._debugKey)for(y=0;y<f.length;)i.drawCircle(f[y++],f[y++],10,"#ff0000");h=f,this._curves.length=M;var k=this._curves;l=0;var I,A,S,b,T,C,F,w,P,L=h[0],U=h[1],B=0,E=0,R=0,N=0,O=0,V=0;for(y=0,P=2;y<M;y++,P+=6)T=2*(I=.1875*(L-2*(B=h[P])+(R=h[P+2])))+(S=.09375*(3*(B-R)-L+(O=h[P+4]))),C=2*(A=.1875*(U-2*(E=h[P+1])+(N=h[P+3])))+(b=.09375*(3*(E-N)-U+(V=h[P+5]))),F=.75*(B-L)+I+.16666667*S,w=.75*(E-U)+A+.16666667*b,l+=Math.sqrt(F*F+w*w),F+=T,w+=C,T+=S,C+=b,l+=Math.sqrt(F*F+w*w),F+=T,w+=C,l+=Math.sqrt(F*F+w*w),F+=T+S,w+=C+b,l+=Math.sqrt(F*F+w*w),k[y]=l,L=O,U=V;if(s&&(g*=l),n)for(y=0;y<a;y++)v[y]*=l;var Y,K=this._segments,X=0;for(y=0,o=0,u=0,Y=0;y<a;y++,o+=3)if((c=g+=p=v[y])<0)this.addBeforePosition(c,h,0,x,o);else if(c>l)this.addAfterPosition(c-l,h,m-4,x,o);else{for(;;u++)if(!(c>(d=k[u]))){0==u?c/=d:c=(c-(_=k[u-1]))/(d-_);break}if(u!=D){D=u;var W=6*u;for(T=2*(I=.03*((L=h[W])-2*(B=h[W+2])+(R=h[W+4])))+(S=.006*(3*(B-R)-L+(O=h[W+6]))),C=2*(A=.03*((U=h[W+1])-2*(E=h[W+3])+(N=h[W+5])))+(b=.006*(3*(E-N)-U+(V=h[W+7]))),F=.3*(B-L)+I+.16666667*S,w=.3*(E-U)+A+.16666667*b,X=Math.sqrt(F*F+w*w),K[0]=X,W=1;W<8;W++)F+=T,w+=C,T+=S,C+=b,X+=Math.sqrt(F*F+w*w),K[W]=X;F+=T,w+=C,X+=Math.sqrt(F*F+w*w),K[8]=X,F+=T+S,w+=C+b,X+=Math.sqrt(F*F+w*w),K[9]=X,Y=0}for(c*=X;;Y++)if(!(c>(d=K[Y]))){0==Y?c/=d:c=Y+(c-(_=K[Y-1]))/(d-_);break}this.addCurvePosition(.1*c,L,U,B,E,R,N,O,V,x,o,r||y>0&&0==p)}return x}},{key:"addBeforePosition",value:function(t,e,i,a,r){var s=e[i],n=e[i+1],h=e[i+2]-s,l=e[i+3]-n,o=Math.atan2(l,h);a[r]=s+t*Math.cos(o),a[r+1]=n+t*Math.sin(o),a[r+2]=o}},{key:"addAfterPosition",value:function(t,e,i,a,r){var s=e[i+2],n=e[i+3],h=s-e[i],l=n-e[i+1],o=Math.atan2(l,h);a[r]=s+t*Math.cos(o),a[r+1]=n+t*Math.sin(o),a[r+2]=o}},{key:"addCurvePosition",value:function(t,e,i,a,r,s,n,h,l,o,u,c){0==t&&(t=1e-4);var p=t*t,_=p*t,d=1-t,f=d*d,y=f*d,m=d*t,g=3*m,v=d*g,x=g*t,M=e*y+a*v+s*x+h*_,D=i*y+r*v+n*x+l*_;o[u]=M,o[u+1]=D,o[u+2]=c?Math.atan2(D-(i*f+r*m*2+n*p),M-(e*f+a*m*2+s*p)):0}}]),t}();L.BEFORE=-2,L.AFTER=-3,L._tempMt=new n.Matrix;var U=function t(){l(this,t),this.bones=[]},B=function(){function t(e,i){var a,r;for(l(this,t),this._temp=[],this._data=e,null==this._bones&&(this._bones=[]),this.target=i[e.targetIndex],a=0,r=e.boneIndexs.length;a<r;a++)this._bones.push(i[e.boneIndexs[a]]);this.rotateMix=e.rotateMix,this.translateMix=e.translateMix,this.scaleMix=e.scaleMix,this.shearMix=e.shearMix}return h(t,[{key:"apply",value:function(){for(var t,e=this.target.resultMatrix.a,i=this.target.resultMatrix.b,a=this.target.resultMatrix.c,r=this.target.resultMatrix.d,s=0,n=this._bones.length;s<n;s++){if(t=this._bones[s],this.rotateMix>0){var h=t.resultMatrix.a,l=t.resultMatrix.b,o=t.resultMatrix.c,u=t.resultMatrix.d,c=Math.atan2(a,e)-Math.atan2(o,h)+this._data.offsetRotation*Math.PI/180;c>Math.PI?c-=2*Math.PI:c<-Math.PI&&(c+=2*Math.PI),c*=this.rotateMix;var p=Math.cos(c),_=Math.sin(c);t.resultMatrix.a=p*h-_*o,t.resultMatrix.b=p*l-_*u,t.resultMatrix.c=_*h+p*o,t.resultMatrix.d=_*l+p*u}if(this.translateMix&&(this._temp[0]=this._data.offsetX,this._temp[1]=this._data.offsetY,this.target.localToWorld(this._temp),t.resultMatrix.tx+=(this._temp[0]-t.resultMatrix.tx)*this.translateMix,t.resultMatrix.ty+=(this._temp[1]-t.resultMatrix.ty)*this.translateMix,t.updateChild()),this.scaleMix>0){var d=Math.sqrt(t.resultMatrix.a*t.resultMatrix.a+t.resultMatrix.c*t.resultMatrix.c),f=Math.sqrt(e*e+a*a),y=d>1e-5?(d+(f-d+this._data.offsetScaleX)*this.scaleMix)/d:0;t.resultMatrix.a*=y,t.resultMatrix.c*=y,d=Math.sqrt(t.resultMatrix.b*t.resultMatrix.b+t.resultMatrix.d*t.resultMatrix.d),f=Math.sqrt(i*i+r*r),y=d>1e-5?(d+(f-d+this._data.offsetScaleY)*this.scaleMix)/d:0,t.resultMatrix.b*=y,t.resultMatrix.d*=y}if(this.shearMix>0){l=t.resultMatrix.b,u=t.resultMatrix.d;var m=Math.atan2(u,l);(c=Math.atan2(r,i)-Math.atan2(a,e)-(m-Math.atan2(t.resultMatrix.c,t.resultMatrix.a)))>Math.PI?c-=2*Math.PI:c<-Math.PI&&(c+=2*Math.PI),c=m+(c+this._data.offsetShearY*Math.PI/180)*this.shearMix,y=Math.sqrt(l*l+u*u),t.resultMatrix.b=Math.cos(c)*y,t.resultMatrix.d=Math.sin(c)*y}}}}]),t}(),E=function(t){function a(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return l(this,a),(t=i(this,r(a).call(this)))._boneMatrixArray=[],t._lastTime=0,t._currAniIndex=-1,t._pause=!0,t._aniClipIndex=-1,t._clipIndex=-1,t._skinIndex=0,t._skinName="default",t._aniMode=0,t._index=-1,t._total=-1,t._indexControl=!1,t._eventIndex=0,t._drawOrderIndex=0,t._drawOrder=null,t._lastAniClipIndex=-1,t._lastUpdateAniClipIndex=-1,t._playAudio=!0,t._soundChannelArr=[],e&&t.init(e,s),t}return s(a,n.Sprite),h(a,[{key:"init",value:function(t){var e,i,a,r,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,h=0;if(1==s)for(this._graphicsCache=[],h=0,e=t.getAnimationCount();h<e;h++)this._graphicsCache.push([]);if(this._yReverseMatrix=t.yReverseMatrix,this._aniMode=s,this._templet=t,this._templet._addReference(1),this._player=new y,this._player.cacheFrameRate=t.rate,this._player.templet=t,this._player.play(),this._parseSrcBoneMatrix(),this._boneList=t.mBoneArr,this._rootBone=t.mRootBone,this._aniSectionDic=t.aniSectionDic,t.ikArr.length>0)for(this._ikArr=[],h=0,e=t.ikArr.length;h<e;h++)this._ikArr.push(new w(t.ikArr[h],this._boneList));if(t.pathArr.length>0)for(null==this._pathDic&&(this._pathDic={}),h=0,e=t.pathArr.length;h<e;h++)i=t.pathArr[h],a=new L(i,this._boneList),(r=this._boneSlotDic[i.name])&&((a=new L(i,this._boneList)).target=r),this._pathDic[i.name]=a;if(t.tfArr.length>0)for(this._tfArr=[],h=0,e=t.tfArr.length;h<e;h++)this._tfArr.push(new B(t.tfArr[h],this._boneList));if(t.skinDataArray.length>0){var l=this._templet.skinDataArray[this._skinIndex];this._skinName=l.name}this._player.on(n.Event.PLAYED,this,this._onPlay),this._player.on(n.Event.STOPPED,this,this._onStop),this._player.on(n.Event.PAUSED,this,this._onPause)}},{key:"load",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this._aniPath=t,this._complete=e,this._loadAniMode=i,n.ILaya.loader.load([{url:t,type:n.ILaya.Loader.BUFFER}],n.Handler.create(this,this._onLoaded))}},{key:"_onLoaded",value:function(){var t,e=n.ILaya.Loader.getRes(this._aniPath);null!=e&&(null==o.Templet.TEMPLET_DICTIONARY&&(o.Templet.TEMPLET_DICTIONARY={}),(t=o.Templet.TEMPLET_DICTIONARY[this._aniPath])?t.isParseFail?this._parseFail():t.isParserComplete?this._parseComplete():(t.on(n.Event.COMPLETE,this,this._parseComplete),t.on(n.Event.ERROR,this,this._parseFail)):((t=new o.Templet)._setCreateURL(this._aniPath),o.Templet.TEMPLET_DICTIONARY[this._aniPath]=t,t.on(n.Event.COMPLETE,this,this._parseComplete),t.on(n.Event.ERROR,this,this._parseFail),t.isParserComplete=!1,t.parseData(null,e)))}},{key:"_parseComplete",value:function(){var t=o.Templet.TEMPLET_DICTIONARY[this._aniPath];t&&(this.init(t,this._loadAniMode),this.play(0,!0)),this._complete&&this._complete.runWith(this)}},{key:"_parseFail",value:function(){console.log("[Error]:"+this._aniPath+"解析失败")}},{key:"_onPlay",value:function(){this.event(n.Event.PLAYED)}},{key:"_onStop",value:function(){var t,e=this._templet.eventAniArr[this._aniClipIndex];if(e&&this._eventIndex<e.length)for(;this._eventIndex<e.length;this._eventIndex++)(t=e[this._eventIndex]).time>=this._player.playStart&&t.time<=this._player.playEnd&&this.event(n.Event.LABEL,t);this._drawOrder=null,this.event(n.Event.STOPPED)}},{key:"_onPause",value:function(){this.event(n.Event.PAUSED)}},{key:"_parseSrcBoneMatrix",value:function(){var t=0,e=0;for(e=this._templet.srcBoneMatrixArr.length,t=0;t<e;t++)this._boneMatrixArray.push(new n.Matrix);if(0==this._aniMode)this._boneSlotDic=this._templet.boneSlotDic,this._bindBoneBoneSlotDic=this._templet.bindBoneBoneSlotDic,this._boneSlotArray=this._templet.boneSlotArray;else{null==this._boneSlotDic&&(this._boneSlotDic={}),null==this._bindBoneBoneSlotDic&&(this._bindBoneBoneSlotDic={}),null==this._boneSlotArray&&(this._boneSlotArray=[]);var i,a,r=this._templet.boneSlotArray;for(t=0,e=r.length;t<e;t++)i=r[t],null==(a=this._bindBoneBoneSlotDic[i.parent])&&(this._bindBoneBoneSlotDic[i.parent]=a=[]),this._boneSlotDic[i.name]=i=i.copy(),a.push(i),this._boneSlotArray.push(i)}}},{key:"_emitMissedEvents",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=this._templet.eventAniArr[this._player.currentAnimationClipIndex];if(a){var r,s,h=0;for(r=a.length,h=i;h<r;h++)(s=a[h]).time>=this._player.playStart&&s.time<=this._player.playEnd&&this.event(n.Event.LABEL,s)}}},{key:"_update",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!(this._pause||t&&this._indexControl)){var e=this.timer.currTimer,i=this._player.currentKeyframeIndex,a=e-this._lastTime;if(t?this._player._update(a):i=-1,this._lastTime=e,this._player&&(this._index=this._clipIndex=this._player.currentKeyframeIndex,!(this._index<0||a>0&&this._clipIndex==i&&this._lastUpdateAniClipIndex==this._aniClipIndex))){this._lastUpdateAniClipIndex=this._aniClipIndex,i>this._clipIndex&&0!=this._eventIndex&&(this._emitMissedEvents(this._player.playStart,this._player.playEnd,this._eventIndex),this._eventIndex=0);var r,s,h=this._templet.eventAniArr[this._aniClipIndex];if(h&&this._eventIndex<h.length){var l=h[this._eventIndex];l.time>=this._player.playStart&&l.time<=this._player.playEnd?this._player.currentPlayTime>=l.time&&(this.event(n.Event.LABEL,l),this._eventIndex++,this._playAudio&&l.audioValue&&"null"!==l.audioValue&&"undefined"!==l.audioValue&&(r=n.SoundManager.playSound(this._player.templet._path+l.audioValue,1,n.Handler.create(this,this._onAniSoundStoped)),n.SoundManager.playbackRate=this._player.playbackRate,r&&this._soundChannelArr.push(r))):l.time<this._player.playStart&&this._playAudio&&l.audioValue&&"null"!==l.audioValue&&"undefined"!==l.audioValue?(this._eventIndex++,r=n.SoundManager.playSound(this._player.templet._path+l.audioValue,1,n.Handler.create(this,this._onAniSoundStoped),null,(this._player.currentPlayTime-l.time)/1e3),n.SoundManager.playbackRate=this._player.playbackRate,r&&this._soundChannelArr.push(r)):this._eventIndex++}0==this._aniMode?(s=this._templet.getGrahicsDataWithCache(this._aniClipIndex,this._clipIndex)||this._createGraphics())&&this.graphics!=s&&(this.graphics=s):1==this._aniMode?(s=this._getGrahicsDataWithCache(this._aniClipIndex,this._clipIndex)||this._createGraphics())&&this.graphics!=s&&(this.graphics=s):this._createGraphics()}}}},{key:"_onAniSoundStoped",value:function(t){for(var e,i=this._soundChannelArr.length,a=0;a<i;a++)((e=this._soundChannelArr[a]).isStopped||t)&&(!e.isStopped&&e.stop(),this._soundChannelArr.splice(a,1),i--,a--)}},{key:"_createGraphics",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1;-1==t&&(t=this._clipIndex);var e,i=t*this._player.cacheFrameRateInterval,a=this._templet.drawOrderAniArr[this._aniClipIndex];if(a&&a.length>0)for(this._drawOrderIndex=0,e=a[this._drawOrderIndex];i>=e.time&&(this._drawOrder=e.drawOrder,this._drawOrderIndex++,!(this._drawOrderIndex>=a.length));)e=a[this._drawOrderIndex];0==this._aniMode||1==this._aniMode?this.graphics=v.create():this.graphics instanceof v?this.graphics.clear():this.graphics=v.create();var r=this.graphics,s=this._templet.getNodes(this._aniClipIndex),h=0==this._player.state;this._templet.getOriginalData(this._aniClipIndex,this._curOriginalData,null,t,h?i+this._player.cacheFrameRateInterval:i);var l,o,u,c,p=this._aniSectionDic[this._aniClipIndex],_=0,d=0,f=0,y=0,m=0,g=this._templet.srcBoneMatrixArr.length,x=this._curOriginalData;for(d=0,m=p[0];d<g;d++){var M=(c=this._boneList[d]).resultTransform;u=this._templet.srcBoneMatrixArr[d],M.scX=u.scX*x[_++],M.skX=u.skX+x[_++],M.skY=u.skY+x[_++],M.scY=u.scY*x[_++],M.x=u.x+x[_++],M.y=u.y+x[_++],8===this._templet.tMatrixDataLen&&(M.skewX=u.skewX+x[_++],M.skewY=u.skewY+x[_++])}var D,k={},I={};for(m+=p[1];d<m;d++)k[(D=s[d]).name]=x[_++],I[D.name]=x[_++],_+=4;var A,S,b={},T={};for(m+=p[2];d<m;d++)b[(D=s[d]).name]=x[_++],T[D.name]=x[_++],_+=4;if(this._pathDic)for(m+=p[3];d<m;d++)if(D=s[d],A=this._pathDic[D.name]){switch(new n.Byte(D.extenData).getByte()){case 1:A.position=x[_++];break;case 2:A.spacing=x[_++];break;case 3:A.rotateMix=x[_++],A.translateMix=x[_++]}}if(this._rootBone.update(this._yReverseMatrix||n.Matrix.TEMP.identity()),this._ikArr)for(d=0,m=this._ikArr.length;d<m;d++)(S=this._ikArr[d]).name in b&&(S.bendDirection=b[S.name]),S.name in T&&(S.mix=T[S.name]),S.apply();if(this._pathDic)for(var C in this._pathDic)(A=this._pathDic[C]).apply(this._boneList,r);if(this._tfArr)for(d=0,y=this._tfArr.length;d<y;d++)this._tfArr[d].apply();for(d=0,y=this._boneList.length;d<y;d++)if(c=this._boneList[d],o=this._bindBoneBoneSlotDic[c.name],c.resultMatrix.copyTo(this._boneMatrixArray[d]),o)for(f=0,m=o.length;f<m;f++)(l=o[f])&&l.setParentMatrix(c.resultMatrix);var F,w,P,L,U={},B=this._templet.deformAniArr;if(B&&B.length>0){if(this._lastAniClipIndex!=this._aniClipIndex)for(this._lastAniClipIndex=this._aniClipIndex,d=0,m=this._boneSlotArray.length;d<m;d++)(l=this._boneSlotArray[d]).deformData=null;var E,R=B[this._aniClipIndex];for(E in F=R.default,this._setDeform(F,U,this._boneSlotArray,i),R)"default"!=E&&E!=this._skinName&&(F=R[E],this._setDeform(F,U,this._boneSlotArray,i));F=R[this._skinName],this._setDeform(F,U,this._boneSlotArray,i)}if(this._drawOrder)for(d=0,m=this._drawOrder.length;d<m;d++)w=k[(l=this._boneSlotArray[this._drawOrder[d]]).name],P=I[l.name],isNaN(w)||-2==w||(this._templet.attachmentNames?l.showDisplayByName(this._templet.attachmentNames[w]):l.showDisplayByIndex(w)),U[this._drawOrder[d]]?(L=U[this._drawOrder[d]],l.currDisplayData&&L[l.currDisplayData.attachmentName]?l.deformData=L[l.currDisplayData.attachmentName]:l.deformData=null):l.deformData=null,isNaN(P)?l.draw(r,this._boneMatrixArray,2==this._aniMode):l.draw(r,this._boneMatrixArray,2==this._aniMode,P);else for(d=0,m=this._boneSlotArray.length;d<m;d++)w=k[(l=this._boneSlotArray[d]).name],P=I[l.name],isNaN(w)||-2==w||(this._templet.attachmentNames?l.showDisplayByName(this._templet.attachmentNames[w]):l.showDisplayByIndex(w)),U[d]?(L=U[d],l.currDisplayData&&L[l.currDisplayData.attachmentName]?l.deformData=L[l.currDisplayData.attachmentName]:l.deformData=null):l.deformData=null,isNaN(P)?l.draw(r,this._boneMatrixArray,2==this._aniMode):l.draw(r,this._boneMatrixArray,2==this._aniMode,P);return 0==this._aniMode?(this._templet.setGrahicsDataWithCache(this._aniClipIndex,t,r),this._checkIsAllParsed(this._aniClipIndex)):1==this._aniMode&&this._setGrahicsDataWithCache(this._aniClipIndex,t,r),r}},{key:"_checkIsAllParsed",value:function(t){var e,i;for(i=Math.floor(.01+this._templet.getAniDuration(t)/1e3*this._player.cacheFrameRate),e=0;e<i;e++)if(!this._templet.getGrahicsDataWithCache(t,e))return;this._templet.getGrahicsDataWithCache(t,i)?this._templet.deleteAniData(t):this._createGraphics(i)}},{key:"_setDeform",value:function(t,e,i,a){var r,s,n,h,l,o;if(t&&t)for(h=0,l=t.deformSlotDataList.length;h<l;h++)for(r=t.deformSlotDataList[h],o=0;o<r.deformSlotDisplayList.length;o++)n=i[(s=r.deformSlotDisplayList[o]).slotIndex],s.apply(a,n),e[s.slotIndex]||(e[s.slotIndex]={}),e[s.slotIndex][s.attachment]=s.deformData}},{key:"getAnimNum",value:function(){return this._templet.getAnimationCount()}},{key:"getAniNameByIndex",value:function(t){return this._templet.getAniNameByIndex(t)}},{key:"getSlotByName",value:function(t){return this._boneSlotDic[t]}},{key:"showSkinByName",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.showSkinByIndex(this._templet.getSkinIndexByName(t),e)}},{key:"showSkinByIndex",value:function(t){for(var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=0;i<this._boneSlotArray.length;i++)this._boneSlotArray[i].showSlotData(null,e);if(this._templet.showSkinByIndex(this._boneSlotDic,t,e)){var a=this._templet.skinDataArray[t];this._skinIndex=t,this._skinName=a.name}this._clearCache()}},{key:"showSlotSkinByIndex",value:function(t,e){if(0!=this._aniMode){var i=this.getSlotByName(t);i&&i.showDisplayByIndex(e),this._clearCache()}}},{key:"showSlotSkinByName",value:function(t,e){if(0!=this._aniMode){var i=this.getSlotByName(t);i&&i.showDisplayByName(e),this._clearCache()}}},{key:"replaceSlotSkinName",value:function(t,e,i){if(0!=this._aniMode){var a=this.getSlotByName(t);a&&a.replaceDisplayByName(e,i),this._clearCache()}}},{key:"replaceSlotSkinByIndex",value:function(t,e,i){if(0!=this._aniMode){var a=this.getSlotByName(t);a&&a.replaceDisplayByIndex(e,i),this._clearCache()}}},{key:"setSlotSkin",value:function(t,e){if(0!=this._aniMode){var i=this.getSlotByName(t);i&&i.replaceSkin(e),this._clearCache()}}},{key:"_clearCache",value:function(){if(1==this._aniMode)for(var t=0,e=this._graphicsCache.length;t<e;t++){for(var i=0,a=this._graphicsCache[t].length;i<a;i++){var r=this._graphicsCache[t][i];r&&r!=this.graphics&&v.recycle(r)}this._graphicsCache[t].length=0}}},{key:"play",value:function(t,e){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],h=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];this._playAudio=h,this._indexControl=!1;var l,o=-1;if(l=e?2147483647:0,"string"==typeof t)for(var u=0,c=this._templet.getAnimationCount();u<c;u++){var p=this._templet.getAnimation(u);if(p&&t==p.name){o=u;break}}else o=t;o>-1&&o<this.getAnimNum()&&(this._aniClipIndex=o,(i||this._pause||this._currAniIndex!=o)&&(this._currAniIndex=o,this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(o)),this._drawOrder=null,this._eventIndex=0,this._player.play(o,this._player.playbackRate,l,a,r),s&&this._templet.showSkinByIndex(this._boneSlotDic,this._skinIndex),this._pause&&(this._pause=!1,this._lastTime=n.ILaya.Browser.now(),this.timer.frameLoop(1,this,this._update,null,!0)),this._update()))}},{key:"stop",value:function(){this._pause||(this._pause=!0,this._player&&this._player.stop(!0),this._soundChannelArr.length>0&&this._onAniSoundStoped(!0),this.timer.clear(this,this._update))}},{key:"playbackRate",value:function(t){this._player&&(this._player.playbackRate=t)}},{key:"paused",value:function(){if(!this._pause){if(this._pause=!0,this._player&&(this._player.paused=!0),this._soundChannelArr.length>0)for(var t,e=this._soundChannelArr.length,i=0;i<e;i++)(t=this._soundChannelArr[i]).isStopped||t.pause();this.timer.clear(this,this._update)}}},{key:"resume",value:function(){if(this._indexControl=!1,this._pause){if(this._pause=!1,this._player&&(this._player.paused=!1),this._soundChannelArr.length>0)for(var t,e=this._soundChannelArr.length,i=0;i<e;i++)(t=this._soundChannelArr[i]).audioBuffer&&t.resume();this._lastTime=n.ILaya.Browser.now(),this.timer.frameLoop(1,this,this._update,null,!0)}}},{key:"_getGrahicsDataWithCache",value:function(t,e){return this._graphicsCache[t][e]}},{key:"_setGrahicsDataWithCache",value:function(t,e,i){this._graphicsCache[t][e]=i}},{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];e(r(a.prototype),"destroy",this).call(this,t),this._templet._removeReference(1),this._templet=null,this._player&&this._player.offAll(),this._player=null,this._curOriginalData=null,this._boneMatrixArray.length=0,this._lastTime=0,this.timer.clear(this,this._update),this._soundChannelArr.length>0&&this._onAniSoundStoped(!0)}},{key:"url",get:function(){return this._aniPath},set:function(t){this.load(t)}},{key:"index",get:function(){return this._index},set:function(t){this.player&&(this._index=t,this._player.currentTime=1e3*this._index/this._player.cacheFrameRate,this._indexControl=!0,this._update(!1))}},{key:"total",get:function(){return this._templet&&this._player?this._total=Math.floor(this._templet.getAniDuration(this._player.currentAnimationClipIndex)/1e3*this._player.cacheFrameRate):this._total=-1,this._total}},{key:"player",get:function(){return this._player}},{key:"templet",get:function(){return this._templet}}]),a}();E.useSimpleMeshInCanvas=!1,o.Skeleton=E,n.ILaya.regClass(E),n.ClassUtils.regClass("laya.ani.bone.Skeleton",E),n.ClassUtils.regClass("Laya.Skeleton",E);var R=function t(){l(this,t),this.slotArr=[]},N=function(){function t(){l(this,t)}return h(t,[{key:"createTexture",value:function(t){return this.texture?this.texture:(this.texture=new n.Texture(t.bitmap,this.uvs),this.uvs[0]>this.uvs[4]&&this.uvs[1]>this.uvs[5]?(this.texture.width=t.height,this.texture.height=t.width,this.texture.offsetX=-t.offsetX,this.texture.offsetY=-t.offsetY,this.texture.sourceWidth=t.sourceHeight,this.texture.sourceHeight=t.sourceWidth):(this.texture.width=t.width,this.texture.height=t.height,this.texture.offsetX=-t.offsetX,this.texture.offsetY=-t.offsetY,this.texture.sourceWidth=t.sourceWidth,this.texture.sourceHeight=t.sourceHeight),this.texture)}},{key:"destory",value:function(){this.texture&&this.texture.destroy()}}]),t}(),O=function(){function t(){l(this,t),this.displayArr=[]}return h(t,[{key:"getDisplayByName",value:function(t){for(var e=0,i=this.displayArr.length;e<i;e++)if(this.displayArr[e].attachmentName==t)return e;return-1}}]),t}(),V=function t(){l(this,t),this.boneIndexs=[]},Y=function(t){function a(){var t;return l(this,a),(t=i(this,r(a).apply(this,arguments)))._graphicsCache=[],t.srcBoneMatrixArr=[],t.ikArr=[],t.tfArr=[],t.pathArr=[],t.boneSlotDic={},t.bindBoneBoneSlotDic={},t.boneSlotArray=[],t.skinDataArray=[],t.skinDic={},t.subTextureDic={},t.isParseFail=!1,t.drawOrderAniArr=[],t.eventAniArr=[],t.attachmentNames=null,t.deformAniArr=[],t.skinSlotDisplayDataArr=[],t._isParseAudio=!1,t._isDestroyed=!1,t._rate=30,t.isParserComplete=!1,t.aniSectionDic={},t._textureDic={},t.mBoneArr=[],t}return s(a,g),h(a,[{key:"loadAni",value:function(t){this._skBufferUrl=t,n.ILaya.loader.load(t,n.Handler.create(this,this.onComplete),null,n.ILaya.Loader.BUFFER)}},{key:"onComplete",value:function(){if(arguments.length>0&&void 0!==arguments[0]&&arguments[0],this._isDestroyed)this.destroy();else{var t=n.ILaya.Loader.getRes(this._skBufferUrl);t?(this._path=this._skBufferUrl.slice(0,this._skBufferUrl.lastIndexOf("/"))+"/",this.parseData(null,t)):this.event(n.Event.ERROR,"load failed:"+this._skBufferUrl)}}},{key:"parseData",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30;if(!this._path){var a=this._relativeUrl||this.url;if(a){var r=a.lastIndexOf("/");this._path=r>0?a.slice(0,r)+"/":""}}this._mainTexture=t,this._rate=i,this.parse(e)}},{key:"buildArmature",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new E(this,t)}},{key:"parse",value:function(t){e(r(a.prototype),"parse",this).call(this,t),this.event(n.Event.LOADED,this),this._aniVersion===a.LAYA_ANIMATION_VISION?this._isParseAudio=!0:this._aniVersion!=a.LAYA_ANIMATION_160_VISION&&console.log("[Error] 版本不一致，请使用IDE版本配套的重新导出"+this._aniVersion+"->"+a.LAYA_ANIMATION_VISION),this._mainTexture?this._parsePublicExtData():this._parseTexturePath()}},{key:"_parseTexturePath",value:function(){if(this._isDestroyed)this.destroy();else{var t=0;this._loadList=[];var e,i=new n.Byte(this.getPublicExtData()),a=i.getInt32(),r=i.readUTFString(),s=r.split("\n");for(t=0;t<a;t++)e=this._path+s[2*t],r=s[2*t+1],i.getFloat32(),i.getFloat32(),i.getFloat32(),i.getFloat32(),i.getFloat32(),i.getFloat32(),i.getFloat32(),i.getFloat32(),-1==this._loadList.indexOf(e)&&this._loadList.push(e);n.ILaya.loader.load(this._loadList,n.Handler.create(this,this._textureComplete))}}},{key:"_textureComplete",value:function(){for(var t,e=0,i=this._loadList.length;e<i;e++)t=this._loadList[e],this._textureDic[t]=n.ILaya.Loader.getRes(t);this._parsePublicExtData()}},{key:"_parsePublicExtData",value:function(){var t,e=0,i=0,a=0,r=0,s=0;for(e=0,s=this.getAnimationCount();e<s;e++)this._graphicsCache.push([]);t="Dragon"!=this._aniClassName;var h,l,o=new n.Byte(this.getPublicExtData()),u=0,c=0,p=0,_=0,d=0,f=0,y=0,m=0,g=0,v=o.getInt32(),D=o.readUTFString(),k=D.split("\n");for(e=0;e<v;e++){if(h=this._mainTexture,l=this._path+k[2*e],D=k[2*e+1],null==this._mainTexture&&(h=this._textureDic[l]),!h)return this.event(n.Event.ERROR,this),void(this.isParseFail=!0);u=o.getFloat32(),c=o.getFloat32(),p=o.getFloat32(),_=o.getFloat32(),g=o.getFloat32(),d=isNaN(g)?0:g,g=o.getFloat32(),f=isNaN(g)?0:g,g=o.getFloat32(),y=isNaN(g)?p:g,g=o.getFloat32(),m=isNaN(g)?_:g,this.subTextureDic[D]=n.Texture.create(h,u,c,p,_,-d,-f,y,m)}this._mainTexture=h;var I,w,L,B,E,Y=o.getUint16();for(e=0;e<Y;e++)(I=[]).push(o.getUint16()),I.push(o.getUint16()),I.push(o.getUint16()),I.push(o.getUint16()),this.aniSectionDic[e]=I;var K,X=o.getInt16(),W={};for(e=0;e<X;e++)w=new M,0==e?K=w:w.root=K,w.d=t?-1:1,B=o.readUTFString(),E=o.readUTFString(),w.length=o.getFloat32(),1==o.getByte()&&(w.inheritRotation=!1),1==o.getByte()&&(w.inheritScale=!1),w.name=B,E&&((L=W[E])?L.addChild(w):this.mRootBone=w),W[B]=w,this.mBoneArr.push(w);this.tMatrixDataLen=o.getUint16();var z,G,q=o.getUint16(),H=Math.floor(q/this.tMatrixDataLen),j=this.srcBoneMatrixArr;for(e=0;e<H;e++)(z=new x).scX=o.getFloat32(),z.skX=o.getFloat32(),z.skY=o.getFloat32(),z.scY=o.getFloat32(),z.x=o.getFloat32(),z.y=o.getFloat32(),8===this.tMatrixDataLen&&(z.skewX=o.getFloat32(),z.skewY=o.getFloat32()),j.push(z),(w=this.mBoneArr[e]).transform=z;var Q,Z,J=o.getUint16();for(e=0;e<J;e++){for(G=new P,Q=o.getUint16(),i=0;i<Q;i++)G.boneNames.push(o.readUTFString()),G.boneIndexs.push(o.getInt16());G.name=o.readUTFString(),G.targetBoneName=o.readUTFString(),G.targetBoneIndex=o.getInt16(),G.bendDirection=o.getFloat32(),G.mix=o.getFloat32(),G.isSpine=t,this.ikArr.push(G)}var $,tt,et=o.getUint16();for(e=0;e<et;e++){for(Z=new V,$=o.getUint16(),i=0;i<$;i++)Z.boneIndexs.push(o.getInt16());Z.name=o.getUTFString(),Z.targetIndex=o.getInt16(),Z.rotateMix=o.getFloat32(),Z.translateMix=o.getFloat32(),Z.scaleMix=o.getFloat32(),Z.shearMix=o.getFloat32(),Z.offsetRotation=o.getFloat32(),Z.offsetX=o.getFloat32(),Z.offsetY=o.getFloat32(),Z.offsetScaleX=o.getFloat32(),Z.offsetScaleY=o.getFloat32(),Z.offsetShearY=o.getFloat32(),this.tfArr.push(Z)}var it,at,rt,st,nt,ht,lt,ot,ut,ct,pt=o.getUint16();for(e=0;e<pt;e++){for((tt=new U).name=o.readUTFString(),it=o.getUint16(),i=0;i<it;i++)tt.bones.push(o.getInt16());tt.target=o.readUTFString(),tt.positionMode=o.readUTFString(),tt.spacingMode=o.readUTFString(),tt.rotateMode=o.readUTFString(),tt.offsetRotation=o.getFloat32(),tt.position=o.getFloat32(),tt.spacing=o.getFloat32(),tt.rotateMix=o.getFloat32(),tt.translateMix=o.getFloat32(),this.pathArr.push(tt)}var _t,dt=o.getInt16();for(e=0;e<dt;e++){var ft=o.getUint8(),yt={};this.deformAniArr.push(yt);for(var mt=0;mt<ft;mt++)for((lt=new S).skinName=o.getUTFString(),yt[lt.skinName]=lt,at=o.getInt16(),i=0;i<at;i++)for(ot=new b,lt.deformSlotDataList.push(ot),rt=o.getInt16(),a=0;a<rt;a++)for(ut=new T,ot.deformSlotDisplayList.push(ut),ut.slotIndex=o.getInt16(),ut.attachment=o.getUTFString(),st=o.getInt16(),r=0;r<st;r++)for(1==o.getByte()?ut.tweenKeyList.push(!0):ut.tweenKeyList.push(!1),nt=o.getFloat32(),ut.timeList.push(nt),ct=[],ut.vectices.push(ct),ht=o.getInt16(),s=0;s<ht;s++)ct.push(o.getFloat32())}var gt,vt,xt,Mt,Dt=o.getInt16();for(e=0;e<Dt;e++){for(gt=o.getInt16(),_t=[],i=0;i<gt;i++){for((vt=new C).time=o.getFloat32(),xt=o.getInt16(),a=0;a<xt;a++)vt.drawOrder.push(o.getInt16());_t.push(vt)}this.drawOrderAniArr.push(_t)}var kt,It,At=o.getInt16();for(e=0;e<At;e++){for(kt=o.getInt16(),Mt=[],i=0;i<kt;i++)(It=new F).name=o.getUTFString(),this._isParseAudio&&(It.audioValue=o.getUTFString()),It.intValue=o.getInt32(),It.floatValue=o.getFloat32(),It.stringValue=o.getUTFString(),It.time=o.getFloat32(),Mt.push(It);this.eventAniArr.push(Mt)}var St=o.getInt16();if(St>0)for(this.attachmentNames=[],e=0;e<St;e++)this.attachmentNames.push(o.getUTFString());var bt,Tt,Ct=o.getInt16();for(e=0;e<Ct;e++)(bt=new A).name=o.readUTFString(),bt.parent=o.readUTFString(),bt.attachmentName=o.readUTFString(),bt.srcDisplayIndex=bt.displayIndex=o.getInt16(),bt.templet=this,this.boneSlotDic[bt.name]=bt,null==(Tt=this.bindBoneBoneSlotDic[bt.parent])&&(this.bindBoneBoneSlotDic[bt.parent]=Tt=[]),Tt.push(bt),this.boneSlotArray.push(bt);var Ft,wt,Pt,Lt,Ut,Bt,Et,Rt,Nt,Ot,Vt=o.readUTFString().split("\n"),Yt=0,Kt=o.getUint8();for(e=0;e<Kt;e++){for((Ft=new R).name=Vt[Yt++],Lt=o.getUint8(),i=0;i<Lt;i++){for((wt=new O).name=Vt[Yt++],bt=this.boneSlotDic[wt.name],Ut=o.getUint8(),a=0;a<Ut;a++){if(Pt=new N,this.skinSlotDisplayDataArr.push(Pt),Pt.name=Vt[Yt++],Pt.attachmentName=Vt[Yt++],Pt.transform=new x,Pt.transform.scX=o.getFloat32(),Pt.transform.skX=o.getFloat32(),Pt.transform.skY=o.getFloat32(),Pt.transform.scY=o.getFloat32(),Pt.transform.x=o.getFloat32(),Pt.transform.y=o.getFloat32(),wt.displayArr.push(Pt),Pt.width=o.getFloat32(),Pt.height=o.getFloat32(),Pt.type=o.getUint8(),Pt.verLen=o.getUint16(),(X=o.getUint16())>0)for(Pt.bones=[],r=0;r<X;r++){var Xt=o.getUint16();Pt.bones.push(Xt)}if((Bt=o.getUint16())>0)for(Pt.uvs=[],r=0;r<Bt;r++)Pt.uvs.push(o.getFloat32());if((Et=o.getUint16())>0)for(Pt.weights=[],r=0;r<Et;r++)Pt.weights.push(o.getFloat32());if((Rt=o.getUint16())>0)for(Pt.triangles=[],r=0;r<Rt;r++)Pt.triangles.push(o.getUint16());if((Nt=o.getUint16())>0)for(Pt.vertices=[],r=0;r<Nt;r++)Pt.vertices.push(o.getFloat32());if((Ot=o.getUint16())>0)for(Pt.lengths=[],r=0;r<Ot;r++)Pt.lengths.push(o.getFloat32())}Ft.slotArr.push(wt)}this.skinDic[Ft.name]=Ft,this.skinDataArray.push(Ft)}1==o.getUint8()?(this.yReverseMatrix=new n.Matrix(1,0,0,-1,0,0),K&&K.setTempMatrix(this.yReverseMatrix)):K&&K.setTempMatrix(new n.Matrix),this.showSkinByIndex(this.boneSlotDic,0),this.isParserComplete=!0,this.event(n.Event.COMPLETE,this)}},{key:"getTexture",value:function(t){var e=this.subTextureDic[t];return e||(e=this.subTextureDic[t.substr(0,t.length-1)]),null==e?this._mainTexture:e}},{key:"showSkinByIndex",value:function(t,e){var i,a,r,s,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(e<0&&e>=this.skinDataArray.length)return!1;var h=this.skinDataArray[e];if(h){for(i=0,a=h.slotArr.length;i<a;i++)(s=h.slotArr[i])&&(r=t[s.name])&&(r.showSlotData(s,n),n&&"undefined"!=r.attachmentName&&"null"!=r.attachmentName?r.showDisplayByName(r.attachmentName):r.showDisplayByIndex(r.displayIndex));return!0}return!1}},{key:"getSkinIndexByName",value:function(t){for(var e=0,i=this.skinDataArray.length;e<i;e++)if(this.skinDataArray[e].name==t)return e;return-1}},{key:"getGrahicsDataWithCache",value:function(t,e){return this._graphicsCache[t]&&this._graphicsCache[t][e]?this._graphicsCache[t][e]:null}},{key:"_setCreateURL",value:function(t){this._skBufferUrl=this._relativeUrl=t,e(r(a.prototype),"_setCreateURL",this).call(this,t)}},{key:"setGrahicsDataWithCache",value:function(t,e,i){this._graphicsCache[t][e]=i}},{key:"deleteAniData",value:function(t){if(this._anis[t]){var e=this._anis[t];e.bone3DMap=null,e.nodes=null}}},{key:"destroy",value:function(){var t;for(t in this._isDestroyed=!0,this.subTextureDic)t&&this.subTextureDic[t].destroy();for(t in this._textureDic)t&&this._textureDic[t].destroy();for(var i=0,s=this.skinSlotDisplayDataArr.length;i<s;i++)this.skinSlotDisplayDataArr[i].destory();this.skinSlotDisplayDataArr.length=0,this._relativeUrl&&delete a.TEMPLET_DICTIONARY[this._relativeUrl],e(r(a.prototype),"destroy",this).call(this),n.ILaya.loader.clearRes(this._skBufferUrl)}},{key:"getAniNameByIndex",value:function(t){var e=this.getAnimation(t);return e?e.name:null}},{key:"rate",get:function(){return this._rate},set:function(t){this._rate=t}}]),a}();Y.LAYA_ANIMATION_160_VISION="LAYAANIMATION:1.6.0",Y.LAYA_ANIMATION_VISION="LAYAANIMATION:1.7.0",o.Templet=Y;var K=function(t){function o(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return l(this,o),(t=i(this,r(o).call(this)))._start=0,t._Pos=0,t._ended=!0,t._loadedImage={},t._endFrame=-1,t.interval=30,t._ids={},t._idOfSprite=[],t._reset(),t._playing=!1,t._parentMovieClip=e,e?(t._isRoot=!1,t._movieClipList=e._movieClipList,t._movieClipList.push(a(t))):(t._movieClipList=[a(t)],t._isRoot=!0,t._setBitUp(n.Const.DISPLAY)),t}return s(o,n.Sprite),h(o,[{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._clear(),e(r(o.prototype),"destroy",this).call(this,t)}},{key:"_setDisplay",value:function(t){e(r(o.prototype),"_setDisplay",this).call(this,t),this._isRoot&&this._onDisplay(t)}},{key:"_onDisplay",value:function(t){t?this.timer.loop(this.interval,this,this.updates,null,!0):this.timer.clear(this,this.updates)}},{key:"updates",value:function(){var t,e;if(!this._parentMovieClip)for(e=this._movieClipList.length,t=0;t<e;t++)this._movieClipList[t]&&this._movieClipList[t]._update()}},{key:"addLabel",value:function(t,e){this._labels||(this._labels={}),this._labels[e]=t}},{key:"removeLabel",value:function(t){if(t){if(!this._labels)for(var e in this._labels)if(this._labels[e]===t){delete this._labels[e];break}}else this._labels=null}},{key:"_update",value:function(){if(this._data&&this._playing){if(this._playIndex++,this._playIndex>=this._count){if(!this.loop)return this._playIndex--,void this.stop();this._playIndex=0}if(this._parseFrame(this._playIndex),this._labels&&this._labels[this._playIndex]&&this.event(n.Event.LABEL,this._labels[this._playIndex]),-1!=this._endFrame&&this._endFrame==this._playIndex){if(this._endFrame=-1,null!=this._completeHandler){var t=this._completeHandler;this._completeHandler=null,t.run()}this.stop()}}}},{key:"stop",value:function(){this._playing=!1}},{key:"gotoAndStop",value:function(t){this.index=t,this.stop()}},{key:"_clear",value:function(){if(this.stop(),this._idOfSprite.length=0,!this._parentMovieClip){var t,e;for(this.timer.clear(this,this.updates),e=this._movieClipList.length,t=0;t<e;t++)this._movieClipList[t]!=this&&this._movieClipList[t]._clear();this._movieClipList.length=0}var i;for(i in this._atlasPath&&n.ILaya.Loader.clearRes(this._atlasPath),this._loadedImage)this._loadedImage[i]&&(n.ILaya.Loader.clearRes(i),this._loadedImage[i]=!1);this.removeChildren(),this.graphics=null,this._parentMovieClip=null}},{key:"play",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.loop=e,this._playing=!0,this._data&&this._displayFrame(t)}},{key:"_displayFrame",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1;-1!=t&&(this._curIndex>t&&this._reset(),this._parseFrame(t))}},{key:"_reset",value:function(){(!(arguments.length>0&&void 0!==arguments[0])||arguments[0])&&1!=this._curIndex&&this.removeChildren(),this._preIndex=this._curIndex=-1,this._Pos=this._start}},{key:"_parseFrame",value:function(t){var e,i,a,r,s,h,l=!1,u=this._idOfSprite,c=this._data;for(this._ended&&this._reset(),c.pos=this._Pos,this._ended=!1,this._playIndex=t,this._curIndex>t&&t<this._preIndex&&(this._reset(!0),c.pos=this._Pos);this._curIndex<=t&&!this._ended;)switch(c.getUint16()){case 12:if(a=c.getUint16(),r=this._ids[c.getUint16()],this._Pos=c.pos,c.pos=r,0==(s=c.getUint8())){var p=c.getUint16();if(!(i=u[a])){i=u[a]=new n.Sprite;var _=new n.Sprite;_.loadImage(this.basePath+p+".png"),this._loadedImage[this.basePath+p+".png"]=!0,i.addChild(_),_.size(c.getFloat32(),c.getFloat32());var d=c._getMatrix();_.transform=d}i.alpha=1}else 1==s&&((e=u[a])||(u[a]=e=new o(this),e.interval=this.interval,e._ids=this._ids,e.basePath=this.basePath,e._setData(c,r),e._initState(),e.play(0)),e.alpha=1);c.pos=this._Pos;break;case 3:var f=u[c.getUint16()];f&&(this.addChild(f),f.zOrder=c.getUint16(),l=!0);break;case 4:(f=u[c.getUint16()])&&f.removeSelf();break;case 5:u[c.getUint16()][o._ValueList[c.getUint16()]]=c.getFloat32();break;case 6:u[c.getUint16()].visible=c.getUint8()>0;break;case 7:var y=(i=u[c.getUint16()]).transform||n.Matrix.create();y.setTo(c.getFloat32(),c.getFloat32(),c.getFloat32(),c.getFloat32(),c.getFloat32(),c.getFloat32()),i.transform=y;break;case 8:u[c.getUint16()].setPos(c.getFloat32(),c.getFloat32());break;case 9:u[c.getUint16()].setSize(c.getFloat32(),c.getFloat32());break;case 10:u[c.getUint16()].alpha=c.getFloat32();break;case 11:u[c.getUint16()].setScale(c.getFloat32(),c.getFloat32());break;case 98:h=c.getString(),this.event(h),"stop"==h&&this.stop();break;case 99:this._curIndex=c.getUint16(),l&&this.updateZOrder();break;case 100:this._count=this._curIndex+1,this._ended=!0,this._playing&&(this.event(n.Event.FRAME),this.event(n.Event.END),this.event(n.Event.COMPLETE)),this._reset(!1)}this._playing&&!this._ended&&this.event(n.Event.FRAME),this._Pos=c.pos}},{key:"_setData",value:function(t,e){this._data=t,this._start=e+3}},{key:"load",value:function(t){var e,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._url=t,i&&(this._atlasPath=a||t.split(".swf")[0]+".json"),this.stop(),this._clear(),this._movieClipList=[this],e=[{url:t,type:n.ILaya.Loader.BUFFER}],this._atlasPath&&e.push({url:this._atlasPath,type:n.ILaya.Loader.ATLAS}),n.ILaya.loader.load(e,n.Handler.create(this,this._onLoaded))}},{key:"_onLoaded",value:function(){var t;(t=n.ILaya.Loader.getRes(this._url))?!this._atlasPath||n.ILaya.Loader.getAtlas(this._atlasPath)?(this.basePath=this._atlasPath?n.ILaya.Loader.getAtlas(this._atlasPath).dir:this._url.split(".swf")[0]+"/image/",this._initData(t)):this.event(n.Event.ERROR,"Atlas not find"):this.event(n.Event.ERROR,"file not find")}},{key:"_initState",value:function(){this._reset(),this._ended=!1;var t=this._playing;for(this._playing=!1,this._curIndex=0;!this._ended;)this._parseFrame(++this._curIndex);this._playing=t}},{key:"_initData",value:function(t){this._data=new n.Byte(t);var e,i=this._data.getUint16();for(e=0;e<i;e++)this._ids[this._data.getInt16()]=this._data.getInt32();this.interval=1e3/this._data.getUint16(),this._setData(this._data,this._ids[32767]),this._initState(),this.play(0),this.event(n.Event.LOADED),this._parentMovieClip||this.timer.loop(this.interval,this,this.updates,null,!0)}},{key:"playTo",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._completeHandler=i,this._endFrame=e,this.play(t,!1)}},{key:"index",get:function(){return this._playIndex},set:function(t){this._playIndex=t,this._data&&this._displayFrame(this._playIndex),this._labels&&this._labels[t]&&this.event(n.Event.LABEL,this._labels[t])}},{key:"count",get:function(){return this._count}},{key:"playing",get:function(){return this._playing}},{key:"url",set:function(t){this.load(t)}}]),o}();K._ValueList=["x","y","width","height","scaleX","scaleY","rotation","alpha"],t.AnimationContent=u,t.AnimationNodeContent=c,t.AnimationParser01=_,t.AnimationParser02=d,t.AnimationPlayer=y,t.AnimationState=f,t.AnimationTemplet=g,t.BezierLerp=m,t.Bone=M,t.BoneSlot=A,t.DeformAniData=S,t.DeformSlotData=b,t.DeformSlotDisplayData=T,t.DrawOrderData=C,t.EventData=F,t.GraphicsAni=v,t.IAniLib=o,t.IkConstraint=w,t.IkConstraintData=P,t.KeyFramesContent=p,t.MeshData=k,t.MovieClip=K,t.PathConstraint=L,t.PathConstraintData=U,t.Skeleton=E,t.SkinData=R,t.SkinMeshForGraphic=I,t.SkinSlotDisplayData=N,t.SlotData=O,t.Templet=Y,t.TfConstraint=B,t.TfConstraintData=V,t.Transform=x,t.UVTools=D}(window.Laya=window.Laya||{},Laya)}(); 
 			}); 
		define("__plugin__/wx70d8aa25ec591f7a/laya.core.js", function(require, module, exports){ 			
"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _get(e,t,i){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=_superPropBase(e,t);if(n){var r=Object.getOwnPropertyDescriptor(n,t);return r.get?r.get.call(i):r.value}})(e,t,i||e)}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}window.Laya=function(e){var t=function Config(){_classCallCheck(this,Config)};t.animationInterval=50,t.isAntialias=!1,t.isAlpha=!1,t.premultipliedAlpha=!0,t.isStencil=!0,t.preserveDrawingBuffer=!1,t.webGL2D_MeshAllocMaxMem=!0,t.is2DPixelArtGame=!1,t.useWebGL2=!0,t.allowGPUInstanceDynamicBatch=!0,t.useRetinalCanvas=!1,window.Config=t;var i=function(){function ILaya(){_classCallCheck(this,ILaya)}return _createClass(ILaya,null,[{key:"regClass",value:function(e){ILaya.__classMap[e.name]=e}}]),ILaya}();i.Laya=null,i.Timer=null,i.WorkerLoader=null,i.Dragging=null,i.GraphicsBounds=null,i.Sprite=null,i.TextRender=null,i.TextAtlas=null,i.timer=null,i.systemTimer=null,i.startTimer=null,i.updateTimer=null,i.lateTimer=null,i.physicsTimer=null,i.stage=null,i.Loader=null,i.loader=null,i.TTFLoader=null,i.SoundManager=null,i.WebAudioSound=null,i.AudioSound=null,i.ShaderCompile=null,i.ClassUtils=null,i.SceneUtils=null,i.Context=null,i.Render=null,i.MouseManager=null,i.Text=null,i.Browser=null,i.WebGL=null,i.Pool=null,i.Utils=null,i.Graphics=null,i.Submit=null,i.Stage=null,i.Resource=null,i.__classMap={};var n=function(){function Pool(){_classCallCheck(this,Pool)}return _createClass(Pool,null,[{key:"getPoolBySign",value:function(e){return Pool._poolDic[e]||(Pool._poolDic[e]=[])}},{key:"clearBySign",value:function(e){Pool._poolDic[e]&&(Pool._poolDic[e].length=0)}},{key:"recover",value:function(e,t){t[Pool.POOLSIGN]||(t[Pool.POOLSIGN]=!0,Pool.getPoolBySign(e).push(t))}},{key:"recoverByClass",value:function(e){if(e){var t=e.__className||e.constructor._$gid;t&&Pool.recover(t,e)}}},{key:"_getClassSign",value:function(e){var t=e.__className||e._$gid;return t||(e._$gid=t=Pool._CLSID+"",Pool._CLSID++),t}},{key:"createByClass",value:function(e){return Pool.getItemByClass(Pool._getClassSign(e),e)}},{key:"getItemByClass",value:function(e,t){if(!Pool._poolDic[e])return new t;var i=Pool.getPoolBySign(e);if(i.length){var n=i.pop();n[Pool.POOLSIGN]=!1}else n=new t;return n}},{key:"getItemByCreateFun",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=Pool.getPoolBySign(e),r=n.length?n.pop():t.call(i);return r[Pool.POOLSIGN]=!1,r}},{key:"getItem",value:function(e){var t=Pool.getPoolBySign(e),i=t.length?t.pop():null;return i&&(i[Pool.POOLSIGN]=!1),i}}]),Pool}();n._CLSID=0,n.POOLSIGN="__InPool",n._poolDic={};var r=function(){function AlphaCmd(){_classCallCheck(this,AlphaCmd)}return _createClass(AlphaCmd,[{key:"recover",value:function(){n.recover("AlphaCmd",this)}},{key:"run",value:function(e,t,i){e.alpha(this.alpha)}},{key:"cmdID",get:function(){return AlphaCmd.ID}}],[{key:"create",value:function(e){var t=n.getItemByClass("AlphaCmd",AlphaCmd);return t.alpha=e,t}}]),AlphaCmd}();r.ID="Alpha";var a=function(){function DrawCircleCmd(){_classCallCheck(this,DrawCircleCmd)}return _createClass(DrawCircleCmd,[{key:"recover",value:function(){this.fillColor=null,this.lineColor=null,n.recover("DrawCircleCmd",this)}},{key:"run",value:function(e,t,i){e._drawCircle(this.x+t,this.y+i,this.radius,this.fillColor,this.lineColor,this.lineWidth,this.vid)}},{key:"cmdID",get:function(){return DrawCircleCmd.ID}}],[{key:"create",value:function(e,t,i,r,a,s,o){var l=n.getItemByClass("DrawCircleCmd",DrawCircleCmd);return l.x=e,l.y=t,l.radius=i,l.fillColor=r,l.lineColor=a,l.lineWidth=s,l.vid=o,l}}]),DrawCircleCmd}();a.ID="DrawCircle";var s=function(){function DrawCurvesCmd(){_classCallCheck(this,DrawCurvesCmd)}return _createClass(DrawCurvesCmd,[{key:"recover",value:function(){this.points=null,this.lineColor=null,n.recover("DrawCurvesCmd",this)}},{key:"run",value:function(e,t,i){this.points&&e.drawCurves(this.x+t,this.y+i,this.points,this.lineColor,this.lineWidth)}},{key:"cmdID",get:function(){return DrawCurvesCmd.ID}}],[{key:"create",value:function(e,t,i,r,a){var s=n.getItemByClass("DrawCurvesCmd",DrawCurvesCmd);return s.x=e,s.y=t,s.points=i,s.lineColor=r,s.lineWidth=a,s}}]),DrawCurvesCmd}();s.ID="DrawCurves";var o=function(){function DrawImageCmd(){_classCallCheck(this,DrawImageCmd)}return _createClass(DrawImageCmd,[{key:"recover",value:function(){this.texture&&this.texture._removeReference(),this.texture=null,n.recover("DrawImageCmd",this)}},{key:"run",value:function(e,t,i){this.texture&&e.drawTexture(this.texture,this.x+t,this.y+i,this.width,this.height)}},{key:"cmdID",get:function(){return DrawImageCmd.ID}}],[{key:"create",value:function(e,t,i,r,a){var s=n.getItemByClass("DrawImageCmd",DrawImageCmd);return s.texture=e,e._addReference(),s.x=t,s.y=i,s.width=r,s.height=a,s}}]),DrawImageCmd}();o.ID="DrawImage";var l=function(){function DrawLineCmd(){_classCallCheck(this,DrawLineCmd)}return _createClass(DrawLineCmd,[{key:"recover",value:function(){n.recover("DrawLineCmd",this)}},{key:"run",value:function(e,t,i){e._drawLine(t,i,this.fromX,this.fromY,this.toX,this.toY,this.lineColor,this.lineWidth,this.vid)}},{key:"cmdID",get:function(){return DrawLineCmd.ID}}],[{key:"create",value:function(e,t,i,r,a,s,o){var l=n.getItemByClass("DrawLineCmd",DrawLineCmd);return l.fromX=e,l.fromY=t,l.toX=i,l.toY=r,l.lineColor=a,l.lineWidth=s,l.vid=o,l}}]),DrawLineCmd}();l.ID="DrawLine";var h=function(){function DrawLinesCmd(){_classCallCheck(this,DrawLinesCmd)}return _createClass(DrawLinesCmd,[{key:"recover",value:function(){this.points=null,this.lineColor=null,n.recover("DrawLinesCmd",this)}},{key:"run",value:function(e,t,i){this.points&&e._drawLines(this.x+t,this.y+i,this.points,this.lineColor,this.lineWidth,this.vid)}},{key:"cmdID",get:function(){return DrawLinesCmd.ID}}],[{key:"create",value:function(e,t,i,r,a,s){var o=n.getItemByClass("DrawLinesCmd",DrawLinesCmd);return o.x=e,o.y=t,o.points=i,o.lineColor=r,o.lineWidth=a,o.vid=s,o}}]),DrawLinesCmd}();h.ID="DrawLines";var u=function(){function DrawPathCmd(){_classCallCheck(this,DrawPathCmd)}return _createClass(DrawPathCmd,[{key:"recover",value:function(){this.paths=null,this.brush=null,this.pen=null,n.recover("DrawPathCmd",this)}},{key:"run",value:function(e,t,i){this.paths&&e._drawPath(this.x+t,this.y+i,this.paths,this.brush,this.pen)}},{key:"cmdID",get:function(){return DrawPathCmd.ID}}],[{key:"create",value:function(e,t,i,r,a){var s=n.getItemByClass("DrawPathCmd",DrawPathCmd);return s.x=e,s.y=t,s.paths=i,s.brush=r,s.pen=a,s}}]),DrawPathCmd}();u.ID="DrawPath";var c=function(){function DrawPieCmd(){_classCallCheck(this,DrawPieCmd)}return _createClass(DrawPieCmd,[{key:"recover",value:function(){this.fillColor=null,this.lineColor=null,n.recover("DrawPieCmd",this)}},{key:"run",value:function(e,t,i){e._drawPie(this.x+t,this.y+i,this.radius,this._startAngle,this._endAngle,this.fillColor,this.lineColor,this.lineWidth,this.vid)}},{key:"cmdID",get:function(){return DrawPieCmd.ID}},{key:"startAngle",get:function(){return 180*this._startAngle/Math.PI},set:function(e){this._startAngle=e*Math.PI/180}},{key:"endAngle",get:function(){return 180*this._endAngle/Math.PI},set:function(e){this._endAngle=e*Math.PI/180}}],[{key:"create",value:function(e,t,i,r,a,s,o,l,h){var u=n.getItemByClass("DrawPieCmd",DrawPieCmd);return u.x=e,u.y=t,u.radius=i,u._startAngle=r,u._endAngle=a,u.fillColor=s,u.lineColor=o,u.lineWidth=l,u.vid=h,u}}]),DrawPieCmd}();c.ID="DrawPie";var _=function(){function DrawPolyCmd(){_classCallCheck(this,DrawPolyCmd)}return _createClass(DrawPolyCmd,[{key:"recover",value:function(){this.points=null,this.fillColor=null,this.lineColor=null,n.recover("DrawPolyCmd",this)}},{key:"run",value:function(e,t,i){this.points&&e._drawPoly(this.x+t,this.y+i,this.points,this.fillColor,this.lineColor,this.lineWidth,this.isConvexPolygon,this.vid)}},{key:"cmdID",get:function(){return DrawPolyCmd.ID}}],[{key:"create",value:function(e,t,i,r,a,s,o,l){var h=n.getItemByClass("DrawPolyCmd",DrawPolyCmd);return h.x=e,h.y=t,h.points=i,h.fillColor=r,h.lineColor=a,h.lineWidth=s,h.isConvexPolygon=o,h.vid=l,h}}]),DrawPolyCmd}();_.ID="DrawPoly";var d=function(){function DrawRectCmd(){_classCallCheck(this,DrawRectCmd)}return _createClass(DrawRectCmd,[{key:"recover",value:function(){this.fillColor=null,this.lineColor=null,n.recover("DrawRectCmd",this)}},{key:"run",value:function(e,t,i){e.drawRect(this.x+t,this.y+i,this.width,this.height,this.fillColor,this.lineColor,this.lineWidth)}},{key:"cmdID",get:function(){return DrawRectCmd.ID}}],[{key:"create",value:function(e,t,i,r,a,s,o){var l=n.getItemByClass("DrawRectCmd",DrawRectCmd);return l.x=e,l.y=t,l.width=i,l.height=r,l.fillColor=a,l.lineColor=s,l.lineWidth=o,l}}]),DrawRectCmd}();d.ID="DrawRect";var f=function(){function Matrix(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;if(_classCallCheck(this,Matrix),this._bTransform=!1,null!=Matrix._createFun)return Matrix._createFun(e,t,i,n,r,a,s);this.a=e,this.b=t,this.c=i,this.d=n,this.tx=r,this.ty=a,this._checkTransform()}return _createClass(Matrix,[{key:"identity",value:function(){return this.a=this.d=1,this.b=this.tx=this.ty=this.c=0,this._bTransform=!1,this}},{key:"_checkTransform",value:function(){return this._bTransform=1!==this.a||0!==this.b||0!==this.c||1!==this.d}},{key:"setTranslate",value:function(e,t){return this.tx=e,this.ty=t,this}},{key:"translate",value:function(e,t){return this.tx+=e,this.ty+=t,this}},{key:"scale",value:function(e,t){return this.a*=e,this.d*=t,this.c*=e,this.b*=t,this.tx*=e,this.ty*=t,this._bTransform=!0,this}},{key:"rotate",value:function(e){var t=Math.cos(e),i=Math.sin(e),n=this.a,r=this.c,a=this.tx;return this.a=n*t-this.b*i,this.b=n*i+this.b*t,this.c=r*t-this.d*i,this.d=r*i+this.d*t,this.tx=a*t-this.ty*i,this.ty=a*i+this.ty*t,this._bTransform=!0,this}},{key:"skew",value:function(e,t){var i=Math.tan(e),n=Math.tan(t),r=this.a,a=this.b;return this.a+=n*this.c,this.b+=n*this.d,this.c+=i*r,this.d+=i*a,this}},{key:"invertTransformPoint",value:function(e){var t=this.a,i=this.b,n=this.c,r=this.d,a=this.tx,s=t*r-i*n,o=r/s,l=-i/s,h=-n/s,u=t/s,c=(n*this.ty-r*a)/s,_=-(t*this.ty-i*a)/s;return e.setTo(o*e.x+h*e.y+c,l*e.x+u*e.y+_)}},{key:"transformPoint",value:function(e){return e.setTo(this.a*e.x+this.c*e.y+this.tx,this.b*e.x+this.d*e.y+this.ty)}},{key:"transformPointN",value:function(e){return e.setTo(this.a*e.x+this.c*e.y,this.b*e.x+this.d*e.y)}},{key:"getScaleX",value:function(){return 0===this.b?this.a:Math.sqrt(this.a*this.a+this.b*this.b)}},{key:"getScaleY",value:function(){return 0===this.c?this.d:Math.sqrt(this.c*this.c+this.d*this.d)}},{key:"invert",value:function(){var e=this.a,t=this.b,i=this.c,n=this.d,r=this.tx,a=e*n-t*i;return this.a=n/a,this.b=-t/a,this.c=-i/a,this.d=e/a,this.tx=(i*this.ty-n*r)/a,this.ty=-(e*this.ty-t*r)/a,this}},{key:"setTo",value:function(e,t,i,n,r,a){return this.a=e,this.b=t,this.c=i,this.d=n,this.tx=r,this.ty=a,this}},{key:"concat",value:function(e){var t=this.a,i=this.c,n=this.tx;return this.a=t*e.a+this.b*e.c,this.b=t*e.b+this.b*e.d,this.c=i*e.a+this.d*e.c,this.d=i*e.b+this.d*e.d,this.tx=n*e.a+this.ty*e.c+e.tx,this.ty=n*e.b+this.ty*e.d+e.ty,this}},{key:"scaleEx",value:function(e,t){var i=this.a,n=this.b,r=this.c,a=this.d;0!==n||0!==r?(this.a=e*i,this.b=e*n,this.c=t*r,this.d=t*a):(this.a=e*i,this.b=0*a,this.c=0*i,this.d=t*a),this._bTransform=!0}},{key:"rotateEx",value:function(e){var t=Math.cos(e),i=Math.sin(e),n=this.a,r=this.b,a=this.c,s=this.d;0!==r||0!==a?(this.a=t*n+i*a,this.b=t*r+i*s,this.c=-i*n+t*a,this.d=-i*r+t*s):(this.a=t*n,this.b=i*s,this.c=-i*n,this.d=t*s),this._bTransform=!0}},{key:"clone",value:function(){var e=Matrix.create();return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e._bTransform=this._bTransform,e}},{key:"copyTo",value:function(e){return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e._bTransform=this._bTransform,e}},{key:"toString",value:function(){return this.a+","+this.b+","+this.c+","+this.d+","+this.tx+","+this.ty}},{key:"destroy",value:function(){this.recover()}},{key:"recover",value:function(){n.recover("Matrix",this.identity())}}],[{key:"mul",value:function(e,t,i){var n=e.a,r=e.b,a=e.c,s=e.d,o=e.tx,l=e.ty,h=t.a,u=t.b,c=t.c,_=t.d,d=t.tx,f=t.ty;return 0!==u||0!==c?(i.a=n*h+r*c,i.b=n*u+r*_,i.c=a*h+s*c,i.d=a*u+s*_,i.tx=h*o+c*l+d,i.ty=u*o+_*l+f):(i.a=n*h,i.b=r*_,i.c=a*h,i.d=s*_,i.tx=h*o+d,i.ty=_*l+f),i}},{key:"mul16",value:function(e,t,i){var n=e.a,r=e.b,a=e.c,s=e.d,o=e.tx,l=e.ty,h=t.a,u=t.b,c=t.c,_=t.d,d=t.tx,f=t.ty;return 0!==u||0!==c?(i[0]=n*h+r*c,i[1]=n*u+r*_,i[4]=a*h+s*c,i[5]=a*u+s*_,i[12]=h*o+c*l+d,i[13]=u*o+_*l+f):(i[0]=n*h,i[1]=r*_,i[4]=a*h,i[5]=s*_,i[12]=h*o+d,i[13]=_*l+f),i}},{key:"create",value:function(){return n.getItemByClass("Matrix",Matrix)}}]),Matrix}();f.EMPTY=new f,f.TEMP=new f,f._createFun=null;var v=function(){function Point(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;_classCallCheck(this,Point),this.x=e,this.y=t}return _createClass(Point,[{key:"setTo",value:function(e,t){return this.x=e,this.y=t,this}},{key:"reset",value:function(){return this.x=this.y=0,this}},{key:"recover",value:function(){n.recover("Point",this.reset())}},{key:"distance",value:function(e,t){return Math.sqrt((this.x-e)*(this.x-e)+(this.y-t)*(this.y-t))}},{key:"toString",value:function(){return this.x+","+this.y}},{key:"normalize",value:function(){var e=Math.sqrt(this.x*this.x+this.y*this.y);if(e>0){var t=1/e;this.x*=t,this.y*=t}}},{key:"copy",value:function(e){return this.setTo(e.x,e.y)}}],[{key:"create",value:function(){return n.getItemByClass("Point",Point)}}]),Point}();v.TEMP=new v,v.EMPTY=new v;var p=function(){function Rectangle(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;_classCallCheck(this,Rectangle),this.x=e,this.y=t,this.width=i,this.height=n}return _createClass(Rectangle,[{key:"setTo",value:function(e,t,i,n){return this.x=e,this.y=t,this.width=i,this.height=n,this}},{key:"reset",value:function(){return this.x=this.y=this.width=this.height=0,this}},{key:"recover",value:function(){this!=Rectangle.TEMP&&this!=Rectangle.EMPTY?n.recover("Rectangle",this.reset()):console.log("recover Temp or Empty:",this)}},{key:"copyFrom",value:function(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this}},{key:"contains",value:function(e,t){return!(this.width<=0||this.height<=0)&&(e>=this.x&&e<this.right&&t>=this.y&&t<this.bottom)}},{key:"intersects",value:function(e){return!(e.x>this.x+this.width||e.x+e.width<this.x||e.y>this.y+this.height||e.y+e.height<this.y)}},{key:"intersection",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.intersects(e)?(t||(t=new Rectangle),t.x=Math.max(this.x,e.x),t.y=Math.max(this.y,e.y),t.width=Math.min(this.right,e.right)-t.x,t.height=Math.min(this.bottom,e.bottom)-t.y,t):null}},{key:"union",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return t||(t=new Rectangle),this.clone(t),e.width<=0||e.height<=0?t:(t.addPoint(e.x,e.y),t.addPoint(e.right,e.bottom),this)}},{key:"clone",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return e||(e=new Rectangle),e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e}},{key:"toString",value:function(){return this.x+","+this.y+","+this.width+","+this.height}},{key:"equals",value:function(e){return!(!e||e.x!==this.x||e.y!==this.y||e.width!==this.width||e.height!==this.height)}},{key:"addPoint",value:function(e,t){return this.x>e&&(this.width+=this.x-e,this.x=e),this.y>t&&(this.height+=this.y-t,this.y=t),this.width<e-this.x&&(this.width=e-this.x),this.height<t-this.y&&(this.height=t-this.y),this}},{key:"_getBoundPoints",value:function(){var e=Rectangle._temB;return e.length=0,0==this.width||0==this.height?e:(e.push(this.x,this.y,this.x+this.width,this.y,this.x,this.y+this.height,this.x+this.width,this.y+this.height),e)}},{key:"isEmpty",value:function(){return this.width<=0||this.height<=0}},{key:"right",get:function(){return this.x+this.width}},{key:"bottom",get:function(){return this.y+this.height}}],[{key:"create",value:function(){return n.getItemByClass("Rectangle",Rectangle)}},{key:"_getBoundPointS",value:function(e,t,i,n){var r=Rectangle._temA;return r.length=0,0==i||0==n?r:(r.push(e,t,e+i,t,e,t+n,e+i,t+n),r)}},{key:"_getWrapRec",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!e||e.length<1)return t?t.setTo(0,0,0,0):Rectangle.TEMP.setTo(0,0,0,0);t=t||Rectangle.create();var i,n,r,a,s,o=e.length,l=v.TEMP;for(r=s=-(n=a=99999),i=0;i<o;i+=2)l.x=e[i],l.y=e[i+1],n=n<l.x?n:l.x,a=a<l.y?a:l.y,r=r>l.x?r:l.x,s=s>l.y?s:l.y;return t.setTo(n,a,r-n,s-a)}}]),Rectangle}();p.EMPTY=new p,p.TEMP=new p,p._temB=[],p._temA=[];var g=function LayaGL(){_classCallCheck(this,LayaGL)};g.ARRAY_BUFFER_TYPE_DATA=0,g.ARRAY_BUFFER_TYPE_CMD=1,g.ARRAY_BUFFER_REF_REFERENCE=0,g.ARRAY_BUFFER_REF_COPY=1,g.UPLOAD_SHADER_UNIFORM_TYPE_ID=0,g.UPLOAD_SHADER_UNIFORM_TYPE_DATA=1;var y=function(){function WebGLContext(){_classCallCheck(this,WebGLContext)}return _createClass(WebGLContext,null,[{key:"__init__",value:function(){var e=g.instance;WebGLContext._depthFunc=e.LESS,WebGLContext._blendEquation=e.FUNC_ADD,WebGLContext._blendEquationRGB=e.FUNC_ADD,WebGLContext._blendEquationAlpha=e.FUNC_ADD,WebGLContext._sFactor=e.ONE,WebGLContext._dFactor=e.ZERO,WebGLContext._sFactorAlpha=e.ONE,WebGLContext._dFactorAlpha=e.ZERO,WebGLContext._activedTextureID=e.TEXTURE0,WebGLContext._glTextureIDs=[e.TEXTURE0,e.TEXTURE1,e.TEXTURE2,e.TEXTURE3,e.TEXTURE4,e.TEXTURE5,e.TEXTURE6,e.TEXTURE7]}},{key:"useProgram",value:function(e,t){return WebGLContext._useProgram!==t&&(e.useProgram(t),WebGLContext._useProgram=t,!0)}},{key:"setDepthTest",value:function(e,t){t!==WebGLContext._depthTest&&(WebGLContext._depthTest=t,t?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST))}},{key:"setDepthMask",value:function(e,t){t!==WebGLContext._depthMask&&(WebGLContext._depthMask=t,e.depthMask(t))}},{key:"setDepthFunc",value:function(e,t){t!==WebGLContext._depthFunc&&(WebGLContext._depthFunc=t,e.depthFunc(t))}},{key:"setBlend",value:function(e,t){t!==WebGLContext._blend&&(WebGLContext._blend=t,t?e.enable(e.BLEND):e.disable(e.BLEND))}},{key:"setBlendEquation",value:function(e,t){t!==WebGLContext._blendEquation&&(WebGLContext._blendEquation=t,WebGLContext._blendEquationRGB=WebGLContext._blendEquationAlpha=null,e.blendEquation(t))}},{key:"setBlendEquationSeparate",value:function(e,t,i){t===WebGLContext._blendEquationRGB&&i===WebGLContext._blendEquationAlpha||(WebGLContext._blendEquationRGB=t,WebGLContext._blendEquationAlpha=i,WebGLContext._blendEquation=null,e.blendEquationSeparate(t,i))}},{key:"setBlendFunc",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];(n||t!==WebGLContext._sFactor||i!==WebGLContext._dFactor)&&(WebGLContext._sFactor=t,WebGLContext._dFactor=i,WebGLContext._sFactorRGB=null,WebGLContext._dFactorRGB=null,WebGLContext._sFactorAlpha=null,WebGLContext._dFactorAlpha=null,e.blendFunc(t,i))}},{key:"setBlendFuncSeperate",value:function(e,t,i,n,r){t===WebGLContext._sFactorRGB&&i===WebGLContext._dFactorRGB&&n===WebGLContext._sFactorAlpha&&r===WebGLContext._dFactorAlpha||(WebGLContext._sFactorRGB=t,WebGLContext._dFactorRGB=i,WebGLContext._sFactorAlpha=n,WebGLContext._dFactorAlpha=r,WebGLContext._sFactor=null,WebGLContext._dFactor=null,e.blendFuncSeparate(t,i,n,r))}},{key:"setCullFace",value:function(e,t){t!==WebGLContext._cullFace&&(WebGLContext._cullFace=t,t?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE))}},{key:"setFrontFace",value:function(e,t){t!==WebGLContext._frontFace&&(WebGLContext._frontFace=t,e.frontFace(t))}},{key:"activeTexture",value:function(e,t){WebGLContext._activedTextureID!==t&&(e.activeTexture(t),WebGLContext._activedTextureID=t)}},{key:"bindTexture",value:function(e,t,i){WebGLContext._activeTextures[WebGLContext._activedTextureID-e.TEXTURE0]!==i&&(e.bindTexture(t,i),WebGLContext._activeTextures[WebGLContext._activedTextureID-e.TEXTURE0]=i)}},{key:"__init_native",value:function(){if(i.Render.supportWebGLPlusRendering){var e=WebGLContext;e.activeTexture=e.activeTextureForNative,e.bindTexture=e.bindTextureForNative}}},{key:"useProgramForNative",value:function(e,t){return e.useProgram(t),!0}},{key:"setDepthTestForNative",value:function(e,t){t?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST)}},{key:"setDepthMaskForNative",value:function(e,t){e.depthMask(t)}},{key:"setDepthFuncForNative",value:function(e,t){e.depthFunc(t)}},{key:"setBlendForNative",value:function(e,t){t?e.enable(e.BLEND):e.disable(e.BLEND)}},{key:"setBlendFuncForNative",value:function(e,t,i){e.blendFunc(t,i)}},{key:"setCullFaceForNative",value:function(e,t){t?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE)}},{key:"setFrontFaceForNative",value:function(e,t){e.frontFace(t)}},{key:"activeTextureForNative",value:function(e,t){e.activeTexture(t)}},{key:"bindTextureForNative",value:function(e,t,i){e.bindTexture(t,i)}},{key:"bindVertexArrayForNative",value:function(e,t){e.bindVertexArray(t)}}]),WebGLContext}();y._activeTextures=new Array(8),y._useProgram=null,y._depthTest=!0,y._depthMask=!0,y._blend=!1,y._cullFace=!1,y.mainContext=null;var m=function(){function Handler(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];_classCallCheck(this,Handler),this.once=!1,this._id=0,this.setTo(e,t,i,n)}return _createClass(Handler,[{key:"setTo",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return this._id=Handler._gid++,this.caller=e,this.method=t,this.args=i,this.once=n,this}},{key:"run",value:function(){if(null==this.method)return null;var e=this._id,t=this.method.apply(this.caller,this.args);return this._id===e&&this.once&&this.recover(),t}},{key:"runWith",value:function(e){if(null==this.method)return null;var t=this._id;if(null==e)var i=this.method.apply(this.caller,this.args);else i=this.args||e.unshift?this.args?this.method.apply(this.caller,this.args.concat(e)):this.method.apply(this.caller,e):this.method.call(this.caller,e);return this._id===t&&this.once&&this.recover(),i}},{key:"clear",value:function(){return this.caller=null,this.method=null,this.args=null,this}},{key:"recover",value:function(){this._id>0&&(this._id=0,Handler._pool.push(this.clear()))}}],[{key:"create",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return Handler._pool.length?Handler._pool.pop().setTo(e,t,i,n):new Handler(e,t,i,n)}}]),Handler}();m._pool=[],m._gid=1;var T=function(){function EventDispatcher(){_classCallCheck(this,EventDispatcher)}return _createClass(EventDispatcher,[{key:"hasListener",value:function(e){return!!(this._events&&this._events[e])}},{key:"event",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!this._events||!this._events[e])return!1;var i=this._events[e];if(i.run)i.once&&delete this._events[e],null!=t?i.runWith(t):i.run();else{for(var n=0,r=i.length;n<r;n++){var a=i[n];a&&(null!=t?a.runWith(t):a.run()),a&&!a.once||(i.splice(n,1),n--,r--)}0===i.length&&this._events&&delete this._events[e]}return!0}},{key:"on",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return this._createListener(e,t,i,n,!1)}},{key:"once",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return this._createListener(e,t,i,n,!0)}},{key:"_createListener",value:function(e,t,i,n,r){var a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5];a&&this.off(e,t,i,r);var s=C.create(t||this,i,n,r);this._events||(this._events={});var o=this._events;return o[e]?o[e].run?o[e]=[o[e],s]:o[e].push(s):o[e]=s,this}},{key:"off",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!this._events||!this._events[e])return this;var r=this._events[e];if(null!=r)if(r.run)t&&r.caller!==t||null!=i&&r.method!==i||n&&!r.once||(delete this._events[e],r.recover());else{for(var a=0,s=0,o=r.length;s<o;s++){var l=r[s];l?!l||t&&l.caller!==t||null!=i&&l.method!==i||n&&!l.once||(a++,r[s]=null,l.recover()):a++}a===o&&delete this._events[e]}return this}},{key:"offAll",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=this._events;if(!t)return this;if(e)this._recoverHandlers(t[e]),delete t[e];else{for(var i in t)this._recoverHandlers(t[i]);this._events=null}return this}},{key:"offAllCaller",value:function(e){if(e&&this._events)for(var t in this._events)this.off(t,e,null);return this}},{key:"_recoverHandlers",value:function(e){if(e)if(e.run)e.recover();else for(var t=e.length-1;t>-1;t--)e[t]&&(e[t].recover(),e[t]=null)}},{key:"isMouseEvent",value:function(e){return EventDispatcher.MOUSE_EVENTS[e]||!1}}]),EventDispatcher}();T.MOUSE_EVENTS={rightmousedown:!0,rightmouseup:!0,rightclick:!0,mousedown:!0,mouseup:!0,mousemove:!0,mouseover:!0,mouseout:!0,click:!0,doubleclick:!0};var C=function(e){function EventHandler(e,t,i,n){return _classCallCheck(this,EventHandler),_possibleConstructorReturn(this,_getPrototypeOf(EventHandler).call(this,e,t,i,n))}return _inherits(EventHandler,e),_createClass(EventHandler,[{key:"recover",value:function(){this._id>0&&(this._id=0,EventHandler._pool.push(this.clear()))}}],[{key:"create",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return EventHandler._pool.length?EventHandler._pool.pop().setTo(e,t,i,n):new EventHandler(e,t,i,n)}}]),EventHandler}(m);C._pool=[];var x=function(){function URL(e){_classCallCheck(this,URL),this._url=URL.formatURL(e),this._path=URL.getPath(e)}return _createClass(URL,[{key:"url",get:function(){return this._url}},{key:"path",get:function(){return this._path}}],[{key:"formatURL",value:function(e){if(!e)return"null path";if(e.indexOf(":")>0)return e;if(null!=URL.customFormat&&(e=URL.customFormat(e)),e.indexOf(":")>0)return e;var t=e.charAt(0);if("."===t)return URL._formatRelativePath(URL._basePath+e);if("~"===t)return URL.rootPath+e.substring(1);if("d"===t){if(0===e.indexOf("data:image"))return e}else if("/"===t)return e;return URL._basePath+e}},{key:"_formatRelativePath",value:function(e){for(var t=e.split("/"),i=0,n=t.length;i<n;i++)".."==t[i]&&(t.splice(i-1,2),i-=2);return t.join("/")}},{key:"getPath",value:function(e){var t=e.lastIndexOf("/");return t>0?e.substr(0,t+1):""}},{key:"getFileName",value:function(e){var t=e.lastIndexOf("/");return t>0?e.substr(t+1):e}},{key:"getAdptedFilePath",value:function(e){if(!URL.exportSceneToJson||!e)return e;var t,i,n;for(i=URL._adpteTypeList.length,t=0;t<i;t++)n=URL._adpteTypeList[t],e=e.replace(n[0],n[1]);return e}},{key:"basePath",set:function(e){URL._basePath=i.Laya._getUrlPath(),URL._basePath=URL.formatURL(e)},get:function(){return URL._basePath}}]),URL}();x.version={},x.exportSceneToJson=!1,x._basePath="",x.rootPath="",x.customFormat=function(e){var t=x.version[e];return!window.conch&&t&&(e+="?v="+t),e},x._adpteTypeList=[[".scene3d",".json"],[".scene",".json"],[".taa",".json"],[".prefab",".json"]];var k=function(e){function Resource(){var e;return _classCallCheck(this,Resource),(e=_possibleConstructorReturn(this,_getPrototypeOf(Resource).call(this)))._id=0,e._url=null,e._cpuMemory=0,e._gpuMemory=0,e._destroyed=!1,e._referenceCount=0,e.lock=!1,e.name=null,e._id=++Resource._uniqueIDCounter,e._destroyed=!1,e._referenceCount=0,Resource._idResourcesMap[e.id]=_assertThisInitialized(e),e.lock=!1,e}return _inherits(Resource,e),_createClass(Resource,[{key:"_setCPUMemory",value:function(e){var t=e-this._cpuMemory;this._cpuMemory=e,Resource._addCPUMemory(t)}},{key:"_setGPUMemory",value:function(e){var t=e-this._gpuMemory;this._gpuMemory=e,Resource._addGPUMemory(t)}},{key:"_setCreateURL",value:function(e){var t;(e=x.formatURL(e),this._url!==e)&&(this._url&&((t=Resource._urlResourcesMap[this._url]).splice(t.indexOf(this),1),0===t.length&&delete Resource._urlResourcesMap[this._url]),e&&((t=Resource._urlResourcesMap[e])||(Resource._urlResourcesMap[e]=t=[]),t.push(this)),this._url=e)}},{key:"_addReference",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._referenceCount+=e}},{key:"_removeReference",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._referenceCount-=e}},{key:"_clearReference",value:function(){this._referenceCount=0}},{key:"_recoverResource",value:function(){}},{key:"_disposeResource",value:function(){}},{key:"_activeResource",value:function(){}},{key:"destroy",value:function(){var e;this._destroyed||(this._destroyed=!0,this.lock=!1,this._disposeResource(),delete Resource._idResourcesMap[this.id],this._url&&((e=Resource._urlResourcesMap[this._url])&&(e.splice(e.indexOf(this),1),0===e.length&&delete Resource._urlResourcesMap[this._url]),i.Loader.loadedMap[this._url]==this&&delete i.Loader.loadedMap[this._url]))}},{key:"id",get:function(){return this._id}},{key:"url",get:function(){return this._url}},{key:"cpuMemory",get:function(){return this._cpuMemory}},{key:"gpuMemory",get:function(){return this._gpuMemory}},{key:"destroyed",get:function(){return this._destroyed}},{key:"referenceCount",get:function(){return this._referenceCount}}],[{key:"_addCPUMemory",value:function(e){Resource._cpuMemory+=e}},{key:"_addGPUMemory",value:function(e){Resource._gpuMemory+=e}},{key:"_addMemory",value:function(e,t){Resource._cpuMemory+=e,Resource._gpuMemory+=t}},{key:"getResourceByID",value:function(e){return Resource._idResourcesMap[e]}},{key:"getResourceByURL",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return Resource._urlResourcesMap[e][t]}},{key:"destroyUnusedResources",value:function(){for(var e in Resource._idResourcesMap){var t=Resource._idResourcesMap[e];t.lock||0!==t._referenceCount||t.destroy()}}},{key:"cpuMemory",get:function(){return Resource._cpuMemory}},{key:"gpuMemory",get:function(){return Resource._gpuMemory}}]),Resource}(T);k._uniqueIDCounter=0,k._idResourcesMap={},k._urlResourcesMap={},k._cpuMemory=0,k._gpuMemory=0;var S,R,b,E=function(e){function Bitmap(){var e;return _classCallCheck(this,Bitmap),(e=_possibleConstructorReturn(this,_getPrototypeOf(Bitmap).call(this)))._width=-1,e._height=-1,e}return _inherits(Bitmap,e),_createClass(Bitmap,[{key:"_getSource",value:function(){throw"Bitmap: must override it."}},{key:"width",get:function(){return this._width},set:function(e){this._width=e}},{key:"height",get:function(){return this._height},set:function(e){this._height=e}}]),Bitmap}(k);(S=e.FilterMode||(e.FilterMode={}))[S.Point=0]="Point",S[S.Bilinear=1]="Bilinear",S[S.Trilinear=2]="Trilinear",(R=e.TextureFormat||(e.TextureFormat={}))[R.R8G8B8=0]="R8G8B8",R[R.R8G8B8A8=1]="R8G8B8A8",R[R.R5G6B5=16]="R5G6B5",R[R.Alpha8=2]="Alpha8",R[R.DXT1=3]="DXT1",R[R.DXT5=4]="DXT5",R[R.ETC1RGB=5]="ETC1RGB",R[R.PVRTCRGB_2BPPV=9]="PVRTCRGB_2BPPV",R[R.PVRTCRGBA_2BPPV=10]="PVRTCRGBA_2BPPV",R[R.PVRTCRGB_4BPPV=11]="PVRTCRGB_4BPPV",R[R.PVRTCRGBA_4BPPV=12]="PVRTCRGBA_4BPPV",R[R.R32G32B32A32=15]="R32G32B32A32",R[R.R16G16B16A16=16]="R16G16B16A16",(b=e.WarpMode||(e.WarpMode={}))[b.Repeat=0]="Repeat",b[b.Clamp=1]="Clamp";var M=function(t){function BaseTexture(t,i){var n;return _classCallCheck(this,BaseTexture),(n=_possibleConstructorReturn(this,_getPrototypeOf(BaseTexture).call(this)))._wrapModeU=e.WarpMode.Repeat,n._wrapModeV=e.WarpMode.Repeat,n._filterMode=e.FilterMode.Bilinear,n._readyed=!1,n._width=-1,n._height=-1,n._format=t,n._mipmap=i,n._anisoLevel=1,n._glTexture=g.instance.createTexture(),n}return _inherits(BaseTexture,t),_createClass(BaseTexture,[{key:"_getFormatByteCount",value:function(){switch(this._format){case e.TextureFormat.R8G8B8:return 3;case e.TextureFormat.R8G8B8A8:return 4;case e.TextureFormat.R5G6B5:case e.TextureFormat.Alpha8:return 1;case e.TextureFormat.R32G32B32A32:return 4;default:throw"Texture2D: unknown format."}}},{key:"_isPot",value:function(e){return 0==(e&e-1)}},{key:"_getGLFormat",value:function(){var t,i=g.instance,n=g.layaGPUInstance;switch(this._format){case e.TextureFormat.R8G8B8:case e.TextureFormat.R5G6B5:t=i.RGB;break;case e.TextureFormat.R8G8B8A8:t=i.RGBA;break;case e.TextureFormat.Alpha8:t=i.ALPHA;break;case e.TextureFormat.R32G32B32A32:case e.TextureFormat.R16G16B16A16:t=i.RGBA;break;case e.TextureFormat.DXT1:if(!n._compressedTextureS3tc)throw"BaseTexture: not support DXT1 format.";t=n._compressedTextureS3tc.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case e.TextureFormat.DXT5:if(!n._compressedTextureS3tc)throw"BaseTexture: not support DXT5 format.";t=n._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case e.TextureFormat.ETC1RGB:if(!n._compressedTextureEtc1)throw"BaseTexture: not support ETC1RGB format.";t=n._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL;break;case e.TextureFormat.PVRTCRGB_2BPPV:if(!n._compressedTexturePvrtc)throw"BaseTexture: not support PVRTCRGB_2BPPV format.";t=n._compressedTexturePvrtc.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case e.TextureFormat.PVRTCRGBA_2BPPV:if(!n._compressedTexturePvrtc)throw"BaseTexture: not support PVRTCRGBA_2BPPV format.";t=n._compressedTexturePvrtc.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case e.TextureFormat.PVRTCRGB_4BPPV:if(!n._compressedTexturePvrtc)throw"BaseTexture: not support PVRTCRGB_4BPPV format.";t=n._compressedTexturePvrtc.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case e.TextureFormat.PVRTCRGBA_4BPPV:if(!n._compressedTexturePvrtc)throw"BaseTexture: not support PVRTCRGBA_4BPPV format.";t=n._compressedTexturePvrtc.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;default:throw"BaseTexture: unknown texture format."}return t}},{key:"_setFilterMode",value:function(t){var i=g.instance;switch(y.bindTexture(i,this._glTextureType,this._glTexture),t){case e.FilterMode.Point:this._mipmap?i.texParameteri(this._glTextureType,i.TEXTURE_MIN_FILTER,i.NEAREST_MIPMAP_NEAREST):i.texParameteri(this._glTextureType,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(this._glTextureType,i.TEXTURE_MAG_FILTER,i.NEAREST);break;case e.FilterMode.Bilinear:this._mipmap?i.texParameteri(this._glTextureType,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_NEAREST):i.texParameteri(this._glTextureType,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(this._glTextureType,i.TEXTURE_MAG_FILTER,i.LINEAR);break;case e.FilterMode.Trilinear:this._mipmap?i.texParameteri(this._glTextureType,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_LINEAR):i.texParameteri(this._glTextureType,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(this._glTextureType,i.TEXTURE_MAG_FILTER,i.LINEAR);break;default:throw new Error("BaseTexture:unknown filterMode value.")}}},{key:"_setWarpMode",value:function(t,i){var n=g.instance;if(y.bindTexture(n,this._glTextureType,this._glTexture),this._isPot(this._width)&&this._isPot(this._height))switch(i){case e.WarpMode.Repeat:n.texParameteri(this._glTextureType,t,n.REPEAT);break;case e.WarpMode.Clamp:n.texParameteri(this._glTextureType,t,n.CLAMP_TO_EDGE)}else n.texParameteri(this._glTextureType,t,n.CLAMP_TO_EDGE)}},{key:"_setAnisotropy",value:function(e){var t=g.layaGPUInstance._extTextureFilterAnisotropic;if(t){e=Math.max(e,1);var i=g.instance;y.bindTexture(i,this._glTextureType,this._glTexture),e=Math.min(i.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT),e),i.texParameterf(this._glTextureType,t.TEXTURE_MAX_ANISOTROPY_EXT,e)}}},{key:"_disposeResource",value:function(){this._glTexture&&(g.instance.deleteTexture(this._glTexture),this._glTexture=null,this._setGPUMemory(0))}},{key:"_getSource",value:function(){return this._readyed?this._glTexture:null}},{key:"generateMipmap",value:function(){this._isPot(this.width)&&this._isPot(this.height)&&g.instance.generateMipmap(this._glTextureType)}},{key:"mipmap",get:function(){return this._mipmap}},{key:"format",get:function(){return this._format}},{key:"wrapModeU",get:function(){return this._wrapModeU},set:function(e){this._wrapModeU!==e&&(this._wrapModeU=e,-1!==this._width&&this._setWarpMode(g.instance.TEXTURE_WRAP_S,e))}},{key:"wrapModeV",get:function(){return this._wrapModeV},set:function(e){this._wrapModeV!==e&&(this._wrapModeV=e,-1!==this._height&&this._setWarpMode(g.instance.TEXTURE_WRAP_T,e))}},{key:"filterMode",get:function(){return this._filterMode},set:function(e){e!==this._filterMode&&(this._filterMode=e,-1!==this._width&&-1!==this._height&&this._setFilterMode(e))}},{key:"anisoLevel",get:function(){return this._anisoLevel},set:function(e){e!==this._anisoLevel&&(this._anisoLevel=Math.max(1,Math.min(16,e)),-1!==this._width&&-1!==this._height&&this._setAnisotropy(e))}},{key:"mipmapCount",get:function(){return this._mipmapCount}},{key:"defaulteTexture",get:function(){throw"BaseTexture:must override it."}}]),BaseTexture}(E);M._rgbmRange=5,M.FORMAT_R8G8B8=0,M.FORMAT_R8G8B8A8=1,M.FORMAT_ALPHA8=2,M.FORMAT_DXT1=3,M.FORMAT_DXT5=4,M.FORMAT_ETC1RGB=5,M.FORMAT_PVRTCRGB_2BPPV=9,M.FORMAT_PVRTCRGBA_2BPPV=10,M.FORMAT_PVRTCRGB_4BPPV=11,M.FORMAT_PVRTCRGBA_4BPPV=12,M.RENDERTEXTURE_FORMAT_RGBA_HALF_FLOAT=14,M.FORMAT_R32G32B32A32=15,M.FORMAT_DEPTH_16=0,M.FORMAT_STENCIL_8=1,M.FORMAT_DEPTHSTENCIL_16_8=2,M.FORMAT_DEPTHSTENCIL_NONE=3,M.FILTERMODE_POINT=0,M.FILTERMODE_BILINEAR=1,M.FILTERMODE_TRILINEAR=2,M.WARPMODE_REPEAT=0,M.WARPMODE_CLAMP=1;var A=function(){function Byte(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;_classCallCheck(this,Byte),this._xd_=!0,this._allocated_=8,this._pos_=0,this._length=0,e?(this._u8d_=new Uint8Array(e),this._d_=new DataView(this._u8d_.buffer),this._length=this._d_.byteLength):this._resizeBuffer(this._allocated_)}return _createClass(Byte,[{key:"_resizeBuffer",value:function(e){try{var t=new Uint8Array(e);null!=this._u8d_&&(this._u8d_.length<=e?t.set(this._u8d_):t.set(this._u8d_.subarray(0,e))),this._u8d_=t,this._d_=new DataView(t.buffer)}catch(t){throw"Invalid typed array length:"+e}}},{key:"getString",value:function(){return this.readString()}},{key:"readString",value:function(){return this._rUTF(this.getUint16())}},{key:"getFloat32Array",value:function(e,t){return this.readFloat32Array(e,t)}},{key:"readFloat32Array",value:function(e,t){var i=e+t;i=i>this._length?this._length:i;var n=new Float32Array(this._d_.buffer.slice(e,i));return this._pos_=i,n}},{key:"getUint8Array",value:function(e,t){return this.readUint8Array(e,t)}},{key:"readUint8Array",value:function(e,t){var i=e+t;i=i>this._length?this._length:i;var n=new Uint8Array(this._d_.buffer.slice(e,i));return this._pos_=i,n}},{key:"getInt16Array",value:function(e,t){return this.readInt16Array(e,t)}},{key:"readInt16Array",value:function(e,t){var i=e+t;i=i>this._length?this._length:i;var n=new Int16Array(this._d_.buffer.slice(e,i));return this._pos_=i,n}},{key:"getFloat32",value:function(){return this.readFloat32()}},{key:"readFloat32",value:function(){if(this._pos_+4>this._length)throw"getFloat32 error - Out of bounds";var e=this._d_.getFloat32(this._pos_,this._xd_);return this._pos_+=4,e}},{key:"getFloat64",value:function(){return this.readFloat64()}},{key:"readFloat64",value:function(){if(this._pos_+8>this._length)throw"getFloat64 error - Out of bounds";var e=this._d_.getFloat64(this._pos_,this._xd_);return this._pos_+=8,e}},{key:"writeFloat32",value:function(e){this._ensureWrite(this._pos_+4),this._d_.setFloat32(this._pos_,e,this._xd_),this._pos_+=4}},{key:"writeFloat64",value:function(e){this._ensureWrite(this._pos_+8),this._d_.setFloat64(this._pos_,e,this._xd_),this._pos_+=8}},{key:"getInt32",value:function(){return this.readInt32()}},{key:"readInt32",value:function(){if(this._pos_+4>this._length)throw"getInt32 error - Out of bounds";var e=this._d_.getInt32(this._pos_,this._xd_);return this._pos_+=4,e}},{key:"getUint32",value:function(){return this.readUint32()}},{key:"readUint32",value:function(){if(this._pos_+4>this._length)throw"getUint32 error - Out of bounds";var e=this._d_.getUint32(this._pos_,this._xd_);return this._pos_+=4,e}},{key:"writeInt32",value:function(e){this._ensureWrite(this._pos_+4),this._d_.setInt32(this._pos_,e,this._xd_),this._pos_+=4}},{key:"writeUint32",value:function(e){this._ensureWrite(this._pos_+4),this._d_.setUint32(this._pos_,e,this._xd_),this._pos_+=4}},{key:"getInt16",value:function(){return this.readInt16()}},{key:"readInt16",value:function(){if(this._pos_+2>this._length)throw"getInt16 error - Out of bounds";var e=this._d_.getInt16(this._pos_,this._xd_);return this._pos_+=2,e}},{key:"getUint16",value:function(){return this.readUint16()}},{key:"readUint16",value:function(){if(this._pos_+2>this._length)throw"getUint16 error - Out of bounds";var e=this._d_.getUint16(this._pos_,this._xd_);return this._pos_+=2,e}},{key:"writeUint16",value:function(e){this._ensureWrite(this._pos_+2),this._d_.setUint16(this._pos_,e,this._xd_),this._pos_+=2}},{key:"writeInt16",value:function(e){this._ensureWrite(this._pos_+2),this._d_.setInt16(this._pos_,e,this._xd_),this._pos_+=2}},{key:"getUint8",value:function(){return this.readUint8()}},{key:"readUint8",value:function(){if(this._pos_+1>this._length)throw"getUint8 error - Out of bounds";return this._u8d_[this._pos_++]}},{key:"writeUint8",value:function(e){this._ensureWrite(this._pos_+1),this._d_.setUint8(this._pos_,e),this._pos_++}},{key:"_getUInt8",value:function(e){return this._readUInt8(e)}},{key:"_readUInt8",value:function(e){return this._d_.getUint8(e)}},{key:"_getUint16",value:function(e){return this._readUint16(e)}},{key:"_readUint16",value:function(e){return this._d_.getUint16(e,this._xd_)}},{key:"_getMatrix",value:function(){return this._readMatrix()}},{key:"_readMatrix",value:function(){return new f(this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32())}},{key:"_rUTF",value:function(e){var t,i,n=this._pos_+e,r=String.fromCharCode,a=this._u8d_,s=[],o=0;for(s.length=1e3;this._pos_<n;)if((t=a[this._pos_++])<128)0!=t&&(s[o++]=r(t));else if(t<224)s[o++]=r((63&t)<<6|127&a[this._pos_++]);else if(t<240)i=a[this._pos_++],s[o++]=r((31&t)<<12|(127&i)<<6|127&a[this._pos_++]);else{var l=(15&t)<<18|(127&(i=a[this._pos_++]))<<12|(127&a[this._pos_++])<<6|127&a[this._pos_++];if(l>=65536){var h=l-65536,u=55296|h>>10,c=56320|1023&h;s[o++]=r(u),s[o++]=r(c)}else s[o++]=r(l)}return s.length=o,s.join("")}},{key:"getCustomString",value:function(e){return this.readCustomString(e)}},{key:"readCustomString",value:function(e){for(var t,i="",n=0,r=String.fromCharCode,a=this._u8d_;e>0;)if((t=a[this._pos_])<128)i+=r(t),this._pos_++,e--;else for(n=t-128,this._pos_++,e-=n;n>0;)t=a[this._pos_++],i+=r(a[this._pos_++]<<8|t),n--;return i}},{key:"clear",value:function(){this._pos_=0,this.length=0}},{key:"__getBuffer",value:function(){return this._d_.buffer}},{key:"writeUTFBytes",value:function(e){for(var t=0,i=(e+="").length;t<i;t++){var n=e.charCodeAt(t);if(n<=127)this.writeByte(n);else if(n<=2047)this._ensureWrite(this._pos_+2),this._u8d_.set([192|n>>6,128|63&n],this._pos_),this._pos_+=2;else if(n>=55296&&n<=56319){t++;var r=e.charCodeAt(t);if(!Number.isNaN(r)&&r>=56320&&r<=57343){var a=64+(1023&n),s=1023&r,o=240|a>>8&63,l=128|a>>2&63,h=128|(3&a)<<4|s>>6&15,u=128|63&s;this._ensureWrite(this._pos_+4),this._u8d_.set([o,l,h,u],this._pos_),this._pos_+=4}}else n<=65535?(this._ensureWrite(this._pos_+3),this._u8d_.set([224|n>>12,128|n>>6&63,128|63&n],this._pos_),this._pos_+=3):(this._ensureWrite(this._pos_+4),this._u8d_.set([240|n>>18,128|n>>12&63,128|n>>6&63,128|63&n],this._pos_),this._pos_+=4)}}},{key:"writeUTFString",value:function(e){var t=this.pos;this.writeUint16(1),this.writeUTFBytes(e);var i=this.pos-t-2;this._d_.setUint16(t,i,this._xd_)}},{key:"readUTFString",value:function(){return this.readUTFBytes(this.getUint16())}},{key:"getUTFString",value:function(){return this.readUTFString()}},{key:"readUTFBytes",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1;if(0===e)return"";var t=this.bytesAvailable;if(e>t)throw"readUTFBytes error - Out of bounds";return e=e>0?e:t,this._rUTF(e)}},{key:"getUTFBytes",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1;return this.readUTFBytes(e)}},{key:"writeByte",value:function(e){this._ensureWrite(this._pos_+1),this._d_.setInt8(this._pos_,e),this._pos_+=1}},{key:"readByte",value:function(){if(this._pos_+1>this._length)throw"readByte error - Out of bounds";return this._d_.getInt8(this._pos_++)}},{key:"getByte",value:function(){return this.readByte()}},{key:"_ensureWrite",value:function(e){this._length<e&&(this._length=e),this._allocated_<e&&(this.length=e)}},{key:"writeArrayBuffer",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(t<0||i<0)throw"writeArrayBuffer error - Out of bounds";0==i&&(i=e.byteLength-t),this._ensureWrite(this._pos_+i);var n=new Uint8Array(e);this._u8d_.set(n.subarray(t,t+i),this._pos_),this._pos_+=i}},{key:"readArrayBuffer",value:function(e){var t;return t=this._u8d_.buffer.slice(this._pos_,this._pos_+e),this._pos_=this._pos_+e,t}},{key:"buffer",get:function(){var e=this._d_.buffer;return e.byteLength===this._length?e:e.slice(0,this._length)}},{key:"endian",get:function(){return this._xd_?Byte.LITTLE_ENDIAN:Byte.BIG_ENDIAN},set:function(e){this._xd_=e===Byte.LITTLE_ENDIAN}},{key:"length",set:function(e){this._allocated_<e?this._resizeBuffer(this._allocated_=Math.floor(Math.max(e,2*this._allocated_))):this._allocated_>e&&this._resizeBuffer(this._allocated_=e),this._length=e},get:function(){return this._length}},{key:"pos",get:function(){return this._pos_},set:function(e){this._pos_=e}},{key:"bytesAvailable",get:function(){return this._length-this._pos_}}],[{key:"getSystemEndian",value:function(){if(!Byte._sysEndian){var e=new ArrayBuffer(2);new DataView(e).setInt16(0,256,!0),Byte._sysEndian=256===new Int16Array(e)[0]?Byte.LITTLE_ENDIAN:Byte.BIG_ENDIAN}return Byte._sysEndian}}]),Byte}();A.BIG_ENDIAN="bigEndian",A.LITTLE_ENDIAN="littleEndian",A._sysEndian=null;var w=function(t){function Texture2D(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.TextureFormat.R8G8B8A8,a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];_classCallCheck(this,Texture2D),t=_possibleConstructorReturn(this,_getPrototypeOf(Texture2D).call(this,r,a));var o=g.instance;t._glTextureType=o.TEXTURE_2D,t._width=i,t._height=n,t._canRead=s,t._setWarpMode(o.TEXTURE_WRAP_S,t._wrapModeU),t._setWarpMode(o.TEXTURE_WRAP_T,t._wrapModeV),t._setFilterMode(t._filterMode),t._setAnisotropy(t._anisoLevel);var l=t._gpuCompressFormat();if(a){var h=Math.max(Math.ceil(Math.log2(i))+1,Math.ceil(Math.log2(n))+1);if(!l)for(var u=0;u<h;u++)t._setPixels(null,u,Math.max(i>>u,1),Math.max(n>>u,1));t._mipmapCount=h,t._setGPUMemory(i*n*4*(1+1/3))}else l||t._setPixels(null,0,i,n),t._mipmapCount=1,t._setGPUMemory(i*n*4);return t}return _inherits(Texture2D,t),_createClass(Texture2D,[{key:"_gpuCompressFormat",value:function(){return this._format==e.TextureFormat.DXT1||this._format==e.TextureFormat.DXT5||this._format==e.TextureFormat.ETC1RGB||this._format==e.TextureFormat.PVRTCRGB_2BPPV||this._format==e.TextureFormat.PVRTCRGBA_2BPPV||this._format==e.TextureFormat.PVRTCRGB_4BPPV||this._format==e.TextureFormat.PVRTCRGBA_4BPPV}},{key:"_setPixels",value:function(t,i,n,r){var a=g.instance,s=this._glTextureType,o=this._getGLFormat();switch(y.bindTexture(a,s,this._glTexture),this.format){case e.TextureFormat.R8G8B8:a.pixelStorei(a.UNPACK_ALIGNMENT,1),a.texImage2D(s,i,o,n,r,0,o,a.UNSIGNED_BYTE,t),a.pixelStorei(a.UNPACK_ALIGNMENT,4);break;case e.TextureFormat.R5G6B5:a.pixelStorei(a.UNPACK_ALIGNMENT,2),a.texImage2D(s,i,o,n,r,0,o,a.UNSIGNED_SHORT_5_6_5,t),a.pixelStorei(a.UNPACK_ALIGNMENT,4);break;case e.TextureFormat.R32G32B32A32:g.layaGPUInstance._isWebGL2?a.texImage2D(s,i,a.RGBA32F,n,r,0,o,a.FLOAT,t):a.texImage2D(s,i,a.RGBA,n,r,0,o,a.FLOAT,t);break;case e.TextureFormat.R16G16B16A16:g.layaGPUInstance._isWebGL2?a.texImage2D(s,i,a.RGBA16F,n,r,0,o,a.HALF_FLOAT,t):a.texImage2D(s,i,a.RGBA16F,n,r,0,o,g.layaGPUInstance._oesTextureHalfFloat.HALF_FLOAT_OES,t);default:a.texImage2D(s,i,o,n,r,0,o,a.UNSIGNED_BYTE,t)}}},{key:"_calcualatesCompressedDataSize",value:function(t,i,n){switch(t){case e.TextureFormat.DXT1:case e.TextureFormat.ETC1RGB:return(i+3>>2)*(n+3>>2)*8;case e.TextureFormat.DXT5:return(i+3>>2)*(n+3>>2)*16;case e.TextureFormat.PVRTCRGB_4BPPV:case e.TextureFormat.PVRTCRGBA_4BPPV:return Math.floor((Math.max(i,8)*Math.max(n,8)*4+7)/8);case e.TextureFormat.PVRTCRGB_2BPPV:case e.TextureFormat.PVRTCRGBA_2BPPV:return Math.floor((Math.max(i,16)*Math.max(n,8)*2+7)/8);default:return 0}}},{key:"_pharseDDS",value:function(t){var i=new Int32Array(t,0,31);if(542327876!=i[0])throw"Invalid magic number in DDS header";if(!(4&i[20]))throw"Unsupported format, must contain a FourCC code";var n=i[21];switch(this._format){case e.TextureFormat.DXT1:if(827611204!==n)throw"the FourCC code is not same with texture format.";break;case e.TextureFormat.DXT5:if(894720068!==n)throw"the FourCC code is not same with texture format.";break;default:throw"unknown texture format."}var r=1;if(131072&i[2]){if(r=Math.max(1,i[7]),!this._mipmap)throw"the mipmap is not same with Texture2D."}else if(this._mipmap)throw"the mipmap is not same with Texture2D.";var a=i[4],s=i[3];this._width=a,this._height=s;var o=i[1]+4;this._upLoadCompressedTexImage2D(t,a,s,r,o,0)}},{key:"_pharseKTX",value:function(t){var i=new Uint8Array(t,0,12);if(171!=i[0]||75!=i[1]||84!=i[2]||88!=i[3]||32!=i[4]||49!=i[5]||49!=i[6]||187!=i[7]||13!=i[8]||10!=i[9]||26!=i[10]||10!=i[11])throw"Invalid fileIdentifier in KTX header";var n=new Int32Array(i.buffer,i.length,13);switch(n[4]){case g.layaGPUInstance._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL:this._format=e.TextureFormat.ETC1RGB;break;default:throw"unknown texture format."}var r=n[11],a=n[6],s=n[7];this._width=a,this._height=s;var o=64+n[12];this._upLoadCompressedTexImage2D(t,a,s,r,o,4)}},{key:"_pharsePVR",value:function(t){var i=new Int32Array(t,0,13);if(55727696!=i[0])throw"Invalid magic number in PVR header";switch(i[2]){case 0:this._format=e.TextureFormat.PVRTCRGB_2BPPV;break;case 2:this._format=e.TextureFormat.PVRTCRGB_4BPPV;break;case 1:this._format=e.TextureFormat.PVRTCRGBA_2BPPV;break;case 3:this._format=e.TextureFormat.PVRTCRGBA_4BPPV;break;default:throw"Texture2D:unknown PVR format."}var n=i[11],r=i[7],a=i[6];this._width=r,this._height=a;var s=i[12]+52;this._upLoadCompressedTexImage2D(t,r,a,n,s,0)}},{key:"_upLoadCompressedTexImage2D",value:function(e,t,i,n,r,a){var s=g.instance,o=this._glTextureType;y.bindTexture(s,o,this._glTexture);for(var l=this._getGLFormat(),h=r,u=0;u<n;u++){h+=a;var c=this._calcualatesCompressedDataSize(this._format,t,i),_=new Uint8Array(e,h,c);s.compressedTexImage2D(o,u,l,t,i,0,_),t=Math.max(t>>1,1),i=Math.max(i>>1,1),h+=c}var d=h;this._setGPUMemory(d),this._readyed=!0,this._activeResource()}},{key:"loadImageSource",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=g.instance,a=t.width,s=t.height;this._width=a,this._height=s,this._isPot(a)&&this._isPot(s)||(this._mipmap=!1),this._setWarpMode(r.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(r.TEXTURE_WRAP_T,this._wrapModeV),this._setFilterMode(this._filterMode),y.bindTexture(r,this._glTextureType,this._glTexture);var o=this._getGLFormat();i.Render.isConchApp?(t.setPremultiplyAlpha&&t.setPremultiplyAlpha(n),r.texImage2D(this._glTextureType,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,t)):(n&&r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.format==e.TextureFormat.R5G6B5?r.texImage2D(this._glTextureType,0,r.RGB,r.RGB,r.UNSIGNED_SHORT_5_6_5,t):r.texImage2D(this._glTextureType,0,o,o,r.UNSIGNED_BYTE,t),n&&r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1)),this._mipmap?(r.generateMipmap(this._glTextureType),this._setGPUMemory(a*s*4*(1+1/3))):this._setGPUMemory(a*s*4),this._canRead&&(i.Render.isConchApp?this._pixels=new Uint8Array(t._nativeObj.getImageData(0,0,a,s)):(i.Browser.canvas.size(a,s),i.Browser.canvas.clear(),i.Browser.context.drawImage(t,0,0,a,s),this._pixels=new Uint8Array(i.Browser.context.getImageData(0,0,a,s).data.buffer))),this._readyed=!0,this._activeResource()}},{key:"setPixels",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(this._gpuCompressFormat())throw"Texture2D:the format is GPU compression format.";if(!e)throw"Texture2D:pixels can't be null.";var i=Math.max(this._width>>t,1),n=Math.max(this._height>>t,1),r=i*n*this._getFormatByteCount();if(e.length<r)throw"Texture2D:pixels length should at least "+r+".";this._setPixels(e,t,i,n),this._canRead&&(this._pixels=e),this._readyed=!0,this._activeResource()}},{key:"setSubPixels",value:function(t,i,n,r,a){var s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;if(this._gpuCompressFormat())throw"Texture2D:the format is GPU compression format.";if(!a)throw"Texture2D:pixels can't be null.";var o=g.instance,l=this._glTextureType;y.bindTexture(o,l,this._glTexture);var h=this._getGLFormat();switch(this.format){case e.TextureFormat.R8G8B8:o.pixelStorei(o.UNPACK_ALIGNMENT,1),o.texSubImage2D(l,s,t,i,n,r,h,o.UNSIGNED_BYTE,a),o.pixelStorei(o.UNPACK_ALIGNMENT,4);break;case e.TextureFormat.R5G6B5:o.pixelStorei(o.UNPACK_ALIGNMENT,2),o.texSubImage2D(l,s,t,i,n,r,h,o.UNSIGNED_SHORT_5_6_5,a),o.pixelStorei(o.UNPACK_ALIGNMENT,4);break;case e.TextureFormat.R32G32B32A32:o.texSubImage2D(l,s,t,i,n,r,h,o.FLOAT,a);break;default:o.texSubImage2D(l,s,t,i,n,r,h,o.UNSIGNED_BYTE,a)}this._readyed=!0,this._activeResource()}},{key:"setCompressData",value:function(t){switch(this._format){case e.TextureFormat.DXT1:case e.TextureFormat.DXT5:this._pharseDDS(t);break;case e.TextureFormat.ETC1RGB:this._pharseKTX(t);break;case e.TextureFormat.PVRTCRGB_2BPPV:case e.TextureFormat.PVRTCRGBA_2BPPV:case e.TextureFormat.PVRTCRGB_4BPPV:case e.TextureFormat.PVRTCRGBA_4BPPV:this._pharsePVR(t);break;default:throw"Texture2D:unkonwn format."}}},{key:"getPixels",value:function(){if(this._canRead)return this._pixels;throw new Error("Texture2D: must set texture canRead is true.")}},{key:"defaulteTexture",get:function(){return Texture2D.grayTexture}}],[{key:"__init__",value:function(){var t=new Uint8Array(3);t[0]=128,t[1]=128,t[2]=128,Texture2D.grayTexture=new Texture2D(1,1,e.TextureFormat.R8G8B8,!1,!1),Texture2D.grayTexture.setPixels(t),Texture2D.grayTexture.lock=!0,t[0]=255,t[1]=255,t[2]=255,Texture2D.whiteTexture=new Texture2D(1,1,e.TextureFormat.R8G8B8,!1,!1),Texture2D.whiteTexture.setPixels(t),Texture2D.whiteTexture.lock=!0,t[0]=0,t[1]=0,t[2]=0,Texture2D.blackTexture=new Texture2D(1,1,e.TextureFormat.R8G8B8,!1,!1),Texture2D.blackTexture.setPixels(t),Texture2D.blackTexture.lock=!0}},{key:"_parse",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=n?new Texture2D(n[0],n[1],n[2],n[3],n[4]):new Texture2D(0,0);switch(i&&(r.wrapModeU=i.wrapModeU,r.wrapModeV=i.wrapModeV,r.filterMode=i.filterMode,r.anisoLevel=i.anisoLevel),r._format){case e.TextureFormat.R8G8B8:case e.TextureFormat.R8G8B8A8:r.loadImageSource(t);break;case e.TextureFormat.DXT1:case e.TextureFormat.DXT5:case e.TextureFormat.ETC1RGB:case e.TextureFormat.PVRTCRGB_2BPPV:case e.TextureFormat.PVRTCRGBA_2BPPV:case e.TextureFormat.PVRTCRGB_4BPPV:case e.TextureFormat.PVRTCRGBA_4BPPV:r.setCompressData(t);break;default:throw"Texture2D:unkonwn format."}return r}},{key:"_SimpleAnimatorTextureParse",value:function(t){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var i=new A(t),n=i.readUTFString();if("LAYAANIMATORTEXTURE:0000"!=n)throw"Laya3D:unknow version.";var r=i.readInt32(),a=i.readInt32(),s=new Float32Array(r*r*4),o=new Float32Array(i.readArrayBuffer(4*a));s.set(o,0);var l=new Texture2D(r,r,e.TextureFormat.R32G32B32A32,!1,!1);return l.setPixels(s,0),l.filterMode=e.FilterMode.Point,l}},{key:"load",value:function(e,t){i.loader.create(e,t,null,i.Loader.TEXTURE2D)}}]),Texture2D}(M);w.TEXTURE2D="TEXTURE2D",w.grayTexture=null,w.whiteTexture=null,w.blackTexture=null;var L,I,P=function(e){function BaseShader(){return _classCallCheck(this,BaseShader),_possibleConstructorReturn(this,_getPrototypeOf(BaseShader).call(this))}return _inherits(BaseShader,e),BaseShader}(k),D=function(){function RenderState2D(){_classCallCheck(this,RenderState2D)}return _createClass(RenderState2D,null,[{key:"mat2MatArray",value:function(e,t){var i=e,n=t;return n[0]=i.a,n[1]=i.b,n[2]=RenderState2D.EMPTYMAT4_ARRAY[2],n[3]=RenderState2D.EMPTYMAT4_ARRAY[3],n[4]=i.c,n[5]=i.d,n[6]=RenderState2D.EMPTYMAT4_ARRAY[6],n[7]=RenderState2D.EMPTYMAT4_ARRAY[7],n[8]=RenderState2D.EMPTYMAT4_ARRAY[8],n[9]=RenderState2D.EMPTYMAT4_ARRAY[9],n[10]=RenderState2D.EMPTYMAT4_ARRAY[10],n[11]=RenderState2D.EMPTYMAT4_ARRAY[11],n[12]=i.tx,n[13]=i.ty,n[14]=RenderState2D.EMPTYMAT4_ARRAY[14],n[15]=RenderState2D.EMPTYMAT4_ARRAY[15],t}},{key:"restoreTempArray",value:function(){RenderState2D.TEMPMAT4_ARRAY[0]=1,RenderState2D.TEMPMAT4_ARRAY[1]=0,RenderState2D.TEMPMAT4_ARRAY[4]=0,RenderState2D.TEMPMAT4_ARRAY[5]=1,RenderState2D.TEMPMAT4_ARRAY[12]=0,RenderState2D.TEMPMAT4_ARRAY[13]=0}},{key:"clear",value:function(){RenderState2D.worldScissorTest=!1,RenderState2D.worldAlpha=1}}]),RenderState2D}();D._MAXSIZE=99999999,D.EMPTYMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],D.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],D.worldMatrix4=D.TEMPMAT4_ARRAY,D.worldMatrix=new f,D.matWVP=null,D.worldAlpha=1,D.worldScissorTest=!1,D.width=0,D.height=0,(L=e.RenderTextureFormat||(e.RenderTextureFormat={}))[L.R8G8B8=0]="R8G8B8",L[L.R8G8B8A8=1]="R8G8B8A8",L[L.Alpha8=2]="Alpha8",L[L.R16G16B16A16=14]="R16G16B16A16",L[L.Depth=15]="Depth",L[L.ShadowMap=16]="ShadowMap",(I=e.RenderTextureDepthFormat||(e.RenderTextureDepthFormat={}))[I.DEPTH_16=0]="DEPTH_16",I[I.STENCIL_8=1]="STENCIL_8",I[I.DEPTHSTENCIL_24_8=2]="DEPTHSTENCIL_24_8",I[I.DEPTHSTENCIL_NONE=3]="DEPTHSTENCIL_NONE",I[I.DEPTHSTENCIL_16_8=2]="DEPTHSTENCIL_16_8";var B=function(t){function RenderTexture2D(t,i){var n,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.RenderTextureFormat.R8G8B8,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.RenderTextureDepthFormat.DEPTH_16;return _classCallCheck(this,RenderTexture2D),(n=_possibleConstructorReturn(this,_getPrototypeOf(RenderTexture2D).call(this,r,!1)))._mgrKey=0,n._glTextureType=g.instance.TEXTURE_2D,n._width=t,n._height=i,n._depthStencilFormat=a,n._create(t,i),n.lock=!0,n}return _inherits(RenderTexture2D,t),_createClass(RenderTexture2D,[{key:"getIsReady",value:function(){return!0}},{key:"_create",value:function(t,i){var n=g.instance;this._frameBuffer=n.createFramebuffer(),y.bindTexture(n,this._glTextureType,this._glTexture);var r=this._getGLFormat();if(n.texImage2D(this._glTextureType,0,r,t,i,0,r,n.UNSIGNED_BYTE,null),this._setGPUMemory(t*i*4),n.bindFramebuffer(n.FRAMEBUFFER,this._frameBuffer),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,this._glTexture,0),this._depthStencilFormat!==e.RenderTextureDepthFormat.DEPTHSTENCIL_NONE)switch(this._depthStencilBuffer=n.createRenderbuffer(),n.bindRenderbuffer(n.RENDERBUFFER,this._depthStencilBuffer),this._depthStencilFormat){case e.RenderTextureDepthFormat.DEPTH_16:n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_COMPONENT16,t,i),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,this._depthStencilBuffer);break;case e.RenderTextureDepthFormat.STENCIL_8:n.renderbufferStorage(n.RENDERBUFFER,n.STENCIL_INDEX8,t,i),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.STENCIL_ATTACHMENT,n.RENDERBUFFER,this._depthStencilBuffer);break;case e.RenderTextureDepthFormat.DEPTHSTENCIL_24_8:n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_STENCIL,t,i),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_STENCIL_ATTACHMENT,n.RENDERBUFFER,this._depthStencilBuffer)}n.bindFramebuffer(n.FRAMEBUFFER,null),n.bindRenderbuffer(n.RENDERBUFFER,null),this._setWarpMode(n.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(n.TEXTURE_WRAP_T,this._wrapModeV),this._setFilterMode(this._filterMode),this._setAnisotropy(this._anisoLevel),this._readyed=!0,this._activeResource()}},{key:"generateMipmap",value:function(){this._isPot(this.width)&&this._isPot(this.height)?(this._mipmap=!0,g.instance.generateMipmap(this._glTextureType),this._setFilterMode(this._filterMode),this._setGPUMemory(this.width*this.height*4*(1+1/3))):(this._mipmap=!1,this._setGPUMemory(this.width*this.height*4))}},{key:"start",value:function(){var e=g.instance;g.instance.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),this._lastRT=RenderTexture2D._currentActive,RenderTexture2D._currentActive=this,this._readyed=!0,e.viewport(0,0,this._width,this._height),this._lastWidth=D.width,this._lastHeight=D.height,D.width=this._width,D.height=this._height,P.activeShader=null}},{key:"end",value:function(){var e=g.instance;e.bindFramebuffer(e.FRAMEBUFFER,null),RenderTexture2D._currentActive=null,this._readyed=!0}},{key:"restore",value:function(){var e=g.instance;this._lastRT!=RenderTexture2D._currentActive&&(g.instance.bindFramebuffer(e.FRAMEBUFFER,this._lastRT?this._lastRT._frameBuffer:null),RenderTexture2D._currentActive=this._lastRT),this._readyed=!0,e.viewport(0,0,this._lastWidth,this._lastHeight),D.width=this._lastWidth,D.height=this._lastHeight,P.activeShader=null}},{key:"clear",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,r=g.instance;r.clearColor(e,t,i,n);var a=r.COLOR_BUFFER_BIT;switch(this._depthStencilFormat){case r.DEPTH_COMPONENT16:a|=r.DEPTH_BUFFER_BIT;break;case r.STENCIL_INDEX8:a|=r.STENCIL_BUFFER_BIT;break;case r.DEPTH_STENCIL:a|=r.DEPTH_BUFFER_BIT,a|=r.STENCIL_BUFFER_BIT}r.clear(a)}},{key:"getData",value:function(e,t,n,r){if(i.Render.isConchApp&&2==window.conchConfig.threadMode)throw"native 2 thread mode use getDataAsync";var a=g.instance;if(a.bindFramebuffer(a.FRAMEBUFFER,this._frameBuffer),!(a.checkFramebufferStatus(a.FRAMEBUFFER)===a.FRAMEBUFFER_COMPLETE))return a.bindFramebuffer(a.FRAMEBUFFER,null),null;var s=new Uint8Array(this._width*this._height*4),o=this._getGLFormat();return a.readPixels(e,t,n,r,o,a.UNSIGNED_BYTE,s),a.bindFramebuffer(a.FRAMEBUFFER,null),s}},{key:"getDataAsync",value:function(e,t,i,n,r){var a=g.instance;a.bindFramebuffer(a.FRAMEBUFFER,this._frameBuffer),a.readPixelsAsync(e,t,i,n,a.RGBA,a.UNSIGNED_BYTE,(function(e){r(new Uint8Array(e))})),a.bindFramebuffer(a.FRAMEBUFFER,null)}},{key:"recycle",value:function(){}},{key:"_disposeResource",value:function(){if(this._frameBuffer){var e=g.instance;e.deleteTexture(this._glTexture),e.deleteFramebuffer(this._frameBuffer),e.deleteRenderbuffer(this._depthStencilBuffer),this._glTexture=null,this._frameBuffer=null,this._depthStencilBuffer=null,this._setGPUMemory(0)}}},{key:"depthStencilFormat",get:function(){return this._depthStencilFormat}},{key:"defaulteTexture",get:function(){return w.grayTexture}},{key:"sourceWidth",get:function(){return this._width}},{key:"sourceHeight",get:function(){return this._height}},{key:"offsetX",get:function(){return 0}},{key:"offsetY",get:function(){return 0}}],[{key:"pushRT",value:function(){RenderTexture2D.rtStack.push({rt:RenderTexture2D._currentActive,w:D.width,h:D.height})}},{key:"popRT",value:function(){var e=g.instance,t=RenderTexture2D.rtStack.pop();t&&(RenderTexture2D._currentActive!=t.rt&&(g.instance.bindFramebuffer(e.FRAMEBUFFER,t.rt?t.rt._frameBuffer:null),RenderTexture2D._currentActive=t.rt),e.viewport(0,0,t.w,t.h),D.width=t.w,D.height=t.h)}},{key:"currentActive",get:function(){return RenderTexture2D._currentActive}}]),RenderTexture2D}(M);B.rtStack=[],B.defuv=[0,0,1,0,1,1,0,1],B.flipyuv=[0,1,1,1,1,0,0,0];var O=function(){function WebGLRTMgr(){_classCallCheck(this,WebGLRTMgr)}return _createClass(WebGLRTMgr,null,[{key:"getRT",value:function(t,i){return i|=0,(t|=0)>=1e4&&console.error("getRT error! w too big"),new B(t,i,e.RenderTextureFormat.R8G8B8A8,-1)}},{key:"releaseRT",value:function(e){e.destroy()}}]),WebGLRTMgr}();O.dict={};var F=function(){function BlendMode(){_classCallCheck(this,BlendMode)}return _createClass(BlendMode,null,[{key:"_init_",value:function(e){BlendMode.fns=[BlendMode.BlendNormal,BlendMode.BlendAdd,BlendMode.BlendMultiply,BlendMode.BlendScreen,BlendMode.BlendOverlay,BlendMode.BlendLight,BlendMode.BlendMask,BlendMode.BlendDestinationOut,BlendMode.BlendAddOld],BlendMode.targetFns=[BlendMode.BlendNormalTarget,BlendMode.BlendAddTarget,BlendMode.BlendMultiplyTarget,BlendMode.BlendScreenTarget,BlendMode.BlendOverlayTarget,BlendMode.BlendLightTarget,BlendMode.BlendMask,BlendMode.BlendDestinationOut,BlendMode.BlendAddTargetOld]}},{key:"BlendNormal",value:function(e){y.setBlendFunc(e,e.ONE,e.ONE_MINUS_SRC_ALPHA,!0)}},{key:"BlendAddOld",value:function(e){y.setBlendFunc(e,e.ONE,e.DST_ALPHA,!0)}},{key:"BlendAdd",value:function(e){y.setBlendFunc(e,e.ONE,e.ONE,!0)}},{key:"BlendMultiply",value:function(e){y.setBlendFunc(e,e.DST_COLOR,e.ONE_MINUS_SRC_ALPHA,!0)}},{key:"BlendScreen",value:function(e){y.setBlendFunc(e,e.ONE,e.ONE,!0)}},{key:"BlendOverlay",value:function(e){y.setBlendFunc(e,e.ONE,e.ONE_MINUS_SRC_COLOR,!0)}},{key:"BlendLight",value:function(e){y.setBlendFunc(e,e.ONE,e.ONE,!0)}},{key:"BlendNormalTarget",value:function(e){y.setBlendFunc(e,e.ONE,e.ONE_MINUS_SRC_ALPHA,!0)}},{key:"BlendAddTargetOld",value:function(e){y.setBlendFunc(e,e.ONE,e.DST_ALPHA,!0)}},{key:"BlendAddTarget",value:function(e){y.setBlendFunc(e,e.ONE,e.ONE,!0)}},{key:"BlendMultiplyTarget",value:function(e){y.setBlendFunc(e,e.DST_COLOR,e.ONE_MINUS_SRC_ALPHA,!0)}},{key:"BlendScreenTarget",value:function(e){y.setBlendFunc(e,e.ONE,e.ONE,!0)}},{key:"BlendOverlayTarget",value:function(e){y.setBlendFunc(e,e.ONE,e.ONE_MINUS_SRC_COLOR,!0)}},{key:"BlendLightTarget",value:function(e){y.setBlendFunc(e,e.ONE,e.ONE,!0)}},{key:"BlendMask",value:function(e){y.setBlendFunc(e,e.ZERO,e.SRC_ALPHA,!0)}},{key:"BlendDestinationOut",value:function(e){y.setBlendFunc(e,e.ZERO,e.ZERO,!0)}}]),BlendMode}();F.activeBlendFunction=null,F.NAMES=["normal","add","multiply","screen","overlay","light","mask","destination-out","add_old"],F.TOINT={normal:0,add:1,multiply:2,screen:3,overlay:4,light:5,mask:6,"destination-out":7,lighter:1,lighter_old:8,add_old:8},F.NORMAL="normal",F.ADD="add",F.MULTIPLY="multiply",F.SCREEN="screen",F.OVERLAY="overlay",F.LIGHT="light",F.MASK="mask",F.DESTINATIONOUT="destination-out",F.LIGHTER="lighter",F.fns=[],F.targetFns=[];var G=function(){function ShaderDefinesBase(e,t,i){_classCallCheck(this,ShaderDefinesBase),this._value=0,this._name2int=e,this._int2name=t,this._int2nameMap=i}return _createClass(ShaderDefinesBase,[{key:"add",value:function(e){return this._value|="string"==typeof e?this._name2int[e]:e,this._value}},{key:"addInt",value:function(e){return this._value|=e,this._value}},{key:"remove",value:function(e){return this._value&="string"==typeof e?~this._name2int[e]:~e,this._value}},{key:"isDefine",value:function(e){return(this._value&e)===e}},{key:"getValue",value:function(){return this._value}},{key:"setValue",value:function(e){this._value=e}},{key:"toNameDic",value:function(){var e=this._int2nameMap[this._value];return e||ShaderDefinesBase._toText(this._value,this._int2name,this._int2nameMap)}}],[{key:"_reg",value:function(e,t,i,n){i[e]=t,n[t]=e}},{key:"_toText",value:function(e,t,i){var n=i[e];if(n)return n;for(var r={},a=1,s=0;s<32&&!((a=1<<s)>e);s++)if(e&a){var o=t[a];o&&(r[o]="")}return i[e]=r,r}},{key:"_toInt",value:function(e,t){for(var i=e.split("."),n=0,r=0,a=i.length;r<a;r++){var s=t[i[r]];if(!s)throw new Error("Defines to int err:"+e+"/"+i[r]);n|=s}return n}}]),ShaderDefinesBase}(),U=function(e){function ShaderDefines2D(){return _classCallCheck(this,ShaderDefines2D),_possibleConstructorReturn(this,_getPrototypeOf(ShaderDefines2D).call(this,ShaderDefines2D.__name2int,ShaderDefines2D.__int2name,ShaderDefines2D.__int2nameMap))}return _inherits(ShaderDefines2D,e),_createClass(ShaderDefines2D,null,[{key:"__init__",value:function(){ShaderDefines2D.reg("TEXTURE2D",ShaderDefines2D.TEXTURE2D),ShaderDefines2D.reg("PRIMITIVE",ShaderDefines2D.PRIMITIVE),ShaderDefines2D.reg("GLOW_FILTER",ShaderDefines2D.FILTERGLOW),ShaderDefines2D.reg("BLUR_FILTER",ShaderDefines2D.FILTERBLUR),ShaderDefines2D.reg("COLOR_FILTER",ShaderDefines2D.FILTERCOLOR),ShaderDefines2D.reg("COLOR_ADD",ShaderDefines2D.COLORADD),ShaderDefines2D.reg("WORLDMAT",ShaderDefines2D.WORLDMAT),ShaderDefines2D.reg("FILLTEXTURE",ShaderDefines2D.FILLTEXTURE),ShaderDefines2D.reg("MVP3D",ShaderDefines2D.MVP3D)}},{key:"reg",value:function(e,t){this._reg(e,t,ShaderDefines2D.__name2int,ShaderDefines2D.__int2name)}},{key:"toText",value:function(e,t,i){return this._toText(e,t,i)}},{key:"toInt",value:function(e){return this._toInt(e,ShaderDefines2D.__name2int)}}]),ShaderDefines2D}(G);U.TEXTURE2D=1,U.PRIMITIVE=4,U.FILTERGLOW=8,U.FILTERBLUR=16,U.FILTERCOLOR=32,U.COLORADD=64,U.WORLDMAT=128,U.FILLTEXTURE=256,U.SKINMESH=512,U.MVP3D=2048,U.NOOPTMASK=U.FILTERGLOW|U.FILTERBLUR|U.FILTERCOLOR|U.FILLTEXTURE,U.__name2int={},U.__int2name=[],U.__int2nameMap=[];var N=function(){function Stat(){_classCallCheck(this,Stat)}return _createClass(Stat,null,[{key:"show",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;Stat._StatRender.show(e,t)}},{key:"enable",value:function(){Stat._StatRender.enable()}},{key:"hide",value:function(){Stat._StatRender.hide()}},{key:"clear",value:function(){Stat.trianglesFaces=Stat.renderBatches=Stat.savedRenderBatches=Stat.shaderCall=Stat.spriteRenderUseCacheCount=Stat.frustumCulling=Stat.octreeNodeCulling=Stat.canvasNormal=Stat.canvasBitmap=Stat.canvasReCache=0}},{key:"onclick",set:function(e){Stat._StatRender.set_onclick(e)}}]),Stat}();N.FPS=0,N.loopCount=0,N.shaderCall=0,N.renderBatches=0,N.savedRenderBatches=0,N.trianglesFaces=0,N.spriteCount=0,N.spriteRenderUseCacheCount=0,N.frustumCulling=0,N.octreeNodeCulling=0,N.canvasNormal=0,N.canvasBitmap=0,N.canvasReCache=0,N.renderSlow=!1,N._fpsData=[],N._timer=0,N._count=0,N._StatRender=null;var W=function(){function StringKey(){_classCallCheck(this,StringKey),this._strsToID={},this._idToStrs=[],this._length=0}return _createClass(StringKey,[{key:"add",value:function(e){var t=this._strsToID[e];return null!=t?t:(this._idToStrs[this._length]=e,this._strsToID[e]=this._length++)}},{key:"getID",value:function(e){var t=this._strsToID[e];return null==t?-1:t}},{key:"getName",value:function(e){var t=this._idToStrs[e];return null==t?void 0:t}}]),StringKey}(),V=function(e){function Shader(e,t){var i,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(_classCallCheck(this,Shader),(i=_possibleConstructorReturn(this,_getPrototypeOf(Shader).call(this)))._attribInfo=null,i.customCompile=!1,i._curActTexIndex=0,i.tag={},i._program=null,i._params=null,i._paramsMap={},!e||!t)throw"Shader Error";return i._attribInfo=a,i._id=++Shader._count,i._vs=e,i._ps=t,i._nameMap=r||{},null!=n&&(Shader.sharders[n]=_assertThisInitialized(i)),i.recreateResource(),i.lock=!0,i}return _inherits(Shader,e),_createClass(Shader,[{key:"recreateResource",value:function(){this._compile(),this._setGPUMemory(0)}},{key:"_disposeResource",value:function(){y.mainContext.deleteShader(this._vshader),y.mainContext.deleteShader(this._pshader),y.mainContext.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._params=null,this._paramsMap={},this._setGPUMemory(0),this._curActTexIndex=0}},{key:"_compile",value:function(){if(this._vs&&this._ps&&!this._params){var e;this._reCompile=!0,this._params=[],this.customCompile&&(e=i.ShaderCompile.preGetParams(this._vs,this._ps));var t,n,r,a=y.mainContext;this._program=a.createProgram(),this._vshader=Shader._createShader(a,this._vs,a.VERTEX_SHADER),this._pshader=Shader._createShader(a,this._ps,a.FRAGMENT_SHADER),a.attachShader(this._program,this._vshader),a.attachShader(this._program,this._pshader);var s=this._attribInfo?this._attribInfo.length:0;for(n=0;n<s;n+=2)a.bindAttribLocation(this._program,this._attribInfo[n+1],this._attribInfo[n]);if(a.linkProgram(this._program),!this.customCompile&&!a.getProgramParameter(this._program,a.LINK_STATUS))throw a.getProgramInfoLog(this._program);var o=this.customCompile?e.uniforms.length:a.getProgramParameter(this._program,a.ACTIVE_UNIFORMS);for(n=0;n<o;n++){var l=this.customCompile?e.uniforms[n]:a.getActiveUniform(this._program,n);(t={vartype:"uniform",glfun:null,ivartype:1,location:a.getUniformLocation(this._program,l.name),name:l.name,type:l.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0}).name.indexOf("[0]")>0&&(t.name=t.name.substr(0,t.name.length-3),t.isArray=!0,t.location=a.getUniformLocation(this._program,t.name)),this._params.push(t)}for(n=0,r=this._params.length;n<r;n++)switch((t=this._params[n]).indexOfParams=n,t.index=1,t.value=[t.location,null],t.codename=t.name,t.name=this._nameMap[t.codename]?this._nameMap[t.codename]:t.codename,this._paramsMap[t.name]=t,t._this=this,t.uploadedValue=[],t.type){case a.INT:t.fun=t.isArray?this._uniform1iv:this._uniform1i;break;case a.FLOAT:t.fun=t.isArray?this._uniform1fv:this._uniform1f;break;case a.FLOAT_VEC2:t.fun=t.isArray?this._uniform_vec2v:this._uniform_vec2;break;case a.FLOAT_VEC3:t.fun=t.isArray?this._uniform_vec3v:this._uniform_vec3;break;case a.FLOAT_VEC4:t.fun=t.isArray?this._uniform_vec4v:this._uniform_vec4;break;case a.SAMPLER_2D:t.fun=this._uniform_sampler2D;break;case a.SAMPLER_CUBE:t.fun=this._uniform_samplerCube;break;case a.FLOAT_MAT4:t.glfun=a.uniformMatrix4fv,t.fun=this._uniformMatrix4fv;break;case a.BOOL:t.fun=this._uniform1i;break;case a.FLOAT_MAT2:case a.FLOAT_MAT3:default:throw new Error("compile shader err!")}}}},{key:"getUniform",value:function(e){return this._paramsMap[e]}},{key:"_uniform1f",value:function(e,t){var i=e.uploadedValue;return i[0]!==t?(y.mainContext.uniform1f(e.location,i[0]=t),1):0}},{key:"_uniform1fv",value:function(e,t){if(t.length<4){var i=e.uploadedValue;return i[0]!==t[0]||i[1]!==t[1]||i[2]!==t[2]||i[3]!==t[3]?(y.mainContext.uniform1fv(e.location,t),i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],1):0}return y.mainContext.uniform1fv(e.location,t),1}},{key:"_uniform_vec2",value:function(e,t){var i=e.uploadedValue;return i[0]!==t[0]||i[1]!==t[1]?(y.mainContext.uniform2f(e.location,i[0]=t[0],i[1]=t[1]),1):0}},{key:"_uniform_vec2v",value:function(e,t){if(t.length<2){var i=e.uploadedValue;return i[0]!==t[0]||i[1]!==t[1]||i[2]!==t[2]||i[3]!==t[3]?(y.mainContext.uniform2fv(e.location,t),i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],1):0}return y.mainContext.uniform2fv(e.location,t),1}},{key:"_uniform_vec3",value:function(e,t){var i=e.uploadedValue;return i[0]!==t[0]||i[1]!==t[1]||i[2]!==t[2]?(y.mainContext.uniform3f(e.location,i[0]=t[0],i[1]=t[1],i[2]=t[2]),1):0}},{key:"_uniform_vec3v",value:function(e,t){return y.mainContext.uniform3fv(e.location,t),1}},{key:"_uniform_vec4",value:function(e,t){var i=e.uploadedValue;return i[0]!==t[0]||i[1]!==t[1]||i[2]!==t[2]||i[3]!==t[3]?(y.mainContext.uniform4f(e.location,i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3]),1):0}},{key:"_uniform_vec4v",value:function(e,t){return y.mainContext.uniform4fv(e.location,t),1}},{key:"_uniformMatrix2fv",value:function(e,t){return y.mainContext.uniformMatrix2fv(e.location,!1,t),1}},{key:"_uniformMatrix3fv",value:function(e,t){return y.mainContext.uniformMatrix3fv(e.location,!1,t),1}},{key:"_uniformMatrix4fv",value:function(e,t){return y.mainContext.uniformMatrix4fv(e.location,!1,t),1}},{key:"_uniform1i",value:function(e,t){var i=e.uploadedValue;return i[0]!==t?(y.mainContext.uniform1i(e.location,i[0]=t),1):0}},{key:"_uniform1iv",value:function(e,t){return y.mainContext.uniform1iv(e.location,t),1}},{key:"_uniform_ivec2",value:function(e,t){var i=e.uploadedValue;return i[0]!==t[0]||i[1]!==t[1]?(y.mainContext.uniform2i(e.location,i[0]=t[0],i[1]=t[1]),1):0}},{key:"_uniform_ivec2v",value:function(e,t){return y.mainContext.uniform2iv(e.location,t),1}},{key:"_uniform_vec3i",value:function(e,t){var i=e.uploadedValue;return i[0]!==t[0]||i[1]!==t[1]||i[2]!==t[2]?(y.mainContext.uniform3i(e.location,i[0]=t[0],i[1]=t[1],i[2]=t[2]),1):0}},{key:"_uniform_vec3vi",value:function(e,t){return y.mainContext.uniform3iv(e.location,t),1}},{key:"_uniform_vec4i",value:function(e,t){var i=e.uploadedValue;return i[0]!==t[0]||i[1]!==t[1]||i[2]!==t[2]||i[3]!==t[3]?(y.mainContext.uniform4i(e.location,i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3]),1):0}},{key:"_uniform_vec4vi",value:function(e,t){return y.mainContext.uniform4iv(e.location,t),1}},{key:"_uniform_sampler2D",value:function(e,t){var i=y.mainContext,n=e.uploadedValue;return null==n[0]?(n[0]=this._curActTexIndex,i.uniform1i(e.location,this._curActTexIndex),y.activeTexture(i,i.TEXTURE0+this._curActTexIndex),y.bindTexture(i,i.TEXTURE_2D,t),this._curActTexIndex++,1):(y.activeTexture(i,i.TEXTURE0+n[0]),y.bindTexture(i,i.TEXTURE_2D,t),0)}},{key:"_uniform_samplerCube",value:function(e,t){var i=y.mainContext,n=e.uploadedValue;return null==n[0]?(n[0]=this._curActTexIndex,i.uniform1i(e.location,this._curActTexIndex),y.activeTexture(i,i.TEXTURE0+this._curActTexIndex),y.bindTexture(i,i.TEXTURE_CUBE_MAP,t),this._curActTexIndex++,1):(y.activeTexture(i,i.TEXTURE0+n[0]),y.bindTexture(i,i.TEXTURE_CUBE_MAP,t),0)}},{key:"_noSetValue",value:function(e){console.log("no....:"+e.name)}},{key:"uploadOne",value:function(e,t){y.useProgram(y.mainContext,this._program);var i=this._paramsMap[e];i.fun.call(this,i,t)}},{key:"uploadTexture2D",value:function(e){var t=y;t._activeTextures[0]!==e&&(t.bindTexture(y.mainContext,g.instance.TEXTURE_2D,e),t._activeTextures[0]=e)}},{key:"upload",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;P.activeShader=P.bindShader=this;var i=y.mainContext;y.useProgram(i,this._program),this._reCompile?(t=this._params,this._reCompile=!1):t=t||this._params;for(var n,r,a=t.length,s=0,o=0;o<a;o++)null!==(r=e[(n=t[o]).name])&&(s+=n.fun.call(this,n,r));N.shaderCall+=s}},{key:"uploadArray",value:function(e,t,i){P.activeShader=this,P.bindShader=this,y.useProgram(y.mainContext,this._program);this._params;for(var n,r,a=0,s=t-2;s>=0;s-=2)(r=this._paramsMap[e[s]])&&null!=(n=e[s+1])&&(i&&i[r.name]&&i[r.name].bind(),a+=r.fun.call(this,r,n));N.shaderCall+=a}},{key:"getParams",value:function(){return this._params}},{key:"setAttributesLocation",value:function(e){this._attribInfo=e}}],[{key:"getShader",value:function(e){return Shader.sharders[e]}},{key:"create",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return new Shader(e,t,i,n,r)}},{key:"withCompile",value:function(e,t,i,n){if(i&&Shader.sharders[i])return Shader.sharders[i];var r=Shader._preCompileShader[Shader.SHADERNAME2ID*e];if(!r)throw new Error("withCompile shader err!"+e);return r.createShader(t,i,n,null)}},{key:"withCompile2D",value:function(e,t,i,n,r){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;if(n&&Shader.sharders[n])return Shader.sharders[n];var s=Shader._preCompileShader[Shader.SHADERNAME2ID*e+t];if(!s)throw new Error("withCompile shader err!"+e+" "+t);return s.createShader(i,n,r,a)}},{key:"addInclude",value:function(e,t){i.ShaderCompile.addInclude(e,t)}},{key:"preCompile",value:function(e,t,n,r){var a=Shader.SHADERNAME2ID*e;Shader._preCompileShader[a]=new i.ShaderCompile(t,n,r)}},{key:"preCompile2D",value:function(e,t,n,r,a){var s=Shader.SHADERNAME2ID*e+t;Shader._preCompileShader[s]=new i.ShaderCompile(n,r,a)}},{key:"_createShader",value:function(e,t,i){var n=e.createShader(i);return e.shaderSource(n,t),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS)?n:(console.log(e.getShaderInfoLog(n)),null)}}]),Shader}(P);V._count=0,V._preCompileShader={},V.SHADERNAME2ID=2e-4,V.nameKey=new W,V.sharders=new Array(32);var H=function(e){function Shader2X(e,t){var i,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return _classCallCheck(this,Shader2X),(i=_possibleConstructorReturn(this,_getPrototypeOf(Shader2X).call(this,e,t,n,r,a)))._params2dQuick2=null,i._shaderValueWidth=0,i._shaderValueHeight=0,i}return _inherits(Shader2X,e),_createClass(Shader2X,[{key:"_disposeResource",value:function(){_get(_getPrototypeOf(Shader2X.prototype),"_disposeResource",this).call(this),this._params2dQuick2=null}},{key:"upload2dQuick2",value:function(e){this.upload(e,this._params2dQuick2||this._make2dQuick2())}},{key:"_make2dQuick2",value:function(){if(!this._params2dQuick2){this._params2dQuick2=[];for(var e,t=this._params,i=0,n=t.length;i<n;i++)"size"!==(e=t[i]).name&&this._params2dQuick2.push(e)}return this._params2dQuick2}}],[{key:"create",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return new Shader2X(e,t,i,n,r)}}]),Shader2X}(V),Y=function(){function Value2D(e,t){_classCallCheck(this,Value2D),this.defines=new U,this.size=[0,0],this.alpha=1,this.ALPHA=1,this.subID=0,this.ref=1,this._cacheID=0,this.clipMatDir=[i.Context._MAXSIZE,0,0,i.Context._MAXSIZE],this.clipMatPos=[0,0],this.clipOff=[0,0],this.mainID=e,this.subID=t,this.textureHost=null,this.texture=null,this.color=null,this.colorAdd=null,this.u_mmat2=null,this._cacheID=e|t,this._inClassCache=Value2D._cache[this._cacheID],e>0&&!this._inClassCache&&(this._inClassCache=Value2D._cache[this._cacheID]=[],this._inClassCache._length=0),this.clear()}return _createClass(Value2D,[{key:"setValue",value:function(e){}},{key:"_ShaderWithCompile",value:function(){return V.withCompile2D(0,this.mainID,this.defines.toNameDic(),this.mainID|this.defines._value,H.create,this._attribLocation)}},{key:"upload",value:function(){var e=D;D.worldMatrix4===D.TEMPMAT4_ARRAY||this.defines.addInt(U.WORLDMAT),this.mmat=e.worldMatrix4,D.matWVP&&(this.defines.addInt(U.MVP3D),this.u_MvpMatrix=D.matWVP.elements);var t=V.sharders[this.mainID|this.defines._value]||this._ShaderWithCompile();t._shaderValueWidth!==e.width||t._shaderValueHeight!==e.height?(this.size[0]=e.width,this.size[1]=e.height,t._shaderValueWidth=e.width,t._shaderValueHeight=e.height,t.upload(this,null)):t.upload(this,t._params2dQuick2||t._make2dQuick2())}},{key:"setFilters",value:function(e){if(this.filters=e,e)for(var t,i=e.length,n=0;n<i;n++)(t=e[n])&&(this.defines.add(t.type),t.action.setValue(this))}},{key:"clear",value:function(){this.defines._value=this.subID,this.clipOff[0]=0}},{key:"release",value:function(){--this.ref<1&&(this._inClassCache&&(this._inClassCache[this._inClassCache._length++]=this),this.clear(),this.filters=null,this.ref=1,this.clipOff[0]=0)}}],[{key:"_initone",value:function(e,t){Value2D._typeClass[e]=t,Value2D._cache[e]=[],Value2D._cache[e]._length=0}},{key:"__init__",value:function(){}},{key:"create",value:function(e,t){var i=Value2D._cache[e|t];return i._length?i[--i._length]:new Value2D._typeClass[e|t](t)}}]),Value2D}();Y._cache=[],Y._typeClass=[],Y.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];var X=function(){function SubmitKey(){_classCallCheck(this,SubmitKey),this.clear()}return _createClass(SubmitKey,[{key:"clear",value:function(){this.submitType=-1,this.blendShader=this.other=0}},{key:"copyFrom",value:function(e){this.other=e.other,this.blendShader=e.blendShader,this.submitType=e.submitType}},{key:"copyFrom2",value:function(e,t,i){this.other=i,this.submitType=t}},{key:"equal3_2",value:function(e,t,i){return this.submitType===t&&this.other===i&&this.blendShader===e.blendShader}},{key:"equal4_2",value:function(e,t,i){return this.submitType===t&&this.other===i&&this.blendShader===e.blendShader}},{key:"equal_3",value:function(e){return this.submitType===e.submitType&&this.blendShader===e.blendShader}},{key:"equal",value:function(e){return this.other===e.other&&this.submitType===e.submitType&&this.blendShader===e.blendShader}}]),SubmitKey}(),z=function(){function SubmitCMD(){_classCallCheck(this,SubmitCMD),this._ref=1,this._key=new X}return _createClass(SubmitCMD,[{key:"renderSubmit",value:function(){return this.fun.apply(this._this,this.args),1}},{key:"getRenderType",value:function(){return 0}},{key:"releaseRender",value:function(){if(--this._ref<1){var e=SubmitCMD.POOL;e[e._length++]=this}}}],[{key:"create",value:function(e,t,i){var n=SubmitCMD.POOL._length?SubmitCMD.POOL[--SubmitCMD.POOL._length]:new SubmitCMD;return n.fun=t,n.args=e,n._this=i,n._ref=1,n._key.clear(),n}}]),SubmitCMD}();z.POOL=[],z.POOL._length=0;var K=function(){function Filter(){_classCallCheck(this,Filter)}return _createClass(Filter,[{key:"type",get:function(){return-1}}]),Filter}();K.BLUR=16,K.COLOR=32,K.GLOW=8,K._filter=function(e,t,i,n){var r=t,a=this._next;if(a){var s=e.filters,o=s.length;if(1==o&&s[0].type==K.COLOR)return t.save(),t.setColorFilter(s[0]),a._fun.call(a,e,t,i,n),void t.restore();var l,h=Y.create(U.TEXTURE2D,0),u=v.TEMP,c=r._curMat,_=f.create();c.copyTo(_);var d=0,g=0,y=null,m=e._cacheStyle.filterCache||null;if(m&&0==e.getRepaint()){if((e._cacheStyle.hasGlowFilter||!1)&&(d=50,g=25),(l=e.getBounds()).width<=0||l.height<=0)return;l.width+=d,l.height+=d,u.x=l.x*_.a+l.y*_.c,u.y=l.y*_.d+l.x*_.b,l.x=u.x,l.y=u.y,u.x=l.width*_.a+l.height*_.c,u.y=l.height*_.d+l.width*_.b,l.width=u.x,l.height=u.y}else{e._isHaveGlowFilter()&&(d=50,g=25),(l=new p).copyFrom(e.getSelfBounds()),l.x+=e.x,l.y+=e.y,l.x-=e.pivotX+4,l.y-=e.pivotY+4;var T=l.x,C=l.y;if(l.width+=d+8,l.height+=d+8,u.x=l.x*_.a+l.y*_.c,u.y=l.y*_.d+l.x*_.b,l.x=u.x,l.y=u.y,u.x=l.width*_.a+l.height*_.c,u.y=l.height*_.d+l.width*_.b,l.width=u.x,l.height=u.y,l.width<=0||l.height<=0)return;m&&O.releaseRT(m),y=O.getRT(l.width,l.height);var x=m=O.getRT(l.width,l.height);e._getCacheStyle().filterCache=m,r.pushRT(),r.useRT(y);var k=e.x-T+g,S=e.y-C+g;a._fun.call(a,e,t,k,S),r.useRT(x);for(var R=0;R<o;R++){0!=R&&(r.useRT(y),r.drawTarget(x,0,0,l.width,l.height,f.TEMP.identity(),h,null,F.TOINT.overlay),r.useRT(x));var b=s[R];switch(b.type){case K.BLUR:case K.GLOW:b._glRender&&b._glRender.render(y,t,l.width,l.height,b);break;case K.COLOR:r.setColorFilter(b),r.drawTarget(y,0,0,l.width,l.height,f.EMPTY.identity(),Y.create(U.TEXTURE2D,0)),r.setColorFilter(null)}}r.popRT()}if(i=i-g-e.x,n=n-g-e.y,u.setTo(i,n),_.transformPoint(u),i=u.x+l.x,n=u.y+l.y,r._drawRenderTexture(m,i,n,l.width,l.height,f.TEMP.identity(),1,B.defuv),y){var E=z.create([y],(function(e){e.destroy()}),this);y=null,t.addRenderObject(E)}_.destroy()}};var j=function(){function Utils(){_classCallCheck(this,Utils)}return _createClass(Utils,null,[{key:"toRadian",value:function(e){return e*Utils._pi2}},{key:"toAngle",value:function(e){return e*Utils._pi}},{key:"toHexColor",value:function(e){if(e<0||isNaN(e))return null;for(var t=e.toString(16);t.length<6;)t="0"+t;return"#"+t}},{key:"getGID",value:function(){return Utils._gid++}},{key:"concatArray",value:function(e,t){if(!t)return e;if(!e)return t;var i,n=t.length;for(i=0;i<n;i++)e.push(t[i]);return e}},{key:"clearArray",value:function(e){return e?(e.length=0,e):e}},{key:"copyArray",value:function(e,t){if(e||(e=[]),!t)return e;e.length=t.length;var i,n=t.length;for(i=0;i<n;i++)e[i]=t[i];return e}},{key:"getGlobalRecByPoints",value:function(e,t,i,n,r){var a,s;a=v.create().setTo(t,i),a=e.localToGlobal(a),s=v.create().setTo(n,r),s=e.localToGlobal(s);var o=p._getWrapRec([a.x,a.y,s.x,s.y]);return a.recover(),s.recover(),o}},{key:"getGlobalPosAndScale",value:function(e){return Utils.getGlobalRecByPoints(e,0,0,1,1)}},{key:"bind",value:function(e,t){return e.bind(t)}},{key:"updateOrder",value:function(e){if(!e||e.length<2)return!1;for(var t,i,n,r=1,a=e.length;r<a;){for(n=e[t=r],i=e[t]._zOrder;--t>-1&&e[t]._zOrder>i;)e[t+1]=e[t];e[t+1]=n,r++}return!0}},{key:"transPointList",value:function(e,t,i){var n,r=e.length;for(n=0;n<r;n+=2)e[n]+=t,e[n+1]+=i}},{key:"parseInt",value:function(e){function parseInt(t){return e.apply(this,arguments)}return parseInt.toString=function(){return e.toString()},parseInt}((function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=parseInt(e,t);return isNaN(i)?0:i}))},{key:"getFileExtension",value:function(e){Utils._extReg.lastIndex=e.lastIndexOf(".");var t=Utils._extReg.exec(e);return t&&t.length>1?t[1].toLowerCase():null}},{key:"getFilecompatibleExtension",value:function(e){var t=e.split("."),i=t.length;return t.length>2?t[i-2]+"."+t[i-1]:null}},{key:"getTransformRelativeToWindow",value:function(e,t,i){var n=Utils.gStage,r=Utils.getGlobalPosAndScale(e),a=n._canvasTransform.clone(),s=a.tx,o=a.ty;a.rotate(-Math.PI/180*n.canvasDegree),a.scale(n.clientScaleX,n.clientScaleY);var l,h,u,c,_=n.canvasDegree%180!=0;return _?(l=i+r.y,h=t+r.x,l*=a.d,h*=a.a,90==n.canvasDegree?(l=s-l,h+=o):(l+=s,h=o-h)):(l=t+r.x,h=i+r.y,l*=a.a,h*=a.d,l+=s,h+=o),h+=n._safariOffsetY,_?(u=a.d*r.height,c=a.a*r.width):(u=a.a*r.width,c=a.d*r.height),{x:l,y:h,scaleX:u,scaleY:c}}},{key:"fitDOMElementInArea",value:function(e,t,i,n,r,a){e._fitLayaAirInitialized||(e._fitLayaAirInitialized=!0,e.style.transformOrigin=e.style.webKittransformOrigin="left top",e.style.position="absolute");var s=Utils.getTransformRelativeToWindow(t,i,n);e.style.transform=e.style.webkitTransform="scale("+s.scaleX+","+s.scaleY+") rotate("+Utils.gStage.canvasDegree+"deg)",e.style.width=r+"px",e.style.height=a+"px",e.style.left=s.x+"px",e.style.top=s.y+"px"}},{key:"isOkTextureList",value:function(e){if(!e)return!1;var t,i,n=e.length;for(t=0;t<n;t++)if(!(i=e[t])||!i._getSource())return!1;return!0}},{key:"isOKCmdList",value:function(e){if(!e)return!1;var t,i=e.length;for(t=0;t<i;t++)e[t];return!0}},{key:"getQueryString",value:function(e){if(i.Browser.onMiniGame)return null;if(!window.location||!window.location.search)return null;var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),n=window.location.search.substr(1).match(t);return null!=n?unescape(n[2]):null}}]),Utils}();j.gStage=null,j._gid=1,j._pi=180/Math.PI,j._pi2=Math.PI/180,j._extReg=/\.(\w+)\??/g,j.parseXMLFromString=function(e){var t;if(e=e.replace(/>\s+</g,"><"),(t=(new DOMParser).parseFromString(e,"text/xml")).firstChild.textContent.indexOf("This page contains the following errors")>-1)throw new Error(t.firstChild.firstChild.textContent);return t};var Q=function(){function ColorUtils(e){if(_classCallCheck(this,ColorUtils),this.arrColor=[],null==e)return this.strColor="#00000000",this.numColor=0,void(this.arrColor=[0,0,0,0]);var t,i,n;if("string"==typeof e)if(e.indexOf("rgba(")>=0||e.indexOf("rgb(")>=0){var r,a,s=e;for(r=s.indexOf("("),a=s.indexOf(")"),s=s.substring(r+1,a),this.arrColor=s.split(","),i=this.arrColor.length,t=0;t<i;t++)this.arrColor[t]=parseFloat(this.arrColor[t]),t<3&&(this.arrColor[t]=Math.round(this.arrColor[t]));n=4==this.arrColor.length?256*(256*(256*this.arrColor[0]+this.arrColor[1])+this.arrColor[2])+Math.round(255*this.arrColor[3]):256*(256*this.arrColor[0]+this.arrColor[1])+this.arrColor[2],this.strColor=e}else{if(this.strColor=e,"#"===e.charAt(0)&&(e=e.substr(1)),3===(i=e.length)||4===i){var o="";for(t=0;t<i;t++)o+=e[t]+e[t];e=o}n=parseInt(e,16)}else n=e,this.strColor=j.toHexColor(n);this.strColor.indexOf("rgba")>=0||9===this.strColor.length?(this.arrColor=[((4278190080&n)>>>24)/255,((16711680&n)>>16)/255,((65280&n)>>8)/255,(255&n)/255],this.numColor=(4278190080&n)>>>24|(16711680&n)>>8|(65280&n)<<8|(255&n)<<24):(this.arrColor=[((16711680&n)>>16)/255,((65280&n)>>8)/255,(255&n)/255,1],this.numColor=4278190080|(16711680&n)>>16|65280&n|(255&n)<<16),this.arrColor.__id=++ColorUtils._COLODID}return _createClass(ColorUtils,null,[{key:"_initDefault",value:function(){for(var e in ColorUtils._DEFAULT={},ColorUtils._COLOR_MAP)ColorUtils._SAVE[e]=ColorUtils._DEFAULT[e]=new ColorUtils(ColorUtils._COLOR_MAP[e]);return ColorUtils._DEFAULT}},{key:"_initSaveMap",value:function(){for(var e in ColorUtils._SAVE_SIZE=0,ColorUtils._SAVE={},ColorUtils._DEFAULT)ColorUtils._SAVE[e]=ColorUtils._DEFAULT[e]}},{key:"create",value:function(e){var t=e+"",i=ColorUtils._SAVE[t];return null!=i?i:(ColorUtils._SAVE_SIZE<1e3&&ColorUtils._initSaveMap(),ColorUtils._SAVE[t]=new ColorUtils(e))}}]),ColorUtils}();Q._SAVE={},Q._SAVE_SIZE=0,Q._COLOR_MAP={purple:"#800080",orange:"#ffa500",white:"#FFFFFF",red:"#FF0000",green:"#00FF00",blue:"#0000FF",black:"#000000",yellow:"#FFFF00",gray:"#808080"},Q._DEFAULT=Q._initDefault(),Q._COLODID=1;var q=function(e){function ColorFilter(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return _classCallCheck(this,ColorFilter),e=_possibleConstructorReturn(this,_getPrototypeOf(ColorFilter).call(this)),t||(t=e._copyMatrix(ColorFilter.IDENTITY_MATRIX)),e._mat=new Float32Array(16),e._alpha=new Float32Array(4),e.setByMatrix(t),e}return _inherits(ColorFilter,e),_createClass(ColorFilter,[{key:"gray",value:function(){return this.setByMatrix(ColorFilter.GRAY_MATRIX)}},{key:"color",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return this.setByMatrix([1,0,0,0,e,0,1,0,0,t,0,0,1,0,i,0,0,0,1,n])}},{key:"setColor",value:function(e){var t=Q.create(e).arrColor,i=[0,0,0,0,256*t[0],0,0,0,0,256*t[1],0,0,0,0,256*t[2],0,0,0,1,0];return this.setByMatrix(i)}},{key:"setByMatrix",value:function(e){this._matrix!=e&&this._copyMatrix(e);for(var t=0,i=0,n=0;n<20;n++)n%5!=4?this._mat[t++]=e[n]:this._alpha[i++]=e[n];return this}},{key:"adjustColor",value:function(e,t,i,n){return this.adjustHue(n),this.adjustContrast(t),this.adjustBrightness(e),this.adjustSaturation(i),this}},{key:"adjustBrightness",value:function(e){return 0==(e=this._clampValue(e,100))||isNaN(e)?this:this._multiplyMatrix([1,0,0,0,e,0,1,0,0,e,0,0,1,0,e,0,0,0,1,0,0,0,0,0,1])}},{key:"adjustContrast",value:function(e){if(0==(e=this._clampValue(e,100))||isNaN(e))return this;var t,i=(t=e<0?127+e/100*127:127*(t=0==(t=e%1)?ColorFilter.DELTA_INDEX[e]:ColorFilter.DELTA_INDEX[e<<0]*(1-t)+ColorFilter.DELTA_INDEX[1+(e<<0)]*t)+127)/127,n=.5*(127-t);return this._multiplyMatrix([i,0,0,0,n,0,i,0,0,n,0,0,i,0,n,0,0,0,1,0,0,0,0,0,1])}},{key:"adjustSaturation",value:function(e){if(0==(e=this._clampValue(e,100))||isNaN(e))return this;var t=1+(e>0?3*e/100:e/100),i=1-t,n=.3086*i,r=.6094*i,a=.082*i;return this._multiplyMatrix([n+t,r,a,0,0,n,r+t,a,0,0,n,r,a+t,0,0,0,0,0,1,0,0,0,0,0,1])}},{key:"adjustHue",value:function(e){if(0==(e=this._clampValue(e,180)/180*Math.PI)||isNaN(e))return this;var t=Math.cos(e),i=Math.sin(e),n=.213,r=.715,a=.072;return this._multiplyMatrix([n+t*(1-n)+i*-n,r+t*-r+i*-r,a+t*-a+i*(1-a),0,0,n+t*-n+.143*i,r+t*(1-r)+.14*i,a+t*-a+-.283*i,0,0,n+t*-n+-.787*i,r+t*-r+i*r,a+t*(1-a)+i*a,0,0,0,0,0,1,0,0,0,0,0,1])}},{key:"reset",value:function(){return this.setByMatrix(this._copyMatrix(ColorFilter.IDENTITY_MATRIX))}},{key:"_multiplyMatrix",value:function(e){var t=[];this._matrix=this._fixMatrix(this._matrix);for(var i=0;i<5;i++){for(var n=0;n<5;n++)t[n]=this._matrix[n+5*i];for(n=0;n<5;n++){for(var r=0,a=0;a<5;a++)r+=e[n+5*a]*t[a];this._matrix[n+5*i]=r}}return this.setByMatrix(this._matrix)}},{key:"_clampValue",value:function(e,t){return Math.min(t,Math.max(-t,e))}},{key:"_fixMatrix",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return null==e?ColorFilter.IDENTITY_MATRIX:(e.length<ColorFilter.LENGTH?e=e.slice(0,e.length).concat(ColorFilter.IDENTITY_MATRIX.slice(e.length,ColorFilter.LENGTH)):e.length>ColorFilter.LENGTH&&(e=e.slice(0,ColorFilter.LENGTH)),e)}},{key:"_copyMatrix",value:function(e){var t=ColorFilter.LENGTH;this._matrix||(this._matrix=[]);for(var i=0;i<t;i++)this._matrix[i]=e[i];return this._matrix}},{key:"type",get:function(){return K.COLOR}}]),ColorFilter}(K);q.DELTA_INDEX=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10],q.GRAY_MATRIX=[.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,0,0,0,1,0],q.IDENTITY_MATRIX=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1],q.LENGTH=25;var Z=function(){function DrawTextureCmd(){_classCallCheck(this,DrawTextureCmd),this.colorFlt=null,this.uv=null}return _createClass(DrawTextureCmd,[{key:"recover",value:function(){this.texture&&this.texture._removeReference(),this.texture=null,this.matrix=null,n.recover("DrawTextureCmd",this)}},{key:"run",value:function(e,t,i){this.texture&&e.drawTextureWithTransform(this.texture,this.x,this.y,this.width,this.height,this.matrix,t,i,this.alpha,this.blendMode,this.colorFlt,this.uv)}},{key:"cmdID",get:function(){return DrawTextureCmd.ID}}],[{key:"create",value:function(e,t,i,r,a,s,o,l,h,u){var c=n.getItemByClass("DrawTextureCmd",DrawTextureCmd);return c.texture=e,e._addReference(),c.x=t,c.y=i,c.width=r,c.height=a,c.matrix=s,c.alpha=o,c.color=l,c.blendMode=h,c.uv=null==u?null:u,l&&(c.colorFlt=new q,c.colorFlt.setColor(l)),c}}]),DrawTextureCmd}();Z.ID="DrawTexture";var $=function(){function FillTextureCmd(){_classCallCheck(this,FillTextureCmd)}return _createClass(FillTextureCmd,[{key:"recover",value:function(){this.texture=null,this.offset=null,this.other=null,n.recover("FillTextureCmd",this)}},{key:"run",value:function(e,t,i){e.fillTexture(this.texture,this.x+t,this.y+i,this.width,this.height,this.type,this.offset,this.other)}},{key:"cmdID",get:function(){return FillTextureCmd.ID}}],[{key:"create",value:function(e,t,i,r,a,s,o,l){var h=n.getItemByClass("FillTextureCmd",FillTextureCmd);return h.texture=e,h.x=t,h.y=i,h.width=r,h.height=a,h.type=s,h.offset=o,h.other=l,h}}]),FillTextureCmd}();$.ID="FillTexture";var J=function(){function RestoreCmd(){_classCallCheck(this,RestoreCmd)}return _createClass(RestoreCmd,[{key:"recover",value:function(){n.recover("RestoreCmd",this)}},{key:"run",value:function(e,t,i){e.restore()}},{key:"cmdID",get:function(){return RestoreCmd.ID}}],[{key:"create",value:function(){return n.getItemByClass("RestoreCmd",RestoreCmd)}}]),RestoreCmd}();J.ID="Restore";var ee=function(){function RotateCmd(){_classCallCheck(this,RotateCmd)}return _createClass(RotateCmd,[{key:"recover",value:function(){n.recover("RotateCmd",this)}},{key:"run",value:function(e,t,i){e._rotate(this.angle,this.pivotX+t,this.pivotY+i)}},{key:"cmdID",get:function(){return RotateCmd.ID}}],[{key:"create",value:function(e,t,i){var r=n.getItemByClass("RotateCmd",RotateCmd);return r.angle=e,r.pivotX=t,r.pivotY=i,r}}]),RotateCmd}();ee.ID="Rotate";var te=function(){function ScaleCmd(){_classCallCheck(this,ScaleCmd)}return _createClass(ScaleCmd,[{key:"recover",value:function(){n.recover("ScaleCmd",this)}},{key:"run",value:function(e,t,i){e._scale(this.scaleX,this.scaleY,this.pivotX+t,this.pivotY+i)}},{key:"cmdID",get:function(){return ScaleCmd.ID}}],[{key:"create",value:function(e,t,i,r){var a=n.getItemByClass("ScaleCmd",ScaleCmd);return a.scaleX=e,a.scaleY=t,a.pivotX=i,a.pivotY=r,a}}]),ScaleCmd}();te.ID="Scale";var ie=function(){function TransformCmd(){_classCallCheck(this,TransformCmd)}return _createClass(TransformCmd,[{key:"recover",value:function(){this.matrix=null,n.recover("TransformCmd",this)}},{key:"run",value:function(e,t,i){e._transform(this.matrix,this.pivotX+t,this.pivotY+i)}},{key:"cmdID",get:function(){return TransformCmd.ID}}],[{key:"create",value:function(e,t,i){var r=n.getItemByClass("TransformCmd",TransformCmd);return r.matrix=e,r.pivotX=t,r.pivotY=i,r}}]),TransformCmd}();ie.ID="Transform";var ne=function(){function TranslateCmd(){_classCallCheck(this,TranslateCmd)}return _createClass(TranslateCmd,[{key:"recover",value:function(){n.recover("TranslateCmd",this)}},{key:"run",value:function(e,t,i){e.translate(this.tx,this.ty)}},{key:"cmdID",get:function(){return TranslateCmd.ID}}],[{key:"create",value:function(e,t){var i=n.getItemByClass("TranslateCmd",TranslateCmd);return i.tx=e,i.ty=t,i}}]),TranslateCmd}();ne.ID="Translate";var re=function(){function Bezier(){_classCallCheck(this,Bezier),this._controlPoints=[new v,new v,new v],this._calFun=this.getPoint2}return _createClass(Bezier,[{key:"_switchPoint",value:function(e,t){var i=this._controlPoints.shift();i.setTo(e,t),this._controlPoints.push(i)}},{key:"getPoint2",value:function(e,t){var i=this._controlPoints[0],n=this._controlPoints[1],r=this._controlPoints[2],a=Math.pow(1-e,2)*i.x+2*e*(1-e)*n.x+Math.pow(e,2)*r.x,s=Math.pow(1-e,2)*i.y+2*e*(1-e)*n.y+Math.pow(e,2)*r.y;t.push(a,s)}},{key:"getPoint3",value:function(e,t){var i=this._controlPoints[0],n=this._controlPoints[1],r=this._controlPoints[2],a=this._controlPoints[3],s=Math.pow(1-e,3)*i.x+3*n.x*e*(1-e)*(1-e)+3*r.x*e*e*(1-e)+a.x*Math.pow(e,3),o=Math.pow(1-e,3)*i.y+3*n.y*e*(1-e)*(1-e)+3*r.y*e*e*(1-e)+a.y*Math.pow(e,3);t.push(s,o)}},{key:"insertPoints",value:function(e,t){var i,n;for(n=1/(e=e>0?e:5),i=0;i<=1;i+=n)this._calFun(i,t)}},{key:"getBezierPoints",value:function(e){var t,i,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;if((i=e.length)<2*(r+1))return[];var a=[];switch(r){case 2:this._calFun=this.getPoint2;break;case 3:this._calFun=this.getPoint3;break;default:return[]}for(;this._controlPoints.length<=r;)this._controlPoints.push(v.create());for(t=0;t<2*r;t+=2)this._switchPoint(e[t],e[t+1]);for(t=2*r;t<i;t+=2)this._switchPoint(e[t],e[t+1]),t/2%r==0&&this.insertPoints(n,a);return a}}]),Bezier}();re.I=new re;var ae=function(){function GrahamScan(){_classCallCheck(this,GrahamScan)}return _createClass(GrahamScan,null,[{key:"multiply",value:function(e,t,i){return(e.x-i.x)*(t.y-i.y)-(t.x-i.x)*(e.y-i.y)}},{key:"dis",value:function(e,t){return(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y)}},{key:"_getPoints",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;for(GrahamScan._mPointList||(GrahamScan._mPointList=[]);GrahamScan._mPointList.length<e;)GrahamScan._mPointList.push(new v);return i||(i=[]),i.length=0,t?GrahamScan.getFrom(i,GrahamScan._mPointList,e):GrahamScan.getFromR(i,GrahamScan._mPointList,e),i}},{key:"getFrom",value:function(e,t,i){var n;for(n=0;n<i;n++)e.push(t[n]);return e}},{key:"getFromR",value:function(e,t,i){var n;for(n=0;n<i;n++)e.push(t.pop());return e}},{key:"pListToPointList",value:function(e){var t,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=e.length/2,r=GrahamScan._getPoints(n,i,GrahamScan._tempPointList);for(t=0;t<n;t++)r[t].setTo(e[t+t],e[t+t+1]);return r}},{key:"pointListToPlist",value:function(e){var t,i,n=e.length,r=GrahamScan._temPList;for(r.length=0,t=0;t<n;t++)i=e[t],r.push(i.x,i.y);return r}},{key:"scanPList",value:function(e){return j.copyArray(e,GrahamScan.pointListToPlist(GrahamScan.scan(GrahamScan.pListToPointList(e,!0))))}},{key:"scan",value:function(e){var t,i,n,r,a,s=0,o=e.length,l={};for((r=GrahamScan._temArr).length=0,t=(o=e.length)-1;t>=0;t--)(a=(n=e[t]).x+"_"+n.y)in l||(l[a]=!0,r.push(n));for(o=r.length,j.copyArray(e,r),t=1;t<o;t++)(e[t].y<e[s].y||e[t].y==e[s].y&&e[t].x<e[s].x)&&(s=t);for(n=e[0],e[0]=e[s],e[s]=n,t=1;t<o-1;t++){for(s=t,i=t+1;i<o;i++)(GrahamScan.multiply(e[i],e[s],e[0])>0||0==GrahamScan.multiply(e[i],e[s],e[0])&&GrahamScan.dis(e[0],e[i])<GrahamScan.dis(e[0],e[s]))&&(s=i);n=e[t],e[t]=e[s],e[s]=n}if((r=GrahamScan._temArr).length=0,e.length<3)return j.copyArray(r,e);for(r.push(e[0],e[1],e[2]),t=3;t<o;t++){for(;r.length>=2&&GrahamScan.multiply(e[t],r[r.length-1],r[r.length-2])>=0;)r.pop();e[t]&&r.push(e[t])}return r}}]),GrahamScan}();ae._tempPointList=[],ae._temPList=[],ae._temArr=[];var se=function(){function DrawStyle(e){_classCallCheck(this,DrawStyle),this.setValue(e)}return _createClass(DrawStyle,[{key:"setValue",value:function(e){this._color=e?e instanceof Q?e:Q.create(e):Q.create("#000000")}},{key:"reset",value:function(){this._color=Q.create("#000000")}},{key:"toInt",value:function(){return this._color.numColor}},{key:"equal",value:function(e){return"string"==typeof e?this._color.strColor===e:e instanceof Q&&this._color.numColor===e.numColor}},{key:"toColorStr",value:function(){return this._color.strColor}}],[{key:"create",value:function(e){if(e){var t=e instanceof Q?e:Q.create(e);return t._drawStyle||(t._drawStyle=new DrawStyle(e))}return DrawStyle.DEFAULT}}]),DrawStyle}();se.DEFAULT=new se("#000000");var oe=function(){function Path(){_classCallCheck(this,Path),this._lastOriX=0,this._lastOriY=0,this.paths=[],this._curPath=null}return _createClass(Path,[{key:"beginPath",value:function(e){this.paths.length=1,this._curPath=this.paths[0]=new le,this._curPath.convex=e}},{key:"closePath",value:function(){this._curPath.loop=!0}},{key:"newPath",value:function(){this._curPath=new le,this.paths.push(this._curPath)}},{key:"addPoint",value:function(e,t){this._curPath.path.push(e,t)}},{key:"push",value:function(e,t){this._curPath?this._curPath.path.length>0&&(this._curPath=new le,this.paths.push(this._curPath)):(this._curPath=new le,this.paths.push(this._curPath));var i=this._curPath;i.path=e.slice(),i.convex=t}},{key:"reset",value:function(){this.paths.length=0}}]),Path}(),le=function renderPath(){_classCallCheck(this,renderPath),this.path=[],this.loop=!1,this.convex=!1},he=function(){function SubmitBase(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:SubmitBase.TYPE_2D;_classCallCheck(this,SubmitBase),this.clipInfoID=-1,this._mesh=null,this._blendFn=null,this._id=0,this._renderType=0,this._parent=null,this._key=new X,this._startIdx=0,this._numEle=0,this._ref=1,this.shaderValue=null,this._renderType=e,this._id=++SubmitBase.ID}return _createClass(SubmitBase,[{key:"getID",value:function(){return this._id}},{key:"getRenderType",value:function(){return this._renderType}},{key:"toString",value:function(){return"ibindex:"+this._startIdx+" num:"+this._numEle+" key="+this._key}},{key:"renderSubmit",value:function(){return 1}},{key:"releaseRender",value:function(){}}],[{key:"__init__",value:function(){var e=SubmitBase.RENDERBASE=new SubmitBase(-1);e.shaderValue=new Y(0,0),e.shaderValue.ALPHA=1,e._ref=4294967295}}]),SubmitBase}();he.TYPE_2D=1e4,he.TYPE_CANVAS=10003,he.TYPE_CMDSETRT=10004,he.TYPE_CUSTOM=10005,he.TYPE_BLURRT=10006,he.TYPE_CMDDESTORYPRERT=10007,he.TYPE_DISABLESTENCIL=10008,he.TYPE_OTHERIBVB=10009,he.TYPE_PRIMITIVE=10010,he.TYPE_RT=10011,he.TYPE_BLUR_RT=10012,he.TYPE_TARGET=10013,he.TYPE_CHANGE_VALUE=10014,he.TYPE_SHAPE=10015,he.TYPE_TEXTURE=10016,he.TYPE_FILLTEXTURE=10017,he.KEY_ONCE=-1,he.KEY_FILLRECT=1,he.KEY_DRAWTEXTURE=2,he.KEY_VG=3,he.KEY_TRIANGLES=4,he.ID=1,he.preRender=null;var ue=function(){function SaveBase(){_classCallCheck(this,SaveBase)}return _createClass(SaveBase,[{key:"isSaveMark",value:function(){return!1}},{key:"restore",value:function(e){this._dataObj[this._valueName]=this._value,SaveBase.POOL[SaveBase.POOL._length++]=this,this._newSubmit&&(e._curSubmit=he.RENDERBASE)}}],[{key:"_createArray",value:function(){var e=[];return e._length=0,e}},{key:"_init",value:function(){var e=SaveBase._namemap={};return e[SaveBase.TYPE_ALPHA]="ALPHA",e[SaveBase.TYPE_FILESTYLE]="fillStyle",e[SaveBase.TYPE_FONT]="font",e[SaveBase.TYPE_LINEWIDTH]="lineWidth",e[SaveBase.TYPE_STROKESTYLE]="strokeStyle",e[SaveBase.TYPE_ENABLEMERGE]="_mergeID",e[SaveBase.TYPE_MARK]=e[SaveBase.TYPE_TRANSFORM]=e[SaveBase.TYPE_TRANSLATE]=[],e[SaveBase.TYPE_TEXTBASELINE]="textBaseline",e[SaveBase.TYPE_TEXTALIGN]="textAlign",e[SaveBase.TYPE_GLOBALCOMPOSITEOPERATION]="_nBlendType",e[SaveBase.TYPE_SHADER]="shader",e[SaveBase.TYPE_FILTERS]="filters",e[SaveBase.TYPE_COLORFILTER]="_colorFiler",e}},{key:"save",value:function(e,t,i,n){if((e._saveMark._saveuse&t)!==t){e._saveMark._saveuse|=t;var r=SaveBase.POOL,a=r._length>0?r[--r._length]:new SaveBase;a._value=i[a._valueName=SaveBase._namemap[t]],a._dataObj=i,a._newSubmit=n;var s=e._save;s[s._length++]=a}}}]),SaveBase}();ue.TYPE_ALPHA=1,ue.TYPE_FILESTYLE=2,ue.TYPE_FONT=8,ue.TYPE_LINEWIDTH=256,ue.TYPE_STROKESTYLE=512,ue.TYPE_MARK=1024,ue.TYPE_TRANSFORM=2048,ue.TYPE_TRANSLATE=4096,ue.TYPE_ENABLEMERGE=8192,ue.TYPE_TEXTBASELINE=16384,ue.TYPE_TEXTALIGN=32768,ue.TYPE_GLOBALCOMPOSITEOPERATION=65536,ue.TYPE_CLIPRECT=131072,ue.TYPE_CLIPRECT_STENCIL=262144,ue.TYPE_IBVB=524288,ue.TYPE_SHADER=1048576,ue.TYPE_FILTERS=2097152,ue.TYPE_FILTERS_TYPE=4194304,ue.TYPE_COLORFILTER=8388608,ue.POOL=ue._createArray(),ue._namemap=ue._init();var ce=function(){function SaveClipRect(){_classCallCheck(this,SaveClipRect),this._globalClipMatrix=new f,this._clipInfoID=-1,this._clipRect=new p,this.incache=!1}return _createClass(SaveClipRect,[{key:"isSaveMark",value:function(){return!1}},{key:"restore",value:function(e){this._globalClipMatrix.copyTo(e._globalClipMatrix),this._clipRect.clone(e._clipRect),e._clipInfoID=this._clipInfoID,SaveClipRect.POOL[SaveClipRect.POOL._length++]=this,e._clipInCache=this.incache}}],[{key:"save",value:function(e){if((e._saveMark._saveuse&ue.TYPE_CLIPRECT)!=ue.TYPE_CLIPRECT){e._saveMark._saveuse|=ue.TYPE_CLIPRECT;var t=SaveClipRect.POOL,i=t._length>0?t[--t._length]:new SaveClipRect;e._globalClipMatrix.copyTo(i._globalClipMatrix),e._clipRect.clone(i._clipRect),i._clipInfoID=e._clipInfoID,i.incache=e._clipInCache;var n=e._save;n[n._length++]=i}}}]),SaveClipRect}();ce.POOL=ue._createArray();var _e=function(){function SaveMark(){_classCallCheck(this,SaveMark),this._saveuse=0}return _createClass(SaveMark,[{key:"isSaveMark",value:function(){return!0}},{key:"restore",value:function(e){e._saveMark=this._preSaveMark,SaveMark.POOL[SaveMark.POOL._length++]=this}}],[{key:"Create",value:function(e){var t=SaveMark.POOL,i=t._length>0?t[--t._length]:new SaveMark;return i._saveuse=0,i._preSaveMark=e._saveMark,e._saveMark=i,i}}]),SaveMark}();_e.POOL=ue._createArray();var de=function(){function SaveTransform(){_classCallCheck(this,SaveTransform),this._matrix=new f}return _createClass(SaveTransform,[{key:"isSaveMark",value:function(){return!1}},{key:"restore",value:function(e){e._curMat=this._savematrix,SaveTransform.POOL[SaveTransform.POOL._length++]=this}}],[{key:"save",value:function(e){var t=e._saveMark;if((t._saveuse&ue.TYPE_TRANSFORM)!==ue.TYPE_TRANSFORM){t._saveuse|=ue.TYPE_TRANSFORM;var i=SaveTransform.POOL,n=i._length>0?i[--i._length]:new SaveTransform;n._savematrix=e._curMat,e._curMat=e._curMat.copyTo(n._matrix);var r=e._save;r[r._length++]=n}}}]),SaveTransform}();de.POOL=ue._createArray();var fe=function(){function SaveTranslate(){_classCallCheck(this,SaveTranslate),this._mat=new f}return _createClass(SaveTranslate,[{key:"isSaveMark",value:function(){return!1}},{key:"restore",value:function(e){this._mat.copyTo(e._curMat),SaveTranslate.POOL[SaveTranslate.POOL._length++]=this}}],[{key:"save",value:function(e){var t=SaveTranslate.POOL,i=t._length>0?t[--t._length]:new SaveTranslate;e._curMat.copyTo(i._mat);var n=e._save;n[n._length++]=i}}]),SaveTranslate}();fe.POOL=ue._createArray();var ve=function(){function BufferStateBase(){_classCallCheck(this,BufferStateBase),this._nativeVertexArrayObject=g.layaGPUInstance.createVertexArray()}return _createClass(BufferStateBase,[{key:"bind",value:function(){BufferStateBase._curBindedBufferState!==this&&(g.layaGPUInstance.bindVertexArray(this._nativeVertexArrayObject),BufferStateBase._curBindedBufferState=this)}},{key:"unBind",value:function(){if(BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";g.layaGPUInstance.bindVertexArray(null),BufferStateBase._curBindedBufferState=null}},{key:"destroy",value:function(){g.layaGPUInstance.deleteVertexArray(this._nativeVertexArrayObject)}},{key:"bindForNative",value:function(){g.instance.bindVertexArray(this._nativeVertexArrayObject),BufferStateBase._curBindedBufferState=this}},{key:"unBindForNative",value:function(){g.instance.bindVertexArray(null),BufferStateBase._curBindedBufferState=null}}]),BufferStateBase}(),pe=function(e){function BufferState2D(){return _classCallCheck(this,BufferState2D),_possibleConstructorReturn(this,_getPrototypeOf(BufferState2D).call(this))}return _inherits(BufferState2D,e),BufferState2D}(ve),ge=function(){function Buffer(){_classCallCheck(this,Buffer),this._byteLength=0,this._glBuffer=g.instance.createBuffer()}return _createClass(Buffer,[{key:"_bindForVAO",value:function(){}},{key:"bind",value:function(){return!1}},{key:"destroy",value:function(){this._glBuffer&&(g.instance.deleteBuffer(this._glBuffer),this._glBuffer=null)}},{key:"bufferUsage",get:function(){return this._bufferUsage}}]),Buffer}(),ye=function RenderInfo(){_classCallCheck(this,RenderInfo)};ye.loopStTm=0,ye.loopCount=0;var me=function(e){function Buffer2D(){var e;return _classCallCheck(this,Buffer2D),(e=_possibleConstructorReturn(this,_getPrototypeOf(Buffer2D).call(this)))._maxsize=0,e._upload=!0,e._uploadSize=0,e._bufferSize=0,e._u8Array=null,e}return _inherits(Buffer2D,e),_createClass(Buffer2D,[{key:"setByteLength",value:function(e){this._byteLength!==e&&(e<=this._bufferSize||this._resizeBuffer(2*e+256,!0),this._byteLength=e)}},{key:"needSize",value:function(e){var t=this._byteLength;if(e){var i=this._byteLength+e;i<=this._bufferSize||this._resizeBuffer(i<<1,!0),this._byteLength=i}return t}},{key:"_bufferData",value:function(){this._maxsize=Math.max(this._maxsize,this._byteLength),ye.loopCount%30==0&&(this._buffer.byteLength>this._maxsize+64&&(this._buffer=this._buffer.slice(0,this._maxsize+64),this._bufferSize=this._buffer.byteLength,this._checkArrayUse()),this._maxsize=this._byteLength),this._uploadSize<this._buffer.byteLength&&(this._uploadSize=this._buffer.byteLength,g.instance.bufferData(this._bufferType,this._uploadSize,this._bufferUsage)),g.instance.bufferSubData(this._bufferType,0,new Uint8Array(this._buffer,0,this._byteLength))}},{key:"_bufferSubData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this._maxsize=Math.max(this._maxsize,this._byteLength),ye.loopCount%30==0&&(this._buffer.byteLength>this._maxsize+64&&(this._buffer=this._buffer.slice(0,this._maxsize+64),this._bufferSize=this._buffer.byteLength,this._checkArrayUse()),this._maxsize=this._byteLength),this._uploadSize<this._buffer.byteLength&&(this._uploadSize=this._buffer.byteLength,g.instance.bufferData(this._bufferType,this._uploadSize,this._bufferUsage)),t||i){var n=this._buffer.slice(t,i);g.instance.bufferSubData(this._bufferType,e,n)}else g.instance.bufferSubData(this._bufferType,e,this._buffer)}},{key:"_checkArrayUse",value:function(){}},{key:"_bind_uploadForVAO",value:function(){return!!this._upload&&(this._upload=!1,this._bindForVAO(),this._bufferData(),!0)}},{key:"_bind_upload",value:function(){return!!this._upload&&(this._upload=!1,this.bind(),this._bufferData(),!0)}},{key:"_bind_subUpload",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return!!this._upload&&(this._upload=!1,this.bind(),this._bufferSubData(e,t,i),!0)}},{key:"_resizeBuffer",value:function(e,t){var i=this._buffer;if(e<=i.byteLength)return this;var n=this._u8Array;if(t&&i&&i.byteLength>0){var r=new ArrayBuffer(e),a=n&&n.buffer==i?n:new Uint8Array(i);(n=this._u8Array=new Uint8Array(r)).set(a,0),i=this._buffer=r}else i=this._buffer=new ArrayBuffer(e),this._u8Array=null;return this._checkArrayUse(),this._upload=!0,this._bufferSize=i.byteLength,this}},{key:"append",value:function(e){var t,i;this._upload=!0,t=e.byteLength,e instanceof Uint8Array?(this._resizeBuffer(this._byteLength+t,!0),i=new Uint8Array(this._buffer,this._byteLength)):e instanceof Uint16Array?(this._resizeBuffer(this._byteLength+t,!0),i=new Uint16Array(this._buffer,this._byteLength)):e instanceof Float32Array&&(this._resizeBuffer(this._byteLength+t,!0),i=new Float32Array(this._buffer,this._byteLength)),i.set(e,0),this._byteLength+=t,this._checkArrayUse()}},{key:"appendU16Array",value:function(e,t){this._resizeBuffer(this._byteLength+2*t,!0);var i=new Uint16Array(this._buffer,this._byteLength,t);if(6==t)i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5];else if(t>=100)i.set(new Uint16Array(e.buffer,0,t));else for(var n=0;n<t;n++)i[n]=e[n];this._byteLength+=2*t,this._checkArrayUse()}},{key:"appendEx",value:function(e,t){var i;this._upload=!0,i=e.byteLength,this._resizeBuffer(this._byteLength+i,!0),new t(this._buffer,this._byteLength).set(e,0),this._byteLength+=i,this._checkArrayUse()}},{key:"appendEx2",value:function(e,t,i){var n,r,a,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;for(this._upload=!0,n=i*s,this._resizeBuffer(this._byteLength+n,!0),r=new t(this._buffer,this._byteLength),a=0;a<i;a++)r[a]=e[a];this._byteLength+=n,this._checkArrayUse()}},{key:"getBuffer",value:function(){return this._buffer}},{key:"setNeedUpload",value:function(){this._upload=!0}},{key:"getNeedUpload",value:function(){return this._upload}},{key:"upload",value:function(){var e=g.instance,t=this._bind_upload();return e.bindBuffer(this._bufferType,null),this._bufferType==e.ARRAY_BUFFER&&(ge._bindedVertexBuffer=null),this._bufferType==e.ELEMENT_ARRAY_BUFFER&&(ge._bindedIndexBuffer=null),P.activeShader=null,t}},{key:"subUpload",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0],arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var e=g.instance,t=this._bind_subUpload();return e.bindBuffer(this._bufferType,null),this._bufferType==e.ARRAY_BUFFER&&(ge._bindedVertexBuffer=null),this._bufferType==e.ELEMENT_ARRAY_BUFFER&&(ge._bindedIndexBuffer=null),P.activeShader=null,t}},{key:"_disposeResource",value:function(){this._upload=!0,this._uploadSize=0}},{key:"clear",value:function(){this._byteLength=0,this._upload=!0}},{key:"bufferLength",get:function(){return this._buffer.byteLength}},{key:"byteLength",set:function(e){this.setByteLength(e)}}],[{key:"__int__",value:function(e){}}]),Buffer2D}(ge);me.FLOAT32=4,me.SHORT=2;var Te=function(e){function IndexBuffer2D(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:35044;return _classCallCheck(this,IndexBuffer2D),(e=_possibleConstructorReturn(this,_getPrototypeOf(IndexBuffer2D).call(this)))._bufferUsage=t,e._bufferType=g.instance.ELEMENT_ARRAY_BUFFER,e._buffer=new ArrayBuffer(8),e}return _inherits(IndexBuffer2D,e),_createClass(IndexBuffer2D,[{key:"_checkArrayUse",value:function(){this._uint16Array&&(this._uint16Array=new Uint16Array(this._buffer))}},{key:"getUint16Array",value:function(){return this._uint16Array||(this._uint16Array=new Uint16Array(this._buffer))}},{key:"_bindForVAO",value:function(){var e=g.instance;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._glBuffer)}},{key:"bind",value:function(){if(ge._bindedIndexBuffer!==this._glBuffer){var e=g.instance;return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._glBuffer),ge._bindedIndexBuffer=this._glBuffer,!0}return!1}},{key:"destory",value:function(){this._uint16Array=null,this._buffer=null}},{key:"disposeResource",value:function(){this._disposeResource()}}]),IndexBuffer2D}(me);Te.create=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:35044;return new Te(e)};var Ce=function(e){function VertexBuffer2D(e,t){var i;return _classCallCheck(this,VertexBuffer2D),(i=_possibleConstructorReturn(this,_getPrototypeOf(VertexBuffer2D).call(this)))._vertexStride=e,i._bufferUsage=t,i._bufferType=g.instance.ARRAY_BUFFER,i._buffer=new ArrayBuffer(8),i._floatArray32=new Float32Array(i._buffer),i._uint32Array=new Uint32Array(i._buffer),i}return _inherits(VertexBuffer2D,e),_createClass(VertexBuffer2D,[{key:"getFloat32Array",value:function(){return this._floatArray32}},{key:"appendArray",value:function(e){var t=this._byteLength>>2;this.setByteLength(this._byteLength+4*e.length),this.getFloat32Array().set(e,t),this._upload=!0}},{key:"_checkArrayUse",value:function(){this._floatArray32&&(this._floatArray32=new Float32Array(this._buffer)),this._uint32Array&&(this._uint32Array=new Uint32Array(this._buffer))}},{key:"deleteBuffer",value:function(){_get(_getPrototypeOf(VertexBuffer2D.prototype),"_disposeResource",this).call(this)}},{key:"_bindForVAO",value:function(){var e=g.instance;e.bindBuffer(e.ARRAY_BUFFER,this._glBuffer)}},{key:"bind",value:function(){if(ge._bindedVertexBuffer!==this._glBuffer){var e=g.instance;return e.bindBuffer(e.ARRAY_BUFFER,this._glBuffer),ge._bindedVertexBuffer=this._glBuffer,!0}return!1}},{key:"destroy",value:function(){_get(_getPrototypeOf(VertexBuffer2D.prototype),"destroy",this).call(this),this._byteLength=0,this._upload=!0,this._buffer=null,this._floatArray32=null}},{key:"vertexStride",get:function(){return this._vertexStride}}]),VertexBuffer2D}(me);Ce.create=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:35048;return new Ce(e,t)};var xe=function(){function Mesh2D(e,i,n){_classCallCheck(this,Mesh2D),this._stride=0,this.vertNum=0,this.indexNum=0,this._applied=!1,this._quadNum=0,this.canReuse=!1,this._stride=e,this._vb=new Ce(e,g.instance.DYNAMIC_DRAW),i?this._vb._resizeBuffer(i,!1):t.webGL2D_MeshAllocMaxMem&&this._vb._resizeBuffer(65536*e,!1),this._ib=new Te,n&&this._ib._resizeBuffer(n,!1)}return _createClass(Mesh2D,[{key:"cloneWithNewVB",value:function(){var e=new Mesh2D(this._stride,0,0);return e._ib=this._ib,e._quadNum=this._quadNum,e._attribInfo=this._attribInfo,e}},{key:"cloneWithNewVBIB",value:function(){var e=new Mesh2D(this._stride,0,0);return e._attribInfo=this._attribInfo,e}},{key:"getVBW",value:function(){return this._vb.setNeedUpload(),this._vb}},{key:"getVBR",value:function(){return this._vb}},{key:"getIBR",value:function(){return this._ib}},{key:"getIBW",value:function(){return this._ib.setNeedUpload(),this._ib}},{key:"createQuadIB",value:function(e){this._quadNum=e,this._ib._resizeBuffer(6*e*2,!1),this._ib.byteLength=this._ib.bufferLength;for(var t=this._ib.getUint16Array(),i=0,n=0,r=0;r<e;r++)t[i++]=n,t[i++]=n+2,t[i++]=n+1,t[i++]=n,t[i++]=n+3,t[i++]=n+2,n+=4;this._ib.setNeedUpload()}},{key:"setAttributes",value:function(e){if(this._attribInfo=e,this._attribInfo.length%3!=0)throw"Mesh2D setAttributes error!"}},{key:"configVAO",value:function(e){if(!this._applied){this._applied=!0,this._vao||(this._vao=new pe),this._vao.bind(),this._vb._bindForVAO(),this._ib.setNeedUpload(),this._ib._bind_uploadForVAO();for(var t=this._attribInfo.length/3,i=0,n=0;n<t;n++){var r=this._attribInfo[i+1],a=this._attribInfo[i],s=this._attribInfo[i+2];e.enableVertexAttribArray(n),e.vertexAttribPointer(n,r,a,!1,this._stride,s),i+=3}this._vao.unBind()}}},{key:"useMesh",value:function(e){this._applied||this.configVAO(e),this._vao.bind(),this._vb.bind(),this._ib._bind_upload()||this._ib.bind(),this._vb._bind_upload()||this._vb.bind()}},{key:"getEleNum",value:function(){return this._ib.getBuffer().byteLength/2}},{key:"releaseMesh",value:function(){}},{key:"destroy",value:function(){}},{key:"clearVB",value:function(){this._vb.clear()}}]),Mesh2D}();xe._gvaoid=0;var ke=function(e){function MeshQuadTexture(){var e;return _classCallCheck(this,MeshQuadTexture),(e=_possibleConstructorReturn(this,_getPrototypeOf(MeshQuadTexture).call(this,MeshQuadTexture.const_stride,4,4))).canReuse=!0,e.setAttributes(MeshQuadTexture._fixattriInfo),MeshQuadTexture._fixib?(e._ib=MeshQuadTexture._fixib,e._quadNum=MeshQuadTexture._maxIB):(e.createQuadIB(MeshQuadTexture._maxIB),MeshQuadTexture._fixib=e._ib),e}return _inherits(MeshQuadTexture,e),_createClass(MeshQuadTexture,[{key:"releaseMesh",value:function(){this._vb.setByteLength(0),this.vertNum=0,this.indexNum=0,MeshQuadTexture._POOL.push(this)}},{key:"destroy",value:function(){this._vb.destroy(),this._vb.deleteBuffer()}},{key:"addQuad",value:function(e,t,i,n){var r=this._vb,a=r._byteLength>>2;r.setByteLength(a+MeshQuadTexture.const_stride<<2);var s=r._floatArray32||r.getFloat32Array(),o=r._uint32Array,l=a,h=n?255:0;s[l++]=e[0],s[l++]=e[1],s[l++]=t[0],s[l++]=t[1],o[l++]=i,o[l++]=h,s[l++]=e[2],s[l++]=e[3],s[l++]=t[2],s[l++]=t[3],o[l++]=i,o[l++]=h,s[l++]=e[4],s[l++]=e[5],s[l++]=t[4],s[l++]=t[5],o[l++]=i,o[l++]=h,s[l++]=e[6],s[l++]=e[7],s[l++]=t[6],s[l++]=t[7],o[l++]=i,o[l++]=h,r._upload=!0}}],[{key:"__int__",value:function(){MeshQuadTexture._fixattriInfo=[5126,4,0,5121,4,16,5121,4,20]}},{key:"getAMesh",value:function(e){var t=null;return t=MeshQuadTexture._POOL.length?MeshQuadTexture._POOL.pop():new MeshQuadTexture,e&&t._vb._resizeBuffer(65536*MeshQuadTexture.const_stride,!1),t}}]),MeshQuadTexture}(xe);ke.const_stride=24,ke._maxIB=16384,ke._POOL=[];var Se=function(e){function MeshTexture(){var e;return _classCallCheck(this,MeshTexture),(e=_possibleConstructorReturn(this,_getPrototypeOf(MeshTexture).call(this,MeshTexture.const_stride,4,4))).canReuse=!0,e.setAttributes(MeshTexture._fixattriInfo),e}return _inherits(MeshTexture,e),_createClass(MeshTexture,[{key:"addData",value:function(e,t,i,n,r){var a=this._vb,s=this._ib,o=e.length>>1,l=a.needSize(o*MeshTexture.const_stride)>>2,h=a._floatArray32||a.getFloat32Array(),u=a._uint32Array,c=0,_=n.a,d=n.b,f=n.c,v=n.d,p=n.tx,g=n.ty,y=0;for(y=0;y<o;y++){var m=e[c],T=e[c+1];h[l]=m*_+T*f+p,h[l+1]=m*d+T*v+g,h[l+2]=t[c],h[l+3]=t[c+1],u[l+4]=r,u[l+5]=255,l+=6,c+=2}a.setNeedUpload();var C=this.vertNum,x=i.length,k=s.needSize(i.byteLength),S=s.getUint16Array(),R=k>>1;if(C>0){var b=R+x,E=0;for(y=R;y<b;y++,E++)S[y]=i[E]+C}else S.set(i,R);s.setNeedUpload(),this.vertNum+=o,this.indexNum+=i.length}},{key:"releaseMesh",value:function(){this._vb.setByteLength(0),this._ib.setByteLength(0),this.vertNum=0,this.indexNum=0,MeshTexture._POOL.push(this)}},{key:"destroy",value:function(){this._ib.destroy(),this._vb.destroy(),this._ib.disposeResource(),this._vb.deleteBuffer()}}],[{key:"__init__",value:function(){MeshTexture._fixattriInfo=[5126,4,0,5121,4,16,5121,4,20]}},{key:"getAMesh",value:function(e){var t;return t=MeshTexture._POOL.length?MeshTexture._POOL.pop():new MeshTexture,e&&t._vb._resizeBuffer(65536*MeshTexture.const_stride,!1),t}}]),MeshTexture}(xe);Se.const_stride=24,Se._POOL=[];var Re=function(e){function MeshVG(){var e;return _classCallCheck(this,MeshVG),(e=_possibleConstructorReturn(this,_getPrototypeOf(MeshVG).call(this,MeshVG.const_stride,4,4))).canReuse=!0,e.setAttributes(MeshVG._fixattriInfo),e}return _inherits(MeshVG,e),_createClass(MeshVG,[{key:"addVertAndIBToMesh",value:function(e,t,i,n){for(var r=this._vb.needSize(t.length/2*MeshVG.const_stride)>>2,a=this._vb._floatArray32||this._vb.getFloat32Array(),s=this._vb._uint32Array,o=0,l=t.length/2,h=0;h<l;h++)a[r++]=t[o],a[r++]=t[o+1],o+=2,s[r++]=i;this._vb.setNeedUpload(),this._ib.append(new Uint16Array(n)),this._ib.setNeedUpload(),this.vertNum+=l,this.indexNum+=n.length}},{key:"releaseMesh",value:function(){this._vb.setByteLength(0),this._ib.setByteLength(0),this.vertNum=0,this.indexNum=0,MeshVG._POOL.push(this)}},{key:"destroy",value:function(){this._ib.destroy(),this._vb.destroy(),this._ib.disposeResource(),this._vb.deleteBuffer()}}],[{key:"__init__",value:function(){MeshVG._fixattriInfo=[5126,2,0,5121,4,8]}},{key:"getAMesh",value:function(e){var t;return t=MeshVG._POOL.length?MeshVG._POOL.pop():new MeshVG,e&&t._vb._resizeBuffer(65536*MeshVG.const_stride,!1),t}}]),MeshVG}(xe);Re.const_stride=12,Re._POOL=[];var be=function(){function WebGLCacheAsNormalCanvas(e,t){_classCallCheck(this,WebGLCacheAsNormalCanvas),this.submitStartPos=0,this.submitEndPos=0,this.touches=[],this.submits=[],this.sprite=null,this.meshlist=[],this.cachedClipInfo=new f,this.oldTx=0,this.oldTy=0,this.invMat=new f,this.context=e,this.sprite=t,e._globalClipMatrix.copyTo(this.cachedClipInfo)}return _createClass(WebGLCacheAsNormalCanvas,[{key:"startRec",value:function(){var e=this.context;e._charSubmitCache&&e._charSubmitCache._enable&&(e._charSubmitCache.enable(!1,e),e._charSubmitCache.enable(!0,e)),e._incache=!0,this.touches.length=0,e.touches=this.touches,e._globalClipMatrix.copyTo(this.cachedClipInfo),this.submits.length=0,this.submitStartPos=e._submits._length;for(var t=0,i=this.meshlist.length;t<i;t++){var n=this.meshlist[t];n.canReuse?n.releaseMesh():n.destroy()}this.meshlist.length=0,this._mesh=ke.getAMesh(!1),this._pathMesh=Re.getAMesh(!1),this._triangleMesh=Se.getAMesh(!1),this.meshlist.push(this._mesh),this.meshlist.push(this._pathMesh),this.meshlist.push(this._triangleMesh),e._curSubmit=he.RENDERBASE,this._oldMesh=e._mesh,this._oldPathMesh=e._pathMesh,this._oldTriMesh=e._triangleMesh,this._oldMeshList=e.meshlist,e._mesh=this._mesh,e._pathMesh=this._pathMesh,e._triangleMesh=this._triangleMesh,e.meshlist=this.meshlist,this.oldTx=e._curMat.tx,this.oldTy=e._curMat.ty,e._curMat.tx=0,e._curMat.ty=0,e._curMat.copyTo(this.invMat),this.invMat.invert()}},{key:"endRec",value:function(){var e=this.context;e._charSubmitCache&&e._charSubmitCache._enable&&(e._charSubmitCache.enable(!1,e),e._charSubmitCache.enable(!0,e));var t=e._submits;this.submitEndPos=t._length;for(var i=this.submitEndPos-this.submitStartPos,n=0;n<i;n++)this.submits.push(t[this.submitStartPos+n]);t._length-=i,e._mesh=this._oldMesh,e._pathMesh=this._oldPathMesh,e._triangleMesh=this._oldTriMesh,e.meshlist=this._oldMeshList,e._curSubmit=he.RENDERBASE,e._curMat.tx=this.oldTx,e._curMat.ty=this.oldTy,e.touches=null,e._incache=!1}},{key:"isCacheValid",value:function(){var e=this.context._globalClipMatrix;return e.a==this.cachedClipInfo.a&&e.b==this.cachedClipInfo.b&&e.c==this.cachedClipInfo.c&&e.d==this.cachedClipInfo.d&&e.tx==this.cachedClipInfo.tx&&e.ty==this.cachedClipInfo.ty}},{key:"flushsubmit",value:function(){var e=he.RENDERBASE;this.submits.forEach((function(t){t!=he.RENDERBASE&&(he.preRender=e,e=t,t.renderSubmit())}))}},{key:"releaseMem",value:function(){}}]),WebGLCacheAsNormalCanvas}();be.matI=new f;var Ee=function(){function Shader2D(){_classCallCheck(this,Shader2D),this.ALPHA=1,this.defines=new U,this.shaderType=0,this.fillStyle=se.DEFAULT,this.strokeStyle=se.DEFAULT}return _createClass(Shader2D,[{key:"destroy",value:function(){this.defines=null,this.filters=null}}],[{key:"__init__",value:function(){V.preCompile2D(0,U.TEXTURE2D,"/*\r\n\ttexture和fillrect使用的。\r\n*/\r\nattribute vec4 posuv;\r\nattribute vec4 attribColor;\r\nattribute vec4 attribFlags;\r\n//attribute vec4 clipDir;\r\n//attribute vec2 clipRect;\r\nuniform vec4 clipMatDir;\r\nuniform vec2 clipMatPos;\t\t// 这个是全局的，不用再应用矩阵了。\r\nvarying vec2 cliped;\r\nuniform vec2 size;\r\nuniform vec2 clipOff;\t\t\t// 使用要把clip偏移。cacheas normal用. 只用了[0]\r\n#ifdef WORLDMAT\r\n\tuniform mat4 mmat;\r\n#endif\r\n#ifdef MVP3D\r\n\tuniform mat4 u_MvpMatrix;\r\n#endif\r\nvarying vec4 v_texcoordAlpha;\r\nvarying vec4 v_color;\r\nvarying float v_useTex;\r\n\r\nvoid main() {\r\n\r\n\tvec4 pos = vec4(posuv.xy,0.,1.);\r\n#ifdef WORLDMAT\r\n\tpos=mmat*pos;\r\n#endif\r\n\tvec4 pos1  =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,0.,1.0);\r\n#ifdef MVP3D\r\n\tgl_Position=u_MvpMatrix*pos1;\r\n#else\r\n\tgl_Position=pos1;\r\n#endif\r\n\tv_texcoordAlpha.xy = posuv.zw;\r\n\t//v_texcoordAlpha.z = attribColor.a/255.0;\r\n\tv_color = attribColor/255.0;\r\n\tv_color.xyz*=v_color.w;//反正后面也要预乘\r\n\t\r\n\tv_useTex = attribFlags.r/255.0;\r\n\tfloat clipw = length(clipMatDir.xy);\r\n\tfloat cliph = length(clipMatDir.zw);\r\n\t\r\n\tvec2 clpos = clipMatPos.xy;\r\n\t#ifdef WORLDMAT\r\n\t\t// 如果有mmat，需要修改clipMatPos,因为 这是cacheas normal （如果不是就错了）， clipMatPos被去掉了偏移\r\n\t\tif(clipOff[0]>0.0){\r\n\t\t\tclpos.x+=mmat[3].x;\t//tx\t最简单处理\r\n\t\t\tclpos.y+=mmat[3].y;\t//ty\r\n\t\t}\r\n\t#endif\r\n\tvec2 clippos = pos.xy - clpos;\t//pos已经应用矩阵了，为了减的有意义，clip的位置也要缩放\r\n\tif(clipw>20000. && cliph>20000.)\r\n\t\tcliped = vec2(0.5,0.5);\r\n\telse {\r\n\t\t//转成0到1之间。/clipw/clipw 表示clippos与normalize之后的clip朝向点积之后，再除以clipw\r\n\t\tcliped=vec2( dot(clippos,clipMatDir.xy)/clipw/clipw, dot(clippos,clipMatDir.zw)/cliph/cliph);\r\n\t}\r\n\r\n}","/*\r\n\ttexture和fillrect使用的。\r\n*/\r\n#ifdef GL_FRAGMENT_PRECISION_HIGH\r\nprecision highp float;\r\n#else\r\nprecision mediump float;\r\n#endif\r\n\r\nvarying vec4 v_texcoordAlpha;\r\nvarying vec4 v_color;\r\nvarying float v_useTex;\r\nuniform sampler2D texture;\r\nvarying vec2 cliped;\r\n\r\n#ifdef BLUR_FILTER\r\nuniform vec4 strength_sig2_2sig2_gauss1;\r\nuniform vec2 blurInfo;\r\n\r\n#define PI 3.141593\r\n\r\nfloat getGaussian(float x, float y){\r\n    return strength_sig2_2sig2_gauss1.w*exp(-(x*x+y*y)/strength_sig2_2sig2_gauss1.z);\r\n}\r\n\r\nvec4 blur(){\r\n    const float blurw = 9.0;\r\n    vec4 vec4Color = vec4(0.0,0.0,0.0,0.0);\r\n    vec2 halfsz=vec2(blurw,blurw)/2.0/blurInfo;    \r\n    vec2 startpos=v_texcoordAlpha.xy-halfsz;\r\n    vec2 ctexcoord = startpos;\r\n    vec2 step = 1.0/blurInfo;  //每个像素      \r\n    \r\n    for(float y = 0.0;y<=blurw; ++y){\r\n        ctexcoord.x=startpos.x;\r\n        for(float x = 0.0;x<=blurw; ++x){\r\n            //TODO 纹理坐标的固定偏移应该在vs中处理\r\n            vec4Color += texture2D(texture, ctexcoord)*getGaussian(x-blurw/2.0,y-blurw/2.0);\r\n            ctexcoord.x+=step.x;\r\n        }\r\n        ctexcoord.y+=step.y;\r\n    }\r\n    return vec4Color;\r\n}\r\n#endif\r\n\r\n#ifdef COLOR_FILTER\r\nuniform vec4 colorAlpha;\r\nuniform mat4 colorMat;\r\n#endif\r\n\r\n#ifdef GLOW_FILTER\r\nuniform vec4 u_color;\r\nuniform vec4 u_blurInfo1;\r\nuniform vec4 u_blurInfo2;\r\n#endif\r\n\r\n#ifdef COLOR_ADD\r\nuniform vec4 colorAdd;\r\n#endif\r\n\r\n#ifdef FILLTEXTURE\t\r\nuniform vec4 u_TexRange;//startu,startv,urange, vrange\r\n#endif\r\nvoid main() {\r\n\tif(cliped.x<0.) discard;\r\n\tif(cliped.x>1.) discard;\r\n\tif(cliped.y<0.) discard;\r\n\tif(cliped.y>1.) discard;\r\n\t\r\n#ifdef FILLTEXTURE\t\r\n   vec4 color= texture2D(texture, fract(v_texcoordAlpha.xy)*u_TexRange.zw + u_TexRange.xy);\r\n#else\r\n   vec4 color= texture2D(texture, v_texcoordAlpha.xy);\r\n#endif\r\n\r\n   if(v_useTex<=0.)color = vec4(1.,1.,1.,1.);\r\n   color.a*=v_color.w;\r\n   //color.rgb*=v_color.w;\r\n   color.rgb*=v_color.rgb;\r\n   gl_FragColor=color;\r\n   \r\n   #ifdef COLOR_ADD\r\n\tgl_FragColor = vec4(colorAdd.rgb,colorAdd.a*gl_FragColor.a);\r\n\tgl_FragColor.xyz *= colorAdd.a;\r\n   #endif\r\n   \r\n   #ifdef BLUR_FILTER\r\n\tgl_FragColor =   blur();\r\n\tgl_FragColor.w*=v_color.w;   \r\n   #endif\r\n   \r\n   #ifdef COLOR_FILTER\r\n\tmat4 alphaMat =colorMat;\r\n\r\n\talphaMat[0][3] *= gl_FragColor.a;\r\n\talphaMat[1][3] *= gl_FragColor.a;\r\n\talphaMat[2][3] *= gl_FragColor.a;\r\n\r\n\tgl_FragColor = gl_FragColor * alphaMat;\r\n\tgl_FragColor += colorAlpha/255.0*gl_FragColor.a;\r\n   #endif\r\n   \r\n   #ifdef GLOW_FILTER\r\n\tconst float c_IterationTime = 10.0;\r\n\tfloat floatIterationTotalTime = c_IterationTime * c_IterationTime;\r\n\tvec4 vec4Color = vec4(0.0,0.0,0.0,0.0);\r\n\tvec2 vec2FilterDir = vec2(-(u_blurInfo1.z)/u_blurInfo2.x,-(u_blurInfo1.w)/u_blurInfo2.y);\r\n\tvec2 vec2FilterOff = vec2(u_blurInfo1.x/u_blurInfo2.x/c_IterationTime * 2.0,u_blurInfo1.y/u_blurInfo2.y/c_IterationTime * 2.0);\r\n\tfloat maxNum = u_blurInfo1.x * u_blurInfo1.y;\r\n\tvec2 vec2Off = vec2(0.0,0.0);\r\n\tfloat floatOff = c_IterationTime/2.0;\r\n\tfor(float i = 0.0;i<=c_IterationTime; ++i){\r\n\t\tfor(float j = 0.0;j<=c_IterationTime; ++j){\r\n\t\t\tvec2Off = vec2(vec2FilterOff.x * (i - floatOff),vec2FilterOff.y * (j - floatOff));\r\n\t\t\tvec4Color += texture2D(texture, v_texcoordAlpha.xy + vec2FilterDir + vec2Off)/floatIterationTotalTime;\r\n\t\t}\r\n\t}\r\n\tgl_FragColor = vec4(u_color.rgb,vec4Color.a * u_blurInfo2.z);\r\n\tgl_FragColor.rgb *= gl_FragColor.a;   \r\n   #endif\r\n   \r\n}",null),V.preCompile2D(0,U.PRIMITIVE,"attribute vec4 position;\r\nattribute vec4 attribColor;\r\n//attribute vec4 clipDir;\r\n//attribute vec2 clipRect;\r\nuniform vec4 clipMatDir;\r\nuniform vec2 clipMatPos;\r\n#ifdef WORLDMAT\r\n\tuniform mat4 mmat;\r\n#endif\r\nuniform mat4 u_mmat2;\r\n//uniform vec2 u_pos;\r\nuniform vec2 size;\r\nvarying vec4 color;\r\n//vec4 dirxy=vec4(0.9,0.1, -0.1,0.9);\r\n//vec4 clip=vec4(100.,30.,300.,600.);\r\nvarying vec2 cliped;\r\nvoid main(){\r\n\t\r\n#ifdef WORLDMAT\r\n\tvec4 pos=mmat*vec4(position.xy,0.,1.);\r\n\tgl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\r\n#else\r\n\tgl_Position =vec4((position.x/size.x-0.5)*2.0,(0.5-position.y/size.y)*2.0,position.z,1.0);\r\n#endif\t\r\n\tfloat clipw = length(clipMatDir.xy);\r\n\tfloat cliph = length(clipMatDir.zw);\r\n\tvec2 clippos = position.xy - clipMatPos.xy;\t//pos已经应用矩阵了，为了减的有意义，clip的位置也要缩放\r\n\tif(clipw>20000. && cliph>20000.)\r\n\t\tcliped = vec2(0.5,0.5);\r\n\telse {\r\n\t\t//clipdir是带缩放的方向，由于上面clippos是在缩放后的空间计算的，所以需要把方向先normalize一下\r\n\t\tcliped=vec2( dot(clippos,clipMatDir.xy)/clipw/clipw, dot(clippos,clipMatDir.zw)/cliph/cliph);\r\n\t}\r\n  //pos2d.x = dot(clippos,dirx);\r\n  color=attribColor/255.;\r\n}","precision mediump float;\r\n//precision mediump float;\r\nvarying vec4 color;\r\n//uniform float alpha;\r\nvarying vec2 cliped;\r\nvoid main(){\r\n\t//vec4 a=vec4(color.r, color.g, color.b, 1);\r\n\t//a.a*=alpha;\r\n    gl_FragColor= color;// vec4(color.r, color.g, color.b, alpha);\r\n\tgl_FragColor.rgb*=color.a;\r\n\tif(cliped.x<0.) discard;\r\n\tif(cliped.x>1.) discard;\r\n\tif(cliped.y<0.) discard;\r\n\tif(cliped.y>1.) discard;\r\n}",null),V.preCompile2D(0,U.SKINMESH,"attribute vec2 position;\r\nattribute vec2 texcoord;\r\nattribute vec4 color;\r\nuniform vec2 size;\r\nuniform float offsetX;\r\nuniform float offsetY;\r\nuniform mat4 mmat;\r\nuniform mat4 u_mmat2;\r\nvarying vec2 v_texcoord;\r\nvarying vec4 v_color;\r\nvoid main() {\r\n  vec4 pos=mmat*u_mmat2*vec4(offsetX+position.x,offsetY+position.y,0,1 );\r\n  gl_Position = vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\r\n  v_color = color;\r\n  v_color.rgb *= v_color.a;\r\n  v_texcoord = texcoord;  \r\n}","precision mediump float;\r\nvarying vec2 v_texcoord;\r\nvarying vec4 v_color;\r\nuniform sampler2D texture;\r\nuniform float alpha;\r\nvoid main() {\r\n\tvec4 t_color = texture2D(texture, v_texcoord);\r\n\tgl_FragColor = t_color.rgba * v_color;\r\n\tgl_FragColor *= alpha;\r\n}",null)}}]),Shader2D}(),Me=function(){function SkinMeshBuffer(){_classCallCheck(this,SkinMeshBuffer);var e=g.instance;this.ib=Te.create(e.DYNAMIC_DRAW),this.vb=Ce.create(8)}return _createClass(SkinMeshBuffer,[{key:"addSkinMesh",value:function(e){e.getData2(this.vb,this.ib,this.vb._byteLength/32)}},{key:"reset",value:function(){this.vb.clear(),this.ib.clear()}}],[{key:"getInstance",value:function(){return SkinMeshBuffer.instance=SkinMeshBuffer.instance||new SkinMeshBuffer}}]),SkinMeshBuffer}(),Ae=function(){function BasePoly(){_classCallCheck(this,BasePoly)}return _createClass(BasePoly,null,[{key:"createLine2",value:function(e,t,i,n,r,a){if(e.length<4)return null;var s=BasePoly.tempData.length>e.length+2?BasePoly.tempData:new Array(e.length+2);s[0]=e[0],s[1]=e[1];var o=2,l=0,h=e.length;for(l=2;l<h;l+=2)Math.abs(e[l]-e[l-2])+Math.abs(e[l+1]-e[l-1])>.01&&(s[o++]=e[l],s[o++]=e[l+1]);a&&Math.abs(e[0]-s[o-2])+Math.abs(e[1]-s[o-1])>.01&&(s[o++]=e[0],s[o++]=e[1]);var u=r;h=o/2;var c,_,d,f,v,p,g,y,m,T,C,x,k,S,R,b,E,M,A,w,L=i/2;for(d=s[0],f=s[1],T=d-(v=s[2]),m=(m=-(f-(p=s[3])))/(w=Math.sqrt(m*m+T*T))*L,T=T/w*L,u.push(d-m,f-T,d+m,f+T),l=1;l<h-1;l++)d=s[2*(l-1)],f=s[2*(l-1)+1],v=s[2*l],p=s[2*l+1],g=s[2*(l+1)],y=s[2*(l+1)+1],T=d-v,x=v-g,R=(-(m=(m=-(f-p))/(w=Math.sqrt(m*m+T*T))*L)+d)*(-(T=T/w*L)+p)-(-m+v)*(-T+f),M=(-(C=(C=-(p-y))/(w=Math.sqrt(C*C+x*x))*L)+g)*(-(x=x/w*L)+p)-(-C+v)*(-x+y),A=(k=-T+f-(-T+p))*(E=-C+v-(-C+g))-(b=-x+y-(-x+p))*(S=-m+v-(-m+d)),Math.abs(A)<.1?(A+=10.1,u.push(v-m,p-T,v+m,p+T)):(c=(S*M-E*R)/A,_=(b*R-k*M)/A,u.push(c,_,v-(c-v),p-(_-p)));for(d=s[o-4],f=s[o-3],T=d-(v=s[o-2]),m=(m=-(f-(p=s[o-1])))/(w=Math.sqrt(m*m+T*T))*L,T=T/w*L,u.push(v-m,p-T,v+m,p+T),l=1;l<h;l++)t.push(n+2*(l-1),n+2*(l-1)+1,n+2*l+1,n+2*l+1,n+2*l,n+2*(l-1));return u}},{key:"createLineTriangle",value:function(e,t,i,n,r,a,s){var o=e.slice(),l=o.length,h=o[0],u=o[1],c=o[2],_=(o[2],0),d=0,f=0,v=0,p=l/2;if(!(p<=1)&&2!=p){for(var g=new Array(4*p),y=0,m=0,T=0;T<p-1;T++)h=o[m++],u=o[m++],c=o[m++],v=o[m++]-u,0!=(f=c-h)&&0!=v&&(_=Math.sqrt(f*f+v*v))>.001&&(g[d=4*y]=h,g[d+1]=u,g[d+2]=f/_,g[d+3]=v/_,y++);for(n?(h=o[l-2],u=o[l-1],c=o[0],v=o[1]-u,0!=(f=c-h)&&0!=v&&(_=Math.sqrt(f*f+v*v))>.001&&(g[d=4*y]=h,g[d+1]=u,g[d+2]=f/_,g[d+3]=v/_,y++)):(g[d=4*y]=h,g[d+1]=u,g[d+2]=f/_,g[d+3]=v/_,y++),m=0,T=0;T<p;T++)h=o[m],u=o[m+1],c=o[m+2],o[m+3]}}}]),BasePoly}();Ae.tempData=new Array(256);var we=function EarcutNode(e,t,i){_classCallCheck(this,EarcutNode),this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1},Le=function(){function Earcut(){_classCallCheck(this,Earcut)}return _createClass(Earcut,null,[{key:"earcut",value:function(e,t,i){i=i||2;var n,r,a,s,o,l,h,u=t&&t.length,c=u?t[0]*i:e.length,_=Earcut.linkedList(e,0,c,i,!0),d=[];if(!_)return d;if(u&&(_=Earcut.eliminateHoles(e,t,_,i)),e.length>80*i){n=a=e[0],r=s=e[1];for(var f=i;f<c;f+=i)(o=e[f])<n&&(n=o),(l=e[f+1])<r&&(r=l),o>a&&(a=o),l>s&&(s=l);h=0!==(h=Math.max(a-n,s-r))?1/h:0}return Earcut.earcutLinked(_,d,i,n,r,h),d}},{key:"linkedList",value:function(e,t,i,n,r){var a,s;if(r===Earcut.signedArea(e,t,i,n)>0)for(a=t;a<i;a+=n)s=Earcut.insertNode(a,e[a],e[a+1],s);else for(a=i-n;a>=t;a-=n)s=Earcut.insertNode(a,e[a],e[a+1],s);return s&&Earcut.equals(s,s.next)&&(Earcut.removeNode(s),s=s.next),s}},{key:"filterPoints",value:function(e,t){if(!e)return e;t||(t=e);var i,n=e;do{if(i=!1,n.steiner||!Earcut.equals(n,n.next)&&0!==Earcut.area(n.prev,n,n.next))n=n.next;else{if(Earcut.removeNode(n),(n=t=n.prev)===n.next)break;i=!0}}while(i||n!==t);return t}},{key:"earcutLinked",value:function(e,t,i,n,r,a){var s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;if(e){!s&&a&&Earcut.indexCurve(e,n,r,a);for(var o,l,h=e;e.prev!==e.next;)if(o=e.prev,l=e.next,a?Earcut.isEarHashed(e,n,r,a):Earcut.isEar(e))t.push(o.i/i),t.push(e.i/i),t.push(l.i/i),Earcut.removeNode(e),e=l.next,h=l.next;else if((e=l)===h){s?1===s?(e=Earcut.cureLocalIntersections(e,t,i),Earcut.earcutLinked(e,t,i,n,r,a,2)):2===s&&Earcut.splitEarcut(e,t,i,n,r,a):Earcut.earcutLinked(Earcut.filterPoints(e,null),t,i,n,r,a,1);break}}}},{key:"isEar",value:function(e){var t=e.prev,i=e,n=e.next;if(Earcut.area(t,i,n)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(Earcut.pointInTriangle(t.x,t.y,i.x,i.y,n.x,n.y,r.x,r.y)&&Earcut.area(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}},{key:"isEarHashed",value:function(e,t,i,n){var r=e.prev,a=e,s=e.next;if(Earcut.area(r,a,s)>=0)return!1;for(var o=r.x<a.x?r.x<s.x?r.x:s.x:a.x<s.x?a.x:s.x,l=r.y<a.y?r.y<s.y?r.y:s.y:a.y<s.y?a.y:s.y,h=r.x>a.x?r.x>s.x?r.x:s.x:a.x>s.x?a.x:s.x,u=r.y>a.y?r.y>s.y?r.y:s.y:a.y>s.y?a.y:s.y,c=Earcut.zOrder(o,l,t,i,n),_=Earcut.zOrder(h,u,t,i,n),d=e.nextZ;d&&d.z<=_;){if(d!==e.prev&&d!==e.next&&Earcut.pointInTriangle(r.x,r.y,a.x,a.y,s.x,s.y,d.x,d.y)&&Earcut.area(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(d=e.prevZ;d&&d.z>=c;){if(d!==e.prev&&d!==e.next&&Earcut.pointInTriangle(r.x,r.y,a.x,a.y,s.x,s.y,d.x,d.y)&&Earcut.area(d.prev,d,d.next)>=0)return!1;d=d.prevZ}return!0}},{key:"cureLocalIntersections",value:function(e,t,i){var n=e;do{var r=n.prev,a=n.next.next;!Earcut.equals(r,a)&&Earcut.intersects(r,n,n.next,a)&&Earcut.locallyInside(r,a)&&Earcut.locallyInside(a,r)&&(t.push(r.i/i),t.push(n.i/i),t.push(a.i/i),Earcut.removeNode(n),Earcut.removeNode(n.next),n=e=a),n=n.next}while(n!==e);return n}},{key:"splitEarcut",value:function(e,t,i,n,r,a){var s=e;do{for(var o=s.next.next;o!==s.prev;){if(s.i!==o.i&&Earcut.isValidDiagonal(s,o)){var l=Earcut.splitPolygon(s,o);return s=Earcut.filterPoints(s,s.next),l=Earcut.filterPoints(l,l.next),Earcut.earcutLinked(s,t,i,n,r,a),void Earcut.earcutLinked(l,t,i,n,r,a)}o=o.next}s=s.next}while(s!==e)}},{key:"eliminateHoles",value:function(e,t,i,n){var r,a,s,o,l,h=[];for(r=0,a=t.length;r<a;r++)s=t[r]*n,o=r<a-1?t[r+1]*n:e.length,(l=Earcut.linkedList(e,s,o,n,!1))===l.next&&(l.steiner=!0),h.push(Earcut.getLeftmost(l));for(h.sort(Earcut.compareX),r=0;r<h.length;r++)Earcut.eliminateHole(h[r],i),i=Earcut.filterPoints(i,i.next);return i}},{key:"compareX",value:function(e,t){return e.x-t.x}},{key:"eliminateHole",value:function(e,t){if(t=Earcut.findHoleBridge(e,t)){var i=Earcut.splitPolygon(t,e);Earcut.filterPoints(i,i.next)}}},{key:"findHoleBridge",value:function(e,t){var i,n=t,r=e.x,a=e.y,s=-1/0;do{if(a<=n.y&&a>=n.next.y&&n.next.y!==n.y){var o=n.x+(a-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(o<=r&&o>s){if(s=o,o===r){if(a===n.y)return n;if(a===n.next.y)return n.next}i=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!i)return null;if(r===s)return i.prev;var l,h=i,u=i.x,c=i.y,_=1/0;for(n=i.next;n!==h;)r>=n.x&&n.x>=u&&r!==n.x&&Earcut.pointInTriangle(a<c?r:s,a,u,c,a<c?s:r,a,n.x,n.y)&&((l=Math.abs(a-n.y)/(r-n.x))<_||l===_&&n.x>i.x)&&Earcut.locallyInside(n,e)&&(i=n,_=l),n=n.next;return i}},{key:"indexCurve",value:function(e,t,i,n){var r=e;do{null===r.z&&(r.z=Earcut.zOrder(r.x,r.y,t,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,Earcut.sortLinked(r)}},{key:"sortLinked",value:function(e){var t,i,n,r,a,s,o,l,h=1;do{for(i=e,e=null,a=null,s=0;i;){for(s++,n=i,o=0,t=0;t<h&&(o++,n=n.nextZ);t++);for(l=h;o>0||l>0&&n;)0!==o&&(0===l||!n||i.z<=n.z)?(r=i,i=i.nextZ,o--):(r=n,n=n.nextZ,l--),a?a.nextZ=r:e=r,r.prevZ=a,a=r;i=n}a.nextZ=null,h*=2}while(s>1);return e}},{key:"zOrder",value:function(e,t,i,n,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}},{key:"getLeftmost",value:function(e){var t=e,i=e;do{t.x<i.x&&(i=t),t=t.next}while(t!==e);return i}},{key:"pointInTriangle",value:function(e,t,i,n,r,a,s,o){return(r-s)*(t-o)-(e-s)*(a-o)>=0&&(e-s)*(n-o)-(i-s)*(t-o)>=0&&(i-s)*(a-o)-(r-s)*(n-o)>=0}},{key:"isValidDiagonal",value:function(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!Earcut.intersectsPolygon(e,t)&&Earcut.locallyInside(e,t)&&Earcut.locallyInside(t,e)&&Earcut.middleInside(e,t)}},{key:"area",value:function(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}},{key:"equals",value:function(e,t){return e.x===t.x&&e.y===t.y}},{key:"intersects",value:function(e,t,i,n){return!!(Earcut.equals(e,t)&&Earcut.equals(i,n)||Earcut.equals(e,n)&&Earcut.equals(i,t))||Earcut.area(e,t,i)>0!=Earcut.area(e,t,n)>0&&Earcut.area(i,n,e)>0!=Earcut.area(i,n,t)>0}},{key:"intersectsPolygon",value:function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&Earcut.intersects(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}},{key:"locallyInside",value:function(e,t){return Earcut.area(e.prev,e,e.next)<0?Earcut.area(e,t,e.next)>=0&&Earcut.area(e,e.prev,t)>=0:Earcut.area(e,t,e.prev)<0||Earcut.area(e,e.next,t)<0}},{key:"middleInside",value:function(e,t){var i=e,n=!1,r=(e.x+t.x)/2,a=(e.y+t.y)/2;do{i.y>a!=i.next.y>a&&i.next.y!==i.y&&r<(i.next.x-i.x)*(a-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==e);return n}},{key:"splitPolygon",value:function(e,t){var i=new we(e.i,e.x,e.y),n=new we(t.i,t.x,t.y),r=e.next,a=t.prev;return e.next=t,t.prev=e,i.next=r,r.prev=i,n.next=i,i.prev=n,a.next=n,n.prev=a,n}},{key:"insertNode",value:function(e,t,i,n){var r=new we(e,t,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}},{key:"removeNode",value:function(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}},{key:"signedArea",value:function(e,t,i,n){for(var r=0,a=t,s=i-n;a<i;a+=n)r+=(e[s]-e[a])*(e[a+1]+e[s+1]),s=a;return r}}]),Earcut}(),Ie=function CONST3D2D(){_classCallCheck(this,CONST3D2D)};Ie.BYTES_PE=4,Ie.BYTES_PIDX=2,Ie.defaultMatrix4=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Ie.defaultMinusYMatrix4=[1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1],Ie.uniformMatrix3=[1,0,0,0,0,1,0,0,0,0,1,0],Ie._TMPARRAY=[],Ie._OFFSETX=0,Ie._OFFSETY=0;var Pe=function(e){function Submit(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:he.TYPE_2D;return _classCallCheck(this,Submit),_possibleConstructorReturn(this,_getPrototypeOf(Submit).call(this,e))}return _inherits(Submit,e),_createClass(Submit,[{key:"renderSubmit",value:function(){if(0===this._numEle||!this._mesh||0==this._numEle)return 1;var e=this.shaderValue.textureHost;if(e){var t=e._getSource();if(!t)return 1;this.shaderValue.texture=t}var i=y.mainContext;return this._mesh.useMesh(i),this.shaderValue.upload(),F.activeBlendFunction!==this._blendFn&&(y.setBlend(i,!0),this._blendFn(i),F.activeBlendFunction=this._blendFn),i.drawElements(i.TRIANGLES,this._numEle,i.UNSIGNED_SHORT,this._startIdx),N.renderBatches++,N.trianglesFaces+=this._numEle/3,1}},{key:"releaseRender",value:function(){he.RENDERBASE!=this&&--this._ref<1&&(Submit.POOL[Submit._poolSize++]=this,this.shaderValue.release(),this.shaderValue=null,this._mesh=null,this._parent&&(this._parent.releaseRender(),this._parent=null))}}],[{key:"create",value:function(e,t,i){var n=Submit._poolSize?Submit.POOL[--Submit._poolSize]:new Submit;n._ref=1,n._mesh=t,n._key.clear(),n._startIdx=t.indexNum*Ie.BYTES_PIDX,n._numEle=0;var r=e._nBlendType;n._blendFn=e._targets?F.targetFns[r]:F.fns[r],n.shaderValue=i,n.shaderValue.setValue(e._shader2D);var a=e._shader2D.filters;return a&&n.shaderValue.setFilters(a),n}},{key:"createShape",value:function(e,t,i,n){var r=Submit._poolSize?Submit.POOL[--Submit._poolSize]:new Submit;r._mesh=t,r._numEle=i,r._startIdx=2*t.indexNum,r._ref=1,r.shaderValue=n,r.shaderValue.setValue(e._shader2D);var a=e._nBlendType;return r._key.blendShader=a,r._blendFn=e._targets?F.targetFns[a]:F.fns[a],r}}]),Submit}(he);Pe._poolSize=0,Pe.POOL=[];var De=function(e){function SubmitCanvas(){var e;return _classCallCheck(this,SubmitCanvas),(e=_possibleConstructorReturn(this,_getPrototypeOf(SubmitCanvas).call(this,he.TYPE_2D)))._matrix=new f,e._matrix4=Ie.defaultMatrix4.concat(),e.shaderValue=new Y(0,0),e}return _inherits(SubmitCanvas,e),_createClass(SubmitCanvas,[{key:"renderSubmit",value:function(){var e=D.worldAlpha,t=D.worldMatrix4,i=D.worldMatrix,n=D.worldFilters,r=D.worldShaderDefines,a=this.shaderValue,s=this._matrix,o=this._matrix4,l=f.TEMP;return f.mul(s,i,l),o[0]=l.a,o[1]=l.b,o[4]=l.c,o[5]=l.d,o[12]=l.tx,o[13]=l.ty,D.worldMatrix=l.clone(),D.worldMatrix4=o,D.worldAlpha=D.worldAlpha*a.alpha,a.filters&&a.filters.length&&(D.worldFilters=a.filters,D.worldShaderDefines=a.defines),this.canv.flushsubmit(),D.worldAlpha=e,D.worldMatrix4=t,D.worldMatrix.destroy(),D.worldMatrix=i,D.worldFilters=n,D.worldShaderDefines=r,1}},{key:"releaseRender",value:function(){if(--this._ref<1){var e=SubmitCanvas.POOL;this._mesh=null,e[e._length++]=this}}},{key:"getRenderType",value:function(){return he.TYPE_CANVAS}}],[{key:"create",value:function(e,t,i){var n=SubmitCanvas.POOL._length?SubmitCanvas.POOL[--SubmitCanvas.POOL._length]:new SubmitCanvas;n.canv=e,n._ref=1,n._numEle=0;var r=n.shaderValue;return r.alpha=t,r.defines.setValue(0),i&&i.length&&r.setFilters(i),n}}]),SubmitCanvas}(he);De.POOL=[],De.POOL._length=0;var Be=function(){function SubmitTarget(){_classCallCheck(this,SubmitTarget),this.blendType=0,this._ref=1,this._key=new X}return _createClass(SubmitTarget,[{key:"renderSubmit",value:function(){var e=y.mainContext;this._mesh.useMesh(e);var t=this.srcRT;return t&&(this.shaderValue.texture=t._getSource(),this.shaderValue.upload(),this.blend(),N.renderBatches++,N.trianglesFaces+=this._numEle/3,e.drawElements(e.TRIANGLES,this._numEle,e.UNSIGNED_SHORT,this._startIdx)),1}},{key:"blend",value:function(){if(F.activeBlendFunction!==F.fns[this.blendType]){var e=y.mainContext;e.enable(e.BLEND),F.fns[this.blendType](e),F.activeBlendFunction=F.fns[this.blendType]}}},{key:"getRenderType",value:function(){return 0}},{key:"releaseRender",value:function(){if(--this._ref<1){var e=SubmitTarget.POOL;e[e._length++]=this}}}],[{key:"create",value:function(e,t,i,n){var r=SubmitTarget.POOL._length?SubmitTarget.POOL[--SubmitTarget.POOL._length]:new SubmitTarget;if(r._mesh=t,r.srcRT=n,r._startIdx=t.indexNum*Ie.BYTES_PIDX,r._ref=1,r._key.clear(),r._numEle=0,r.blendType=e._nBlendType,r._key.blendShader=r.blendType,r.shaderValue=i,r.shaderValue.setValue(e._shader2D),e._colorFiler){var a=e._colorFiler;i.defines.add(a.type),i.colorMat=a._mat,i.colorAlpha=a._alpha}return r}}]),SubmitTarget}();Be.POOL=[],Be.POOL._length=0;var Oe=function(e){function SubmitTexture(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:he.TYPE_2D;return _classCallCheck(this,SubmitTexture),_possibleConstructorReturn(this,_getPrototypeOf(SubmitTexture).call(this,e))}return _inherits(SubmitTexture,e),_createClass(SubmitTexture,[{key:"releaseRender",value:function(){--this._ref<1&&(SubmitTexture.POOL[SubmitTexture._poolSize++]=this,this.shaderValue.release(),this._mesh=null,this._parent&&(this._parent.releaseRender(),this._parent=null))}},{key:"renderSubmit",value:function(){if(0===this._numEle)return 1;var e=this.shaderValue.textureHost;if(e){var t=e?e._getSource():null;if(!t)return 1}var i=y.mainContext;this._mesh.useMesh(i);var n=he.preRender,r=he.preRender._key;return 0===this._key.blendShader&&this._key.submitType===r.submitType&&this._key.blendShader===r.blendShader&&P.activeShader&&he.preRender.clipInfoID==this.clipInfoID&&n.shaderValue.defines._value===this.shaderValue.defines._value&&0==(this.shaderValue.defines._value&U.NOOPTMASK)?P.activeShader.uploadTexture2D(t):(F.activeBlendFunction!==this._blendFn&&(y.setBlend(i,!0),this._blendFn(i),F.activeBlendFunction=this._blendFn),this.shaderValue.texture=t,this.shaderValue.upload()),i.drawElements(i.TRIANGLES,this._numEle,i.UNSIGNED_SHORT,this._startIdx),N.renderBatches++,N.trianglesFaces+=this._numEle/3,1}}],[{key:"create",value:function(e,t,i){var n=SubmitTexture._poolSize?SubmitTexture.POOL[--SubmitTexture._poolSize]:new SubmitTexture(he.TYPE_TEXTURE);n._mesh=t,n._key.clear(),n._key.submitType=he.KEY_DRAWTEXTURE,n._ref=1,n._startIdx=t.indexNum*Ie.BYTES_PIDX,n._numEle=0;var r=e._nBlendType;if(n._key.blendShader=r,n._blendFn=e._targets?F.targetFns[r]:F.fns[r],n.shaderValue=i,e._colorFiler){var a=e._colorFiler;i.defines.add(a.type),i.colorMat=a._mat,i.colorAlpha=a._alpha}return n}}]),SubmitTexture}(he);Oe._poolSize=0,Oe.POOL=[];var Fe=function(){function CharSubmitCache(){_classCallCheck(this,CharSubmitCache),this._data=[],this._ndata=0,this._clipid=-1,this._clipMatrix=new f,this._enable=!1}return _createClass(CharSubmitCache,[{key:"clear",value:function(){this._tex=null,this._imgId=-1,this._ndata=0,this._enable=!1,this._colorFiler=null}},{key:"destroy",value:function(){this.clear(),this._data.length=0,this._data=null}},{key:"add",value:function(e,t,i,n,r,a){this._ndata>0&&(this._tex!=t||this._imgId!=i||this._clipid>=0&&this._clipid!=e._clipInfoID)&&this.submit(e),this._clipid=e._clipInfoID,e._globalClipMatrix.copyTo(this._clipMatrix),this._tex=t,this._imgId=i,this._colorFiler=e._colorFiler,this._data[this._ndata]=n,this._data[this._ndata+1]=r,this._data[this._ndata+2]=a,this._ndata+=3}},{key:"getPos",value:function(){return 0==CharSubmitCache.__nPosPool?new Array(8):CharSubmitCache.__posPool[--CharSubmitCache.__nPosPool]}},{key:"enable",value:function(e,t){e!==this._enable&&(this._enable=e,this._enable||this.submit(t))}},{key:"submit",value:function(e){var t=this._ndata;if(t){var i=e._mesh,n=e._colorFiler;e._colorFiler=this._colorFiler;var r=Oe.create(e,i,Y.create(U.TEXTURE2D,0));e._submits[e._submits._length++]=e._curSubmit=r,r.shaderValue.textureHost=this._tex,r._key.other=this._imgId,e._colorFiler=n,e._copyClipInfo(r,this._clipMatrix),r.clipInfoID=this._clipid;for(var a=0;a<t;a+=3)i.addQuad(this._data[a],this._data[a+1],this._data[a+2],!0),CharSubmitCache.__posPool[CharSubmitCache.__nPosPool++]=this._data[a];t/=3,r._numEle+=6*t,i.indexNum+=6*t,i.vertNum+=4*t,e._drawCount+=t,this._ndata=0,ye.loopCount%100==0&&(this._data.length=0)}}}]),CharSubmitCache}();Fe.__posPool=[],Fe.__nPosPool=0;var Ge=function(){function AtlasGrid(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;_classCallCheck(this,AtlasGrid),this.atlasID=0,this._width=0,this._height=0,this._texCount=0,this._rowInfo=null,this._cells=null,this._used=0,this._cells=null,this._rowInfo=null,this.atlasID=i,this._init(e,t)}return _createClass(AtlasGrid,[{key:"addRect",value:function(e,t,i,n){return!!this._get(t,i,n)&&(this._fill(n.x,n.y,t,i,e),this._texCount++,!0)}},{key:"_release",value:function(){this._cells=null,this._rowInfo=null}},{key:"_init",value:function(e,t){return this._width=e,this._height=t,this._release(),0!=this._width&&(this._cells=new Uint8Array(this._width*this._height*3),this._rowInfo=new Uint8Array(this._height),this._used=0,this._clear(),!0)}},{key:"_get",value:function(e,t,i){if(e>this._width||t>this._height)return!1;for(var n=-1,r=-1,a=this._width,s=this._height,o=this._cells,l=0;l<s;l++)if(!(this._rowInfo[l]<e))for(var h=0;h<a;){var u=3*(l*a+h);if(0!=o[u]||o[u+1]<e||o[u+2]<t)h+=o[u+1];else{n=h,r=l;for(var c=0;c<e;c++)if(o[3*c+u+2]<t){n=-1;break}if(!(n<0))return i.x=n,i.y=r,!0;h+=o[u+1]}}return!1}},{key:"_fill",value:function(e,t,i,n,r){var a=this._width,s=this._height;this._check(e+i<=a&&t+n<=s);for(var o=t;o<n+t;++o){this._check(this._rowInfo[o]>=i),this._rowInfo[o]-=i;for(var l=0;l<i;l++){var h=3*(e+o*a+l);this._check(0==this._cells[h]),this._cells[h]=r,this._cells[h+1]=i,this._cells[h+2]=n}}if(e>0)for(o=0;o<n;++o){var u=0;for(l=e-1;l>=0&&0==this._cells[3*((t+o)*a+l)];--l,++u);for(l=u;l>0;--l)this._cells[3*((t+o)*a+e-l)+1]=l,this._check(l>0)}if(t>0)for(l=e;l<e+i;++l){for(u=0,o=t-1;o>=0&&0==this._cells[3*(l+o*a)];--o,u++);for(o=u;o>0;--o)this._cells[3*(l+(t-o)*a)+2]=o,this._check(o>0)}this._used+=i*n/(this._width*this._height)}},{key:"_check",value:function(e){0==e&&console.log("xtexMerger 错误啦")}},{key:"_clear",value:function(){this._texCount=0;for(var e=0;e<this._height;e++)this._rowInfo[e]=this._width;for(var t=0;t<this._height;t++)for(var i=0;i<this._width;i++){var n=3*(t*this._width+i);this._cells[n]=0,this._cells[n+1]=this._width-i,this._cells[n+2]=this._width-t}}}]),AtlasGrid}(),Ue=function(e){function TextTexture(e,t){var i;return _classCallCheck(this,TextTexture),(i=_possibleConstructorReturn(this,_getPrototypeOf(TextTexture).call(this)))._texW=0,i._texH=0,i.__destroyed=!1,i._discardTm=0,i.genID=0,i.bitmap={id:0,_glTexture:null},i.curUsedCovRate=0,i.curUsedCovRateAtlas=0,i.lastTouchTm=0,i.ri=null,i._texW=e||TextTexture.gTextRender.atlasWidth,i._texH=t||TextTexture.gTextRender.atlasWidth,i.bitmap.id=i.id,i.lock=!0,i}return _inherits(TextTexture,e),_createClass(TextTexture,[{key:"recreateResource",value:function(){if(!this._source){var e=g.instance,t=this._source=e.createTexture();this.bitmap._glTexture=t,y.bindTexture(e,e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this._texW,this._texH,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),TextTexture.gTextRender.debugUV&&this.fillWhite()}}},{key:"addChar",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(TextTexture.gTextRender.isWan1Wan)return this.addCharCanvas(e,t,n,r);!this._source&&this.recreateResource();var a=g.instance;y.bindTexture(a,a.TEXTURE_2D,this._source),!i.Render.isConchApp&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);var s,o,l,h,u=e.data;return e.data instanceof Uint8ClampedArray&&(u=new Uint8Array(u.buffer)),a.texSubImage2D(a.TEXTURE_2D,0,t,n,e.width,e.height,a.RGBA,a.UNSIGNED_BYTE,u),!i.Render.isConchApp&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),s=t/this._texW,o=n/this._texH,l=(t+e.width)/this._texW,h=(n+e.height)/this._texH,(r=r||new Array(8))[0]=s,r[1]=o,r[2]=l,r[3]=o,r[4]=l,r[5]=h,r[6]=s,r[7]=h,r}},{key:"addCharCanvas",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;!this._source&&this.recreateResource();var a,s,o,l,h=g.instance;return y.bindTexture(h,h.TEXTURE_2D,this._source),!i.Render.isConchApp&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),h.texSubImage2D(h.TEXTURE_2D,0,t,n,h.RGBA,h.UNSIGNED_BYTE,e),!i.Render.isConchApp&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i.Render.isConchApp?(a=t/this._texW,s=n/this._texH,o=(t+e.width)/this._texW,l=(n+e.height)/this._texH):(a=(t+1)/this._texW,s=(n+1)/this._texH,o=(t+e.width-1)/this._texW,l=(n+e.height-1)/this._texH),(r=r||new Array(8))[0]=a,r[1]=s,r[2]=o,r[3]=s,r[4]=o,r[5]=l,r[6]=a,r[7]=l,r}},{key:"fillWhite",value:function(){!this._source&&this.recreateResource();var e=g.instance,t=new Uint8Array(this._texW*this._texH*4);t.fill(255),e.texSubImage2D(e.TEXTURE_2D,0,0,0,this._texW,this._texH,e.RGBA,e.UNSIGNED_BYTE,t)}},{key:"discard",value:function(){i.stage.setGlobalRepaint(),this.destroy()}},{key:"destroy",value:function(){this.__destroyed=!0;var e=g.instance;this._source&&e.deleteTexture(this._source),this._source=null}},{key:"touchRect",value:function(e,t){this.lastTouchTm!=t&&(this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=t);var n=TextTexture.gTextRender.atlasWidth*TextTexture.gTextRender.atlasWidth,r=i.TextAtlas.atlasGridW*i.TextAtlas.atlasGridW;this.curUsedCovRate+=e.bmpWidth*e.bmpHeight/n,this.curUsedCovRateAtlas+=Math.ceil(e.bmpWidth/i.TextAtlas.atlasGridW)*Math.ceil(e.bmpHeight/i.TextAtlas.atlasGridW)/(n/r)}},{key:"_getSource",value:function(){return this._source}},{key:"drawOnScreen",value:function(e,t){}},{key:"texture",get:function(){return this}}],[{key:"getTextTexture",value:function(e,t){return new TextTexture(e,t)}},{key:"clean",value:function(){var e=ye.loopStTm;if(0===TextTexture.cleanTm&&(TextTexture.cleanTm=e),e-TextTexture.cleanTm>=TextTexture.gTextRender.checkCleanTextureDt){for(var t=0;t<TextTexture.poolLen;t++){var i=TextTexture.pool[t];e-i._discardTm>=TextTexture.gTextRender.destroyUnusedTextureDt&&(i.destroy(),TextTexture.pool[t]=TextTexture.pool[TextTexture.poolLen-1],TextTexture.poolLen--,t--)}TextTexture.cleanTm=e}}}]),TextTexture}(k);Ue.gTextRender=null,Ue.pool=new Array(10),Ue.poolLen=0,Ue.cleanTm=0;var Ne=function(){function TextAtlas(){_classCallCheck(this,TextAtlas),this.texWidth=1024,this.texHeight=1024,this.texture=null,this.charMaps={},this.texHeight=this.texWidth=i.TextRender.atlasWidth,this.texture=Ue.getTextTexture(this.texWidth,this.texHeight),this.texWidth/TextAtlas.atlasGridW>256&&(TextAtlas.atlasGridW=Math.ceil(this.texWidth/256)),this.atlasgrid=new Ge(this.texWidth/TextAtlas.atlasGridW,this.texHeight/TextAtlas.atlasGridW,this.texture.id)}return _createClass(TextAtlas,[{key:"setProtecteDist",value:function(e){}},{key:"getAEmpty",value:function(e,t,i){var n=this.atlasgrid.addRect(1,Math.ceil(e/TextAtlas.atlasGridW),Math.ceil(t/TextAtlas.atlasGridW),i);return n&&(i.x*=TextAtlas.atlasGridW,i.y*=TextAtlas.atlasGridW),n}},{key:"destroy",value:function(){for(var e in this.charMaps){this.charMaps[e].deleted=!0}this.texture.discard()}},{key:"printDebugInfo",value:function(){}},{key:"usedRate",get:function(){return this.atlasgrid._used}}]),TextAtlas}();Ne.atlasGridW=16;var We=function(){function Event(){_classCallCheck(this,Event)}return _createClass(Event,[{key:"setTo",value:function(e,t,i){return this.type=e,this.currentTarget=t,this.target=i,this}},{key:"stopPropagation",value:function(){this._stoped=!0}},{key:"touches",get:function(){if(!this.nativeEvent)return null;var e=this.nativeEvent.touches;if(e)for(var t=i.stage,n=0,r=e.length;n<r;n++){var a=e[n],s=v.TEMP;s.setTo(a.clientX,a.clientY),t._canvasTransform.invertTransformPoint(s),t.transform.invertTransformPoint(s),a.stageX=s.x,a.stageY=s.y}return e}},{key:"altKey",get:function(){return this.nativeEvent.altKey}},{key:"ctrlKey",get:function(){return this.nativeEvent.ctrlKey}},{key:"shiftKey",get:function(){return this.nativeEvent.shiftKey}},{key:"charCode",get:function(){return this.nativeEvent.charCode}},{key:"keyLocation",get:function(){return this.nativeEvent.location||this.nativeEvent.keyLocation}},{key:"stageX",get:function(){return i.stage.mouseX}},{key:"stageY",get:function(){return i.stage.mouseY}}]),Event}();We.EMPTY=new We,We.MOUSE_DOWN="mousedown",We.MOUSE_UP="mouseup",We.CLICK="click",We.RIGHT_MOUSE_DOWN="rightmousedown",We.RIGHT_MOUSE_UP="rightmouseup",We.RIGHT_CLICK="rightclick",We.MOUSE_MOVE="mousemove",We.MOUSE_OVER="mouseover",We.MOUSE_OUT="mouseout",We.MOUSE_WHEEL="mousewheel",We.ROLL_OVER="mouseover",We.ROLL_OUT="mouseout",We.DOUBLE_CLICK="doubleclick",We.CHANGE="change",We.CHANGED="changed",We.RESIZE="resize",We.ADDED="added",We.REMOVED="removed",We.DISPLAY="display",We.UNDISPLAY="undisplay",We.ERROR="error",We.COMPLETE="complete",We.LOADED="loaded",We.READY="ready",We.PROGRESS="progress",We.INPUT="input",We.RENDER="render",We.OPEN="open",We.MESSAGE="message",We.CLOSE="close",We.KEY_DOWN="keydown",We.KEY_PRESS="keypress",We.KEY_UP="keyup",We.FRAME="enterframe",We.DRAG_START="dragstart",We.DRAG_MOVE="dragmove",We.DRAG_END="dragend",We.ENTER="enter",We.SELECT="select",We.BLUR="blur",We.FOCUS="focus",We.VISIBILITY_CHANGE="visibilitychange",We.FOCUS_CHANGE="focuschange",We.PLAYED="played",We.PAUSED="paused",We.STOPPED="stopped",We.START="start",We.END="end",We.COMPONENT_ADDED="componentadded",We.COMPONENT_REMOVED="componentremoved",We.RELEASED="released",We.LINK="link",We.LABEL="label",We.FULL_SCREEN_CHANGE="fullscreenchange",We.DEVICE_LOST="devicelost",We.TRANSFORM_CHANGED="transformchanged",We.ANIMATION_CHANGED="animationchanged",We.TRAIL_FILTER_CHANGE="trailfilterchange",We.TRIGGER_ENTER="triggerenter",We.TRIGGER_STAY="triggerstay",We.TRIGGER_EXIT="triggerexit";var Ve=function(e){function Texture(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return _classCallCheck(this,Texture),(e=_possibleConstructorReturn(this,_getPrototypeOf(Texture).call(this))).uvrect=[0,0,1,1],e._destroyed=!1,e._referenceCount=0,e.$_GID=0,e.offsetX=0,e.offsetY=0,e._w=0,e._h=0,e.sourceWidth=0,e.sourceHeight=0,e.url=null,e.scaleRate=1,e.setTo(t,i,n,r),e}return _inherits(Texture,e),_createClass(Texture,[{key:"_addReference",value:function(){this._bitmap&&this._bitmap._addReference(),this._referenceCount++}},{key:"_removeReference",value:function(){this._bitmap&&this._bitmap._removeReference(),this._referenceCount--}},{key:"_getSource",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return this._destroyed||!this._bitmap?null:(this.recoverBitmap(e),this._bitmap.destroyed?null:this.bitmap._getSource())}},{key:"_onLoaded",value:function(e,t){if(t)if(t==this);else if(t instanceof Texture){var i=t;Texture._create(t,0,0,i.width,i.height,0,0,i.sourceWidth,i.sourceHeight,this)}else this.bitmap=t,this.sourceWidth=this._w=t.width,this.sourceHeight=this._h=t.height;else;e&&e.run(),this.event(We.READY,this)}},{key:"getIsReady",value:function(){return!this._destroyed&&!!this._bitmap}},{key:"setTo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;this.bitmap=e,this.sourceWidth=i,this.sourceHeight=n,e&&(this._w=e.width,this._h=e.height,this.sourceWidth=this.sourceWidth||e.width,this.sourceHeight=this.sourceHeight||e.height),this.uv=t||Texture.DEF_UV}},{key:"load",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this._destroyed||i.loader.load(e,m.create(this,this._onLoaded,[t]),null,"htmlimage",1,!0)}},{key:"getTexturePixels",value:function(e,t,n,r){var a,s,o,l=this.bitmap,h=this._w,u=this._h,c=this.sourceWidth,_=this.sourceHeight,d=l.width,f=l.height,v=this.offsetX,p=this.offsetY,g=n,y=r;if(e+n>h+v&&(g-=e+n-h-v),e+n>c&&(n-=e+n-c),t+r>u+p&&(y-=t+r-u-p),t+r>_&&(r-=t+r-_),n<=0||r<=0)return null;var m=v>e?v-e:0,T=p>t?p-t:0,C=e>v?e-v:0,x=t>p?t-p:0;g-=m,y-=T;var k=4*n,S=null;try{S=l.getPixels()}catch(e){}if(S){if(0==e&&0==t&&n==d&&r==f)return S;var R=this._uv.slice(),b=Math.round(R[0]*d),E=Math.round(R[1]*f),M=new Uint8Array(n*r*4);for(a=4*b+4*C+(s=(E+x)*(k=4*d)),o=0;o<y;o++)M.set(S.slice(a,a+4*g),4*n*(o+T)+4*m),a+=k;return M}var A=new i.Context;A.size(n,r),A.asBitmap=!0;var w=null;if(0!=e||0!=t||n!=d||r!=f){var L=(w=this._uv.slice())[0],I=w[1],P=(w[2]-L)/h,D=(w[7]-I)/u;w=[L+C*P,I+x*D,L+(C+g)*P,I+x*D,L+(C+g)*P,I+(x+y)*D,L+C*P,I+(x+y)*D]}A._drawTextureM(this,m,T,g,y,null,1,w),A._targets.start(),A.flush(),A._targets.end(),A._targets.restore();var B=A._targets.getData(0,0,n,r);for(A.destroy(),M=new Uint8Array(n*r*4),a=0,s=(r-1)*k,o=r-1;o>=0;o--)M.set(B.slice(s,s+k),a),a+=k,s-=k;return M}},{key:"getPixels",value:function(e,t,i,n){return window.conch?this._nativeObj.getImageData(e,t,i,n):this.getTexturePixels(e,t,i,n)}},{key:"recoverBitmap",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=this._bitmap.url;this._destroyed||this._bitmap&&!this._bitmap.destroyed||!t||i.loader.load(t,m.create(this,(function(t){this.bitmap=t,e&&e()})),null,"htmlimage",1,!0)}},{key:"disposeBitmap",value:function(){!this._destroyed&&this._bitmap&&this._bitmap.destroy()}},{key:"destroy",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this._destroyed){this._destroyed=!0;var t=this._bitmap;t&&(t._removeReference(this._referenceCount),(0===t.referenceCount||e)&&t.destroy(),t=null),this.url&&this===i.loader.getRes(this.url)&&i.Loader.clearRes(this.url)}}},{key:"uv",get:function(){return this._uv},set:function(e){this.uvrect[0]=Math.min(e[0],e[2],e[4],e[6]),this.uvrect[1]=Math.min(e[1],e[3],e[5],e[7]),this.uvrect[2]=Math.max(e[0],e[2],e[4],e[6])-this.uvrect[0],this.uvrect[3]=Math.max(e[1],e[3],e[5],e[7])-this.uvrect[1],this._uv=e}},{key:"width",get:function(){return this._w?this._w:this.bitmap?this.uv&&this.uv!==Texture.DEF_UV?(this.uv[2]-this.uv[0])*this.bitmap.width:this.bitmap.width:0},set:function(e){this._w=e,this.sourceWidth||(this.sourceWidth=e)}},{key:"height",get:function(){return this._h?this._h:this.bitmap?this.uv&&this.uv!==Texture.DEF_UV?(this.uv[5]-this.uv[1])*this.bitmap.height:this.bitmap.height:0},set:function(e){this._h=e,this.sourceHeight||(this.sourceHeight=e)}},{key:"bitmap",get:function(){return this._bitmap},set:function(e){this._bitmap&&this._bitmap._removeReference(this._referenceCount),this._bitmap=e,e&&e._addReference(this._referenceCount)}},{key:"destroyed",get:function(){return this._destroyed}}],[{key:"moveUV",value:function(e,t,i){for(var n=0;n<8;n+=2)i[n]+=e,i[n+1]+=t;return i}},{key:"create",value:function(e,t,i,n,r){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0;return Texture._create(e,t,i,n,r,a,s,o,l)}},{key:"_create",value:function(e,t,i,n,r){var a,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,h=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,c=e instanceof Texture,_=c?e.uv:Texture.DEF_UV,d=c?e.bitmap:e;d.width&&t+n>d.width&&(n=d.width-t),d.height&&i+r>d.height&&(r=d.height-i),u?(a=u).setTo(d,null,l||n,h||r):a=new Texture(d,null,l||n,h||r),a.width=n,a.height=r,a.offsetX=s,a.offsetY=o;var f=1/d.width,v=1/d.height;t*=f,i*=v,n*=f,r*=v;var p=a.uv[0],g=a.uv[1],y=a.uv[4],m=a.uv[5],T=y-p,C=m-g,x=Texture.moveUV(_[0],_[1],[t,i,t+n,i,t+n,i+r,t,i+r]);a.uv=new Float32Array([p+x[0]*T,g+x[1]*C,y-(1-x[2])*T,g+x[3]*C,y-(1-x[4])*T,m-(1-x[5])*C,p+x[6]*T,m-(1-x[7])*C]);var k=d.scaleRate;return k&&1!=k?(a.sourceWidth/=k,a.sourceHeight/=k,a.width/=k,a.height/=k,a.scaleRate=k):a.scaleRate=1,a}},{key:"createFromTexture",value:function(e,t,i,n,r){var a=e.scaleRate;1!=a&&(t*=a,i*=a,n*=a,r*=a);var s=p.TEMP.setTo(t-e.offsetX,i-e.offsetY,n,r),o=s.intersection(Texture._rect1.setTo(0,0,e.width,e.height),Texture._rect2);return o?Texture.create(e,o.x,o.y,o.width,o.height,o.x-s.x,o.y-s.y,n,r):null}}]),Texture}(T);Ve.DEF_UV=new Float32Array([0,0,1,0,1,1,0,1]),Ve.NO_UV=new Float32Array([0,0,0,0,0,0,0,0]),Ve.INV_UV=new Float32Array([0,1,1,1,1,0,0,0]),Ve._rect1=new p,Ve._rect2=new p;var He=function(){function FontInfo(e){_classCallCheck(this,FontInfo),this._font="14px Arial",this._family="Arial",this._size=14,this._italic=!1,this._bold=!1,this._id=FontInfo._gfontID++,this.setFont(e||this._font)}return _createClass(FontInfo,[{key:"setFont",value:function(e){this._font=e;var t=e.split(" "),i=t.length;if(i<2)1==i&&t[0].indexOf("px")>0&&(this._size=parseInt(t[0]));else{for(var n=-1,r=0;r<i;r++)if(t[r].indexOf("px")>0||t[r].indexOf("pt")>0){n=r,this._size=parseInt(t[r]),this._size<=0&&(console.error("font parse error:"+e),this._size=14);break}var a=n+1,s=t[a];for(a++;a<i;a++)s+=" "+t[a];this._family=s.split(",")[0],this._italic=t.indexOf("italic")>=0,this._bold=t.indexOf("bold")>=0}}}],[{key:"Parse",value:function(e){if(e===FontInfo._lastFont)return FontInfo._lastFontInfo;var t=FontInfo._cache[e];return t||(t=FontInfo._cache[e]=new FontInfo(e)),FontInfo._lastFont=e,FontInfo._lastFontInfo=t,t}}]),FontInfo}();He.EMPTY=new He(null),He._cache={},He._gfontID=0,He._lastFont="";var Ye=function(){function WordText(){_classCallCheck(this,WordText),this.save=[],this.toUpperCase=null,this.width=-1,this.pageChars=[],this.startID=0,this.startIDStroke=0,this.lastGCCnt=0,this.splitRender=!1,this.scalex=1,this.scaley=1}return _createClass(WordText,[{key:"setText",value:function(e){this.changed=!0,this._text=e,this.width=-1,this.cleanCache()}},{key:"toString",value:function(){return this._text}},{key:"charCodeAt",value:function(e){return this._text?this._text.charCodeAt(e):NaN}},{key:"charAt",value:function(e){return this._text?this._text.charAt(e):null}},{key:"cleanCache",value:function(){this.pageChars.forEach((function(e){var t=e.tex;e.words;1==e.words.length&&t&&t.ri&&t.destroy()})),this.pageChars=[],this.startID=0,this.scalex=1,this.scaley=1}},{key:"length",get:function(){return this._text?this._text.length:0}}]),WordText}(),Xe=function(){function CharRenderInfo(){_classCallCheck(this,CharRenderInfo),this.char="",this.deleted=!1,this.uv=new Array(8),this.pos=0,this.orix=0,this.oriy=0,this.touchTick=0,this.isSpace=!1}return _createClass(CharRenderInfo,[{key:"touch",value:function(){var e=ye.loopCount;this.touchTick!=e&&this.tex.touchRect(this,e),this.touchTick=e}}]),CharRenderInfo}(),ze=function(){function ICharRender(){_classCallCheck(this,ICharRender),this.fontsz=16}return _createClass(ICharRender,[{key:"getWidth",value:function(e,t){return 0}},{key:"scale",value:function(e,t){}},{key:"getCharBmp",value:function(e,t,i,n,r,a,s,o,l,h){arguments.length>10&&void 0!==arguments[10]&&arguments[10];return null}},{key:"canvasWidth",get:function(){return 0},set:function(e){}}]),ICharRender}(),Ke=function(){function Browser(){_classCallCheck(this,Browser)}return _createClass(Browser,null,[{key:"__init__",value:function(){var e=window.Laya||i.Laya;if(Browser._window)return Browser._window;var t=Browser._window=window,n=Browser._document=t.document,r=Browser.userAgent=t.navigator.userAgent,a=t.navigator.maxTouchPoints||0,s=t.navigator.platform;"my"in Browser.window&&("tb"in Browser.window.my?(window.tbMiniGame(e,e),e.TBMiniAdapter?e.TBMiniAdapter.enable():console.error("请先添加淘宝适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-6-0")):r.indexOf("AlipayMiniGame")>-1&&(window.aliPayMiniGame(e,e),e.ALIMiniAdapter?e.ALIMiniAdapter.enable():console.error("请先添加阿里小游戏适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-6-0"))),-1==r.indexOf("OPPO")&&r.indexOf("MiniGame")>-1&&"wx"in Browser.window&&("tt"in Browser.window?(window.ttMiniGame(e,e),e.TTMiniAdapter?e.TTMiniAdapter.enable():console.error("请引入字节跳动小游戏的适配库")):"bl"in Browser.window?(window.biliMiniGame(e,e),e.BLMiniAdapter?e.BLMiniAdapter.enable():console.error("请引入bilibili小游戏的适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-7-0")):"qq"in Browser.window?(window.qqMiniGame(e,e),e.QQMiniAdapter?e.QQMiniAdapter.enable():console.error("请引入手机QQ小游戏的适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-0-0")):(window.wxMiniGame(e,e),e.MiniAdpter?e.MiniAdpter.enable():console.error("请先添加小游戏适配库,详细教程：https://ldc2.layabox.com/doc/?nav=zh-ts-5-0-0"))),"hbs"in Browser.window&&(window.hwMiniGame(e,e),e.HWMiniAdapter?e.HWMiniAdapter.enable():console.error("请先添加小游戏适配库!")),r.indexOf("SwanGame")>-1&&(window.bdMiniGame(e,e),e.BMiniAdapter?e.BMiniAdapter.enable():console.error("请先添加百度小游戏适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-1-0")),r.indexOf("QuickGame")>-1&&(window.miMiniGame(e,e),e.KGMiniAdapter?e.KGMiniAdapter.enable():console.error("请先添加小米小游戏适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-2-0")),r.indexOf("OPPO")>-1&&r.indexOf("MiniGame")>-1&&(window.qgMiniGame(e,e),e.QGMiniAdapter?e.QGMiniAdapter.enable():console.error("请先添加OPPO小游戏适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-3-0")),r.indexOf("VVGame")>-1&&(window.vvMiniGame(e,e),e.VVMiniAdapter?e.VVMiniAdapter.enable():console.error("请先添加VIVO小游戏适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-4-0")),t.trace=console.log,t.requestAnimationFrame=t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||t.oRequestAnimationFrame||t.msRequestAnimationFrame||function(e){return t.setTimeout(e,1e3/60)};var o=n.body.style;o.margin=0,o.overflow="hidden",o["-webkit-user-select"]="none",o["-webkit-tap-highlight-color"]="rgba(200,200,200,0)";for(var l=n.getElementsByTagName("meta"),h=0,u=!1,c="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no";h<l.length;){var _=l[h];if("viewport"==_.name){_.content=c,u=!0;break}h++}return u||((_=n.createElement("meta")).name="viewport",_.content=c,n.getElementsByTagName("head")[0].appendChild(_)),Browser.onMobile=!!window.isConchApp||r.indexOf("Mobile")>-1,Browser.onIOS=!!r.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),Browser.onIPhone=r.indexOf("iPhone")>-1,Browser.onMac=r.indexOf("Mac OS X")>-1,Browser.onIPad=r.indexOf("iPad")>-1||"MacIntel"===s&&a>1,Browser.onAndroid=r.indexOf("Android")>-1||r.indexOf("Adr")>-1,Browser.onWP=r.indexOf("Windows Phone")>-1,Browser.onQQBrowser=r.indexOf("QQBrowser")>-1,Browser.onMQQBrowser=r.indexOf("MQQBrowser")>-1||r.indexOf("Mobile")>-1&&r.indexOf("QQ")>-1,Browser.onIE=!!t.ActiveXObject||"ActiveXObject"in t,Browser.onWeiXin=r.indexOf("MicroMessenger")>-1,Browser.onSafari=r.indexOf("Safari")>-1,Browser.onPC=!Browser.onMobile,Browser.onMiniGame=r.indexOf("MiniGame")>-1,Browser.onBDMiniGame=r.indexOf("SwanGame")>-1,Browser.onLayaRuntime=!!Browser.window.conch,r.indexOf("OPPO")>-1&&r.indexOf("MiniGame")>-1?(Browser.onQGMiniGame=!0,Browser.onMiniGame=!1):"qq"in Browser.window&&r.indexOf("MiniGame")>-1?(Browser.onQQMiniGame=!0,Browser.onMiniGame=!1):"bl"in Browser.window&&r.indexOf("MiniGame")>-1?(Browser.onBLMiniGame=!0,Browser.onMiniGame=!1):"tt"in Browser.window&&r.indexOf("MiniGame")>-1&&(Browser.onTTMiniGame=!0,Browser.onMiniGame=!1),Browser.onHWMiniGame="hbs"in Browser.window,Browser.onVVMiniGame=r.indexOf("VVGame")>-1,Browser.onKGMiniGame=r.indexOf("QuickGame")>-1,r.indexOf("AlipayMiniGame")>-1&&(Browser.onAlipayMiniGame=!0,Browser.onMiniGame=!1),(r.indexOf("TB/")>-1||r.indexOf("Taobao/")>-1||r.indexOf("TM/")>-1)&&(Browser.onTBMiniGame=!0),t}},{key:"createElement",value:function(e){return Browser.__init__(),Browser._document.createElement(e)}},{key:"getElementById",value:function(e){return Browser.__init__(),Browser._document.getElementById(e)}},{key:"removeElement",value:function(e){e&&e.parentNode&&e.parentNode.removeChild(e)}},{key:"now",value:function(){return Date.now()}},{key:"clientWidth",get:function(){return Browser.__init__(),Browser._window.innerWidth||Browser._document.body.clientWidth}},{key:"clientHeight",get:function(){return Browser.__init__(),Browser._window.innerHeight||Browser._document.body.clientHeight||Browser._document.documentElement.clientHeight}},{key:"width",get:function(){return Browser.__init__(),(i.stage&&i.stage.canvasRotation?Browser.clientHeight:Browser.clientWidth)*Browser.pixelRatio}},{key:"height",get:function(){return Browser.__init__(),(i.stage&&i.stage.canvasRotation?Browser.clientWidth:Browser.clientHeight)*Browser.pixelRatio}},{key:"pixelRatio",get:function(){return Browser._pixelRatio<0&&(Browser.__init__(),Browser.userAgent.indexOf("Mozilla/6.0(Linux; Android 6.0; HUAWEI NXT-AL10 Build/HUAWEINXT-AL10)")>-1?Browser._pixelRatio=2:(Browser._pixelRatio=Browser._window.devicePixelRatio||1,Browser._pixelRatio<1&&(Browser._pixelRatio=1))),Browser._pixelRatio}},{key:"container",get:function(){return Browser._container||(Browser.__init__(),Browser._container=Browser.createElement("div"),Browser._container.id="layaContainer",Browser._document.body.appendChild(Browser._container)),Browser._container},set:function(e){Browser._container=e}},{key:"window",get:function(){return Browser._window||Browser.__init__()}},{key:"document",get:function(){return Browser.__init__(),Browser._document}}]),Browser}();Ke._pixelRatio=-1,Ke.mainCanvas=null,Ke.hanzi=new RegExp("^[一-龥]$"),Ke.fontMap=[],Ke.measureText=function(e,t){var i=Ke.hanzi.test(e);if(i&&Ke.fontMap[t])return Ke.fontMap[t];var n=Ke.context;n.font=t;var r=n.measureText(e);return i&&(Ke.fontMap[t]=r),r};var je=function(e){function CharRender_Canvas(e,t){var i,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return _classCallCheck(this,CharRender_Canvas),(i=_possibleConstructorReturn(this,_getPrototypeOf(CharRender_Canvas).call(this))).ctx=null,i.lastScaleX=1,i.lastScaleY=1,i.maxTexW=0,i.maxTexH=0,i.scaleFontSize=!0,i.showDbgInfo=!1,i.supportImageData=!0,i.maxTexW=e,i.maxTexH=t,i.scaleFontSize=n,i.supportImageData=r,i.showDbgInfo=a,CharRender_Canvas.canvas||(CharRender_Canvas.canvas=Ke.createElement("canvas"),CharRender_Canvas.canvas.width=1024,CharRender_Canvas.canvas.height=512,CharRender_Canvas.canvas.style.left="-10000px",CharRender_Canvas.canvas.style.position="absolute",document.body.appendChild(CharRender_Canvas.canvas),i.ctx=CharRender_Canvas.canvas.getContext("2d")),i}return _inherits(CharRender_Canvas,e),_createClass(CharRender_Canvas,[{key:"getWidth",value:function(e,t){return this.ctx?(this.ctx._lastFont!=e&&(this.ctx.font=e,this.ctx._lastFont=e),this.ctx.measureText(t).width):0}},{key:"scale",value:function(e,t){if(!this.supportImageData)return this.lastScaleX=e,void(this.lastScaleY=t);this.lastScaleX==e&&this.lastScaleY==t||(this.ctx.setTransform(e,0,0,t,0,0),this.lastScaleX=e,this.lastScaleY=t)}},{key:"getCharBmp",value:function(e,t,i,n,r,a,s,o,l,h){var u=arguments.length>10&&void 0!==arguments[10]?arguments[10]:null;if(!this.supportImageData)return this.getCharCanvas(e,t,i,n,r,a,s,o,l,h);var c=this.ctx,_=this.fontsz;c.font!=t&&(c.font=t,c._lastFont=t),a.width=c.measureText(e).width;var d=a.width*this.lastScaleX,f=a.height*this.lastScaleY;d+=(s+l)*this.lastScaleX,f+=(o+h)*this.lastScaleY,d=Math.ceil(d),f=Math.ceil(f);var v=(d=Math.min(d,CharRender_Canvas.canvas.width))+2*i+1,p=(f=Math.min(f,CharRender_Canvas.canvas.height))+2*i+1;u&&(v=Math.max(v,u[0]+u[2]+1),p=Math.max(p,u[1]+u[3]+1)),c.clearRect(0,0,v/this.lastScaleX+1,p/this.lastScaleY+1),c.save(),c.textBaseline="middle",i>0&&(c.strokeStyle=r,c.lineWidth=i,c.strokeText(e,s,o+_/2)),n&&(c.fillStyle=n,c.fillText(e,s,o+_/2)),this.showDbgInfo&&(c.strokeStyle="#ff0000",c.strokeRect(1,1,d-2,f-2),c.strokeStyle="#00ff00",c.strokeRect(s,o,a.width,a.height)),u&&(-1==u[2]&&(u[2]=Math.ceil((a.width+2*i)*this.lastScaleX)),u[2]<=0&&(u[2]=1));var g=u?c.getImageData(u[0],u[1],u[2],u[3]+1):c.getImageData(0,0,d,f+1);return c.restore(),a.bmpWidth=g.width,a.bmpHeight=g.height,g}},{key:"getCharCanvas",value:function(e,t,i,n,r,a,s,o,l,h){var u=this.ctx;u.font!=t&&(u.font=t,u._lastFont=t),a.width=u.measureText(e).width;var c=a.width*this.lastScaleX,_=a.height*this.lastScaleY;c+=(s+l)*this.lastScaleX,_+=(o+h)*this.lastScaleY+1,c=Math.min(c,this.maxTexW),_=Math.min(_,this.maxTexH),CharRender_Canvas.canvas.width=Math.min(c+1,this.maxTexW),CharRender_Canvas.canvas.height=Math.min(_+1,this.maxTexH),u.font=t,u.clearRect(0,0,c+1+i,_+1+i),u.setTransform(1,0,0,1,0,0),u.save(),this.scaleFontSize&&u.scale(this.lastScaleX,this.lastScaleY),u.translate(s,o),u.textAlign="left";var d=this.fontsz;return u.textBaseline="middle",i>0?(u.strokeStyle=r,u.fillStyle=n,u.lineWidth=i,u.fillAndStrokeText?u.fillAndStrokeText(e,0,d/2):(u.strokeText(e,0,d/2),u.fillText(e,0,d/2))):n&&(u.fillStyle=n,u.fillText(e,0,d/2)),this.showDbgInfo&&(u.strokeStyle="#ff0000",u.strokeRect(0,0,c,_),u.strokeStyle="#00ff00",u.strokeRect(0,0,a.width,a.height)),u.restore(),a.bmpWidth=CharRender_Canvas.canvas.width,a.bmpHeight=CharRender_Canvas.canvas.height,CharRender_Canvas.canvas}},{key:"canvasWidth",get:function(){return CharRender_Canvas.canvas.width},set:function(e){CharRender_Canvas.canvas.width!=e&&(CharRender_Canvas.canvas.width=e,e>2048&&console.warn("画文字设置的宽度太大，超过2048了"),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.lastScaleX,this.lastScaleY))}}]),CharRender_Canvas}(ze);je.canvas=null;var Qe=function(e){function CharRender_Native(){var e;return _classCallCheck(this,CharRender_Native),(e=_possibleConstructorReturn(this,_getPrototypeOf(CharRender_Native).call(this))).lastFont="",e.lastScaleX=1,e.lastScaleY=1,e}return _inherits(CharRender_Native,e),_createClass(CharRender_Native,[{key:"getWidth",value:function(e,t){return window.conchTextCanvas?(window.conchTextCanvas.font=e,this.lastFont=e,window.conchTextCanvas.measureText(t).width):0}},{key:"scale",value:function(e,t){this.lastScaleX=e,this.lastScaleY=t}},{key:"getCharBmp",value:function(e,t,i,n,r,a,s,o,l,h){arguments.length>10&&void 0!==arguments[10]&&arguments[10];if(!window.conchTextCanvas)return null;window.conchTextCanvas.font=t,this.lastFont=t;a.width=window.conchTextCanvas.measureText(e).width,a.height;window.conchTextCanvas.scale&&window.conchTextCanvas.scale(this.lastScaleX,this.lastScaleY);var u=Q.create(r),c=u.numColor,_=Q.create(n),d=_.numColor,f=window.conchTextCanvas.getTextBitmapData(e,d,i>2?2:i,c);return a.bmpWidth=f.width,a.bmpHeight=f.height,f}}]),CharRender_Native}(ze),qe=function(){function TextRender(){_classCallCheck(this,TextRender),this.fontSizeInfo={},this.mapFont={},this.fontID=0,this.mapColor=[],this.colorID=0,this.fontScaleX=1,this.fontScaleY=1,this._curStrPos=0,this.textAtlases=[],this.isoTextures=[],this.lastFont=null,this.fontSizeW=0,this.fontSizeH=0,this.fontSizeOffX=0,this.fontSizeOffY=0,this.renderPerChar=!0,this.tmpAtlasPos=new v,this.textureMem=0,i.TextAtlas=Ne;var e=!1,t=i.Laya.MiniAdpter;t&&t.systemInfo&&t.systemInfo.system&&(e="ios 10.1.1"===t.systemInfo.system.toLowerCase()),(i.Browser.onMiniGame||i.Browser.onTTMiniGame||i.Browser.onBLMiniGame||i.Browser.onAlipayMiniGame||i.Browser.onTBMiniGame)&&!e&&(TextRender.isWan1Wan=!0),this.charRender=i.Render.isConchApp?new Qe:new je(2048,2048,TextRender.scaleFontWithCtx,!TextRender.isWan1Wan,!1),TextRender.textRenderInst=this,i.Laya.textRender=this,TextRender.atlasWidth2=TextRender.atlasWidth*TextRender.atlasWidth}return _createClass(TextRender,[{key:"setFont",value:function(e){if(this.lastFont!=e){this.lastFont=e;var t=this.getFontSizeInfo(e._family),i=t>>24,n=t>>16&255,r=t>>8&255,a=255&t,s=e._size/TextRender.standardFontSize;this.fontSizeOffX=Math.ceil(i*s),this.fontSizeOffY=Math.ceil(n*s),this.fontSizeW=Math.ceil(r*s),this.fontSizeH=Math.ceil(a*s),e._font.indexOf("italic")>=0?this.fontStr=e._font.replace("italic",""):this.fontStr=e._font}}},{key:"getNextChar",value:function(e){var t=e.length,i=this._curStrPos;if(!e.substring)return null;if(i>=t)return null;for(var n=i,r=0;n<t;n++){var a=e.charCodeAt(n);if(a>>>11==27){if(1==r)break;r=1,n++}else if(65038===a||65039===a);else if(8205==a)r=2;else if(0==r)r=1;else if(1==r)break}return this._curStrPos=n,e.substring(i,n)}},{key:"filltext",value:function(e,t,n,r,a,s,o,l,h){var u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0;if(!(t.length<=0)){var c=He.Parse(a),_=0;switch(h){case"center":_=i.Context.ENUM_TEXTALIGN_CENTER;break;case"right":_=i.Context.ENUM_TEXTALIGN_RIGHT}this._fast_filltext(e,t,null,n,r,c,s,o,l,_,u)}}},{key:"fillWords",value:function(e,t,i,n,r,a,s,o){if(t&&!(t.length<=0)){var l="string"==typeof r?He.Parse(r):r;this._fast_filltext(e,null,t,i,n,l,a,s,o,0,0)}}},{key:"_fast_filltext",value:function(e,t,n,r,a,s,o,l,h,u){arguments.length>10&&void 0!==arguments[10]&&arguments[10];if((!t||t.length>=1)&&!(n&&n.length<1)){if(h<0&&(h=0),this.setFont(s),this.fontScaleX=this.fontScaleY=1,TextRender.scaleFontWithCtx){var c=1,_=1;if(i.Render.isConchApp&&!window.conchTextCanvas.scale||(c=e.getMatScaleX(),_=e.getMatScaleY()),c<1e-4||_<.1)return;c>1&&(this.fontScaleX=c),_>1&&(this.fontScaleY=_)}s._italic&&(e._italicDeg=13);var d=t,f=!n&&t instanceof Ye,v=t&&t.toString(),p=!!n,g=f?d.pageChars:[],y=0;switch(f?(v=d._text,(y=d.width)<0&&(y=d.width=this.charRender.getWidth(this.fontStr,v))):y=v?this.charRender.getWidth(this.fontStr,v):0,u){case i.Context.ENUM_TEXTALIGN_CENTER:r-=y/2;break;case i.Context.ENUM_TEXTALIGN_RIGHT:r-=y}d&&g&&this.hasFreedText(g)&&(g=d.pageChars=[]);var m=null,T=this.renderPerChar=!f||TextRender.forceSplitRender||p||f&&d.splitRender;if(!g||g.length<1)if(f&&(d.scalex=this.fontScaleX,d.scaley=this.fontScaleY),T){var C,x=0,k=0;for(this._curStrPos=0;;){if(n){var S=n[this._curStrPos++];S?(C=S.char,x=S.x,k=S.y):C=null}else C=this.getNextChar(v);if(!C)break;if(!(m=this.getCharRenderInfo(C,s,o,l,h,!1)))break;if(m.isSpace);else{var R=g[m.tex.id];if(R)R=R.words;else{var b={texgen:m.tex.genID,tex:m.tex,words:[]};g[m.tex.id]=b,R=b.words}R.push({ri:m,x:x,y:k,w:m.bmpWidth/this.fontScaleX,h:m.bmpHeight/this.fontScaleY}),x+=m.width}}}else{var E=i.Render.isConchApp?0:s._size/3|0,M=TextRender.noAtlas||(y+E+E)*this.fontScaleX>TextRender.atlasWidth;m=this.getCharRenderInfo(v,s,o,l,h,M),g[0]={texgen:m.tex.genID,tex:m.tex,words:[{ri:m,x:0,y:0,w:m.bmpWidth/this.fontScaleX,h:m.bmpHeight/this.fontScaleY}]}}this._drawResortedWords(e,r,a,g),e._italicDeg=0}}},{key:"_drawResortedWords",value:function(e,t,n,r){var a=!!e._charSubmitCache&&e._charSubmitCache._enable,s=e._curMat;r.length;for(var o in r){var l=r[o];if(l){var h=l.words,u=h.length;if(!(u<=0))for(var c=r[o].tex,_=0;_<u;_++){var d=h[_],f=d.ri;if(!f.isSpace){if(f.touch(),e.drawTexAlign=!0,i.Render.isConchApp)e._drawTextureM(c.texture,t+d.x-f.orix,n+d.y-f.oriy,d.w,d.h,null,1,f.uv);else{var v=c;e._inner_drawTexture(v.texture,v.id,t+d.x-f.orix,n+d.y-f.oriy,d.w,d.h,s,f.uv,1,a)}e.touches&&e.touches.push(f)}}}}}},{key:"hasFreedText",value:function(e){for(var t in e){var i=e[t];if(i){var n=i.tex;if(n.__destroyed||n.genID!=i.texgen)return!0}}return!1}},{key:"getCharRenderInfo",value:function(e,t,n,r,a){var s=arguments.length>5&&void 0!==arguments[5]&&arguments[5],o=this.mapFont[t._family];null==o&&(this.mapFont[t._family]=o=this.fontID++);var l=e+"_"+o+"_"+t._size+"_"+n;a>0&&(l+="_"+r+a),t._bold&&(l+="P"),1==this.fontScaleX&&1==this.fontScaleY||(l+=(20*this.fontScaleX|0)+"_"+(20*this.fontScaleY|0));var h,u,c=0,_=this.textAtlases.length;if(!s)for(c=0;c<_;c++)if(h=(u=this.textAtlases[c]).charMaps[l])return h.touch(),h;h=new Xe,this.charRender.scale(this.fontScaleX,this.fontScaleY),h.char=e,h.height=t._size;var d=i.Render.isConchApp?0:t._size/3|0,f=null;a||(a=0);var v=Math.ceil((this.charRender.getWidth(this.fontStr,e)+2*a)*this.fontScaleX);if(v>this.charRender.canvasWidth&&(this.charRender.canvasWidth=Math.min(2048,v+2*d)),s){if(this.charRender.fontsz=t._size,f=this.charRender.getCharBmp(e,this.fontStr,a,n,r,h,d,d,d,d,null)){var p=Ue.getTextTexture(f.width,f.height);p.addChar(f,0,0,h.uv),h.tex=p,h.orix=d,h.oriy=d,p.ri=h,this.isoTextures.push(p)}}else{var g=e.length,y=1*a,m=Math.ceil((this.fontSizeW+2*y)*this.fontScaleX),T=Math.ceil((this.fontSizeH+2*y)*this.fontScaleY);TextRender.imgdtRect[0]=(d-this.fontSizeOffX-y)*this.fontScaleX|0,TextRender.imgdtRect[1]=(d-this.fontSizeOffY-y)*this.fontScaleY|0,this.renderPerChar||1==g?(TextRender.imgdtRect[2]=Math.max(v,m),TextRender.imgdtRect[3]=Math.max(v,T)):(TextRender.imgdtRect[2]=-1,TextRender.imgdtRect[3]=T),this.charRender.fontsz=t._size,(f=this.charRender.getCharBmp(e,this.fontStr,a,n,r,h,d,d,d,d,TextRender.imgdtRect))&&(u=this.addBmpData(f,h),TextRender.isWan1Wan?(h.orix=d,h.oriy=d):(h.orix=this.fontSizeOffX+y,h.oriy=this.fontSizeOffY+y),u.charMaps[l]=h)}return h}},{key:"addBmpData",value:function(e,t){for(var i,n=e.width,r=e.height,a=this.textAtlases.length,s=!1,o=0;o<a&&!(s=(i=this.textAtlases[o]).getAEmpty(n,r,this.tmpAtlasPos));o++);if(!s){if(i=new Ne,this.textAtlases.push(i),!(s=i.getAEmpty(n,r,this.tmpAtlasPos)))throw"err1";this.cleanAtlases()}return s&&(i.texture.addChar(e,this.tmpAtlasPos.x,this.tmpAtlasPos.y,t.uv),t.tex=i.texture),i}},{key:"GC",value:function(){for(var e=0,t=this.textAtlases.length,i=TextRender.destroyAtlasDt,n=0,r=ye.loopCount,a=-1,s=0,o=null,l=null;e<t;e++){if(o=(l=this.textAtlases[e]).texture){o.curUsedCovRate,n+=o.curUsedCovRateAtlas;var h=l.usedRate-o.curUsedCovRateAtlas;s<h&&(s=h,a=e)}r-l.texture.lastTouchTm>i&&(TextRender.showLog&&console.log(l.texture.id),l.destroy(),this.textAtlases[e]=this.textAtlases[t-1],t--,e--,a=-1)}for(this.textAtlases.length=t,t=this.isoTextures.length,e=0;e<t;e++)r-(o=this.isoTextures[e]).lastTouchTm>TextRender.destroyUnusedTextureDt&&(o.ri.deleted=!0,o.ri.tex=null,o.destroy(),this.isoTextures[e]=this.isoTextures[t-1],t--,e--);this.isoTextures.length=t;var u=this.textAtlases.length>1&&this.textAtlases.length-n>=2;(TextRender.atlasWidth*TextRender.atlasWidth*4*this.textAtlases.length>TextRender.cleanMem||u||TextRender.simClean)&&(TextRender.simClean=!1,TextRender.showLog&&console.log("清理使用率低的贴图。总使用率:",n,":",this.textAtlases.length,"最差贴图:"+a),a>=0&&((l=this.textAtlases[a]).destroy(),this.textAtlases[a]=this.textAtlases[this.textAtlases.length-1],this.textAtlases.length=this.textAtlases.length-1)),Ue.clean()}},{key:"cleanAtlases",value:function(){}},{key:"getCharBmp",value:function(e){}},{key:"checkBmpLine",value:function(e,t,i,n){this.bmpData32.buffer!=e.data.buffer&&(this.bmpData32=new Uint32Array(e.data.buffer));for(var r=e.width*t+i,a=i;a<n;a++)if(0!=this.bmpData32[r++])return!0;return!1}},{key:"updateBbx",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=e.width,r=e.height,a=0,s=t[1],o=0,l=s;if(this.checkBmpLine(e,s,0,n))for(;;){if((l=(s+o)/2|0)+1>=s){t[1]=l;break}this.checkBmpLine(e,l,0,n)?s=l:o=l}if(t[3]>r)t[3]=r;else if(l=s=t[3],o=r,this.checkBmpLine(e,s,0,n))for(;;){if((l=(s+o)/2|0)-1<=s){t[3]=l;break}this.checkBmpLine(e,l,0,n)?s=l:o=l}if(!i){var h=t[0],u=n*t[1];for(l=t[1];l<t[3];l++){for(a=0;a<h;a++)if(0!=this.bmpData32[u+a]){h=a;break}u+=n}t[0]=h;var c=t[2];for(u=n*t[1],l=t[1];l<t[3];l++){for(a=c;a<n;a++)if(0!=this.bmpData32[u+a]){c=a;break}u+=n}t[2]=c}}},{key:"getFontSizeInfo",value:function(e){var t=this.fontSizeInfo[e];if(null!=t)return t;var n="bold "+TextRender.standardFontSize+"px "+e;if(TextRender.isWan1Wan){this.fontSizeW=1.5*this.charRender.getWidth(n,"有"),this.fontSizeH=1.5*TextRender.standardFontSize;var r=this.fontSizeW<<8|this.fontSizeH;return this.fontSizeInfo[e]=r,r}TextRender.pixelBBX[0]=TextRender.standardFontSize/2,TextRender.pixelBBX[1]=TextRender.standardFontSize/2,TextRender.pixelBBX[2]=TextRender.standardFontSize,TextRender.pixelBBX[3]=TextRender.standardFontSize;var a=16,s=16;this.charRender.scale(1,1),TextRender.tmpRI.height=TextRender.standardFontSize,this.charRender.fontsz=TextRender.standardFontSize;var o=this.charRender.getCharBmp("g",n,0,"red",null,TextRender.tmpRI,a,s,16,16);i.Render.isConchApp&&(o.data=new Uint8ClampedArray(o.data)),this.bmpData32=new Uint32Array(o.data.buffer),this.updateBbx(o,TextRender.pixelBBX,!1),o=this.charRender.getCharBmp("有",n,0,"red",null,TextRender.tmpRI,s,s,16,16),i.Render.isConchApp&&(o.data=new Uint8ClampedArray(o.data)),this.bmpData32=new Uint32Array(o.data.buffer),TextRender.pixelBBX[2]<a+TextRender.tmpRI.width&&(TextRender.pixelBBX[2]=a+TextRender.tmpRI.width),this.updateBbx(o,TextRender.pixelBBX,!1),i.Render.isConchApp&&(a=0,s=0);var l=Math.max(a-TextRender.pixelBBX[0],0)<<24|Math.max(s-TextRender.pixelBBX[1],0)<<16|TextRender.pixelBBX[2]-TextRender.pixelBBX[0]<<8|TextRender.pixelBBX[3]-TextRender.pixelBBX[1];return this.fontSizeInfo[e]=l,l}},{key:"printDbgInfo",value:function(){for(var e in console.log("图集个数:"+this.textAtlases.length+",每个图集大小:"+TextRender.atlasWidth+"x"+TextRender.atlasWidth," 用canvas:",TextRender.isWan1Wan),console.log("图集占用空间:"+TextRender.atlasWidth*TextRender.atlasWidth*4/1024/1024*this.textAtlases.length+"M"),console.log("缓存用到的字体:"),this.mapFont){var t=this.getFontSizeInfo(e),i=t>>24,n=t>>16&255,r=t>>8&255,a=255&t;console.log("    "+e," off:",i,n," size:",r,a)}var s=0;console.log("缓存数据:");var o=0,l=0;this.textAtlases.forEach((function(e){var t=e.texture.id,i=ye.loopCount-e.texture.lastTouchTm,n=i>0?i+"帧以前":"当前帧";for(var r in o+=e.texture.curUsedCovRate,l+=e.texture.curUsedCovRateAtlas,console.log("--图集(id:"+t+",当前使用率:"+(1e3*e.texture.curUsedCovRate|0)+"‰","当前图集使用率:",(100*e.texture.curUsedCovRateAtlas|0)+"%","图集使用率:",100*e.usedRate|0,"%, 使用于:"+n+")--:"),e.charMaps){var a=e.charMaps[r];console.log("     off:",a.orix,a.oriy," bmp宽高:",a.bmpWidth,a.bmpHeight,"无效:",a.deleted,"touchdt:",ye.loopCount-a.touchTick,"位置:",a.uv[0]*TextRender.atlasWidth|0,a.uv[1]*TextRender.atlasWidth|0,"字符:",a.char,"key:",r),s++}})),console.log("独立贴图文字("+this.isoTextures.length+"个):"),this.isoTextures.forEach((function(e){console.log("    size:",e._texW,e._texH,"touch间隔:",ye.loopCount-e.lastTouchTm,"char:",e.ri.char)})),console.log("总缓存:",s,"总使用率:",o,"总当前图集使用率:",l)}},{key:"showAtlas",value:function(e,t,n,r,a,s){if(!this.textAtlases[e])return console.log("没有这个图集"),null;var o=new i.Sprite,l=this.textAtlases[e].texture,h={width:TextRender.atlasWidth,height:TextRender.atlasWidth,sourceWidth:TextRender.atlasWidth,sourceHeight:TextRender.atlasWidth,offsetX:0,offsetY:0,getIsReady:function(){return!0},_addReference:function(){},_removeReference:function(){},_getSource:function(){return l._getSource()},bitmap:{id:l.id},_uv:Ve.DEF_UV};return o.size=function(e,i){return this.width=e,this.height=i,o.graphics.clear(),o.graphics.drawRect(0,0,o.width,o.height,t),o.graphics.drawTexture(h,0,0,o.width,o.height),this},o.graphics.drawRect(0,0,a,s,t),o.graphics.drawTexture(h,0,0,a,s),o.pos(n,r),i.stage.addChild(o),o}},{key:"filltext_native",value:function(e,t,n,r,a,s,o,l,h,u){var c=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0;if(!(t&&t.length<=0||n&&n.length<1)){var _=He.Parse(s),d=0;switch(u){case"center":d=i.Context.ENUM_TEXTALIGN_CENTER;break;case"right":d=i.Context.ENUM_TEXTALIGN_RIGHT}return this._fast_filltext(e,t,n,r,a,_,o,l,h,d,c)}}}]),TextRender}();qe.useOldCharBook=!1,qe.atlasWidth=1024,qe.noAtlas=!1,qe.forceSplitRender=!1,qe.forceWholeRender=!1,qe.scaleFontWithCtx=!0,qe.standardFontSize=32,qe.destroyAtlasDt=10,qe.checkCleanTextureDt=2e3,qe.destroyUnusedTextureDt=3e3,qe.cleanMem=104857600,qe.isWan1Wan=!1,qe.showLog=!1,qe.debugUV=!1,qe.tmpRI=new Xe,qe.pixelBBX=[0,0,0,0],qe.imgdtRect=[0,0,0,0],qe.simClean=!1,Ue.gTextRender=qe;var Ze=function(){function Context(){if(_classCallCheck(this,Context),this._tmpMatrix=new f,this._drawTexToDrawTri_Vert=new Float32Array(8),this._drawTexToDrawTri_Index=new Uint16Array([0,1,2,0,2,3]),this._tempUV=new Float32Array(8),this._drawTriUseAbsMatrix=!1,this._id=++Context._COUNT,this._other=null,this._renderNextSubmitIndex=0,this._path=null,this._drawCount=1,this._width=Context._MAXSIZE,this._height=Context._MAXSIZE,this._renderCount=0,this._submits=null,this._curSubmit=null,this._submitKey=new X,this._mesh=null,this._pathMesh=null,this._triangleMesh=null,this.meshlist=[],this._transedPoints=new Array(8),this._temp4Points=new Array(8),this._clipRect=Context.MAXCLIPRECT,this._globalClipMatrix=new f(Context._MAXSIZE,0,0,Context._MAXSIZE,0,0),this._clipInCache=!1,this._clipInfoID=0,this._clipID_Gen=0,this._lastMatScaleX=1,this._lastMatScaleY=1,this._lastMat_a=1,this._lastMat_b=0,this._lastMat_c=0,this._lastMat_d=1,this._nBlendType=0,this._save=null,this._targets=null,this._charSubmitCache=null,this._saveMark=null,this._shader2D=new Ee,this.sprite=null,this._italicDeg=0,this._lastTex=null,this._fillColor=0,this._flushCnt=0,this.defTexture=null,this._colorFiler=null,this.drawTexAlign=!1,this._incache=!1,this.isMain=!1,Context._contextcount++,Context._textRender=Context._textRender||new qe,!this.defTexture){var e=new w(2,2);e.setPixels(new Uint8Array(16)),e.lock=!0,this.defTexture=new Ve(e)}this._lastTex=this.defTexture,this.clear()}return _createClass(Context,[{key:"drawImage",value:function(){}},{key:"getImageData",value:function(){}},{key:"measureText",value:function(e){return null}},{key:"setTransform",value:function(){}},{key:"$transform",value:function(e,t,i,n,r,a){}},{key:"clearRect",value:function(e,t,i,n){}},{key:"_drawRect",value:function(e,t,i,n,r){N.renderBatches++,r&&(this.fillStyle=r),this.fillRect(e,t,i,n,null)}},{key:"drawTexture2",value:function(e,t,i,n,r,a){}},{key:"transformByMatrix",value:function(e,t,i){this.transform(e.a,e.b,e.c,e.d,e.tx+t,e.ty+i)}},{key:"saveTransform",value:function(e){this.save()}},{key:"restoreTransform",value:function(e){this.restore()}},{key:"drawRect",value:function(e,t,i,n,r,a,s){null!=r&&(this.fillStyle=r,this.fillRect(e,t,i,n)),null!=a&&(this.strokeStyle=a,this.lineWidth=s,this.strokeRect(e,t,i,n))}},{key:"alpha",value:function(e){this.globalAlpha*=e}},{key:"_transform",value:function(e,t,i){this.translate(t,i),this.transform(e.a,e.b,e.c,e.d,e.tx,e.ty),this.translate(-t,-i)}},{key:"_rotate",value:function(e,t,i){this.translate(t,i),this.rotate(e),this.translate(-t,-i)}},{key:"_scale",value:function(e,t,i,n){this.translate(i,n),this.scale(e,t),this.translate(-i,-n)}},{key:"_drawLine",value:function(e,t,i,n,r,a,s,o,l){this.beginPath(),this.strokeStyle=s,this.lineWidth=o,this.moveTo(e+i,t+n),this.lineTo(e+r,t+a),this.stroke()}},{key:"_drawLines",value:function(e,t,i,n,r,a){this.beginPath(),this.strokeStyle=n,this.lineWidth=r,this.addPath(i.slice(),!1,!1,e,t),this.stroke()}},{key:"drawCurves",value:function(e,t,i,n,r){this.beginPath(),this.strokeStyle=n,this.lineWidth=r,this.moveTo(e+i[0],t+i[1]);for(var a=2,s=i.length;a<s;)this.quadraticCurveTo(e+i[a++],t+i[a++],e+i[a++],t+i[a++]);this.stroke()}},{key:"_fillAndStroke",value:function(e,t,i){arguments.length>3&&void 0!==arguments[3]&&arguments[3];null!=e&&(this.fillStyle=e,this.fill()),null!=t&&i>0&&(this.strokeStyle=t,this.lineWidth=i,this.stroke())}},{key:"_drawCircle",value:function(e,t,i,n,r,a,s){N.renderBatches++,this.beginPath(!0),this.arc(e,t,i,0,Context.PI2),this.closePath(),this._fillAndStroke(n,r,a)}},{key:"_drawPie",value:function(e,t,i,n,r,a,s,o,l){this.beginPath(),this.moveTo(e,t),this.arc(e,t,i,n,r),this.closePath(),this._fillAndStroke(a,s,o)}},{key:"_drawPoly",value:function(e,t,i,n,r,a,s,o){this.beginPath(),this.addPath(i.slice(),!0,s,e,t),this.closePath(),this._fillAndStroke(n,r,a,s)}},{key:"_drawPath",value:function(e,t,i,n,r){this.beginPath();for(var a=0,s=i.length;a<s;a++){var o=i[a];switch(o[0]){case"moveTo":this.moveTo(e+o[1],t+o[2]);break;case"lineTo":this.lineTo(e+o[1],t+o[2]);break;case"arcTo":this.arcTo(e+o[1],t+o[2],e+o[3],t+o[4],o[5]);break;case"closePath":this.closePath()}}null!=n&&(this.fillStyle=n.fillStyle,this.fill()),null!=r&&(this.strokeStyle=r.strokeStyle,this.lineWidth=r.lineWidth||1,this.lineJoin=r.lineJoin,this.lineCap=r.lineCap,this.miterLimit=r.miterLimit,this.stroke())}},{key:"clearBG",value:function(e,t,i,n){var r=y.mainContext;r.clearColor(e,t,i,n),r.clear(r.COLOR_BUFFER_BIT)}},{key:"_getSubmits",value:function(){return this._submits}},{key:"_releaseMem",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._submits){this._curMat&&this._curMat.destroy(),this._curMat=null,this._shader2D.destroy(),this._shader2D=null,this._charSubmitCache.clear();for(var t=0,i=this._submits._length;t<i;t++)this._submits[t].releaseRender();var n;for(this._submits.length=0,this._submits._length=0,this._submits=null,this._curSubmit=null,this._path=null,this._save=null,t=0,n=this.meshlist.length;t<n;t++){var r=this.meshlist[t];r.destroy()}this.meshlist.length=0,this.sprite=null,e||(this._targets&&this._targets.destroy(),this._targets=null)}}},{key:"destroy",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];--Context._contextcount,this.sprite=null,this._releaseMem(e),this._charSubmitCache.destroy(),this._mesh.destroy(),e||(this._targets&&this._targets.destroy(),this._targets=null)}},{key:"clear",value:function(){this._submits||(this._other=$e.DEFAULT,this._curMat=f.create(),this._charSubmitCache=new Fe,this._mesh=ke.getAMesh(this.isMain),this.meshlist.push(this._mesh),this._pathMesh=Re.getAMesh(this.isMain),this.meshlist.push(this._pathMesh),this._triangleMesh=Se.getAMesh(this.isMain),this.meshlist.push(this._triangleMesh),this._submits=[],this._save=[_e.Create(this)],this._save.length=10,this._shader2D=new Ee),this._submitKey.clear(),this._mesh.clearVB(),this._drawCount=1,this._other=$e.DEFAULT,this._other.lineWidth=this._shader2D.ALPHA=1,this._nBlendType=0,this._clipRect=Context.MAXCLIPRECT,this._curSubmit=he.RENDERBASE,he.RENDERBASE._ref=16777215,he.RENDERBASE._numEle=0,this._shader2D.fillStyle=this._shader2D.strokeStyle=se.DEFAULT;for(var e=0,t=this._submits._length;e<t;e++)this._submits[e].releaseRender();this._submits._length=0,this._curMat.identity(),this._other.clear(),this._saveMark=this._save[0],this._save._length=1}},{key:"size",value:function(t,i){this._width==t&&this._height==i||(this._width=t,this._height=i,this._targets&&(this._targets.destroy(),this._targets=new B(t,i,e.RenderTextureFormat.R8G8B8A8,-1)),this.isMain&&(y.mainContext.viewport(0,0,t,i),D.width=t,D.height=i)),0===t&&0===i&&this._releaseMem()}},{key:"getMatScaleX",value:function(){return this._lastMat_a==this._curMat.a&&this._lastMat_b==this._curMat.b?this._lastMatScaleX:(this._lastMatScaleX=this._curMat.getScaleX(),this._lastMat_a=this._curMat.a,this._lastMat_b=this._curMat.b,this._lastMatScaleX)}},{key:"getMatScaleY",value:function(){return this._lastMat_c==this._curMat.c&&this._lastMat_d==this._curMat.d?this._lastMatScaleY:(this._lastMatScaleY=this._curMat.getScaleY(),this._lastMat_c=this._curMat.c,this._lastMat_d=this._curMat.d,this._lastMatScaleY)}},{key:"setFillColor",value:function(e){this._fillColor=e}},{key:"getFillColor",value:function(){return this._fillColor}},{key:"translate",value:function(e,t){0===e&&0===t||(fe.save(this),this._curMat._bTransform?(de.save(this),this._curMat.tx+=e*this._curMat.a+t*this._curMat.c,this._curMat.ty+=e*this._curMat.b+t*this._curMat.d):(this._curMat.tx=e,this._curMat.ty=t))}},{key:"save",value:function(){this._save[this._save._length++]=_e.Create(this)}},{key:"restore",value:function(){var e=this._save._length,t=this._nBlendType;if(!(e<1)){for(var i=e-1;i>=0;i--){var n=this._save[i];if(n.restore(this),n.isSaveMark())return void(this._save._length=i)}t!=this._nBlendType&&(this._curSubmit=he.RENDERBASE)}}},{key:"fillText",value:function(e,t,i,n,r,a){var s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:"";Context._textRender.filltext(this,e,t,i,n,r,o,s,a)}},{key:"drawText",value:function(e,t,i,n,r,a){Context._textRender.filltext(this,e,t,i,n,r,null,0,a)}},{key:"fillWords",value:function(e,t,i,n,r){Context._textRender.fillWords(this,e,t,i,n,r,null,0)}},{key:"strokeWord",value:function(e,t,i,n,r,a,s){Context._textRender.filltext(this,e,t,i,n,null,r,a,s)}},{key:"fillBorderText",value:function(e,t,i,n,r,a,s,o){Context._textRender.filltext(this,e,t,i,n,r,a,s,o)}},{key:"fillBorderWords",value:function(e,t,i,n,r,a,s){Context._textRender.fillWords(this,e,t,i,n,r,a,s)}},{key:"_fast_filltext",value:function(e,t,i,n,r,a,s,o){var l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0;Context._textRender._fast_filltext(this,e,null,t,i,n,r,a,s,o,l)}},{key:"_fillRect",value:function(e,t,i,n,r){var a=this._curSubmit,s=a&&a._key.submitType===he.KEY_DRAWTEXTURE&&a._key.blendShader===this._nBlendType;this._mesh.vertNum+4>Context._MAXVERTNUM&&(this._mesh=ke.getAMesh(this.isMain),this.meshlist.push(this._mesh),s=!1),s&&(s=s&&this.isSameClipInfo(a)),this.transformQuad(e,t,i,n,0,this._curMat,this._transedPoints),this.clipedOff(this._transedPoints)||(this._mesh.addQuad(this._transedPoints,Ve.NO_UV,r,!1),s||(a=this._curSubmit=Oe.create(this,this._mesh,Y.create(U.TEXTURE2D,0)),this._submits[this._submits._length++]=a,this._copyClipInfo(a,this._globalClipMatrix),a.shaderValue.textureHost=this._lastTex,a._key.other=this._lastTex&&this._lastTex.bitmap?this._lastTex.bitmap.id:-1,a._renderType=he.TYPE_TEXTURE),this._curSubmit._numEle+=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4)}},{key:"fillRect",value:function(e,t,i,n,r){var a=r?se.create(r):this._shader2D.fillStyle,s=this.mixRGBandAlpha(a.toInt());this._fillRect(e,t,i,n,s)}},{key:"fillTexture",value:function(e,t,n,r,a,s,o,l){e._getSource()?this._fillTexture(e,e.width,e.height,e.uvrect,t,n,r,a,s,o.x,o.y):this.sprite&&i.systemTimer.callLater(this,this._repaintSprite)}},{key:"_fillTexture",value:function(e,t,i,n,r,a,s,o,l,h,u){var c=this._curSubmit;this._mesh.vertNum+4>Context._MAXVERTNUM&&(this._mesh=ke.getAMesh(this.isMain),this.meshlist.push(this._mesh));var _=!0,d=!0;switch(l){case"repeat":break;case"repeat-x":d=!1;break;case"repeat-y":_=!1;break;case"no-repeat":_=d=!1}var f=this._temp4Points,v=0,p=0,g=0,y=0,m=0,T=0;if(h<0?(g=r,v=-h%t/t):g=r+h,u<0?(y=a,p=-u%i/i):y=a+u,m=r+s,T=a+o,!_&&(m=Math.min(m,r+h+t)),!d&&(T=Math.min(T,a+u+i)),!(m<r||T<a||g>m||y>T)){var C=(m-r-h)/t,x=(T-a-u)/i;if(this.transformQuad(g,y,m-g,T-y,0,this._curMat,this._transedPoints),f[0]=v,f[1]=p,f[2]=C,f[3]=p,f[4]=C,f[5]=x,f[6]=v,f[7]=x,!this.clipedOff(this._transedPoints)){var k=this._mixRGBandAlpha(4294967295,this._shader2D.ALPHA);this._mesh.addQuad(this._transedPoints,f,k,!0);var S=Y.create(U.TEXTURE2D,0);S.defines.add(U.FILLTEXTURE),S.u_TexRange=n.concat(),c=this._curSubmit=Oe.create(this,this._mesh,S),this._submits[this._submits._length++]=c,this._copyClipInfo(c,this._globalClipMatrix),c.shaderValue.textureHost=e,c._renderType=he.TYPE_TEXTURE,this._curSubmit._numEle+=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4}this.breakNextMerge()}}},{key:"setColorFilter",value:function(e){ue.save(this,ue.TYPE_COLORFILTER,this,!0),this._colorFiler=e,this._curSubmit=he.RENDERBASE}},{key:"drawTexture",value:function(e,t,i,n,r){this._drawTextureM(e,t,i,n,r,null,1,null)}},{key:"drawTextures",value:function(e,t,n,r){if(e._getSource())for(var a=t.length/2,s=0,o=e.bitmap.id,l=0;l<a;l++)this._inner_drawTexture(e,o,t[s++]+n,t[s++]+r,0,0,null,null,1,!1);else this.sprite&&i.systemTimer.callLater(this,this._repaintSprite)}},{key:"_drawTextureAddSubmit",value:function(e,t){var i=null;i=Oe.create(this,this._mesh,Y.create(U.TEXTURE2D,0)),this._submits[this._submits._length++]=i,i.shaderValue.textureHost=t,i._key.other=e,i._renderType=he.TYPE_TEXTURE,this._curSubmit=i}},{key:"_drawTextureM",value:function(e,t,i,n,r,a,s,o){var l=this.sprite;return!!e._getSource((function(){l&&l.repaint()}))&&this._inner_drawTexture(e,e.bitmap.id,t,i,n,r,a,o,s,!1)}},{key:"_drawRenderTexture",value:function(e,t,i,n,r,a,s,o){return this._inner_drawTexture(e,-1,t,i,n,r,a,o,1,!1)}},{key:"submitDebugger",value:function(){this._submits[this._submits._length++]=z.create([],(function(){}),this)}},{key:"_copyClipInfo",value:function(e,t){var i=e.shaderValue.clipMatDir;i[0]=t.a,i[1]=t.b,i[2]=t.c,i[3]=t.d;var n=e.shaderValue.clipMatPos;n[0]=t.tx,n[1]=t.ty,e.clipInfoID=this._clipInfoID,this._clipInCache&&(e.shaderValue.clipOff[0]=1)}},{key:"isSameClipInfo",value:function(e){return e.clipInfoID===this._clipInfoID}},{key:"_useNewTex2DSubmit",value:function(e,t){this._mesh.vertNum+t>Context._MAXVERTNUM&&(this._mesh=ke.getAMesh(this.isMain),this.meshlist.push(this._mesh));var i=Oe.create(this,this._mesh,Y.create(U.TEXTURE2D,0));this._submits[this._submits._length++]=this._curSubmit=i,i.shaderValue.textureHost=e,this._copyClipInfo(i,this._globalClipMatrix)}},{key:"_drawTexRect",value:function(e,t,i,n,r){this.transformQuad(e,t,i,n,this._italicDeg,this._curMat,this._transedPoints);var a=this._transedPoints;a[0]=a[0]+.5|0,a[1]=a[1]+.5|0,a[2]=a[2]+.5|0,a[3]=a[3]+.5|0,a[4]=a[4]+.5|0,a[5]=a[5]+.5|0,a[6]=a[6]+.5|0,a[7]=a[7]+.5|0,this.clipedOff(this._transedPoints)||(this._mesh.addQuad(this._transedPoints,r,this._fillColor,!0),this._curSubmit._numEle+=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4)}},{key:"drawCallOptimize",value:function(e){return this._charSubmitCache.enable(e,this),e}},{key:"_inner_drawTexture",value:function(e,t,i,n,r,a,s,o,l,h){if(!(r<=0||a<=0)){var u=this._curSubmit._key;if(o=o||e._uv,u.submitType===he.KEY_TRIANGLES&&u.other===t){var c=this._drawTexToDrawTri_Vert;c[0]=i,c[1]=n,c[2]=i+r,c[3]=n,c[4]=i+r,c[5]=n+a,c[6]=i,c[7]=n+a,this._drawTriUseAbsMatrix=!0;var _=this._tempUV;return _[0]=o[0],_[1]=o[1],_[2]=o[2],_[3]=o[3],_[4]=o[4],_[5]=o[5],_[6]=o[6],_[7]=o[7],this.drawTriangles(e,0,0,c,_,this._drawTexToDrawTri_Index,s,l,null,null),this._drawTriUseAbsMatrix=!1,!0}var d=this._mesh,f=this._curSubmit,v=h?this._charSubmitCache.getPos():this._transedPoints;if(this.transformQuad(i,n,r||e.width,a||e.height,this._italicDeg,s||this._curMat,v),this.drawTexAlign){var p=Math.round;v[0]=p(v[0]),v[1]=p(v[1]),v[2]=p(v[2]),v[3]=p(v[3]),v[4]=p(v[4]),v[5]=p(v[5]),v[6]=p(v[6]),v[7]=p(v[7]),this.drawTexAlign=!1}var g=this._mixRGBandAlpha(4294967295,this._shader2D.ALPHA*l);if(h)return this._charSubmitCache.add(this,e,t,v,o,g),!0;this._drawCount++;var y=t>=0&&u.submitType===he.KEY_DRAWTEXTURE&&u.other===t;return y&&(y=y&&this.isSameClipInfo(f)),this._lastTex=e,d.vertNum+4>Context._MAXVERTNUM&&(d=this._mesh=ke.getAMesh(this.isMain),this.meshlist.push(d),y=!1),d.addQuad(v,o,g,!0),y||(this._submits[this._submits._length++]=this._curSubmit=f=Oe.create(this,d,Y.create(U.TEXTURE2D,0)),f.shaderValue.textureHost=e,f._key.other=t,this._copyClipInfo(f,this._globalClipMatrix)),f._numEle+=6,d.indexNum+=6,d.vertNum+=4,!0}}},{key:"transform4Points",value:function(e,t,i){var n=t.tx,r=t.ty,a=t.a,s=t.b,o=t.c,l=t.d,h=e[0],u=e[1],c=e[2],_=e[3],d=e[4],f=e[5],v=e[6],p=e[7];t._bTransform?(i[0]=h*a+u*o+n,i[1]=h*s+u*l+r,i[2]=c*a+_*o+n,i[3]=c*s+_*l+r,i[4]=d*a+f*o+n,i[5]=d*s+f*l+r,i[6]=v*a+p*o+n,i[7]=v*s+p*l+r):(i[0]=h+n,i[1]=u+r,i[2]=c+n,i[3]=_+r,i[4]=d+n,i[5]=f+r,i[6]=v+n,i[7]=p+r)}},{key:"clipedOff",value:function(e){return this._clipRect.width<=0||this._clipRect.height<=0}},{key:"transformQuad",value:function(e,t,i,n,r,a,s){var o=0;0!=r&&(o=Math.tan(r*Math.PI/180)*n);var l=e+i,h=t+n,u=a.tx,c=a.ty,_=a.a,d=a.b,f=a.c,v=a.d,p=e+o,g=t,y=l+o,m=t,T=l,C=h,x=e,k=h;a._bTransform?(s[0]=p*_+g*f+u,s[1]=p*d+g*v+c,s[2]=y*_+m*f+u,s[3]=y*d+m*v+c,s[4]=T*_+C*f+u,s[5]=T*d+C*v+c,s[6]=x*_+k*f+u,s[7]=x*d+k*v+c):(s[0]=p+u,s[1]=g+c,s[2]=y+u,s[3]=m+c,s[4]=T+u,s[5]=C+c,s[6]=x+u,s[7]=k+c)}},{key:"pushRT",value:function(){this.addRenderObject(z.create(null,B.pushRT,this))}},{key:"popRT",value:function(){this.addRenderObject(z.create(null,B.popRT,this)),this.breakNextMerge()}},{key:"useRT",value:function(e){this.addRenderObject(z.create([e],(function(e){if(!e)throw"error useRT";e.start(),e.clear(0,0,0,0)}),this)),this.breakNextMerge()}},{key:"RTRestore",value:function(e){this.addRenderObject(z.create([e],(function(e){e.restore()}),this)),this.breakNextMerge()}},{key:"breakNextMerge",value:function(){this._curSubmit=he.RENDERBASE}},{key:"_repaintSprite",value:function(){this.sprite&&this.sprite.repaint()}},{key:"drawTextureWithTransform",value:function(e,t,i,n,r,a,s,o,l,h){var u,c=arguments.length>10&&void 0!==arguments[10]?arguments[10]:null,_=arguments.length>11?arguments[11]:void 0,d=this._curMat;h&&(u=this.globalCompositeOperation,this.globalCompositeOperation=h);var v=this._colorFiler;if(c&&this.setColorFilter(c),!a)return this._drawTextureM(e,t+s,i+o,n,r,d,l,_),h&&(this.globalCompositeOperation=u),void(c&&this.setColorFilter(v));var p=this._tmpMatrix;p.a=a.a,p.b=a.b,p.c=a.c,p.d=a.d,p.tx=a.tx+s,p.ty=a.ty+o,p._bTransform=a._bTransform,a&&d._bTransform?(f.mul(p,d,p),(a=p)._bTransform=!0):(p.tx+=d.tx,p.ty+=d.ty,a=p),this._drawTextureM(e,t,i,n,r,a,l,_),h&&(this.globalCompositeOperation=u),c&&this.setColorFilter(v)}},{key:"_flushToTarget",value:function(e,t){D.worldScissorTest=!1;var i=g.instance;i.disable(i.SCISSOR_TEST);var n=D.worldAlpha,r=D.worldMatrix4,a=D.worldMatrix;D.worldMatrix=f.EMPTY,D.restoreTempArray(),D.worldMatrix4=D.TEMPMAT4_ARRAY,D.worldAlpha=1,P.activeShader=null,t.start(),e._submits._length>0&&t.clear(0,0,0,0),e._curSubmit=he.RENDERBASE,e.flush(),e.clear(),t.restore(),e._curSubmit=he.RENDERBASE,P.activeShader=null,D.worldAlpha=n,D.worldMatrix4=r,D.worldMatrix=a}},{key:"drawCanvas",value:function(e,t,i,n,r){if(e){var a,s=e.context;if(s._targets)s._submits._length>0&&(a=z.create([s,s._targets],this._flushToTarget,this),this._submits[this._submits._length++]=a),this._drawRenderTexture(s._targets,t,i,n,r,null,1,B.flipyuv),this._curSubmit=he.RENDERBASE;else{var o=e;o.touches&&o.touches.forEach((function(e){e.touch()})),a=De.create(e,this._shader2D.ALPHA,this._shader2D.filters),this._submits[this._submits._length++]=a,a._key.clear();var l=a._matrix;this._curMat.copyTo(l);var h=l.tx,u=l.ty;l.tx=l.ty=0,l.transformPoint(v.TEMP.setTo(t,i)),l.translate(v.TEMP.x+h,v.TEMP.y+u),f.mul(o.invMat,l,l),this._curSubmit=he.RENDERBASE}}}},{key:"drawTarget",value:function(e,t,i,n,r,a,s){var o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:-1;if(this._drawCount++,this._mesh.vertNum+4>Context._MAXVERTNUM&&(this._mesh=ke.getAMesh(this.isMain),this.meshlist.push(this._mesh)),this.transformQuad(t,i,n,r,0,a||this._curMat,this._transedPoints),!this.clipedOff(this._transedPoints)){this._mesh.addQuad(this._transedPoints,o||Ve.DEF_UV,4294967295,!0);var h=this._curSubmit=Be.create(this,this._mesh,s,e);return h.blendType=-1==l?this._nBlendType:l,this._copyClipInfo(h,this._globalClipMatrix),h._numEle=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4,this._submits[this._submits._length++]=h,this._curSubmit=he.RENDERBASE,!0}return this._curSubmit=he.RENDERBASE,!1}},{key:"drawTriangles",value:function(e,t,n,r,a,s,o,l,h,u){var c=arguments.length>10&&void 0!==arguments[10]?arguments[10]:4294967295;if(e._getSource()){var _=null;u&&(_=this.globalCompositeOperation,this.globalCompositeOperation=u),this._drawCount++;var d=this._tmpMatrix,v=this._triangleMesh,p=null,g=!1;h&&(p=this._colorFiler,this._colorFiler=h,this._curSubmit=he.RENDERBASE,g=p!=h);var y=e.bitmap,m=this._curSubmit._key,T=m.submitType===he.KEY_TRIANGLES&&m.other===y.id&&m.blendShader==this._nBlendType;if(v.vertNum+r.length/2>Context._MAXVERTNUM&&(v=this._triangleMesh=Se.getAMesh(this.isMain),this.meshlist.push(v),T=!1),!T){var C=this._curSubmit=Oe.create(this,v,Y.create(U.TEXTURE2D,0));C.shaderValue.textureHost=e,C._renderType=he.TYPE_TEXTURE,C._key.submitType=he.KEY_TRIANGLES,C._key.other=y.id,this._copyClipInfo(C,this._globalClipMatrix),this._submits[this._submits._length++]=C}var x=this._mixRGBandAlpha(c,this._shader2D.ALPHA*l);this._drawTriUseAbsMatrix?v.addData(r,a,s,o,x):(o?(d.a=o.a,d.b=o.b,d.c=o.c,d.d=o.d,d.tx=o.tx+t,d.ty=o.ty+n):(d.a=1,d.b=0,d.c=0,d.d=1,d.tx=t,d.ty=n),f.mul(d,this._curMat,d),v.addData(r,a,s,d||this._curMat,x)),this._curSubmit._numEle+=s.length,g&&(this._colorFiler=p,this._curSubmit=he.RENDERBASE),u&&(this.globalCompositeOperation=_)}else this.sprite&&i.systemTimer.callLater(this,this._repaintSprite)}},{key:"transform",value:function(e,t,i,n,r,a){de.save(this),f.mul(f.TEMP.setTo(e,t,i,n,r,a),this._curMat,this._curMat),this._curMat._checkTransform()}},{key:"_transformByMatrix",value:function(e,t,i){e.setTranslate(t,i),f.mul(e,this._curMat,this._curMat),e.setTranslate(0,0),this._curMat._bTransform=!0}},{key:"setTransformByMatrix",value:function(e){e.copyTo(this._curMat)}},{key:"rotate",value:function(e){de.save(this),this._curMat.rotateEx(e)}},{key:"scale",value:function(e,t){de.save(this),this._curMat.scaleEx(e,t)}},{key:"clipRect",value:function(e,t,i,n){ce.save(this),this._clipRect==Context.MAXCLIPRECT?this._clipRect=new p(e,t,i,n):(this._clipRect.width=i,this._clipRect.height=n,this._clipRect.x=e,this._clipRect.y=t),this._clipID_Gen++,this._clipID_Gen%=1e4,this._clipInfoID=this._clipID_Gen;var r=this._globalClipMatrix,a=r.tx,s=r.ty,o=a+r.a,l=s+r.d;if(this._clipRect.width>=Context._MAXSIZE?(r.a=r.d=Context._MAXSIZE,r.b=r.c=r.tx=r.ty=0):(this._curMat._bTransform?(r.tx=this._clipRect.x*this._curMat.a+this._clipRect.y*this._curMat.c+this._curMat.tx,r.ty=this._clipRect.x*this._curMat.b+this._clipRect.y*this._curMat.d+this._curMat.ty,r.a=this._clipRect.width*this._curMat.a,r.b=this._clipRect.width*this._curMat.b,r.c=this._clipRect.height*this._curMat.c,r.d=this._clipRect.height*this._curMat.d):(r.tx=this._clipRect.x+this._curMat.tx,r.ty=this._clipRect.y+this._curMat.ty,r.a=this._clipRect.width,r.b=r.c=0,r.d=this._clipRect.height),this._incache&&(this._clipInCache=!0)),r.a>0&&r.d>0){var h=r.tx+r.a,u=r.ty+r.d;h<=a||u<=s||r.tx>=o||r.ty>=l?(r.a=-.1,r.d=-.1):(r.tx<a&&(r.a-=a-r.tx,r.tx=a),h>o&&(r.a-=h-o),r.ty<s&&(r.d-=s-r.ty,r.ty=s),u>l&&(r.d-=u-l),r.a<=0&&(r.a=-.1),r.d<=0&&(r.d=-.1))}}},{key:"drawMesh",value:function(e,t,i,n,r,a,s,o){arguments.length>8&&void 0!==arguments[8]&&arguments[8]}},{key:"addRenderObject",value:function(e){this._submits[this._submits._length++]=e}},{key:"submitElement",value:function(e,t){this.isMain;var i=this._submits,n=i._length;t<0&&(t=i._length);for(var r=he.RENDERBASE;e<t;)this._renderNextSubmitIndex=e+1,i[e]!==he.RENDERBASE?(he.preRender=r,e+=(r=i[e]).renderSubmit()):e++;return n}},{key:"flush",value:function(){this._clipID_Gen=0;var e=this.submitElement(0,this._submits._length);this._path&&this._path.reset(),Me.instance&&Me.getInstance().reset(),this._curSubmit=he.RENDERBASE;for(var t=0,i=this.meshlist.length;t<i;t++){var n=this.meshlist[t];n.canReuse?n.releaseMesh():n.destroy()}return this.meshlist.length=0,this._mesh=ke.getAMesh(this.isMain),this._pathMesh=Re.getAMesh(this.isMain),this._triangleMesh=Se.getAMesh(this.isMain),this.meshlist.push(this._mesh,this._pathMesh,this._triangleMesh),this._flushCnt++,this._flushCnt%60==0&&this.isMain&&qe.textRenderInst&&qe.textRenderInst.GC(),e}},{key:"beginPath",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this._getPath();t.beginPath(e)}},{key:"closePath",value:function(){this._path.closePath()}},{key:"addPath",value:function(e,t,i,n,r){for(var a=0,s=0,o=e.length/2;s<o;s++){var l=e[a]+n,h=e[a+1]+r;e[a]=l,e[a+1]=h,a+=2}this._getPath().push(e,i)}},{key:"fill",value:function(){var e=this._curMat,t=this._getPath(),i=this._curSubmit,n=i._key.submitType===he.KEY_VG&&i._key.blendShader===this._nBlendType;n&&(n=n&&this.isSameClipInfo(i)),n||(this._curSubmit=this.addVGSubmit(this._pathMesh));for(var r,a=this.mixRGBandAlpha(this.fillStyle.toInt()),s=0,o=0,l=t.paths.length;o<l;o++){var h=t.paths[o],u=h.path.length/2;if(!(u<3||3==u&&!h.convex)){var c,_,d,f,v=h.path.concat(),p=0;if(e._bTransform)for(p=0;p<u;p++)_=(c=p<<1)+1,d=v[c],f=v[_],v[c]=e.a*d+e.c*f+e.tx,v[_]=e.b*d+e.d*f+e.ty;else for(p=0;p<u;p++)_=(c=p<<1)+1,d=v[c],f=v[_],v[c]=d+e.tx,v[_]=f+e.ty;this._pathMesh.vertNum+u>Context._MAXVERTNUM&&(this._curSubmit._numEle+=s,s=0,this._pathMesh=Re.getAMesh(this.isMain),this._curSubmit=this.addVGSubmit(this._pathMesh));var g=this._pathMesh.vertNum;if(h.convex){var y=u-2;r=new Array(3*y);for(var m=0,T=0;T<y;T++)r[m++]=g,r[m++]=T+1+g,r[m++]=T+2+g}else if(r=Le.earcut(v,null,2),g>0)for(var C=0;C<r.length;C++)r[C]+=g;this._pathMesh.addVertAndIBToMesh(this,v,a,r),s+=r.length}}this._curSubmit._numEle+=s}},{key:"addVGSubmit",value:function(e){var t=Pe.createShape(this,e,0,Y.create(U.PRIMITIVE,0));return t._key.submitType=he.KEY_VG,this._submits[this._submits._length++]=t,this._copyClipInfo(t,this._globalClipMatrix),t}},{key:"stroke",value:function(){if(this.lineWidth>0){var e=this.mixRGBandAlpha(this.strokeStyle._color.numColor),t=this._getPath(),i=this._curSubmit,n=i._key.submitType===he.KEY_VG&&i._key.blendShader===this._nBlendType;n&&(n=n&&this.isSameClipInfo(i)),n||(this._curSubmit=this.addVGSubmit(this._pathMesh));for(var r=0,a=0,s=t.paths.length;a<s;a++){var o=t.paths[a];if(!(o.path.length<=0)){var l=[],h=[],u=2*o.path.length;if(!(u<2)){this._pathMesh.vertNum+u>Context._MAXVERTNUM&&(this._curSubmit._numEle+=r,r=0,this._pathMesh=Re.getAMesh(this.isMain),this.meshlist.push(this._pathMesh),this._curSubmit=this.addVGSubmit(this._pathMesh)),Ae.createLine2(o.path,l,this.lineWidth,this._pathMesh.vertNum,h,o.loop);var c,_,d,f,v=h.length/2,p=this._curMat,g=0;if(p._bTransform)for(g=0;g<v;g++)_=(c=g<<1)+1,d=h[c],f=h[_],h[c]=p.a*d+p.c*f+p.tx,h[_]=p.b*d+p.d*f+p.ty;else for(g=0;g<v;g++)_=(c=g<<1)+1,d=h[c],f=h[_],h[c]=d+p.tx,h[_]=f+p.ty;this._pathMesh.addVertAndIBToMesh(this,h,e,l),r+=l.length}}}this._curSubmit._numEle+=r}}},{key:"moveTo",value:function(e,t){var i=this._getPath();i.newPath(),i._lastOriX=e,i._lastOriY=t,i.addPoint(e,t)}},{key:"lineTo",value:function(e,t){var i=this._getPath();Math.abs(e-i._lastOriX)<.001&&Math.abs(t-i._lastOriY)<.001||(i._lastOriX=e,i._lastOriY=t,i.addPoint(e,t))}},{key:"arcTo",value:function(e,t,i,n,r){var a=0,s=0,o=0,l=this._path._lastOriX-e,h=this._path._lastOriY-t,u=Math.sqrt(l*l+h*h);if(!(u<=1e-6)){var c=l/u,_=h/u,d=i-e,f=n-t,v=d*d+f*f,p=Math.sqrt(v);if(!(p<=1e-6)){var g=d/p,y=f/p,m=c+g,T=_+y,C=Math.sqrt(m*m+T*T);if(!(C<=1e-6)){var x=m/C,k=T/C,S=Math.acos(x*c+k*_),R=Math.PI/2-S,b=(u=r/Math.tan(R))*c+e,E=u*_+t,M=Math.sqrt(u*u+r*r),A=e+x*M,w=t+k*M,L=0,I=0;if(c*y-_*g>=0){var P=2*R/Context.SEGNUM;L=Math.sin(P),I=Math.cos(P)}else P=2*-R/Context.SEGNUM,L=Math.sin(P),I=Math.cos(P);var D=this._path._lastOriX,B=this._path._lastOriY,O=b,F=E;(Math.abs(O-this._path._lastOriX)>.1||Math.abs(F-this._path._lastOriY)>.1)&&(s=O,o=F,D=O,B=F,this._path._lastOriX=s,this._path._lastOriY=o,this._path.addPoint(s,o));var G=b-A,U=E-w;for(a=0;a<Context.SEGNUM;a++){var N=G*I+U*L,W=-G*L+U*I;s=N+A,o=W+w,(Math.abs(D-s)>.1||Math.abs(B-o)>.1)&&(this._path._lastOriX=s,this._path._lastOriY=o,this._path.addPoint(s,o),D=s,B=o),G=N,U=W}}}}}},{key:"arc",value:function(e,t,i,n,r){var a,s,o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],l=(!(arguments.length>6&&void 0!==arguments[6])||arguments[6],0),h=0,u=0,c=0,_=0;if(h=r-n,o)if(Math.abs(h)>=2*Math.PI)h=2*-Math.PI;else for(;h>0;)h-=2*Math.PI;else if(Math.abs(h)>=2*Math.PI)h=2*Math.PI;else for(;h<0;)h+=2*Math.PI;var d=this.getMatScaleX(),f=this.getMatScaleY(),v=i*(d>f?d:f),p=2*Math.PI*v;s=0|Math.max(p/10,10);var g=this._getPath();for(a=0;a<=s;a++)l=n+h*(a/s),u=Math.cos(l),_=t+Math.sin(l)*i,(c=e+u*i)==this._path._lastOriX&&_==this._path._lastOriY||g.addPoint(c,_);u=Math.cos(r),_=t+Math.sin(r)*i,(c=e+u*i)==this._path._lastOriX&&_==this._path._lastOriY||g.addPoint(c,_)}},{key:"quadraticCurveTo",value:function(e,t,i,n){for(var r=re.I.getBezierPoints([this._path._lastOriX,this._path._lastOriY,e,t,i,n],30,2),a=0,s=r.length/2;a<s;a++)this.lineTo(r[2*a],r[2*a+1]);this.lineTo(i,n)}},{key:"mixRGBandAlpha",value:function(e){return this._mixRGBandAlpha(e,this._shader2D.ALPHA)}},{key:"_mixRGBandAlpha",value:function(e,t){if(t>=1)return e;var i=(4278190080&e)>>>24;return 0!=i?i*=t:i=255*t,16777215&e|i<<24}},{key:"strokeRect",value:function(e,t,i,n,r){if(this.lineWidth>0){var a=this.mixRGBandAlpha(this.strokeStyle._color.numColor),s=this.lineWidth/2;this._fillRect(e-s,t-s,i+this.lineWidth,this.lineWidth,a),this._fillRect(e-s,t-s+n,i+this.lineWidth,this.lineWidth,a),this._fillRect(e-s,t+s,this.lineWidth,n-this.lineWidth,a),this._fillRect(e-s+i,t+s,this.lineWidth,n-this.lineWidth,a)}}},{key:"clip",value:function(){}},{key:"drawParticle",value:function(e,t,i){i.x=e,i.y=t,this._submits[this._submits._length++]=i}},{key:"_getPath",value:function(){return this._path||(this._path=new oe)}},{key:"_fillTexture_h",value:function(e,t,i,n,r,a,s,o){n<=0&&console.error("_fillTexture_h error: oriw must>0");for(var l=a,h=Math.floor(o/n),u=o%n,c=0;c<h;c++)this._inner_drawTexture(e,t,l,s,n,r,this._curMat,i,1,!1),l+=n;if(u>0){var _=i[2]-i[0],d=i[0]+_*(u/n),f=Context.tmpuv1;f[0]=i[0],f[1]=i[1],f[2]=d,f[3]=i[3],f[4]=d,f[5]=i[5],f[6]=i[6],f[7]=i[7],this._inner_drawTexture(e,t,l,s,u,r,this._curMat,f,1,!1)}}},{key:"_fillTexture_v",value:function(e,t,i,n,r,a,s,o){r<=0&&console.error("_fillTexture_v error: orih must>0");for(var l=s,h=Math.floor(o/r),u=o%r,c=0;c<h;c++)this._inner_drawTexture(e,t,a,l,n,r,this._curMat,i,1,!1),l+=r;if(u>0){var _=i[7]-i[1],d=i[1]+_*(u/r),f=Context.tmpuv1;f[0]=i[0],f[1]=i[1],f[2]=i[2],f[3]=i[3],f[4]=i[4],f[5]=d,f[6]=i[6],f[7]=d,this._inner_drawTexture(e,t,a,l,n,u,this._curMat,f,1,!1)}}},{key:"drawTextureWithSizeGrid",value:function(e,t,i,n,r,a,s,o){if(e._getSource()){t+=s,i+=o;var l=e.uv,h=e.bitmap.width,u=e.bitmap.height,c=a[0],_=a[3],d=a[1],f=a[2],v=a[4],p=!1;n==h&&(_=d=0),r==u&&(c=f=0);var g=c/u,y=_/h,m=d/h,T=f/u;if(_+d>n){var C=n;p=!0,n=_+d,this.save(),this.clipRect(0+t,0+i,C,r)}var x=e.bitmap.id,k=this._curMat,S=this._tempUV,R=l[0],b=l[1],E=l[4],M=l[5],A=R,w=b,L=E,I=M;if(_&&c&&(L=R+y,I=b+g,S[0]=R,S[1]=b,S[2]=L,S[3]=b,S[4]=L,S[5]=I,S[6]=R,S[7]=I,this._inner_drawTexture(e,x,t,i,_,c,k,S,1,!1)),d&&c&&(A=E-m,w=b,L=E,I=b+g,S[0]=A,S[1]=w,S[2]=L,S[3]=w,S[4]=L,S[5]=I,S[6]=A,S[7]=I,this._inner_drawTexture(e,x,n-d+t,0+i,d,c,k,S,1,!1)),_&&f&&(A=R,w=M-T,L=R+y,I=M,S[0]=A,S[1]=w,S[2]=L,S[3]=w,S[4]=L,S[5]=I,S[6]=A,S[7]=I,this._inner_drawTexture(e,x,0+t,r-f+i,_,f,k,S,1,!1)),d&&f&&(A=E-m,w=M-T,L=E,I=M,S[0]=A,S[1]=w,S[2]=L,S[3]=w,S[4]=L,S[5]=I,S[6]=A,S[7]=I,this._inner_drawTexture(e,x,n-d+t,r-f+i,d,f,k,S,1,!1)),c&&(A=R+y,w=b,L=E-m,I=b+g,S[0]=A,S[1]=w,S[2]=L,S[3]=w,S[4]=L,S[5]=I,S[6]=A,S[7]=I,v?this._fillTexture_h(e,x,S,e.width-_-d,c,_+t,i,n-_-d):this._inner_drawTexture(e,x,_+t,i,n-_-d,c,k,S,1,!1)),f&&(A=R+y,w=M-T,L=E-m,I=M,S[0]=A,S[1]=w,S[2]=L,S[3]=w,S[4]=L,S[5]=I,S[6]=A,S[7]=I,v?this._fillTexture_h(e,x,S,e.width-_-d,f,_+t,r-f+i,n-_-d):this._inner_drawTexture(e,x,_+t,r-f+i,n-_-d,f,k,S,1,!1)),_&&(A=R,w=b+g,L=R+y,I=M-T,S[0]=A,S[1]=w,S[2]=L,S[3]=w,S[4]=L,S[5]=I,S[6]=A,S[7]=I,v?this._fillTexture_v(e,x,S,_,e.height-c-f,t,c+i,r-c-f):this._inner_drawTexture(e,x,t,c+i,_,r-c-f,k,S,1,!1)),d&&(A=E-m,w=b+g,L=E,I=M-T,S[0]=A,S[1]=w,S[2]=L,S[3]=w,S[4]=L,S[5]=I,S[6]=A,S[7]=I,v?this._fillTexture_v(e,x,S,d,e.height-c-f,n-d+t,c+i,r-c-f):this._inner_drawTexture(e,x,n-d+t,c+i,d,r-c-f,k,S,1,!1)),A=R+y,w=b+g,L=E-m,I=M-T,S[0]=A,S[1]=w,S[2]=L,S[3]=w,S[4]=L,S[5]=I,S[6]=A,S[7]=I,v){var P=Context.tmpUVRect;P[0]=A,P[1]=w,P[2]=L-A,P[3]=I-w,this._fillTexture(e,e.width-_-d,e.height-c-f,P,_+t,c+i,n-_-d,r-c-f,"repeat",0,0)}else this._inner_drawTexture(e,x,_+t,c+i,n-_-d,r-c-f,k,S,1,!1);p&&this.restore()}}},{key:"lineJoin",get:function(){return""},set:function(e){}},{key:"lineCap",get:function(){return""},set:function(e){}},{key:"miterLimit",get:function(){return""},set:function(e){}},{key:"asBitmap",set:function(t){if(t){var i=this._targets;if(!this._width||!this._height)throw Error("asBitmap no size!");i&&i.width==this._width&&i.height==this._height||(i&&i.destroy(),this._targets=new B(this._width,this._height,e.RenderTextureFormat.R8G8B8A8,-1))}else this._targets&&this._targets.destroy(),this._targets=null}},{key:"fillStyle",set:function(e){this._shader2D.fillStyle.equal(e)||(ue.save(this,ue.TYPE_FILESTYLE,this._shader2D,!1),this._shader2D.fillStyle=se.create(e),this._submitKey.other=-this._shader2D.fillStyle.toInt())},get:function(){return this._shader2D.fillStyle}},{key:"globalAlpha",set:function(e){(e=Math.floor(1e3*e)/1e3)!=this._shader2D.ALPHA&&(ue.save(this,ue.TYPE_ALPHA,this._shader2D,!1),this._shader2D.ALPHA=e)},get:function(){return this._shader2D.ALPHA}},{key:"textAlign",set:function(e){this._other.textAlign===e||(this._other=this._other.make(),ue.save(this,ue.TYPE_TEXTALIGN,this._other,!1),this._other.textAlign=e)},get:function(){return this._other.textAlign}},{key:"textBaseline",set:function(e){this._other.textBaseline===e||(this._other=this._other.make(),ue.save(this,ue.TYPE_TEXTBASELINE,this._other,!1),this._other.textBaseline=e)},get:function(){return this._other.textBaseline}},{key:"globalCompositeOperation",set:function(e){var t=F.TOINT[e];null==t||this._nBlendType===t||(ue.save(this,ue.TYPE_GLOBALCOMPOSITEOPERATION,this,!0),this._curSubmit=he.RENDERBASE,this._nBlendType=t)},get:function(){return F.NAMES[this._nBlendType]}},{key:"strokeStyle",set:function(e){this._shader2D.strokeStyle.equal(e)||(ue.save(this,ue.TYPE_STROKESTYLE,this._shader2D,!1),this._shader2D.strokeStyle=se.create(e),this._submitKey.other=-this._shader2D.strokeStyle.toInt())},get:function(){return this._shader2D.strokeStyle}},{key:"lineWidth",set:function(e){this._other.lineWidth===e||(this._other=this._other.make(),ue.save(this,ue.TYPE_LINEWIDTH,this._other,!1),this._other.lineWidth=e)},get:function(){return this._other.lineWidth}},{key:"font",set:function(e){this._other=this._other.make(),ue.save(this,ue.TYPE_FONT,this._other,!1)}},{key:"canvas",get:function(){return this._canvas}}],[{key:"__init__",value:function(){Context.MAXCLIPRECT=new p(0,0,Context._MAXSIZE,Context._MAXSIZE),$e.DEFAULT=new $e}},{key:"set2DRenderConfig",value:function(){var e=g.instance;y.setBlend(e,!0),y.setBlendEquation(e,e.FUNC_ADD),F.activeBlendFunction=null,y.setBlendFunc(e,e.ONE,e.ONE_MINUS_SRC_ALPHA),y.setDepthTest(e,!1),y.setCullFace(e,!1),y.setDepthMask(e,!0),y.setFrontFace(e,e.CCW),e.viewport(0,0,D.width,D.height)}}]),Context}();Ze.ENUM_TEXTALIGN_DEFAULT=0,Ze.ENUM_TEXTALIGN_CENTER=1,Ze.ENUM_TEXTALIGN_RIGHT=2,Ze._SUBMITVBSIZE=32e3,Ze._MAXSIZE=99999999,Ze._MAXVERTNUM=65535,Ze.MAXCLIPRECT=null,Ze._COUNT=0,Ze.SEGNUM=32,Ze._contextcount=0,Ze.PI2=2*Math.PI,Ze._textRender=null,Ze.tmpuv1=[0,0,0,0,0,0,0,0],Ze.tmpUV=[0,0,0,0,0,0,0,0],Ze.tmpUVRect=[0,0,0,0];var $e=function(){function ContextParams(){_classCallCheck(this,ContextParams),this.lineWidth=1}return _createClass(ContextParams,[{key:"clear",value:function(){this.lineWidth=1,this.textAlign=this.textBaseline=null}},{key:"make",value:function(){return this===ContextParams.DEFAULT?new ContextParams:this}}]),ContextParams}(),Je=function(){function WebGL(){_classCallCheck(this,WebGL)}return _createClass(WebGL,null,[{key:"_uint8ArraySlice",value:function(){for(var e=this.length,t=new Uint8Array(this.length),i=0;i<e;i++)t[i]=this[i];return t}},{key:"_float32ArraySlice",value:function(){for(var e=this.length,t=new Float32Array(this.length),i=0;i<e;i++)t[i]=this[i];return t}},{key:"_uint16ArraySlice",value:function(){var e,t,i,n=this;if(0===arguments.length)for(e=n.length,t=new Uint16Array(e),i=0;i<e;i++)t[i]=n[i];else if(2===arguments.length){var r=arguments.length<=0?void 0:arguments[0],a=arguments.length<=1?void 0:arguments[1];if(a>r)for(e=a-r,t=new Uint16Array(e),i=r;i<a;i++)t[i-r]=n[i];else t=new Uint16Array(0)}return t}},{key:"_nativeRender_enable",value:function(){}},{key:"enable",value:function(){return!0}},{key:"inner_enable",value:function(){return Float32Array.prototype.slice||(Float32Array.prototype.slice=WebGL._float32ArraySlice),Uint16Array.prototype.slice||(Uint16Array.prototype.slice=WebGL._uint16ArraySlice),Uint8Array.prototype.slice||(Uint8Array.prototype.slice=WebGL._uint8ArraySlice),!0}},{key:"onStageResize",value:function(e,t){null!=y.mainContext&&(y.mainContext.viewport(0,0,e,t),D.width=e,D.height=t)}}]),WebGL}();Je._isWebGL2=!1,Je.isNativeRender_enable=!1;!function(){var e={};function synthesizeGLError(t,i){var n;e[t]=!0,void 0!==i&&(n=i,window.console&&window.console.error&&window.console.error(n))}var t=function WebGLVertexArrayObjectOES(e){var t=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(var i=0;i<this.attribs.length;i++){var n=new WebGLVertexArrayObjectOES.VertexAttrib(t);this.attribs[i]=n}this.maxAttrib=0};(t.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=e.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var OESVertexArrayObject=function(t){var i=this;this.gl=t,function(t){var i=t.getError;t.getError=function(){var n;do{(n=i.apply(t))!=t.NO_ERROR&&(e[n]=!0)}while(n!=t.NO_ERROR);for(var r in e)if(e[r])return delete e[r],parseInt(r);return t.NO_ERROR}}(t);var n=this.original={getParameter:t.getParameter,enableVertexAttribArray:t.enableVertexAttribArray,disableVertexAttribArray:t.disableVertexAttribArray,bindBuffer:t.bindBuffer,getVertexAttrib:t.getVertexAttrib,vertexAttribPointer:t.vertexAttribPointer};t.getParameter=function(e){return e==i.VERTEX_ARRAY_BINDING_OES?i.currentVertexArrayObject==i.defaultVertexArrayObject?null:i.currentVertexArrayObject:n.getParameter.apply(this,arguments)},t.enableVertexAttribArray=function(e){var t=i.currentVertexArrayObject;t.maxAttrib=Math.max(t.maxAttrib,e);var r=t.attribs[e];return r.enabled=!0,n.enableVertexAttribArray.apply(this,arguments)},t.disableVertexAttribArray=function(e){var t=i.currentVertexArrayObject;t.maxAttrib=Math.max(t.maxAttrib,e);var r=t.attribs[e];return r.enabled=!1,n.disableVertexAttribArray.apply(this,arguments)},t.bindBuffer=function(e,r){switch(e){case t.ARRAY_BUFFER:i.currentArrayBuffer=r;break;case t.ELEMENT_ARRAY_BUFFER:i.currentVertexArrayObject.elementArrayBuffer=r}return n.bindBuffer.apply(this,arguments)},t.getVertexAttrib=function(e,r){var a=i.currentVertexArrayObject,s=a.attribs[e];switch(r){case t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return s.buffer;case t.VERTEX_ATTRIB_ARRAY_ENABLED:return s.enabled;case t.VERTEX_ATTRIB_ARRAY_SIZE:return s.size;case t.VERTEX_ATTRIB_ARRAY_STRIDE:return s.stride;case t.VERTEX_ATTRIB_ARRAY_TYPE:return s.type;case t.VERTEX_ATTRIB_ARRAY_NORMALIZED:return s.normalized;default:return n.getVertexAttrib.apply(this,arguments)}},t.vertexAttribPointer=function(e,t,r,a,s,o){var l=i.currentVertexArrayObject;l.maxAttrib=Math.max(l.maxAttrib,e);var h=l.attribs[e];return h.buffer=i.currentArrayBuffer,h.size=t,h.type=r,h.normalized=a,h.stride=s,h.offset=o,h.recache(),n.vertexAttribPointer.apply(this,arguments)},t.instrumentExtension&&t.instrumentExtension(this,"OES_vertex_array_object"),t.canvas.addEventListener("webglcontextrestored",(function(){var e;e="OESVertexArrayObject emulation library context restored",window.console&&window.console.log&&window.console.log(e),i.reset_()}),!0),this.reset_()};OESVertexArrayObject.prototype.VERTEX_ARRAY_BINDING_OES=34229,OESVertexArrayObject.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var e=0;e<this.vertexArrayObjects.length;++e)this.vertexArrayObjects.isAlive=!1;var i=this.gl;this.maxVertexAttribs=i.getParameter(i.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new t(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},OESVertexArrayObject.prototype.createVertexArrayOES=function(){var e=new t(this);return this.vertexArrayObjects.push(e),e},OESVertexArrayObject.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject==e&&this.bindVertexArrayOES(null)},OESVertexArrayObject.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof t&&e.hasBeenBound&&e.ext==this)},OESVertexArrayObject.prototype.bindVertexArrayOES=function(e){var t=this.gl;if(!e||e.isAlive){var i=this.original,n=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var r=this.currentVertexArrayObject;if(n!=r){n&&r.elementArrayBuffer==n.elementArrayBuffer||i.bindBuffer.call(t,t.ELEMENT_ARRAY_BUFFER,r.elementArrayBuffer);for(var a=this.currentArrayBuffer,s=Math.max(n?n.maxAttrib:0,r.maxAttrib),o=0;o<=s;o++){var l=r.attribs[o],h=n?n.attribs[o]:null;if(n&&l.enabled==h.enabled||(l.enabled?i.enableVertexAttribArray.call(t,o):i.disableVertexAttribArray.call(t,o)),l.enabled){var u=!1;n&&l.buffer==h.buffer||(a!=l.buffer&&(i.bindBuffer.call(t,t.ARRAY_BUFFER,l.buffer),a=l.buffer),u=!0),(u||l.cached!=h.cached)&&i.vertexAttribPointer.call(t,o,l.size,l.type,l.normalized,l.stride,l.offset)}}this.currentArrayBuffer!=a&&i.bindBuffer.call(t,t.ARRAY_BUFFER,this.currentArrayBuffer)}}else synthesizeGLError(t.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")},window._setupVertexArrayObject=function(e){var t=e.getSupportedExtensions;e.getSupportedExtensions=function(){var e=t.call(this)||[];return e.indexOf("OES_vertex_array_object")<0&&e.push("OES_vertex_array_object"),e};var i=e.getExtension;e.getExtension=function(e){var t=i.call(this,e);return t||("OES_vertex_array_object"!==e?null:(this.__OESVertexArrayObject||(console.log("Setup OES_vertex_array_object polyfill"),this.__OESVertexArrayObject=new OESVertexArrayObject(this)),this.__OESVertexArrayObject))}}}();var et=function(){function SystemUtils(){_classCallCheck(this,SystemUtils)}return _createClass(SystemUtils,null,[{key:"supportTextureFormat",value:function(t){switch(t){case e.TextureFormat.R32G32B32A32:return!(!g.layaGPUInstance._isWebGL2&&!g.layaGPUInstance._oesTextureFloat);default:return!0}}},{key:"supportRenderTextureFormat",value:function(t){switch(t){case e.RenderTextureFormat.R16G16B16A16:return!!(g.layaGPUInstance._isWebGL2&&g.layaGPUInstance._extColorBufferFloat||g.layaGPUInstance._oesTextureHalfFloat&&g.layaGPUInstance._oesTextureHalfFloatLinear);case e.RenderTextureFormat.Depth:return!(!g.layaGPUInstance._isWebGL2&&!g.layaGPUInstance._webgl_depth_texture);case e.RenderTextureFormat.ShadowMap:return!!g.layaGPUInstance._isWebGL2;default:return!0}}},{key:"maxTextureCount",get:function(){return this._maxTextureCount}},{key:"maxTextureSize",get:function(){return this._maxTextureSize}},{key:"shaderCapailityLevel",get:function(){return this._shaderCapailityLevel}}]),SystemUtils}(),tt=function(){function LayaGPU(e,t){_classCallCheck(this,LayaGPU),this._gl=null,this._vaoExt=null,this._angleInstancedArrays=null,this._isWebGL2=!1,this._oesTextureHalfFloat=null,this._oes_element_index_uint=null,this._oesTextureHalfFloatLinear=null,this._oesTextureFloat=null,this._extShaderTextureLod=null,this._extTextureFilterAnisotropic=null,this._compressedTextureS3tc=null,this._compressedTexturePvrtc=null,this._compressedTextureEtc1=null,this._webgl_depth_texture=null,this._extColorBufferFloat=null,this._gl=e,this._isWebGL2=t;var n=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),r=e.getParameter(e.MAX_TEXTURE_SIZE);t?(this._extColorBufferFloat=this._getExtension("EXT_color_buffer_float"),et._shaderCapailityLevel=35):(i.Render.isConchApp||window._setupVertexArrayObject&&window._setupVertexArrayObject(e),this._vaoExt=this._getExtension("OES_vertex_array_object"),this._angleInstancedArrays=this._getExtension("ANGLE_instanced_arrays"),this._oesTextureHalfFloat=this._getExtension("OES_texture_half_float"),this._oesTextureHalfFloatLinear=this._getExtension("OES_texture_half_float_linear"),this._oesTextureFloat=this._getExtension("OES_texture_float"),this._oes_element_index_uint=this._getExtension("OES_element_index_uint"),this._extShaderTextureLod=this._getExtension("EXT_shader_texture_lod"),this._webgl_depth_texture=this._getExtension("WEBGL_depth_texture"),et._shaderCapailityLevel=30),this._extTextureFilterAnisotropic=this._getExtension("EXT_texture_filter_anisotropic"),this._compressedTextureS3tc=this._getExtension("WEBGL_compressed_texture_s3tc"),this._compressedTexturePvrtc=this._getExtension("WEBGL_compressed_texture_pvrtc"),this._compressedTextureEtc1=this._getExtension("WEBGL_compressed_texture_etc1"),et._maxTextureCount=n,et._maxTextureSize=r}return _createClass(LayaGPU,[{key:"_getExtension",value:function(e){var t=LayaGPU._extentionVendorPrefixes;for(var i in t){var n=this._gl.getExtension(t[i]+e);if(n)return n}return null}},{key:"createVertexArray",value:function(){return this._isWebGL2?this._gl.createVertexArray():this._vaoExt.createVertexArrayOES()}},{key:"bindVertexArray",value:function(e){this._isWebGL2?this._gl.bindVertexArray(e):this._vaoExt.bindVertexArrayOES(e)}},{key:"deleteVertexArray",value:function(e){this._isWebGL2?this._gl.deleteVertexArray(e):this._vaoExt.deleteVertexArrayOES(e)}},{key:"isVertexArray",value:function(e){this._isWebGL2?this._gl.isVertexArray(e):this._vaoExt.isVertexArrayOES(e)}},{key:"drawElementsInstanced",value:function(e,t,i,n,r){this._isWebGL2?this._gl.drawElementsInstanced(e,t,i,n,r):this._angleInstancedArrays.drawElementsInstancedANGLE(e,t,i,n,r)}},{key:"drawArraysInstanced",value:function(e,t,i,n){this._isWebGL2?this._gl.drawArraysInstanced(e,t,i,n):this._angleInstancedArrays.drawArraysInstancedANGLE(e,t,i,n)}},{key:"vertexAttribDivisor",value:function(e,t){this._isWebGL2?this._gl.vertexAttribDivisor(e,t):this._angleInstancedArrays.vertexAttribDivisorANGLE(e,t)}},{key:"supportInstance",value:function(){return!(!this._isWebGL2&&!this._angleInstancedArrays||!t.allowGPUInstanceDynamicBatch)}},{key:"supportElementIndexUint32",value:function(){return!(!this._isWebGL2&&!this._oes_element_index_uint)}}]),LayaGPU}();tt._extentionVendorPrefixes=["","WEBKIT_","MOZ_"];var it=function(){function Render(e,t,n){_classCallCheck(this,Render),this._timeId=0,Render._mainCanvas=n;var r=Render._mainCanvas.source;r.id="layaCanvas",r.width=e,r.height=t,Render.isConchApp&&document.body.appendChild(r),this.initRender(Render._mainCanvas,e,t),window.requestAnimationFrame((function loop(e){i.stage._loop();window.requestAnimationFrame(loop)})),i.stage.on("visibilitychange",this,this._onVisibilitychange)}return _createClass(Render,[{key:"_onVisibilitychange",value:function(){i.stage.isVisibility?0!=this._timeId&&window.clearInterval(this._timeId):this._timeId=window.setInterval(this._enterFrame,1e3)}},{key:"initRender",value:function(e,i,n){var r=g.instance=y.mainContext=function(e){var i,n=["webgl2","webgl","experimental-webgl","webkit-3d","moz-webgl"];t.useWebGL2&&!Ke.onBDMiniGame||n.shift();for(var r=0;r<n.length;r++){try{i=e.getContext(n[r],{stencil:t.isStencil,alpha:t.isAlpha,antialias:t.isAntialias,premultipliedAlpha:t.premultipliedAlpha,preserveDrawingBuffer:t.preserveDrawingBuffer})}catch(e){}if(i)return"webgl2"===n[r]&&(Je._isWebGL2=!0),i}return null}(Render._mainCanvas.source);if(!r)return!1;g.instance=r,g.layaGPUInstance=new tt(r,Je._isWebGL2),e.size(i,n),Ze.__init__(),he.__init__();var a=new Ze;return a.isMain=!0,Render._context=a,e._setContext(a),U.__init__(),Y.__init__(),Ee.__init__(),me.__int__(r),F._init_(r),!0}},{key:"_enterFrame",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];i.stage._loop()}}],[{key:"context",get:function(){return Render._context}},{key:"canvas",get:function(){return Render._mainCanvas.source}}]),Render}();it.supportWebGLPlusCulling=!1,it.supportWebGLPlusAnimation=!1,it.supportWebGLPlusRendering=!1,it.isConchApp=!1,it.isConchApp=null!=window.conch,it.isConchApp?(it.supportWebGLPlusCulling=!1,it.supportWebGLPlusAnimation=!1,it.supportWebGLPlusRendering=!1):null!=window.qq&&null!=window.qq.webglPlus&&(it.supportWebGLPlusCulling=!1,it.supportWebGLPlusAnimation=!1,it.supportWebGLPlusRendering=!1);var nt=function(){function DrawTrianglesCmd(){_classCallCheck(this,DrawTrianglesCmd)}return _createClass(DrawTrianglesCmd,[{key:"recover",value:function(){this.texture=null,this.vertices=null,this.uvs=null,this.indices=null,this.matrix=null,n.recover("DrawTrianglesCmd",this)}},{key:"run",value:function(e,t,i){e.drawTriangles(this.texture,this.x+t,this.y+i,this.vertices,this.uvs,this.indices,this.matrix,this.alpha,this.color,this.blendMode,this.colorNum)}},{key:"cmdID",get:function(){return DrawTrianglesCmd.ID}}],[{key:"create",value:function(e,t,i,r,a,s,o,l,h,u,c){var _=n.getItemByClass("DrawTrianglesCmd",DrawTrianglesCmd);if(_.texture=e,_.x=t,_.y=i,_.vertices=r,_.uvs=a,_.indices=s,_.matrix=o,_.alpha=l,h){_.color=new q;var d=Q.create(h).arrColor;_.color.color(255*d[0],255*d[1],255*d[2],255*d[3])}return _.blendMode=u,_.colorNum=c,_}}]),DrawTrianglesCmd}();nt.ID="DrawTriangles";var rt=function(){function Draw9GridTexture(){_classCallCheck(this,Draw9GridTexture)}return _createClass(Draw9GridTexture,[{key:"recover",value:function(){this.texture._removeReference(),n.recover("Draw9GridTexture",this)}},{key:"run",value:function(e,t,i){e.drawTextureWithSizeGrid(this.texture,this.x,this.y,this.width,this.height,this.sizeGrid,t,i)}},{key:"cmdID",get:function(){return Draw9GridTexture.ID}}],[{key:"create",value:function(e,t,i,r,a,s){var o=n.getItemByClass("Draw9GridTexture",Draw9GridTexture);return o.texture=e,e._addReference(),o.x=t,o.y=i,o.width=r,o.height=a,o.sizeGrid=s,o}}]),Draw9GridTexture}();rt.ID="Draw9GridTexture";var at=function(){function SaveCmd(){_classCallCheck(this,SaveCmd)}return _createClass(SaveCmd,[{key:"recover",value:function(){n.recover("SaveCmd",this)}},{key:"run",value:function(e,t,i){e.save()}},{key:"cmdID",get:function(){return SaveCmd.ID}}],[{key:"create",value:function(){return n.getItemByClass("SaveCmd",SaveCmd)}}]),SaveCmd}();at.ID="Save";var st=function(){function GraphicsBounds(){_classCallCheck(this,GraphicsBounds),this._cacheBoundsType=!1}return _createClass(GraphicsBounds,[{key:"destroy",value:function(){this._graphics=null,this._cacheBoundsType=!1,this._temp&&(this._temp.length=0),this._rstBoundPoints&&(this._rstBoundPoints.length=0),this._bounds&&this._bounds.recover(),this._bounds=null,n.recover("GraphicsBounds",this)}},{key:"reset",value:function(){this._temp&&(this._temp.length=0)}},{key:"getBounds",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(!this._bounds||!this._temp||this._temp.length<1||e!=this._cacheBoundsType)&&(this._bounds=p._getWrapRec(this.getBoundPoints(e),this._bounds)),this._cacheBoundsType=e,this._bounds}},{key:"getBoundPoints",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(!this._temp||this._temp.length<1||e!=this._cacheBoundsType)&&(this._temp=this._getCmdPoints(e)),this._cacheBoundsType=e,this._rstBoundPoints=j.copyArray(this._rstBoundPoints,this._temp)}},{key:"_getCmdPoints",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=this._graphics.cmds;if((e=this._temp||(this._temp=[])).length=0,i||null==this._graphics._one||(GraphicsBounds._tempCmds.length=0,GraphicsBounds._tempCmds.push(this._graphics._one),i=GraphicsBounds._tempCmds),!i)return e;var n=GraphicsBounds._tempMatrixArrays;n.length=0;var f=GraphicsBounds._initMatrix;f.identity();for(var v,g,y=GraphicsBounds._tempMatrix,m=0,T=i.length;m<T;m++)switch((v=i[m]).cmdID){case r.ID:case at.ID:n.push(f),f=f.clone();break;case J.ID:f=n.pop();break;case te.ID:y.identity(),y.translate(-v.pivotX,-v.pivotY),y.scale(v.scaleX,v.scaleY),y.translate(v.pivotX,v.pivotY),this._switchMatrix(f,y);break;case ee.ID:y.identity(),y.translate(-v.pivotX,-v.pivotY),y.rotate(v.angle),y.translate(v.pivotX,v.pivotY),this._switchMatrix(f,y);break;case ne.ID:y.identity(),y.translate(v.tx,v.ty),this._switchMatrix(f,y);break;case ie.ID:y.identity(),y.translate(-v.pivotX,-v.pivotY),y.concat(v.matrix),y.translate(v.pivotX,v.pivotY),this._switchMatrix(f,y);break;case o.ID:case $.ID:GraphicsBounds._addPointArrToRst(e,p._getBoundPointS(v.x,v.y,v.width,v.height),f);break;case Z.ID:f.copyTo(y),v.matrix&&y.concat(v.matrix),GraphicsBounds._addPointArrToRst(e,p._getBoundPointS(v.x,v.y,v.width,v.height),y);break;case o.ID:if(g=v.texture,t)v.width&&v.height?GraphicsBounds._addPointArrToRst(e,p._getBoundPointS(v.x,v.y,v.width,v.height),f):GraphicsBounds._addPointArrToRst(e,p._getBoundPointS(v.x,v.y,g.width,g.height),f);else{var C=(v.width||g.sourceWidth)/g.width,x=(v.height||g.sourceHeight)/g.height,k=C*g.sourceWidth,S=x*g.sourceHeight,R=g.offsetX>0?g.offsetX:0,b=g.offsetY>0?g.offsetY:0;R*=C,b*=x,GraphicsBounds._addPointArrToRst(e,p._getBoundPointS(v.x-R,v.y-b,k,S),f)}break;case $.ID:v.width&&v.height?GraphicsBounds._addPointArrToRst(e,p._getBoundPointS(v.x,v.y,v.width,v.height),f):(g=v.texture,GraphicsBounds._addPointArrToRst(e,p._getBoundPointS(v.x,v.y,g.width,g.height),f));break;case Z.ID:var E;v.matrix?(f.copyTo(y),y.concat(v.matrix),E=y):E=f,t?v.width&&v.height?GraphicsBounds._addPointArrToRst(e,p._getBoundPointS(v.x,v.y,v.width,v.height),E):(g=v.texture,GraphicsBounds._addPointArrToRst(e,p._getBoundPointS(v.x,v.y,g.width,g.height),E)):(g=v.texture,C=(v.width||g.sourceWidth)/g.width,x=(v.height||g.sourceHeight)/g.height,k=C*g.sourceWidth,S=x*g.sourceHeight,R=g.offsetX>0?g.offsetX:0,b=g.offsetY>0?g.offsetY:0,R*=C,b*=x,GraphicsBounds._addPointArrToRst(e,p._getBoundPointS(v.x-R,v.y-b,k,S),E));break;case d.ID:GraphicsBounds._addPointArrToRst(e,p._getBoundPointS(v.x,v.y,v.width,v.height),f);break;case a.ID:GraphicsBounds._addPointArrToRst(e,p._getBoundPointS(v.x-v.radius,v.y-v.radius,v.radius+v.radius,v.radius+v.radius),f);break;case l.ID:var M;GraphicsBounds._tempPoints.length=0,M=.5*v.lineWidth,v.fromX==v.toX?GraphicsBounds._tempPoints.push(v.fromX+M,v.fromY,v.toX+M,v.toY,v.fromX-M,v.fromY,v.toX-M,v.toY):v.fromY==v.toY?GraphicsBounds._tempPoints.push(v.fromX,v.fromY+M,v.toX,v.toY+M,v.fromX,v.fromY-M,v.toX,v.toY-M):GraphicsBounds._tempPoints.push(v.fromX,v.fromY,v.toX,v.toY),GraphicsBounds._addPointArrToRst(e,GraphicsBounds._tempPoints,f);break;case s.ID:GraphicsBounds._addPointArrToRst(e,re.I.getBezierPoints(v.points),f,v.x,v.y);break;case h.ID:case _.ID:GraphicsBounds._addPointArrToRst(e,v.points,f,v.x,v.y);break;case u.ID:GraphicsBounds._addPointArrToRst(e,this._getPathPoints(v.paths),f,v.x,v.y);break;case c.ID:GraphicsBounds._addPointArrToRst(e,this._getPiePoints(v.x,v.y,v.radius,v.startAngle,v.endAngle),f);break;case nt.ID:GraphicsBounds._addPointArrToRst(e,this._getTriAngBBXPoints(v.vertices),f);break;case rt.ID:GraphicsBounds._addPointArrToRst(e,this._getDraw9GridBBXPoints(v),f)}return e.length>200?e=j.copyArray(e,p._getWrapRec(e)._getBoundPoints()):e.length>8&&(e=ae.scanPList(e)),e}},{key:"_switchMatrix",value:function(e,t){t.concat(e),t.copyTo(e)}},{key:"_getPiePoints",value:function(e,t,i,n,r){var a=GraphicsBounds._tempPoints;GraphicsBounds._tempPoints.length=0;var s=Math.PI/180,o=r-n;if(o>=360||o<=-360)return a.push(e-i,t-i),a.push(e+i,t-i),a.push(e+i,t+i),a.push(e-i,t+i),a;a.push(e,t);var l=o%360;l<0&&(l+=360);var h=n+l,u=n*s,c=h*s;a.push(e+i*Math.cos(u),t+i*Math.sin(u)),a.push(e+i*Math.cos(c),t+i*Math.sin(c));for(var _=90*Math.ceil(n/90),d=90*Math.floor(h/90),f=_;f<=d;f+=90){var v=f*s;a.push(e+i*Math.cos(v),t+i*Math.sin(v))}return a}},{key:"_getTriAngBBXPoints",value:function(e){var t=e.length;if(t<2)return[];for(var i=e[0],n=e[1],r=i,a=n,s=2;s<t;){var o=e[s++],l=e[s++];i>o&&(i=o),n>l&&(n=l),r<o&&(r=o),a<l&&(a=l)}return[i,n,r,n,r,a,i,a]}},{key:"_getDraw9GridBBXPoints",value:function(e){var t=e.width,i=e.height;return[0,0,t,0,t,i,0,i]}},{key:"_getPathPoints",value:function(e){var t,i,n,r=GraphicsBounds._tempPoints;for(r.length=0,i=e.length,t=0;t<i;t++)(n=e[t]).length>1&&(r.push(n[1],n[2]),n.length>3&&r.push(n[3],n[4]));return r}}],[{key:"create",value:function(){return n.getItemByClass("GraphicsBounds",GraphicsBounds)}},{key:"_addPointArrToRst",value:function(e,t,i){var n,r,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;for(r=t.length,n=0;n<r;n+=2)GraphicsBounds._addPointToRst(e,t[n]+a,t[n+1]+s,i)}},{key:"_addPointToRst",value:function(e,t,i,n){var r=v.TEMP;r.setTo(t||0,i||0),n.transformPoint(r),e.push(r.x,r.y)}}]),GraphicsBounds}();st._tempMatrix=new f,st._initMatrix=new f,st._tempPoints=[],st._tempMatrixArrays=[],st._tempCmds=[];var ot=function SpriteConst(){_classCallCheck(this,SpriteConst)};ot.ALPHA=1,ot.TRANSFORM=2,ot.BLEND=4,ot.CANVAS=8,ot.FILTERS=16,ot.MASK=32,ot.CLIP=64,ot.STYLE=128,ot.TEXTURE=256,ot.GRAPHICS=512,ot.LAYAGL3D=1024,ot.CUSTOM=2048,ot.ONECHILD=4096,ot.CHILDS=8192,ot.REPAINT_NONE=0,ot.REPAINT_NODE=1,ot.REPAINT_CACHE=2,ot.REPAINT_ALL=3;var lt=function(){function ClipRectCmd(){_classCallCheck(this,ClipRectCmd)}return _createClass(ClipRectCmd,[{key:"recover",value:function(){n.recover("ClipRectCmd",this)}},{key:"run",value:function(e,t,i){e.clipRect(this.x+t,this.y+i,this.width,this.height)}},{key:"cmdID",get:function(){return ClipRectCmd.ID}}],[{key:"create",value:function(e,t,i,r){var a=n.getItemByClass("ClipRectCmd",ClipRectCmd);return a.x=e,a.y=t,a.width=i,a.height=r,a}}]),ClipRectCmd}();lt.ID="ClipRect";var ht=function(){function DrawTexturesCmd(){_classCallCheck(this,DrawTexturesCmd)}return _createClass(DrawTexturesCmd,[{key:"recover",value:function(){this.texture._removeReference(),this.texture=null,this.pos=null,n.recover("DrawTexturesCmd",this)}},{key:"run",value:function(e,t,i){e.drawTextures(this.texture,this.pos,t,i)}},{key:"cmdID",get:function(){return DrawTexturesCmd.ID}}],[{key:"create",value:function(e,t){var i=n.getItemByClass("DrawTexturesCmd",DrawTexturesCmd);return i.texture=e,e._addReference(),i.pos=t,i}}]),DrawTexturesCmd}();ht.ID="DrawTextures";var ut=function(){function FillTextCmd(){_classCallCheck(this,FillTextCmd),this._textIsWorldText=!1,this._fontColor=4294967295,this._strokeColor=0,this._fontObj=FillTextCmd._defFontObj,this._nTexAlign=0}return _createClass(FillTextCmd,[{key:"recover",value:function(){n.recover("FillTextCmd",this)}},{key:"run",value:function(e,t,n){i.stage.isGlobalRepaint()&&this._textIsWorldText&&this._text.cleanCache(),this._words?Ze._textRender.fillWords(e,this._words,this.x+t,this.y+n,this._fontObj,this._color,this._borderColor,this._lineWidth):this._textIsWorldText?e._fast_filltext(this._text,this.x+t,this.y+n,this._fontObj,this._color,this._borderColor,this._lineWidth,this._nTexAlign,0):Ze._textRender.filltext(e,this._text,this.x+t,this.y+n,this.font,this.color,this._borderColor,this._lineWidth,this._textAlign)}},{key:"cmdID",get:function(){return FillTextCmd.ID}},{key:"text",get:function(){return this._text},set:function(e){this._text=e,this._textIsWorldText=e instanceof Ye,this._textIsWorldText&&this._text.cleanCache()}},{key:"font",get:function(){return this._font},set:function(e){this._font=e,this._fontObj=He.Parse(e),this._textIsWorldText&&this._text.cleanCache()}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._fontColor=Q.create(e).numColor,this._textIsWorldText&&this._text.cleanCache()}},{key:"textAlign",get:function(){return this._textAlign},set:function(e){switch(this._textAlign=e,e){case"center":this._nTexAlign=i.Context.ENUM_TEXTALIGN_CENTER;break;case"right":this._nTexAlign=i.Context.ENUM_TEXTALIGN_RIGHT;break;default:this._nTexAlign=i.Context.ENUM_TEXTALIGN_DEFAULT}this._textIsWorldText&&this._text.cleanCache()}}],[{key:"create",value:function(e,t,i,r,a,s,o,l,h){var u=n.getItemByClass("FillTextCmd",FillTextCmd);return u.text=e,u._textIsWorldText=e instanceof Ye,u._words=t,u.x=i,u.y=r,u.font=a,u.color=s,u.textAlign=o,u._lineWidth=l,u._borderColor=h,u}}]),FillTextCmd}();ut.ID="FillText",ut._defFontObj=new He(null);var ct=function(){function CacheManger(){_classCallCheck(this,CacheManger)}return _createClass(CacheManger,null,[{key:"regCacheByFunction",value:function(e,t){var i;CacheManger.unRegCacheByFunction(e,t),i={tryDispose:e,getCacheList:t},CacheManger._cacheList.push(i)}},{key:"unRegCacheByFunction",value:function(e,t){var i,n;for(n=CacheManger._cacheList.length,i=0;i<n;i++)if(CacheManger._cacheList[i].tryDispose==e&&CacheManger._cacheList[i].getCacheList==t)return void CacheManger._cacheList.splice(i,1)}},{key:"forceDispose",value:function(){var e,t=CacheManger._cacheList.length;for(e=0;e<t;e++)CacheManger._cacheList[e].tryDispose(!0)}},{key:"beginCheck",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:15e3;i.systemTimer.loop(e,null,CacheManger._checkLoop)}},{key:"stopCheck",value:function(){i.systemTimer.clear(null,CacheManger._checkLoop)}},{key:"_checkLoop",value:function(){var e=CacheManger._cacheList;if(!(e.length<1)){var t,n,r=i.Browser.now();for(n=t=e.length;t>0&&(CacheManger._index++,CacheManger._index=CacheManger._index%n,e[CacheManger._index].tryDispose(!1),!(i.Browser.now()-r>CacheManger.loopTimeLimit));)t--}}}]),CacheManger}();ct.loopTimeLimit=2,ct._cacheList=[],ct._index=0;var _t=function(){function VectorGraphManager(){_classCallCheck(this,VectorGraphManager),this.useDic={},this.shapeDic={},this.shapeLineDic={},this._id=0,this._checkKey=!1,this._freeIdArray=[],ct.regCacheByFunction(this.startDispose.bind(this),this.getCacheList.bind(this))}return _createClass(VectorGraphManager,[{key:"getId",value:function(){return this._id++}},{key:"addShape",value:function(e,t){this.shapeDic[e]=t,this.useDic[e]||(this.useDic[e]=!0)}},{key:"addLine",value:function(e,t){this.shapeLineDic[e]=t,this.shapeLineDic[e]||(this.shapeLineDic[e]=!0)}},{key:"getShape",value:function(e){this._checkKey&&null!=this.useDic[e]&&(this.useDic[e]=!0)}},{key:"deleteShape",value:function(e){this.shapeDic[e]&&(this.shapeDic[e]=null,delete this.shapeDic[e]),this.shapeLineDic[e]&&(this.shapeLineDic[e]=null,delete this.shapeLineDic[e]),null!=this.useDic[e]&&delete this.useDic[e]}},{key:"getCacheList",value:function(){var e,t=[];for(e in this.shapeDic)t.push(this.shapeDic[e]);for(e in this.shapeLineDic)t.push(this.shapeLineDic[e]);return t}},{key:"startDispose",value:function(e){var t;for(t in this.useDic)this.useDic[t]=!1;this._checkKey=!0}},{key:"endDispose",value:function(){if(this._checkKey){var e;for(e in this.useDic)this.useDic[e]||this.deleteShape(e);this._checkKey=!1}}}],[{key:"getInstance",value:function(){return VectorGraphManager.instance=VectorGraphManager.instance||new VectorGraphManager}}]),VectorGraphManager}(),dt=function(){function Graphics(){_classCallCheck(this,Graphics),this._sp=null,this._one=null,this._render=this._renderEmpty,this._cmds=null,this._vectorgraphArray=null,this._graphicBounds=null,this.autoDestroy=!1,this._createData()}return _createClass(Graphics,[{key:"_createData",value:function(){}},{key:"_clearData",value:function(){}},{key:"_destroyData",value:function(){}},{key:"destroy",value:function(){this.clear(!0),this._graphicBounds&&this._graphicBounds.destroy(),this._graphicBounds=null,this._vectorgraphArray=null,this._sp&&(this._sp._renderType=0,this._sp._setRenderType(0),this._sp=null),this._destroyData()}},{key:"clear",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(e){var t=this._one;if(this._cmds){var i,n=this._cmds.length;for(i=0;i<n;i++)(t=this._cmds[i]).recover();this._cmds.length=0}else t&&t.recover()}else this._cmds=null;if(this._one=null,this._render=this._renderEmpty,this._clearData(),this._sp&&(this._sp._renderType&=~ot.GRAPHICS,this._sp._setRenderType(this._sp._renderType)),this._repaint(),this._vectorgraphArray){for(i=0,n=this._vectorgraphArray.length;i<n;i++)_t.getInstance().deleteShape(this._vectorgraphArray[i]);this._vectorgraphArray.length=0}}},{key:"_clearBoundsCache",value:function(){this._graphicBounds&&this._graphicBounds.reset()}},{key:"_initGraphicBounds",value:function(){this._graphicBounds||(this._graphicBounds=st.create(),this._graphicBounds._graphics=this)}},{key:"_repaint",value:function(){this._clearBoundsCache(),this._sp&&this._sp.repaint()}},{key:"_isOnlyOne",value:function(){return!this._cmds||0===this._cmds.length}},{key:"getBounds",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this._initGraphicBounds(),this._graphicBounds.getBounds(e)}},{key:"getBoundPoints",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this._initGraphicBounds(),this._graphicBounds.getBoundPoints(e)}},{key:"drawImage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;if(!e)return null;if(n||(n=e.sourceWidth),r||(r=e.sourceHeight),e.getIsReady()){var a=n/e.sourceWidth,s=r/e.sourceHeight;if(n=e.width*a,r=e.height*s,n<=0||r<=0)return null;t+=e.offsetX*a,i+=e.offsetY*s}this._sp&&(this._sp._renderType|=ot.GRAPHICS,this._sp._setRenderType(this._sp._renderType));var l=o.create.call(this,e,t,i,n,r);return null==this._one?(this._one=l,this._render=this._renderOneImg):this._saveToCmd(null,l),this._repaint(),l}},{key:"drawTexture",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,h=arguments.length>9?arguments[9]:void 0;if(!e||s<.01)return null;if(!e.getIsReady())return null;if(n||(n=e.sourceWidth),r||(r=e.sourceHeight),e.getIsReady()){var u=n/e.sourceWidth,c=r/e.sourceHeight;if(n=e.width*u,r=e.height*c,n<=0||r<=0)return null;t+=e.offsetX*u,i+=e.offsetY*c}this._sp&&(this._sp._renderType|=ot.GRAPHICS,this._sp._setRenderType(this._sp._renderType));var _=Z.create.call(this,e,t,i,n,r,a,s,o,l,h);return this._repaint(),this._saveToCmd(null,_)}},{key:"drawTextures",value:function(e,t){return e?this._saveToCmd(it._context.drawTextures,ht.create.call(this,e,t)):null}},{key:"drawTriangles",value:function(e,t,i,n,r,a){var s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,h=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,u=arguments.length>10&&void 0!==arguments[10]?arguments[10]:void 0;return this._saveToCmd(it._context.drawTriangles,nt.create.call(this,e,t,i,n,r,a,s,o,l,h,u))}},{key:"fillTexture",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"repeat",s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;return e&&e.getIsReady()?this._saveToCmd(it._context._fillTexture,$.create.call(this,e,t,i,n,r,a,s||v.EMPTY,{})):null}},{key:"_saveToCmd",value:function(e,t){return this._sp&&(this._sp._renderType|=ot.GRAPHICS,this._sp._setRenderType(this._sp._renderType)),null==this._one?(this._one=t,this._render=this._renderOne):(this._render=this._renderAll,0===(this._cmds||(this._cmds=[])).length&&this._cmds.push(this._one),this._cmds.push(t)),this._repaint(),t}},{key:"clipRect",value:function(e,t,i,n){return this._saveToCmd(it._context.clipRect,lt.create.call(this,e,t,i,n))}},{key:"fillText",value:function(e,t,n,r,a,s){return this._saveToCmd(it._context.fillText,ut.create.call(this,e,null,t,n,r||i.Text.defaultFontStr(),a,s,0,""))}},{key:"fillBorderText",value:function(e,t,n,r,a,s,o,l){return this._saveToCmd(it._context.fillText,ut.create.call(this,e,null,t,n,r||i.Text.defaultFontStr(),a,s,o,l))}},{key:"fillWords",value:function(e,t,n,r,a){return this._saveToCmd(it._context.fillText,ut.create.call(this,null,e,t,n,r||i.Text.defaultFontStr(),a))}},{key:"fillBorderWords",value:function(e,t,n,r,a,s,o){return this._saveToCmd(it._context.fillText,ut.create.call(this,null,e,t,n,r||i.Text.defaultFontStr(),a,"",o,s))}},{key:"strokeText",value:function(e,t,n,r,a,s,o){return this._saveToCmd(it._context.fillText,ut.create.call(this,e,null,t,n,r||i.Text.defaultFontStr(),null,o,s,a))}},{key:"alpha",value:function(e){return this._saveToCmd(it._context.alpha,r.create.call(this,e))}},{key:"transform",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return this._saveToCmd(it._context._transform,ie.create.call(this,e,t,i))}},{key:"rotate",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return this._saveToCmd(it._context._rotate,ee.create.call(this,e,t,i))}},{key:"scale",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return this._saveToCmd(it._context._scale,te.create.call(this,e,t,i,n))}},{key:"translate",value:function(e,t){return this._saveToCmd(it._context.translate,ne.create.call(this,e,t))}},{key:"save",value:function(){return this._saveToCmd(it._context._save,at.create.call(this))}},{key:"restore",value:function(){return this._saveToCmd(it._context.restore,J.create.call(this))}},{key:"replaceText",value:function(e){this._repaint();var t=this._cmds;if(t){for(var i=t.length-1;i>-1;i--)if(this._isTextCmd(t[i]))return t[i].text=e,!0}else if(this._one&&this._isTextCmd(this._one))return this._one.text=e,!0;return!1}},{key:"_isTextCmd",value:function(e){return e.cmdID==ut.ID}},{key:"replaceTextColor",value:function(e){this._repaint();var t=this._cmds;if(t)for(var i=t.length-1;i>-1;i--)this._isTextCmd(t[i])&&this._setTextCmdColor(t[i],e);else this._one&&this._isTextCmd(this._one)&&this._setTextCmdColor(this._one,e)}},{key:"_setTextCmdColor",value:function(e,t){switch(e.cmdID){case ut.ID:e.color=t}}},{key:"loadImage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=i.Loader.getRes(e);o?o.getIsReady()?this.drawImage(o,t,n,r,a):o.once(We.READY,this,this.drawImage,[o,t,n,r,a]):((o=new Ve).load(e),i.Loader.cacheTexture(e,o),o.once(We.READY,this,this.drawImage,[o,t,n,r,a])),null!=s&&(o.getIsReady()?s.call(this._sp):o.on(We.READY,this._sp,s))}},{key:"_renderEmpty",value:function(e,t,i,n){}},{key:"_renderAll",value:function(e,t,i,n){for(var r=this._cmds,a=0,s=r.length;a<s;a++)r[a].run(t,i,n)}},{key:"_renderOne",value:function(e,t,i,n){t.sprite=e,this._one.run(t,i,n)}},{key:"_renderOneImg",value:function(e,t,i,n){t.sprite=e,this._one.run(t,i,n)}},{key:"drawLine",value:function(e,t,i,n,r){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,s=a<1||a%2==0?0:.5;return this._saveToCmd(it._context._drawLine,l.create.call(this,e+s,t+s,i+s,n+s,r,a,0))}},{key:"drawLines",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;if(!i||i.length<4)return null;var a=r<1||r%2==0?0:.5;return this._saveToCmd(it._context._drawLines,h.create.call(this,e+a,t+a,i,n,r,0))}},{key:"drawCurves",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;return this._saveToCmd(it._context.drawCurves,s.create.call(this,e,t,i,n,r))}},{key:"drawRect",value:function(e,t,i,n,r){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,o=s>=1&&a?s/2:0,l=a?s:0;return this._saveToCmd(it._context.drawRect,d.create.call(this,e+o,t+o,i-l,n-l,r,a,s))}},{key:"drawCircle",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,o=s>=1&&r?s/2:0;return this._saveToCmd(it._context._drawCircle,a.create.call(this,e,t,i-o,n,r,s,0))}},{key:"drawPie",value:function(e,t,i,n,r,a){var s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,l=o>=1&&s?o/2:0,h=s?o:0;return this._saveToCmd(it._context._drawPie,c.create.call(this,e+l,t+l,i-h,j.toRadian(n),j.toRadian(r),a,s,o,0))}},{key:"drawPoly",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,s=!1;s=!(i.length>6);var o=a>=1&&r?a%2==0?0:.5:0;return this._saveToCmd(it._context._drawPoly,_.create.call(this,e+o,t+o,i,n,r,a,s,0))}},{key:"drawPath",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return this._saveToCmd(it._context._drawPath,u.create.call(this,e,t,i,n,r))}},{key:"draw9Grid",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;this._saveToCmd(null,rt.create(e,t,i,n,r,a))}},{key:"cmds",get:function(){return this._cmds},set:function(e){this._sp&&(this._sp._renderType|=ot.GRAPHICS,this._sp._setRenderType(this._sp._renderType)),this._cmds=e,this._render=this._renderAll,this._repaint()}}]),Graphics}(),ft=function Const(){_classCallCheck(this,Const)};ft.NOT_ACTIVE=1,ft.ACTIVE_INHIERARCHY=2,ft.AWAKED=4,ft.NOT_READY=8,ft.DISPLAY=16,ft.HAS_ZORDER=32,ft.HAS_MOUSE=64,ft.DISPLAYED_INSTAGE=128,ft.DRAWCALL_OPTIMIZE=256;var vt=function(){function LayaGLQuickRunner(){_classCallCheck(this,LayaGLQuickRunner)}return _createClass(LayaGLQuickRunner,null,[{key:"__init__",value:function(){LayaGLQuickRunner.map[ot.ALPHA|ot.TRANSFORM|ot.GRAPHICS]=LayaGLQuickRunner.alpha_transform_drawLayaGL,LayaGLQuickRunner.map[ot.ALPHA|ot.GRAPHICS]=LayaGLQuickRunner.alpha_drawLayaGL,LayaGLQuickRunner.map[ot.TRANSFORM|ot.GRAPHICS]=LayaGLQuickRunner.transform_drawLayaGL,LayaGLQuickRunner.map[ot.TRANSFORM|ot.CHILDS]=LayaGLQuickRunner.transform_drawNodes,LayaGLQuickRunner.map[ot.ALPHA|ot.TRANSFORM|ot.TEXTURE]=LayaGLQuickRunner.alpha_transform_drawTexture,LayaGLQuickRunner.map[ot.ALPHA|ot.TEXTURE]=LayaGLQuickRunner.alpha_drawTexture,LayaGLQuickRunner.map[ot.TRANSFORM|ot.TEXTURE]=LayaGLQuickRunner.transform_drawTexture,LayaGLQuickRunner.map[ot.GRAPHICS|ot.CHILDS]=LayaGLQuickRunner.drawLayaGL_drawNodes}},{key:"transform_drawTexture",value:function(e,t,i,n){e._style;var r=e.texture;t.saveTransform(LayaGLQuickRunner.curMat),t.transformByMatrix(e.transform,i,n);var a=e._width||r.sourceWidth,s=e._height||r.sourceHeight,o=a/r.sourceWidth,l=s/r.sourceHeight;if(a=r.width*o,s=r.height*l,a<=0||s<=0)return null;var h=-e.pivotX+r.offsetX*o,u=-e.pivotY+r.offsetY*l;t.drawTexture(r,h,u,a,s),t.restoreTransform(LayaGLQuickRunner.curMat)}},{key:"alpha_drawTexture",value:function(e,t,i,n){var r,a=e._style,s=e.texture;if((r=a.alpha)>.01||e._needRepaint()){var o=t.globalAlpha;t.globalAlpha*=r,t.drawTexture(s,i-a.pivotX+s.offsetX,n-a.pivotY+s.offsetY,e._width||s.width,e._height||s.height),t.globalAlpha=o}}},{key:"alpha_transform_drawTexture",value:function(e,t,i,n){var r,a=e._style,s=e.texture;if((r=a.alpha)>.01||e._needRepaint()){var o=t.globalAlpha;t.globalAlpha*=r,t.saveTransform(LayaGLQuickRunner.curMat),t.transformByMatrix(e.transform,i,n),t.drawTexture(s,-a.pivotX+s.offsetX,-a.pivotY+s.offsetY,e._width||s.width,e._height||s.height),t.restoreTransform(LayaGLQuickRunner.curMat),t.globalAlpha=o}}},{key:"alpha_transform_drawLayaGL",value:function(e,t,i,n){var r,a=e._style;if((r=a.alpha)>.01||e._needRepaint()){var s=t.globalAlpha;t.globalAlpha*=r,t.saveTransform(LayaGLQuickRunner.curMat),t.transformByMatrix(e.transform,i,n),e._graphics&&e._graphics._render(e,t,-a.pivotX,-a.pivotY),t.restoreTransform(LayaGLQuickRunner.curMat),t.globalAlpha=s}}},{key:"alpha_drawLayaGL",value:function(e,t,i,n){var r,a=e._style;if((r=a.alpha)>.01||e._needRepaint()){var s=t.globalAlpha;t.globalAlpha*=r,e._graphics&&e._graphics._render(e,t,i-a.pivotX,n-a.pivotY),t.globalAlpha=s}}},{key:"transform_drawLayaGL",value:function(e,t,i,n){var r=e._style;t.saveTransform(LayaGLQuickRunner.curMat),t.transformByMatrix(e.transform,i,n),e._graphics&&e._graphics._render(e,t,-r.pivotX,-r.pivotY),t.restoreTransform(LayaGLQuickRunner.curMat)}},{key:"transform_drawNodes",value:function(e,t,i,n){var r=e._getBit(ft.DRAWCALL_OPTIMIZE)&&t.drawCallOptimize(!0),a=e._style;t.saveTransform(LayaGLQuickRunner.curMat),t.transformByMatrix(e.transform,i,n),i=-a.pivotX,n=-a.pivotY;var s,o=e._children,l=o.length;if(a.viewport){var h,u,c=a.viewport,_=c.x,d=c.y,f=c.right,v=c.bottom;for(p=0;p<l;++p)(s=o[p])._visible&&(h=s._x)<f&&h+s.width>_&&(u=s._y)<v&&u+s.height>d&&s.render(t,i,n)}else for(var p=0;p<l;++p)(s=o[p])._visible&&s.render(t,i,n);t.restoreTransform(LayaGLQuickRunner.curMat),r&&t.drawCallOptimize(!1)}},{key:"drawLayaGL_drawNodes",value:function(e,t,i,n){var r=e._getBit(ft.DRAWCALL_OPTIMIZE)&&t.drawCallOptimize(!0),a=e._style;i-=a.pivotX,n-=a.pivotY,e._graphics&&e._graphics._render(e,t,i,n);var s,o=e._children,l=o.length;if(a.viewport){var h,u,c=a.viewport,_=c.x,d=c.y,f=c.right,v=c.bottom;for(p=0;p<l;++p)(s=o[p])._visible&&(h=s._x)<f&&h+s.width>_&&(u=s._y)<v&&u+s.height>d&&s.render(t,i,n)}else for(var p=0;p<l;++p)(s=o[p])._visible&&s.render(t,i,n);r&&t.drawCallOptimize(!1)}}]),LayaGLQuickRunner}();vt.map=[],vt.curMat=new f;var pt=function(){function RenderSprite(e,t){if(_classCallCheck(this,RenderSprite),vt.map[e])return this._fun=vt.map[e],void(this._next=RenderSprite.NORENDER);switch(this._next=t||RenderSprite.NORENDER,e){case 0:return void(this._fun=this._no);case ot.ALPHA:return void(this._fun=this._alpha);case ot.TRANSFORM:return void(this._fun=this._transform);case ot.BLEND:return void(this._fun=this._blend);case ot.CANVAS:return void(this._fun=this._canvas);case ot.MASK:return void(this._fun=this._mask);case ot.CLIP:return void(this._fun=this._clip);case ot.STYLE:return void(this._fun=this._style);case ot.GRAPHICS:return void(this._fun=this._graphics);case ot.CHILDS:return void(this._fun=this._children);case ot.CUSTOM:return void(this._fun=this._custom);case ot.TEXTURE:return void(this._fun=this._texture);case ot.FILTERS:return void(this._fun=K._filter);case RenderSprite.INIT:return void(this._fun=RenderSprite._initRenderFun)}this.onCreate(e)}return _createClass(RenderSprite,[{key:"onCreate",value:function(e){}},{key:"_style",value:function(e,t,i,n){var r=e._style;null!=r.render&&r.render(e,t,i,n);var a=this._next;a._fun.call(a,e,t,i,n)}},{key:"_no",value:function(e,t,i,n){}},{key:"_custom",value:function(e,t,i,n){e.customRender(t,i,n),this._next._fun.call(this._next,e,t,0,0)}},{key:"_clip",value:function(e,t,i,n){var r=this._next;if(r!=RenderSprite.NORENDER){var a=e._style.scrollRect,s=a.width,o=a.height;0!==s&&0!==o&&(t.save(),t.clipRect(i,n,s,o),r._fun.call(r,e,t,i-a.x,n-a.y),t.restore())}}},{key:"_texture",value:function(e,t,i,n){var r=e.texture;if(r._getSource()){var a=e._width||r.sourceWidth,s=e._height||r.sourceHeight,o=a/r.sourceWidth,l=s/r.sourceHeight;if(a=r.width*o,s=r.height*l,a<=0||s<=0)return;var h=i-e.pivotX+r.offsetX*o,u=n-e.pivotY+r.offsetY*l;t.drawTexture(r,h,u,a,s)}var c=this._next;c!=RenderSprite.NORENDER&&c._fun.call(c,e,t,i,n)}},{key:"_graphics",value:function(e,t,i,n){var r=e._style,a=e._graphics;a&&a._render(e,t,i-r.pivotX,n-r.pivotY);var s=this._next;s!=RenderSprite.NORENDER&&s._fun.call(s,e,t,i,n)}},{key:"_image",value:function(e,t,i,n){var r=e._style;t.drawTexture2(i,n,r.pivotX,r.pivotY,e.transform,e._graphics._one)}},{key:"_image2",value:function(e,t,i,n){var r=e._style;t.drawTexture2(i,n,r.pivotX,r.pivotY,e.transform,e._graphics._one)}},{key:"_alpha",value:function(e,t,i,n){var r;if((r=e._style.alpha)>.01||e._needRepaint()){var a=t.globalAlpha;t.globalAlpha*=r;var s=this._next;s._fun.call(s,e,t,i,n),t.globalAlpha=a}}},{key:"_transform",value:function(e,t,i,n){var r=e.transform,a=this._next;e._style;r&&a!=RenderSprite.NORENDER?(t.save(),t.transform(r.a,r.b,r.c,r.d,r.tx+i,r.ty+n),a._fun.call(a,e,t,0,0),t.restore()):a!=RenderSprite.NORENDER&&a._fun.call(a,e,t,i,n)}},{key:"_children",value:function(e,t,i,n){var r,a=e._style,s=e._children,o=s.length;i-=e.pivotX,n-=e.pivotY;var l=e._getBit(ft.DRAWCALL_OPTIMIZE)&&t.drawCallOptimize(!0);if(a.viewport){var h,u,c=a.viewport,_=c.x,d=c.y,f=c.right,v=c.bottom;for(p=0;p<o;++p)(r=s[p])._visible&&(h=r._x)<f&&h+r.width>_&&(u=r._y)<v&&u+r.height>d&&r.render(t,i,n)}else for(var p=0;p<o;++p)(r=s[p])._visible&&r.render(t,i,n);l&&t.drawCallOptimize(!1)}},{key:"_canvas",value:function(e,t,n,r){var a=e._cacheStyle,s=this._next;if(a.enableCanvasRender){"bitmap"===a.cacheAs?N.canvasBitmap++:N.canvasNormal++;var o=!1,l=!1;if(a.canvas){var h=a.canvas,u=(h.context,h.touches);if(u)for(var c=0;c<u.length;c++)if(u[c].deleted){l=!0;break}o=h.isCacheValid&&!h.isCacheValid()}if(e._needRepaint()||!a.canvas||l||o||i.stage.isGlobalRepaint())if("normal"===a.cacheAs){if(t._targets)return void s._fun.call(s,e,t,n,r);this._canvas_webgl_normal_repaint(e,t)}else this._canvas_repaint(e,t,n,r);var _=a.cacheRect;t.drawCanvas(a.canvas,n+_.x,r+_.y,_.width,_.height)}else s._fun.call(s,e,t,n,r)}},{key:"_canvas_repaint",value:function(e,t,i,n){var r,a,s,o,l,h,u,c,_,d=e._cacheStyle,f=this._next,v=d.canvas,p=d.cacheAs;if(u=(_=d._calculateCacheRect(e,p,i,n)).x,c=_.y,l=(o=d.cacheRect).width*u,h=o.height*c,a=o.x,s=o.y,"bitmap"===p&&(l>2048||h>2048))return console.warn("cache bitmap size larger than 2048,cache ignored"),d.releaseContext(),void f._fun.call(f,e,t,i,n);if(v||(d.createContext(),v=d.canvas),(r=v.context).sprite=e,(v.width!=l||v.height!=h)&&v.size(l,h),"bitmap"===p?r.asBitmap=!0:"normal"===p&&(r.asBitmap=!1),r.clear(),1!=u||1!=c){var g=r;g.save(),g.scale(u,c),f._fun.call(f,e,r,-a,-s),g.restore(),e._applyFilters()}else g=r,f._fun.call(f,e,r,-a,-s),e._applyFilters();d.staticCache&&(d.reCache=!1),N.canvasReCache++}},{key:"_canvas_webgl_normal_repaint",value:function(e,t){var i=e._cacheStyle,n=this._next,r=i.canvas,a=i.cacheAs;i._calculateCacheRect(e,a,0,0),r||(r=new be(t,e),i.canvas=r);var s=r.context;r.startRec(),n._fun.call(n,e,s,e.pivotX,e.pivotY),e._applyFilters(),N.canvasReCache++,r.endRec()}},{key:"_blend",value:function(e,t,i,n){var r=e._style,a=this._next;r.blendMode?(t.save(),t.globalCompositeOperation=r.blendMode,a._fun.call(a,e,t,i,n),t.restore()):a._fun.call(a,e,t,i,n)}},{key:"_mask",value:function(e,t,i,n){var r=this._next,a=e.mask,s=t;if(a){s.save();var o=s.globalCompositeOperation,l=new p;if(l.copyFrom(a.getBounds()),l.width=Math.round(l.width),l.height=Math.round(l.height),l.x=Math.round(l.x),l.y=Math.round(l.y),l.width>0&&l.height>0){var h=l.width,u=l.height,c=O.getRT(h,u);s.breakNextMerge(),s.pushRT(),s.addRenderObject(z.create([s,c,h,u],RenderSprite.tmpTarget,this)),a.render(s,-l.x,-l.y),s.breakNextMerge(),s.popRT(),s.save();s.clipRect(i+l.x-e.getStyle().pivotX+.1,n+l.y-e.getStyle().pivotY+.1,h-.2,u-.2),r._fun.call(r,e,s,i,n),s.restore(),o=s.globalCompositeOperation,s.addRenderObject(z.create(["mask"],RenderSprite.setBlendMode,this));var _=Y.create(U.TEXTURE2D,0),d=Ve.INV_UV;s.drawTarget(c,i+l.x-e.getStyle().pivotX,n+l.y-e.getStyle().pivotY,h,u,f.TEMP.identity(),_,d,6),s.addRenderObject(z.create([c],RenderSprite.recycleTarget,this)),s.addRenderObject(z.create([o],RenderSprite.setBlendMode,this))}s.restore()}else r._fun.call(r,e,t,i,n)}}],[{key:"__init__",value:function(){var e,t,i;for(vt.__init__(),i=new RenderSprite(RenderSprite.INIT,null),t=RenderSprite.renders.length=2*ot.CHILDS,e=0;e<t;e++)RenderSprite.renders[e]=i;RenderSprite.renders[0]=new RenderSprite(0,null)}},{key:"_initRenderFun",value:function(e,t,i,n){var r=e._renderType;(RenderSprite.renders[r]=RenderSprite._getTypeRender(r))._fun(e,t,i,n)}},{key:"_getTypeRender",value:function(e){if(vt.map[e])return new RenderSprite(e,null);for(var t=null,i=ot.CHILDS;i>0;)i&e&&(t=new RenderSprite(i,t)),i>>=1;return t}},{key:"tmpTarget",value:function(e,t,i,n){t.start(),t.clear(0,0,0,0)}},{key:"recycleTarget",value:function(e){O.releaseRT(e)}},{key:"setBlendMode",value:function(e){var t=y.mainContext;F.targetFns[F.TOINT[e]](t)}}]),RenderSprite}();pt.INIT=69905,pt.renders=[],pt.NORENDER=new pt(0,null),pt.tempUV=new Array(8);var gt=function(e){function HTMLCanvas(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return _classCallCheck(this,HTMLCanvas),(e=_possibleConstructorReturn(this,_getPrototypeOf(HTMLCanvas).call(this)))._source=t?Ke.createElement("canvas"):_assertThisInitialized(e),e.lock=!0,e}return _inherits(HTMLCanvas,e),_createClass(HTMLCanvas,[{key:"_getSource",value:function(){return this._source}},{key:"clear",value:function(){this._ctx&&(this._ctx.clear?this._ctx.clear():this._ctx.clearRect(0,0,this._width,this._height)),this._texture&&(this._texture.destroy(),this._texture=null)}},{key:"destroy",value:function(){_get(_getPrototypeOf(HTMLCanvas.prototype),"destroy",this).call(this),this._setCPUMemory(0),this._ctx&&this._ctx.destroy&&this._ctx.destroy(),this._ctx=null}},{key:"release",value:function(){}},{key:"_setContext",value:function(e){this._ctx=e}},{key:"getContext",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.context}},{key:"getMemSize",value:function(){return 0}},{key:"size",value:function(e,t){(this._width!=e||this._height!=t||this._source&&(this._source.width!=e||this._source.height!=t))&&(this._width=e,this._height=t,this._setCPUMemory(e*t*4),this._ctx&&this._ctx.size&&this._ctx.size(e,t),this._source&&(this._source.height=t,this._source.width=e),this._texture&&(this._texture.destroy(),this._texture=null))}},{key:"getTexture",value:function(){if(!this._texture){var e=new w;e.loadImageSource(this.source),this._texture=new Ve(e)}return this._texture}},{key:"toBase64",value:function(e,t){if(this._source){if(i.Render.isConchApp){var n=window;if(2==n.conchConfig.threadMode)throw"native 2 thread mode use toBase64Async";var r=this._ctx._targets.sourceWidth,a=this._ctx._targets.sourceHeight,s=this._ctx._targets.getData(0,0,r,a);return n.conchToBase64FlipY?n.conchToBase64FlipY(e,t,s.buffer,r,a):n.conchToBase64(e,t,s.buffer,r,a)}return this._source.toDataURL(e,t)}return null}},{key:"toBase64Async",value:function(e,t,i){var n=this._ctx._targets.sourceWidth,r=this._ctx._targets.sourceHeight;this._ctx._targets.getDataAsync(0,0,n,r,(function(a){var s=window,o=s.conchToBase64FlipY?s.conchToBase64FlipY(e,t,a.buffer,n,r):s.conchToBase64(e,t,a.buffer,n,r);i(o)}))}},{key:"source",get:function(){return this._source}},{key:"context",get:function(){return this._ctx?this._ctx:(this._source==this?this._ctx=new i.Context:this._ctx=this._source.getContext(i.Render.isConchApp?"layagl":"2d"),this._ctx._canvas=this,this._ctx)}}]),HTMLCanvas}(E),yt=function(){function HitArea(){_classCallCheck(this,HitArea)}return _createClass(HitArea,[{key:"contains",value:function(e,t){return!!HitArea._isHitGraphic(e,t,this.hit)&&!HitArea._isHitGraphic(e,t,this.unHit)}},{key:"hit",get:function(){return this._hit||(this._hit=new i.Graphics),this._hit},set:function(e){this._hit=e}},{key:"unHit",get:function(){return this._unHit||(this._unHit=new i.Graphics),this._unHit},set:function(e){this._unHit=e}}],[{key:"_isHitGraphic",value:function(e,t,i){if(!i)return!1;var n,r,a,s=i.cmds;if(!s&&i._one&&((s=HitArea._cmds).length=1,s[0]=i._one),!s)return!1;for(r=s.length,n=0;n<r;n++)if(a=s[n]){switch(a.cmdID){case"Translate":e-=a.tx,t-=a.ty}if(HitArea._isHitCmd(e,t,a))return!0}return!1}},{key:"_isHitCmd",value:function(e,t,i){if(!i)return!1;var n=!1;switch(i.cmdID){case"DrawRect":HitArea._rect.setTo(i.x,i.y,i.width,i.height),n=HitArea._rect.contains(e,t);break;case"DrawCircle":n=(e-=i.x)*e+(t-=i.y)*t<i.radius*i.radius;break;case"DrawPoly":e-=i.x,t-=i.y,n=HitArea._ptInPolygon(e,t,i.points)}return n}},{key:"_ptInPolygon",value:function(e,t,i){var n=HitArea._ptPoint;n.setTo(e,t);var r,a,s,o,l,h=0;l=i.length;for(var u=0;u<l;u+=2){if(r=i[u],a=i[u+1],s=i[(u+2)%l],a!=(o=i[(u+3)%l]))if(!(n.y<Math.min(a,o)))if(!(n.y>=Math.max(a,o)))(n.y-a)*(s-r)/(o-a)+r>n.x&&h++}return h%2==1}}]),HitArea}();yt._cmds=[],yt._rect=new p,yt._ptPoint=new v;var mt=function(){function ClassUtils(){_classCallCheck(this,ClassUtils)}return _createClass(ClassUtils,null,[{key:"regClass",value:function(e,t){ClassUtils._classMap[e]=t}},{key:"regShortClassName",value:function(e){for(var t=0;t<e.length;t++){var i=e[t],n=i.name;ClassUtils._classMap[n]=i}}},{key:"getRegClass",value:function(e){return ClassUtils._classMap[e]}},{key:"getClass",value:function(e){var t=ClassUtils._classMap[e]||ClassUtils._classMap["Laya."+e]||e,n=i.Laya;return"string"==typeof t?i.__classMap[t]||n[e]:t}},{key:"getInstance",value:function(e){var t=ClassUtils.getClass(e);return t?new t:(console.warn("[error] Undefined class:",e),null)}},{key:"createByJson",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;"string"==typeof e&&(e=JSON.parse(e));var a=e.props;if(!t&&!(t=r?r.runWith(e):ClassUtils.getInstance(a.runtime||e.type)))return null;var s=e.child;if(s)for(var o=0,l=s.length;o<l;o++){var h=s[o];if("render"!==h.props.name&&"render"!==h.props.renderType||!t._$set_itemRender)if("Graphic"==h.type)ClassUtils._addGraphicsToSprite(h,t);else if(ClassUtils._isDrawType(h.type))ClassUtils._addGraphicToSprite(h,t,!0);else{var u=ClassUtils.createByJson(h,null,i,n,r);"Script"===h.type?"owner"in u?u.owner=t:"target"in u&&(u.target=t):"mask"==h.props.renderType?t.mask=u:t.addChild(u)}else t.itemRender=h}if(a)for(var c in a){var _=a[c];"var"===c&&i?i[_]=t:_ instanceof Array&&t[c]instanceof Function?t[c].apply(t,_):t[c]=_}return n&&e.customProps&&n.runWith([t,e]),t.created&&t.created(),t}},{key:"_addGraphicsToSprite",value:function(e,t){var i=e.child;if(i&&!(i.length<1)){var n,r,a=ClassUtils._getGraphicsFromSprite(e,t),s=0,o=0;for(e.props&&(s=ClassUtils._getObjVar(e.props,"x",0),o=ClassUtils._getObjVar(e.props,"y",0)),0!=s&&0!=o&&a.translate(s,o),r=i.length,n=0;n<r;n++)ClassUtils._addGraphicToGraphics(i[n],a);0!=s&&0!=o&&a.translate(-s,-o)}}},{key:"_addGraphicToSprite",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=i?ClassUtils._getGraphicsFromSprite(e,t):t.graphics;ClassUtils._addGraphicToGraphics(e,n)}},{key:"_getGraphicsFromSprite",value:function(e,t){if(!e||!e.props)return t.graphics;var i=e.props.renderType;if("hit"===i||"unHit"===i){var n=t._style.hitArea||(t.hitArea=new yt);n[i]||(n[i]=new dt);var r=n[i]}return r||(r=t.graphics),r}},{key:"_getTransformData",value:function(e){var t;("pivotX"in e||"pivotY"in e)&&(t=t||new f).translate(-ClassUtils._getObjVar(e,"pivotX",0),-ClassUtils._getObjVar(e,"pivotY",0));var i=ClassUtils._getObjVar(e,"scaleX",1),n=ClassUtils._getObjVar(e,"scaleY",1),r=ClassUtils._getObjVar(e,"rotation",0);ClassUtils._getObjVar(e,"skewX",0),ClassUtils._getObjVar(e,"skewY",0);return 1==i&&1==n&&0==r||((t=t||new f).scale(i,n),t.rotate(.0174532922222222*r)),t}},{key:"_addGraphicToGraphics",value:function(e,t){var i,n;if((i=e.props)&&(n=ClassUtils.DrawTypeDic[e.type])){var r=t,a=ClassUtils._getParams(i,n[1],n[2],n[3]),s=ClassUtils._tM;(s||1!=ClassUtils._alpha)&&(r.save(),s&&r.transform(s),1!=ClassUtils._alpha&&r.alpha(ClassUtils._alpha)),r[n[0]].apply(r,a),(s||1!=ClassUtils._alpha)&&r.restore()}}},{key:"_adptLineData",value:function(e){return e[2]=parseFloat(e[0])+parseFloat(e[2]),e[3]=parseFloat(e[1])+parseFloat(e[3]),e}},{key:"_adptTextureData",value:function(e){return e[0]=i.Loader.getRes(e[0]),e}},{key:"_adptLinesData",value:function(e){return e[2]=ClassUtils._getPointListByStr(e[2]),e}},{key:"_isDrawType",value:function(e){return"Image"!==e&&e in ClassUtils.DrawTypeDic}},{key:"_getParams",value:function(e,t){var i,n,r,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=ClassUtils._temParam;for(o.length=t.length,n=t.length,i=0;i<n;i++)o[i]=ClassUtils._getObjVar(e,t[i][0],t[i][1]);return ClassUtils._alpha=ClassUtils._getObjVar(e,"alpha",1),(r=ClassUtils._getTransformData(e))?(a||(a=0),r.translate(o[a],o[a+1]),o[a]=o[a+1]=0,ClassUtils._tM=r):ClassUtils._tM=null,s&&ClassUtils[s]&&(o=ClassUtils[s](o)),o}},{key:"_getPointListByStr",value:function(e){var t,i,n=e.split(",");for(i=n.length,t=0;t<i;t++)n[t]=parseFloat(n[t]);return n}},{key:"_getObjVar",value:function(e,t,i){return t in e?e[t]:i}}]),ClassUtils}();mt.DrawTypeDic={Rect:["drawRect",[["x",0],["y",0],["width",0],["height",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Circle:["drawCircle",[["x",0],["y",0],["radius",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Pie:["drawPie",[["x",0],["y",0],["radius",0],["startAngle",0],["endAngle",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Image:["drawTexture",[["x",0],["y",0],["width",0],["height",0]]],Texture:["drawTexture",[["skin",null],["x",0],["y",0],["width",0],["height",0]],1,"_adptTextureData"],FillTexture:["fillTexture",[["skin",null],["x",0],["y",0],["width",0],["height",0],["repeat",null]],1,"_adptTextureData"],FillText:["fillText",[["text",""],["x",0],["y",0],["font",null],["color",null],["textAlign",null]],1],Line:["drawLine",[["x",0],["y",0],["toX",0],["toY",0],["lineColor",null],["lineWidth",0]],0,"_adptLineData"],Lines:["drawLines",[["x",0],["y",0],["points",""],["lineColor",null],["lineWidth",0]],0,"_adptLinesData"],Curves:["drawCurves",[["x",0],["y",0],["points",""],["lineColor",null],["lineWidth",0]],0,"_adptLinesData"],Poly:["drawPoly",[["x",0],["y",0],["points",""],["fillColor",null],["lineColor",null],["lineWidth",1]],0,"_adptLinesData"]},mt._temParam=[],mt._classMap={};var Tt=function(){function BoundsStyle(){_classCallCheck(this,BoundsStyle)}return _createClass(BoundsStyle,[{key:"reset",value:function(){return this.bounds&&this.bounds.recover(),this.userBounds&&this.userBounds.recover(),this.bounds=null,this.userBounds=null,this.temBM=null,this}},{key:"recover",value:function(){n.recover("BoundsStyle",this.reset())}}],[{key:"create",value:function(){return n.getItemByClass("BoundsStyle",BoundsStyle)}}]),BoundsStyle}(),Ct=function(){function CacheStyle(){_classCallCheck(this,CacheStyle),this.reset()}return _createClass(CacheStyle,[{key:"needBitmapCache",value:function(){return this.cacheForFilters||!!this.mask}},{key:"needEnableCanvasRender",value:function(){return"none"!=this.userSetCache||this.cacheForFilters||!!this.mask}},{key:"releaseContext",value:function(){if(this.canvas&&this.canvas.size){n.recover("CacheCanvas",this.canvas),this.canvas.size(0,0);try{this.canvas.width=0,this.canvas.height=0}catch(e){}}this.canvas=null}},{key:"createContext",value:function(){if(!this.canvas){this.canvas=n.getItem("CacheCanvas")||new gt(!1);var e=this.canvas.context;e||(e=this.canvas.getContext("2d"))}}},{key:"releaseFilterCache",value:function(){var e=this.filterCache;e&&(e.destroy(),e.recycle(),this.filterCache=null)}},{key:"recover",value:function(){this!==CacheStyle.EMPTY&&n.recover("SpriteCache",this.reset())}},{key:"reset",value:function(){return this.releaseContext(),this.releaseFilterCache(),this.cacheAs="none",this.enableCanvasRender=!1,this.userSetCache="none",this.cacheForFilters=!1,this.staticCache=!1,this.reCache=!0,this.mask=null,this.maskParent=null,this.filterCache=null,this.filters=null,this.hasGlowFilter=!1,this.cacheRect&&this.cacheRect.recover(),this.cacheRect=null,this}},{key:"_calculateCacheRect",value:function(e,t,i,n){var r,a=e._cacheStyle;if(a.cacheRect||(a.cacheRect=p.create()),"bitmap"===t?((r=e.getSelfBounds()).width=r.width+2*CacheStyle.CANVAS_EXTEND_EDGE,r.height=r.height+2*CacheStyle.CANVAS_EXTEND_EDGE,r.x=r.x-e.pivotX,r.y=r.y-e.pivotY,r.x=r.x-CacheStyle.CANVAS_EXTEND_EDGE,r.y=r.y-CacheStyle.CANVAS_EXTEND_EDGE,r.x=Math.floor(r.x+i)-i,r.y=Math.floor(r.y+n)-n,r.width=Math.floor(r.width),r.height=Math.floor(r.height),a.cacheRect.copyFrom(r)):a.cacheRect.setTo(-e._style.pivotX,-e._style.pivotY,1,1),r=a.cacheRect,e._style.scrollRect){var s=e._style.scrollRect;r.x-=s.x,r.y-=s.y}return CacheStyle._scaleInfo.setTo(1,1),CacheStyle._scaleInfo}}],[{key:"create",value:function(){return n.getItemByClass("SpriteCache",CacheStyle)}}]),CacheStyle}();Ct.EMPTY=new Ct,Ct._scaleInfo=new v,Ct.CANVAS_EXTEND_EDGE=16;var xt=function(){function SpriteStyle(){_classCallCheck(this,SpriteStyle),this.reset()}return _createClass(SpriteStyle,[{key:"reset",value:function(){return this.scaleX=this.scaleY=1,this.skewX=this.skewY=0,this.pivotX=this.pivotY=this.rotation=0,this.alpha=1,this.scrollRect&&this.scrollRect.recover(),this.scrollRect=null,this.viewport&&this.viewport.recover(),this.viewport=null,this.hitArea=null,this.dragging=null,this.blendMode=null,this}},{key:"recover",value:function(){this!==SpriteStyle.EMPTY&&n.recover("SpriteStyle",this.reset())}}],[{key:"create",value:function(){return n.getItemByClass("SpriteStyle",SpriteStyle)}}]),SpriteStyle}();xt.EMPTY=new xt;var kt=function(e){function Node(){var e;return _classCallCheck(this,Node),(e=_possibleConstructorReturn(this,_getPrototypeOf(Node).call(this)))._bits=0,e._children=Node.ARRAY_EMPTY,e._extUIChild=Node.ARRAY_EMPTY,e._parent=null,e.name="",e.destroyed=!1,e.createGLBuffer(),e}return _inherits(Node,e),_createClass(Node,[{key:"createGLBuffer",value:function(){}},{key:"_setBit",value:function(e,t){e===ft.DISPLAY&&(this._getBit(e)!=t&&this._updateDisplayedInstage());t?this._bits|=e:this._bits&=~e}},{key:"_getBit",value:function(e){return 0!=(this._bits&e)}},{key:"_setUpNoticeChain",value:function(){this._getBit(ft.DISPLAY)&&this._setBitUp(ft.DISPLAY)}},{key:"_setBitUp",value:function(e){var t=this;for(t._setBit(e,!0),t=t._parent;t;){if(t._getBit(e))return;t._setBit(e,!0),t=t._parent}}},{key:"on",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return e!==We.DISPLAY&&e!==We.UNDISPLAY||this._getBit(ft.DISPLAY)||this._setBitUp(ft.DISPLAY),this._createListener(e,t,i,n,!1)}},{key:"once",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return e!==We.DISPLAY&&e!==We.UNDISPLAY||this._getBit(ft.DISPLAY)||this._setBitUp(ft.DISPLAY),this._createListener(e,t,i,n,!0)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed=!0,this._destroyAllComponent(),this._parent&&this._parent.removeChild(this),this._children&&(e?this.destroyChildren():this.removeChildren()),this.onDestroy(),this._children=null,this.offAll()}},{key:"onDestroy",value:function(){}},{key:"destroyChildren",value:function(){if(this._children)for(var e=0,t=this._children.length;e<t;e++)this._children[0].destroy(!0)}},{key:"addChild",value:function(e){if(!e||this.destroyed||e===this)return e;if(e._zOrder&&this._setBit(ft.HAS_ZORDER,!0),e._parent===this){var t=this.getChildIndex(e);t!==this._children.length-1&&(this._children.splice(t,1),this._children.push(e),this._childChanged())}else e._parent&&e._parent.removeChild(e),this._children===Node.ARRAY_EMPTY&&(this._children=[]),this._children.push(e),e._setParent(this),this._childChanged();return e}},{key:"addInputChild",value:function(e){if(this._extUIChild==Node.ARRAY_EMPTY)this._extUIChild=[e];else{if(this._extUIChild.indexOf(e)>=0)return null;this._extUIChild.push(e)}return null}},{key:"removeInputChild",value:function(e){var t=this._extUIChild.indexOf(e);t>=0&&this._extUIChild.splice(t,1)}},{key:"addChildren",value:function(){for(var e=0,t=arguments.length;e<t;){var i;this.addChild((i=e++)<0||arguments.length<=i?void 0:arguments[i])}}},{key:"addChildAt",value:function(e,t){if(!e||this.destroyed||e===this)return e;if(e._zOrder&&this._setBit(ft.HAS_ZORDER,!0),t>=0&&t<=this._children.length){if(e._parent===this){var i=this.getChildIndex(e);this._children.splice(i,1),this._children.splice(t,0,e),this._childChanged()}else e._parent&&e._parent.removeChild(e),this._children===Node.ARRAY_EMPTY&&(this._children=[]),this._children.splice(t,0,e),e._setParent(this);return e}throw new Error("appendChildAt:The index is out of bounds")}},{key:"getChildIndex",value:function(e){return this._children.indexOf(e)}},{key:"getChildByName",value:function(e){var t=this._children;if(t)for(var i=0,n=t.length;i<n;i++){var r=t[i];if(r.name===e)return r}return null}},{key:"getChildAt",value:function(e){return this._children[e]||null}},{key:"setChildIndex",value:function(e,t){var i=this._children;if(t<0||t>=i.length)throw new Error("setChildIndex:The index is out of bounds.");var n=this.getChildIndex(e);if(n<0)throw new Error("setChildIndex:node is must child of this object.");return i.splice(n,1),i.splice(t,0,e),this._childChanged(),e}},{key:"_childChanged",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]}},{key:"removeChild",value:function(e){if(!this._children)return e;var t=this._children.indexOf(e);return this.removeChildAt(t)}},{key:"removeSelf",value:function(){return this._parent&&this._parent.removeChild(this),this}},{key:"removeChildByName",value:function(e){var t=this.getChildByName(e);return t&&this.removeChild(t),t}},{key:"removeChildAt",value:function(e){var t=this.getChildAt(e);return t&&(this._children.splice(e,1),t._setParent(null)),t}},{key:"removeChildren",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2147483647;if(this._children&&this._children.length>0){var i=this._children;if(0===e&&t>=i.length-1){var n=i;this._children=Node.ARRAY_EMPTY}else n=i.splice(e,t-e);for(var r=0,a=n.length;r<a;r++)n[r]._setParent(null)}return this}},{key:"replaceChild",value:function(e,t){var i=this._children.indexOf(t);return i>-1?(this._children.splice(i,1,e),t._setParent(null),e._setParent(this),e):null}},{key:"_setParent",value:function(e){this._parent!==e&&(e?(this._parent=e,this._onAdded(),this.event(We.ADDED),this._getBit(ft.DISPLAY)&&(this._setUpNoticeChain(),e.displayedInStage&&this._displayChild(this,!0)),e._childChanged(this)):(this._onRemoved(),this.event(We.REMOVED),this._parent._childChanged(),this._getBit(ft.DISPLAY)&&this._displayChild(this,!1),this._parent=e))}},{key:"_updateDisplayedInstage",value:function(){var e;e=this;for(var t=i.stage,n=!1;e;){if(e._getBit(ft.DISPLAY)){n=e._getBit(ft.DISPLAYED_INSTAGE);break}if(e===t||e._getBit(ft.DISPLAYED_INSTAGE)){n=!0;break}e=e._parent}this._setBit(ft.DISPLAYED_INSTAGE,n)}},{key:"_setDisplay",value:function(e){this._getBit(ft.DISPLAYED_INSTAGE)!==e&&(this._setBit(ft.DISPLAYED_INSTAGE,e),e?this.event(We.DISPLAY):this.event(We.UNDISPLAY))}},{key:"_displayChild",value:function(e,t){var i=e._children;if(i)for(var n=0,r=i.length;n<r;n++){var a=i[n];a._getBit(ft.DISPLAY)&&(a._children.length>0?this._displayChild(a,t):a._setDisplay(t))}e._setDisplay(t)}},{key:"contains",value:function(e){if(e===this)return!0;for(;e;){if(e._parent===this)return!0;e=e._parent}return!1}},{key:"timerLoop",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],s=arguments.length>5&&void 0!==arguments[5]&&arguments[5],o=this.scene?this.scene.timer:i.timer;o.loop(e,t,n,r,a,s)}},{key:"timerOnce",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],s=this.scene?this.scene.timer:i.timer;s._create(!1,!1,e,t,n,r,a)}},{key:"frameLoop",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],s=this.scene?this.scene.timer:i.timer;s._create(!0,!0,e,t,n,r,a)}},{key:"frameOnce",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],s=this.scene?this.scene.timer:i.timer;s._create(!0,!1,e,t,n,r,a)}},{key:"clearTimer",value:function(e,t){(this.scene?this.scene.timer:i.timer).clear(e,t)}},{key:"callLater",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this.scene?this.scene.timer:i.timer;n.callLater(this,e,t)}},{key:"runCallLater",value:function(e){(this.scene?this.scene.timer:i.timer).runCallLater(this,e)}},{key:"_onActive",value:function(){N.spriteCount++}},{key:"_onInActive",value:function(){N.spriteCount--}},{key:"_onActiveInScene",value:function(){}},{key:"_onInActiveInScene",value:function(){}},{key:"_parse",value:function(e,t){}},{key:"_setBelongScene",value:function(e){if(!this._scene){this._scene=e,this._onActiveInScene();for(var t=0,i=this._children.length;t<i;t++)this._children[t]._setBelongScene(e)}}},{key:"_setUnBelongScene",value:function(){if(this._scene!==this){this._onInActiveInScene(),this._scene=null;for(var e=0,t=this._children.length;e<t;e++)this._children[e]._setUnBelongScene()}}},{key:"onAwake",value:function(){}},{key:"onEnable",value:function(){}},{key:"_processActive",value:function(){this._activeChangeScripts||(this._activeChangeScripts=[]),this._activeHierarchy(this._activeChangeScripts),this._activeScripts()}},{key:"_activeHierarchy",value:function(e){if(this._setBit(ft.ACTIVE_INHIERARCHY,!0),this._components)for(var t=0,i=this._components.length;t<i;t++){var n=this._components[t];n._isScript()?n._enabled&&e.push(n):n._setActive(!0)}for(this._onActive(),t=0,i=this._children.length;t<i;t++){var r=this._children[t];!r._getBit(ft.NOT_ACTIVE)&&!r._getBit(ft.NOT_READY)&&r._activeHierarchy(e)}this._getBit(ft.AWAKED)||(this._setBit(ft.AWAKED,!0),this.onAwake()),this.onEnable()}},{key:"_activeScripts",value:function(){for(var e=0,t=this._activeChangeScripts.length;e<t;e++){var i=this._activeChangeScripts[e];i._awaked||(i._awaked=!0,i._onAwake()),i._onEnable()}this._activeChangeScripts.length=0}},{key:"_processInActive",value:function(){this._activeChangeScripts||(this._activeChangeScripts=[]),this._inActiveHierarchy(this._activeChangeScripts),this._inActiveScripts()}},{key:"_inActiveHierarchy",value:function(e){if(this._onInActive(),this._components)for(var t=0,i=this._components.length;t<i;t++){var n=this._components[t];n._setActive(!1),n._isScript()&&n._enabled&&e.push(n)}for(this._setBit(ft.ACTIVE_INHIERARCHY,!1),t=0,i=this._children.length;t<i;t++){var r=this._children[t];r&&!r._getBit(ft.NOT_ACTIVE)&&r._inActiveHierarchy(e)}this.onDisable()}},{key:"_inActiveScripts",value:function(){for(var e=0,t=this._activeChangeScripts.length;e<t;e++)this._activeChangeScripts[e].onDisable();this._activeChangeScripts.length=0}},{key:"onDisable",value:function(){}},{key:"_onAdded",value:function(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw"Node: can't set the main inActive node active in hierarchy,if the operate is in main inActive node or it's children script's onDisable Event.";var e=this._parent.scene;e&&this._setBelongScene(e),this._parent.activeInHierarchy&&this.active&&this._processActive()}},{key:"_onRemoved",value:function(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw"Node: can't set the main active node inActive in hierarchy,if the operate is in main active node or it's children script's onEnable Event.";this._parent.activeInHierarchy&&this.active&&this._processInActive(),this._parent.scene&&this._setUnBelongScene()}},{key:"_addComponentInstance",value:function(e){this._components=this._components||[],this._components.push(e),e.owner=this,e._onAdded(),this.activeInHierarchy&&e._setActive(!0)}},{key:"_destroyComponent",value:function(e){if(this._components)for(var t=0,i=this._components.length;t<i;t++){var n=this._components[t];if(n===e){n._destroy(),this._components.splice(t,1);break}}}},{key:"_destroyAllComponent",value:function(){if(this._components){for(var e=0,t=this._components.length;e<t;e++){var i=this._components[e];i&&i._destroy()}this._components.length=0}}},{key:"_cloneTo",value:function(e,t,i){var n=e;if(this._components)for(var r=0,a=this._components.length;r<a;r++){var s=n.addComponent(this._components[r].constructor);this._components[r]._cloneTo(s)}}},{key:"addComponentIntance",value:function(e){if(e.owner)throw"Node:the component has belong to other node.";if(e.isSingleton&&this.getComponent(e.constructor))throw"Node:the component is singleton,can't add the second one.";return this._addComponentInstance(e),e}},{key:"addComponent",value:function(e){var t=n.createByClass(e);if(t._destroyed=!1,t.isSingleton&&this.getComponent(e))throw"无法实例"+e+"组件，"+e+"组件已存在！";return this._addComponentInstance(t),t}},{key:"getComponent",value:function(e){if(this._components)for(var t=0,i=this._components.length;t<i;t++){var n=this._components[t];if(n instanceof e)return n}return null}},{key:"getComponents",value:function(e){var t;if(this._components)for(var i=0,n=this._components.length;i<n;i++){var r=this._components[i];r instanceof e&&(t=t||[]).push(r)}return t}},{key:"numChildren",get:function(){return this._children.length}},{key:"parent",get:function(){return this._parent}},{key:"displayedInStage",get:function(){return this._getBit(ft.DISPLAY)?this._getBit(ft.DISPLAYED_INSTAGE):(this._setBitUp(ft.DISPLAY),this._getBit(ft.DISPLAYED_INSTAGE))}},{key:"scene",get:function(){return this._scene}},{key:"active",get:function(){return!this._getBit(ft.NOT_READY)&&!this._getBit(ft.NOT_ACTIVE)},set:function(e){if(e=!!e,!this._getBit(ft.NOT_ACTIVE)!==e){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw e?"Node: can't set the main inActive node active in hierarchy,if the operate is in main inActive node or it's children script's onDisable Event.":"Node: can't set the main active node inActive in hierarchy,if the operate is in main active node or it's children script's onEnable Event.";this._setBit(ft.NOT_ACTIVE,!e),this._parent&&this._parent.activeInHierarchy&&(e?this._processActive():this._processInActive())}}},{key:"activeInHierarchy",get:function(){return this._getBit(ft.ACTIVE_INHIERARCHY)}},{key:"timer",get:function(){return this.scene?this.scene.timer:i.timer}}]),Node}(T);kt.ARRAY_EMPTY=[],mt.regClass("laya.display.Node",kt),mt.regClass("Laya.Node",kt);var St=function(e){function Sprite(){var e;return _classCallCheck(this,Sprite),(e=_possibleConstructorReturn(this,_getPrototypeOf(Sprite).call(this)))._x=0,e._y=0,e._width=0,e._height=0,e._visible=!0,e._mouseState=0,e._zOrder=0,e._renderType=0,e._transform=null,e._tfChanged=!1,e._repaint=ot.REPAINT_NONE,e._texture=null,e._style=xt.EMPTY,e._cacheStyle=Ct.EMPTY,e._boundStyle=null,e._graphics=null,e.mouseThrough=!1,e.autoSize=!1,e.hitTestPrior=!1,e}return _inherits(Sprite,e),_createClass(Sprite,[{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];_get(_getPrototypeOf(Sprite.prototype),"destroy",this).call(this,e),this._style&&this._style.recover(),this._cacheStyle&&this._cacheStyle.recover(),this._boundStyle&&this._boundStyle.recover(),this._style=null,this._cacheStyle=null,this._boundStyle=null,this._transform=null,this._graphics&&this._graphics.autoDestroy&&this._graphics.destroy(),this._graphics=null,this.texture=null}},{key:"updateZOrder",value:function(){j.updateOrder(this._children)&&this.repaint()}},{key:"_getBoundsStyle",value:function(){return this._boundStyle||(this._boundStyle=Tt.create()),this._boundStyle}},{key:"_setCustomRender",value:function(){}},{key:"_setCacheAs",value:function(e){}},{key:"_checkCanvasEnable",value:function(){var e=this._cacheStyle.needEnableCanvasRender();this._getCacheStyle().enableCanvasRender=e,e?(this._cacheStyle.needBitmapCache()?this._cacheStyle.cacheAs="bitmap":this._cacheStyle.cacheAs=this._cacheStyle.userSetCache,this._cacheStyle.reCache=!0,this._renderType|=ot.CANVAS):(this._cacheStyle.cacheAs="none",this._cacheStyle.releaseContext(),this._renderType&=~ot.CANVAS),this._setCacheAs(this._cacheStyle.cacheAs),this._setRenderType(this._renderType)}},{key:"reCache",value:function(){this._cacheStyle.reCache=!0,this._repaint|=ot.REPAINT_CACHE}},{key:"getRepaint",value:function(){return this._repaint}},{key:"_setX",value:function(e){this._x=e}},{key:"_setY",value:function(e){this._y=e}},{key:"_setWidth",value:function(e,t){}},{key:"_setHeight",value:function(e,t){}},{key:"set_width",value:function(e){this._width!==e&&(this._width=e,this._setWidth(this.texture,e),this._setTranformChange())}},{key:"get_width",value:function(){return this.autoSize?this.texture?this.texture.width:this._graphics||0!==this._children.length?this.getSelfBounds().width:0:this._width||(this.texture?this.texture.width:0)}},{key:"set_height",value:function(e){this._height!==e&&(this._height=e,this._setHeight(this.texture,e),this._setTranformChange())}},{key:"get_height",value:function(){return this.autoSize?this.texture?this.texture.height:this._graphics||0!==this._children.length?this.getSelfBounds().height:0:this._height||(this.texture?this.texture.height:0)}},{key:"setSelfBounds",value:function(e){this._getBoundsStyle().userBounds=e}},{key:"getBounds",value:function(){return this._getBoundsStyle().bounds=p._getWrapRec(this._boundPointsToParent())}},{key:"getSelfBounds",value:function(){return this._boundStyle&&this._boundStyle.userBounds?this._boundStyle.userBounds:this._graphics||0!==this._children.length||this._texture?this._getBoundsStyle().bounds=p._getWrapRec(this._getBoundPointsM(!1)):p.TEMP.setTo(0,0,this.width,this.height)}},{key:"_boundPointsToParent",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=0,i=0;this._style&&(t=this.pivotX,i=this.pivotY,e=e||0!==this._style.rotation,this._style.scrollRect&&(t+=this._style.scrollRect.x,i+=this._style.scrollRect.y));var n=this._getBoundPointsM(e);if(!n||n.length<1)return n;if(8!=n.length&&(n=e?ae.scanPList(n):p._getWrapRec(n,p.TEMP)._getBoundPoints()),!this.transform)return j.transPointList(n,this._x-t,this._y-i),n;var r,a=v.TEMP,s=n.length;for(r=0;r<s;r+=2)a.x=n[r],a.y=n[r+1],this.toParentPoint(a),n[r]=a.x,n[r+1]=a.y;return n}},{key:"getGraphicBounds",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this._graphics?this._graphics.getBounds(e):p.TEMP.setTo(0,0,0,0)}},{key:"_getBoundPointsM",value:function(){var e,t,i,n,r=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._boundStyle&&this._boundStyle.userBounds)return this._boundStyle.userBounds._getBoundPoints();if(this._boundStyle||this._getBoundsStyle(),this._boundStyle.temBM||(this._boundStyle.temBM=[]),this._style.scrollRect){var a=j.clearArray(this._boundStyle.temBM),s=p.TEMP;return s.copyFrom(this._style.scrollRect),j.concatArray(a,s._getBoundPoints()),a}this._graphics?e=this._graphics.getBoundPoints():(e=j.clearArray(this._boundStyle.temBM),this._texture&&((s=p.TEMP).setTo(0,0,this.width||this._texture.width,this.height||this._texture.height),j.concatArray(e,s._getBoundPoints())));for(var o=0,l=(n=this._children).length;o<l;o++)(t=n[o])instanceof Sprite&&!0===t._visible&&(i=t._boundPointsToParent(r))&&(e=e?j.concatArray(e,i):i);return e}},{key:"_getCacheStyle",value:function(){return this._cacheStyle===Ct.EMPTY&&(this._cacheStyle=Ct.create()),this._cacheStyle}},{key:"getStyle",value:function(){return this._style===xt.EMPTY&&(this._style=xt.create()),this._style}},{key:"setStyle",value:function(e){this._style=e}},{key:"_setScaleX",value:function(e){this._style.scaleX=e}},{key:"_setScaleY",value:function(e){this._style.scaleY=e}},{key:"set_scaleX",value:function(e){this.getStyle().scaleX!==e&&(this._setScaleX(e),this._setTranformChange())}},{key:"get_scaleX",value:function(){return this._style.scaleX}},{key:"set_scaleY",value:function(e){this.getStyle().scaleY!==e&&(this._setScaleY(e),this._setTranformChange())}},{key:"get_scaleY",value:function(){return this._style.scaleY}},{key:"_setRotation",value:function(e){this._style.rotation=e}},{key:"_setSkewX",value:function(e){this._style.skewX=e}},{key:"_setSkewY",value:function(e){this._style.skewY=e}},{key:"_createTransform",value:function(){return f.create()}},{key:"_adjustTransform",value:function(){this._tfChanged=!1;var e=this._style,t=e.scaleX,i=e.scaleY,n=e.skewX,r=e.skewY,a=e.rotation,s=this._transform||(this._transform=this._createTransform());if(a||1!==t||1!==i||0!==n||0!==r){s._bTransform=!0;var o=.0174532922222222*(a-n),l=.0174532922222222*(a+r),h=Math.cos(l),u=Math.sin(l),c=Math.sin(o),_=Math.cos(o);s.a=t*h,s.b=t*u,s.c=-i*c,s.d=i*_,s.tx=s.ty=0}else s.identity(),this._renderType&=~ot.TRANSFORM,this._setRenderType(this._renderType);return s}},{key:"_setTransform",value:function(e){}},{key:"get_transform",value:function(){return this._tfChanged?this._adjustTransform():this._transform}},{key:"set_transform",value:function(e){this._tfChanged=!1;var t=this._transform||(this._transform=this._createTransform());e.copyTo(t),this._setTransform(t),e&&(this._x=t.tx,this._y=t.ty,t.tx=t.ty=0),e?this._renderType|=ot.TRANSFORM:this._renderType&=~ot.TRANSFORM,this._setRenderType(this._renderType),this.parentRepaint()}},{key:"_setPivotX",value:function(e){this.getStyle().pivotX=e}},{key:"_getPivotX",value:function(){return this._style.pivotX}},{key:"_setPivotY",value:function(e){this.getStyle().pivotY=e}},{key:"_getPivotY",value:function(){return this._style.pivotY}},{key:"_setAlpha",value:function(e){this._style.alpha!==e&&(this.getStyle().alpha=e,1!==e?this._renderType|=ot.ALPHA:this._renderType&=~ot.ALPHA,this._setRenderType(this._renderType),this.parentRepaint())}},{key:"_getAlpha",value:function(){return this._style.alpha}},{key:"get_visible",value:function(){return this._visible}},{key:"set_visible",value:function(e){this._visible!==e&&(this._visible=e,this.parentRepaint(ot.REPAINT_ALL))}},{key:"_setBlendMode",value:function(e){}},{key:"_setGraphics",value:function(e){}},{key:"_setGraphicsCallBack",value:function(){}},{key:"_setScrollRect",value:function(e){}},{key:"pos",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this._x!==e||this._y!==t){if(this.destroyed)return this;if(i){this._setX(e),this._setY(t),this.parentRepaint(ot.REPAINT_CACHE);var n=this._cacheStyle.maskParent;n&&n.repaint(ot.REPAINT_CACHE)}else this.x=e,this.y=t}return this}},{key:"pivot",value:function(e,t){return this.pivotX=e,this.pivotY=t,this}},{key:"size",value:function(e,t){return this.width=e,this.height=t,this}},{key:"scale",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.getStyle();if(n.scaleX!=e||n.scaleY!=t){if(this.destroyed)return this;i?(this._setScaleX(e),this._setScaleY(t),this._setTranformChange()):(this.scaleX=e,this.scaleY=t)}return this}},{key:"skew",value:function(e,t){return this.skewX=e,this.skewY=t,this}},{key:"render",value:function(e,t,i){pt.renders[this._renderType]._fun(this,e,t+this._x,i+this._y),this._repaint=0}},{key:"drawToCanvas",value:function(e,t,i,n){return Sprite.drawToCanvas(this,this._renderType,e,t,i,n)}},{key:"drawToTexture",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return Sprite.drawToTexture(this,this._renderType,e,t,i,n,r)}},{key:"drawToTexture3D",value:function(e,t,i){throw"not implement"}},{key:"customRender",value:function(e,t,i){this._repaint=ot.REPAINT_ALL}},{key:"_applyFilters",value:function(){}},{key:"_setColorFilter",value:function(e){}},{key:"_isHaveGlowFilter",value:function(){var e,t;if(this.filters)for(e=0;e<this.filters.length;e++)if(this.filters[e].type==K.GLOW)return!0;for(e=0,t=this._children.length;e<t;e++)if(this._children[e]._isHaveGlowFilter())return!0;return!1}},{key:"localToGlobal",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;!0===t&&(e=new v(e.x,e.y));var r=this;for(n=n||i.stage;r&&!r.destroyed&&r!=n;)e=r.toParentPoint(e),r=r.parent;return e}},{key:"globalToLocal",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;t&&(e=new v(e.x,e.y));var r=this,a=[];for(n=n||i.stage;r&&!r.destroyed&&r!=n;)a.push(r),r=r.parent;for(var s=a.length-1;s>=0;)e=(r=a[s]).fromParentPoint(e),s--;return e}},{key:"toParentPoint",value:function(e){if(!e)return e;e.x-=this.pivotX,e.y-=this.pivotY,this.transform&&this._transform.transformPoint(e),e.x+=this._x,e.y+=this._y;var t=this._style.scrollRect;return t&&(e.x-=t.x,e.y-=t.y),e}},{key:"fromParentPoint",value:function(e){if(!e)return e;e.x-=this._x,e.y-=this._y;var t=this._style.scrollRect;return t&&(e.x+=t.x,e.y+=t.y),this.transform&&this._transform.invertTransformPoint(e),e.x+=this.pivotX,e.y+=this.pivotY,e}},{key:"fromStagePoint",value:function(e){return e}},{key:"on",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return 1!==this._mouseState&&this.isMouseEvent(e)?(this.mouseEnabled=!0,this._setBit(ft.HAS_MOUSE,!0),this._parent&&this._onDisplay(),this._createListener(e,t,i,n,!1)):_get(_getPrototypeOf(Sprite.prototype),"on",this).call(this,e,t,i,n)}},{key:"once",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return 1!==this._mouseState&&this.isMouseEvent(e)?(this.mouseEnabled=!0,this._setBit(ft.HAS_MOUSE,!0),this._parent&&this._onDisplay(),this._createListener(e,t,i,n,!0)):_get(_getPrototypeOf(Sprite.prototype),"once",this).call(this,e,t,i,n)}},{key:"_onDisplay",value:function(e){if(1!==this._mouseState){var t=this;for(t=t.parent;t&&1!==t._mouseState&&!t._getBit(ft.HAS_MOUSE);)t.mouseEnabled=!0,t._setBit(ft.HAS_MOUSE,!0),t=t.parent}}},{key:"_setParent",value:function(e){_get(_getPrototypeOf(Sprite.prototype),"_setParent",this).call(this,e),e&&this._getBit(ft.HAS_MOUSE)&&this._onDisplay()}},{key:"loadImage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(e){var n=i.Loader.textureMap[x.formatURL(e)];n||((n=new Ve).load(e),i.Loader.cacheTexture(e,n)),this.texture=n,n.getIsReady()?loaded.call(this):n.once(We.READY,this,loaded)}else this.texture=null,loaded.call(this);function loaded(){this.repaint(ot.REPAINT_ALL),t&&t.run()}return this}},{key:"repaint",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ot.REPAINT_CACHE;this._repaint&e||(this._repaint|=e,this.parentRepaint(e)),this._cacheStyle&&this._cacheStyle.maskParent&&this._cacheStyle.maskParent.repaint(e)}},{key:"_needRepaint",value:function(){return this._repaint&ot.REPAINT_CACHE&&this._cacheStyle.enableCanvasRender&&this._cacheStyle.reCache}},{key:"_childChanged",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this._children.length?this._renderType|=ot.CHILDS:this._renderType&=~ot.CHILDS,this._setRenderType(this._renderType),e&&this._getBit(ft.HAS_ZORDER)&&i.systemTimer.callLater(this,this.updateZOrder),this.repaint(ot.REPAINT_ALL)}},{key:"parentRepaint",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ot.REPAINT_CACHE,t=this._parent;!t||t._repaint&e||(t._repaint|=e,t.parentRepaint(e))}},{key:"_setMask",value:function(e){}},{key:"startDrag",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:300,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=arguments.length>5&&void 0!==arguments[5]&&arguments[5],o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:.92;this._style.dragging||(this.getStyle().dragging=new i.Dragging),this._style.dragging.start(this,e,t,n,r,a,s,o)}},{key:"stopDrag",value:function(){this._style.dragging&&this._style.dragging.stop()}},{key:"_setDisplay",value:function(e){e||this._cacheStyle&&(this._cacheStyle.releaseContext(),this._cacheStyle.releaseFilterCache(),this._cacheStyle.hasGlowFilter&&(this._cacheStyle.hasGlowFilter=!1)),_get(_getPrototypeOf(Sprite.prototype),"_setDisplay",this).call(this,e)}},{key:"hitTestPoint",value:function(e,t){var i=this.globalToLocal(v.TEMP.setTo(e,t));return e=i.x,t=i.y,(this._style.hitArea?this._style.hitArea:this._width>0&&this._height>0?p.TEMP.setTo(0,0,this._width,this._height):this.getSelfBounds()).contains(e,t)}},{key:"getMousePoint",value:function(){return this.globalToLocal(v.TEMP.setTo(i.stage.mouseX,i.stage.mouseY))}},{key:"_setTexture",value:function(e){}},{key:"_setRenderType",value:function(e){}},{key:"_setTranformChange",value:function(){this._tfChanged=!0,this._renderType|=ot.TRANSFORM,this.parentRepaint(ot.REPAINT_CACHE)}},{key:"_setBgStyleColor",value:function(e,t,i,n,r){}},{key:"_setBorderStyleColor",value:function(e,t,i,n,r,a){}},{key:"captureMouseEvent",value:function(e){i.MouseManager.instance.setCapture(this,e)}},{key:"releaseMouseEvent",value:function(){i.MouseManager.instance.releaseCapture()}},{key:"customRenderEnable",set:function(e){e&&(this._renderType|=ot.CUSTOM,this._setRenderType(this._renderType),this._setCustomRender())}},{key:"cacheAs",get:function(){return this._cacheStyle.cacheAs},set:function(e){e!==this._cacheStyle.userSetCache&&(this.mask&&"normal"===e||(this._setCacheAs(e),this._getCacheStyle().userSetCache=e,this._checkCanvasEnable(),this.repaint()))}},{key:"staticCache",get:function(){return this._cacheStyle.staticCache},set:function(e){this._getCacheStyle().staticCache=e,e||this.reCache()}},{key:"x",get:function(){return this._x},set:function(e){if(!this.destroyed&&this._x!==e){this._setX(e),this.parentRepaint(ot.REPAINT_CACHE);var t=this._cacheStyle.maskParent;t&&t.repaint(ot.REPAINT_CACHE)}}},{key:"y",get:function(){return this._y},set:function(e){if(!this.destroyed&&this._y!==e){this._setY(e),this.parentRepaint(ot.REPAINT_CACHE);var t=this._cacheStyle.maskParent;t&&t.repaint(ot.REPAINT_CACHE)}}},{key:"width",get:function(){return this.get_width()},set:function(e){this.set_width(e)}},{key:"height",get:function(){return this.get_height()},set:function(e){this.set_height(e)}},{key:"displayWidth",get:function(){return this.width*this.scaleX}},{key:"displayHeight",get:function(){return this.height*this.scaleY}},{key:"scaleX",get:function(){return this._style.scaleX},set:function(e){this.set_scaleX(e)}},{key:"scaleY",get:function(){return this._style.scaleY},set:function(e){this.set_scaleY(e)}},{key:"rotation",get:function(){return this._style.rotation},set:function(e){this.getStyle().rotation!==e&&(this._setRotation(e),this._setTranformChange())}},{key:"skewX",get:function(){return this._style.skewX},set:function(e){this.getStyle().skewX!==e&&(this._setSkewX(e),this._setTranformChange())}},{key:"skewY",get:function(){return this._style.skewY},set:function(e){this.getStyle().skewY!==e&&(this._setSkewY(e),this._setTranformChange())}},{key:"transform",get:function(){return this._tfChanged?this._adjustTransform():this._transform},set:function(e){this.set_transform(e)}},{key:"pivotX",get:function(){return this._getPivotX()},set:function(e){this._setPivotX(e),this.repaint()}},{key:"pivotY",get:function(){return this._getPivotY()},set:function(e){this._setPivotY(e),this.repaint()}},{key:"alpha",get:function(){return this._getAlpha()},set:function(e){e=e<0?0:e>1?1:e,this._setAlpha(e)}},{key:"visible",get:function(){return this.get_visible()},set:function(e){this.set_visible(e)}},{key:"blendMode",get:function(){return this._style.blendMode},set:function(e){this._setBlendMode(e),this.getStyle().blendMode=e,e&&"source-over"!=e?this._renderType|=ot.BLEND:this._renderType&=~ot.BLEND,this._setRenderType(this._renderType),this.parentRepaint()}},{key:"graphics",get:function(){return this._graphics||(this.graphics=new dt,this._graphics.autoDestroy=!0),this._graphics},set:function(e){this._graphics&&(this._graphics._sp=null),this._graphics=e,e?(this._setGraphics(e),this._renderType|=ot.GRAPHICS,e._sp=this):this._renderType&=~ot.GRAPHICS,this._setRenderType(this._renderType),this.repaint()}},{key:"scrollRect",get:function(){return this._style.scrollRect},set:function(e){this.getStyle().scrollRect=e,this._setScrollRect(e),this.repaint(),e?this._renderType|=ot.CLIP:this._renderType&=~ot.CLIP,this._setRenderType(this._renderType)}},{key:"filters",get:function(){return this._cacheStyle.filters},set:function(e){e&&0===e.length&&(e=null),this._cacheStyle.filters!=e&&(this._getCacheStyle().filters=e?e.slice():null,e&&e.length?(this._setColorFilter(e[0]),this._renderType|=ot.FILTERS):(this._setColorFilter(null),this._renderType&=~ot.FILTERS),this._setRenderType(this._renderType),e&&e.length>0?(this._getBit(ft.DISPLAY)||this._setBitUp(ft.DISPLAY),1==e.length&&e[0]instanceof q||(this._getCacheStyle().cacheForFilters=!0,this._checkCanvasEnable())):this._cacheStyle.cacheForFilters&&(this._cacheStyle.cacheForFilters=!1,this._checkCanvasEnable()),this._getCacheStyle().hasGlowFilter=this._isHaveGlowFilter(),this.repaint())}},{key:"stage",get:function(){return i.stage}},{key:"hitArea",get:function(){return this._style.hitArea},set:function(e){this.getStyle().hitArea=e}},{key:"mask",get:function(){return this._cacheStyle.mask},set:function(e){e&&this.mask&&this.mask._cacheStyle.maskParent||(this._getCacheStyle().mask=e,this._setMask(e),this._checkCanvasEnable(),e?e._getCacheStyle().maskParent=this:this.mask&&(this.mask._getCacheStyle().maskParent=null),this._renderType|=ot.MASK,this._setRenderType(this._renderType),this.parentRepaint(ot.REPAINT_ALL))}},{key:"mouseEnabled",get:function(){return this._mouseState>1},set:function(e){this._mouseState=e?2:1}},{key:"globalScaleX",get:function(){for(var e=1,t=this;t&&t!==i.stage;)e*=t.scaleX,t=t.parent;return e}},{key:"globalRotation",get:function(){for(var e=0,t=this;t&&t!==i.stage;)e+=t.rotation,t=t.parent;return e}},{key:"globalScaleY",get:function(){for(var e=1,t=this;t&&t!==i.stage;)e*=t.scaleY,t=t.parent;return e}},{key:"mouseX",get:function(){return this.getMousePoint().x}},{key:"mouseY",get:function(){return this.getMousePoint().y}},{key:"zOrder",get:function(){return this._zOrder},set:function(e){this._zOrder!=e&&(this._zOrder=e,this._parent&&(e&&this._parent._setBit(ft.HAS_ZORDER,!0),i.systemTimer.callLater(this._parent,this.updateZOrder)))}},{key:"texture",get:function(){return this._texture},set:function(e){"string"==typeof e?this.loadImage(e):this._texture!=e&&(this._texture&&this._texture._removeReference(),this._texture=e,e&&e._addReference(),this._setTexture(e),this._setWidth(this._texture,this.width),this._setHeight(this._texture,this.height),e?this._renderType|=ot.TEXTURE:this._renderType&=~ot.TEXTURE,this._setRenderType(this._renderType),this.repaint())}},{key:"viewport",get:function(){return this._style.viewport},set:function(e){var t;"string"==typeof e&&((t=e.split(",")).length>3&&(e=new p(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]))));this.getStyle().viewport=e}},{key:"drawCallOptimize",set:function(e){this._setBit(ft.DRAWCALL_OPTIMIZE,e)},get:function(){return this._getBit(ft.DRAWCALL_OPTIMIZE)}}],[{key:"drawToCanvas",value:function(e,t,i,n,r,a){r-=e.x,a-=e.y,r|=0,a|=0,i|=0,n|=0;var s=new Ze;s.size(i,n),s.asBitmap=!0,s._targets.start(),s._targets.clear(0,0,0,0),pt.renders[t]._fun(e,s,r,a),s.flush(),s._targets.end(),s._targets.restore();var o=s._targets.getData(0,0,i,n);s.destroy();for(var l=new ImageData(i,n),h=4*i,u=l.data,c=n-1,_=c*h,d=0;c>=0;c--)u.set(o.subarray(d,d+h),_),_-=h,d+=h;var f=new gt(!0);return f.size(i,n),f.getContext("2d").putImageData(l,0,0),f}},{key:"drawToTexture",value:function(e,t,i,n,r,a){var s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;Sprite.drawtocanvCtx||(Sprite.drawtocanvCtx=new Ze),r-=e.x,a-=e.y,r|=0,a|=0,i|=0,n|=0;var o=s?Sprite.drawtocanvCtx:new Ze;if(o.clear(),o.size(i,n),s?o._targets=s:o.asBitmap=!0,o._targets&&(o._targets.start(),o._targets.clear(0,0,0,0),pt.renders[t]._fun(e,o,r,a),o.flush(),o._targets.end(),o._targets.restore()),!s){var l=new Ve(o._targets,Ve.INV_UV);return o.destroy(!0),l}return e._repaint=0,s}},{key:"fromImage",value:function(e){return(new Sprite).loadImage(e)}}]),Sprite}(kt);mt.regClass("laya.display.Sprite",St),mt.regClass("Laya.Sprite",St);var Rt=function(e){function TextStyle(){var e;return _classCallCheck(this,TextStyle),(e=_possibleConstructorReturn(this,_getPrototypeOf(TextStyle).apply(this,arguments))).italic=!1,e}return _inherits(TextStyle,e),_createClass(TextStyle,[{key:"reset",value:function(){return _get(_getPrototypeOf(TextStyle.prototype),"reset",this).call(this),this.italic=!1,this.align="left",this.wordWrap=!1,this.leading=0,this.padding=[0,0,0,0],this.bgColor=null,this.borderColor=null,this.asPassword=!1,this.stroke=0,this.strokeColor="#000000",this.bold=!1,this.underline=!1,this.underlineColor=null,this.currBitmapFont=null,this}},{key:"recover",value:function(){this!==TextStyle.EMPTY&&n.recover("TextStyle",this.reset())}},{key:"render",value:function(e,t,i,n){(this.bgColor||this.borderColor)&&t.drawRect(i,n,e.width,e.height,this.bgColor,this.borderColor,1)}}],[{key:"create",value:function(){return n.getItemByClass("TextStyle",TextStyle)}}]),TextStyle}(xt);Rt.EMPTY=new Rt;var bt=function(e){function Text(){var e;return _classCallCheck(this,Text),(e=_possibleConstructorReturn(this,_getPrototypeOf(Text).call(this)))._textWidth=0,e._textHeight=0,e._lines=[],e._lineWidths=[],e._startX=0,e._startY=0,e._charSize={},e._valign="top",e._fontSize=Text.defaultFontSize,e._font=Text.defaultFont,e._color="#000000",e._singleCharRender=!1,e.overflow=Text.VISIBLE,e._style=Rt.EMPTY,e}return _inherits(Text,e),_createClass(Text,[{key:"getStyle",value:function(){return this._style===Rt.EMPTY&&(this._style=Rt.create()),this._style}},{key:"_getTextStyle",value:function(){return this._style===Rt.EMPTY&&(this._style=Rt.create()),this._style}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];_get(_getPrototypeOf(Text.prototype),"destroy",this).call(this,e),this._clipPoint=null,this._lines=null,this._lineWidths=null,this._words&&this._words.forEach((function(e){e.cleanCache()})),this._words=null,this._charSize=null}},{key:"_getBoundPointsM",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];var e=p.TEMP;return e.setTo(0,0,this.width,this.height),e._getBoundPoints()}},{key:"getGraphicBounds",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];var e=p.TEMP;return e.setTo(0,0,this.width,this.height),e}},{key:"_getCSSStyle",value:function(){return this._style}},{key:"get_text",value:function(){return this._text||""}},{key:"set_text",value:function(e){this._text!==e&&(this.lang(e+""),this.isChanged=!0,this.event(We.CHANGE),this.borderColor&&this._setBorderStyleColor(0,0,this.width,this.height,this.borderColor,1))}},{key:"lang",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5&&void 0!==arguments[5]&&arguments[5],arguments.length>6&&void 0!==arguments[6]&&arguments[6],arguments.length>7&&void 0!==arguments[7]&&arguments[7],arguments.length>8&&void 0!==arguments[8]&&arguments[8],arguments.length>9&&void 0!==arguments[9]&&arguments[9],arguments.length>10&&void 0!==arguments[10]&&arguments[10];if(e=Text.langPacks&&Text.langPacks[e]?Text.langPacks[e]:e,arguments.length<2)this._text=e;else{for(var t=0,i=arguments.length;t<i;t++)e=e.replace("{"+t+"}",arguments[t+1]);this._text=e}}},{key:"get_color",value:function(){return this._color}},{key:"set_color",value:function(e){this._color!=e&&(this._color=e,!this._isChanged&&this._graphics?this._graphics.replaceTextColor(this.color):this.isChanged=!0)}},{key:"set_bgColor",value:function(e){this._getTextStyle().bgColor=e,this._renderType|=ot.STYLE,this._setBgStyleColor(0,0,this.width,this.height,e),this._setRenderType(this._renderType),this.isChanged=!0}},{key:"get_bgColor",value:function(){return this._style.bgColor}},{key:"_getContextFont",value:function(){return(this.italic?"italic ":"")+(this.bold?"bold ":"")+this.fontSize+"px "+(i.Browser.onIPhone&&Text.fontFamilyMap[this.font]||this.font)}},{key:"_isPassWordMode",value:function(){var e=this._style.asPassword;return"prompt"in this&&this.prompt==this._text&&(e=!1),e}},{key:"_getPassWordTxt",value:function(e){var t;t="";for(var i=e.length;i>0;i--)t+="●";return t}},{key:"_renderText",value:function(){var e=this.padding,t=this._lines.length;this.overflow!=Text.VISIBLE&&(t=Math.min(t,Math.floor((this.height-e[0]-e[2])/(this.leading+this._charSize.height))+1));var n=this.scrollY/(this._charSize.height+this.leading)|0,r=this.graphics;r.clear(!0);var a=this._getContextFont();i.Browser.context.font=a;var s=e[3],o="left",l=this._lines,h=this.leading+this._charSize.height,u=this._style.currBitmapFont;u&&(h=this.leading+u.getMaxHeight());var c=e[0];if(!u&&this._width>0&&this._textWidth<=this._width&&("right"==this.align?(o="right",s=this._width-e[1]):"center"==this.align&&(o="center",s=.5*this._width+e[3]-e[1])),this._height>0){var _=this._textHeight>this._height?"top":this.valign;"middle"===_?c=.5*(this._height-t*h)+e[0]-e[2]:"bottom"===_&&(c=this._height-t*h-e[2])}var d=this._style;if(u&&u.autoScaleSize)var f=u.fontSize/this.fontSize;if(this._clipPoint){var v,p;if(r.save(),u&&u.autoScaleSize)v=this._width?this._width-e[3]-e[1]:this._textWidth,p=this._height?this._height-e[0]-e[2]:this._textHeight,v*=f,p*=f,r.clipRect(e[3],e[0],v,p);else r.clipRect(e[3],e[0],this._width?this._width-e[3]-e[1]:this._textWidth,this._height?this._height-e[0]-e[2]:this._textHeight);this.repaint()}var g=d.asPassword;"prompt"in this&&this.prompt==this._text&&(g=!1);for(var y=0,m=0,T=Math.min(this._lines.length,t+n)||1,C=n;C<T;C++){var x,k=l[C];if(g){var S=k.length;k="";for(var R=S;R>0;R--)k+="●"}if(null==k&&(k=""),y=s-(this._clipPoint?this._clipPoint.x:0),m=c+h*C-(this._clipPoint?this._clipPoint.y:0),this.underline&&this._drawUnderline(o,y,m,C),u){var b=this.width;u.autoScaleSize&&(b=this.width*f),u._drawText(k,this,y,m,this.align,b)}else this._words||(this._words=[]),this._words.length>C-n?x=this._words[C-n]:(x=new Ye,this._words.push(x)),x.setText(k),x.splitRender=this._singleCharRender,d.stroke?r.fillBorderText(x,y,m,a,this.color,o,d.stroke,d.strokeColor):r.fillText(x,y,m,a,this.color,o)}if(u&&u.autoScaleSize){var E=1/f;this.scale(E,E)}this._clipPoint&&r.restore(),this._startX=s,this._startY=c}},{key:"_drawUnderline",value:function(e,t,i,n){var r=this._lineWidths[n];switch(e){case"center":t-=r/2;break;case"right":t-=r}i+=this._charSize.height,this._graphics.drawLine(t,i,t+r,i,this.underlineColor||this.color,1)}},{key:"typeset",value:function(){if(this._isChanged=!1,!this._text)return this._clipPoint=null,this._textWidth=this._textHeight=0,void this.graphics.clear(!0);i.Render.isConchApp?window.conchTextCanvas.font=this._getContextFont():i.Browser.context.font=this._getContextFont(),this._lines.length=0,this._lineWidths.length=0,this._isPassWordMode()?this._parseLines(this._getPassWordTxt(this._text)):this._parseLines(this._text),this._evalTextSize(),this._checkEnabledViewportOrNot()?this._clipPoint||(this._clipPoint=new v(0,0)):this._clipPoint=null,this._renderText()}},{key:"_evalTextSize",value:function(){var e,t;e=Math.max.apply(this,this._lineWidths),t=this._style.currBitmapFont?this._lines.length*(this._style.currBitmapFont.getMaxHeight()+this.leading)+this.padding[0]+this.padding[2]:this._lines.length*(this._charSize.height+this.leading)+this.padding[0]+this.padding[2],e==this._textWidth&&t==this._textHeight||(this._textWidth=e,this._textHeight=t)}},{key:"_checkEnabledViewportOrNot",value:function(){return this.overflow==Text.SCROLL&&(this._width>0&&this._textWidth>this._width||this._height>0&&this._textHeight>this._height)}},{key:"changeText",value:function(e){this._text!==e&&(this.lang(e+""),this._graphics&&this._graphics.replaceText(this._text)||this.typeset())}},{key:"_parseLines",value:function(e){var t=this.wordWrap||this.overflow==Text.HIDDEN;if(t)var n=this._getWordWrapWidth();var r=this._style.currBitmapFont;if(r)this._charSize.width=r.getMaxWidth(),this._charSize.height=r.getMaxHeight();else{var a=null;(a=i.Render.isConchApp?window.conchTextCanvas.measureText(Text._testWord):i.Browser.context.measureText(Text._testWord))||(a={width:100}),this._charSize.width=a.width,this._charSize.height=a.height||this.fontSize}for(var s=e.replace(/\r\n/g,"\n").split("\n"),o=0,l=s.length;o<l;o++){var h=s[o];t?this._parseLine(h,n):(this._lineWidths.push(this._getTextWidth(h)),this._lines.push(h))}}},{key:"_parseLine",value:function(e,t){var i=this._lines,n=0,r=0,a=0,s=0;if((r=this._getTextWidth(e))<=t)return i.push(e),void this._lineWidths.push(r);r=this._charSize.width,0==(n=Math.floor(t/r))&&(n=1),a=r=this._getTextWidth(e.substring(0,n));for(var o=n,l=e.length;o<l;o++)if((a+=r=this._getTextWidth(e.charAt(o)))>t)if(this.wordWrap){var h=e.substring(s,o);if(h.charCodeAt(h.length-1)<255){var u=/(?:\w|-)+$/.exec(h);u&&(o=u.index+s,0==u.index?o+=h.length:h=e.substring(s,o))}if(i.push(h),this._lineWidths.push(a-r),s=o,!(o+n<l)){i.push(e.substring(s,l)),this._lineWidths.push(this._getTextWidth(i[i.length-1])),s=-1;break}o+=n,a=r=this._getTextWidth(e.substring(s,o)),o--}else if(this.overflow==Text.HIDDEN)return i.push(e.substring(0,o)),void this._lineWidths.push(this._getTextWidth(i[i.length-1]));this.wordWrap&&-1!=s&&(i.push(e.substring(s,l)),this._lineWidths.push(this._getTextWidth(i[i.length-1])))}},{key:"_getTextWidth",value:function(e){var t=this._style.currBitmapFont;return t?t.getTextWidth(e):i.Render.isConchApp?window.conchTextCanvas.measureText(e).width:(i.Browser.context.measureText(e)||{width:100}).width}},{key:"_getWordWrapWidth",value:function(){var e,t=this.padding,n=this._style.currBitmapFont;return(e=n&&n.autoScaleSize?this._width*(n.fontSize/this.fontSize):this._width)<=0&&(e=this.wordWrap?100:i.Browser.width),e<=0&&(e=100),e-t[3]-t[1]}},{key:"getCharPoint",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this._isChanged&&i.systemTimer.runCallLater(this,this.typeset);for(var n=0,r=this._lines,a=0,s=0,o=r.length;s<o;s++){if(e<(n+=r[s].length)){var l=s;break}a=n}var h=(this.italic?"italic ":"")+(this.bold?"bold ":"")+this.fontSize+"px "+this.font;i.Browser.context.font=h;var u=this._getTextWidth(this._text.substring(a,e)),c=t||new v;return c.setTo(this._startX+u-(this._clipPoint?this._clipPoint.x:0),this._startY+l*(this._charSize.height+this.leading)-(this._clipPoint?this._clipPoint.y:0))}},{key:"width",get:function(){return this._width?this._width:this.textWidth+this.padding[1]+this.padding[3]},set:function(e){e!=this._width&&(_get(_getPrototypeOf(Text.prototype),"set_width",this).call(this,e),this.isChanged=!0,this.borderColor&&this._setBorderStyleColor(0,0,this.width,this.height,this.borderColor,1))}},{key:"height",get:function(){return this._height?this._height:this.textHeight},set:function(e){e!=this._height&&(_get(_getPrototypeOf(Text.prototype),"set_height",this).call(this,e),this.isChanged=!0,this.borderColor&&this._setBorderStyleColor(0,0,this.width,this.height,this.borderColor,1))}},{key:"textWidth",get:function(){return this._isChanged&&i.systemTimer.runCallLater(this,this.typeset),this._textWidth}},{key:"textHeight",get:function(){return this._isChanged&&i.systemTimer.runCallLater(this,this.typeset),this._textHeight}},{key:"text",get:function(){return this._text||""},set:function(e){this.set_text(e)}},{key:"font",get:function(){return this._font},set:function(e){this._style.currBitmapFont&&(this._getTextStyle().currBitmapFont=null,this.scale(1,1)),Text._bitmapFonts&&Text._bitmapFonts[e]&&(this._getTextStyle().currBitmapFont=Text._bitmapFonts[e]),this._font=e,this.isChanged=!0}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!=e&&(this._fontSize=e,this.isChanged=!0)}},{key:"bold",get:function(){return this._style.bold},set:function(e){this._getTextStyle().bold=e,this.isChanged=!0}},{key:"color",get:function(){return this._color},set:function(e){this.set_color(e)}},{key:"italic",get:function(){return this._style.italic},set:function(e){this._getTextStyle().italic=e,this.isChanged=!0}},{key:"align",get:function(){return this._style.align},set:function(e){this._getTextStyle().align=e,this.isChanged=!0}},{key:"valign",get:function(){return this._valign},set:function(e){this._valign=e,this.isChanged=!0}},{key:"wordWrap",get:function(){return this._style.wordWrap},set:function(e){this._getTextStyle().wordWrap=e,this.isChanged=!0}},{key:"leading",get:function(){return this._style.leading},set:function(e){this._getTextStyle().leading=e,this.isChanged=!0}},{key:"padding",get:function(){return this._style.padding},set:function(e){if("string"==typeof e){var t,i,n;for(n=(t=e.split(",")).length;t.length<4;)t.push(0);for(i=0;i<n;i++)t[i]=parseFloat(t[i])||0;e=t}this._getTextStyle().padding=e,this.isChanged=!0}},{key:"bgColor",get:function(){return this._style.bgColor},set:function(e){this.set_bgColor(e)}},{key:"borderColor",get:function(){return this._style.borderColor},set:function(e){this._getTextStyle().borderColor=e,this._renderType|=ot.STYLE,this._setBorderStyleColor(0,0,this.width,this.height,e,1),this._setRenderType(this._renderType),this.isChanged=!0}},{key:"stroke",get:function(){return this._style.stroke},set:function(e){this._getTextStyle().stroke=e,this.isChanged=!0}},{key:"strokeColor",get:function(){return this._style.strokeColor},set:function(e){this._getTextStyle().strokeColor=e,this.isChanged=!0}},{key:"isChanged",set:function(e){this._isChanged!==e&&(this._isChanged=e,e&&i.systemTimer.callLater(this,this.typeset))}},{key:"scrollX",set:function(e){if(!(this.overflow!=Text.SCROLL||this.textWidth<this._width)&&this._clipPoint){e=e<this.padding[3]?this.padding[3]:e;var t=this._textWidth-this._width;e=e>t?t:e,this._clipPoint.x=e,this._renderText()}},get:function(){return this._clipPoint?this._clipPoint.x:0}},{key:"scrollY",set:function(e){if(!(this.overflow!=Text.SCROLL||this.textHeight<this._height)&&this._clipPoint){e=e<this.padding[0]?this.padding[0]:e;var t=this._textHeight-this._height;e=e>t?t:e,this._clipPoint.y=e,this._renderText()}},get:function(){return this._clipPoint?this._clipPoint.y:0}},{key:"maxScrollX",get:function(){return this.textWidth<this._width?0:this._textWidth-this._width}},{key:"maxScrollY",get:function(){return this.textHeight<this._height?0:this._textHeight-this._height}},{key:"lines",get:function(){return this._isChanged&&this.typeset(),this._lines}},{key:"underlineColor",get:function(){return this._style.underlineColor},set:function(e){this._getTextStyle().underlineColor=e,this._isChanged||this._renderText()}},{key:"underline",get:function(){return this._style.underline},set:function(e){this._getTextStyle().underline=e}},{key:"singleCharRender",set:function(e){this._singleCharRender=e},get:function(){return this._singleCharRender}}],[{key:"defaultFontStr",value:function(){return Text.defaultFontSize+"px "+Text.defaultFont}},{key:"registerBitmapFont",value:function(e,t){Text._bitmapFonts||(Text._bitmapFonts={}),Text._bitmapFonts[e]=t}},{key:"unregisterBitmapFont",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(Text._bitmapFonts&&Text._bitmapFonts[e]){var i=Text._bitmapFonts[e];t&&i.destroy(),delete Text._bitmapFonts[e]}}}]),Text}(St);bt.VISIBLE="visible",bt.SCROLL="scroll",bt.HIDDEN="hidden",bt.defaultFontSize=12,bt.defaultFont="Arial",bt.isComplexText=!1,bt.fontFamilyMap={"报隶":"报隶-简","黑体":"黑体-简","楷体":"楷体-简","兰亭黑":"兰亭黑-简","隶变":"隶变-简","凌慧体":"凌慧体-简","翩翩体":"翩翩体-简","苹方":"苹方-简","手札体":"手札体-简","宋体":"宋体-简","娃娃体":"娃娃体-简","魏碑":"魏碑-简","行楷":"行楷-简","雅痞":"雅痞-简","圆体":"圆体-简"},bt._testWord="游",bt.CharacterCache=!0,bt.RightToLeft=!1,i.regClass(bt),mt.regClass("laya.display.Text",bt),mt.regClass("Laya.Text",bt);var Et=function(e){function Input(){var e;return _classCallCheck(this,Input),(e=_possibleConstructorReturn(this,_getPrototypeOf(Input).call(this)))._multiline=!1,e._editable=!0,e._maxChars=1e5,e._type="text",e._prompt="",e._promptColor="#A9A9A9",e._originColor="#000000",e._content="",Input.IOS_IFRAME=i.Browser.onIOS&&i.Browser.window.top!=i.Browser.window.self,e._width=100,e._height=20,e.multiline=!1,e.overflow=bt.SCROLL,e.on(We.MOUSE_DOWN,_assertThisInitialized(e),e._onMouseDown),e.on(We.UNDISPLAY,_assertThisInitialized(e),e._onUnDisplay),e}return _inherits(Input,e),_createClass(Input,[{key:"setSelection",value:function(e,t){this.focus=!0,Input.inputElement.selectionStart=e,Input.inputElement.selectionEnd=t}},{key:"_onUnDisplay",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.focus=!1}},{key:"_onMouseDown",value:function(e){this.focus=!0}},{key:"_syncInputTransform",value:function(){var e=this.nativeInput,t=j.getTransformRelativeToWindow(this,this.padding[3],this.padding[0]),n=this._width-this.padding[1]-this.padding[3],r=this._height-this.padding[0]-this.padding[2];i.Render.isConchApp?(e.setScale(t.scaleX,t.scaleY),e.setSize(n,r),e.setPos(t.x,t.y)):(Input.inputContainer.style.transform=Input.inputContainer.style.webkitTransform="scale("+t.scaleX+","+t.scaleY+") rotate("+i.stage.canvasDegree+"deg)",e.style.width=n+"px",e.style.height=r+"px",Input.inputContainer.style.left=t.x+"px",Input.inputContainer.style.top=t.y+"px")}},{key:"select",value:function(){this.nativeInput.select()}},{key:"_setInputMethod",value:function(){Input.input.parentElement&&Input.inputContainer.removeChild(Input.input),Input.area.parentElement&&Input.inputContainer.removeChild(Input.area),Input.inputElement=this._multiline?Input.area:Input.input,Input.inputContainer.appendChild(Input.inputElement),bt.RightToLeft&&(Input.inputElement.style.direction="rtl")}},{key:"_focusIn",value:function(){Input.isInputting=!0;var e=this.nativeInput;Input.input&&(Input.input.type=this._type),this._focus=!0;var t=e.style;t.whiteSpace=this.wordWrap?"pre-wrap":"nowrap",this._setPromptColor(),e.readOnly=!this._editable,i.Render.isConchApp&&(e.setType(this._type),e.setForbidEdit(!this._editable)),e.maxLength=this._maxChars;this.padding;if(e.value=this._content,e.placeholder=this._prompt,i.stage.off(We.KEY_DOWN,this,this._onKeyDown),i.stage.on(We.KEY_DOWN,this,this._onKeyDown),i.stage.focus=this,this.event(We.FOCUS),i.Browser.onPC&&e.focus(),!(i.Browser.onMiniGame||i.Browser.onBDMiniGame||i.Browser.onQGMiniGame||i.Browser.onKGMiniGame||i.Browser.onVVMiniGame||i.Browser.onAlipayMiniGame||i.Browser.onQQMiniGame||i.Browser.onBLMiniGame||i.Browser.onTTMiniGame||i.Browser.onHWMiniGame||i.Browser.onTBMiniGame)){this._text;this._text=null}this.typeset(),e.setColor(this._originColor),e.setFontSize(this.fontSize),e.setFontFace(i.Browser.onIPhone&&bt.fontFamilyMap[this.font]||this.font),i.Render.isConchApp&&e.setMultiAble&&e.setMultiAble(this._multiline),t.lineHeight=this.leading+this.fontSize+"px",t.fontStyle=this.italic?"italic":"normal",t.fontWeight=this.bold?"bold":"normal",t.textAlign=this.align,t.padding="0 0",this._syncInputTransform(),!i.Render.isConchApp&&i.Browser.onPC&&i.systemTimer.frameLoop(1,this,this._syncInputTransform)}},{key:"_setPromptColor",value:function(){Input.promptStyleDOM=i.Browser.getElementById("promptStyle"),Input.promptStyleDOM||(Input.promptStyleDOM=i.Browser.createElement("style"),Input.promptStyleDOM.setAttribute("id","promptStyle"),i.Browser.document.head.appendChild(Input.promptStyleDOM)),Input.promptStyleDOM.innerText="input::-webkit-input-placeholder, textarea::-webkit-input-placeholder {color:"+this._promptColor+"}input:-moz-placeholder, textarea:-moz-placeholder {color:"+this._promptColor+"}input::-moz-placeholder, textarea::-moz-placeholder {color:"+this._promptColor+"}input:-ms-input-placeholder, textarea:-ms-input-placeholder {color:"+this._promptColor+"}"}},{key:"_focusOut",value:function(){Input.isInputting&&(Input.isInputting=!1,this._focus=!1,this._text=null,this._content=this.nativeInput.value,this._content?(_get(_getPrototypeOf(Input.prototype),"set_text",this).call(this,this._content),_get(_getPrototypeOf(Input.prototype),"set_color",this).call(this,this._originColor)):(_get(_getPrototypeOf(Input.prototype),"set_text",this).call(this,this._prompt),_get(_getPrototypeOf(Input.prototype),"set_color",this).call(this,this._promptColor)),i.stage.off(We.KEY_DOWN,this,this._onKeyDown),i.stage.focus=null,this.event(We.BLUR),this.event(We.CHANGE),i.Render.isConchApp&&this.nativeInput.blur(),i.Browser.onPC&&i.systemTimer.clear(this,this._syncInputTransform))}},{key:"_onKeyDown",value:function(e){13===e.keyCode&&(i.Browser.onMobile&&!this._multiline&&(this.focus=!1),this.event(We.ENTER))}},{key:"changeText",value:function(e){this._content=e,this._focus?(this.nativeInput.value=e||"",this.event(We.CHANGE)):_get(_getPrototypeOf(Input.prototype),"changeText",this).call(this,e)}},{key:"multiline",get:function(){return this._multiline},set:function(e){this._multiline=e,this.valign=e?"top":"middle"}},{key:"nativeInput",get:function(){return this._multiline?Input.area:Input.input}},{key:"focus",get:function(){return this._focus},set:function(e){var t=this.nativeInput;this._focus!==e&&(e?(t.target?t.target._focusOut():this._setInputMethod(),t.target=this,this._focusIn()):(t.target=null,this._focusOut(),i.Browser.document.body.scrollTop=0,t.blur(),i.Render.isConchApp?t.setPos(-1e4,-1e4):Input.inputContainer.contains(t)&&Input.inputContainer.removeChild(t)))}},{key:"text",set:function(e){_get(_getPrototypeOf(Input.prototype),"set_color",this).call(this,this._originColor),e+="",this._focus?(this.nativeInput.value=e||"",this.event(We.CHANGE)):(this._multiline||(e=e.replace(/\r?\n/g,"")),this._content=e,e?_get(_getPrototypeOf(Input.prototype),"set_text",this).call(this,e):(_get(_getPrototypeOf(Input.prototype),"set_text",this).call(this,this._prompt),_get(_getPrototypeOf(Input.prototype),"set_color",this).call(this,this.promptColor)))},get:function(){return this._focus?this.nativeInput.value:this._content||""}},{key:"color",set:function(e){this._focus&&this.nativeInput.setColor(e),_get(_getPrototypeOf(Input.prototype),"set_color",this).call(this,this._content?e:this._promptColor),this._originColor=e},get:function(){return _get(_getPrototypeOf(Input.prototype),"color",this)}},{key:"bgColor",set:function(e){_get(_getPrototypeOf(Input.prototype),"set_bgColor",this).call(this,e),i.Render.isConchApp&&this.nativeInput.setBgColor(e)},get:function(){return _get(_getPrototypeOf(Input.prototype),"bgColor",this)}},{key:"restrict",get:function(){return this._restrictPattern?this._restrictPattern.source:""},set:function(e){e?((e="[^"+e+"]").indexOf("^^")>-1&&(e=e.replace("^^","")),this._restrictPattern=new RegExp(e,"g")):this._restrictPattern=null}},{key:"editable",set:function(e){this._editable=e,i.Render.isConchApp&&Input.input.setForbidEdit(!e)},get:function(){return this._editable}},{key:"maxChars",get:function(){return this._maxChars},set:function(e){e<=0&&(e=1e5),this._maxChars=e}},{key:"prompt",get:function(){return this._prompt},set:function(e){!this._text&&e&&_get(_getPrototypeOf(Input.prototype),"set_color",this).call(this,this._promptColor),this.promptColor=this._promptColor,this._text?_get(_getPrototypeOf(Input.prototype),"set_text",this).call(this,this._text==this._prompt?e:this._text):_get(_getPrototypeOf(Input.prototype),"set_text",this).call(this,e),this._prompt=bt.langPacks&&bt.langPacks[e]?bt.langPacks[e]:e}},{key:"promptColor",get:function(){return this._promptColor},set:function(e){this._promptColor=e,this._content||_get(_getPrototypeOf(Input.prototype),"set_color",this).call(this,e)}},{key:"type",get:function(){return this._type},set:function(e){this._getTextStyle().asPassword="password"===e,this._type=e}}],[{key:"__init__",value:function(){if(Input._createInputElement(),i.Browser.onMobile){var e=!1;(i.Browser.onMiniGame||i.Browser.onBDMiniGame||i.Browser.onQGMiniGame||i.Browser.onKGMiniGame||i.Browser.onVVMiniGame||i.Browser.onAlipayMiniGame||i.Browser.onQQMiniGame||i.Browser.onBLMiniGame||i.Browser.onTTMiniGame||i.Browser.onHWMiniGame||i.Browser.onTBMiniGame)&&(e=!0),i.Render.canvas.addEventListener(Input.IOS_IFRAME?e?"touchend":"click":"touchend",Input._popupInputMethod)}}},{key:"_popupInputMethod",value:function(e){Input.isInputting&&Input.inputElement.focus()}},{key:"_createInputElement",value:function(){Input._initInput(Input.area=i.Browser.createElement("textarea")),Input._initInput(Input.input=i.Browser.createElement("input")),Input.inputContainer=i.Browser.createElement("div"),Input.inputContainer.style.position="absolute",Input.inputContainer.style.zIndex=1e5,i.Browser.container.appendChild(Input.inputContainer),Input.inputContainer.setPos=function(e,t){Input.inputContainer.style.left=e+"px",Input.inputContainer.style.top=t+"px"}}},{key:"_initInput",value:function(e){var t=e.style;t.cssText="position:absolute;overflow:hidden;resize:none;transform-origin:0 0;-webkit-transform-origin:0 0;-moz-transform-origin:0 0;-o-transform-origin:0 0;",t.resize="none",t.backgroundColor="transparent",t.border="none",t.outline="none",t.zIndex=1,e.addEventListener("input",Input._processInputting),e.addEventListener("mousemove",Input._stopEvent),e.addEventListener("mousedown",Input._stopEvent),e.addEventListener("touchmove",Input._stopEvent),e.setFontFace=function(t){e.style.fontFamily=t},i.Render.isConchApp||(e.setColor=function(t){e.style.color=t},e.setFontSize=function(t){e.style.fontSize=t+"px"})}},{key:"_processInputting",value:function(e){var t=Input.inputElement.target;if(t){var i=Input.inputElement.value;t._restrictPattern&&(i=i.replace(/\u2006|\x27/g,""),t._restrictPattern.test(i)&&(i=i.replace(t._restrictPattern,""),Input.inputElement.value=i)),t._text=i,t.event(We.INPUT)}}},{key:"_stopEvent",value:function(e){"touchmove"==e.type&&e.preventDefault(),e.stopPropagation&&e.stopPropagation()}}]),Input}(bt);Et.TYPE_TEXT="text",Et.TYPE_PASSWORD="password",Et.TYPE_EMAIL="email",Et.TYPE_URL="url",Et.TYPE_NUMBER="number",Et.TYPE_RANGE="range",Et.TYPE_DATE="date",Et.TYPE_MONTH="month",Et.TYPE_WEEK="week",Et.TYPE_TIME="time",Et.TYPE_DATE_TIME="datetime",Et.TYPE_DATE_TIME_LOCAL="datetime-local",Et.TYPE_SEARCH="search",Et.IOS_IFRAME=!1,Et.inputHeight=45,Et.isInputting=!1,mt.regClass("laya.display.Input",Et),mt.regClass("Laya.Input",Et);var Mt=function(){function TouchManager(){_classCallCheck(this,TouchManager),this.preOvers=[],this.preDowns=[],this.preRightDowns=[],this.enable=!0,this._event=new We,this._lastClickTime=0}return _createClass(TouchManager,[{key:"_clearTempArrs",value:function(){TouchManager._oldArr.length=0,TouchManager._newArr.length=0,TouchManager._tEleArr.length=0}},{key:"getTouchFromArr",value:function(e,t){var i,n,r;for(n=t.length,i=0;i<n;i++)if((r=t[i]).id==e)return r;return null}},{key:"removeTouchFromArr",value:function(e,t){var i;for(i=t.length-1;i>=0;i--)t[i].id==e&&t.splice(i,1)}},{key:"createTouchO",value:function(e,t){var i;return(i=n.getItem("TouchData")||{}).id=t,i.tar=e,i}},{key:"onMouseDown",value:function(e,t){var i,n,r,a,s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.enable&&(i=this.getTouchFromArr(t,this.preOvers),r=this.getEles(e,null,TouchManager._tEleArr),i?i.tar=e:(n=this.createTouchO(e,t),this.preOvers.push(n)),Ke.onMobile&&this.sendEvents(r,We.MOUSE_OVER),a=s?this.preDowns:this.preRightDowns,(i=this.getTouchFromArr(t,a))?i.tar=e:(n=this.createTouchO(e,t),a.push(n)),this.sendEvents(r,s?We.MOUSE_DOWN:We.RIGHT_MOUSE_DOWN),this._clearTempArrs())}},{key:"sendEvents",value:function(e,t){var i,n,r;for(n=e.length,this._event._stoped=!1,r=e[0],i=0;i<n;i++){var a=e[i];if(a.destroyed)return;if(a.event(t,this._event.setTo(t,a,r)),this._event._stoped)break}}},{key:"getEles",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;for(i?i.length=0:i=[];e&&e!=t;)i.push(e),e=e.parent;return i}},{key:"checkMouseOutAndOverOfMove",value:function(e,t){var i,n,r,a;arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(t!=e)if(t.contains(e))n=this.getEles(e,t,TouchManager._tEleArr),this.sendEvents(n,We.MOUSE_OVER);else if(e.contains(t))n=this.getEles(t,e,TouchManager._tEleArr),this.sendEvents(n,We.MOUSE_OUT);else{var s,o,l;for((n=TouchManager._tEleArr).length=0,s=this.getEles(t,null,TouchManager._oldArr),o=this.getEles(e,null,TouchManager._newArr),a=s.length,r=0;r<a;r++){if(i=s[r],(l=o.indexOf(i))>=0){o.splice(l,o.length-l);break}n.push(i)}n.length>0&&this.sendEvents(n,We.MOUSE_OUT),o.length>0&&this.sendEvents(o,We.MOUSE_OVER)}}},{key:"onMouseMove",value:function(e,t){var i,n;this.enable&&((i=this.getTouchFromArr(t,this.preOvers))?(this.checkMouseOutAndOverOfMove(e,i.tar),i.tar=e,n=this.getEles(e,null,TouchManager._tEleArr)):(n=this.getEles(e,null,TouchManager._tEleArr),this.sendEvents(n,We.MOUSE_OVER),this.preOvers.push(this.createTouchO(e,t))),this.sendEvents(n,We.MOUSE_MOVE),this._clearTempArrs())}},{key:"getLastOvers",value:function(){return TouchManager._tEleArr.length=0,this.preOvers.length>0&&this.preOvers[0].tar?this.getEles(this.preOvers[0].tar,null,TouchManager._tEleArr):(TouchManager._tEleArr.push(i.stage),TouchManager._tEleArr)}},{key:"stageMouseOut",value:function(){var e;e=this.getLastOvers(),this.preOvers.length=0,this.sendEvents(e,We.MOUSE_OUT)}},{key:"onMouseUp",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.enable){var r,a,s,o,l,h,u,c,_=Ke.onMobile;if(a=this.getEles(e,null,TouchManager._tEleArr),this.sendEvents(a,i?We.MOUSE_UP:We.RIGHT_MOUSE_UP),c=i?this.preDowns:this.preRightDowns,r=this.getTouchFromArr(t,c)){var d,f=Ke.now();if(d=f-this._lastClickTime<300,this._lastClickTime=f,e==r.tar)u=a;else for(s=this.getEles(r.tar,null,TouchManager._oldArr),(u=TouchManager._newArr).length=0,l=s.length,o=0;o<l;o++)h=s[o],a.indexOf(h)>=0&&u.push(h);u.length>0&&this.sendEvents(u,i?We.CLICK:We.RIGHT_CLICK),i&&d&&this.sendEvents(u,We.DOUBLE_CLICK),this.removeTouchFromArr(t,c),r.tar=null,n.recover("TouchData",r)}else;(r=this.getTouchFromArr(t,this.preOvers))&&_&&((u=this.getEles(r.tar,null,u))&&u.length>0&&this.sendEvents(u,We.MOUSE_OUT),this.removeTouchFromArr(t,this.preOvers),r.tar=null,n.recover("TouchData",r)),this._clearTempArrs()}}}]),TouchManager}();Mt.I=new Mt,Mt._oldArr=[],Mt._newArr=[],Mt._tEleArr=[];var At=function(){function MouseManager(){_classCallCheck(this,MouseManager),this.mouseX=0,this.mouseY=0,this.disableMouseEvent=!1,this.mouseDownTime=0,this.mouseMoveAccuracy=2,this._event=new We,this._captureSp=null,this._captureChain=[],this._captureExlusiveMode=!1,this._hitCaputreSp=!1,this._point=new v,this._rect=new p,this._lastMoveTimer=0,this._prePoint=new v,this._touchIDs={},this._curTouchID=NaN,this._id=1}return _createClass(MouseManager,[{key:"__init__",value:function(e,t){this._stage=e;var i=this;t.oncontextmenu=function(e){if(MouseManager.enabled)return!1},t.addEventListener("mousedown",(function(e){MouseManager.enabled&&(Ke.onIE||e.cancelable&&e.preventDefault(),i.mouseDownTime=Ke.now(),i.runEvent(e))})),t.addEventListener("mouseup",(function(e){MouseManager.enabled&&(e.cancelable&&e.preventDefault(),i.mouseDownTime=-Ke.now(),i.runEvent(e))}),!0),t.addEventListener("mousemove",(function(e){if(MouseManager.enabled){e.cancelable&&e.preventDefault();var t=Ke.now();if(t-i._lastMoveTimer<10)return;i._lastMoveTimer=t,i.runEvent(e)}}),!0),t.addEventListener("mouseout",(function(e){MouseManager.enabled&&i.runEvent(e)})),t.addEventListener("mouseover",(function(e){MouseManager.enabled&&i.runEvent(e)})),t.addEventListener("touchstart",(function(e){MouseManager.enabled&&(MouseManager._isFirstTouch||Et.isInputting||e.cancelable&&e.preventDefault(),i.mouseDownTime=Ke.now(),i.runEvent(e))})),t.addEventListener("touchend",(function(e){MouseManager.enabled?(MouseManager._isFirstTouch||Et.isInputting||e.cancelable&&e.preventDefault(),MouseManager._isFirstTouch=!1,i.mouseDownTime=-Ke.now(),i.runEvent(e)):i._curTouchID=NaN}),!0),t.addEventListener("touchmove",(function(e){MouseManager.enabled&&(e.cancelable&&e.preventDefault(),i.runEvent(e))}),!0),t.addEventListener("touchcancel",(function(e){MouseManager.enabled?(e.cancelable&&e.preventDefault(),i.runEvent(e)):i._curTouchID=NaN}),!0),t.addEventListener("mousewheel",(function(e){MouseManager.enabled&&i.runEvent(e)})),t.addEventListener("DOMMouseScroll",(function(e){MouseManager.enabled&&i.runEvent(e)}))}},{key:"initEvent",value:function(e){var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this;n._event._stoped=!1,n._event.nativeEvent=i||e,n._target=null,this._point.setTo(e.pageX||e.clientX,e.pageY||e.clientY),this._stage._canvasTransform&&(this._stage._canvasTransform.invertTransformPoint(this._point),n.mouseX=this._point.x,n.mouseY=this._point.y),n._event.touchId=e.identifier||0,this._tTouchID=n._event.touchId,(t=Mt.I._event)._stoped=!1,t.nativeEvent=n._event.nativeEvent,t.touchId=n._event.touchId}},{key:"checkMouseWheel",value:function(e){this._event.delta=e.wheelDelta?.025*e.wheelDelta:-e.detail;for(var t=Mt.I.getLastOvers(),i=0,n=t.length;i<n;i++){var r=t[i];r.event(We.MOUSE_WHEEL,this._event.setTo(We.MOUSE_WHEEL,r,this._target))}}},{key:"onMouseMove",value:function(e){Mt.I.onMouseMove(e,this._tTouchID)}},{key:"onMouseDown",value:function(e){if(Et.isInputting&&i.stage.focus&&i.stage.focus.focus&&!i.stage.focus.contains(this._target)){var t=i.stage.focus._tf||i.stage.focus,n=e._tf||e;n instanceof Et&&n.multiline==t.multiline?t._focusOut():t.focus=!1}Mt.I.onMouseDown(e,this._tTouchID,this._isLeftMouse)}},{key:"onMouseUp",value:function(e){Mt.I.onMouseUp(e,this._tTouchID,this._isLeftMouse)}},{key:"check",value:function(e,t,i,n){this._point.setTo(t,i),e.fromParentPoint(this._point),t=this._point.x,i=this._point.y;var r=e._style.scrollRect;if(r&&(this._rect.setTo(r.x,r.y,r.width,r.height),!this._rect.contains(t,i)))return!1;if(!this.disableMouseEvent){if(e.hitTestPrior&&!e.mouseThrough&&!this.hitTest(e,t,i))return!1;for(var a=e._children.length-1;a>-1;a--){var s=e._children[a];if(!s.destroyed&&s._mouseState>1&&s._visible&&this.check(s,t,i,n))return!0}for(a=e._extUIChild.length-1;a>=0;a--){var o=e._extUIChild[a];if(!o.destroyed&&o._mouseState>1&&o._visible&&this.check(o,t,i,n))return!0}}var l=!(!e.hitTestPrior||e.mouseThrough||this.disableMouseEvent)||this.hitTest(e,t,i);return l?(this._target=e,n.call(this,e),this._target==this._hitCaputreSp&&(this._hitCaputreSp=!0)):n===this.onMouseUp&&e===this._stage&&(this._target=this._stage,n.call(this,this._target)),l}},{key:"hitTest",value:function(e,t,i){var n=!1;e.scrollRect&&(t-=e._style.scrollRect.x,i-=e._style.scrollRect.y);var r=e._style.hitArea;return r&&r._hit?r.contains(t,i):((e.width>0&&e.height>0||e.mouseThrough||r)&&(n=e.mouseThrough?e.getGraphicBounds().contains(t,i):(r||this._rect.setTo(0,0,e.width,e.height)).contains(t,i)),n)}},{key:"_checkAllBaseUI",value:function(e,t,i){var n=this.handleExclusiveCapture(this.mouseX,this.mouseY,i);return!!n||(n=this.check(this._stage,this.mouseX,this.mouseY,i),this.handleCapture(this.mouseX,this.mouseY,i)||n)}},{key:"check3DUI",value:function(e,t,i){for(var n=this._stage._3dUI,r=0,a=!1;r<n.length;r++){var s=n[r];this._stage._curUIBase=s,!s.destroyed&&s._mouseState>1&&s._visible&&(a=a||this.check(s,this.mouseX,this.mouseY,i))}return this._stage._curUIBase=this._stage,a}},{key:"handleExclusiveCapture",value:function(e,t,i){if(this._captureExlusiveMode&&this._captureSp&&this._captureChain.length>0){var n;this._point.setTo(e,t);for(var r=0;r<this._captureChain.length;r++)(n=this._captureChain[r]).fromParentPoint(this._point);return this._target=n,i.call(this,n),!0}return!1}},{key:"handleCapture",value:function(e,t,i){if(!this._hitCaputreSp&&this._captureSp&&this._captureChain.length>0){var n;this._point.setTo(e,t);for(var r=0;r<this._captureChain.length;r++)(n=this._captureChain[r]).fromParentPoint(this._point);return this._target=n,i.call(this,n),!0}return!1}},{key:"runEvent",value:function(e){var t,i,n;switch("mousemove"!==e.type&&(this._prePoint.x=this._prePoint.y=-1e6),e.type){case"mousedown":this._touchIDs[0]=this._id++,MouseManager._isTouchRespond?MouseManager._isTouchRespond=!1:(this._isLeftMouse=0===e.button,this.initEvent(e),this._checkAllBaseUI(this.mouseX,this.mouseY,this.onMouseDown));break;case"mouseup":this._isLeftMouse=0===e.button,this.initEvent(e),this._checkAllBaseUI(this.mouseX,this.mouseY,this.onMouseUp);break;case"mousemove":Math.abs(this._prePoint.x-e.clientX)+Math.abs(this._prePoint.y-e.clientY)>=this.mouseMoveAccuracy&&(this._prePoint.x=e.clientX,this._prePoint.y=e.clientY,this.initEvent(e),this._checkAllBaseUI(this.mouseX,this.mouseY,this.onMouseMove));break;case"touchstart":MouseManager._isTouchRespond=!0,this._isLeftMouse=!0;var r=e.changedTouches;for(t=0,i=r.length;t<i;t++)n=r[t],(MouseManager.multiTouchEnabled||isNaN(this._curTouchID))&&(this._curTouchID=n.identifier,this._id%200==0&&(this._touchIDs={}),this._touchIDs[n.identifier]=this._id++,this.initEvent(n,e),this._checkAllBaseUI(this.mouseX,this.mouseY,this.onMouseDown));break;case"touchend":case"touchcancel":MouseManager._isTouchRespond=!0,this._isLeftMouse=!0;var a=e.changedTouches;for(t=0,i=a.length;t<i;t++){if(n=a[t],MouseManager.multiTouchEnabled||n.identifier==this._curTouchID)this._curTouchID=NaN,this.initEvent(n,e),this._checkAllBaseUI(this.mouseX,this.mouseY,this.onMouseUp)||this.onMouseUp(null)}break;case"touchmove":var s=e.changedTouches;for(t=0,i=s.length;t<i;t++)n=s[t],(MouseManager.multiTouchEnabled||n.identifier==this._curTouchID)&&(this.initEvent(n,e),this._checkAllBaseUI(this.mouseX,this.mouseY,this.onMouseMove));break;case"wheel":case"mousewheel":case"DOMMouseScroll":this.checkMouseWheel(e);break;case"mouseout":Mt.I.stageMouseOut();break;case"mouseover":this._stage.event(We.MOUSE_OVER,this._event.setTo(We.MOUSE_OVER,this._stage,this._stage))}}},{key:"setCapture",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._captureSp=e,this._captureExlusiveMode=t,this._captureChain.length=0,this._captureChain.push(e);for(var n=e;n!=i.stage&&n!=i.stage._curUIBase&&(n=n.parent);)this._captureChain.splice(0,0,n)}},{key:"releaseCapture",value:function(){console.log("release capture"),this._captureSp=null}}]),MouseManager}();At.instance=new At,At.enabled=!0,At.multiTouchEnabled=!0,At._isFirstTouch=!0;var wt=function(){function CallLater(){_classCallCheck(this,CallLater),this._pool=[],this._map={},this._laters=[]}return _createClass(CallLater,[{key:"_update",value:function(){var e=this._laters,t=e.length;if(t>0){for(var i=0,n=t-1;i<=n;i++){var r=e[i];this._map[r.key]=null,null!==r.method&&(r.run(),r.clear()),this._pool.push(r),i===n&&(n=e.length-1)}e.length=0}}},{key:"_getHandler",value:function(e,t){var n=e?e.$_GID||(e.$_GID=i.Utils.getGID()):0,r=t.$_TID||(t.$_TID=i.Timer._mid++);return this._map[n+"."+r]}},{key:"callLater",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(null==this._getHandler(e,t)){var n;(n=this._pool.length?this._pool.pop():new Lt).caller=e,n.method=t,n.args=i;var r=e?e.$_GID:0,a=t.$_TID;n.key=r+"."+a,this._map[n.key]=n,this._laters.push(n)}}},{key:"runCallLater",value:function(e,t){var i=this._getHandler(e,t);i&&null!=i.method&&(this._map[i.key]=null,i.run(),i.clear())}}]),CallLater}();wt.I=new wt;var Lt=function(){function LaterHandler(){_classCallCheck(this,LaterHandler)}return _createClass(LaterHandler,[{key:"clear",value:function(){this.caller=null,this.method=null,this.args=null}},{key:"run",value:function(){var e=this.caller;if(e&&e.destroyed)return this.clear();var t=this.method,i=this.args;null!=t&&(i?t.apply(e,i):t.call(e))}}]),LaterHandler}(),It=function RunDriver(){_classCallCheck(this,RunDriver)};It.createShaderCondition=function(e){var t="(function() {return "+e+";})";return window.Laya._runScript(t)},It.changeWebGLSize=function(e,t){Je.onStageResize(e,t)};var Pt=function(e){function Stage(){var e;_classCallCheck(this,Stage),(e=_possibleConstructorReturn(this,_getPrototypeOf(Stage).call(this))).offset=new v,e._frameRate="fast",e.designWidth=0,e.designHeight=0,e.canvasRotation=!1,e.canvasDegree=0,e.renderingEnabled=!0,e.screenAdaptationEnabled=!0,e._canvasTransform=new f,e._screenMode="none",e._scaleMode="noscale",e._alignV="top",e._alignH="left",e._bgColor="black",e._mouseMoveTime=0,e._renderCount=0,e._safariOffsetY=0,e._frameStartTime=0,e._previousOrientation=Ke.window.orientation,e._wgColor=[0,0,0,1],e._scene3Ds=[],e._globalRepaintSet=!1,e._globalRepaintGet=!1,e._3dUI=[],e._curUIBase=null,e.useRetinalCanvas=!1,_get(_getPrototypeOf(Stage.prototype),"set_transform",_assertThisInitialized(e)).call(_assertThisInitialized(e),e._createTransform()),e.mouseEnabled=!0,e.hitTestPrior=!0,e.autoSize=!1,e._setBit(ft.DISPLAYED_INSTAGE,!0),e._setBit(ft.ACTIVE_INHIERARCHY,!0),e._isFocused=!0,e._isVisibility=!0,e.useRetinalCanvas=t.useRetinalCanvas;var i=Ke.window;i.addEventListener("focus",(function(){e._isFocused=!0,e.event(We.FOCUS),e.event(We.FOCUS_CHANGE)})),i.addEventListener("blur",(function(){e._isFocused=!1,e.event(We.BLUR),e.event(We.FOCUS_CHANGE),e._isInputting()&&(Et.inputElement.target.focus=!1)}));var n="visibilityState",r="visibilitychange",a=i.document;return void 0!==a.hidden?(r="visibilitychange",n="visibilityState"):void 0!==a.mozHidden?(r="mozvisibilitychange",n="mozVisibilityState"):void 0!==a.msHidden?(r="msvisibilitychange",n="msVisibilityState"):void 0!==a.webkitHidden&&(r="webkitvisibilitychange",n="webkitVisibilityState"),i.document.addEventListener(r,(function(){"hidden"==Ke.document[n]?(e._isVisibility=!1,e._isInputting()&&(Et.inputElement.target.focus=!1)):e._isVisibility=!0,e.renderingEnabled=e._isVisibility,e.event(We.VISIBILITY_CHANGE)})),i.addEventListener("resize",(function(){var t=Ke.window.orientation;null!=t&&t!=e._previousOrientation&&e._isInputting()&&(Et.inputElement.target.focus=!1),e._previousOrientation=t,e._isInputting()||(Ke.onSafari&&(e._safariOffsetY=(Ke.window.__innerHeight||Ke.document.body.clientHeight||Ke.document.documentElement.clientHeight)-Ke.window.innerHeight),e._resetCanvas())})),i.addEventListener("orientationchange",(function(t){e._resetCanvas()})),e.on(We.MOUSE_MOVE,_assertThisInitialized(e),e._onmouseMove),Ke.onMobile&&e.on(We.MOUSE_DOWN,_assertThisInitialized(e),e._onmouseMove),e}return _inherits(Stage,e),_createClass(Stage,[{key:"_isInputting",value:function(){return Ke.onMobile&&Et.isInputting}},{key:"_changeCanvasSize",value:function(){this.setScreenSize(Ke.clientWidth*Ke.pixelRatio,Ke.clientHeight*Ke.pixelRatio)}},{key:"_resetCanvas",value:function(){this.screenAdaptationEnabled&&this._changeCanvasSize()}},{key:"setScreenSize",value:function(e,t){var i=!1;if(this._screenMode!==Stage.SCREEN_NONE&&(i=(e/t<1?Stage.SCREEN_VERTICAL:Stage.SCREEN_HORIZONTAL)!==this._screenMode)){var n=t;t=e,e=n}this.canvasRotation=i;var r=it._mainCanvas,a=r.source.style,s=this._canvasTransform.identity(),o=this._scaleMode,l=e/this.designWidth,h=t/this.designHeight,u=this.useRetinalCanvas?e:this.designWidth,c=this.useRetinalCanvas?t:this.designHeight,_=e,d=t,f=Ke.pixelRatio;switch(this._width=this.designWidth,this._height=this.designHeight,o){case Stage.SCALE_NOSCALE:l=h=1,_=this.designWidth,d=this.designHeight;break;case Stage.SCALE_SHOWALL:l=h=Math.min(l,h),u=_=Math.round(this.designWidth*l),c=d=Math.round(this.designHeight*h);break;case Stage.SCALE_NOBORDER:l=h=Math.max(l,h),_=Math.round(this.designWidth*l),d=Math.round(this.designHeight*h);break;case Stage.SCALE_FULL:l=h=1,this._width=u=e,this._height=c=t;break;case Stage.SCALE_FIXED_WIDTH:h=l,this._height=c=Math.round(t/l);break;case Stage.SCALE_FIXED_HEIGHT:l=h,this._width=u=Math.round(e/h);break;case Stage.SCALE_FIXED_AUTO:e/t<this.designWidth/this.designHeight?(h=l,this._height=c=Math.round(t/l)):(l=h,this._width=u=Math.round(e/h))}this.useRetinalCanvas&&(_=u=e,d=c=t),l*=this.scaleX,h*=this.scaleY,1===l&&1===h?this.transform.identity():(this.transform.a=this._formatData(l/(_/u)),this.transform.d=this._formatData(h/(d/c))),r.size(u,c),It.changeWebGLSize(u,c),s.scale(_/u/f,d/c/f),this._alignH===Stage.ALIGN_LEFT?this.offset.x=0:this._alignH===Stage.ALIGN_RIGHT?this.offset.x=e-_:this.offset.x=.5*(e-_)/f,this._alignV===Stage.ALIGN_TOP?this.offset.y=0:this._alignV===Stage.ALIGN_BOTTOM?this.offset.y=t-d:this.offset.y=.5*(t-d)/f,this.offset.x=Math.round(this.offset.x),this.offset.y=Math.round(this.offset.y),s.translate(this.offset.x,this.offset.y),this._safariOffsetY&&s.translate(0,this._safariOffsetY),this.canvasDegree=0,i&&(this._screenMode===Stage.SCREEN_HORIZONTAL?(s.rotate(Math.PI/2),s.translate(t/f,0),this.canvasDegree=90):(s.rotate(-Math.PI/2),s.translate(0,e/f),this.canvasDegree=-90)),s.a=this._formatData(s.a),s.d=this._formatData(s.d),s.tx=this._formatData(s.tx),s.ty=this._formatData(s.ty),_get(_getPrototypeOf(Stage.prototype),"set_transform",this).call(this,this.transform),a.transformOrigin=a.webkitTransformOrigin=a.msTransformOrigin=a.mozTransformOrigin=a.oTransformOrigin="0px 0px 0px",a.transform=a.webkitTransform=a.msTransform=a.mozTransform=a.oTransform="matrix("+s.toString()+")",a.width=u,a.height=c,this._safariOffsetY&&s.translate(0,-this._safariOffsetY),s.translate(parseInt(a.left)||0,parseInt(a.top)||0),this.visible=!0,this._repaint|=ot.REPAINT_CACHE,this.event(We.RESIZE)}},{key:"_formatData",value:function(e){return Math.abs(e)<1e-6?0:Math.abs(1-e)<.001?e>0?1:-1:e}},{key:"getMousePoint",value:function(){return v.TEMP.setTo(this.mouseX,this.mouseY)}},{key:"repaint",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ot.REPAINT_CACHE;this._repaint|=e}},{key:"parentRepaint",value:function(){arguments.length>0&&void 0!==arguments[0]?arguments[0]:ot.REPAINT_CACHE}},{key:"_loop",value:function(){return this._globalRepaintGet=this._globalRepaintSet,this._globalRepaintSet=!1,this.render(it._context,0,0),!0}},{key:"getFrameTm",value:function(){return this._frameStartTime}},{key:"_onmouseMove",value:function(e){this._mouseMoveTime=Ke.now()}},{key:"getTimeFromFrameStart",value:function(){return Ke.now()-this._frameStartTime}},{key:"render",value:function(e,t,i){if(window.conch)this.renderToNative(e,t,i);else{if(this._frameRate===Stage.FRAME_SLEEP){var n=Ke.now();if(!(n-this._frameStartTime>=1e3))return;this._frameStartTime=n}else{if(!this._visible)return this._renderCount++,void(this._renderCount%5==0&&(wt.I._update(),N.loopCount++,ye.loopCount=N.loopCount,this._updateTimers()));this._frameStartTime=Ke.now(),ye.loopStTm=this._frameStartTime}this._renderCount++;var r=(this._frameRate===Stage.FRAME_MOUSE?this._frameStartTime-this._mouseMoveTime<2e3?Stage.FRAME_FAST:Stage.FRAME_SLOW:this._frameRate)!==Stage.FRAME_SLOW,a=this._renderCount%2==0;if(N.renderSlow=!r,r||a){if(wt.I._update(),N.loopCount++,ye.loopCount=N.loopCount,this.renderingEnabled){for(var s=0,o=this._scene3Ds.length;s<o;s++)this._scene3Ds[s]._update();e.clear(),_get(_getPrototypeOf(Stage.prototype),"render",this).call(this,e,t,i),N._StatRender.renderNotCanvas(e,t,i)}this.renderingEnabled&&(Stage.clear(this._bgColor),e.flush(),_t.instance&&_t.getInstance().endDispose()),this._updateTimers()}}}},{key:"renderToNative",value:function(e,t,i){if(this._renderCount++,this._visible){if(wt.I._update(),N.loopCount++,ye.loopCount=N.loopCount,this.renderingEnabled){for(var n=0,r=this._scene3Ds.length;n<r;n++)this._scene3Ds[n]._update();e.clear(),_get(_getPrototypeOf(Stage.prototype),"render",this).call(this,e,t,i),N._StatRender.renderNotCanvas(e,t,i)}this.renderingEnabled&&(Stage.clear(this._bgColor),e.flush(),_t.instance&&_t.getInstance().endDispose()),this._updateTimers()}else this._renderCount%5==0&&(wt.I._update(),N.loopCount++,ye.loopCount=N.loopCount,this._updateTimers())}},{key:"_updateTimers",value:function(){i.systemTimer._update(),i.startTimer._update(),i.physicsTimer._update(),i.updateTimer._update(),i.lateTimer._update(),i.timer._update()}},{key:"_requestFullscreen",value:function(){var e=Ke.document.documentElement;e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}},{key:"_fullScreenChanged",value:function(){i.stage.event(We.FULL_SCREEN_CHANGE)}},{key:"exitFullscreen",value:function(){var e=Ke.document;e.exitFullscreen?e.exitFullscreen():e.mozCancelFullScreen?e.mozCancelFullScreen():e.webkitExitFullscreen&&e.webkitExitFullscreen()}},{key:"isGlobalRepaint",value:function(){return this._globalRepaintGet}},{key:"setGlobalRepaint",value:function(){this._globalRepaintSet=!0}},{key:"add3DUI",value:function(e){var t=e.rootView;this._3dUI.indexOf(t)>=0||this._3dUI.push(t)}},{key:"remove3DUI",value:function(e){var t=e.rootView,i=this._3dUI.indexOf(t);return i>=0&&(this._3dUI.splice(i,1),!0)}},{key:"width",set:function(e){this.designWidth=e,_get(_getPrototypeOf(Stage.prototype),"set_width",this).call(this,e),i.systemTimer.callLater(this,this._changeCanvasSize)},get:function(){return _get(_getPrototypeOf(Stage.prototype),"get_width",this).call(this)}},{key:"height",set:function(e){this.designHeight=e,_get(_getPrototypeOf(Stage.prototype),"set_height",this).call(this,e),i.systemTimer.callLater(this,this._changeCanvasSize)},get:function(){return _get(_getPrototypeOf(Stage.prototype),"get_height",this).call(this)}},{key:"transform",set:function(e){_get(_getPrototypeOf(Stage.prototype),"set_transform",this).call(this,e)},get:function(){return this._tfChanged&&this._adjustTransform(),this._transform=this._transform||this._createTransform()}},{key:"isFocused",get:function(){return this._isFocused}},{key:"isVisibility",get:function(){return this._isVisibility}},{key:"scaleMode",get:function(){return this._scaleMode},set:function(e){this._scaleMode=e,i.systemTimer.callLater(this,this._changeCanvasSize)}},{key:"alignH",get:function(){return this._alignH},set:function(e){this._alignH=e,i.systemTimer.callLater(this,this._changeCanvasSize)}},{key:"alignV",get:function(){return this._alignV},set:function(e){this._alignV=e,i.systemTimer.callLater(this,this._changeCanvasSize)}},{key:"bgColor",get:function(){return this._bgColor},set:function(e){this._bgColor=e,this._wgColor=e?Q.create(e).arrColor:null,it.canvas.style.background=e||"none"}},{key:"mouseX",get:function(){return Math.round(At.instance.mouseX/this.clientScaleX)}},{key:"mouseY",get:function(){return Math.round(At.instance.mouseY/this.clientScaleY)}},{key:"clientScaleX",get:function(){return this._transform?this._transform.getScaleX():1}},{key:"clientScaleY",get:function(){return this._transform?this._transform.getScaleY():1}},{key:"screenMode",get:function(){return this._screenMode},set:function(e){this._screenMode=e}},{key:"visible",set:function(e){this.visible!==e&&(_get(_getPrototypeOf(Stage.prototype),"set_visible",this).call(this,e),it._mainCanvas.source.style.visibility=e?"visible":"hidden")},get:function(){return _get(_getPrototypeOf(Stage.prototype),"visible",this)}},{key:"fullScreenEnabled",set:function(e){var t=Ke.document,i=it.canvas;e?(i.addEventListener("mousedown",this._requestFullscreen),i.addEventListener("touchstart",this._requestFullscreen),t.addEventListener("fullscreenchange",this._fullScreenChanged),t.addEventListener("mozfullscreenchange",this._fullScreenChanged),t.addEventListener("webkitfullscreenchange",this._fullScreenChanged),t.addEventListener("msfullscreenchange",this._fullScreenChanged)):(i.removeEventListener("mousedown",this._requestFullscreen),i.removeEventListener("touchstart",this._requestFullscreen),t.removeEventListener("fullscreenchange",this._fullScreenChanged),t.removeEventListener("mozfullscreenchange",this._fullScreenChanged),t.removeEventListener("webkitfullscreenchange",this._fullScreenChanged),t.removeEventListener("msfullscreenchange",this._fullScreenChanged))}},{key:"frameRate",get:function(){return i.Render.isConchApp?this._frameRateNative:this._frameRate},set:function(e){if(i.Render.isConchApp){var t=window.conch;switch(e){case Stage.FRAME_FAST:t.config.setLimitFPS(60);break;case Stage.FRAME_MOUSE:t.config.setMouseFrame(2e3);break;case Stage.FRAME_SLOW:t.config.setSlowFrame(!0);break;case Stage.FRAME_SLEEP:t.config.setLimitFPS(1)}this._frameRateNative=e}else this._frameRate=e}}]),Stage}(St);Pt.SCALE_NOSCALE="noscale",Pt.SCALE_EXACTFIT="exactfit",Pt.SCALE_SHOWALL="showall",Pt.SCALE_NOBORDER="noborder",Pt.SCALE_FULL="full",Pt.SCALE_FIXED_WIDTH="fixedwidth",Pt.SCALE_FIXED_HEIGHT="fixedheight",Pt.SCALE_FIXED_AUTO="fixedauto",Pt.ALIGN_LEFT="left",Pt.ALIGN_RIGHT="right",Pt.ALIGN_CENTER="center",Pt.ALIGN_TOP="top",Pt.ALIGN_MIDDLE="middle",Pt.ALIGN_BOTTOM="bottom",Pt.SCREEN_NONE="none",Pt.SCREEN_HORIZONTAL="horizontal",Pt.SCREEN_VERTICAL="vertical",Pt.FRAME_FAST="fast",Pt.FRAME_SLOW="slow",Pt.FRAME_MOUSE="mouse",Pt.FRAME_SLEEP="sleep",Pt.clear=function(e){Ze.set2DRenderConfig();var n=g.instance;D.worldScissorTest&&n.disable(n.SCISSOR_TEST);var r=it.context,a=0==r._submits._length||t.preserveDrawingBuffer?Q.create(e).arrColor:i.stage._wgColor;a?r.clearBG(a[0],a[1],a[2],a[3]):r.clearBG(0,0,0,0),D.clear()},mt.regClass("laya.display.Stage",Pt),mt.regClass("Laya.Stage",Pt);var Dt=function(){function KeyBoardManager(){_classCallCheck(this,KeyBoardManager)}return _createClass(KeyBoardManager,null,[{key:"__init__",value:function(){KeyBoardManager._addEvent("keydown"),KeyBoardManager._addEvent("keypress"),KeyBoardManager._addEvent("keyup")}},{key:"_addEvent",value:function(e){i.Browser.document.addEventListener(e,(function(t){KeyBoardManager._dispatch(t,e)}),!0)}},{key:"_dispatch",value:function(e,t){if(KeyBoardManager.enabled){KeyBoardManager._event._stoped=!1,KeyBoardManager._event.nativeEvent=e,KeyBoardManager._event.keyCode=e.keyCode||e.which||e.charCode,"keydown"===t?KeyBoardManager._pressKeys[KeyBoardManager._event.keyCode]=!0:"keyup"===t&&(KeyBoardManager._pressKeys[KeyBoardManager._event.keyCode]=null);for(var n=i.stage.focus&&null!=i.stage.focus.event&&i.stage.focus.displayedInStage?i.stage.focus:i.stage,r=n;r;)r.event(t,KeyBoardManager._event.setTo(t,r,n)),r=r.parent}}},{key:"hasKeyDown",value:function(e){return KeyBoardManager._pressKeys[e]}}]),KeyBoardManager}();Dt._pressKeys={},Dt.enabled=!0,Dt._event=new We;var Bt=function(e){function SoundChannel(){var e;return _classCallCheck(this,SoundChannel),(e=_possibleConstructorReturn(this,_getPrototypeOf(SoundChannel).apply(this,arguments))).isStopped=!1,e}return _inherits(SoundChannel,e),_createClass(SoundChannel,[{key:"play",value:function(){}},{key:"stop",value:function(){this.completeHandler&&this.completeHandler.runWith(!1)}},{key:"pause",value:function(){}},{key:"resume",value:function(){}},{key:"__runComplete",value:function(e){e&&e.runWith(!0)}},{key:"volume",set:function(e){},get:function(){return 1}},{key:"position",get:function(){return 0}},{key:"duration",get:function(){return 0}}]),SoundChannel}(T),Ot=function(e){function AudioSoundChannel(e){var t;return _classCallCheck(this,AudioSoundChannel),(t=_possibleConstructorReturn(this,_getPrototypeOf(AudioSoundChannel).call(this)))._audio=null,t._onEnd=t.__onEnd.bind(_assertThisInitialized(t)),t._resumePlay=t.__resumePlay.bind(_assertThisInitialized(t)),e.addEventListener("ended",t._onEnd),t._audio=e,t}return _inherits(AudioSoundChannel,e),_createClass(AudioSoundChannel,[{key:"__onEnd",value:function(e){if(1==this.loops)return this.completeHandler&&(i.systemTimer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(We.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}},{key:"__resumePlay",value:function(){if(this._audio&&this._audio.removeEventListener("canplay",this._resumePlay),!this.isStopped)try{this._audio.currentTime=this.startTime,Ke.container.appendChild(this._audio),this._audio.play()}catch(e){this.event(We.ERROR)}}},{key:"play",value:function(){this.isStopped=!1;try{this._audio.playbackRate=i.SoundManager.playbackRate,this._audio.currentTime=this.startTime}catch(e){return void this._audio.addEventListener("canplay",this._resumePlay)}i.SoundManager.addChannel(this),Ke.container.appendChild(this._audio),"play"in this._audio&&this._audio.play()}},{key:"stop",value:function(){_get(_getPrototypeOf(AudioSoundChannel.prototype),"stop",this).call(this),this.isStopped=!0,i.SoundManager.removeChannel(this),this.completeHandler=null,this._audio&&("pause"in this._audio&&i.Render.isConchApp&&this._audio.stop(),this._audio.pause(),this._audio.removeEventListener("ended",this._onEnd),this._audio.removeEventListener("canplay",this._resumePlay),i.Browser.onIE||this._audio!=i.AudioSound._musicAudio&&i.Pool.recover("audio:"+this.url,this._audio),Ke.removeElement(this._audio),this._audio=null,i.SoundManager.autoReleaseSound&&i.SoundManager.disposeSoundLater(this.url))}},{key:"pause",value:function(){this.isStopped=!0,i.SoundManager.removeChannel(this),"pause"in this._audio&&this._audio.pause(),i.SoundManager.autoReleaseSound&&i.SoundManager.disposeSoundLater(this.url)}},{key:"resume",value:function(){var e=this._audio;e&&(this.isStopped=!1,0==e.readyState&&(e.src=this.url,e.addEventListener("canplay",this._resumePlay),e.load()),i.SoundManager.addChannel(this),"play"in e&&e.play())}},{key:"position",get:function(){return this._audio?this._audio.currentTime:0}},{key:"duration",get:function(){return this._audio?this._audio.duration:0}},{key:"volume",set:function(e){this._audio&&(this._audio.volume=e)},get:function(){return this._audio?this._audio.volume:1}}]),AudioSoundChannel}(Bt),Ft=function(e){function AudioSound(){var e;return _classCallCheck(this,AudioSound),(e=_possibleConstructorReturn(this,_getPrototypeOf(AudioSound).apply(this,arguments))).loaded=!1,e}return _inherits(AudioSound,e),_createClass(AudioSound,[{key:"dispose",value:function(){var e=AudioSound._audioCache[this.url];n.clearBySign("audio:"+this.url),e&&(it.isConchApp||(e.src=""),delete AudioSound._audioCache[this.url])}},{key:"load",value:function(e){var t;if(e=x.formatURL(e),this.url=e,e==i.SoundManager._bgMusic?(AudioSound._initMusicAudio(),(t=AudioSound._musicAudio).src!=e&&(AudioSound._audioCache[t.src]=null,t=null)):t=AudioSound._audioCache[e],t&&t.readyState>=2)this.event(We.COMPLETE);else{t||(e==i.SoundManager._bgMusic?(AudioSound._initMusicAudio(),t=AudioSound._musicAudio):t=Ke.createElement("audio"),AudioSound._audioCache[e]=t,t.src=e),t.addEventListener("canplaythrough",onLoaded),t.addEventListener("error",onErr);var n=this;this.audio=t,t.load?t.load():onErr()}function onLoaded(){offs(),n.loaded=!0,n.event(We.COMPLETE)}function onErr(){t.load=null,offs(),n.event(We.ERROR)}function offs(){t.removeEventListener("canplaythrough",onLoaded),t.removeEventListener("error",onErr)}}},{key:"play",value:function(){var e,t,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.url)return null;if(!(e=this.url==i.SoundManager._bgMusic?AudioSound._musicAudio:AudioSound._audioCache[this.url]))return null;t=n.getItem("audio:"+this.url),it.isConchApp?t||((t=Ke.createElement("audio")).src=this.url):this.url==i.SoundManager._bgMusic?(AudioSound._initMusicAudio(),(t=AudioSound._musicAudio).src=this.url):t=t||e.cloneNode(!0);var s=new Ot(t);return s.url=this.url,s.loops=a,s.startTime=r,s.play(),i.SoundManager.addChannel(s),s}},{key:"duration",get:function(){var e;return(e=AudioSound._audioCache[this.url])?e.duration:0}}],[{key:"_initMusicAudio",value:function(){AudioSound._musicAudio||(AudioSound._musicAudio||(AudioSound._musicAudio=Ke.createElement("audio")),it.isConchApp||Ke.document.addEventListener("mousedown",AudioSound._makeMusicOK))}},{key:"_makeMusicOK",value:function(){Ke.document.removeEventListener("mousedown",AudioSound._makeMusicOK),AudioSound._musicAudio.src?AudioSound._musicAudio.play():(AudioSound._musicAudio.src="",AudioSound._musicAudio.load())}}]),AudioSound}(T);Ft._audioCache={};var Gt=function(e){function WebAudioSoundChannel(){var e;return _classCallCheck(this,WebAudioSoundChannel),(e=_possibleConstructorReturn(this,_getPrototypeOf(WebAudioSoundChannel).call(this))).bufferSource=null,e._currentTime=0,e._volume=1,e._startTime=0,e._pauseTime=0,e.context=i.WebAudioSound.ctx,e._onPlayEnd=j.bind(e.__onPlayEnd,_assertThisInitialized(e)),e.context.createGain?e.gain=e.context.createGain():e.gain=e.context.createGainNode(),e}return _inherits(WebAudioSoundChannel,e),_createClass(WebAudioSoundChannel,[{key:"play",value:function(){if(i.SoundManager.addChannel(this),this.isStopped=!1,this._clearBufferSource(),this.audioBuffer){if(this.startTime>=this.duration)return stop();var e=this.context,t=this.gain,n=e.createBufferSource();this.bufferSource=n,n.buffer=this.audioBuffer,n.connect(t),t&&t.disconnect(),t.connect(e.destination),n.onended=this._onPlayEnd,this._startTime=Ke.now(),this.gain.gain.setTargetAtTime?this.gain.gain.setTargetAtTime(this._volume,this.context.currentTime,WebAudioSoundChannel.SetTargetDelay):this.gain.gain.value=this._volume,0==this.loops&&(n.loop=!0),n.playbackRate.setTargetAtTime?n.playbackRate.setTargetAtTime(i.SoundManager.playbackRate,this.context.currentTime,WebAudioSoundChannel.SetTargetDelay):n.playbackRate.value=i.SoundManager.playbackRate,n.start(0,this.startTime),this._currentTime=0}}},{key:"__onPlayEnd",value:function(){if(1==this.loops)return this.completeHandler&&(i.timer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(We.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}},{key:"_clearBufferSource",value:function(){if(this.bufferSource){var e=this.bufferSource;e.stop?e.stop(0):e.noteOff(0),e.disconnect(0),e.onended=null,WebAudioSoundChannel._tryCleanFailed||this._tryClearBuffer(e),this.bufferSource=null}}},{key:"_tryClearBuffer",value:function(e){try{e.buffer=null}catch(e){WebAudioSoundChannel._tryCleanFailed=!0}}},{key:"stop",value:function(){_get(_getPrototypeOf(WebAudioSoundChannel.prototype),"stop",this).call(this),this._clearBufferSource(),this.audioBuffer=null,this.gain&&this.gain.disconnect(),this.isStopped=!0,i.SoundManager.removeChannel(this),this.completeHandler=null,i.SoundManager.autoReleaseSound&&i.SoundManager.disposeSoundLater(this.url)}},{key:"pause",value:function(){this.isStopped||(this._pauseTime=this.position),this._clearBufferSource(),this.gain&&this.gain.disconnect(),this.isStopped=!0,i.SoundManager.removeChannel(this),i.SoundManager.autoReleaseSound&&i.SoundManager.disposeSoundLater(this.url)}},{key:"resume",value:function(){this.startTime=this._pauseTime,this.play()}},{key:"position",get:function(){return this.bufferSource?(Ke.now()-this._startTime)/1e3+this.startTime:0}},{key:"duration",get:function(){return this.audioBuffer?this.audioBuffer.duration:0}},{key:"volume",set:function(e){this._volume=e,this.isStopped||(this.gain.gain.setTargetAtTime?this.gain.gain.setTargetAtTime(e,this.context.currentTime,WebAudioSoundChannel.SetTargetDelay):this.gain.gain.value=e)},get:function(){return this._volume}}]),WebAudioSoundChannel}(Bt);Gt._tryCleanFailed=!1,Gt.SetTargetDelay=.001;var Ut=function(e){function WebAudioSound(){var e;return _classCallCheck(this,WebAudioSound),(e=_possibleConstructorReturn(this,_getPrototypeOf(WebAudioSound).apply(this,arguments))).loaded=!1,e._disposed=!1,e}return _inherits(WebAudioSound,e),_createClass(WebAudioSound,[{key:"load",value:function(e){var t=this;if(e=x.formatURL(e),this.url=e,this.audioBuffer=WebAudioSound._dataCache[e],this.audioBuffer)this._loaded(this.audioBuffer);else if(WebAudioSound.e.on("loaded:"+e,this,this._loaded),WebAudioSound.e.on("err:"+e,this,this._err),!WebAudioSound.__loadingSound[e]){WebAudioSound.__loadingSound[e]=!0;var i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onload=function(){t._disposed?t._removeLoadEvents():(t.data=i.response,WebAudioSound.buffs.push({buffer:t.data,url:t.url}),WebAudioSound.decode())},i.onerror=function(e){t._err()},i.send()}}},{key:"_err",value:function(){this._removeLoadEvents(),WebAudioSound.__loadingSound[this.url]=!1,this.event(We.ERROR)}},{key:"_loaded",value:function(e){this._removeLoadEvents(),this._disposed||(this.audioBuffer=e,WebAudioSound._dataCache[this.url]=this.audioBuffer,this.loaded=!0,this.event(We.COMPLETE))}},{key:"_removeLoadEvents",value:function(){WebAudioSound.e.off("loaded:"+this.url,this,this._loaded),WebAudioSound.e.off("err:"+this.url,this,this._err)}},{key:"__playAfterLoaded",value:function(){if(this.__toPlays){var e,t,i,n;for(t=(i=this.__toPlays).length,e=0;e<t;e++)(n=i[e])[2]&&!n[2].isStopped&&this.play(n[0],n[1],n[2]);this.__toPlays.length=0}}},{key:"play",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return n=n||new Gt,this.audioBuffer||this.url&&(this.__toPlays||(this.__toPlays=[]),this.__toPlays.push([e,t,n]),this.once(We.COMPLETE,this,this.__playAfterLoaded),this.load(this.url)),n.url=this.url,n.loops=t,n.audioBuffer=this.audioBuffer,n.startTime=e,n.play(),i.SoundManager.addChannel(n),n}},{key:"dispose",value:function(){this._disposed=!0,delete WebAudioSound._dataCache[this.url],delete WebAudioSound.__loadingSound[this.url],this.audioBuffer=null,this.data=null,this.__toPlays=[]}},{key:"duration",get:function(){return this.audioBuffer?this.audioBuffer.duration:0}}],[{key:"decode",value:function(){WebAudioSound.buffs.length<=0||WebAudioSound.isDecoding||(WebAudioSound.isDecoding=!0,WebAudioSound.tInfo=WebAudioSound.buffs.shift(),WebAudioSound.ctx.decodeAudioData(WebAudioSound.tInfo.buffer,WebAudioSound._done,WebAudioSound._fail))}},{key:"_done",value:function(e){WebAudioSound.e.event("loaded:"+WebAudioSound.tInfo.url,e),WebAudioSound.isDecoding=!1,WebAudioSound.decode()}},{key:"_fail",value:function(){WebAudioSound.e.event("err:"+WebAudioSound.tInfo.url,null),WebAudioSound.isDecoding=!1,WebAudioSound.decode()}},{key:"_playEmptySound",value:function(){if(null!=WebAudioSound.ctx){var e=WebAudioSound.ctx.createBufferSource();e.buffer=WebAudioSound._miniBuffer,e.connect(WebAudioSound.ctx.destination),e.start(0,0,0)}}},{key:"_unlock",value:function(){WebAudioSound._unlocked||(WebAudioSound._playEmptySound(),"running"==WebAudioSound.ctx.state&&(window.document.removeEventListener("mousedown",WebAudioSound._unlock,!0),window.document.removeEventListener("touchend",WebAudioSound._unlock,!0),window.document.removeEventListener("touchstart",WebAudioSound._unlock,!0),WebAudioSound._unlocked=!0))}},{key:"initWebAudio",value:function(){"running"!=WebAudioSound.ctx.state&&(WebAudioSound._unlock(),window.document.addEventListener("mousedown",WebAudioSound._unlock,!0),window.document.addEventListener("touchend",WebAudioSound._unlock,!0),window.document.addEventListener("touchstart",WebAudioSound._unlock,!0))}}]),WebAudioSound}(T);Ut._dataCache={},Ut.webAudioEnabled=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,Ut.ctx=Ut.webAudioEnabled?new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext):void 0,Ut.buffs=[],Ut.isDecoding=!1,Ut._miniBuffer=Ut.ctx?Ut.ctx.createBuffer(1,1,22050):void 0,Ut.e=new T,Ut._unlocked=!1,Ut.__loadingSound={};var Nt=function(){function SoundManager(){_classCallCheck(this,SoundManager)}return _createClass(SoundManager,null,[{key:"__init__",value:function(){var e=i.Browser.window,t=!!(e.AudioContext||e.webkitAudioContext||e.mozAudioContext);return t&&Ut.initWebAudio(),SoundManager._soundClass=t?Ut:Ft,Ft._initMusicAudio(),SoundManager._musicClass=Ft,t}},{key:"addChannel",value:function(e){SoundManager._channels.indexOf(e)>=0||SoundManager._channels.push(e)}},{key:"removeChannel",value:function(e){var t;for(t=SoundManager._channels.length-1;t>=0;t--)SoundManager._channels[t]==e&&SoundManager._channels.splice(t,1)}},{key:"disposeSoundLater",value:function(e){SoundManager._lastSoundUsedTimeDic[e]=i.Browser.now(),SoundManager._isCheckingDispose||(SoundManager._isCheckingDispose=!0,i.timer.loop(5e3,null,SoundManager._checkDisposeSound))}},{key:"_checkDisposeSound",value:function(){var e,t=i.Browser.now(),n=!1;for(e in SoundManager._lastSoundUsedTimeDic)t-SoundManager._lastSoundUsedTimeDic[e]>3e4?(delete SoundManager._lastSoundUsedTimeDic[e],SoundManager.disposeSoundIfNotUsed(e)):n=!0;n||(SoundManager._isCheckingDispose=!1,i.timer.clear(null,SoundManager._checkDisposeSound))}},{key:"disposeSoundIfNotUsed",value:function(e){var t;for(t=SoundManager._channels.length-1;t>=0;t--)if(SoundManager._channels[t].url==e)return;SoundManager.destroySound(e)}},{key:"_visibilityChange",value:function(){i.stage.isVisibility?SoundManager._stageOnFocus():SoundManager._stageOnBlur()}},{key:"_stageOnBlur",value:function(){SoundManager._isActive=!1,SoundManager._musicChannel&&(SoundManager._musicChannel.isStopped||(SoundManager._blurPaused=!0,SoundManager._musicChannel.pause())),SoundManager.stopAllSound(),i.stage.once(We.MOUSE_DOWN,null,SoundManager._stageOnFocus)}},{key:"_recoverWebAudio",value:function(){Ut.ctx&&"running"!=Ut.ctx.state&&Ut.ctx.resume&&Ut.ctx.resume()}},{key:"_stageOnFocus",value:function(){SoundManager._isActive=!0,SoundManager._recoverWebAudio(),i.stage.off(We.MOUSE_DOWN,null,SoundManager._stageOnFocus),SoundManager._blurPaused&&SoundManager._musicChannel&&SoundManager._musicChannel.isStopped&&(SoundManager._blurPaused=!1,SoundManager._musicChannel.resume())}},{key:"playSound",value:function(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;if(!SoundManager._isActive||!e)return null;if(SoundManager._muted)return null;if(SoundManager._recoverWebAudio(),(e=x.formatURL(e))==SoundManager._bgMusic){if(SoundManager._musicMuted)return null}else{if(i.Render.isConchApp){var l=j.getFileExtension(e);if("wav"!=l&&"ogg"!=l)return alert("The sound only supports wav or ogg format,for optimal performance reason,please refer to the official website document."),null}if(SoundManager._soundMuted)return null}return i.Browser.onBDMiniGame||i.Browser.onMiniGame||i.Browser.onKGMiniGame||i.Browser.onQGMiniGame||i.Browser.onVVMiniGame||i.Browser.onAlipayMiniGame||i.Browser.onQQMiniGame||i.Browser.onBLMiniGame||i.Browser.onTTMiniGame||i.Browser.onHWMiniGame||i.Browser.onTBMiniGame||(t=i.loader.getRes(e)),s||(s=SoundManager._soundClass),t||((t=new s).load(e),i.Browser.onBDMiniGame||i.Browser.onMiniGame||i.Browser.onKGMiniGame||i.Browser.onQGMiniGame||i.Browser.onVVMiniGame||i.Browser.onAlipayMiniGame||i.Browser.onQQMiniGame||i.Browser.onBLMiniGame||i.Browser.onTTMiniGame||i.Browser.onHWMiniGame||i.Browser.onTBMiniGame||i.Loader.cacheRes(e,t)),(n=t.play(o,r))?(n.url=e,n.volume=e==SoundManager._bgMusic?SoundManager.musicVolume:SoundManager.soundVolume,n.completeHandler=a,n):null}},{key:"destroySound",value:function(e){var t=i.loader.getRes(e);t&&(i.Loader.clearRes(e),t.dispose())}},{key:"playMusic",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return e=x.formatURL(e),SoundManager._bgMusic=e,SoundManager._musicChannel&&SoundManager._musicChannel.stop(),SoundManager._musicChannel=SoundManager.playSound(e,t,i,SoundManager._musicClass,n)}},{key:"stopSound",value:function(e){var t,i;for(e=x.formatURL(e),t=SoundManager._channels.length-1;t>=0;t--)(i=SoundManager._channels[t]).url==e&&i.stop()}},{key:"stopAll",value:function(){var e;for(SoundManager._bgMusic=null,e=SoundManager._channels.length-1;e>=0;e--)SoundManager._channels[e].stop()}},{key:"stopAllSound",value:function(){var e,t;for(e=SoundManager._channels.length-1;e>=0;e--)(t=SoundManager._channels[e]).url!=SoundManager._bgMusic&&t.stop()}},{key:"stopMusic",value:function(){SoundManager._musicChannel&&SoundManager._musicChannel.stop(),SoundManager._bgMusic=null}},{key:"setSoundVolume",value:function(e){var t,i,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(n)n=x.formatURL(n),SoundManager._setVolume(n,e);else for(SoundManager.soundVolume=e,t=SoundManager._channels.length-1;t>=0;t--)(i=SoundManager._channels[t]).url!=SoundManager._bgMusic&&(i.volume=e)}},{key:"setMusicVolume",value:function(e){SoundManager.musicVolume=e,SoundManager._setVolume(SoundManager._bgMusic,e)}},{key:"_setVolume",value:function(e,t){var i,n;for(e=x.formatURL(e),i=SoundManager._channels.length-1;i>=0;i--)(n=SoundManager._channels[i]).url==e&&(n.volume=t)}},{key:"autoStopMusic",set:function(e){i.stage.off(We.BLUR,null,SoundManager._stageOnBlur),i.stage.off(We.FOCUS,null,SoundManager._stageOnFocus),i.stage.off(We.VISIBILITY_CHANGE,null,SoundManager._visibilityChange),SoundManager._autoStopMusic=e,e&&(i.stage.on(We.BLUR,null,SoundManager._stageOnBlur),i.stage.on(We.FOCUS,null,SoundManager._stageOnFocus),i.stage.on(We.VISIBILITY_CHANGE,null,SoundManager._visibilityChange))},get:function(){return SoundManager._autoStopMusic}},{key:"muted",set:function(e){e!=SoundManager._muted&&(e&&SoundManager.stopAllSound(),SoundManager.musicMuted=e,SoundManager._muted=e)},get:function(){return SoundManager._muted}},{key:"soundMuted",set:function(e){SoundManager._soundMuted=e},get:function(){return SoundManager._soundMuted}},{key:"musicMuted",set:function(e){e!=SoundManager._musicMuted&&(e?(SoundManager._bgMusic&&SoundManager._musicChannel&&!SoundManager._musicChannel.isStopped?i.Render.isConchApp?SoundManager._musicChannel._audio&&(SoundManager._musicChannel._audio.muted=!0):SoundManager._musicChannel.pause():SoundManager._musicChannel=null,SoundManager._musicMuted=e):(SoundManager._musicMuted=e,SoundManager._bgMusic&&SoundManager._musicChannel&&(i.Render.isConchApp?SoundManager._musicChannel._audio&&(SoundManager._musicChannel._audio.muted=!1):SoundManager._musicChannel.resume())))},get:function(){return SoundManager._musicMuted}},{key:"useAudioMusic",get:function(){return SoundManager._useAudioMusic},set:function(e){SoundManager._useAudioMusic=e,SoundManager._musicClass=e?Ft:null}}]),SoundManager}();Nt.musicVolume=1,Nt.soundVolume=1,Nt.playbackRate=1,Nt._useAudioMusic=!0,Nt._muted=!1,Nt._soundMuted=!1,Nt._musicMuted=!1,Nt._bgMusic=null,Nt._musicChannel=null,Nt._channels=[],Nt._blurPaused=!1,Nt._isActive=!0,Nt._lastSoundUsedTimeDic={},Nt._isCheckingDispose=!1,Nt.autoReleaseSound=!0;var Wt=function(){function Prefab(){_classCallCheck(this,Prefab)}return _createClass(Prefab,[{key:"create",value:function(){return this.json?i.SceneUtils.createByData(null,this.json):null}}]),Prefab}(),Vt=function(){function BitmapFont(){_classCallCheck(this,BitmapFont),this._fontCharDic={},this._fontWidthMap={},this._maxWidth=0,this._spaceWidth=10,this.fontSize=12,this.autoScaleSize=!1,this.letterSpacing=0}return _createClass(BitmapFont,[{key:"loadFont",value:function(e,t){this._path=e,this._complete=t,e&&-1!==e.indexOf(".fnt")?i.loader.load([{url:e,type:i.Loader.XML},{url:e.replace(".fnt",".png"),type:i.Loader.IMAGE}],m.create(this,this._onLoaded)):console.error('Bitmap font configuration information must be a ".fnt" file')}},{key:"_onLoaded",value:function(){this.parseFont(i.Loader.getRes(this._path),i.Loader.getRes(this._path.replace(".fnt",".png"))),this._complete&&this._complete.run()}},{key:"parseFont",value:function(e,t){if(null!=e&&null!=t){this._texture=t;var i=e.getElementsByTagName("info");if(!i[0].getAttributeNode)return this.parseFont2(e,t);this.fontSize=parseInt(i[0].getAttributeNode("size").nodeValue);var n=i[0].getAttributeNode("padding").nodeValue.split(",");this._padding=[parseInt(n[0]),parseInt(n[1]),parseInt(n[2]),parseInt(n[3])];var r=e.getElementsByTagName("char"),a=0;for(a=0;a<r.length;a++){var s=r[a],o=parseInt(s.getAttributeNode("id").nodeValue),l=parseInt(s.getAttributeNode("xoffset").nodeValue)/1,h=parseInt(s.getAttributeNode("yoffset").nodeValue)/1,u=parseInt(s.getAttributeNode("xadvance").nodeValue)/1,c=new p;c.x=parseInt(s.getAttributeNode("x").nodeValue),c.y=parseInt(s.getAttributeNode("y").nodeValue),c.width=parseInt(s.getAttributeNode("width").nodeValue),c.height=parseInt(s.getAttributeNode("height").nodeValue);var _=Ve.create(t,c.x,c.y,c.width,c.height,l,h);this._maxWidth=Math.max(this._maxWidth,u+this.letterSpacing),this._fontCharDic[o]=_,this._fontWidthMap[o]=u}}}},{key:"parseFont2",value:function(e,t){if(null!=e&&null!=t){this._texture=t;var i=e.getElementsByTagName("info");this.fontSize=parseInt(i[0].attributes.size.nodeValue);var n=i[0].attributes.padding.nodeValue.split(",");this._padding=[parseInt(n[0]),parseInt(n[1]),parseInt(n[2]),parseInt(n[3])];var r=e.getElementsByTagName("char"),a=0;for(a=0;a<r.length;a++){var s=r[a].attributes,o=parseInt(s.id.nodeValue),l=parseInt(s.xoffset.nodeValue)/1,h=parseInt(s.yoffset.nodeValue)/1,u=parseInt(s.xadvance.nodeValue)/1,c=new p;c.x=parseInt(s.x.nodeValue),c.y=parseInt(s.y.nodeValue),c.width=parseInt(s.width.nodeValue),c.height=parseInt(s.height.nodeValue);var _=Ve.create(t,c.x,c.y,c.width,c.height,l,h);this._maxWidth=Math.max(this._maxWidth,u+this.letterSpacing),this._fontCharDic[o]=_,this._fontWidthMap[o]=u}}}},{key:"getCharTexture",value:function(e){return this._fontCharDic[e.charCodeAt(0)]}},{key:"destroy",value:function(){if(this._texture){for(var e in this._fontCharDic){var t=this._fontCharDic[e];t&&t.destroy()}this._texture.destroy(),this._fontCharDic=null,this._fontWidthMap=null,this._texture=null,this._complete=null,this._padding=null}}},{key:"setSpaceWidth",value:function(e){this._spaceWidth=e}},{key:"getCharWidth",value:function(e){var t=e.charCodeAt(0);return this._fontWidthMap[t]?this._fontWidthMap[t]+this.letterSpacing:" "===e?this._spaceWidth+this.letterSpacing:0}},{key:"getTextWidth",value:function(e){for(var t=0,i=0,n=e.length;i<n;i++)t+=this.getCharWidth(e.charAt(i));return t}},{key:"getMaxWidth",value:function(){return this._maxWidth}},{key:"getMaxHeight",value:function(){return this.fontSize}},{key:"_drawText",value:function(e,t,i,n,r,a){var s,o=this.getTextWidth(e),l=0;"center"===r&&(l=(a-o)/2),"right"===r&&(l=a-o);for(var h=0,u=0,c=e.length;u<c;u++)(s=this.getCharTexture(e.charAt(u)))&&(t.graphics.drawImage(s,i+h+l,n),h+=this.getCharWidth(e.charAt(u)))}}]),BitmapFont}();mt.regClass("laya.display.BitmapFont",Vt),mt.regClass("Laya.BitmapFont",Vt);var Ht=function(e){function HttpRequest(){var e;return _classCallCheck(this,HttpRequest),(e=_possibleConstructorReturn(this,_getPrototypeOf(HttpRequest).apply(this,arguments)))._http=new XMLHttpRequest,e}return _inherits(HttpRequest,e),_createClass(HttpRequest,[{key:"send",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"get",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"text",r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;this._responseType=n,this._data=null,(Ke.onVVMiniGame||Ke.onQGMiniGame||Ke.onQQMiniGame||Ke.onAlipayMiniGame||Ke.onBLMiniGame||Ke.onHWMiniGame||Ke.onTTMiniGame||Ke.onTBMiniGame)&&(e=HttpRequest._urlEncode(e)),this._url=e;var a=this,s=this._http;e=x.getAdptedFilePath(e),s.open(i,e,!0);var o=!1;if(r)for(var l=0;l<r.length;l++)s.setRequestHeader(r[l++],r[l]);else window.conch||(t&&"string"!=typeof t?(s.setRequestHeader("Content-Type","application/json"),o=!0):s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"));var h="arraybuffer"!==n?"text":"arraybuffer";s.responseType=h,s.dataType&&(s.dataType=h),s.onerror=function(e){a._onError(e)},s.onabort=function(e){a._onAbort(e)},s.onprogress=function(e){a._onProgress(e)},s.onload=function(e){a._onLoad(e)},Ke.onBLMiniGame&&Ke.onAndroid&&!t&&(t={}),s.send(o?JSON.stringify(t):t)}},{key:"_onProgress",value:function(e){e&&e.lengthComputable&&this.event(We.PROGRESS,e.loaded/e.total)}},{key:"_onAbort",value:function(e){this.error("Request was aborted by user")}},{key:"_onError",value:function(e){this.error("Request failed Status:"+this._http.status+" text:"+this._http.statusText)}},{key:"_onLoad",value:function(e){var t=this._http,i=void 0!==t.status?t.status:200;200===i||204===i||0===i?this.complete():this.error("["+t.status+"]"+t.statusText+":"+t.responseURL)}},{key:"error",value:function(e){this.clear(),console.warn(this.url,e),this.event(We.ERROR,e)}},{key:"complete",value:function(){this.clear();var e=!0;try{"json"===this._responseType?this._data=JSON.parse(this._http.responseText):"xml"===this._responseType?this._data=j.parseXMLFromString(this._http.responseText):this._data=this._http.response||this._http.responseText}catch(t){e=!1,this.error(t.message)}e&&this.event(We.COMPLETE,this._data instanceof Array?[this._data]:this._data)}},{key:"clear",value:function(){var e=this._http;e.onerror=e.onabort=e.onprogress=e.onload=null}},{key:"url",get:function(){return this._url}},{key:"data",get:function(){return this._data}},{key:"http",get:function(){return this._http}}]),HttpRequest}(T);Ht._urlEncode=encodeURI;var Yt=function(t){function Loader(){var e;return _classCallCheck(this,Loader),(e=_possibleConstructorReturn(this,_getPrototypeOf(Loader).apply(this,arguments)))._customParse=!1,e}return _inherits(Loader,t),_createClass(Loader,[{key:"load",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:i.WorkerLoader.enable;if(e){var o;if(Loader.setGroup(e,"666"),this._url=e,0===e.indexOf("data:image")?t=Loader.IMAGE:e=x.formatURL(e),this._type=t||(t=Loader.getTypeFromUrl(this._url)),this._cache=n,this._useWorkerLoader=s,this._data=null,s&&i.WorkerLoader.enableWorkerLoader(),o=t==Loader.IMAGE?Loader.textureMap[e]:Loader.loadedMap[e],!a&&o)return this._data=o,this.event(We.PROGRESS,1),void this.event(We.COMPLETE,this._data);if(r&&Loader.setGroup(e,r),null!=Loader.parserMap[t])return this._customParse=!0,void(Loader.parserMap[t]instanceof m?Loader.parserMap[t].runWith(this):Loader.parserMap[t].call(null,this));this._loadResourceFilter(t,e)}else this.onLoaded(null)}},{key:"_loadResourceFilter",value:function(e,t){this._loadResource(e,t)}},{key:"_loadResource",value:function(e,t){switch(e){case Loader.IMAGE:case"htmlimage":case"nativeimage":this._loadImage(t);break;case Loader.SOUND:this._loadSound(t);break;case Loader.TTF:this._loadTTF(t);break;case Loader.ATLAS:case Loader.PREFAB:case Loader.PLF:this._loadHttpRequestWhat(t,Loader.JSON);break;case Loader.FONT:this._loadHttpRequestWhat(t,Loader.XML);break;case Loader.PLFB:this._loadHttpRequestWhat(t,Loader.BUFFER);break;default:this._loadHttpRequestWhat(t,e)}}},{key:"_loadHttpRequest",value:function(e,t,i,n,r,a,s,o){Ke.onVVMiniGame||Ke.onHWMiniGame?this._http=new Ht:this._http||(this._http=new Ht),a&&this._http.on(We.PROGRESS,r,a),n&&this._http.on(We.COMPLETE,i,n),this._http.on(We.ERROR,s,o),this._http.send(e,null,"get",t)}},{key:"_loadHtmlImage",value:function(e,t,i,n,r){var a;function clear(){var t=a;t.onload=null,t.onerror=null,delete Loader._imgCache[e]}(a=new Ke.window.Image).crossOrigin="",a.onload=function(){clear(),i.call(t,a)},a.onerror=function(){clear(),r.call(n)},a.src=e,Loader._imgCache[e]=a}},{key:"_loadHttpRequestWhat",value:function(e,t){Loader.preLoadedMap[e]?this.onLoaded(Loader.preLoadedMap[e]):this._loadHttpRequest(e,t,this,this.onLoaded,this,this.onProgress,this,this.onError)}},{key:"_loadTTF",value:function(e){e=x.formatURL(e);var t=new i.TTFLoader;t.complete=m.create(this,this.onLoaded),t.load(e)}},{key:"_loadImage",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this;t&&(e=x.formatURL(e));var onError=function(){i.event(We.ERROR,"Load image failed")};if("nativeimage"===this._type)this._loadHtmlImage(e,this,this.onLoaded,this,onError);else{var n=j.getFileExtension(e);"ktx"===n||"pvr"===n?this._loadHttpRequest(e,Loader.BUFFER,this,this.onLoaded,this,this.onProgress,this,this.onError):this._loadHtmlImage(e,this,this.onLoaded,this,onError)}}},{key:"_loadSound",value:function(e){var t=new Nt._soundClass,i=this;function clear(){t.offAll()}t.on(We.COMPLETE,this,(function(){clear(),i.onLoaded(t)})),t.on(We.ERROR,this,(function(){clear(),t.dispose(),i.event(We.ERROR,"Load sound failed")})),t.load(e)}},{key:"onProgress",value:function(e){this._type===Loader.ATLAS?this.event(We.PROGRESS,.3*e):this._originType==Loader.HIERARCHY?this.event(We.PROGRESS,e/3):this.event(We.PROGRESS,e)}},{key:"onError",value:function(e){this.event(We.ERROR,e)}},{key:"onLoaded",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=this._type;if(i==Loader.PLFB)this.parsePLFBData(t),this.complete(t);else if(i==Loader.PLF)this.parsePLFData(t),this.complete(t);else if(i===Loader.IMAGE){var n;if(t instanceof ArrayBuffer){var r;switch(f=j.getFileExtension(this._url)){case"ktx":r=e.TextureFormat.ETC1RGB;break;case"pvr":r=e.TextureFormat.PVRTCRGBA_4BPPV;break;default:return void console.error("unknown format",f)}(n=new w(0,0,r,!1,!1)).wrapModeU=e.WarpMode.Clamp,n.wrapModeV=e.WarpMode.Clamp,n.setCompressData(t),n._setCreateURL(this.url)}else t instanceof w?n=t:((n=new w(t.width,t.height,1,!1,!1)).wrapModeU=e.WarpMode.Clamp,n.wrapModeV=e.WarpMode.Clamp,n.loadImageSource(t,!0),n._setCreateURL(t.src));var a=new Ve(n);a.url=this._url,this.complete(a)}else if(i===Loader.SOUND||"nativeimage"===i)this.complete(t);else if("htmlimage"===i){var s=new w(t.width,t.height,1,!1,!1);s.wrapModeU=e.WarpMode.Clamp,s.wrapModeV=e.WarpMode.Clamp,s.loadImageSource(t,!0),s._setCreateURL(t.src),this.complete(s)}else if(i===Loader.ATLAS){if(t.frames){var o=[];if(!this._data){if(this._data=t,t.meta&&t.meta.image){o=t.meta.image.split(",");var l=this._url.indexOf("/")>=0?"/":"\\",h=this._url.lastIndexOf(l),u=h>=0?this._url.substr(0,h+1):"",c=null;Ke.onAndroid&&t.meta.compressTextureAndroid&&(c=".ktx"),Ke.onIOS&&t.meta.compressTextureIOS&&(c=".pvr");for(var _=0,d=o.length;_<d;_++)o[_]=c?u+o[_].replace(".png",c):u+o[_]}else o=[this._url.replace(".json",".png")];o.reverse(),t.toLoads=o,t.pics=[]}return this.event(We.PROGRESS,.3+1/o.length*.6),this._loadResourceFilter(Loader.IMAGE,x.formatURL(o.pop()))}if(!(t instanceof w))if(t instanceof ArrayBuffer){var f,v,p=this._http.url;switch(f=j.getFileExtension(p)){case"ktx":v=e.TextureFormat.ETC1RGB;break;case"pvr":v=e.TextureFormat.PVRTCRGBA_4BPPV;break;default:return void console.error("unknown format",f)}var g=new w(0,0,v,!1,!1);g.wrapModeU=e.WarpMode.Clamp,g.wrapModeV=e.WarpMode.Clamp,g.setCompressData(t),g._setCreateURL(p),t=g}else{var y=new w(t.width,t.height,1,!1,!1);y.wrapModeU=M.WARPMODE_CLAMP,y.wrapModeV=M.WARPMODE_CLAMP,y.loadImageSource(t,!0),y._setCreateURL(t.src),t=y}if(this._data.pics.push(t),this._data.toLoads.length>0)return this.event(We.PROGRESS,.3+1/this._data.toLoads.length*.6),this._loadResourceFilter(Loader.IMAGE,this._data.toLoads.pop());var m=this._data.frames,T=this._url.split("?")[0],C=this._data.meta&&this._data.meta.prefix?this._data.meta.prefix:T.substring(0,T.lastIndexOf("."))+"/",k=this._data.pics,S=x.formatURL(this._url),R=Loader.atlasMap[S]||(Loader.atlasMap[S]=[]);R.dir=C;var b=1;if(this._data.meta&&this._data.meta.scale&&1!=this._data.meta.scale)for(var E in b=parseFloat(this._data.meta.scale),m){var A,L=m[E],I=k[L.frame.idx?L.frame.idx:0],P=x.formatURL(C+E);I.scaleRate=b,A=Ve._create(I,L.frame.x,L.frame.y,L.frame.w,L.frame.h,L.spriteSourceSize.x,L.spriteSourceSize.y,L.sourceSize.w,L.sourceSize.h,Loader.getRes(P)),Loader.cacheTexture(P,A),A.url=P,R.push(P)}else for(E in m)I=k[(L=m[E]).frame.idx?L.frame.idx:0],P=x.formatURL(C+E),A=Ve._create(I,L.frame.x,L.frame.y,L.frame.w,L.frame.h,L.spriteSourceSize.x,L.spriteSourceSize.y,L.sourceSize.w,L.sourceSize.h,Loader.getRes(P)),Loader.cacheTexture(P,A),A.url=P,R.push(P);delete this._data.pics,this.complete(this._data)}else if(i===Loader.FONT){if(!t._source)return this._data=t,this.event(We.PROGRESS,.5),this._loadResourceFilter(Loader.IMAGE,this._url.replace(".fnt",".png"));var D=new Vt;D.parseFont(this._data,new Ve(t));var B=this._url.split(".fnt")[0].split("/"),O=B[B.length-1];bt.registerBitmapFont(O,D),this._data=D,this.complete(this._data)}else if(i===Loader.PREFAB){var F=new Wt;F.json=t,this.complete(F)}else this.complete(t)}},{key:"parsePLFData",value:function(e){var t,i,n;for(t in e)switch(n=e[t],t){case"json":case"text":for(i in n)Loader.preLoadedMap[x.formatURL(i)]=n[i];break;default:for(i in n)Loader.preLoadedMap[x.formatURL(i)]=n[i]}}},{key:"parsePLFBData",value:function(e){var t,i,n;for(n=(t=new A(e)).getInt32(),i=0;i<n;i++)this.parseOnePLFBFile(t)}},{key:"parseOnePLFBFile",value:function(e){var t,i,n;i=e.getUTFString(),t=e.getInt32(),n=e.readArrayBuffer(t),Loader.preLoadedMap[x.formatURL(i)]=n}},{key:"complete",value:function(e){this._data=e,this._customParse?this.event(We.LOADED,e instanceof Array?[e]:e):(Loader._loaders.push(this),Loader._isWorking||Loader.checkNext())}},{key:"endLoad",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e&&(this._data=e),this._cache&&Loader.cacheRes(this._url,this._data),this.event(We.PROGRESS,1),this.event(We.COMPLETE,this.data instanceof Array?[this.data]:this.data)}},{key:"url",get:function(){return this._url}},{key:"type",get:function(){return this._type}},{key:"cache",get:function(){return this._cache}},{key:"data",get:function(){return this._data}}],[{key:"getTypeFromUrl",value:function(e){var t=j.getFileExtension(e);return t?Loader.typeMap[t]:(console.warn("Not recognize the resources suffix",e),"text")}},{key:"checkNext",value:function(){Loader._isWorking=!0;for(var e=Ke.now();Loader._startIndex<Loader._loaders.length;)if(Loader._loaders[Loader._startIndex].endLoad(),Loader._startIndex++,Ke.now()-e>Loader.maxTimeOut)return console.warn("loader callback cost a long time:"+(Ke.now()-e)+" url="+Loader._loaders[Loader._startIndex-1].url),void i.systemTimer.frameOnce(1,null,Loader.checkNext);Loader._loaders.length=0,Loader._startIndex=0,Loader._isWorking=!1}},{key:"clearRes",value:function(e){e=x.formatURL(e);var t=Loader.getAtlas(e);if(t){for(var i=0,n=t.length;i<n;i++){var r=t[i],a=Loader.getRes(r);delete Loader.textureMap[r],a&&a.destroy()}t.length=0,delete Loader.atlasMap[e]}var s=Loader.textureMap[e];s&&(s.destroy(),delete Loader.textureMap[e]),Loader.loadedMap[e]&&delete Loader.loadedMap[e]}},{key:"clearTextureRes",value:function(e){e=x.formatURL(e);var t=Loader.getAtlas(e);if(t&&t.length>0)t.forEach((function(e){var t=Loader.getRes(e);t instanceof Ve&&t.disposeBitmap()}));else{var i=Loader.getRes(e);i instanceof Ve&&i.disposeBitmap()}}},{key:"getRes",value:function(e){var t=Loader.textureMap[x.formatURL(e)];return t||Loader.loadedMap[x.formatURL(e)]}},{key:"getAtlas",value:function(e){return Loader.atlasMap[x.formatURL(e)]}},{key:"cacheRes",value:function(e,t){e=x.formatURL(e),null!=Loader.loadedMap[e]?console.warn("Resources already exist,is repeated loading:",e):t instanceof Ve?(Loader.loadedMap[e]=t.bitmap,Loader.textureMap[e]=t):Loader.loadedMap[e]=t}},{key:"cacheTexture",value:function(e,t){e=x.formatURL(e),null!=Loader.textureMap[e]?console.warn("Resources already exist,is repeated loading:",e):Loader.textureMap[e]=t}},{key:"setGroup",value:function(e,t){Loader.groupMap[t]||(Loader.groupMap[t]=[]),Loader.groupMap[t].push(e)}},{key:"clearResByGroup",value:function(e){if(Loader.groupMap[e]){var t,i=Loader.groupMap[e],n=i.length;for(t=0;t<n;t++)Loader.clearRes(i[t]);i.length=0}}}]),Loader}(T);Yt.TEXT="text",Yt.JSON="json",Yt.PREFAB="prefab",Yt.XML="xml",Yt.BUFFER="arraybuffer",Yt.IMAGE="image",Yt.SOUND="sound",Yt.ATLAS="atlas",Yt.FONT="font",Yt.TTF="ttf",Yt.PLF="plf",Yt.PLFB="plfb",Yt.HIERARCHY="HIERARCHY",Yt.MESH="MESH",Yt.MATERIAL="MATERIAL",Yt.TEXTURE2D="TEXTURE2D",Yt.TEXTURECUBE="TEXTURECUBE",Yt.ANIMATIONCLIP="ANIMATIONCLIP",Yt.AVATAR="AVATAR",Yt.TERRAINHEIGHTDATA="TERRAINHEIGHTDATA",Yt.TERRAINRES="TERRAIN",Yt.typeMap={ttf:"ttf",png:"image",jpg:"image",jpeg:"image",ktx:"image",pvr:"image",txt:"text",json:"json",prefab:"prefab",xml:"xml",als:"atlas",atlas:"atlas",mp3:"sound",ogg:"sound",wav:"sound",part:"json",fnt:"font",plf:"plf",plfb:"plfb",scene:"json",ani:"json",sk:"arraybuffer"},Yt.parserMap={},Yt.maxTimeOut=100,Yt.groupMap={},Yt.loadedMap={},Yt.atlasMap={},Yt.textureMap={},Yt.preLoadedMap={},Yt._imgCache={},Yt._loaders=[],Yt._isWorking=!1,Yt._startIndex=0;var Xt=function(){function AtlasInfoManager(){_classCallCheck(this,AtlasInfoManager)}return _createClass(AtlasInfoManager,null,[{key:"enable",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;i.loader.load(e,m.create(null,AtlasInfoManager._onInfoLoaded,[t]),null,Yt.JSON)}},{key:"_onInfoLoaded",value:function(e,t){var i,n,r,a,s;for(i in t)for(n=(r=t[i])[0],s=(r=r[1]).length,a=0;a<s;a++)AtlasInfoManager._fileLoadDic[n+r[a]]=i;e&&e.run()}},{key:"getFileLoadPath",value:function(e){return AtlasInfoManager._fileLoadDic[e]||e}}]),AtlasInfoManager}();Xt._fileLoadDic={};var zt=function(e){function LoaderManager(){var e;_classCallCheck(this,LoaderManager),(e=_possibleConstructorReturn(this,_getPrototypeOf(LoaderManager).call(this))).retryNum=1,e.retryDelay=0,e.maxLoader=5,e._loaders=[],e._loaderCount=0,e._resInfos=[],e._infoPool=[],e._maxPriority=5,e._failRes={},e._statInfo={count:1,loaded:1};for(var t=0;t<e._maxPriority;t++)e._resInfos[t]=[];return e}return _inherits(LoaderManager,e),_createClass(LoaderManager,[{key:"getProgress",value:function(){return this._statInfo.loaded/this._statInfo.count}},{key:"resetProgress",value:function(){this._statInfo.count=this._statInfo.loaded=1}},{key:"create",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,o=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];this._create(e,!0,t,i,n,r,a,s,o)}},{key:"_create",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,l=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];if(e instanceof Array){var h=!0,u=e,c=u.length,_=0;if(n)var d=m.create(n.caller,n?n.method:null,n.args,!1);for(var f=0;f<c;f++){var v=u[f];"string"==typeof v&&(v=u[f]={url:v}),v.progress=0}for(f=0;f<c;f++){v=u[f];var p=n?m.create(null,(function(e,t){e.progress=t;for(var i=0,n=0;n<c;n++){i+=u[n].progress}var r=i/c;d.runWith(r)}),[v],!1):null,g=n||i?m.create(null,(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;_++,e.progress=1,t||(h=!1),_===c&&i&&i.runWith(h)}),[v]):null;this._createOne(v.url,t,g,p,v.type||r,v.constructParams||a,v.propertyParams||s,v.priority||o,l)}}else this._createOne(e,t,i,n,r,a,s,o,l)}},{key:"_createOne",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,h=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],u=this.getRes(e);if(u)!t&&u instanceof k&&u._addReference(),r&&r.runWith(1),n&&n.runWith(u);else{var c=LoaderManager.createMap[j.getFilecompatibleExtension(e)]?j.getFilecompatibleExtension(e):j.getFileExtension(e);if(a||(a=LoaderManager.createMap[c]?LoaderManager.createMap[c][0]:null),!a)return void this.load(e,n,r,a,l,h);var _=Yt.parserMap;if(!_[a])return void this.load(e,n,r,a,l,h);this._createLoad(e,m.create(null,(function(r){r&&(!t&&r instanceof k&&r._addReference(),r._setCreateURL(e)),n&&n.runWith(r),i.loader.event(e)})),r,a,s,o,l,h,!0)}}},{key:"load",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,h=arguments.length>7&&void 0!==arguments[7]&&arguments[7],u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:i.WorkerLoader.enable;if(e instanceof Array)return this._loadAssets(e,n,r,a,s,o,l);if(t=a===Yt.IMAGE?Yt.textureMap[x.formatURL(e)]:Yt.loadedMap[x.formatURL(e)],h||null==t){var c;c=e,(e=Xt.getFileLoadPath(e))!=c&&"nativeimage"!==a?a=Yt.ATLAS:c=null;var _=LoaderManager._resMap[e];_?(n&&(c?n&&_._createListener(We.COMPLETE,this,this._resInfoLoaded,[c,n],!1,!1):n&&_._createListener(We.COMPLETE,n.caller,n.method,n.args,!1,!1)),r&&_._createListener(We.PROGRESS,r.caller,r.method,r.args,!1,!1)):((_=this._infoPool.length?this._infoPool.pop():new Kt).url=e,_.type=a,_.cache=o,_.group=l,_.ignoreCache=h,_.useWorkerLoader=u,_.originalUrl=c,n&&_.on(We.COMPLETE,n.caller,n.method,n.args),r&&_.on(We.PROGRESS,r.caller,r.method,r.args),LoaderManager._resMap[e]=_,s=s<this._maxPriority?s:this._maxPriority-1,this._resInfos[s].push(_),this._statInfo.count++,this.event(We.PROGRESS,this.getProgress()),this._next())}else i.systemTimer.callLater(this,(function(){r&&r.runWith(1),n&&n.runWith(t instanceof Array?[t]:t),this._loaderCount||this.event(We.COMPLETE)}));return this}},{key:"_resInfoLoaded",value:function(e,t){t.runWith(Yt.getRes(e))}},{key:"_createLoad",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,l=!(arguments.length>7&&void 0!==arguments[7])||arguments[7],h=arguments.length>8&&void 0!==arguments[8]&&arguments[8];if(e instanceof Array)return this._loadAssets(e,t,n,r,o,l);var u=Yt.getRes(e);if(null!=u)i.systemTimer.frameOnce(1,this,(function(){n&&n.runWith(1),t&&t.runWith(u),this._loaderCount||this.event(We.COMPLETE)}));else{var c=LoaderManager._resMap[e];c?(t&&c._createListener(We.COMPLETE,t.caller,t.method,t.args,!1,!1),n&&c._createListener(We.PROGRESS,n.caller,n.method,n.args,!1,!1)):((c=this._infoPool.length?this._infoPool.pop():new Kt).url=e,c.type=r,c.cache=!1,c.ignoreCache=h,c.originalUrl=null,c.group=null,c.createCache=l,c.createConstructParams=a,c.createPropertyParams=s,t&&c.on(We.COMPLETE,t.caller,t.method,t.args),n&&c.on(We.PROGRESS,n.caller,n.method,n.args),LoaderManager._resMap[e]=c,o=o<this._maxPriority?o:this._maxPriority-1,this._resInfos[o].push(c),this._statInfo.count++,this.event(We.PROGRESS,this.getProgress()),this._next())}return this}},{key:"_next",value:function(){if(!(this._loaderCount>=this.maxLoader)){for(var e=0;e<this._maxPriority;e++)for(var t=this._resInfos[e];t.length>0;){var i=t.shift();if(i)return this._doLoad(i)}this._loaderCount||this.event(We.COMPLETE)}}},{key:"_doLoad",value:function(e){this._loaderCount++;var t=this._loaders.length?this._loaders.pop():new Yt;t.on(We.COMPLETE,null,onLoaded),t.on(We.PROGRESS,null,(function(t){e.event(We.PROGRESS,t)})),t.on(We.ERROR,null,(function(e){onLoaded(null)}));var i=this;function onLoaded(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;t.offAll(),t._data=null,t._customParse=!1,i._loaders.push(t),i._endLoad(e,n instanceof Array?[n]:n),i._loaderCount--,i._next()}t._constructParams=e.createConstructParams,t._propertyParams=e.createPropertyParams,t._createCache=e.createCache,t.load(e.url,e.type,e.cache,e.group,e.ignoreCache,e.useWorkerLoader)}},{key:"_endLoad",value:function(e,t){var n=e.url;if(null==t){var r=this._failRes[n]||0;if(r<this.retryNum)return console.warn("[warn]Retry to load:",n),this._failRes[n]=r+1,void i.systemTimer.once(this.retryDelay,this,this._addReTry,[e],!1);Yt.clearRes(n),console.warn("[error]Failed to load:",n),this.event(We.ERROR,n)}this._failRes[n]&&(this._failRes[n]=0),delete LoaderManager._resMap[n],e.originalUrl&&(t=Yt.getRes(e.originalUrl)),e.event(We.COMPLETE,t),e.offAll(),this._infoPool.push(e),this._statInfo.loaded++,this.event(We.PROGRESS,this.getProgress())}},{key:"_addReTry",value:function(e){this._resInfos[this._maxPriority-1].push(e),this._next()}},{key:"clearRes",value:function(e){Yt.clearRes(e)}},{key:"clearTextureRes",value:function(e){Yt.clearTextureRes(e)}},{key:"getRes",value:function(e){return Yt.getRes(e)}},{key:"cacheRes",value:function(e,t){Yt.cacheRes(e,t)}},{key:"setGroup",value:function(e,t){Yt.setGroup(e,t)}},{key:"clearResByGroup",value:function(e){Yt.clearResByGroup(e)}},{key:"clearUnLoaded",value:function(){for(var e=0;e<this._maxPriority;e++){for(var t=this._resInfos[e],i=t.length-1;i>-1;i--){var n=t[i];n&&(n.offAll(),this._infoPool.push(n))}t.length=0}this._loaderCount=0,LoaderManager._resMap={}}},{key:"cancelLoadByUrls",value:function(e){if(e)for(var t=0,i=e.length;t<i;t++)this.cancelLoadByUrl(e[t])}},{key:"cancelLoadByUrl",value:function(e){for(var t=0;t<this._maxPriority;t++)for(var i=this._resInfos[t],n=i.length-1;n>-1;n--){var r=i[n];r&&r.url===e&&(i[n]=null,r.offAll(),this._infoPool.push(r))}LoaderManager._resMap[e]&&delete LoaderManager._resMap[e]}},{key:"_loadAssets",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,o=e.length,l=0,h=0,u=[],c=!0,_=0;_<o;_++){var d=e[_],f=void 0;(f="string"==typeof d?{url:d,type:n,size:1,priority:r}:d).size||(f.size=1),f.progress=0,h+=f.size,u.push(f);var v=i?m.create(null,loadProgress,[f],!1):null,p=t||i?m.create(null,loadComplete,[f]):null;this.load(f.url,p,v,f.type,f.priority||1,a,f.group||s,!1,f.useWorkerLoader)}function loadComplete(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;l++,e.progress=1,i||(c=!1),l===o&&t&&t.runWith(c)}function loadProgress(e,t){if(null!=i){e.progress=t;for(var n=0,r=0;r<u.length;r++){var a=u[r];if(a){var s=null==a.progress?0:a.progress;n+=null==a.size?0:a.size*s}}var o=n/h;i.runWith(o)}}return this}},{key:"decodeBitmaps",value:function(e){var t,n,r=e.length;for(n=i.Render._context,t=0;t<r;t++){var a,s;if(a=Yt.getAtlas(e[t]))this._decodeTexture(a[0],n);else(s=this.getRes(e[t]))&&s instanceof Ve&&this._decodeTexture(s,n)}}},{key:"_decodeTexture",value:function(e,t){var i=e.bitmap;if(e&&i){var n=i.source||i.image;if(n&&n instanceof HTMLImageElement){t.drawImage(n,0,0,1,1);t.getImageData(0,0,1,1)}}}}],[{key:"cacheRes",value:function(e,t){Yt.cacheRes(e,t)}}]),LoaderManager}(T);zt._resMap={},zt.createMap={atlas:[null,Yt.ATLAS]};var Kt=function(e){function ResInfo(){return _classCallCheck(this,ResInfo),_possibleConstructorReturn(this,_getPrototypeOf(ResInfo).apply(this,arguments))}return _inherits(ResInfo,e),ResInfo}(T),jt=function(){function LocalStorage(){_classCallCheck(this,LocalStorage)}return _createClass(LocalStorage,null,[{key:"__init__",value:function(){return LocalStorage._baseClass||(LocalStorage._baseClass=Qt,Qt.init()),LocalStorage.items=LocalStorage._baseClass.items,LocalStorage.support=LocalStorage._baseClass.support,LocalStorage.support}},{key:"setItem",value:function(e,t){LocalStorage._baseClass.setItem(e,t)}},{key:"getItem",value:function(e){return LocalStorage._baseClass.getItem(e)}},{key:"setJSON",value:function(e,t){LocalStorage._baseClass.setJSON(e,t)}},{key:"getJSON",value:function(e){return LocalStorage._baseClass.getJSON(e)}},{key:"removeItem",value:function(e){LocalStorage._baseClass.removeItem(e)}},{key:"clear",value:function(){LocalStorage._baseClass.clear()}}]),LocalStorage}();jt.support=!1;var Qt=function(){function Storage(){_classCallCheck(this,Storage)}return _createClass(Storage,null,[{key:"init",value:function(){try{Storage.support=!0,Storage.items=window.localStorage,Storage.setItem("laya","1"),Storage.removeItem("laya")}catch(e){Storage.support=!1}Storage.support||console.log("LocalStorage is not supprot or browser is private mode.")}},{key:"setItem",value:function(e,t){try{Storage.support&&Storage.items.setItem(e,t)}catch(e){console.warn("set localStorage failed",e)}}},{key:"getItem",value:function(e){return Storage.support?Storage.items.getItem(e):null}},{key:"setJSON",value:function(e,t){try{Storage.support&&Storage.items.setItem(e,JSON.stringify(t))}catch(e){console.warn("set localStorage failed",e)}}},{key:"getJSON",value:function(e){try{return JSON.parse(Storage.support?Storage.items.getItem(e):null)}catch(t){return Storage.items.getItem(e)}}},{key:"removeItem",value:function(e){Storage.support&&Storage.items.removeItem(e)}},{key:"clear",value:function(){Storage.support&&Storage.items.clear()}}]),Storage}();Qt.support=!1;var qt=function(){function TTFLoader(){_classCallCheck(this,TTFLoader)}return _createClass(TTFLoader,[{key:"load",value:function(e){this._url=e;var t=e.toLowerCase().split(".ttf")[0].split("/");this.fontName=t[t.length-1],i.Render.isConchApp?this._loadConch():window.FontFace?this._loadWithFontFace():this._loadWithCSS()}},{key:"_loadConch",value:function(){this._http=new Ht,this._http.on(We.ERROR,this,this._onErr),this._http.on(We.COMPLETE,this,this._onHttpLoaded),this._http.send(this._url,null,"get",Yt.BUFFER)}},{key:"_onHttpLoaded",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;window.conchTextCanvas.setFontFaceFromBuffer(this.fontName,e),this._clearHttp(),this._complete()}},{key:"_clearHttp",value:function(){this._http&&(this._http.off(We.ERROR,this,this._onErr),this._http.off(We.COMPLETE,this,this._onHttpLoaded),this._http=null)}},{key:"_onErr",value:function(){this._clearHttp(),this.err&&(this.err.runWith("fail:"+this._url),this.err=null)}},{key:"_complete",value:function(){i.systemTimer.clear(this,this._complete),i.systemTimer.clear(this,this._checkComplete),this._div&&this._div.parentNode&&(this._div.parentNode.removeChild(this._div),this._div=null),this.complete&&(this.complete.runWith(this),this.complete=null)}},{key:"_checkComplete",value:function(){i.Browser.measureText(TTFLoader._testString,this._fontTxt).width!=this._txtWidth&&this._complete()}},{key:"_loadWithFontFace",value:function(){var e=new window.FontFace(this.fontName,"url('"+this._url+"')");document.fonts.add(e);var t=this;e.loaded.then((function(){t._complete()})),e.load()}},{key:"_createDiv",value:function(){this._div=Ke.createElement("div"),this._div.innerHTML="laya";var e=this._div.style;e.fontFamily=this.fontName,e.position="absolute",e.left="-100px",e.top="-100px",document.body.appendChild(this._div)}},{key:"_loadWithCSS",value:function(){var e=Ke.createElement("style");e.type="text/css",document.body.appendChild(e),e.textContent="@font-face { font-family:'"+this.fontName+"'; src:url('"+this._url+"');}",this._fontTxt="40px "+this.fontName,this._txtWidth=Ke.measureText(TTFLoader._testString,this._fontTxt).width;var t=this;e.onload=function(){i.systemTimer.once(1e4,t,t._complete)},i.systemTimer.loop(20,this,this._checkComplete),this._createDiv()}}]),TTFLoader}();qt._testString="LayaTTFFont";var Zt=function(){function Ease(){_classCallCheck(this,Ease)}return _createClass(Ease,null,[{key:"linearNone",value:function(e,t,i,n){return i*e/n+t}},{key:"linearIn",value:function(e,t,i,n){return i*e/n+t}},{key:"linearInOut",value:function(e,t,i,n){return i*e/n+t}},{key:"linearOut",value:function(e,t,i,n){return i*e/n+t}},{key:"bounceIn",value:function(e,t,i,n){return i-Ease.bounceOut(n-e,0,i,n)+t}},{key:"bounceInOut",value:function(e,t,i,n){return e<.5*n?.5*Ease.bounceIn(2*e,0,i,n)+t:.5*Ease.bounceOut(2*e-n,0,i,n)+.5*i+t}},{key:"bounceOut",value:function(e,t,i,n){return(e/=n)<1/2.75?i*(7.5625*e*e)+t:e<2/2.75?i*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?i*(7.5625*(e-=2.25/2.75)*e+.9375)+t:i*(7.5625*(e-=2.625/2.75)*e+.984375)+t}},{key:"backIn",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1.70158;return i*(e/=n)*e*((r+1)*e-r)+t}},{key:"backInOut",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1.70158;return(e/=.5*n)<1?.5*i*(e*e*((1+(r*=1.525))*e-r))+t:i/2*((e-=2)*e*((1+(r*=1.525))*e+r)+2)+t}},{key:"backOut",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1.70158;return i*((e=e/n-1)*e*((r+1)*e+r)+1)+t}},{key:"elasticIn",value:function(e,t,i,n){var r,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;return 0==e?t:1==(e/=n)?t+i:(s||(s=.3*n),!a||i>0&&a<i||i<0&&a<-i?(a=i,r=s/4):r=s/Ease.PI2*Math.asin(i/a),-a*Math.pow(2,10*(e-=1))*Math.sin((e*n-r)*Ease.PI2/s)+t)}},{key:"elasticInOut",value:function(e,t,i,n){var r,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;return 0==e?t:2==(e/=.5*n)?t+i:(s||(s=n*(.3*1.5)),!a||i>0&&a<i||i<0&&a<-i?(a=i,r=s/4):r=s/Ease.PI2*Math.asin(i/a),e<1?a*Math.pow(2,10*(e-=1))*Math.sin((e*n-r)*Ease.PI2/s)*-.5+t:a*Math.pow(2,-10*(e-=1))*Math.sin((e*n-r)*Ease.PI2/s)*.5+i+t)}},{key:"elasticOut",value:function(e,t,i,n){var r,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;return 0==e?t:1==(e/=n)?t+i:(s||(s=.3*n),!a||i>0&&a<i||i<0&&a<-i?(a=i,r=s/4):r=s/Ease.PI2*Math.asin(i/a),a*Math.pow(2,-10*e)*Math.sin((e*n-r)*Ease.PI2/s)+i+t)}},{key:"strongIn",value:function(e,t,i,n){return i*(e/=n)*e*e*e*e+t}},{key:"strongInOut",value:function(e,t,i,n){return(e/=.5*n)<1?.5*i*e*e*e*e*e+t:.5*i*((e-=2)*e*e*e*e+2)+t}},{key:"strongOut",value:function(e,t,i,n){return i*((e=e/n-1)*e*e*e*e+1)+t}},{key:"sineInOut",value:function(e,t,i,n){return.5*-i*(Math.cos(Math.PI*e/n)-1)+t}},{key:"sineIn",value:function(e,t,i,n){return-i*Math.cos(e/n*Ease.HALF_PI)+i+t}},{key:"sineOut",value:function(e,t,i,n){return i*Math.sin(e/n*Ease.HALF_PI)+t}},{key:"quintIn",value:function(e,t,i,n){return i*(e/=n)*e*e*e*e+t}},{key:"quintInOut",value:function(e,t,i,n){return(e/=.5*n)<1?.5*i*e*e*e*e*e+t:.5*i*((e-=2)*e*e*e*e+2)+t}},{key:"quintOut",value:function(e,t,i,n){return i*((e=e/n-1)*e*e*e*e+1)+t}},{key:"quartIn",value:function(e,t,i,n){return i*(e/=n)*e*e*e+t}},{key:"quartInOut",value:function(e,t,i,n){return(e/=.5*n)<1?.5*i*e*e*e*e+t:.5*-i*((e-=2)*e*e*e-2)+t}},{key:"quartOut",value:function(e,t,i,n){return-i*((e=e/n-1)*e*e*e-1)+t}},{key:"cubicIn",value:function(e,t,i,n){return i*(e/=n)*e*e+t}},{key:"cubicInOut",value:function(e,t,i,n){return(e/=.5*n)<1?.5*i*e*e*e+t:.5*i*((e-=2)*e*e+2)+t}},{key:"cubicOut",value:function(e,t,i,n){return i*((e=e/n-1)*e*e+1)+t}},{key:"quadIn",value:function(e,t,i,n){return i*(e/=n)*e+t}},{key:"quadInOut",value:function(e,t,i,n){return(e/=.5*n)<1?.5*i*e*e+t:.5*-i*(--e*(e-2)-1)+t}},{key:"quadOut",value:function(e,t,i,n){return-i*(e/=n)*(e-2)+t}},{key:"expoIn",value:function(e,t,i,n){return 0==e?t:i*Math.pow(2,10*(e/n-1))+t-.001*i}},{key:"expoInOut",value:function(e,t,i,n){return 0==e?t:e==n?t+i:(e/=.5*n)<1?.5*i*Math.pow(2,10*(e-1))+t:.5*i*(2-Math.pow(2,-10*--e))+t}},{key:"expoOut",value:function(e,t,i,n){return e==n?t+i:i*(1-Math.pow(2,-10*e/n))+t}},{key:"circIn",value:function(e,t,i,n){return-i*(Math.sqrt(1-(e/=n)*e)-1)+t}},{key:"circInOut",value:function(e,t,i,n){return(e/=.5*n)<1?.5*-i*(Math.sqrt(1-e*e)-1)+t:.5*i*(Math.sqrt(1-(e-=2)*e)+1)+t}},{key:"circOut",value:function(e,t,i,n){return i*Math.sqrt(1-(e=e/n-1)*e)+t}}]),Ease}();Zt.HALF_PI=.5*Math.PI,Zt.PI2=2*Math.PI;var $t=function(){function Tween(){_classCallCheck(this,Tween),this.gid=0,this.repeat=1,this._count=0}return _createClass(Tween,[{key:"to",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]&&arguments[6];return this._create(e,t,i,n,r,a,s,!0,!1,!0)}},{key:"from",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]&&arguments[6];return this._create(e,t,i,n,r,a,s,!1,!1,!0)}},{key:"_create",value:function(e,t,n,r,a,s,o,l,h,u){if(!e)throw new Error("Tween:target is null");this._target=e,this._duration=n,this._ease=r||t.ease||Tween.easeNone,this._complete=a||t.complete,this._delay=s,this._props=[],this._usedTimer=0,this._startTimer=Ke.now(),this._usedPool=h,this._delayParam=null,this.update=t.update;var c=e.$_GID||(e.$_GID=j.getGID());return Tween.tweenMap[c]?(o&&Tween.clearTween(e),Tween.tweenMap[c].push(this)):Tween.tweenMap[c]=[this],u?s<=0?this.firstStart(e,t,l):(this._delayParam=[e,t,l],i.timer.once(s,this,this.firstStart,this._delayParam)):this._initProps(e,t,l),this}},{key:"firstStart",value:function(e,t,i){this._delayParam=null,e.destroyed?this.clear():(this._initProps(e,t,i),this._beginLoop())}},{key:"_initProps",value:function(e,t,i){for(var n in t)if("number"==typeof e[n]){var r=i?e[n]:t[n],a=i?t[n]:e[n];this._props.push([n,r,a-r]),i||(e[n]=r)}}},{key:"_beginLoop",value:function(){i.timer.frameLoop(1,this,this._doEase)}},{key:"_doEase",value:function(){this._updateEase(Ke.now())}},{key:"_updateEase",value:function(e){var t=this._target;if(t){if(t.destroyed)return Tween.clearTween(t);var i=this._usedTimer=e-this._startTimer-this._delay;if(!(i<0)){if(i>=this._duration)return this.complete();for(var n=i>0?this._ease(i,0,1,this._duration):0,r=this._props,a=0,s=r.length;a<s;a++){var o=r[a];t[o[0]]=o[1]+n*o[2]}this.update&&this.update.run()}}}},{key:"complete",value:function(){if(this._target){i.timer.runTimer(this,this.firstStart);for(var e=this._target,t=this._props,n=this._complete,r=0,a=t.length;r<a;r++){var s=t[r];e[s[0]]=s[1]+s[2]}this.update&&this.update.run(),this._count++,0!=this.repeat&&this._count>=this.repeat?(this.clear(),n&&n.run()):this.restart()}}},{key:"pause",value:function(){var e;i.timer.clear(this,this._beginLoop),i.timer.clear(this,this._doEase),i.timer.clear(this,this.firstStart),(e=Ke.now()-this._startTimer-this._delay)<0&&(this._usedTimer=e)}},{key:"setStartTime",value:function(e){this._startTimer=e}},{key:"clear",value:function(){this._target&&(this._remove(),this._clear())}},{key:"_clear",value:function(){this.pause(),i.timer.clear(this,this.firstStart),this._complete=null,this._target=null,this._ease=null,this._props=null,this._delayParam=null,this.repeat=1,this._usedPool&&(this.update=null,n.recover("tween",this))}},{key:"recover",value:function(){this._usedPool=!0,this._clear()}},{key:"_remove",value:function(){var e=Tween.tweenMap[this._target.$_GID];if(e)for(var t=0,i=e.length;t<i;t++)if(e[t]===this){e.splice(t,1);break}}},{key:"restart",value:function(){if(this.pause(),this._usedTimer=0,this._startTimer=Ke.now(),this._delayParam)i.timer.once(this._delay,this,this.firstStart,this._delayParam);else{for(var e=this._props,t=0,n=e.length;t<n;t++){var r=e[t];this._target[r[0]]=r[1]}i.timer.once(this._delay,this,this._beginLoop)}}},{key:"resume",value:function(){this._usedTimer>=this._duration||(this._startTimer=Ke.now()-this._usedTimer-this._delay,this._delayParam?this._usedTimer<0?i.timer.once(-this._usedTimer,this,this.firstStart,this._delayParam):this.firstStart.apply(this,this._delayParam):this._beginLoop())}},{key:"progress",set:function(e){var t=e*this._duration;this._startTimer=Ke.now()-this._delay-t}}],[{key:"to",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]&&arguments[6],l=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];return n.getItemByClass("tween",Tween)._create(e,t,i,r,a,s,o,!0,l,!0)}},{key:"from",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]&&arguments[6],l=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];return n.getItemByClass("tween",Tween)._create(e,t,i,r,a,s,o,!1,l,!0)}},{key:"clearAll",value:function(e){if(e&&e.$_GID){var t=Tween.tweenMap[e.$_GID];if(t){for(var i=0,n=t.length;i<n;i++)t[i]._clear();t.length=0}}}},{key:"clear",value:function(e){e.clear()}},{key:"clearTween",value:function(e){Tween.clearAll(e)}},{key:"easeNone",value:function(e,t,i,n){return i*e/n+t}}]),Tween}();$t.tweenMap=[];var Jt=function(){function Dragging(){_classCallCheck(this,Dragging),this.ratio=.92,this.maxOffset=60,this._dragging=!1,this._clickOnly=!0}return _createClass(Dragging,[{key:"start",value:function(e,t,n,r,a,s,o){var l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:.92;this.clearTimer(),this.target=e,this.area=t,this.hasInertia=n,this.elasticDistance=t?r:0,this.elasticBackTime=a,this.data=s,this._disableMouseEvent=o,this.ratio=l,this._parent=e.parent,this._clickOnly=!0,this._dragging=!0,this._elasticRateX=this._elasticRateY=1,this._lastX=this._parent.mouseX,this._lastY=this._parent.mouseY,i.stage.on(We.MOUSE_UP,this,this.onStageMouseUp),i.stage.on(We.MOUSE_OUT,this,this.onStageMouseUp),i.systemTimer.frameLoop(1,this,this.loop)}},{key:"clearTimer",value:function(){i.systemTimer.clear(this,this.loop),i.systemTimer.clear(this,this.tweenMove),this._tween&&(this._tween.recover(),this._tween=null)}},{key:"stop",value:function(){this._dragging&&(At.instance.disableMouseEvent=!1,i.stage.off(We.MOUSE_UP,this,this.onStageMouseUp),i.stage.off(We.MOUSE_OUT,this,this.onStageMouseUp),this._dragging=!1,this.target&&this.area&&this.backToArea(),this.clear())}},{key:"loop",value:function(){var e=this._parent.getMousePoint(),t=e.x,n=e.y,r=t-this._lastX,a=n-this._lastY;if(this._clickOnly){if(!(Math.abs(r*i.stage._canvasTransform.getScaleX())>1||Math.abs(a*i.stage._canvasTransform.getScaleY())>1))return;this._clickOnly=!1,this._offsets||(this._offsets=[]),this._offsets.length=0,this.target.event(We.DRAG_START,this.data),At.instance.disableMouseEvent=this._disableMouseEvent}else this._offsets.push(r,a);0===r&&0===a||(this._lastX=t,this._lastY=n,this.target.x+=r*this._elasticRateX,this.target.y+=a*this._elasticRateY,this.area&&this.checkArea(),this.target.event(We.DRAG_MOVE,this.data))}},{key:"checkArea",value:function(){if(this.elasticDistance<=0)this.backToArea();else{if(this.target._x<this.area.x)var e=this.area.x-this.target._x;else e=this.target._x>this.area.x+this.area.width?this.target._x-this.area.x-this.area.width:0;if(this._elasticRateX=Math.max(0,1-e/this.elasticDistance),this.target._y<this.area.y)var t=this.area.y-this.target.y;else t=this.target._y>this.area.y+this.area.height?this.target._y-this.area.y-this.area.height:0;this._elasticRateY=Math.max(0,1-t/this.elasticDistance)}}},{key:"backToArea",value:function(){this.target.x=Math.min(Math.max(this.target._x,this.area.x),this.area.x+this.area.width),this.target.y=Math.min(Math.max(this.target._y,this.area.y),this.area.y+this.area.height)}},{key:"onStageMouseUp",value:function(e){if(At.instance.disableMouseEvent=!1,i.stage.off(We.MOUSE_UP,this,this.onStageMouseUp),i.stage.off(We.MOUSE_OUT,this,this.onStageMouseUp),i.systemTimer.clear(this,this.loop),!this._clickOnly&&this.target)if(this.hasInertia){this._offsets.length<1&&this._offsets.push(this._parent.mouseX-this._lastX,this._parent.mouseY-this._lastY),this._offsetX=this._offsetY=0;for(var t=this._offsets.length,n=Math.min(t,6),r=this._offsets.length-n,a=t-1;a>r;a--)this._offsetY+=this._offsets[a--],this._offsetX+=this._offsets[a];this._offsetX=this._offsetX/n*2,this._offsetY=this._offsetY/n*2,Math.abs(this._offsetX)>this.maxOffset&&(this._offsetX=this._offsetX>0?this.maxOffset:-this.maxOffset),Math.abs(this._offsetY)>this.maxOffset&&(this._offsetY=this._offsetY>0?this.maxOffset:-this.maxOffset),i.systemTimer.frameLoop(1,this,this.tweenMove)}else this.elasticDistance>0?this.checkElastic():this.clear()}},{key:"checkElastic",value:function(){var e=NaN,t=NaN;if(this.target.x<this.area.x?e=this.area.x:this.target._x>this.area.x+this.area.width&&(e=this.area.x+this.area.width),this.target.y<this.area.y?t=this.area.y:this.target._y>this.area.y+this.area.height&&(t=this.area.y+this.area.height),isNaN(e)&&isNaN(t))this.clear();else{var i={};isNaN(e)||(i.x=e),isNaN(t)||(i.y=t),this._tween=$t.to(this.target,i,this.elasticBackTime,Zt.sineOut,m.create(this,this.clear),0,!1,!1)}}},{key:"tweenMove",value:function(){this._offsetX*=this.ratio*this._elasticRateX,this._offsetY*=this.ratio*this._elasticRateY,this.target.x+=this._offsetX,this.target.y+=this._offsetY,this.area&&this.checkArea(),this.target.event(We.DRAG_MOVE,this.data),(Math.abs(this._offsetX)<1&&Math.abs(this._offsetY)<1||this._elasticRateX<.5||this._elasticRateY<.5)&&(i.systemTimer.clear(this,this.tweenMove),this.elasticDistance>0?this.checkElastic():this.clear())}},{key:"clear",value:function(){if(this.target){this.clearTimer();var e=this.target;this.target=null,this._parent=null,e.event(We.DRAG_END,this.data)}}}]),Dragging}(),ei=function(){function Component(){_classCallCheck(this,Component),this._id=j.getGID(),this._resetComp()}return _createClass(Component,[{key:"_isScript",value:function(){return!1}},{key:"_resetComp",value:function(){this._indexInList=-1,this._enabled=!0,this._awaked=!1,this.owner=null}},{key:"_getIndexInList",value:function(){return this._indexInList}},{key:"_setIndexInList",value:function(e){this._indexInList=e}},{key:"_onAdded",value:function(){}},{key:"_onAwake",value:function(){}},{key:"_onEnable",value:function(){}},{key:"_onDisable",value:function(){}},{key:"_onDestroy",value:function(){}},{key:"onReset",value:function(){}},{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]}},{key:"_parseInteractive",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0],arguments.length>1&&void 0!==arguments[1]&&arguments[1]}},{key:"_cloneTo",value:function(e){}},{key:"_setActive",value:function(e){e?(this._awaked||(this._awaked=!0,this._onAwake()),this._enabled&&this._onEnable()):this._enabled&&this._onDisable()}},{key:"destroy",value:function(){this.owner&&this.owner._destroyComponent(this)}},{key:"_destroy",value:function(){this.owner.activeInHierarchy&&this._enabled&&this._setActive(!1),this._onDestroy(),this._destroyed=!0,this.onReset!==Component.prototype.onReset?(this.onReset(),this._resetComp(),n.recoverByClass(this)):this._resetComp()}},{key:"id",get:function(){return this._id}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!=e&&(this._enabled=e,this.owner&&(e?this.owner.activeInHierarchy&&this._onEnable():this.owner.activeInHierarchy&&this._onDisable()))}},{key:"isSingleton",get:function(){return!0}},{key:"destroyed",get:function(){return this._destroyed}}]),Component}(),ti=function(e){function AnimationBase(){var e;return _classCallCheck(this,AnimationBase),(e=_possibleConstructorReturn(this,_getPrototypeOf(AnimationBase).call(this))).wrapMode=0,e._interval=t.animationInterval,e._isReverse=!1,e._frameRateChanged=!1,e._setBitUp(ft.DISPLAY),e}return _inherits(AnimationBase,e),_createClass(AnimationBase,[{key:"play",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";this._isPlaying=!0,this._actionName=i,this.index="string"==typeof e?this._getFrameByLabel(e):e,this.loop=t,this._isReverse=this.wrapMode===AnimationBase.WRAP_REVERSE,0==this.index&&this._isReverse&&(this.index=this.count-1),this.interval>0&&this.timerLoop(this.interval,this,this._frameLoop,null,!0,!0)}},{key:"_getFrameByLabel",value:function(e){for(var t=0;t<this._count;t++){var i=this._labels[t];if(i&&i.indexOf(e)>-1)return t}return 0}},{key:"_frameLoop",value:function(){if(this._isReverse){if(this._index--,this._index<0){if(!this.loop)return this._index=0,this.stop(),void this.event(We.COMPLETE);this.wrapMode==AnimationBase.WRAP_PINGPONG?(this._index=this._count>0?1:0,this._isReverse=!1):this._index=this._count-1,this.event(We.COMPLETE)}}else if(this._index++,this._index>=this._count){if(!this.loop)return this._index--,this.stop(),void this.event(We.COMPLETE);this.wrapMode==AnimationBase.WRAP_PINGPONG?(this._index=this._count-2>=0?this._count-2:0,this._isReverse=!0):this._index=0,this.event(We.COMPLETE)}this.index=this._index}},{key:"_setControlNode",value:function(e){this._controlNode&&(this._controlNode.off(We.DISPLAY,this,this._resumePlay),this._controlNode.off(We.UNDISPLAY,this,this._resumePlay)),this._controlNode=e,e&&e!=this&&(e.on(We.DISPLAY,this,this._resumePlay),e.on(We.UNDISPLAY,this,this._resumePlay))}},{key:"_setDisplay",value:function(e){_get(_getPrototypeOf(AnimationBase.prototype),"_setDisplay",this).call(this,e),this._resumePlay()}},{key:"_resumePlay",value:function(){this._isPlaying&&(this._controlNode.displayedInStage?this.play(this._index,this.loop,this._actionName):this.clearTimer(this,this._frameLoop))}},{key:"stop",value:function(){this._isPlaying=!1,this.clearTimer(this,this._frameLoop)}},{key:"addLabel",value:function(e,t){this._labels||(this._labels={}),this._labels[t]||(this._labels[t]=[]),this._labels[t].push(e)}},{key:"removeLabel",value:function(e){if(e){if(this._labels)for(var t in this._labels)this._removeLabelFromList(this._labels[t],e)}else this._labels=null}},{key:"_removeLabelFromList",value:function(e,t){if(e)for(var i=e.length-1;i>=0;i--)e[i]==t&&e.splice(i,1)}},{key:"gotoAndStop",value:function(e){this.index="string"==typeof e?this._getFrameByLabel(e):e,this.stop()}},{key:"_displayToIndex",value:function(e){}},{key:"clear",value:function(){return this.stop(),this._labels=null,this}},{key:"interval",get:function(){return this._interval},set:function(e){this._interval!=e&&(this._frameRateChanged=!0,this._interval=e,this._isPlaying&&e>0&&this.timerLoop(e,this,this._frameLoop,null,!0,!0))}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"index",get:function(){return this._index},set:function(e){if(this._index=e,this._displayToIndex(e),this._labels&&this._labels[e])for(var t=this._labels[e],i=0,n=t.length;i<n;i++)this.event(We.LABEL,t[i])}},{key:"count",get:function(){return this._count}}]),AnimationBase}(St);ti.WRAP_POSITIVE=0,ti.WRAP_REVERSE=1,ti.WRAP_PINGPONG=2,mt.regClass("laya.display.AnimationBase",ti),mt.regClass("Laya.AnimationBase",ti);var ii=function(){function MathUtil(){_classCallCheck(this,MathUtil)}return _createClass(MathUtil,null,[{key:"subtractVector3",value:function(e,t,i){i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2]}},{key:"lerp",value:function(e,t,i){return e*(1-i)+t*i}},{key:"scaleVector3",value:function(e,t,i){i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t}},{key:"lerpVector3",value:function(e,t,i,n){var r=e[0],a=e[1],s=e[2];n[0]=r+i*(t[0]-r),n[1]=a+i*(t[1]-a),n[2]=s+i*(t[2]-s)}},{key:"lerpVector4",value:function(e,t,i,n){var r=e[0],a=e[1],s=e[2],o=e[3];n[0]=r+i*(t[0]-r),n[1]=a+i*(t[1]-a),n[2]=s+i*(t[2]-s),n[3]=o+i*(t[3]-o)}},{key:"slerpQuaternionArray",value:function(e,t,i,n,r,a,s){var o,l,h,u,c,_=e[t+0],d=e[t+1],f=e[t+2],v=e[t+3],p=i[n+0],g=i[n+1],y=i[n+2],m=i[n+3];return(l=_*p+d*g+f*y+v*m)<0&&(l=-l,p=-p,g=-g,y=-y,m=-m),1-l>1e-6?(o=Math.acos(l),h=Math.sin(o),u=Math.sin((1-r)*o)/h,c=Math.sin(r*o)/h):(u=1-r,c=r),a[s+0]=u*_+c*p,a[s+1]=u*d+c*g,a[s+2]=u*f+c*y,a[s+3]=u*v+c*m,a}},{key:"getRotation",value:function(e,t,i,n){return Math.atan2(n-t,i-e)/Math.PI*180}},{key:"sortBigFirst",value:function(e,t){return e==t?0:t>e?1:-1}},{key:"sortSmallFirst",value:function(e,t){return e==t?0:t>e?-1:1}},{key:"sortNumBigFirst",value:function(e,t){return parseFloat(t)-parseFloat(e)}},{key:"sortNumSmallFirst",value:function(e,t){return parseFloat(e)-parseFloat(t)}},{key:"sortByKey",value:function(e){var t,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return t=i?n?MathUtil.sortNumBigFirst:MathUtil.sortBigFirst:n?MathUtil.sortNumSmallFirst:MathUtil.sortSmallFirst,function(i,n){return t(i[e],n[e])}}}]),MathUtil}(),ni=function(e){function FrameAnimation(){var e;return _classCallCheck(this,FrameAnimation),e=_possibleConstructorReturn(this,_getPrototypeOf(FrameAnimation).call(this)),void 0===FrameAnimation._sortIndexFun&&(FrameAnimation._sortIndexFun=ii.sortByKey("index",!1,!0)),e}return _inherits(FrameAnimation,e),_createClass(FrameAnimation,[{key:"_setUp",value:function(e,t){this._targetDic=e,this._animationData=t,this.interval=1e3/t.frameRate,t.parsed?(this._count=t.count,this._labels=t.labels,this._usedFrames=t.animationNewFrames):(this._usedFrames=[],this._calculateDatas(),t.parsed=!0,t.labels=this._labels,t.count=this._count,t.animationNewFrames=this._usedFrames)}},{key:"clear",value:function(){return _get(_getPrototypeOf(FrameAnimation.prototype),"clear",this).call(this),this._targetDic=null,this._animationData=null,this}},{key:"_displayToIndex",value:function(e){if(this._animationData){e<0&&(e=0),e>this._count&&(e=this._count);var t,i=this._animationData.nodes,n=i.length;for(t=0;t<n;t++)this._displayNodeToFrame(i[t],e)}}},{key:"_displayNodeToFrame",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;i||(i=this._targetDic);var n=i[e.target];if(n){var r,a,s,o,l=e.frames,h=e.keys,u=h.length;for(o=0;o<u;o++)s=(a=l[r=h[o]]).length>t?a[t]:a[a.length-1],n[r]=s;var c,_=e.funkeys;if(0!=(u=_.length))for(o=0;o<u;o++)void 0!==(c=l[r=_[o]])[t]&&n[r]&&n[r].apply(n,c[t])}}},{key:"_calculateDatas",value:function(){if(this._animationData){var e,t,i=this._animationData.nodes,n=i.length;for(this._count=0,e=0;e<n;e++)t=i[e],this._calculateKeyFrames(t);this._count+=1}}},{key:"_calculateKeyFrames",value:function(e){var t,i,n=e.keyframes,r=e.target;for(t in e.frames||(e.frames={}),e.keys?e.keys.length=0:e.keys=[],e.funkeys?e.funkeys.length=0:e.funkeys=[],e.initValues||(e.initValues={}),n){var a=-1!=t.indexOf("()");if(i=n[t],a&&(t=t.substr(0,t.length-2)),e.frames[t]||(e.frames[t]=[]),a){e.funkeys.push(t);for(var s=e.frames[t],o=0;o<i.length;o++){var l=i[o];s[l.index]=l.value,l.index>this._count&&(this._count=l.index)}}else this._targetDic&&this._targetDic[r]&&(e.initValues[t]=this._targetDic[r][t]),i.sort(FrameAnimation._sortIndexFun),e.keys.push(t),this._calculateNodePropFrames(i,e.frames[t],t,r)}}},{key:"resetNodes",value:function(){if(this._targetDic&&this._animationData){var e,t,i,n=this._animationData.nodes,r=n.length;for(e=0;e<r;e++)if(i=(t=n[e]).initValues){var a,s=this._targetDic[t.target];if(s)for(a in i)s[a]=i[a]}}}},{key:"_calculateNodePropFrames",value:function(e,t,i,n){var r,a=e.length-1;for(t.length=e[a].index+1,r=0;r<a;r++)this._dealKeyFrame(e[r]),this._calculateFrameValues(e[r],e[r+1],t);0==a&&(t[0]=e[0].value,this._usedFrames&&(this._usedFrames[e[0].index]=!0)),this._dealKeyFrame(e[r])}},{key:"_dealKeyFrame",value:function(e){e.label&&""!=e.label&&this.addLabel(e.label,e.index)}},{key:"_calculateFrameValues",value:function(e,t,i){var n,r,a=e.index,s=t.index,o=e.value,l=t.value-e.value,h=s-a,u=this._usedFrames;if(s>this._count&&(this._count=s),e.tween)for(null==(r=Zt[e.tweenMethod])&&(r=Zt.linearNone),n=a;n<s;n++)i[n]=r(n-a,o,l,h),u&&(u[n]=!0);else for(n=a;n<s;n++)i[n]=o;u&&(u[e.index]=!0,u[t.index]=!0),i[t.index]=t.value}}],[{key:"_sortIndexFun",value:function(e,t){return e.index-t.index}}]),FrameAnimation}(ti);mt.regClass("laya.display.FrameAnimation",ni),mt.regClass("Laya.FrameAnimation",ni);var ri=function(){function WeakObject(){_classCallCheck(this,WeakObject),this._obj={},WeakObject._maps.push(this)}return _createClass(WeakObject,[{key:"set",value:function(e,t){null!=e&&(WeakObject.supportWeakMap||("string"==typeof e||"number"==typeof e?this._obj[e]=t:(e.$_GID||(e.$_GID=j.getGID()),this._obj[e.$_GID]=t)))}},{key:"get",value:function(e){return null==e?null:WeakObject.supportWeakMap?void 0:"string"==typeof e||"number"==typeof e?this._obj[e]:this._obj[e.$_GID]}},{key:"del",value:function(e){null!=e&&(WeakObject.supportWeakMap||("string"==typeof e||"number"==typeof e?delete this._obj[e]:delete this._obj[this._obj.$_GID]))}},{key:"has",value:function(e){return null!=e&&(WeakObject.supportWeakMap?void 0:"string"==typeof e||"number"==typeof e?null!=this._obj[e]:null!=this._obj[this._obj.$_GID])}}],[{key:"__init__",value:function(){WeakObject.I=new WeakObject,WeakObject.supportWeakMap||i.systemTimer.loop(WeakObject.delInterval,null,WeakObject.clearCache)}},{key:"clearCache",value:function(){for(var e=0,t=WeakObject._maps.length;e<t;e++){WeakObject._maps[e]._obj={}}}}]),WeakObject}();ri.supportWeakMap=!1,ri.delInterval=6e5,ri._maps=[];var ai=function(){function SceneUtils(){_classCallCheck(this,SceneUtils)}return _createClass(SceneUtils,null,[{key:"__init",value:function(){SceneUtils._funMap=new ri}},{key:"getBindFun",value:function(e){var t=SceneUtils._funMap.get(e);if(null==t){var i='"'+e+'"',n="(function(data){if(data==null)return;with(data){try{\nreturn "+(i=i.replace(/^"\${|}"$/g,"").replace(/\${/g,'"+').replace(/}/g,'+"'))+"\n}catch(e){}}})";t=window.Laya._runScript(n),SceneUtils._funMap.set(e,t)}return t}},{key:"createByData",value:function(e,t){var i=oi.create();if((e=SceneUtils.createComp(t,e,e,null,i))._setBit(ft.NOT_READY,!0),"_idMap"in e&&(e._idMap=i._idMap),t.animations){var n,r,a,s=[],o=t.animations,l=o.length;for(n=0;n<l;n++){switch(r=new ni,a=o[n],r._setUp(i._idMap,a),e[a.name]=r,r._setControlNode(e),a.action){case 1:r.play(0,!1);break;case 2:r.play(0,!0)}s.push(r)}e._aniList=s}return"Scene"===e._$componentType&&e._width>0&&null==t.props.hitTestPrior&&!e.mouseThrough&&(e.hitTestPrior=!0),i.beginLoad(e),e}},{key:"createInitTool",value:function(){return oi.create()}},{key:"createComp",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if("Scene3D"==e.type||"Sprite3D"==e.type){var s=[],o=i.Laya.Utils3D._createSceneByJsonForMaker(e,s,a);return"Sprite3D"==e.type?i.Laya.StaticBatchManager.combine(o,s):i.Laya.StaticBatchManager.combine(null,s),o}if(!(t=t||SceneUtils.getCompInstance(e)))return e.props&&e.props.runtime?console.warn("runtime not found:"+e.props.runtime):console.warn("can not create:"+e.type),null;var l=e.child;if(l)for(var h="List"==t._$componentType,u=0,c=l.length;u<c;u++){var _=l[u];if("itemRender"in t&&("render"==_.props.name||"render"===_.props.renderType))t.itemRender=_;else if("Graphic"==_.type)i.ClassUtils._addGraphicsToSprite(_,t);else if(i.ClassUtils._isDrawType(_.type))i.ClassUtils._addGraphicToSprite(_,t,!0);else{if(h){var d=[],f=SceneUtils.createComp(_,null,n,d,a);d.length&&(f._$bindData=d)}else f=SceneUtils.createComp(_,null,n,r,a);"Script"==_.type?f instanceof ei?t._addComponentInstance(f):"owner"in f?f.owner=t:"target"in f&&(f.target=t):"mask"==_.props.renderType||"mask"==_.props.name?t.mask=f:f instanceof kt&&t.addChild(f)}}var v=e.props;for(var p in v){var g=v[p];"string"==typeof g&&(g.indexOf("@node:")>=0||g.indexOf("@Prefab:")>=0)?a&&a.addNodeRef(t,p,g):SceneUtils.setCompValue(t,p,g,n,r)}return t._afterInited&&t._afterInited(),e.compId&&a&&a._idMap&&(a._idMap[e.compId]=t),t}},{key:"setCompValue",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if("string"==typeof n&&n.indexOf("${")>-1){if(SceneUtils._sheet||(SceneUtils._sheet=i.ClassUtils.getClass("laya.data.Table")),!SceneUtils._sheet)return void console.warn("Can not find class Sheet");if(a)a.push(e,t,n);else if(r){-1==n.indexOf("].")&&(n=n.replace(".","[0]."));var s,o,l=new si(e,t,n);l.exe(r);for(var h=n.replace(/\[.*?\]\./g,".");null!=(s=SceneUtils._parseWatchData.exec(h));){for(var u=s[1];null!=(o=SceneUtils._parseKeyWord.exec(u));){var c=o[0],_=r._watchMap[c]||(r._watchMap[c]=[]);_.push(l),SceneUtils._sheet.I.notifer.on(c,r,r.changeData,[c])}(_=r._watchMap[u]||(r._watchMap[u]=[])).push(l),SceneUtils._sheet.I.notifer.on(u,r,r.changeData,[u])}}}else"var"===t&&r?r[n]=e:e[t]="true"===n||"false"!==n&&n}},{key:"getCompInstance",value:function(e){if("UIView"==e.type&&e.props&&e.props.pageData)return SceneUtils.createByData(null,e.props.pageData);var t=e.props&&e.props.runtime||e.type,r=i.ClassUtils.getClass(t);if(!r)throw"Can not find class "+t;if("Script"===e.type&&r.prototype._doAwake){var a=n.createByClass(r);return a._destroyed=!1,a}return e.props&&"renderType"in e.props&&"instance"==e.props.renderType?(r.instance||(r.instance=new r),r.instance):new r}}]),SceneUtils}();ai._parseWatchData=/\${(.*?)}/g,ai._parseKeyWord=/[a-zA-Z_][a-zA-Z0-9_]*(?:(?:\.[a-zA-Z_][a-zA-Z0-9_]*)+)/g;var si=function(){function DataWatcher(e,t,i){_classCallCheck(this,DataWatcher),this.comp=e,this.prop=t,this.value=i}return _createClass(DataWatcher,[{key:"exe",value:function(e){var t=ai.getBindFun(this.value);this.comp[this.prop]=t.call(this,e)}}]),DataWatcher}(),oi=function(){function InitTool(){_classCallCheck(this,InitTool)}return _createClass(InitTool,[{key:"reset",value:function(){this._nodeRefList=null,this._initList=null,this._idMap=null,this._loadList=null,this._scene=null}},{key:"recover",value:function(){this.reset(),n.recover("InitTool",this)}},{key:"addLoadRes",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this._loadList||(this._loadList=[]),i.loader.getRes(e)||(t?this._loadList.push({url:e,type:t}):this._loadList.push(e))}},{key:"addNodeRef",value:function(e,t,i){this._nodeRefList||(this._nodeRefList=[]),this._nodeRefList.push([e,t,i]),i.indexOf("@Prefab:")>=0&&this.addLoadRes(i.replace("@Prefab:",""),Yt.PREFAB)}},{key:"setNodeRef",value:function(){if(this._nodeRefList)if(this._idMap){var e,t,i;for(t=this._nodeRefList.length,e=0;e<t;e++)(i=this._nodeRefList[e])[0][i[1]]=this.getReferData(i[2]);this._nodeRefList=null}else this._nodeRefList=null}},{key:"getReferData",value:function(e){if(e.indexOf("@Prefab:")>=0)return Yt.getRes(e.replace("@Prefab:",""));if(e.indexOf("@arr:")>=0){var t,i,n,r;for(n=(t=(e=e.replace("@arr:","")).split(",")).length,i=0;i<n;i++)r=t[i],t[i]=r?this._idMap[r.replace("@node:","")]:null;return t}return this._idMap[e.replace("@node:","")]}},{key:"addInitItem",value:function(e){this._initList||(this._initList=[]),this._initList.push(e)}},{key:"doInits",value:function(){this._initList&&(this._initList=null)}},{key:"finish",value:function(){this.setNodeRef(),this.doInits(),this._scene._setBit(ft.NOT_READY,!1),this._scene.parent&&this._scene.parent.activeInHierarchy&&this._scene.active&&this._scene._processActive(),this._scene.event("onViewCreated"),this.recover()}},{key:"beginLoad",value:function(e){this._scene=e,!this._loadList||this._loadList.length<1?this.finish():i.loader.load(this._loadList,m.create(this,this.finish))}}],[{key:"create",value:function(){var e=n.getItemByClass("InitTool",InitTool);return e._idMap=[],e}}]),InitTool}(),li=function(){function IStatRender(){_classCallCheck(this,IStatRender)}return _createClass(IStatRender,[{key:"show",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0],arguments.length>1&&void 0!==arguments[1]&&arguments[1]}},{key:"enable",value:function(){}},{key:"hide",value:function(){}},{key:"set_onclick",value:function(e){}},{key:"isCanvasRender",value:function(){return!0}},{key:"renderNotCanvas",value:function(e,t,i){}}]),IStatRender}(),hi=function(e){function StatUI(){var e;return _classCallCheck(this,StatUI),(e=_possibleConstructorReturn(this,_getPrototypeOf(StatUI).apply(this,arguments)))._show=!1,e._useCanvas=!1,e._height=100,e._view=[],e}return _inherits(StatUI,e),_createClass(StatUI,[{key:"show",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;Ke.onMiniGame||i.Render.isConchApp||Ke.onBDMiniGame||Ke.onKGMiniGame||Ke.onQGMiniGame||Ke.onQQMiniGame||Ke.onAlipayMiniGame||Ke.onBLMiniGame||Ke.onTTMiniGame||Ke.onHWMiniGame||Ke.onTBMiniGame||(this._useCanvas=!0),this._show=!0,N._fpsData.length=60,this._view[0]={title:"FPS(WebGL)",value:"_fpsStr",color:"yellow",units:"int"},this._view[1]={title:"Sprite",value:"_spriteStr",color:"white",units:"int"},this._view[2]={title:"RenderBatches",value:"renderBatches",color:"white",units:"int"},this._view[3]={title:"SavedRenderBatches",value:"savedRenderBatches",color:"white",units:"int"},this._view[4]={title:"CPUMemory",value:"cpuMemory",color:"yellow",units:"M"},this._view[5]={title:"GPUMemory",value:"gpuMemory",color:"yellow",units:"M"},this._view[6]={title:"Shader",value:"shaderCall",color:"white",units:"int"},this._view[7]={title:"Canvas",value:"_canvasStr",color:"white",units:"int"},it.is3DMode&&(this._view[0].title="FPS(3D)",this._view[8]={title:"TriFaces",value:"trianglesFaces",color:"white",units:"int"},this._view[9]={title:"FrustumCulling",value:"frustumCulling",color:"white",units:"int"},this._view[10]={title:"OctreeNodeCulling",value:"octreeNodeCulling",color:"white",units:"int"}),this._useCanvas?this.createUIPre(e,t):this.createUI(e,t),this.enable()}},{key:"createUIPre",value:function(e,t){var i=Ke.pixelRatio;this._width=180*i,this._vx=120*i,this._height=i*(12*this._view.length+3*i)+4,StatUI._fontSize=12*i;for(var n=0;n<this._view.length;n++)this._view[n].x=4,this._view[n].y=n*StatUI._fontSize+2*i;this._canvas||(this._canvas=new gt(!0),this._canvas.size(this._width,this._height),this._ctx=this._canvas.getContext("2d"),this._ctx.textBaseline="top",this._ctx.font=StatUI._fontSize+"px Arial",this._canvas.source.style.cssText="pointer-events:none;background:rgba(150,150,150,0.8);z-index:100000;position: absolute;direction:ltr;left:"+e+"px;top:"+t+"px;width:"+this._width/i+"px;height:"+this._height/i+"px;"),Ke.onKGMiniGame||Ke.container.appendChild(this._canvas.source),this._first=!0,this.loop(),this._first=!1}},{key:"createUI",value:function(e,t){var i=this._sp,n=Ke.pixelRatio;i||(i=new St,this._leftText=new bt,this._leftText.pos(5,5),this._leftText.color="#ffffff",i.addChild(this._leftText),this._txt=new bt,this._txt.pos(130*n,5),this._txt.color="#ffffff",i.addChild(this._txt),this._sp=i),i.pos(e,t);for(var r="",a=0;a<this._view.length;a++){r+=this._view[a].title+"\n"}this._leftText.text=r;var s=138*n,o=n*(12*this._view.length+3*n)+4;this._txt.fontSize=StatUI._fontSize*n,this._leftText.fontSize=StatUI._fontSize*n,i.size(s,o),i.graphics.clear(),i.graphics.alpha(.5),i.graphics.drawRect(0,0,s+110,o+30,"#999999"),i.graphics.alpha(2),this.loop()}},{key:"enable",value:function(){i.systemTimer.frameLoop(1,this,this.loop)}},{key:"hide",value:function(){this._show=!1,i.systemTimer.clear(this,this.loop),this._canvas&&Ke.removeElement(this._canvas.source)}},{key:"set_onclick",value:function(e){this._sp&&this._sp.on("click",this._sp,e),this._canvas&&(this._canvas.source.onclick=e,this._canvas.source.style.pointerEvents="")}},{key:"loop",value:function(){N._count++;var e=Ke.now();if(!(e-N._timer<1e3)){var t=N._count;if(N.FPS=Math.round(1e3*t/(e-N._timer)),this._show){N.trianglesFaces=Math.round(N.trianglesFaces/t),this._useCanvas?N.renderBatches=Math.round(N.renderBatches/t):N.renderBatches=Math.round(N.renderBatches/t)-1,N.savedRenderBatches=Math.round(N.savedRenderBatches/t),N.shaderCall=Math.round(N.shaderCall/t),N.spriteRenderUseCacheCount=Math.round(N.spriteRenderUseCacheCount/t),N.canvasNormal=Math.round(N.canvasNormal/t),N.canvasBitmap=Math.round(N.canvasBitmap/t),N.canvasReCache=Math.ceil(N.canvasReCache/t),N.frustumCulling=Math.round(N.frustumCulling/t),N.octreeNodeCulling=Math.round(N.octreeNodeCulling/t);var i=N.FPS>0?Math.floor(1e3/N.FPS).toString():" ";N._fpsStr=N.FPS+(N.renderSlow?" slow":"")+" "+i,N._spriteStr=N.spriteCount+(N.spriteRenderUseCacheCount?"/"+N.spriteRenderUseCacheCount:""),N._canvasStr=N.canvasReCache+"/"+N.canvasNormal+"/"+N.canvasBitmap,N.cpuMemory=k.cpuMemory,N.gpuMemory=k.gpuMemory,this._useCanvas?this.renderInfoPre():this.renderInfo(),N.clear()}N._count=0,N._timer=e}}},{key:"renderInfoPre",value:function(){var e,t,i=0;if(this._canvas){var n=this._ctx;for(n.clearRect(this._first?0:this._vx,0,this._width,this._height),i=0;i<this._view.length;i++)e=this._view[i],this._first&&(n.fillStyle="white",n.fillText(e.title,e.x,e.y)),n.fillStyle=e.color,t=N[e.value],"M"==e.units&&(t=Math.floor(t/1048576*100)/100+" M"),n.fillText(t+"",e.x+this._vx,e.y)}}},{key:"renderInfo",value:function(){for(var e="",t=0;t<this._view.length;t++){var i=this._view[t],n=N[i.value];"M"==i.units&&(n=Math.floor(n/1048576*100)/100+" M"),"K"==i.units&&(n=Math.floor(n/1024*100)/100+" K"),e+=n+"\n"}this._txt.text=e}},{key:"isCanvasRender",value:function(){return this._useCanvas}},{key:"renderNotCanvas",value:function(e,t,i){this._show&&this._sp&&this._sp.render(e,0,0)}}]),StatUI}(li);hi._fontSize=12;var ui=function(){function Timer(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];_classCallCheck(this,Timer),this.scale=1,this.currTimer=Date.now(),this.currFrame=0,this._delta=0,this._lastTimer=Date.now(),this._map=[],this._handlers=[],this._temp=[],this._count=0,e&&Timer.gSysTimer&&Timer.gSysTimer.frameLoop(1,this,this._update)}return _createClass(Timer,[{key:"_update",value:function(){if(this.scale<=0)return this._lastTimer=Date.now(),void(this._delta=0);var e=this.currFrame=this.currFrame+this.scale,t=Date.now(),i=t-this._lastTimer>3e4;this._delta=(t-this._lastTimer)*this.scale;var n=this.currTimer=this.currTimer+this._delta;this._lastTimer=t;var r=this._handlers;this._count=0;for(var a=0,s=r.length;a<s;a++){var o=r[a];if(null!==o.method){var l=o.userFrame?e:n;if(l>=o.exeTime)if(o.repeat)if(!o.jumpFrame||i)o.exeTime+=o.delay,o.run(!1),l>o.exeTime&&(o.exeTime+=Math.ceil((l-o.exeTime)/o.delay)*o.delay);else for(;l>=o.exeTime;)o.exeTime+=o.delay,o.run(!1);else o.run(!0)}else this._count++}(this._count>30||e%200==0)&&this._clearHandlers()}},{key:"_clearHandlers",value:function(){for(var e=this._handlers,t=0,i=e.length;t<i;t++){var n=e[t];null!==n.method?this._temp.push(n):this._recoverHandler(n)}this._handlers=this._temp,e.length=0,this._temp=e}},{key:"_recoverHandler",value:function(e){this._map[e.key]==e&&(this._map[e.key]=null),e.clear(),Timer._pool.push(e)}},{key:"_create",value:function(e,t,i,n,r,a,s){if(!i)return r.apply(n,a),null;if(s){var o=this._getHandler(n,r);if(o)return o.repeat=t,o.userFrame=e,o.delay=i,o.caller=n,o.method=r,o.args=a,o.exeTime=i+(e?this.currFrame:this.currTimer+Date.now()-this._lastTimer),o}return(o=Timer._pool.length>0?Timer._pool.pop():new ci).repeat=t,o.userFrame=e,o.delay=i,o.caller=n,o.method=r,o.args=a,o.exeTime=i+(e?this.currFrame:this.currTimer+Date.now()-this._lastTimer),this._indexHandler(o),this._handlers.push(o),o}},{key:"_indexHandler",value:function(e){var t=e.caller,n=e.method,r=t?t.$_GID||(t.$_GID=i.Utils.getGID()):0,a=n.$_TID||(n.$_TID=1e5*Timer._mid++);e.key=r+a,this._map[e.key]=e}},{key:"once",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];this._create(!1,!1,e,t,i,n,r)}},{key:"loop",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],a=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s=this._create(!1,!0,e,t,i,n,r);s&&(s.jumpFrame=a)}},{key:"frameOnce",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];this._create(!0,!1,e,t,i,n,r)}},{key:"frameLoop",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];this._create(!0,!0,e,t,i,n,r)}},{key:"toString",value:function(){return" handlers:"+this._handlers.length+" pool:"+Timer._pool.length}},{key:"clear",value:function(e,t){var i=this._getHandler(e,t);i&&(this._map[i.key]=null,i.key=0,i.clear())}},{key:"clearAll",value:function(e){if(e)for(var t=0,i=this._handlers.length;t<i;t++){var n=this._handlers[t];n.caller===e&&(this._map[n.key]=null,n.key=0,n.clear())}}},{key:"_getHandler",value:function(e,t){var n=e?e.$_GID||(e.$_GID=i.Utils.getGID()):0,r=t.$_TID||(t.$_TID=1e5*Timer._mid++);return this._map[n+r]}},{key:"callLater",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;wt.I.callLater(e,t,i)}},{key:"runCallLater",value:function(e,t){wt.I.runCallLater(e,t)}},{key:"runTimer",value:function(e,t){var i=this._getHandler(e,t);i&&null!=i.method&&(this._map[i.key]=null,i.run(!0))}},{key:"pause",value:function(){this.scale=0}},{key:"resume",value:function(){this.scale=1}},{key:"delta",get:function(){return this._delta}}]),Timer}();ui.gSysTimer=null,ui._pool=[],ui._mid=1;var ci=function(){function TimerHandler(){_classCallCheck(this,TimerHandler)}return _createClass(TimerHandler,[{key:"clear",value:function(){this.caller=null,this.method=null,this.args=null}},{key:"run",value:function(e){var t=this.caller;if(t&&t.destroyed)return this.clear();var i=this.method,n=this.args;e&&this.clear(),null!=i&&(n?i.apply(t,n):i.call(t))}}]),TimerHandler}(),_i=function(e){function SkinSV(e){var t;_classCallCheck(this,SkinSV),(t=_possibleConstructorReturn(this,_getPrototypeOf(SkinSV).call(this,U.SKINMESH,0))).offsetX=300,t.offsetY=0;var i=y.mainContext,n=8*Ie.BYTES_PE;return t.position=[2,i.FLOAT,!1,n,0],t.texcoord=[2,i.FLOAT,!1,n,2*Ie.BYTES_PE],t.color=[4,i.FLOAT,!1,n,4*Ie.BYTES_PE],t}return _inherits(SkinSV,e),SkinSV}(Y),di=function(e){function PrimitiveSV(e){var t;return _classCallCheck(this,PrimitiveSV),(t=_possibleConstructorReturn(this,_getPrototypeOf(PrimitiveSV).call(this,U.PRIMITIVE,0)))._attribLocation=["position",0,"attribColor",1],t}return _inherits(PrimitiveSV,e),PrimitiveSV}(Y),fi=function(e){function TextureSV(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return _classCallCheck(this,TextureSV),(e=_possibleConstructorReturn(this,_getPrototypeOf(TextureSV).call(this,U.TEXTURE2D,t))).strength=0,e.blurInfo=null,e.colorMat=null,e.colorAlpha=null,e._attribLocation=["posuv",0,"attribColor",1,"attribFlags",2],e}return _inherits(TextureSV,e),_createClass(TextureSV,[{key:"clear",value:function(){this.texture=null,this.shader=null,this.defines._value=this.subID}}]),TextureSV}(Y),vi=function(){function InlcudeFile(e){_classCallCheck(this,InlcudeFile),this.codes={},this.funs={},this.curUseID=-1,this.funnames="",this.script=e;for(var t,n,r=0;!((r=e.indexOf("#begin",r))<0);){for(n=r+5;!((n=e.indexOf("#end",n))<0)&&"i"===e.charAt(n+4);)n+=5;if(n<0)throw"add include err,no #end:"+e;t=e.indexOf("\n",r);var a=i.ShaderCompile.splitToWords(e.substr(r,t-r),null);"code"==a[1]?this.codes[a[2]]=e.substr(t+1,n-t-1):"function"==a[1]&&(t=e.indexOf("function",r),t+="function".length,this.funs[a[3]]=e.substr(t+1,n-t-1),this.funnames+=a[3]+";"),r=n+1}}return _createClass(InlcudeFile,[{key:"getWith",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=e?this.codes[e]:this.script;if(!t)throw"get with error:"+e;return t}},{key:"getFunsScript",value:function(e){var t="";for(var i in this.funs)e.indexOf(i+";")>=0&&(t+=this.funs[i]);return t}}]),InlcudeFile}(),pi=function(){function ShaderNode(e){_classCallCheck(this,ShaderNode),this.childs=[],this.text="",this.useFuns="",this.z=0,this.includefiles=e}return _createClass(ShaderNode,[{key:"setParent",value:function(e){e.childs.push(this),this.z=e.z+1,this.parent=e}},{key:"setCondition",value:function(e,t){e&&(this.conditionType=t,e=e.replace(/(\s*$)/g,""),this.condition=function(){return this[e]},this.condition.__condition=e)}},{key:"toscript",value:function(e,t){return this._toscript(e,t,++ShaderNode.__id)}},{key:"_toscript",value:function(e,t,n){if(this.childs.length<1&&!this.text)return t;t.length;if(this.condition){var r=!!this.condition.call(e);if(this.conditionType===i.ShaderCompile.IFDEF_ELSE&&(r=!r),!r)return t}if(this.text&&t.push(this.text),this.childs.length>0&&this.childs.forEach((function(i,r,a){i._toscript(e,t,n)})),this.includefiles.length>0&&this.useFuns.length>0)for(var a,s=0,o=this.includefiles.length;s<o;s++)this.includefiles[s].curUseID!=n&&(a=this.includefiles[s].file.getFunsScript(this.useFuns)).length>0&&(this.includefiles[s].curUseID=n,t[0]=a+t[0]);return t}}]),ShaderNode}();pi.__id=1;var gi=function(){function ShaderCompile(e,t,i){_classCallCheck(this,ShaderCompile),this.defs={};var n=this;function _compile(e){e=e.replace(ShaderCompile._clearCR,"");var t=[],i=new pi(t);return n._compileToTree(i,e.split("\n"),0,t,n.defs),i}var r=Date.now();this._VS=_compile(e),this._PS=_compile(t),this._nameMap=i,Date.now()-r>2&&console.log("ShaderCompile use time:"+(Date.now()-r)+"  size:"+e.length+"/"+t.length)}return _createClass(ShaderCompile,[{key:"_compileToTree",value:function(e,t,i,n,r){var a,s,o,l,h,u,c,_,d,f,v;for(d=i;d<t.length;d++)if(!((o=t[d]).length<1)&&0!==(u=o.indexOf("//"))){if(u>=0&&(o=o.substr(0,u)),a=_||new pi(n),_=null,a.text=o,a.noCompile=!0,(u=o.indexOf("#"))>=0){for(l="#",v=u+1,f=o.length;v<f;v++){var p=o.charAt(v);if(" "===p||"\t"===p||"?"===p)break;l+=p}switch(a.name=l,l){case"#ifdef":case"#ifndef":if(a.src=o,a.noCompile=null!=o.match(/[!&|()=<>]/),a.noCompile?console.log("function():Boolean{return "+o.substr(u+a.name.length)+"}"):(c=o.replace(/^\s*/,"").split(/\s+/),a.setCondition(c[1],"#ifdef"===l?ShaderCompile.IFDEF_YES:ShaderCompile.IFDEF_ELSE),a.text="//"+a.text),a.setParent(e),e=a,r)for(c=o.substr(v).split(ShaderCompile._splitToWordExps3),v=0;v<c.length;v++)(o=c[v]).length&&(r[o]=!0);continue;case"#if":if(a.src=o,a.noCompile=!0,a.setParent(e),e=a,r)for(c=o.substr(v).split(ShaderCompile._splitToWordExps3),v=0;v<c.length;v++)(o=c[v]).length&&"defined"!=o&&(r[o]=!0);continue;case"#else":a.src=o,s=(e=e.parent).childs[e.childs.length-1],a.noCompile=s.noCompile,a.noCompile||(a.condition=s.condition,a.conditionType=s.conditionType==ShaderCompile.IFDEF_YES?ShaderCompile.IFDEF_ELSE:ShaderCompile.IFDEF_YES,a.text="//"+a.text+" "+s.text+" "+a.conditionType),a.setParent(e),e=a;continue;case"#endif":s=(e=e.parent).childs[e.childs.length-1],a.noCompile=s.noCompile,a.noCompile||(a.text="//"+a.text),a.setParent(e);continue;case"#include":c=ShaderCompile.splitToWords(o,null);var g=ShaderCompile.includes[c[1]];if(!g)throw"ShaderCompile error no this include file:"+c[1];if((u=c[0].indexOf("?"))<0){a.setParent(e),o=g.getWith("with"==c[2]?c[3]:null),this._compileToTree(a,o.split("\n"),0,n,r),a.text="";continue}a.setCondition(c[0].substr(u+1),ShaderCompile.IFDEF_YES),a.text=g.getWith("with"==c[2]?c[3]:null);break;case"#import":h=(c=ShaderCompile.splitToWords(o,null))[1],n.push({node:a,file:ShaderCompile.includes[h],ofs:a.text.length});continue}}else{if((s=e.childs[e.childs.length-1])&&!s.name){n.length>0&&ShaderCompile.splitToWords(o,s),_=a,s.text+="\n"+o;continue}n.length>0&&ShaderCompile.splitToWords(o,a)}a.setParent(e)}}},{key:"createShader",value:function(e,t,i,n){var r={},a="";if(e)for(var s in e)a+="#define "+s+"\n",r[s]=!0;var o=this._VS.toscript(r,[]),l=this._PS.toscript(r,[]);return(i||V.create)(a+o.join("\n"),a+l.join("\n"),t,this._nameMap,n)}}],[{key:"__init__",value:function(){var e=g.instance;ShaderCompile.shaderParamsMap={float:e.FLOAT,int:e.INT,bool:e.BOOL,vec2:e.FLOAT_VEC2,vec3:e.FLOAT_VEC3,vec4:e.FLOAT_VEC4,ivec2:e.INT_VEC2,ivec3:e.INT_VEC3,ivec4:e.INT_VEC4,bvec2:e.BOOL_VEC2,bvec3:e.BOOL_VEC3,bvec4:e.BOOL_VEC4,mat2:e.FLOAT_MAT2,mat3:e.FLOAT_MAT3,mat4:e.FLOAT_MAT4,sampler2D:e.SAMPLER_2D,samplerCube:e.SAMPLER_CUBE}}},{key:"_parseOne",value:function(e,t,i,n,r,a){var s={type:ShaderCompile.shaderParamsMap[i[n+1]],name:i[n+2],size:isNaN(parseInt(i[n+3]))?1:parseInt(i[n+3])};return a&&("attribute"==r?e.push(s):t.push(s)),":"==i[n+3]&&(s.type=i[n+4],n+=2),n+=2}},{key:"addInclude",value:function(e,t){if(!t||0===t.length)throw new Error("add shader include file err:"+e);if(ShaderCompile.includes[e])throw new Error("add shader include file err, has add:"+e);ShaderCompile.includes[e]=new vi(t)}},{key:"preGetParams",value:function(e,t){var i,n,r=[e,t],a={},s=[],o=[],l={},h=[];a.attributes=s,a.uniforms=o,a.defines=l;for(var u=0;u<2;u++){r[u]=r[u].replace(ShaderCompile._removeAnnotation,"");var c,_=r[u].match(ShaderCompile._reg);for(i=0,n=_.length;i<n;i++){var d=_[i];if("attribute"==d||"uniform"==d)i=ShaderCompile._parseOne(s,o,_,i,d,!0);else{if("#define"==d){h[d=_[++i]]=1;continue}if("#ifdef"==d){l[c=_[++i]]=l[c]||[];for(i++;i<n;i++)if("attribute"==(d=_[i])||"uniform"==d)i=ShaderCompile._parseOne(s,o,_,i,d,h[c]);else if("#else"==d)for(i++;i<n;i++)if("attribute"==(d=_[i])||"uniform"==d)i=ShaderCompile._parseOne(s,o,_,i,d,!h[c]);else if("#endif"==d)break}}}}return a}},{key:"splitToWords",value:function(e,t){for(var i,n,r=[],a=-1,s=0,o=e.length;s<o;s++)if(i=e.charAt(s)," \t=+-*/&%!<>()'\",;".indexOf(i)>=0){if(a>=0&&s-a>1&&(n=e.substr(a,s-a),r.push(n)),'"'==i||"'"==i){var l=e.indexOf(i,s+1);if(l<0)throw"Sharder err:"+e;r.push(e.substr(s+1,l-s-1)),s=l,a=-1;continue}"("==i&&t&&r.length>0&&(n=r[r.length-1]+";","vec4;main;".indexOf(n)<0&&(t.useFuns+=n)),a=-1}else a<0&&(a=s);return a<o&&o-a>1&&(n=e.substr(a,o-a),r.push(n)),r}}]),ShaderCompile}();gi.IFDEF_NO=0,gi.IFDEF_YES=1,gi.IFDEF_ELSE=2,gi.IFDEF_PARENT=3,gi._removeAnnotation=new RegExp("(/\\*([^*]|[\\r\\\n]|(\\*+([^*/]|[\\r\\n])))*\\*+/)|(//.*)","g"),gi._reg=new RegExp("(\".*\")|('.*')|([#\\w\\*-\\.+/()=<>{}\\\\]+)|([,;:\\\\])","g"),gi._splitToWordExps=new RegExp("[(\".*\")]+|[('.*')]+|([ \\t=\\+\\-*/&%!<>!%(),;])","g"),gi.includes={},gi._clearCR=new RegExp("\r","g"),gi._splitToWordExps3=new RegExp("[ \\t=\\+\\-*/&%!<>!%(),;\\|]","g");var yi=function(e){function WorkerLoader(){var e;_classCallCheck(this,WorkerLoader),(e=_possibleConstructorReturn(this,_getPrototypeOf(WorkerLoader).call(this))).worker=new Worker(WorkerLoader.workerPath);var t=_assertThisInitialized(e);return e.worker.onmessage=function(e){t.workerMessage(e.data)},e}return _inherits(WorkerLoader,e),_createClass(WorkerLoader,[{key:"workerMessage",value:function(e){if(e)switch(e.type){case"Image":this.imageLoaded(e);break;case"Disable":WorkerLoader.enable=!1}}},{key:"imageLoaded",value:function(e){if(e.dataType&&"imageBitmap"==e.dataType){var t=e.imageBitmap;console.log("load:",e.url),this.event(e.url,t)}else this.event(e.url,null)}},{key:"loadImage",value:function(e){this.worker.postMessage(e)}},{key:"_loadImage",value:function(e){var t=this,i=t.type;if(this._useWorkerLoader&&WorkerLoader._enable){e=x.formatURL(e);var onload=function(n){if(clear(),n){var r=n;"nativeimage"!==i&&(r=new w).loadImageSource(n),t.onLoaded(r)}else WorkerLoader._preLoadFun.call(t,e)};WorkerLoader.I.on(e,t,onload),WorkerLoader.I.loadImage(e)}else WorkerLoader._preLoadFun.call(t,e);function clear(){WorkerLoader.I.off(e,t,onload)}}}],[{key:"__init__",value:function(){return null==WorkerLoader._preLoadFun&&(!!Worker&&(WorkerLoader._preLoadFun=Yt.prototype._loadImage,Yt.prototype._loadImage=WorkerLoader.prototype._loadImage,WorkerLoader.I||(WorkerLoader.I=new WorkerLoader),!0))}},{key:"workerSupported",value:function(){return!!Worker}},{key:"enableWorkerLoader",value:function(){WorkerLoader._tryEnabled||(WorkerLoader.enable=!0,WorkerLoader._tryEnabled=!0)}},{key:"enable",set:function(e){WorkerLoader._enable!=e&&(WorkerLoader._enable=e,e&&null==WorkerLoader._preLoadFun&&(WorkerLoader._enable=WorkerLoader.__init__()))},get:function(){return WorkerLoader._enable}}]),WorkerLoader}(T);yi.workerPath="libs/workerloader.js",yi._enable=!1,yi._tryEnabled=!1;var mi=function(){function Mouse(){_classCallCheck(this,Mouse)}return _createClass(Mouse,null,[{key:"__init__",value:function(){Mouse._style=Ke.document.body.style}},{key:"hide",value:function(){"none"!=Mouse.cursor&&(Mouse._preCursor=Mouse.cursor,Mouse.cursor="none")}},{key:"show",value:function(){"none"==Mouse.cursor&&(Mouse._preCursor?Mouse.cursor=Mouse._preCursor:Mouse.cursor="auto")}},{key:"cursor",set:function(e){Mouse._style.cursor=e},get:function(){return Mouse._style.cursor}}]),Mouse}(),Ti=function(e){function MeshParticle2D(e){var t;return _classCallCheck(this,MeshParticle2D),(t=_possibleConstructorReturn(this,_getPrototypeOf(MeshParticle2D).call(this,MeshParticle2D.const_stride,4*e*MeshParticle2D.const_stride,4))).canReuse=!0,t.setAttributes(MeshParticle2D._fixattriInfo),t.createQuadIB(e),t._quadNum=e,t}return _inherits(MeshParticle2D,e),_createClass(MeshParticle2D,[{key:"setMaxParticleNum",value:function(e){this._vb._resizeBuffer(4*e*MeshParticle2D.const_stride,!1),this.createQuadIB(e)}},{key:"releaseMesh",value:function(){this._vb.setByteLength(0),this.vertNum=0,this.indexNum=0,MeshParticle2D._POOL.push(this)}},{key:"destroy",value:function(){this._ib.destroy(),this._vb.destroy(),this._vb.deleteBuffer()}}],[{key:"__init__",value:function(){var e=g.instance;MeshParticle2D._fixattriInfo=[e.FLOAT,4,0,e.FLOAT,3,16,e.FLOAT,3,28,e.FLOAT,4,40,e.FLOAT,4,56,e.FLOAT,3,72,e.FLOAT,2,84,e.FLOAT,4,92,e.FLOAT,1,108,e.FLOAT,1,112]}},{key:"getAMesh",value:function(e){if(MeshParticle2D._POOL.length){var t=MeshParticle2D._POOL.pop();return t.setMaxParticleNum(e),t}return new MeshParticle2D(e)}}]),MeshParticle2D}(xe);Ti.const_stride=116,Ti._POOL=[];var Ci=function(e){function HTMLImage(){return _classCallCheck(this,HTMLImage),_possibleConstructorReturn(this,_getPrototypeOf(HTMLImage).apply(this,arguments))}return _inherits(HTMLImage,e),HTMLImage}(E);Ci.create=function(t,i,n){var r=new w(t,i,n,!1,!1);return r.wrapModeU=e.WarpMode.Clamp,r.wrapModeV=e.WarpMode.Clamp,r};var xi=function(){function Laya(){_classCallCheck(this,Laya)}return _createClass(Laya,null,[{key:"__init",value:function(e){e.forEach((function(e){e.__init$&&e.__init$()}))}},{key:"init",value:function(t,n){if(!Laya._isinit){Laya._isinit=!0,ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=Laya._arrayBufferSlice),Ke.__init__();var r=Ke.mainCanvas=new gt(!0),a=r.source.style;a.position="absolute",a.top=a.left="0px",a.background="#000000",Ke.onKGMiniGame||Ke.onAlipayMiniGame||Ke.container.appendChild(r.source),Ke.canvas=new gt(!0),Ke.context=Ke.canvas.getContext("2d"),Ke.supportWebAudio=Nt.__init__(),Ke.supportLocalStorage=jt.__init__(),Laya.systemTimer=new ui(!1),e.systemTimer=ui.gSysTimer=Laya.systemTimer,Laya.startTimer=new ui(!1),Laya.physicsTimer=new ui(!1),Laya.updateTimer=new ui(!1),Laya.lateTimer=new ui(!1),Laya.timer=new ui(!1),e.startTimer=i.startTimer=Laya.startTimer,e.lateTimer=i.lateTimer=Laya.lateTimer,e.updateTimer=i.updateTimer=Laya.updateTimer,i.systemTimer=Laya.systemTimer,e.timer=i.timer=Laya.timer,e.physicsTimer=i.physicsTimer=Laya.physicsTimer,Laya.loader=new zt,i.Laya=Laya,e.loader=i.loader=Laya.loader,ri.__init__(),ai.__init(),mi.__init__(),Je.inner_enable();for(var s=arguments.length,o=new Array(s>2?s-2:0),l=2;l<s;l++)o[l-2]=arguments[l];if(o)for(var h=0,u=o.length;h<u;h++)o[h]&&o[h].enable&&o[h].enable();return i.Render.isConchApp&&Laya.enableNative(),Laya.enableWebGLPlus(),ct.beginCheck(),e.stage=Laya.stage=new Pt,i.stage=Laya.stage,j.gStage=Laya.stage,x.rootPath=x._basePath=Laya._getUrlPath(),ke.__int__(),Re.__init__(),Se.__init__(),Laya.render=new it(0,0,Ke.mainCanvas),e.render=Laya.render,Laya.stage.size(t,n),window.stage=Laya.stage,y.__init__(),Ti.__init__(),gi.__init__(),pt.__init__(),Dt.__init__(),At.instance.__init__(Laya.stage,it.canvas),Et.__init__(),Nt.autoStopMusic=!0,N._StatRender=new hi,Y._initone(U.TEXTURE2D,fi),Y._initone(U.TEXTURE2D|U.FILTERGLOW,fi),Y._initone(U.PRIMITIVE,di),Y._initone(U.SKINMESH,_i),it.canvas}}},{key:"_getUrlPath",value:function(){return x.getPath(location.protocol+"//"+location.host+location.pathname)}},{key:"_arrayBufferSlice",value:function(e,t){var i=new Uint8Array(this,e,t-e),n=new Uint8Array(i.length);return n.set(i),n.buffer}},{key:"alertGlobalError",value:function(e){var t=0;Ke.window.onerror=e?function(e,i,n,r,a){t++<5&&a&&this.alert("出错啦，请把此信息截图给研发商\n"+e+"\n"+a.stack)}:null}},{key:"_runScript",value:function(e){return Ke.window[Laya._evcode](e)}},{key:"enableDebugPanel",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"libs/laya.debugtool.js";if(window.Laya.DebugPanel)window.Laya.DebugPanel.enable();else{var t=Ke.createElement("script");t.onload=function(){window.Laya.DebugPanel.enable()},t.src=e,Ke.document.body.appendChild(t)}}},{key:"enableWebGLPlus",value:function(){y.__init_native()}},{key:"enableNative",value:function(){Laya.isNativeRender_enable||(Laya.isNativeRender_enable=!0,it.supportWebGLPlusRendering&&(V.prototype.uploadTexture2D=function(e){var t=g.instance;t.bindTexture(t.TEXTURE_2D,e)}),D.width=Ke.window.innerWidth,D.height=Ke.window.innerHeight,Ke.measureText=function(e,t){return window.conchTextCanvas.font=t,window.conchTextCanvas.measureText(e)},Pt.clear=function(e){Ze.set2DRenderConfig();var t=Q.create(e).arrColor,i=g.instance;t&&i.clearColor(t[0],t[1],t[2],t[3]),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT|i.STENCIL_BUFFER_BIT),D.clear()},St.drawToCanvas=St.drawToTexture=function(e,t,i,n,r,a){r-=e.x,a-=e.y,r|=0,a|=0,i|=0,n|=0;var s=new gt(!1),o=s.getContext("2d");return s.size(i,n),o.asBitmap=!0,o._targets.start(),pt.renders[t]._fun(e,o,r,a),o.flush(),o._targets.end(),o._targets.restore(),s},Object.defineProperty(B.prototype,"uv",{get:function(){return this._uv},set:function(e){this._uv=e}}),gt.prototype.getTexture=function(){return this._texture||(this._texture=this.context._targets,this._texture.uv=B.flipyuv,this._texture.bitmap=this._texture),this._texture})}}]),Laya}();xi.stage=null,xi.systemTimer=null,xi.startTimer=null,xi.physicsTimer=null,xi.updateTimer=null,xi.lateTimer=null,xi.timer=null,xi.loader=null,xi.version="2.8.0",xi._isinit=!1,xi.isWXOpenDataContext=!1,xi.isWXPosMsg=!1,xi.__classmap=null,xi.Config=t,xi.TextRender=qe,xi.EventDispatcher=T,xi.SoundChannel=Bt,xi.Stage=Pt,xi.Render=it,xi.Browser=Ke,xi.Sprite=St,xi.Node=kt,xi.Context=Ze,xi.WebGL=Je,xi.Handler=m,xi.RunDriver=It,xi.Utils=j,xi.Input=Et,xi.Loader=Yt,xi.LocalStorage=jt,xi.SoundManager=Nt,xi.URL=x,xi.Event=We,xi.Matrix=f,xi.HTMLImage=Ci,xi.Laya=xi,xi._evcode="eval",xi.isNativeRender_enable=!1,xi.__classmap=i.__classMap,i.Timer=ui,i.Dragging=Jt,i.GraphicsBounds=st,i.Sprite=St,i.TextRender=qe,i.Loader=Yt,i.TTFLoader=qt,i.WebAudioSound=Ut,i.SoundManager=Nt,i.ShaderCompile=gi,i.ClassUtils=mt,i.SceneUtils=ai,i.Context=Ze,i.Render=it,i.MouseManager=At,i.Text=bt,i.Browser=Ke,i.WebGL=Je,i.AudioSound=Ft,i.Pool=n,i.Utils=j,i.Graphics=dt,i.Submit=Pe,i.Stage=Pt,i.Resource=k,i.WorkerLoader=yi;var ki=window._layalibs;if(ki){ki.sort((function(e,t){return e.i-t.i}));for(var Si=0;Si<ki.length;Si++)ki[Si].f(window,window.document,xi)}var Ri=window;Ri.Laya?(Ri.Laya.Laya=xi,Object.assign(Ri.Laya,xi)):Ri.Laya=xi;var bi=xi.__init,Ei=xi.init,Mi=xi.version,Ai=xi.alertGlobalError,wi=xi.enableDebugPanel;function _static(e,t){for(var i=0,n=t.length;i<n;i+=2)if("length"==t[i])e.length=t[i+1].call(e);else{!function(){var n=t[i],r=t[i+1];Object.defineProperty(e,n,{get:function(){return delete this[n],this[n]=r.call(this)},set:function(e){delete this[n],this[n]=e},enumerable:!0,configurable:!0})}()}}var Li=function(e){function CommonScript(){return _classCallCheck(this,CommonScript),_possibleConstructorReturn(this,_getPrototypeOf(CommonScript).call(this))}return _inherits(CommonScript,e),_createClass(CommonScript,[{key:"isSingleton",get:function(){return!1}}]),_createClass(CommonScript,[{key:"onAwake",value:function(){}},{key:"onEnable",value:function(){}},{key:"onStart",value:function(){}},{key:"onUpdate",value:function(){}},{key:"onLateUpdate",value:function(){}},{key:"onDisable",value:function(){}},{key:"onDestroy",value:function(){}}]),CommonScript}(ei),Ii=function(e){function Script(){return _classCallCheck(this,Script),_possibleConstructorReturn(this,_getPrototypeOf(Script).apply(this,arguments))}return _inherits(Script,e),_createClass(Script,[{key:"_onAwake",value:function(){this.onAwake(),this.onStart!==Script.prototype.onStart&&i.startTimer.callLater(this,this.onStart)}},{key:"_onEnable",value:function(){var e=Script.prototype;this.onTriggerEnter!==e.onTriggerEnter&&this.owner.on(We.TRIGGER_ENTER,this,this.onTriggerEnter),this.onTriggerStay!==e.onTriggerStay&&this.owner.on(We.TRIGGER_STAY,this,this.onTriggerStay),this.onTriggerExit!==e.onTriggerExit&&this.owner.on(We.TRIGGER_EXIT,this,this.onTriggerExit),this.onMouseDown!==e.onMouseDown&&this.owner.on(We.MOUSE_DOWN,this,this.onMouseDown),this.onMouseUp!==e.onMouseUp&&this.owner.on(We.MOUSE_UP,this,this.onMouseUp),this.onClick!==e.onClick&&this.owner.on(We.CLICK,this,this.onClick),this.onStageMouseDown!==e.onStageMouseDown&&i.stage.on(We.MOUSE_DOWN,this,this.onStageMouseDown),this.onStageMouseUp!==e.onStageMouseUp&&i.stage.on(We.MOUSE_UP,this,this.onStageMouseUp),this.onStageClick!==e.onStageClick&&i.stage.on(We.CLICK,this,this.onStageClick),this.onStageMouseMove!==e.onStageMouseMove&&i.stage.on(We.MOUSE_MOVE,this,this.onStageMouseMove),this.onDoubleClick!==e.onDoubleClick&&this.owner.on(We.DOUBLE_CLICK,this,this.onDoubleClick),this.onRightClick!==e.onRightClick&&this.owner.on(We.RIGHT_CLICK,this,this.onRightClick),this.onMouseMove!==e.onMouseMove&&this.owner.on(We.MOUSE_MOVE,this,this.onMouseMove),this.onMouseOver!==e.onMouseOver&&this.owner.on(We.MOUSE_OVER,this,this.onMouseOver),this.onMouseOut!==e.onMouseOut&&this.owner.on(We.MOUSE_OUT,this,this.onMouseOut),this.onKeyDown!==e.onKeyDown&&i.stage.on(We.KEY_DOWN,this,this.onKeyDown),this.onKeyPress!==e.onKeyPress&&i.stage.on(We.KEY_PRESS,this,this.onKeyPress),this.onKeyUp!==e.onKeyUp&&i.stage.on(We.KEY_UP,this,this.onKeyUp),this.onUpdate!==e.onUpdate&&i.updateTimer.frameLoop(1,this,this.onUpdate),this.onLateUpdate!==e.onLateUpdate&&i.lateTimer.frameLoop(1,this,this.onLateUpdate),this.onPreRender!==e.onPreRender&&i.lateTimer.frameLoop(1,this,this.onPreRender),this.onEnable()}},{key:"_onDisable",value:function(){this.owner.offAllCaller(this),i.stage.offAllCaller(this),i.startTimer.clearAll(this),i.updateTimer.clearAll(this),i.lateTimer.clearAll(this)}},{key:"_isScript",value:function(){return!0}},{key:"_onDestroy",value:function(){this.onDestroy()}},{key:"onAwake",value:function(){}},{key:"onEnable",value:function(){}},{key:"onStart",value:function(){}},{key:"onTriggerEnter",value:function(e,t,i){}},{key:"onTriggerStay",value:function(e,t,i){}},{key:"onTriggerExit",value:function(e,t,i){}},{key:"onMouseDown",value:function(e){}},{key:"onMouseUp",value:function(e){}},{key:"onClick",value:function(e){}},{key:"onStageMouseDown",value:function(e){}},{key:"onStageMouseUp",value:function(e){}},{key:"onStageClick",value:function(e){}},{key:"onStageMouseMove",value:function(e){}},{key:"onDoubleClick",value:function(e){}},{key:"onRightClick",value:function(e){}},{key:"onMouseMove",value:function(e){}},{key:"onMouseOver",value:function(e){}},{key:"onMouseOut",value:function(e){}},{key:"onKeyDown",value:function(e){}},{key:"onKeyPress",value:function(e){}},{key:"onKeyUp",value:function(e){}},{key:"onUpdate",value:function(){}},{key:"onLateUpdate",value:function(){}},{key:"onPreRender",value:function(){}},{key:"onPostRender",value:function(){}},{key:"onDisable",value:function(){}},{key:"onDestroy",value:function(){}},{key:"isSingleton",get:function(){return!1}}]),Script}(ei),Pi=function(e){function GraphicAnimation(){var e;return _classCallCheck(this,GraphicAnimation),(e=_possibleConstructorReturn(this,_getPrototypeOf(GraphicAnimation).apply(this,arguments)))._nodeIDAniDic={},e}return _inherits(GraphicAnimation,e),_createClass(GraphicAnimation,[{key:"_parseNodeList",value:function(e){this._nodeList||(this._nodeList=[]),this._nodeDefaultProps[e.compId]=e.props,e.compId&&this._nodeList.push(e.compId);var t=e.child;if(t){var i,n=t.length;for(i=0;i<n;i++)this._parseNodeList(t[i])}}},{key:"_calGraphicData",value:function(e){var t;if(this._setUp(null,e),this._createGraphicData(),this._nodeIDAniDic)for(t in this._nodeIDAniDic)this._nodeIDAniDic[t]=null}},{key:"_createGraphicData",value:function(){var e,t,i=[],n=this.count,r=this._usedFrames;for(r||(r=[]),e=0;e<n;e++)!r[e]&&t||(t=this._createFrameGraphic(e)),i.push(t);this._gList=i}},{key:"_createFrameGraphic",value:function(e){var t=new dt;return GraphicAnimation._rootMatrix||(GraphicAnimation._rootMatrix=new f),this._updateNodeGraphic(this._rootNode,e,GraphicAnimation._rootMatrix,t),t}},{key:"_updateNodeGraphic",value:function(e,t,i,n){var r,a,s,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;(r=this._nodeGDic[e.compId]=this._getNodeGraphicData(e.compId,t,this._nodeGDic[e.compId])).resultTransform||(r.resultTransform=new f),a=r.resultTransform,f.mul(r.transform,i,a);var l=r.alpha*o;if(!(l<.01)){r.skin&&(s=this._getTextureByUrl(r.skin))&&(a._checkTransform()?(n.drawTexture(s,0,0,r.width,r.height,a,l),r.resultTransform=null):n.drawTexture(s,a.tx,a.ty,r.width,r.height,null,l));var h,u,c=e.child;if(c)for(u=c.length,h=0;h<u;h++)this._updateNodeGraphic(c[h],t,a,n,l)}}},{key:"_updateNoChilds",value:function(e,t){if(e.skin){var i=this._getTextureByUrl(e.skin);if(i){var n=e.transform;n._checkTransform(),!n._bTransform?t.drawTexture(i,n.tx,n.ty,e.width,e.height,null,e.alpha):t.drawTexture(i,0,0,e.width,e.height,n.clone(),e.alpha)}}}},{key:"_updateNodeGraphic2",value:function(e,t,i){var n;if(n=this._nodeGDic[e.compId]=this._getNodeGraphicData(e.compId,t,this._nodeGDic[e.compId]),e.child){var r,a,s,o=n.transform;o._checkTransform(),a=(r=!o._bTransform)&&(0!=o.tx||0!=o.ty),(s=o._bTransform||1!=n.alpha)&&i.save(),1!=n.alpha&&i.alpha(n.alpha),r?a&&i.translate(o.tx,o.ty):i.transform(o.clone());var l,h,u,c=e.child;if(n.skin&&(l=this._getTextureByUrl(n.skin))&&i.drawImage(l,0,0,n.width,n.height),c)for(u=c.length,h=0;h<u;h++)this._updateNodeGraphic2(c[h],t,i);s?i.restore():r?a&&i.translate(-o.tx,-o.ty):i.transform(o.clone().invert())}else this._updateNoChilds(n,i)}},{key:"_calculateKeyFrames",value:function(e){_get(_getPrototypeOf(GraphicAnimation.prototype),"_calculateKeyFrames",this).call(this,e),this._nodeIDAniDic[e.target]=e}},{key:"getNodeDataByID",value:function(e){return this._nodeIDAniDic[e]}},{key:"_getParams",value:function(e,t,i,n){var r=GraphicAnimation._temParam;r.length=t.length;var a,s=t.length;for(a=0;a<s;a++)r[a]=this._getObjVar(e,t[a][0],i,t[a][1],n);return r}},{key:"_getObjVar",value:function(e,t,i,n,r){if(t in e){var a=e[t];return i>=a.length&&(i=a.length-1),e[t][i]}return t in r?r[t]:n}},{key:"_getNodeGraphicData",value:function(e,t,i){i||(i=new Di),i.transform?i.transform.identity():i.transform=new f;var n=this.getNodeDataByID(e);if(!n)return i;var r,a,s,o=n.frames,l=this._getParams(o,GraphicAnimation._drawTextureCmd,t,this._nodeDefaultProps[e]),h=l[0],u=l[5],c=l[6],_=l[13],d=l[14],v=l[7],p=l[8],g=l[9],y=l[11],m=l[12];r=l[3],a=l[4],0!=r&&0!=a||(h=null),-1==r&&(r=0),-1==a&&(a=0),i.skin=h,i.width=r,i.height=a,h&&((s=this._getTextureByUrl(h))?(r||(r=s.sourceWidth),a||(a=s.sourceHeight)):console.warn("lost skin:",h,",you may load pics first")),i.alpha=l[10];var T=i.transform;0!=_&&(u=_*r),0!=d&&(c=d*a),0==u&&0==c||T.translate(-u,-c);var C=null;if(g||1!==v||1!==p||y||m){(C=GraphicAnimation._tempMt).identity(),C._bTransform=!0;var x=.0174532922222222*(g-y),k=.0174532922222222*(g+m),S=Math.cos(k),R=Math.sin(k),b=Math.sin(x),E=Math.cos(x);C.a=v*S,C.b=v*R,C.c=-p*b,C.d=p*E,C.tx=C.ty=0}return C&&(T=f.mul(T,C,T)),T.translate(l[1],l[2]),i}},{key:"_getTextureByUrl",value:function(e){return Yt.getRes(e)}},{key:"setAniData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(e.animations){this._nodeDefaultProps={},this._nodeGDic={},this._nodeList&&(this._nodeList.length=0),this._rootNode=e,this._parseNodeList(e);var i,n,r={},a=[],s=e.animations,o=s.length;for(i=0;i<o;i++)if(n=s[i],this._labels=null,(!t||t==n.name)&&n){try{this._calGraphicData(n)}catch(e){console.warn("parse animation fail:"+n.name+",empty animation created"),this._gList=[]}var l={};l.interval=1e3/n.frameRate,l.frames=this._gList,l.labels=this._labels,l.name=n.name,a.push(l),r[n.name]=l}this.animationList=a,this.animationDic=r}GraphicAnimation._temParam.length=0}},{key:"parseByData",value:function(e){var t,i;t=e.nodeRoot,i=e.aniO,delete e.nodeRoot,delete e.aniO,this._nodeDefaultProps={},this._nodeGDic={},this._nodeList&&(this._nodeList.length=0),this._rootNode=t,this._parseNodeList(t),this._labels=null;try{this._calGraphicData(i)}catch(e){console.warn("parse animation fail:"+i.name+",empty animation created"),this._gList=[]}var n=e;return n.interval=1e3/i.frameRate,n.frames=this._gList,n.labels=this._labels,n.name=i.name,n}},{key:"setUpAniData",value:function(e){if(e.animations){var t,i,n={},r=[],a=e.animations,s=a.length;for(t=0;t<s;t++)if(i=a[t]){var o={};o.name=i.name,o.aniO=i,o.nodeRoot=e,r.push(o),n[i.name]=o}this.animationList=r,this.animationDic=n}}},{key:"_clear",value:function(){this.animationList=null,this.animationDic=null,this._gList=null,this._nodeGDic=null}}],[{key:"parseAnimationByData",value:function(e){var t;return GraphicAnimation._I||(GraphicAnimation._I=new GraphicAnimation),t=GraphicAnimation._I.parseByData(e),GraphicAnimation._I._clear(),t}},{key:"parseAnimationData",value:function(e){var t;return GraphicAnimation._I||(GraphicAnimation._I=new GraphicAnimation),GraphicAnimation._I.setUpAniData(e),(t={}).animationList=GraphicAnimation._I.animationList,t.animationDic=GraphicAnimation._I.animationDic,GraphicAnimation._I._clear(),t}}]),GraphicAnimation}(ni);Pi._drawTextureCmd=[["skin",null],["x",0],["y",0],["width",-1],["height",-1],["pivotX",0],["pivotY",0],["scaleX",1],["scaleY",1],["rotation",0],["alpha",1],["skewX",0],["skewY",0],["anchorX",0],["anchorY",0]],Pi._temParam=[],Pi._tempMt=new f;var Di=function GraphicNode(){_classCallCheck(this,GraphicNode),this.alpha=1},Bi=function(e){function Animation(){var e;return _classCallCheck(this,Animation),(e=_possibleConstructorReturn(this,_getPrototypeOf(Animation).call(this)))._setControlNode(_assertThisInitialized(e)),e}return _inherits(Animation,e),_createClass(Animation,[{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.stop(),_get(_getPrototypeOf(Animation.prototype),"destroy",this).call(this,e),this._frames=null,this._labels=null}},{key:"play",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";i&&this._setFramesFromCache(i,!0),_get(_getPrototypeOf(Animation.prototype),"play",this).call(this,e,t,i)}},{key:"_setFramesFromCache",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._url&&(e=this._url+"#"+e),e&&Animation.framesMap[e]){var i=Animation.framesMap[e];return i instanceof Array?(this._frames=Animation.framesMap[e],this._count=this._frames.length):(i.nodeRoot&&(Animation.framesMap[e]=Pi.parseAnimationByData(i),i=Animation.framesMap[e]),this._frames=i.frames,this._count=this._frames.length,this._frameRateChanged||(this._interval=i.interval),this._labels=this._copyLabels(i.labels)),!0}return t&&console.log("ani not found:",e),!1}},{key:"_copyLabels",value:function(e){if(!e)return null;var t,i;for(i in t={},e)t[i]=j.copyArray([],e[i]);return t}},{key:"_frameLoop",value:function(){this._visible&&this._style.alpha>.01&&this._frames&&_get(_getPrototypeOf(Animation.prototype),"_frameLoop",this).call(this)}},{key:"_displayToIndex",value:function(e){this._frames&&(this.graphics=this._frames[e])}},{key:"clear",value:function(){return _get(_getPrototypeOf(Animation.prototype),"clear",this).call(this),this.stop(),this.graphics=null,this._frames=null,this._labels=null,this}},{key:"loadImages",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return this._url="",this._setFramesFromCache(t)||(this.frames=Animation.framesMap[t]?Animation.framesMap[t]:Animation.createFrames(e,t)),this}},{key:"loadAtlas",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";this._url="";var r=this;if(!r._setFramesFromCache(n)){var onLoaded=function(i){e===i&&(r.frames=Animation.framesMap[n]?Animation.framesMap[n]:Animation.createFrames(e,n),t&&t.run())};Yt.getAtlas(e)?onLoaded(e):i.loader.load(e,m.create(null,onLoaded,[e]),null,Yt.ATLAS)}return this}},{key:"loadAnimation",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._url=e;var r=this;return this._actionName||(this._actionName=""),r._setFramesFromCache(this._actionName)?(r._setFramesFromCache(this._actionName,!0),this.index=0,t&&t.run()):!n||Yt.getAtlas(n)?this._loadAnimationData(e,t,n):i.loader.load(n,m.create(this,this._loadAnimationData,[e,t,n]),null,Yt.ATLAS),this}},{key:"_loadAnimationData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(!n||Yt.getAtlas(n)){var r=this;Yt.getRes(e)?onLoaded(e):i.loader.load(e,m.create(null,onLoaded,[e]),null,Yt.JSON)}else console.warn("atlas load fail:"+n);function onLoaded(i){if(Yt.getRes(i)){if(e===i){var n;if(Animation.framesMap[e+"#"])r._setFramesFromCache(r._actionName,!0),r.index=0,r._resumePlay();else{var a=Pi.parseAnimationData(Yt.getRes(e));if(!a)return;var s,o,l=a.animationList,h=l.length;for(s=0;s<h;s++)n=l[s],Animation.framesMap[e+"#"+n.name]=n,o||(o=n);o&&(Animation.framesMap[e+"#"]=o,r._setFramesFromCache(r._actionName,!0),r.index=0),r._resumePlay()}t&&t.run()}Yt.clearRes(e)}else Animation.framesMap[e+"#"]&&(r._setFramesFromCache(r._actionName,!0),r.index=0,r._resumePlay(),t&&t.run())}}},{key:"frames",get:function(){return this._frames},set:function(e){this._frames=e,e&&(this._count=e.length,this._actionName&&this._setFramesFromCache(this._actionName,!0),this.index=this._index)}},{key:"source",set:function(e){e.indexOf(".ani")>-1?this.loadAnimation(e):e.indexOf(".json")>-1||e.indexOf("als")>-1||e.indexOf("atlas")>-1?this.loadAtlas(e):this.loadImages(e.split(","))}},{key:"autoAnimation",set:function(e){this.play(0,!0,e)}},{key:"autoPlay",set:function(e){e?this.play():this.stop()}}],[{key:"createFrames",value:function(e,t){var i;if("string"==typeof e){var n=Yt.getAtlas(e);if(n&&n.length){i=[];for(var r=0,a=n.length;r<a;r++){var s=new dt;s.drawImage(Yt.getRes(n[r]),0,0),i.push(s)}}}else if(e instanceof Array)for(i=[],r=0,a=e.length;r<a;r++)(s=new dt).loadImage(e[r],0,0),i.push(s);return t&&(Animation.framesMap[t]=i),i}},{key:"clearCache",value:function(e){var t,i=Animation.framesMap,n=e+"#";for(t in i)t!==e&&0!==t.indexOf(n)||delete Animation.framesMap[t]}}]),Animation}(ti);Bi.framesMap={},i.regClass(Bi),mt.regClass("laya.display.Animation",Bi),mt.regClass("Laya.Animation",Bi);var Oi=function(e){function EffectAnimation(){var e;return _classCallCheck(this,EffectAnimation),(e=_possibleConstructorReturn(this,_getPrototypeOf(EffectAnimation).apply(this,arguments)))._initData={},e}return _inherits(EffectAnimation,e),_createClass(EffectAnimation,[{key:"_onOtherBegin",value:function(e){e!==this&&this.stop()}},{key:"_addEvent",value:function(){this._target&&this._playEvent&&(this._setControlNode(this._target),this._target.on(this._playEvent,this,this._onPlayAction))}},{key:"_onPlayAction",value:function(){this.play(0,!1)}},{key:"play",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";this._target&&(this._target.event(EffectAnimation.EFFECT_BEGIN,[this]),this._recordInitData(),_get(_getPrototypeOf(EffectAnimation.prototype),"play",this).call(this,e,t,i))}},{key:"_recordInitData",value:function(){var e,t,i;if(this._aniKeys)for(t=this._aniKeys.length,e=0;e<t;e++)i=this._aniKeys[e],this._initData[i]=this._target[i]}},{key:"_displayToIndex",value:function(e){if(this._animationData){e<0&&(e=0),e>this._count&&(e=this._count);var t,i=this._animationData.nodes,n=i.length;for(n=n>1?1:n,t=0;t<n;t++)this._displayNodeToFrame(i[t],e)}}},{key:"_displayNodeToFrame",value:function(e,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this._target){var i,n,r,a,s,o,l,h,u,c=this._target,_=e.frames,d=e.keys,f=d.length,v=e.secondFrames;for(a=0;a<f;a++)n=_[i=d[a]],-1==(s=v[i])?r=this._initData[i]:t<s?(h=(l=e.keyframes[i])[0]).tween?(null==(o=Zt[h.tweenMethod])&&(o=Zt.linearNone),u=l[1],r=o(t,this._initData[i],u.value-this._initData[i],u.index)):r=this._initData[i]:r=n.length>t?n[t]:n[n.length-1],c[i]=r}}},{key:"_calculateKeyFrames",value:function(e){_get(_getPrototypeOf(EffectAnimation.prototype),"_calculateKeyFrames",this).call(this,e);var t,i,n=e.keyframes,r=(e.target,{});for(t in e.secondFrames=r,n)(i=n[t]).length<=1?r[t]=-1:r[t]=i[1].index}},{key:"target",set:function(e){this._target&&this._target.off(EffectAnimation.EFFECT_BEGIN,this,this._onOtherBegin),this._target=e,this._target&&this._target.on(EffectAnimation.EFFECT_BEGIN,this,this._onOtherBegin),this._addEvent()},get:function(){return this._target}},{key:"playEvent",set:function(e){this._playEvent=e,e&&this._addEvent()}},{key:"effectClass",set:function(e){if(this._effectClass=mt.getClass(e),this._effectClass){var t=this._effectClass.uiView;if(t){var i=t.animations;if(i&&i[0]){var n=i[0];this._setUp({},n),n.nodes&&n.nodes[0]&&(this._aniKeys=n.nodes[0].keys)}}}}},{key:"effectData",set:function(e){if(e){var t=e.animations;if(t&&t[0]){var i=t[0];this._setUp({},i),i.nodes&&i.nodes[0]&&(this._aniKeys=i.nodes[0].keys)}}}}]),EffectAnimation}(ni);Oi.EFFECT_BEGIN="effectbegin",mt.regClass("laya.display.EffectAnimation",Oi),mt.regClass("Laya.EffectAnimation",Oi);var Fi=function(e){function SceneLoader(){var e;return _classCallCheck(this,SceneLoader),(e=_possibleConstructorReturn(this,_getPrototypeOf(SceneLoader).call(this)))._completeHandler=new m(_assertThisInitialized(e),e.onOneLoadComplete),e.reset(),e}return _inherits(SceneLoader,e),_createClass(SceneLoader,[{key:"reset",value:function(){this._toLoadList=[],this._isLoading=!1,this.totalCount=0}},{key:"load",value:function(e){var t,i,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(e instanceof Array)for(i=e.length,t=0;t<i;t++)this._addToLoadList(e[t],n);else this._addToLoadList(e,n);r&&this._checkNext()}},{key:"_addToLoadList",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._toLoadList.indexOf(e)>=0||Yt.getRes(e)||(t?this._toLoadList.push({url:e}):this._toLoadList.push(e),this.totalCount++)}},{key:"_checkNext",value:function(){if(!this._isLoading){if(0==this._toLoadList.length)return void this.event(We.COMPLETE);var e;"string"==typeof(e=this._toLoadList.pop())?this.loadOne(e):this.loadOne(e.url,!0)}}},{key:"loadOne",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._curUrl=e;var n=j.getFileExtension(this._curUrl);t?i.loader.create(e,this._completeHandler):SceneLoader.LoadableExtensions[n]?i.loader.load(e,this._completeHandler,null,SceneLoader.LoadableExtensions[n]):e!=Xt.getFileLoadPath(e)||SceneLoader.No3dLoadTypes[n]||!zt.createMap[n]?i.loader.load(e,this._completeHandler):i.loader.create(e,this._completeHandler)}},{key:"onOneLoadComplete",value:function(){this._isLoading=!1,Yt.getRes(this._curUrl)||console.log("Fail to load:",this._curUrl);var e,t=j.getFileExtension(this._curUrl);SceneLoader.LoadableExtensions[t]&&((e=Yt.getRes(this._curUrl))&&e instanceof Wt&&(e=e.json),e&&(e.loadList&&this.load(e.loadList,!1,!1),e.loadList3D&&this.load(e.loadList3D,!0,!1)));"sk"==t&&this.load(this._curUrl.replace(".sk",".png"),!1,!1),this.event(We.PROGRESS,this.getProgress()),this._checkNext()}},{key:"getProgress",value:function(){return this.loadedCount/this.totalCount}},{key:"leftCount",get:function(){return this._isLoading?this._toLoadList.length+1:this._toLoadList.length}},{key:"loadedCount",get:function(){return this.totalCount-this.leftCount}}]),SceneLoader}(T);Fi.LoadableExtensions={scene:Yt.JSON,scene3d:Yt.JSON,ani:Yt.JSON,ui:Yt.JSON,prefab:Yt.PREFAB},Fi.No3dLoadTypes={png:!0,jpg:!0,txt:!0};var Gi=function(e){function Scene(){var e,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return _classCallCheck(this,Scene),(e=_possibleConstructorReturn(this,_getPrototypeOf(Scene).call(this))).autoDestroyAtClosed=!1,e.url=null,e._viewCreated=!1,e._$componentType="Scene",Scene.unDestroyedScenes.push(_assertThisInitialized(e)),e._scene=_assertThisInitialized(e),t&&e.createChildren(),e}return _inherits(Scene,e),_createClass(Scene,[{key:"createChildren",value:function(){}},{key:"loadScene",value:function(e){var t=e.indexOf(".")>-1?e:e+".scene",n=i.loader.getRes(t);if(n)this.createView(n);else{this._setBit(ft.NOT_READY,!0),i.loader.resetProgress();var r=new Fi;r.on(We.COMPLETE,this,this._onSceneLoaded,[t]),r.load(t)}}},{key:"_onSceneLoaded",value:function(e){this.createView(i.Loader.getRes(e))}},{key:"createView",value:function(e){e&&!this._viewCreated&&(this._viewCreated=!0,ai.createByData(this,e))}},{key:"getNodeByID",value:function(e){return this._idMap?this._idMap[e]:null}},{key:"open",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;e&&Scene.closeAll(),Scene.root.addChild(this),this.onOpened(t)}},{key:"onOpened",value:function(e){}},{key:"close",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.onClosed(e),this.autoDestroyAtClosed?this.destroy():this.removeSelf()}},{key:"onClosed",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._idMap=null,_get(_getPrototypeOf(Scene.prototype),"destroy",this).call(this,e);for(var t=Scene.unDestroyedScenes,i=t.length-1;i>-1;i--)if(t[i]===this)return void t.splice(i,1)}},{key:"_sizeChanged",value:function(){this.event(We.RESIZE)}},{key:"scaleX",set:function(e){_get(_getPrototypeOf(Scene.prototype),"get_scaleX",this).call(this)!=e&&(_get(_getPrototypeOf(Scene.prototype),"set_scaleX",this).call(this,e),this.event(We.RESIZE))},get:function(){return _get(_getPrototypeOf(Scene.prototype),"scaleX",this)}},{key:"scaleY",set:function(e){_get(_getPrototypeOf(Scene.prototype),"get_scaleY",this).call(this)!=e&&(_get(_getPrototypeOf(Scene.prototype),"set_scaleY",this).call(this,e),this.event(We.RESIZE))},get:function(){return _get(_getPrototypeOf(Scene.prototype),"scaleY",this)}},{key:"width",get:function(){if(this._width)return this._width;for(var e=0,t=this.numChildren-1;t>-1;t--){var i=this.getChildAt(t);i._visible&&(e=Math.max(i._x+i.width*i.scaleX,e))}return e},set:function(e){_get(_getPrototypeOf(Scene.prototype),"get_width",this).call(this)!=e&&(_get(_getPrototypeOf(Scene.prototype),"set_width",this).call(this,e),this.callLater(this._sizeChanged))}},{key:"height",get:function(){if(this._height)return this._height;for(var e=0,t=this.numChildren-1;t>-1;t--){var i=this.getChildAt(t);i._visible&&(e=Math.max(i._y+i.height*i.scaleY,e))}return e},set:function(e){_get(_getPrototypeOf(Scene.prototype),"get_height",this).call(this)!=e&&(_get(_getPrototypeOf(Scene.prototype),"set_height",this).call(this,e),this.callLater(this._sizeChanged))}},{key:"timer",get:function(){return this._timer||i.timer},set:function(e){this._timer=e}}],[{key:"setUIMap",value:function(e){var t=i.loader.getRes(e);if(!t)throw"请提前加载uimap的json，再使用该接口设置！";for(var n in t)i.Loader.loadedMap[x.formatURL(n+".scene")]=t[n]}},{key:"load",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;i.loader.resetProgress();var r=new Fi;function onProgress(e){Scene._loadPage&&Scene._loadPage.event("progress",e),n&&n.runWith(e)}function create(){r.off(We.PROGRESS,null,onProgress);var n=i.Loader.getRes(e);if(!n)throw"Can not find scene:"+e;if(!n.props)throw"Scene data is error:"+e;var a=n.props.runtime?n.props.runtime:n.type,s=i.ClassUtils.getClass(a);if("instance"==n.props.renderType)var o=s.instance||(s.instance=new s);else o=new s;if(!(o&&o instanceof kt))throw"Can not find scene:"+a;o.url=e,o._viewCreated?t&&t.runWith(o):(o.on("onViewCreated",null,(function(){t&&t.runWith(o)})),o.createView(n)),Scene.hideLoadingPage()}r.on(We.PROGRESS,null,onProgress),r.once(We.COMPLETE,null,create),r.load(e)}},{key:"open",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(i instanceof m){var a=n;n=i,i=a}Scene.showLoadingPage(),Scene.load(e,m.create(null,this._onSceneLoaded,[t,n,i]),r)}},{key:"_onSceneLoaded",value:function(e,t,i,n){n.open(e,i),t&&t.runWith(n)}},{key:"close",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=!1,n=Scene.unDestroyedScenes,r=0,a=n.length;r<a;r++){var s=n[r];s&&s.parent&&s.url===e&&s.name==t&&(s.close(),i=!0)}return i}},{key:"closeAll",value:function(){for(var e=Scene.root,t=0,i=e.numChildren;t<i;t++){var n=e.getChildAt(0);n instanceof Scene?n.close():n.removeSelf()}}},{key:"destroy",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=!1,n=[].concat(Scene.unDestroyedScenes),r=0,a=n.length;r<a;r++){var s=n[r];s.url!==e||s.name!=t||s.destroyed||(s.destroy(),i=!0)}return i}},{key:"gc",value:function(){k.destroyUnusedResources()}},{key:"setLoadingPage",value:function(e){Scene._loadPage!=e&&(Scene._loadPage=e)}},{key:"showLoadingPage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:500;Scene._loadPage&&(i.systemTimer.clear(null,Scene._showLoading),i.systemTimer.clear(null,Scene._hideLoading),i.systemTimer.once(t,null,Scene._showLoading,[e],!1))}},{key:"_showLoading",value:function(e){i.stage.addChild(Scene._loadPage),Scene._loadPage.onOpened(e)}},{key:"_hideLoading",value:function(){Scene._loadPage.close()}},{key:"hideLoadingPage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:500;Scene._loadPage&&(i.systemTimer.clear(null,Scene._showLoading),i.systemTimer.clear(null,Scene._hideLoading),i.systemTimer.once(e,null,Scene._hideLoading))}},{key:"root",get:function(){return Scene._root||(Scene._root=i.stage.addChild(new St),Scene._root.name="root",i.stage.on("resize",null,(function(){Scene._root.size(i.stage.width,i.stage.height),Scene._root.event(We.RESIZE)})),Scene._root.size(i.stage.width,i.stage.height),Scene._root.event(We.RESIZE)),Scene._root}}]),Scene}(St);Gi.unDestroyedScenes=[],i.regClass(Gi),mt.regClass("laya.display.Scene",Gi),mt.regClass("Laya.Scene",Gi);var Ui=function(){function DrawParticleCmd(){_classCallCheck(this,DrawParticleCmd)}return _createClass(DrawParticleCmd,[{key:"recover",value:function(){this._templ=null,n.recover("DrawParticleCmd",this)}},{key:"run",value:function(e,t,i){e.drawParticle(t,i,this._templ)}},{key:"cmdID",get:function(){return DrawParticleCmd.ID}}],[{key:"create",value:function(e){var t=n.getItemByClass("DrawParticleCmd",DrawParticleCmd);return t._templ=e,t}}]),DrawParticleCmd}();Ui.ID="DrawParticleCmd";var Ni=function(){function FilterSetterBase(){_classCallCheck(this,FilterSetterBase)}return _createClass(FilterSetterBase,[{key:"paramChanged",value:function(){xi.systemTimer.callLater(this,this.buildFilter)}},{key:"buildFilter",value:function(){this._target&&this.addFilter(this._target)}},{key:"addFilter",value:function(e){var t;e&&(e.filters?(t=e.filters).indexOf(this._filter)<0&&(t.push(this._filter),e.filters=j.copyArray([],t)):e.filters=[this._filter])}},{key:"removeFilter",value:function(e){e&&(e.filters=null)}},{key:"target",set:function(e){this._target!=e&&(this._target=e,this.paramChanged())}}]),FilterSetterBase}(),Wi=function(){function BlurFilterGLRender(){_classCallCheck(this,BlurFilterGLRender)}return _createClass(BlurFilterGLRender,[{key:"render",value:function(e,t,i,n,r){var a=Y.create(U.TEXTURE2D,0);this.setShaderInfo(a,r,e.width,e.height),t.drawTarget(e,0,0,i,n,f.EMPTY.identity(),a)}},{key:"setShaderInfo",value:function(e,t,i,n){e.defines.add(K.BLUR);var r=e;BlurFilterGLRender.blurinfo[0]=i,BlurFilterGLRender.blurinfo[1]=n,r.blurInfo=BlurFilterGLRender.blurinfo;var a=t.strength/3,s=a*a;t.strength_sig2_2sig2_gauss1[0]=t.strength,t.strength_sig2_2sig2_gauss1[1]=s,t.strength_sig2_2sig2_gauss1[2]=2*s,t.strength_sig2_2sig2_gauss1[3]=1/(2*Math.PI*s),r.strength_sig2_2sig2_gauss1=t.strength_sig2_2sig2_gauss1}}]),BlurFilterGLRender}();Wi.blurinfo=new Array(2);var Vi=function(e){function BlurFilter(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:4;return _classCallCheck(this,BlurFilter),(e=_possibleConstructorReturn(this,_getPrototypeOf(BlurFilter).call(this))).strength_sig2_2sig2_gauss1=[],e.strength=t,e._glRender=new Wi,e}return _inherits(BlurFilter,e),_createClass(BlurFilter,[{key:"getStrenth_sig2_2sig2_native",value:function(){this.strength_sig2_native||(this.strength_sig2_native=new Float32Array(4));var e=this.strength/3,t=e*e;return this.strength_sig2_native[0]=this.strength,this.strength_sig2_native[1]=t,this.strength_sig2_native[2]=2*t,this.strength_sig2_native[3]=1/(2*Math.PI*t),this.strength_sig2_native}},{key:"type",get:function(){return K.BLUR}}]),BlurFilter}(K),Hi=function(e){function BlurFilterSetter(){var e;return _classCallCheck(this,BlurFilterSetter),(e=_possibleConstructorReturn(this,_getPrototypeOf(BlurFilterSetter).call(this)))._strength=4,e._filter=new Vi(e.strength),e}return _inherits(BlurFilterSetter,e),_createClass(BlurFilterSetter,[{key:"buildFilter",value:function(){this._filter=new Vi(this.strength),_get(_getPrototypeOf(BlurFilterSetter.prototype),"buildFilter",this).call(this)}},{key:"strength",get:function(){return this._strength},set:function(e){this._strength=e}}]),BlurFilterSetter}(Ni),Yi=function(){function ButtonEffect(){_classCallCheck(this,ButtonEffect),this._curState=0,this.effectScale=1.5,this.tweenTime=300}return _createClass(ButtonEffect,[{key:"toChangedState",value:function(){this._curState=1,this._curTween&&$t.clear(this._curTween),this._curTween=$t.to(this._tar,{scaleX:this.effectScale,scaleY:this.effectScale},this.tweenTime,Zt[this.effectEase],m.create(this,this.tweenComplete))}},{key:"toInitState",value:function(){2!=this._curState&&(this._curTween&&$t.clear(this._curTween),this._curState=2,this._curTween=$t.to(this._tar,{scaleX:1,scaleY:1},this.tweenTime,Zt[this.backEase],m.create(this,this.tweenComplete)))}},{key:"tweenComplete",value:function(){this._curState=0,this._curTween=null}},{key:"target",set:function(e){this._tar=e,e.on(We.MOUSE_DOWN,this,this.toChangedState),e.on(We.MOUSE_UP,this,this.toInitState),e.on(We.MOUSE_OUT,this,this.toInitState)}}]),ButtonEffect}(),Xi=function(e){function ColorFilterSetter(){var e;return _classCallCheck(this,ColorFilterSetter),(e=_possibleConstructorReturn(this,_getPrototypeOf(ColorFilterSetter).call(this)))._brightness=0,e._contrast=0,e._saturation=0,e._hue=0,e._red=0,e._green=0,e._blue=0,e._alpha=0,e._filter=new q,e}return _inherits(ColorFilterSetter,e),_createClass(ColorFilterSetter,[{key:"buildFilter",value:function(){this._filter.reset(),this._filter.color(this.red,this.green,this.blue,this.alpha),this._filter.adjustHue(this.hue),this._filter.adjustContrast(this.contrast),this._filter.adjustBrightness(this.brightness),this._filter.adjustSaturation(this.saturation),_get(_getPrototypeOf(ColorFilterSetter.prototype),"buildFilter",this).call(this)}},{key:"brightness",get:function(){return this._brightness},set:function(e){this._brightness=e,this.paramChanged()}},{key:"contrast",get:function(){return this._contrast},set:function(e){this._contrast=e,this.paramChanged()}},{key:"saturation",get:function(){return this._saturation},set:function(e){this._saturation=e,this.paramChanged()}},{key:"hue",get:function(){return this._hue},set:function(e){this._hue=e,this.paramChanged()}},{key:"red",get:function(){return this._red},set:function(e){this._red=e,this.paramChanged()}},{key:"green",get:function(){return this._green},set:function(e){this._green=e,this.paramChanged()}},{key:"blue",get:function(){return this._blue},set:function(e){this._blue=e,this.paramChanged()}},{key:"color",get:function(){return this._color},set:function(e){var t;this._color=e,t=Q.create(e),this._red=255*t.arrColor[0],this._green=255*t.arrColor[1],this._blue=255*t.arrColor[2],this.paramChanged()}},{key:"alpha",get:function(){return this._alpha},set:function(e){this._alpha=e,this.paramChanged()}}]),ColorFilterSetter}(Ni),zi=function(e){function EffectBase(){var e;return _classCallCheck(this,EffectBase),(e=_possibleConstructorReturn(this,_getPrototypeOf(EffectBase).apply(this,arguments))).duration=1e3,e.delay=0,e.repeat=0,e.autoDestroyAtComplete=!0,e}return _inherits(EffectBase,e),_createClass(EffectBase,[{key:"_onAwake",value:function(){this.target=this.target||this.owner,this.autoDestroyAtComplete&&(this._comlete=m.create(this.target,this.target.destroy,null,!1)),this.eventName?this.owner.on(this.eventName,this,this._exeTween):this._exeTween()}},{key:"_exeTween",value:function(){this._tween=this._doTween(),this._tween.repeat=this.repeat}},{key:"_doTween",value:function(){return null}},{key:"onReset",value:function(){this.duration=1e3,this.delay=0,this.repeat=0,this.ease=null,this.target=null,this.eventName&&(this.owner.off(this.eventName,this,this._exeTween),this.eventName=null),this._comlete&&(this._comlete.recover(),this._comlete=null),this._tween&&(this._tween.clear(),this._tween=null)}}]),EffectBase}(ei),Ki=function(e){function FadeIn(){return _classCallCheck(this,FadeIn),_possibleConstructorReturn(this,_getPrototypeOf(FadeIn).apply(this,arguments))}return _inherits(FadeIn,e),_createClass(FadeIn,[{key:"_doTween",value:function(){return this.target.alpha=0,$t.to(this.target,{alpha:1},this.duration,Zt[this.ease],this._comlete,this.delay)}}]),FadeIn}(zi),ji=function(e){function FadeOut(){return _classCallCheck(this,FadeOut),_possibleConstructorReturn(this,_getPrototypeOf(FadeOut).apply(this,arguments))}return _inherits(FadeOut,e),_createClass(FadeOut,[{key:"_doTween",value:function(){return this.target.alpha=1,$t.to(this.target,{alpha:0},this.duration,Zt[this.ease],this._comlete,this.delay)}}]),FadeOut}(zi),Qi=function(){function GlowFilterGLRender(){_classCallCheck(this,GlowFilterGLRender)}return _createClass(GlowFilterGLRender,[{key:"setShaderInfo",value:function(e,t,i,n){e.defines.add(n.type);var r=e;r.u_blurInfo1=n._sv_blurInfo1;var a=n._sv_blurInfo2;a[0]=t,a[1]=i,r.u_blurInfo2=a,r.u_color=n.getColor()}},{key:"render",value:function(e,t,i,n,r){var a=i,s=n,o=Y.create(U.TEXTURE2D,0);this.setShaderInfo(o,a,s,r);var l=Y.create(U.TEXTURE2D,0),h=f.TEMP.identity();t.drawTarget(e,0,0,a,s,h,o),t.drawTarget(e,0,0,a,s,h,l)}}]),GlowFilterGLRender}(),qi=function(e){function GlowFilter(e){var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:6,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:6;return _classCallCheck(this,GlowFilter),(t=_possibleConstructorReturn(this,_getPrototypeOf(GlowFilter).call(this)))._elements=new Float32Array(9),t._sv_blurInfo1=new Array(4),t._sv_blurInfo2=[0,0,1,0],t._color=new Q(e),t.blur=Math.min(i,20),t.offX=n,t.offY=r,t._sv_blurInfo1[0]=t._sv_blurInfo1[1]=t.blur,t._sv_blurInfo1[2]=n,t._sv_blurInfo1[3]=-r,t._glRender=new Qi,t}return _inherits(GlowFilter,e),_createClass(GlowFilter,[{key:"getColor",value:function(){return this._color.arrColor}},{key:"getColorNative",value:function(){this._color_native||(this._color_native=new Float32Array(4));var e=this.getColor();return this._color_native[0]=e[0],this._color_native[1]=e[1],this._color_native[2]=e[2],this._color_native[3]=e[3],this._color_native}},{key:"getBlurInfo1Native",value:function(){return this._blurInof1_native||(this._blurInof1_native=new Float32Array(4)),this._blurInof1_native[0]=this._blurInof1_native[1]=this.blur,this._blurInof1_native[2]=this.offX,this._blurInof1_native[3]=this.offY,this._blurInof1_native}},{key:"getBlurInfo2Native",value:function(){return this._blurInof2_native||(this._blurInof2_native=new Float32Array(4)),this._blurInof2_native[2]=1,this._blurInof2_native}},{key:"type",get:function(){return Vi.GLOW}},{key:"offY",get:function(){return this._elements[6]},set:function(e){this._elements[6]=e,this._sv_blurInfo1[3]=-e}},{key:"offX",get:function(){return this._elements[5]},set:function(e){this._elements[5]=e,this._sv_blurInfo1[2]=e}},{key:"blur",get:function(){return this._elements[4]},set:function(e){this._elements[4]=e,this._sv_blurInfo1[0]=this._sv_blurInfo1[1]=e}}]),GlowFilter}(K),Zi=function(e){function GlowFilterSetter(){var e;return _classCallCheck(this,GlowFilterSetter),(e=_possibleConstructorReturn(this,_getPrototypeOf(GlowFilterSetter).call(this)))._color="#ff0000",e._blur=4,e._offX=6,e._offY=6,e._filter=new qi(e._color),e}return _inherits(GlowFilterSetter,e),_createClass(GlowFilterSetter,[{key:"buildFilter",value:function(){this._filter=new qi(this.color,this.blur,this.offX,this.offY),_get(_getPrototypeOf(GlowFilterSetter.prototype),"buildFilter",this).call(this)}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this.paramChanged()}},{key:"blur",get:function(){return this._blur},set:function(e){this._blur=e,this.paramChanged()}},{key:"offX",get:function(){return this._offX},set:function(e){this._offX=e,this.paramChanged()}},{key:"offY",get:function(){return this._offY},set:function(e){this._offY=e,this.paramChanged()}}]),GlowFilterSetter}(Ni),$i=function KeyLocation(){_classCallCheck(this,KeyLocation)};$i.STANDARD=0,$i.LEFT=1,$i.RIGHT=2,$i.NUM_PAD=3;var Ji=function Keyboard(){_classCallCheck(this,Keyboard)};Ji.NUMBER_0=48,Ji.NUMBER_1=49,Ji.NUMBER_2=50,Ji.NUMBER_3=51,Ji.NUMBER_4=52,Ji.NUMBER_5=53,Ji.NUMBER_6=54,Ji.NUMBER_7=55,Ji.NUMBER_8=56,Ji.NUMBER_9=57,Ji.A=65,Ji.B=66,Ji.C=67,Ji.D=68,Ji.E=69,Ji.F=70,Ji.G=71,Ji.H=72,Ji.I=73,Ji.J=74,Ji.K=75,Ji.L=76,Ji.M=77,Ji.N=78,Ji.O=79,Ji.P=80,Ji.Q=81,Ji.R=82,Ji.S=83,Ji.T=84,Ji.U=85,Ji.V=86,Ji.W=87,Ji.X=88,Ji.Y=89,Ji.Z=90,Ji.F1=112,Ji.F2=113,Ji.F3=114,Ji.F4=115,Ji.F5=116,Ji.F6=117,Ji.F7=118,Ji.F8=119,Ji.F9=120,Ji.F10=121,Ji.F11=122,Ji.F12=123,Ji.F13=124,Ji.F14=125,Ji.F15=126,Ji.NUMPAD=21,Ji.NUMPAD_0=96,Ji.NUMPAD_1=97,Ji.NUMPAD_2=98,Ji.NUMPAD_3=99,Ji.NUMPAD_4=100,Ji.NUMPAD_5=101,Ji.NUMPAD_6=102,Ji.NUMPAD_7=103,Ji.NUMPAD_8=104,Ji.NUMPAD_9=105,Ji.NUMPAD_ADD=107,Ji.NUMPAD_DECIMAL=110,Ji.NUMPAD_DIVIDE=111,Ji.NUMPAD_ENTER=108,Ji.NUMPAD_MULTIPLY=106,Ji.NUMPAD_SUBTRACT=109,Ji.SEMICOLON=186,Ji.EQUAL=187,Ji.COMMA=188,Ji.MINUS=189,Ji.PERIOD=190,Ji.SLASH=191,Ji.BACKQUOTE=192,Ji.LEFTBRACKET=219,Ji.BACKSLASH=220,Ji.RIGHTBRACKET=221,Ji.QUOTE=222,Ji.ALTERNATE=18,Ji.BACKSPACE=8,Ji.CAPS_LOCK=20,Ji.COMMAND=15,Ji.CONTROL=17,Ji.DELETE=46,Ji.ENTER=13,Ji.ESCAPE=27,Ji.PAGE_UP=33,Ji.PAGE_DOWN=34,Ji.END=35,Ji.HOME=36,Ji.LEFT=37,Ji.UP=38,Ji.RIGHT=39,Ji.DOWN=40,Ji.SHIFT=16,Ji.SPACE=32,Ji.TAB=9,Ji.INSERT=45;var en=function(){function CommandEncoder(e,t,i,n){_classCallCheck(this,CommandEncoder),this._idata=[]}return _createClass(CommandEncoder,[{key:"getArrayData",value:function(){return this._idata}},{key:"getPtrID",value:function(){return 0}},{key:"beginEncoding",value:function(){}},{key:"endEncoding",value:function(){}},{key:"clearEncoding",value:function(){this._idata.length=0}},{key:"getCount",value:function(){return this._idata.length}},{key:"add_ShaderValue",value:function(e){this._idata.push(e)}},{key:"addShaderUniform",value:function(e){this.add_ShaderValue(e)}}]),CommandEncoder}(),tn=function(){function LayaGLRunner(){_classCallCheck(this,LayaGLRunner)}return _createClass(LayaGLRunner,null,[{key:"uploadShaderUniforms",value:function(e,t,i,n){for(var r=i._data,a=t.getArrayData(),s=0,o=0,l=a.length;o<l;o++){var h=a[o];if(n||-1!==h.textureID){var u=r[h.dataOffset];null!=u&&(s+=h.fun.call(h.caller,h,u))}}return s}},{key:"uploadCustomUniform",value:function(e,t,i,n){var r=0,a=t[i];return a&&null!=n&&(r+=a.fun.call(a.caller,a,n)),r}},{key:"uploadShaderUniformsForNative",value:function(e,t,i){var n=g.UPLOAD_SHADER_UNIFORM_TYPE_ID;i._runtimeCopyValues.length>0&&(n=g.UPLOAD_SHADER_UNIFORM_TYPE_DATA);var r=i._data;return g.instance.uploadShaderUniforms(t,r,n)}}]),LayaGLRunner}(),nn=function(){function QuickTestTool(){_classCallCheck(this,QuickTestTool)}return _createClass(QuickTestTool,[{key:"render",value:function(e,t,i){QuickTestTool._addType(this._renderType),QuickTestTool.showRenderTypeInfo(this._renderType),pt.renders[this._renderType]._fun(this,e,t+this._x,i+this._y),this._repaint=0}},{key:"_stageRender",value:function(e,t,n){QuickTestTool._countStart(),QuickTestTool._PreStageRender.call(i.stage,e,t,n),QuickTestTool._countEnd()}}],[{key:"getMCDName",value:function(e){return QuickTestTool._typeToNameDic[e]}},{key:"showRenderTypeInfo",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t||!QuickTestTool.showedDic[e]){if(QuickTestTool.showedDic[e]=!0,!QuickTestTool._rendertypeToStrDic[e]){var i,n=[];for(i=1;i<=e;)i&e&&n.push(QuickTestTool.getMCDName(i&e)),i<<=1;QuickTestTool._rendertypeToStrDic[e]=n.join(",")}console.log("cmd:",QuickTestTool._rendertypeToStrDic[e])}}},{key:"__init__",value:function(){QuickTestTool._typeToNameDic[ot.ALPHA]="ALPHA",QuickTestTool._typeToNameDic[ot.TRANSFORM]="TRANSFORM",QuickTestTool._typeToNameDic[ot.TEXTURE]="TEXTURE",QuickTestTool._typeToNameDic[ot.GRAPHICS]="GRAPHICS",QuickTestTool._typeToNameDic[ot.ONECHILD]="ONECHILD",QuickTestTool._typeToNameDic[ot.CHILDS]="CHILDS",QuickTestTool._typeToNameDic[ot.TRANSFORM|ot.ALPHA]="TRANSFORM|ALPHA",QuickTestTool._typeToNameDic[ot.CANVAS]="CANVAS",QuickTestTool._typeToNameDic[ot.BLEND]="BLEND",QuickTestTool._typeToNameDic[ot.FILTERS]="FILTERS",QuickTestTool._typeToNameDic[ot.MASK]="MASK",QuickTestTool._typeToNameDic[ot.CLIP]="CLIP",QuickTestTool._typeToNameDic[ot.LAYAGL3D]="LAYAGL3D"}},{key:"_countStart",value:function(){var e;for(e in QuickTestTool._countDic)QuickTestTool._countDic[e]=0}},{key:"_countEnd",value:function(){QuickTestTool._i++,QuickTestTool._i>60&&(QuickTestTool.showCountInfo(),QuickTestTool._i=0)}},{key:"_addType",value:function(e){QuickTestTool._countDic[e]?QuickTestTool._countDic[e]+=1:QuickTestTool._countDic[e]=1}},{key:"showCountInfo",value:function(){var e;for(e in console.log("==================="),QuickTestTool._countDic)console.log("count:"+QuickTestTool._countDic[e]),QuickTestTool.showRenderTypeInfo(e,!0)}},{key:"enableQuickTest",value:function(){QuickTestTool.__init__(),St.prototype.render=QuickTestTool.prototype.render,QuickTestTool._PreStageRender=Pt.prototype.render,Pt.prototype.render=QuickTestTool.prototype._stageRender}}]),QuickTestTool}();nn.showedDic={},nn._rendertypeToStrDic={},nn._typeToNameDic={},nn._countDic={},nn._i=0;var rn=function(e){function Sound(){return _classCallCheck(this,Sound),_possibleConstructorReturn(this,_getPrototypeOf(Sound).apply(this,arguments))}return _inherits(Sound,e),_createClass(Sound,[{key:"load",value:function(e){}},{key:"play",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0],arguments.length>1&&void 0!==arguments[1]&&arguments[1];return null}},{key:"dispose",value:function(){}},{key:"duration",get:function(){return 0}}]),Sound}(T),an=function(e){function SoundNode(){var e;return _classCallCheck(this,SoundNode),(e=_possibleConstructorReturn(this,_getPrototypeOf(SoundNode).call(this))).visible=!1,e.on(We.ADDED,_assertThisInitialized(e),e._onParentChange),e.on(We.REMOVED,_assertThisInitialized(e),e._onParentChange),e}return _inherits(SoundNode,e),_createClass(SoundNode,[{key:"_onParentChange",value:function(){this.target=this.parent}},{key:"play",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;isNaN(e)&&(e=1),this.url&&(this.stop(),this._channel=Nt.playSound(this.url,e,t))}},{key:"stop",value:function(){this._channel&&!this._channel.isStopped&&this._channel.stop(),this._channel=null}},{key:"_setPlayAction",value:function(e,t,i){var n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this[i]&&e&&(n?e.on(t,this,this[i]):e.off(t,this,this[i]))}},{key:"_setPlayActions",value:function(e,t,i){var n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(e&&t){var r,a,s=t.split(",");for(a=s.length,r=0;r<a;r++)this._setPlayAction(e,s[r],i,n)}}},{key:"playEvent",set:function(e){this._playEvents=e,e&&this._tar&&this._setPlayActions(this._tar,e,"play")}},{key:"target",set:function(e){this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!1),this._setPlayActions(this._tar,this._stopEvents,"stop",!1)),this._tar=e,this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!0),this._setPlayActions(this._tar,this._stopEvents,"stop",!0))}},{key:"stopEvent",set:function(e){this._stopEvents=e,e&&this._tar&&this._setPlayActions(this._tar,e,"stop")}}]),SoundNode}(St);mt.regClass("laya.media.SoundNode",an),mt.regClass("Laya.SoundNode",an);var sn=function(){function ResourceVersion(){_classCallCheck(this,ResourceVersion)}return _createClass(ResourceVersion,null,[{key:"enable",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;ResourceVersion.type=n,i.loader.load(e,m.create(null,ResourceVersion.onManifestLoaded,[t]),null,Yt.JSON)}},{key:"onManifestLoaded",value:function(e,t){ResourceVersion.manifest=t,x.customFormat=ResourceVersion.addVersionPrefix,e.run(),t||console.warn("资源版本清单文件不存在，不使用资源版本管理。忽略ERR_FILE_NOT_FOUND错误。")}},{key:"addVersionPrefix",value:function(e){return e=x.getAdptedFilePath(e),ResourceVersion.manifest&&ResourceVersion.manifest[e]?ResourceVersion.type==ResourceVersion.FILENAME_VERSION?ResourceVersion.manifest[e]:ResourceVersion.manifest[e]+"/"+e:e}}]),ResourceVersion}();sn.FOLDER_VERSION=1,sn.FILENAME_VERSION=2,sn.type=sn.FOLDER_VERSION;var on,ln=function(e){function Socket(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return _classCallCheck(this,Socket),(e=_possibleConstructorReturn(this,_getPrototypeOf(Socket).call(this))).disableInput=!1,e.protocols=[],e._byteClass=n||A,e.protocols=r,e.endian=Socket.BIG_ENDIAN,t&&i>0&&i<65535&&e.connect(t,i),e}return _inherits(Socket,e),_createClass(Socket,[{key:"connect",value:function(e,t){var i="ws://"+e+":"+t;this.connectByUrl(i)}},{key:"connectByUrl",value:function(e){var t=this;null!=this._socket&&this.close(),this._socket&&this.cleanSocket(),this.protocols&&0!=this.protocols.length?this._socket=new Ke.window.WebSocket(e,this.protocols):this._socket=new Ke.window.WebSocket(e),this._socket.binaryType="arraybuffer",this._output=new this._byteClass,this._output.endian=this.endian,this._input=new this._byteClass,this._input.endian=this.endian,this._addInputPosition=0,this._socket.onopen=function(e){t._onOpen(e)},this._socket.onmessage=function(e){t._onMessage(e)},this._socket.onclose=function(e){t._onClose(e)},this._socket.onerror=function(e){t._onError(e)}}},{key:"cleanSocket",value:function(){this.close(),this._connected=!1,this._socket.onopen=null,this._socket.onmessage=null,this._socket.onclose=null,this._socket.onerror=null,this._socket=null}},{key:"close",value:function(){if(null!=this._socket)try{this._socket.close()}catch(e){}}},{key:"_onOpen",value:function(e){this._connected=!0,this.event(We.OPEN,e)}},{key:"_onMessage",value:function(e){if(e&&e.data){var t=e.data;if(this.disableInput&&t)this.event(We.MESSAGE,t);else{this._input.length>0&&this._input.bytesAvailable<1&&(this._input.clear(),this._addInputPosition=0);var i=this._input.pos;!this._addInputPosition&&(this._addInputPosition=0),this._input.pos=this._addInputPosition,t&&("string"==typeof t?this._input.writeUTFBytes(t):this._input.writeArrayBuffer(t),this._addInputPosition=this._input.pos,this._input.pos=i),this.event(We.MESSAGE,t)}}}},{key:"_onClose",value:function(e){this._connected=!1,this.event(We.CLOSE,e)}},{key:"_onError",value:function(e){this.event(We.ERROR,e)}},{key:"send",value:function(e){this._socket.send(e)}},{key:"flush",value:function(){if(this._output&&this._output.length>0){var e;try{this._socket&&this._socket.send(this._output.__getBuffer().slice(0,this._output.length))}catch(t){e=t}this._output.endian=this.endian,this._output.clear(),e&&this.event(We.ERROR,e)}}},{key:"input",get:function(){return this._input}},{key:"output",get:function(){return this._output}},{key:"connected",get:function(){return this._connected}},{key:"endian",get:function(){return this._endian},set:function(e){this._endian=e,null!=this._input&&(this._input.endian=e),null!=this._output&&(this._output.endian=e)}}]),Socket}(T);ln.LITTLE_ENDIAN="littleEndian",ln.BIG_ENDIAN="bigEndian",(on=e.TextureDecodeFormat||(e.TextureDecodeFormat={}))[on.Normal=0]="Normal",on[on.RGBM=1]="RGBM";var hn=function(t){function VideoTexture(){var t;_classCallCheck(this,VideoTexture);var i=g.instance;return(t=_possibleConstructorReturn(this,_getPrototypeOf(VideoTexture).call(this,i.RGB,!1)))._glTextureType=i.TEXTURE_2D,t._width=1,t._height=1,t._wrapModeU=t._wrapModeV=e.WarpMode.Clamp,t._filterMode=e.FilterMode.Bilinear,t._setWarpMode(i.TEXTURE_WRAP_S,t._wrapModeU),t._setWarpMode(i.TEXTURE_WRAP_T,t._wrapModeV),t._setFilterMode(t._filterMode),t._needUpdate=!1,t._readyed=!0,VideoTexture._videoTexturePool.push(_assertThisInitialized(t)),t}return _inherits(VideoTexture,t),_createClass(VideoTexture,[{key:"_updateVideoData",value:function(){if(this._video&&this._needUpdate){var e=g.instance;y.bindTexture(e,this._glTextureType,this._glTexture),e.texImage2D(this._glTextureType,0,e.RGB,e.RGB,e.UNSIGNED_BYTE,this._video)}}},{key:"videoPlay",value:function(){this._video.play(),this._needUpdate=!0}},{key:"videoPause",value:function(){this._video.pause(),this._needUpdate=!1}},{key:"destroy",value:function(){_get(_getPrototypeOf(VideoTexture.prototype),"destroy",this).call(this),this._video=null}},{key:"video",get:function(){return this._video},set:function(e){e&&e instanceof HTMLVideoElement&&(this._video=e,xi.Browser.onMobile&&(this._video["x5-playsInline"]=!0,this._video["x5-playsinline"]=!0,this._video.x5PlaysInline=!0,this._video.playsInline=!0,this._video["webkit-playsInline"]=!0,this._video["webkit-playsinline"]=!0,this._video.webkitPlaysInline=!0,this._video.playsinline=!0,this._video.style.playsInline=!0,this._video.crossOrigin="anonymous",this._video.setAttribute("crossorigin","anonymous"),this._video.setAttribute("playsinline","true"),this._video.setAttribute("x5-playsinline","true"),this._video.setAttribute("webkit-playsinline","true"),this._video.autoplay=!0))}}],[{key:"_update",value:function(){for(var e=VideoTexture._videoTexturePool,t=0,i=e.length;t<i;t++){var n=e[t];n&&n._updateVideoData()}}}]),VideoTexture}(M);hn._videoTexturePool=new Array;var un=function(){function System(){_classCallCheck(this,System)}return _createClass(System,null,[{key:"changeDefinition",value:function(e,t){window.Laya[e]=t;var i=e+"=classObj";window.eval(i)}}]),System}(),cn=function(){function HTMLChar(){_classCallCheck(this,HTMLChar),this.reset()}return _createClass(HTMLChar,[{key:"setData",value:function(e,t,i,n){return this.char=e,this.charNum=e.charCodeAt(0),this.x=this.y=0,this.width=t,this.height=i,this.style=n,this.isWord=!HTMLChar._isWordRegExp.test(e),this}},{key:"reset",value:function(){return this.x=this.y=this.width=this.height=0,this.isWord=!1,this.char=null,this.charNum=0,this.style=null,this}},{key:"recover",value:function(){n.recover("HTMLChar",this.reset())}},{key:"_isChar",value:function(){return!0}},{key:"_getCSSStyle",value:function(){return this.style}}],[{key:"create",value:function(){return n.getItemByClass("HTMLChar",HTMLChar)}}]),HTMLChar}();cn._isWordRegExp=new RegExp("[\\w.]","");var _n=function(){function Log(){_classCallCheck(this,Log)}return _createClass(Log,null,[{key:"enable",value:function(){Log._logdiv||(Log._logdiv=Ke.createElement("div"),Log._logdiv.style.cssText="border:white;padding:4px;overflow-y:auto;z-index:1000000;background:rgba(100,100,100,0.6);color:white;position: absolute;left:0px;top:0px;width:50%;height:50%;",Ke.document.body.appendChild(Log._logdiv),Log._btn=Ke.createElement("button"),Log._btn.innerText="Hide",Log._btn.style.cssText="z-index:1000001;position: absolute;left:10px;top:10px;",Log._btn.onclick=Log.toggle,Ke.document.body.appendChild(Log._btn))}},{key:"toggle",value:function(){var e=Log._logdiv.style;""===e.display?(Log._btn.innerText="Show",e.display="none"):(Log._btn.innerText="Hide",e.display="")}},{key:"print",value:function(e){Log._logdiv&&(Log._count>=Log.maxCount&&Log.clear(),Log._count++,Log._logdiv.innerText+=e+"\n",Log.autoScrollToBottom&&Log._logdiv.scrollHeight-Log._logdiv.scrollTop-Log._logdiv.clientHeight<50&&(Log._logdiv.scrollTop=Log._logdiv.scrollHeight))}},{key:"clear",value:function(){Log._logdiv.innerText="",Log._count=0}}]),Log}();_n._count=0,_n.maxCount=50,_n.autoScrollToBottom=!0;var dn=300,fn=function(){function PerfData(e,t,i,n){_classCallCheck(this,PerfData),this.scale=1,this.datas=new Array(dn),this.datapos=0,this.id=e,this.color=t,this.name=i,this.scale=n}return _createClass(PerfData,[{key:"addData",value:function(e){this.datas[this.datapos]=e,this.datapos++,this.datapos%=dn}}]),PerfData}(),vn=function(e){function PerfHUD(){var e;return _classCallCheck(this,PerfHUD),(e=_possibleConstructorReturn(this,_getPrototypeOf(PerfHUD).call(this))).datas=[],e.xdata=new Array(PerfHUD.DATANUM),e.ydata=new Array(PerfHUD.DATANUM),e.hud_width=800,e.hud_height=200,e.gMinV=0,e.gMaxV=100,e.textSpace=40,e.sttm=0,PerfHUD.inst=_assertThisInitialized(e),e._renderType|=ot.CUSTOM,e._setRenderType(e._renderType),e._setCustomRender(),e.addDataDef(0,16777215,"frame",1),e.addDataDef(1,65280,"update",1),e.addDataDef(2,16711680,"flush",1),PerfHUD._now=performance?performance.now.bind(performance):Date.now,e}return _inherits(PerfHUD,e),_createClass(PerfHUD,[{key:"now",value:function(){return PerfHUD._now()}},{key:"start",value:function(){this.sttm=PerfHUD._now()}},{key:"end",value:function(e){var t=PerfHUD._now()-this.sttm;this.updateValue(e,t)}},{key:"config",value:function(e,t){this.hud_width=e,this.hud_height=t}},{key:"addDataDef",value:function(e,t,i,n){this.datas[e]=new fn(e,t,i,n)}},{key:"updateValue",value:function(e,t){this.datas[e].addData(t)}},{key:"v2y",value:function(e){this._y,this.hud_height,this.gMinV,this.gMaxV;return this._y+this.hud_height*(1-(e-this.gMinV)/this.gMaxV)}},{key:"drawHLine",value:function(e,t,i,n){var r=this._x,a=(this._x,this.hud_width,this.v2y(t));e.fillText(n,r,a-6,null,"green",null),r+=this.textSpace,e.fillStyle=i,e.fillRect(r,a,this._x+this.hud_width,1,null)}},{key:"customRender",value:function(e,t,i){var n=performance.now();PerfHUD._lastTm<=0&&(PerfHUD._lastTm=n),this.updateValue(0,n-PerfHUD._lastTm),PerfHUD._lastTm=n,e.save(),e.fillRect(this._x,this._y,this.hud_width,this.hud_height+4,"#000000cc"),e.globalAlpha=.9,this.drawHLine(e,0,"green","    0"),this.drawHLine(e,10,"green","  10"),this.drawHLine(e,16.667,"red"," "),this.drawHLine(e,20,"green","50|20"),this.drawHLine(e,33.334,"yellow",""),this.drawHLine(e,16.667*3,"yellow",""),this.drawHLine(e,66.668,"yellow",""),this.drawHLine(e,50,"green","20|50"),this.drawHLine(e,100,"green","10|100");for(var r=0,a=this.datas.length;r<a;r++){var s=this.datas[r];if(s){var o=s.datas.length,l=(this.hud_width-this.textSpace)/o,h=s.datapos,u=this._x+this.textSpace;e.fillStyle=s.color;for(var c=o;h<c;h++){var _=this.v2y(s.datas[h]*s.scale);e.fillRect(u,_,l,this.hud_height+this._y-_,null),u+=l}for(h=0;h<s.datapos;h++)_=this.v2y(s.datas[h]*s.scale),e.fillRect(u,_,l,this.hud_height+this._y-_,null),u+=l}}e.restore()}}]),PerfHUD}(St);vn._lastTm=0,vn._now=null,vn.DATANUM=300,vn.drawTexTm=0;var pn=function(){function PoolCache(){_classCallCheck(this,PoolCache),this.maxCount=1e3}return _createClass(PoolCache,[{key:"getCacheList",value:function(){return n.getPoolBySign(this.sign)}},{key:"tryDispose",value:function(e){var t;(t=n.getPoolBySign(this.sign)).length>this.maxCount&&t.splice(this.maxCount,t.length-this.maxCount)}}],[{key:"addPoolCacheManager",value:function(e){var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;(t=new PoolCache).sign=e,t.maxCount=i,ct.regCacheByFunction(j.bind(t.tryDispose,t),j.bind(t.getCacheList,t))}}]),PoolCache}(),gn=function(e){function TimeLine(){var e;return _classCallCheck(this,TimeLine),(e=_possibleConstructorReturn(this,_getPrototypeOf(TimeLine).apply(this,arguments)))._tweenDic={},e._tweenDataList=[],e._currTime=0,e._lastTime=0,e._startTime=0,e._index=0,e._gidIndex=0,e._firstTweenDic={},e._startTimeSort=!1,e._endTimeSort=!1,e._loopKey=!1,e.scale=1,e._frameRate=60,e._frameIndex=0,e._total=0,e}return _inherits(TimeLine,e),_createClass(TimeLine,[{key:"to",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return this._create(e,t,i,n,r,!0)}},{key:"from",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return this._create(e,t,i,n,r,!1)}},{key:"_create",value:function(e,t,i,r,a,s){var o=n.getItemByClass("tweenData",yn);return o.isTo=s,o.type=0,o.target=e,o.duration=i,o.data=t,o.startTime=this._startTime+a,o.endTime=o.startTime+o.duration,o.ease=r,this._startTime=Math.max(o.endTime,this._startTime),this._tweenDataList.push(o),this._startTimeSort=!0,this._endTimeSort=!0,this}},{key:"addLabel",value:function(e,t){var i=n.getItemByClass("tweenData",yn);return i.type=1,i.data=e,i.endTime=i.startTime=this._startTime+t,this._labelDic||(this._labelDic={}),this._labelDic[e]=i,this._tweenDataList.push(i),this}},{key:"removeLabel",value:function(e){if(this._labelDic&&this._labelDic[e]){var t=this._labelDic[e];if(t){var i=this._tweenDataList.indexOf(t);i>-1&&this._tweenDataList.splice(i,1)}delete this._labelDic[e]}}},{key:"gotoTime",value:function(e){if(null!=this._tweenDataList&&0!=this._tweenDataList.length){var t,i,r,a;for(var s in this._firstTweenDic)if(i=this._firstTweenDic[s])for(var o in i)o in i.diyTarget&&(i.diyTarget[o]=i[o]);for(s in this._tweenDic)(t=this._tweenDic[s]).clear(),delete this._tweenDic[s];if(this._index=0,this._gidIndex=0,this._currTime=e,this._lastTime=Ke.now(),null==this._endTweenDataList||this._endTimeSort){this._endTimeSort=!1,this._endTweenDataList=r=this._tweenDataList.concat(),r.sort((function(e,t){return e.endTime>t.endTime?1:e.endTime<t.endTime?-1:0}))}else r=this._endTweenDataList;for(var l=0,h=r.length;l<h;l++)if(0==(a=r[l]).type){if(!(e>=a.endTime))break;this._index=Math.max(this._index,l+1);var u=a.data;if(a.isTo)for(var c in u)a.target[c]=u[c]}for(l=0,h=this._tweenDataList.length;l<h;l++)0==(a=this._tweenDataList[l]).type&&e>=a.startTime&&e<a.endTime&&(this._index=Math.max(this._index,l+1),this._gidIndex++,(t=n.getItemByClass("tween",$t))._create(a.target,a.data,a.duration,a.ease,m.create(this,this._animComplete,[this._gidIndex]),0,!1,a.isTo,!0,!1),t.setStartTime(this._currTime-(e-a.startTime)),t._updateEase(this._currTime),t.gid=this._gidIndex,this._tweenDic[this._gidIndex]=t)}}},{key:"gotoLabel",value:function(e){if(null!=this._labelDic){var t=this._labelDic[e];t&&this.gotoTime(t.startTime)}}},{key:"pause",value:function(){i.timer.clear(this,this._update)}},{key:"resume",value:function(){this.play(this._currTime,this._loopKey)}},{key:"play",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._tweenDataList){if(this._startTimeSort){var Compare=function(e,t){return e.startTime>t.startTime?1:e.startTime<t.startTime?-1:0};this._startTimeSort=!1,this._tweenDataList.sort(Compare);for(var n=0,r=this._tweenDataList.length;n<r;n++){var a=this._tweenDataList[n];if(null!=a&&0==a.type){var s=a.target,o=s.$_GID||(s.$_GID=j.getGID()),l=null;for(var h in null==this._firstTweenDic[o]?((l={}).diyTarget=s,this._firstTweenDic[o]=l):l=this._firstTweenDic[o],a.data)null==l[h]&&(l[h]=s[h])}}}"string"==typeof e?this.gotoLabel(e):this.gotoTime(e),this._loopKey=t,this._lastTime=Ke.now(),i.timer.frameLoop(1,this,this._update)}}},{key:"_update",value:function(){if(this._currTime>=this._startTime){if(!this._loopKey){for(var e in this._tweenDic)(t=this._tweenDic[e]).complete();return this.pause(),void this._complete()}if(this._complete(),!this._tweenDataList)return;this.gotoTime(0)}var t,i=Ke.now(),r=i-this._lastTime,a=this._currTime+=r*this.scale;for(e in this._lastTime=i,this._tweenDic)(t=this._tweenDic[e])._updateEase(a);if(0!=this._tweenDataList.length&&this._index<this._tweenDataList.length){var s=this._tweenDataList[this._index];a>=s.startTime&&(this._index++,0==s.type?(this._gidIndex++,(t=n.getItemByClass("tween",$t))._create(s.target,s.data,s.duration,s.ease,m.create(this,this._animComplete,[this._gidIndex]),0,!1,s.isTo,!0,!1),t.setStartTime(a),t.gid=this._gidIndex,this._tweenDic[this._gidIndex]=t,t._updateEase(a)):this.event(We.LABEL,s.data))}}},{key:"_animComplete",value:function(e){this._tweenDic[e]&&delete this._tweenDic[e]}},{key:"_complete",value:function(){this.event(We.COMPLETE)}},{key:"reset",value:function(){var e,t,n;if(this._labelDic)for(e in this._labelDic)delete this._labelDic[e];for(e in this._tweenDic)this._tweenDic[e].clear(),delete this._tweenDic[e];for(e in this._firstTweenDic)delete this._firstTweenDic[e];if(this._endTweenDataList=null,this._tweenDataList&&this._tweenDataList.length)for(n=this._tweenDataList.length,t=0;t<n;t++)this._tweenDataList[t]&&this._tweenDataList[t].destroy();this._tweenDataList.length=0,this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._gidIndex=0,this.scale=1,i.timer.clear(this,this._update)}},{key:"destroy",value:function(){this.reset(),this._labelDic=null,this._tweenDic=null,this._tweenDataList=null,this._firstTweenDic=null}},{key:"index",get:function(){return this._frameIndex},set:function(e){this._frameIndex=e,this.gotoTime(this._frameIndex/this._frameRate*1e3)}},{key:"total",get:function(){return this._total=Math.floor(this._startTime/1e3*this._frameRate),this._total}}],[{key:"to",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return(new TimeLine).to(e,t,i,n,r)}},{key:"from",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return(new TimeLine).from(e,t,i,n,r)}}]),TimeLine}(T),yn=function(){function tweenData(){_classCallCheck(this,tweenData),this.type=0,this.isTo=!0}return _createClass(tweenData,[{key:"destroy",value:function(){this.target=null,this.ease=null,this.data=null,this.isTo=!0,this.type=0,n.recover("tweenData",this)}}]),tweenData}(),mn=function(){function ArabicReshaper(){_classCallCheck(this,ArabicReshaper)}return _createClass(ArabicReshaper,[{key:"characterMapContains",value:function(e){for(var t=0;t<ArabicReshaper.charsMap.length;++t)if(ArabicReshaper.charsMap[t][0]===e)return!0;return!1}},{key:"getCharRep",value:function(e){for(var t=0;t<ArabicReshaper.charsMap.length;++t)if(ArabicReshaper.charsMap[t][0]===e)return ArabicReshaper.charsMap[t];return!1}},{key:"getCombCharRep",value:function(e,t){for(var i=0;i<ArabicReshaper.combCharsMap.length;++i)if(ArabicReshaper.combCharsMap[i][0][0]===e&&ArabicReshaper.combCharsMap[i][0][1]===t)return ArabicReshaper.combCharsMap[i];return!1}},{key:"isTransparent",value:function(e){for(var t=0;t<ArabicReshaper.transChars.length;++t)if(ArabicReshaper.transChars[t]===e)return!0;return!1}},{key:"getOriginalCharsFromCode",value:function(e){var t;for(t=0;t<ArabicReshaper.charsMap.length;++t)if(ArabicReshaper.charsMap[t].indexOf(e)>-1)return String.fromCharCode(ArabicReshaper.charsMap[t][0]);for(t=0;t<ArabicReshaper.combCharsMap.length;++t)if(ArabicReshaper.combCharsMap[t].indexOf(e)>-1)return String.fromCharCode(ArabicReshaper.combCharsMap[t][0][0])+String.fromCharCode(ArabicReshaper.combCharsMap[t][0][1]);return String.fromCharCode(e)}},{key:"convertArabic",value:function(e){for(var t,i,n="",r=0;r<e.length;++r){var a=e.charCodeAt(r);if(this.characterMapContains(a)){for(var s=null,o=null,l=r-1,h=r+1;l>=0&&this.isTransparent(e.charCodeAt(l));--l);for((!(t=!!(s=l>=0?e.charCodeAt(l):null)&&this.getCharRep(s))||null==t[2]&&null==t[3])&&(s=null);h<e.length&&this.isTransparent(e.charCodeAt(h));++h);if((!(t=!!(o=h<e.length?e.charCodeAt(h):null)&&this.getCharRep(o))||null==t[3]&&null==t[4])&&(o=null),1604===a&&null!=o&&(1570===o||1571===o||1573===o||1575===o)){i=this.getCombCharRep(a,o),n+=null!=s?String.fromCharCode(i[4]):String.fromCharCode(i[1]),++r;continue}if(t=this.getCharRep(a),null!=s&&null!=o&&null!=t[3]){n+=String.fromCharCode(t[3]);continue}if(null!=s&&null!=t[4]){n+=String.fromCharCode(t[4]);continue}if(null!=o&&null!=t[2]){n+=String.fromCharCode(t[2]);continue}n+=String.fromCharCode(t[1])}else n+=String.fromCharCode(a)}return n}},{key:"convertArabicBack",value:function(e){var t,i,n="";for(i=0;i<e.length;++i)t=e.charCodeAt(i),n+=this.getOriginalCharsFromCode(t);return n}}]),ArabicReshaper}();mn.charsMap=[[1569,65152,null,null,null],[1570,65153,null,null,65154],[1571,65155,null,null,65156],[1572,65157,null,null,65158],[1573,65159,null,null,65160],[1574,65161,65163,65164,65162],[1575,65165,null,null,65166],[1576,65167,65169,65170,65168],[1577,65171,null,null,65172],[1578,65173,65175,65176,65174],[1579,65177,65179,65180,65178],[1580,65181,65183,65184,65182],[1581,65185,65187,65188,65186],[1582,65189,65191,65192,65190],[1583,65193,null,null,65194],[1584,65195,null,null,65196],[1585,65197,null,null,65198],[1586,65199,null,null,65200],[1587,65201,65203,65204,65202],[1588,65205,65207,65208,65206],[1589,65209,65211,65212,65210],[1590,65213,65215,65216,65214],[1591,65217,65219,65220,65218],[1592,65221,65223,65224,65222],[1593,65225,65227,65228,65226],[1594,65229,65231,65232,65230],[1600,1600,1600,1600,1600],[1601,65233,65235,65236,65234],[1602,65237,65239,65240,65238],[1603,65241,65243,65244,65242],[1604,65245,65247,65248,65246],[1605,65249,65251,65252,65250],[1606,65253,65255,65256,65254],[1607,65257,65259,65260,65258],[1608,65261,null,null,65262],[1609,65263,null,null,65264],[1610,65265,65267,65268,65266],[1662,64342,64344,64345,64343],[1740,64508,64510,64511,64509],[1670,64378,64380,64381,64379],[1705,64398,64400,64401,64399],[1711,64402,64404,64405,64403],[1688,64394,null,null,64395]],mn.combCharsMap=[[[1604,1570],65269,null,null,65270],[[1604,1571],65271,null,null,65272],[[1604,1573],65273,null,null,65274],[[1604,1575],65275,null,null,65276]],mn.transChars=[1552,1554,1555,1556,1557,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1648,1750,1751,1752,1753,1754,1755,1756,1759,1760,1761,1762,1763,1764,1767,1768,1770,1771,1772,1773];var Tn=function(){function MatirxArray(){_classCallCheck(this,MatirxArray)}return _createClass(MatirxArray,null,[{key:"ArrayMul",value:function(e,t,i){if(e)if(t)for(var n,r,a,s,o=0;o<4;o++)n=e[o],r=e[o+4],a=e[o+8],s=e[o+12],i[o]=n*t[0]+r*t[1]+a*t[2]+s*t[3],i[o+4]=n*t[4]+r*t[5]+a*t[6]+s*t[7],i[o+8]=n*t[8]+r*t[9]+a*t[10]+s*t[11],i[o+12]=n*t[12]+r*t[13]+a*t[14]+s*t[15];else MatirxArray.copyArray(e,i);else MatirxArray.copyArray(t,i)}},{key:"copyArray",value:function(e,t){if(e&&t)for(var i=0;i<e.length;i++)t[i]=e[i]}}]),MatirxArray}();return e.AlphaCmd=r,e.Animation=Bi,e.AnimationBase=ti,e.ArabicReshaper=mn,e.AtlasGrid=Ge,e.AtlasInfoManager=Xt,e.AudioSound=Ft,e.AudioSoundChannel=Ot,e.BasePoly=Ae,e.BaseShader=P,e.BaseTexture=M,e.Bezier=re,e.Bitmap=E,e.BitmapFont=Vt,e.BlendMode=F,e.BlurFilter=Vi,e.BlurFilterGLRender=Wi,e.BlurFilterSetter=Hi,e.BoundsStyle=Tt,e.Browser=Ke,e.Buffer=ge,e.Buffer2D=me,e.BufferState2D=pe,e.BufferStateBase=ve,e.ButtonEffect=Yi,e.Byte=A,e.CONST3D2D=Ie,e.CacheManger=ct,e.CacheStyle=Ct,e.CallLater=wt,e.CharRenderInfo=Xe,e.CharRender_Canvas=je,e.CharRender_Native=Qe,e.CharSubmitCache=Fe,e.ClassUtils=mt,e.ClipRectCmd=lt,e.ColorFilter=q,e.ColorFilterSetter=Xi,e.ColorUtils=Q,e.CommandEncoder=en,e.CommonScript=Li,e.Component=ei,e.Config=t,e.Const=ft,e.Context=Ze,e.Dragging=Jt,e.Draw9GridTexture=rt,e.DrawCircleCmd=a,e.DrawCurvesCmd=s,e.DrawImageCmd=o,e.DrawLineCmd=l,e.DrawLinesCmd=h,e.DrawParticleCmd=Ui,e.DrawPathCmd=u,e.DrawPieCmd=c,e.DrawPolyCmd=_,e.DrawRectCmd=d,e.DrawStyle=se,e.DrawTextureCmd=Z,e.DrawTexturesCmd=ht,e.DrawTrianglesCmd=nt,e.Earcut=Le,e.EarcutNode=we,e.Ease=Zt,e.EffectAnimation=Oi,e.EffectBase=zi,e.Event=We,e.EventDispatcher=T,e.FadeIn=Ki,e.FadeOut=ji,e.FillTextCmd=ut,e.FillTextureCmd=$,e.Filter=K,e.FilterSetterBase=Ni,e.FontInfo=He,e.FrameAnimation=ni,e.GlowFilter=qi,e.GlowFilterGLRender=Qi,e.GlowFilterSetter=Zi,e.GrahamScan=ae,e.GraphicAnimation=Pi,e.Graphics=dt,e.GraphicsBounds=st,e.HTMLCanvas=gt,e.HTMLChar=cn,e.HTMLImage=Ci,e.Handler=m,e.HitArea=yt,e.HttpRequest=Ht,e.ICharRender=ze,e.ILaya=i,e.IStatRender=li,e.IndexBuffer2D=Te,e.InlcudeFile=vi,e.Input=Et,e.KeyBoardManager=Dt,e.KeyLocation=$i,e.Keyboard=Ji,e.Laya=xi,e.LayaGL=g,e.LayaGLQuickRunner=vt,e.LayaGLRunner=tn,e.LayaGPU=tt,e.Loader=Yt,e.LoaderManager=zt,e.LocalStorage=jt,e.Log=_n,e.MathUtil=ii,e.MatirxArray=Tn,e.Matrix=f,e.Mesh2D=xe,e.MeshParticle2D=Ti,e.MeshQuadTexture=ke,e.MeshTexture=Se,e.MeshVG=Re,e.Mouse=mi,e.MouseManager=At,e.Node=kt,e.Path=oe,e.PerfData=fn,e.PerfHUD=vn,e.Point=v,e.Pool=n,e.PoolCache=pn,e.Prefab=Wt,e.PrimitiveSV=di,e.QuickTestTool=nn,e.Rectangle=p,e.Render=it,e.RenderInfo=ye,e.RenderSprite=pt,e.RenderState2D=D,e.RenderTexture2D=B,e.Resource=k,e.ResourceVersion=sn,e.RestoreCmd=J,e.RotateCmd=ee,e.RunDriver=It,e.SaveBase=ue,e.SaveClipRect=ce,e.SaveCmd=at,e.SaveMark=_e,e.SaveTransform=de,e.SaveTranslate=fe,e.ScaleCmd=te,e.Scene=Gi,e.SceneLoader=Fi,e.SceneUtils=ai,e.Script=Ii,e.Shader=V,e.Shader2D=Ee,e.Shader2X=H,e.ShaderCompile=gi,e.ShaderDefines2D=U,e.ShaderDefinesBase=G,e.ShaderNode=pi,e.ShaderValue=function ShaderValue(){_classCallCheck(this,ShaderValue)},e.SkinMeshBuffer=Me,e.SkinSV=_i,e.Socket=ln,e.Sound=rn,e.SoundChannel=Bt,e.SoundManager=Nt,e.SoundNode=an,e.Sprite=St,e.SpriteConst=ot,e.SpriteStyle=xt,e.Stage=Pt,e.Stat=N,e.StatUI=hi,e.StringKey=W,e.Submit=Pe,e.SubmitBase=he,e.SubmitCMD=z,e.SubmitCanvas=De,e.SubmitKey=X,e.SubmitTarget=Be,e.SubmitTexture=Oe,e.System=un,e.SystemUtils=et,e.TTFLoader=qt,e.Text=bt,e.TextAtlas=Ne,e.TextRender=qe,e.TextStyle=Rt,e.TextTexture=Ue,e.Texture=Ve,e.Texture2D=w,e.TextureSV=fi,e.TimeLine=gn,e.Timer=ui,e.TouchManager=Mt,e.TransformCmd=ie,e.TranslateCmd=ne,e.Tween=$t,e.URL=x,e.Utils=j,e.Value2D=Y,e.VectorGraphManager=_t,e.VertexArrayObject=function VertexArrayObject(){_classCallCheck(this,VertexArrayObject)},e.VertexBuffer2D=Ce,e.VideoTexture=hn,e.WeakObject=ri,e.WebAudioSound=Ut,e.WebAudioSoundChannel=Gt,e.WebGL=Je,e.WebGLCacheAsNormalCanvas=be,e.WebGLContext=y,e.WebGLRTMgr=O,e.WordText=Ye,e.WorkerLoader=yi,e.__init=bi,e._static=_static,e.alertGlobalError=Ai,e.enableDebugPanel=wi,e.init=Ei,e.isWXOpenDataContext=void 0,e.isWXPosMsg=void 0,e.version=Mi,e.static=_static,e}({}); 
 			}); 
		define("__plugin__/wx70d8aa25ec591f7a/laya.d3.js", function(require, module, exports){ 			
"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function set(e,t,r,n){return(set="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(e,t,r,n){var i,a=_superPropBase(e,t);if(a){if((i=Object.getOwnPropertyDescriptor(a,t)).set)return i.set.call(n,r),!0;if(!i.writable)return!1}if(i=Object.getOwnPropertyDescriptor(n,t)){if(!i.writable)return!1;i.value=r,Object.defineProperty(n,t,i)}else _defineProperty(n,t,r);return!0})(e,t,r,n)}function _set(e,t,r,n,i){if(!set(e,t,r,n||e)&&i)throw new Error("failed to set property");return r}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _get(e,t,r){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=_superPropBase(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(r):i.value}})(e,t,r||e)}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}!function(e,t){var r=function(){function MathUtils3D(){_classCallCheck(this,MathUtils3D)}return _createClass(MathUtils3D,null,[{key:"isZero",value:function(e){return Math.abs(e)<MathUtils3D.zeroTolerance}},{key:"nearEqual",value:function(e,t){return!!MathUtils3D.isZero(e-t)}},{key:"fastInvSqrt",value:function(e){return MathUtils3D.isZero(e)?e:1/Math.sqrt(e)}}]),MathUtils3D}();r.zeroTolerance=1e-6,r.MaxValue=340282347e30,r.MinValue=-340282347e30,r.Deg2Rad=Math.PI/180;var n=function(){function Vector2(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;_classCallCheck(this,Vector2),this.x=e,this.y=t}return _createClass(Vector2,[{key:"setValue",value:function(e,t){this.x=e,this.y=t}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e[t+0],this.y=e[t+1]}},{key:"cloneTo",value:function(e){var t=e;t.x=this.x,t.y=this.y}},{key:"clone",value:function(){var e=new Vector2;return this.cloneTo(e),e}},{key:"forNativeElement",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y):this.elements=new Float32Array([this.x,this.y]),Vector2.rewriteNumProperty(this,"x",0),Vector2.rewriteNumProperty(this,"y",1)}}],[{key:"scale",value:function(e,t,r){r.x=e.x*t,r.y=e.y*t}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"normalize",value:function(e,t){var r=e.x,n=e.y,i=r*r+n*n;i>0&&(i=1/Math.sqrt(i),t.x=r*i,t.y=n*i)}},{key:"scalarLength",value:function(e){var t=e.x,r=e.y;return Math.sqrt(t*t+r*r)}},{key:"rewriteNumProperty",value:function(e,t,r){Object.defineProperty(e,t,{get:function(){return this.elements[r]},set:function(e){this.elements[r]=e}})}}]),Vector2}();n.ZERO=new n(0,0),n.ONE=new n(1,1);var i=function(){function Vector4(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;_classCallCheck(this,Vector4),this.x=e,this.y=t,this.z=r,this.w=n}return _createClass(Vector4,[{key:"setValue",value:function(e,t,r,n){this.x=e,this.y=t,this.z=r,this.w=n}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}},{key:"cloneTo",value:function(e){var t=e;t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w}},{key:"clone",value:function(){var e=new Vector4;return this.cloneTo(e),e}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSquared",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}},{key:"forNativeElement",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),n.rewriteNumProperty(this,"x",0),n.rewriteNumProperty(this,"y",1),n.rewriteNumProperty(this,"z",2),n.rewriteNumProperty(this,"w",3)}}],[{key:"lerp",value:function(e,t,r,n){var i=e.x,a=e.y,o=e.z,s=e.w;n.x=i+r*(t.x-i),n.y=a+r*(t.y-a),n.z=o+r*(t.z-o),n.w=s+r*(t.w-s)}},{key:"transformByM4x4",value:function(e,t,r){var n=e.x,i=e.y,a=e.z,o=e.w,s=t.elements;r.x=n*s[0]+i*s[4]+a*s[8]+o*s[12],r.y=n*s[1]+i*s[5]+a*s[9]+o*s[13],r.z=n*s[2]+i*s[6]+a*s[10]+o*s[14],r.w=n*s[3]+i*s[7]+a*s[11]+o*s[15]}},{key:"equals",value:function(e,t){return r.nearEqual(Math.abs(e.x),Math.abs(t.x))&&r.nearEqual(Math.abs(e.y),Math.abs(t.y))&&r.nearEqual(Math.abs(e.z),Math.abs(t.z))&&r.nearEqual(Math.abs(e.w),Math.abs(t.w))}},{key:"normalize",value:function(e,t){var r=e.length();if(r>0){var n=1/r;t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n}}},{key:"add",value:function(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z,r.w=e.w+t.w}},{key:"subtract",value:function(e,t,r){r.x=e.x-t.x,r.y=e.y-t.y,r.z=e.z-t.z,r.w=e.w-t.w}},{key:"multiply",value:function(e,t,r){r.x=e.x*t.x,r.y=e.y*t.y,r.z=e.z*t.z,r.w=e.w*t.w}},{key:"scale",value:function(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t,r.w=e.w*t}},{key:"Clamp",value:function(e,t,r,n){var i=e.x,a=e.y,o=e.z,s=e.w,l=t.x,u=t.y,c=t.z,h=t.w,_=r.x,d=r.y,f=r.z,m=r.w;i=(i=i>_?_:i)<l?l:i,a=(a=a>d?d:a)<u?u:a,o=(o=o>f?f:o)<c?c:o,s=(s=s>m?m:s)<h?h:s,n.x=i,n.y=a,n.z=o,n.w=s}},{key:"distanceSquared",value:function(e,t){var r=e.x-t.x,n=e.y-t.y,i=e.z-t.z,a=e.w-t.w;return r*r+n*n+i*i+a*a}},{key:"distance",value:function(e,t){var r=e.x-t.x,n=e.y-t.y,i=e.z-t.z,a=e.w-t.w;return Math.sqrt(r*r+n*n+i*i+a*a)}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"min",value:function(e,t,r){r.x=Math.min(e.x,t.x),r.y=Math.min(e.y,t.y),r.z=Math.min(e.z,t.z),r.w=Math.min(e.w,t.w)}},{key:"max",value:function(e,t,r){r.x=Math.max(e.x,t.x),r.y=Math.max(e.y,t.y),r.z=Math.max(e.z,t.z),r.w=Math.max(e.w,t.w)}}]),Vector4}();i.ZERO=new i,i.ONE=new i(1,1,1,1),i.UnitX=new i(1,0,0,0),i.UnitY=new i(0,1,0,0),i.UnitZ=new i(0,0,1,0),i.UnitW=new i(0,0,0,1);var a,o=function(){function Vector3(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;arguments.length>3&&void 0!==arguments[3]&&arguments[3];_classCallCheck(this,Vector3),this.x=e,this.y=t,this.z=r}return _createClass(Vector3,[{key:"setValue",value:function(e,t,r){this.x=e,this.y=t,this.z=r}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e[t+0],this.y=e[t+1],this.z=e[t+2]}},{key:"cloneTo",value:function(e){var t=e;t.x=this.x,t.y=this.y,t.z=this.z}},{key:"clone",value:function(){var e=new Vector3;return this.cloneTo(e),e}},{key:"toDefault",value:function(){this.x=0,this.y=0,this.z=0}},{key:"forNativeElement",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z):this.elements=new Float32Array([this.x,this.y,this.z]),n.rewriteNumProperty(this,"x",0),n.rewriteNumProperty(this,"y",1),n.rewriteNumProperty(this,"z",2)}}],[{key:"distanceSquared",value:function(e,t){var r=e.x-t.x,n=e.y-t.y,i=e.z-t.z;return r*r+n*n+i*i}},{key:"distance",value:function(e,t){var r=e.x-t.x,n=e.y-t.y,i=e.z-t.z;return Math.sqrt(r*r+n*n+i*i)}},{key:"min",value:function(e,t,r){r.x=Math.min(e.x,t.x),r.y=Math.min(e.y,t.y),r.z=Math.min(e.z,t.z)}},{key:"max",value:function(e,t,r){r.x=Math.max(e.x,t.x),r.y=Math.max(e.y,t.y),r.z=Math.max(e.z,t.z)}},{key:"transformQuat",value:function(e,t,r){var n=e.x,i=e.y,a=e.z,o=t.x,s=t.y,l=t.z,u=t.w,c=u*n+s*a-l*i,h=u*i+l*n-o*a,_=u*a+o*i-s*n,d=-o*n-s*i-l*a;r.x=c*u+d*-o+h*-l-_*-s,r.y=h*u+d*-s+_*-o-c*-l,r.z=_*u+d*-l+c*-s-h*-o}},{key:"scalarLength",value:function(e){var t=e.x,r=e.y,n=e.z;return Math.sqrt(t*t+r*r+n*n)}},{key:"scalarLengthSquared",value:function(e){var t=e.x,r=e.y,n=e.z;return t*t+r*r+n*n}},{key:"normalize",value:function(e,t){var r=e.x,n=e.y,i=e.z,a=r*r+n*n+i*i;a>0&&(a=1/Math.sqrt(a),t.x=r*a,t.y=n*a,t.z=i*a)}},{key:"multiply",value:function(e,t,r){r.x=e.x*t.x,r.y=e.y*t.y,r.z=e.z*t.z}},{key:"scale",value:function(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t}},{key:"lerp",value:function(e,t,r,n){var i=e.x,a=e.y,o=e.z;n.x=i+r*(t.x-i),n.y=a+r*(t.y-a),n.z=o+r*(t.z-o)}},{key:"transformV3ToV3",value:function(e,t,r){var n=Vector3._tempVector4;Vector3.transformV3ToV4(e,t,n),r.x=n.x,r.y=n.y,r.z=n.z}},{key:"transformV3ToV4",value:function(e,t,r){var n=e.x,i=e.y,a=e.z,o=t.elements;r.x=n*o[0]+i*o[4]+a*o[8]+o[12],r.y=n*o[1]+i*o[5]+a*o[9]+o[13],r.z=n*o[2]+i*o[6]+a*o[10]+o[14],r.w=n*o[3]+i*o[7]+a*o[11]+o[15]}},{key:"TransformNormal",value:function(e,t,r){var n=e.x,i=e.y,a=e.z,o=t.elements;r.x=n*o[0]+i*o[4]+a*o[8],r.y=n*o[1]+i*o[5]+a*o[9],r.z=n*o[2]+i*o[6]+a*o[10]}},{key:"transformCoordinate",value:function(e,t,r){var n=e.x,i=e.y,a=e.z,o=t.elements,s=n*o[3]+i*o[7]+a*o[11]+o[15];r.x=(n*o[0]+i*o[4]+a*o[8]+o[12])/s,r.y=(n*o[1]+i*o[5]+a*o[9]+o[13])/s,r.z=(n*o[2]+i*o[6]+a*o[10]+o[14])/s}},{key:"Clamp",value:function(e,t,r,n){var i=e.x,a=e.y,o=e.z,s=t.x,l=t.y,u=t.z,c=r.x,h=r.y,_=r.z;i=(i=i>c?c:i)<s?s:i,a=(a=a>h?h:a)<l?l:a,o=(o=o>_?_:o)<u?u:o,n.x=i,n.y=a,n.z=o}},{key:"add",value:function(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z}},{key:"subtract",value:function(e,t,r){r.x=e.x-t.x,r.y=e.y-t.y,r.z=e.z-t.z}},{key:"cross",value:function(e,t,r){var n=e.x,i=e.y,a=e.z,o=t.x,s=t.y,l=t.z;r.x=i*l-a*s,r.y=a*o-n*l,r.z=n*s-i*o}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}},{key:"equals",value:function(e,t){return r.nearEqual(e.x,t.x)&&r.nearEqual(e.y,t.y)&&r.nearEqual(e.z,t.z)}}]),Vector3}();o._tempVector4=new i,o._ZERO=new o(0,0,0),o._ONE=new o(1,1,1),o._NegativeUnitX=new o(-1,0,0),o._UnitX=new o(1,0,0),o._UnitY=new o(0,1,0),o._UnitZ=new o(0,0,1),o._ForwardRH=new o(0,0,-1),o._ForwardLH=new o(0,0,1),o._Up=new o(0,1,0),(a=e.PBRRenderQuality||(e.PBRRenderQuality={}))[a.High=0]="High",a[a.Low=1]="Low";var s=function(){function Matrix3x3(){_classCallCheck(this,Matrix3x3);var e=this.elements=new Float32Array(9);e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}return _createClass(Matrix3x3,[{key:"determinant",value:function(){var e=this.elements,t=e[0],r=e[1],n=e[2],i=e[3],a=e[4],o=e[5],s=e[6],l=e[7],u=e[8];return t*(u*a-o*l)+r*(-u*i+o*s)+n*(l*i-a*s)}},{key:"translate",value:function(e,t){var r=t.elements,n=this.elements,i=n[0],a=n[1],o=n[2],s=n[3],l=n[4],u=n[5],c=n[6],h=n[7],_=n[8],d=e.x,f=e.y;r[0]=i,r[1]=a,r[2]=o,r[3]=s,r[4]=l,r[5]=u,r[6]=d*i+f*s+c,r[7]=d*a+f*l+h,r[8]=d*o+f*u+_}},{key:"rotate",value:function(e,t){var r=t.elements,n=this.elements,i=n[0],a=n[1],o=n[2],s=n[3],l=n[4],u=n[5],c=n[6],h=n[7],_=n[8],d=Math.sin(e),f=Math.cos(e);r[0]=f*i+d*s,r[1]=f*a+d*l,r[2]=f*o+d*u,r[3]=f*s-d*i,r[4]=f*l-d*a,r[5]=f*u-d*o,r[6]=c,r[7]=h,r[8]=_}},{key:"scale",value:function(e,t){var r=t.elements,n=this.elements,i=e.x,a=e.y;r[0]=i*n[0],r[1]=i*n[1],r[2]=i*n[2],r[3]=a*n[3],r[4]=a*n[4],r[5]=a*n[5],r[6]=n[6],r[7]=n[7],r[8]=n[8]}},{key:"invert",value:function(e){var t=e.elements,r=this.elements,n=r[0],i=r[1],a=r[2],o=r[3],s=r[4],l=r[5],u=r[6],c=r[7],h=r[8],_=h*s-l*c,d=-h*o+l*u,f=c*o-s*u,m=n*_+i*d+a*f;m||(e=null),m=1/m,t[0]=_*m,t[1]=(-h*i+a*c)*m,t[2]=(l*i-a*s)*m,t[3]=d*m,t[4]=(h*n-a*u)*m,t[5]=(-l*n+a*o)*m,t[6]=f*m,t[7]=(-c*n+i*u)*m,t[8]=(s*n-i*o)*m}},{key:"transpose",value:function(e){var t=e.elements,r=this.elements;if(e===this){var n=r[1],i=r[2],a=r[5];t[1]=r[3],t[2]=r[6],t[3]=n,t[5]=r[7],t[6]=i,t[7]=a}else t[0]=r[0],t[1]=r[3],t[2]=r[6],t[3]=r[1],t[4]=r[4],t[5]=r[7],t[6]=r[2],t[7]=r[5],t[8]=r[8]}},{key:"identity",value:function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}},{key:"cloneTo",value:function(e){var t,r,n;if((r=this.elements)!==(n=e.elements))for(t=0;t<9;++t)n[t]=r[t]}},{key:"clone",value:function(){var e=new Matrix3x3;return this.cloneTo(e),e}}],[{key:"createRotationQuaternion",value:function(e,t){var r=e.x,n=e.y,i=e.z,a=e.w,o=r*r,s=n*n,l=i*i,u=r*n,c=i*a,h=i*r,_=n*a,d=n*i,f=r*a,m=t.elements;m[0]=1-2*(s+l),m[1]=2*(u+c),m[2]=2*(h-_),m[3]=2*(u-c),m[4]=1-2*(l+o),m[5]=2*(d+f),m[6]=2*(h+_),m[7]=2*(d-f),m[8]=1-2*(s+o)}},{key:"createFromTranslation",value:function(e,t){var r=t.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=e.x,r[7]=e.y,r[8]=1}},{key:"createFromRotation",value:function(e,t){var r=t.elements,n=Math.sin(e),i=Math.cos(e);r[0]=i,r[1]=n,r[2]=0,r[3]=-n,r[4]=i,r[5]=0,r[6]=0,r[7]=0,r[8]=1}},{key:"createFromScaling",value:function(e,t){var r=t.elements;r[0]=e.x,r[1]=0,r[2]=0,r[3]=0,r[4]=e.y,r[5]=0,r[6]=0,r[7]=0,r[8]=e.z}},{key:"createFromMatrix4x4",value:function(e,t){var r=e.elements,n=t.elements;n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[4],n[4]=r[5],n[5]=r[6],n[6]=r[8],n[7]=r[9],n[8]=r[10]}},{key:"multiply",value:function(e,t,r){var n=e.elements,i=t.elements,a=r.elements,o=n[0],s=n[1],l=n[2],u=n[3],c=n[4],h=n[5],_=n[6],d=n[7],f=n[8],m=i[0],T=i[1],p=i[2],g=i[3],E=i[4],y=i[5],S=i[6],v=i[7],R=i[8];a[0]=m*o+T*u+p*_,a[1]=m*s+T*c+p*v,a[2]=m*l+T*h+p*f,a[3]=g*o+E*u+y*_,a[4]=g*s+E*c+y*d,a[5]=g*l+E*h+y*f,a[6]=S*o+v*u+R*_,a[7]=S*s+v*c+R*d,a[8]=S*l+v*h+R*f}},{key:"lookAt",value:function(e,t,r,n){o.subtract(e,t,Matrix3x3._tempV30),o.normalize(Matrix3x3._tempV30,Matrix3x3._tempV30),o.cross(r,Matrix3x3._tempV30,Matrix3x3._tempV31),o.normalize(Matrix3x3._tempV31,Matrix3x3._tempV31),o.cross(Matrix3x3._tempV30,Matrix3x3._tempV31,Matrix3x3._tempV32);var i=Matrix3x3._tempV30,a=Matrix3x3._tempV31,s=Matrix3x3._tempV32,l=n.elements;l[0]=a.x,l[3]=a.y,l[6]=a.z,l[1]=s.x,l[4]=s.y,l[7]=s.z,l[2]=i.x,l[5]=i.y,l[8]=i.z}}]),Matrix3x3}();s.DEFAULT=new s,s._tempV30=new o,s._tempV31=new o,s._tempV32=new o;var l=function ILaya3D(){_classCallCheck(this,ILaya3D)};l.Shader3D=null,l.Scene3D=null,l.MeshRenderStaticBatchManager=null,l.MeshRenderDynamicBatchManager=null,l.SubMeshDynamicBatch=null,l.Laya3D=null,l.Matrix4x4=null,l.Physics3D=null,l.ShadowLightType=null;var u=function(){function Quaternion(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;arguments.length>4&&void 0!==arguments[4]&&arguments[4];_classCallCheck(this,Quaternion),this.x=e,this.y=t,this.z=r,this.w=n}return _createClass(Quaternion,[{key:"scaling",value:function(e,t){t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e}},{key:"normalize",value:function(e){var t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;t>0&&(t=1/Math.sqrt(t),e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e.w=this.w*t)}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"rotateX",value:function(e,t){e*=.5;var r=Math.sin(e),n=Math.cos(e);t.x=this.x*n+this.w*r,t.y=this.y*n+this.z*r,t.z=this.z*n-this.y*r,t.w=this.w*n-this.x*r}},{key:"rotateY",value:function(e,t){e*=.5;var r=Math.sin(e),n=Math.cos(e);t.x=this.x*n-this.z*r,t.y=this.y*n+this.w*r,t.z=this.z*n+this.x*r,t.w=this.w*n-this.y*r}},{key:"rotateZ",value:function(e,t){e*=.5;var r=Math.sin(e),n=Math.cos(e);t.x=this.x*n+this.y*r,t.y=this.y*n-this.x*r,t.z=this.z*n+this.w*r,t.w=this.w*n-this.z*r}},{key:"getYawPitchRoll",value:function(e){o.transformQuat(o._ForwardRH,this,Quaternion.TEMPVector31),o.transformQuat(o._Up,this,Quaternion.TEMPVector32);var t=Quaternion.TEMPVector32;Quaternion.angleTo(o._ZERO,Quaternion.TEMPVector31,Quaternion.TEMPVector33);var r=Quaternion.TEMPVector33;r.x==Math.PI/2?(r.y=Quaternion.arcTanAngle(t.z,t.x),r.z=0):r.x==-Math.PI/2?(r.y=Quaternion.arcTanAngle(-t.z,-t.x),r.z=0):(l.Matrix4x4.createRotationY(-r.y,l.Matrix4x4.TEMPMatrix0),l.Matrix4x4.createRotationX(-r.x,l.Matrix4x4.TEMPMatrix1),o.transformCoordinate(Quaternion.TEMPVector32,l.Matrix4x4.TEMPMatrix0,Quaternion.TEMPVector32),o.transformCoordinate(Quaternion.TEMPVector32,l.Matrix4x4.TEMPMatrix1,Quaternion.TEMPVector32),r.z=Quaternion.arcTanAngle(t.y,-t.x)),r.y<=-Math.PI&&(r.y=Math.PI),r.z<=-Math.PI&&(r.z=Math.PI),r.y>=Math.PI&&r.z>=Math.PI&&(r.y=0,r.z=0,r.x=Math.PI-r.x);var n=e;n.x=r.y,n.y=r.x,n.z=r.z}},{key:"invert",value:function(e){var t=this.x,r=this.y,n=this.z,i=this.w,a=t*t+r*r+n*n+i*i,o=a?1/a:0;e.x=-t*o,e.y=-r*o,e.z=-n*o,e.w=i*o}},{key:"identity",value:function(){this.x=0,this.y=0,this.z=0,this.w=1}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}},{key:"cloneTo",value:function(e){this!==e&&(e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w)}},{key:"clone",value:function(){var e=new Quaternion;return this.cloneTo(e),e}},{key:"equals",value:function(e){return r.nearEqual(this.x,e.x)&&r.nearEqual(this.y,e.y)&&r.nearEqual(this.z,e.z)&&r.nearEqual(this.w,e.w)}},{key:"lengthSquared",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}},{key:"forNativeElement",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),n.rewriteNumProperty(this,"x",0),n.rewriteNumProperty(this,"y",1),n.rewriteNumProperty(this,"z",2),n.rewriteNumProperty(this,"w",3)}}],[{key:"createFromYawPitchRoll",value:function(e,t,r,n){var i=.5*r,a=.5*t,o=.5*e,s=Math.sin(i),l=Math.cos(i),u=Math.sin(a),c=Math.cos(a),h=Math.sin(o),_=Math.cos(o);n.x=_*u*l+h*c*s,n.y=h*c*l-_*u*s,n.z=_*c*s-h*u*l,n.w=_*c*l+h*u*s}},{key:"multiply",value:function(e,t,r){var n=e.x,i=e.y,a=e.z,o=e.w,s=t.x,l=t.y,u=t.z,c=t.w,h=i*u-a*l,_=a*s-n*u,d=n*l-i*s,f=n*s+i*l+a*u;r.x=n*c+s*o+h,r.y=i*c+l*o+_,r.z=a*c+u*o+d,r.w=o*c-f}},{key:"arcTanAngle",value:function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}},{key:"angleTo",value:function(e,t,r){o.subtract(t,e,Quaternion.TEMPVector30),o.normalize(Quaternion.TEMPVector30,Quaternion.TEMPVector30),r.x=Math.asin(Quaternion.TEMPVector30.y),r.y=Quaternion.arcTanAngle(-Quaternion.TEMPVector30.z,-Quaternion.TEMPVector30.x)}},{key:"createFromAxisAngle",value:function(e,t,r){t*=.5;var n=Math.sin(t);r.x=n*e.x,r.y=n*e.y,r.z=n*e.z,r.w=Math.cos(t)}},{key:"createFromMatrix4x4",value:function(e,t){var r,n,i=e.elements,a=i[0]+i[5]+i[10];a>0?(r=Math.sqrt(a+1),t.w=.5*r,r=.5/r,t.x=(i[6]-i[9])*r,t.y=(i[8]-i[2])*r,t.z=(i[1]-i[4])*r):i[0]>=i[5]&&i[0]>=i[10]?(n=.5/(r=Math.sqrt(1+i[0]-i[5]-i[10])),t.x=.5*r,t.y=(i[1]+i[4])*n,t.z=(i[2]+i[8])*n,t.w=(i[6]-i[9])*n):i[5]>i[10]?(n=.5/(r=Math.sqrt(1+i[5]-i[0]-i[10])),t.x=(i[4]+i[1])*n,t.y=.5*r,t.z=(i[9]+i[6])*n,t.w=(i[8]-i[2])*n):(n=.5/(r=Math.sqrt(1+i[10]-i[0]-i[5])),t.x=(i[8]+i[2])*n,t.y=(i[9]+i[6])*n,t.z=.5*r,t.w=(i[1]-i[4])*n)}},{key:"slerp",value:function(e,t,r,n){var i,a,o,s,l,u=e.x,c=e.y,h=e.z,_=e.w,d=t.x,f=t.y,m=t.z,T=t.w;return(a=u*d+c*f+h*m+_*T)<0&&(a=-a,d=-d,f=-f,m=-m,T=-T),1-a>1e-6?(i=Math.acos(a),o=Math.sin(i),s=Math.sin((1-r)*i)/o,l=Math.sin(r*i)/o):(s=1-r,l=r),n.x=s*u+l*d,n.y=s*c+l*f,n.z=s*h+l*m,n.w=s*_+l*T,n}},{key:"lerp",value:function(e,t,r,n){var i=1-r;Quaternion.dot(e,t)>=0?(n.x=i*e.x+r*t.x,n.y=i*e.y+r*t.y,n.z=i*e.z+r*t.z,n.w=i*e.w+r*t.w):(n.x=i*e.x-r*t.x,n.y=i*e.y-r*t.y,n.z=i*e.z-r*t.z,n.w=i*e.w-r*t.w),n.normalize(n)}},{key:"add",value:function(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z,r.w=e.w+t.w}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"rotationLookAt",value:function(e,t,r){Quaternion.lookAt(o._ZERO,e,t,r)}},{key:"lookAt",value:function(e,t,r,n){s.lookAt(e,t,r,Quaternion._tempMatrix3x3),Quaternion.rotationMatrix(Quaternion._tempMatrix3x3,n)}},{key:"invert",value:function(e,t){var n=e.lengthSquared();r.isZero(n)||(n=1/n,t.x=-e.x*n,t.y=-e.y*n,t.z=-e.z*n,t.w=e.w*n)}},{key:"rotationMatrix",value:function(e,t){var r,n,i=e.elements,a=i[0],o=i[1],s=i[2],l=i[3],u=i[4],c=i[5],h=i[6],_=i[7],d=i[8],f=a+u+d;f>0?(r=Math.sqrt(f+1),t.w=.5*r,r=.5/r,t.x=(c-_)*r,t.y=(h-s)*r,t.z=(o-l)*r):a>=u&&a>=d?(n=.5/(r=Math.sqrt(1+a-u-d)),t.x=.5*r,t.y=(o+l)*n,t.z=(s+h)*n,t.w=(c-_)*n):u>d?(n=.5/(r=Math.sqrt(1+u-a-d)),t.x=(l+o)*n,t.y=.5*r,t.z=(_+c)*n,t.w=(h-s)*n):(n=.5/(r=Math.sqrt(1+d-a-u)),t.x=(h+s)*n,t.y=(_+c)*n,t.z=.5*r,t.w=(o-l)*n)}}]),Quaternion}();u.TEMPVector30=new o,u.TEMPVector31=new o,u.TEMPVector32=new o,u.TEMPVector33=new o,u._tempMatrix3x3=new s,u.DEFAULT=new u,u.NAN=new u(NaN,NaN,NaN,NaN);var c=function(){function Matrix4x4(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,c=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,h=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,_=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,d=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,f=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,m=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1,T=arguments.length>16&&void 0!==arguments[16]?arguments[16]:null;_classCallCheck(this,Matrix4x4);var p=this.elements=T||new Float32Array(16);p[0]=e,p[1]=t,p[2]=r,p[3]=n,p[4]=i,p[5]=a,p[6]=o,p[7]=s,p[8]=l,p[9]=u,p[10]=c,p[11]=h,p[12]=_,p[13]=d,p[14]=f,p[15]=m}return _createClass(Matrix4x4,[{key:"setRotation",value:function(e){var t=e.x,r=e.y,n=e.z,i=e.w,a=t*t,o=r*r,s=n*n,l=t*r,u=n*i,c=n*t,h=r*i,_=r*n,d=t*i,f=this.elements;f[0]=1-2*(o+s),f[1]=2*(l+u),f[2]=2*(c-h),f[4]=2*(l-u),f[5]=1-2*(s+a),f[6]=2*(_+d),f[8]=2*(c+h),f[9]=2*(_-d),f[10]=1-2*(o+a)}},{key:"setPosition",value:function(e){var t=this.elements;t[12]=e.x,t[13]=e.y,t[14]=e.z}},{key:"getElementByRowColumn",value:function(e,t){if(e<0||e>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*e+t]}},{key:"setElementByRowColumn",value:function(e,t,r){if(e<0||e>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*e+t]=r}},{key:"equalsOtherMatrix",value:function(e){var t=this.elements,n=e.elements;return r.nearEqual(t[0],n[0])&&r.nearEqual(t[1],n[1])&&r.nearEqual(t[2],n[2])&&r.nearEqual(t[3],n[3])&&r.nearEqual(t[4],n[4])&&r.nearEqual(t[5],n[5])&&r.nearEqual(t[6],n[6])&&r.nearEqual(t[7],n[7])&&r.nearEqual(t[8],n[8])&&r.nearEqual(t[9],n[9])&&r.nearEqual(t[10],n[10])&&r.nearEqual(t[11],n[11])&&r.nearEqual(t[12],n[12])&&r.nearEqual(t[13],n[13])&&r.nearEqual(t[14],n[14])&&r.nearEqual(t[15],n[15])}},{key:"decomposeTransRotScale",value:function(e,t,r){var n=Matrix4x4._tempMatrix4x4;return this.decomposeTransRotMatScale(e,n,r)?(u.createFromMatrix4x4(n,t),!0):(t.identity(),!1)}},{key:"decomposeTransRotMatScale",value:function(e,t,n){var i=this.elements,a=e,s=t.elements,l=n;a.x=i[12],a.y=i[13],a.z=i[14];var u=i[0],c=i[1],h=i[2],_=i[4],d=i[5],f=i[6],m=i[8],T=i[9],p=i[10],g=l.x=Math.sqrt(u*u+c*c+h*h),E=l.y=Math.sqrt(_*_+d*d+f*f),y=l.z=Math.sqrt(m*m+T*T+p*p);if(r.isZero(g)||r.isZero(E)||r.isZero(y))return s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[8]=s[9]=s[11]=s[12]=s[13]=s[14]=0,s[0]=s[5]=s[10]=s[15]=1,!1;var S=Matrix4x4._tempVector0;S.x=m/y,S.y=T/y,S.z=p/y;var v=Matrix4x4._tempVector1;v.x=u/g,v.y=c/g,v.z=h/g;var R=Matrix4x4._tempVector2;o.cross(S,v,R);var C=Matrix4x4._tempVector1;return o.cross(R,S,C),s[3]=s[7]=s[11]=s[12]=s[13]=s[14]=0,s[15]=1,s[0]=C.x,s[1]=C.y,s[2]=C.z,s[4]=R.x,s[5]=R.y,s[6]=R.z,s[8]=S.x,s[9]=S.y,s[10]=S.z,s[0]*u+s[1]*c+s[2]*h<0&&(l.x=-g),s[4]*_+s[5]*d+s[6]*f<0&&(l.y=-E),s[8]*m+s[9]*T+s[10]*p<0&&(l.z=-y),!0}},{key:"decomposeYawPitchRoll",value:function(e){var t=Math.asin(-this.elements[9]);e.y=t,Math.cos(t)>r.zeroTolerance?(e.z=Math.atan2(this.elements[1],this.elements[5]),e.x=Math.atan2(this.elements[8],this.elements[10])):(e.z=Math.atan2(-this.elements[4],this.elements[0]),e.x=0)}},{key:"normalize",value:function(){var e=this.elements,t=e[0],r=e[1],n=e[2],i=Math.sqrt(t*t+r*r+n*n);if(!i)return e[0]=0,e[1]=0,void(e[2]=0);1!=i&&(i=1/i,e[0]=t*i,e[1]=r*i,e[2]=n*i)}},{key:"transpose",value:function(){var e,t;return t=(e=this.elements)[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}},{key:"invert",value:function(e){var t=this.elements,r=e.elements,n=t[0],i=t[1],a=t[2],o=t[3],s=t[4],l=t[5],u=t[6],c=t[7],h=t[8],_=t[9],d=t[10],f=t[11],m=t[12],T=t[13],p=t[14],g=t[15],E=n*l-i*s,y=n*u-a*s,S=n*c-o*s,v=i*u-a*l,R=i*c-o*l,C=a*c-o*u,M=h*T-_*m,D=h*p-d*m,x=h*g-f*m,A=_*p-d*T,I=_*g-f*T,L=d*g-f*p,P=E*L-y*I+S*A+v*x-R*D+C*M;0!==Math.abs(P)&&(P=1/P,r[0]=(l*L-u*I+c*A)*P,r[1]=(a*I-i*L-o*A)*P,r[2]=(T*C-p*R+g*v)*P,r[3]=(d*R-_*C-f*v)*P,r[4]=(u*x-s*L-c*D)*P,r[5]=(n*L-a*x+o*D)*P,r[6]=(p*S-m*C-g*y)*P,r[7]=(h*C-d*S+f*y)*P,r[8]=(s*I-l*x+c*M)*P,r[9]=(i*x-n*I-o*M)*P,r[10]=(m*R-T*S+g*E)*P,r[11]=(_*S-h*R-f*E)*P,r[12]=(l*D-s*A-u*M)*P,r[13]=(n*A-i*D+a*M)*P,r[14]=(T*y-m*v-p*E)*P,r[15]=(h*v-_*y+d*E)*P)}},{key:"identity",value:function(){var e=this.elements;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1}},{key:"cloneTo",value:function(e){var t,r,n;if((r=this.elements)!==(n=e.elements))for(t=0;t<16;++t)n[t]=r[t]}},{key:"clone",value:function(){var e=new Matrix4x4;return this.cloneTo(e),e}},{key:"getTranslationVector",value:function(e){var t=this.elements;e.x=t[12],e.y=t[13],e.z=t[14]}},{key:"setTranslationVector",value:function(e){var t=this.elements,r=e;t[12]=r.x,t[13]=r.y,t[14]=r.z}},{key:"getForward",value:function(e){var t=this.elements;e.x=-t[8],e.y=-t[9],e.z=-t[10]}},{key:"setForward",value:function(e){var t=this.elements;t[8]=-e.x,t[9]=-e.y,t[10]=-e.z}}],[{key:"createRotationX",value:function(e,t){var r=t.elements,n=Math.sin(e),i=Math.cos(e);r[1]=r[2]=r[3]=r[4]=r[7]=r[8]=r[11]=r[12]=r[13]=r[14]=0,r[0]=r[15]=1,r[5]=r[10]=i,r[6]=n,r[9]=-n}},{key:"createRotationY",value:function(e,t){var r=t.elements,n=Math.sin(e),i=Math.cos(e);r[1]=r[3]=r[4]=r[6]=r[7]=r[9]=r[11]=r[12]=r[13]=r[14]=0,r[5]=r[15]=1,r[0]=r[10]=i,r[2]=-n,r[8]=n}},{key:"createRotationZ",value:function(e,t){var r=t.elements,n=Math.sin(e),i=Math.cos(e);r[2]=r[3]=r[6]=r[7]=r[8]=r[9]=r[11]=r[12]=r[13]=r[14]=0,r[10]=r[15]=1,r[0]=r[5]=i,r[1]=n,r[4]=-n}},{key:"createRotationYawPitchRoll",value:function(e,t,r,n){u.createFromYawPitchRoll(e,t,r,Matrix4x4._tempQuaternion),Matrix4x4.createRotationQuaternion(Matrix4x4._tempQuaternion,n)}},{key:"createRotationAxis",value:function(e,t,r){var n=e.x,i=e.y,a=e.z,o=Math.cos(t),s=Math.sin(t),l=n*n,u=i*i,c=a*a,h=n*i,_=n*a,d=i*a,f=r.elements;f[3]=f[7]=f[11]=f[12]=f[13]=f[14]=0,f[15]=1,f[0]=l+o*(1-l),f[1]=h-o*h+s*a,f[2]=_-o*_-s*i,f[4]=h-o*h-s*a,f[5]=u+o*(1-u),f[6]=d-o*d+s*n,f[8]=_-o*_+s*i,f[9]=d-o*d-s*n,f[10]=c+o*(1-c)}},{key:"createRotationQuaternion",value:function(e,t){var r=t.elements,n=e.x,i=e.y,a=e.z,o=e.w,s=n*n,l=i*i,u=a*a,c=n*i,h=a*o,_=a*n,d=i*o,f=i*a,m=n*o;r[3]=r[7]=r[11]=r[12]=r[13]=r[14]=0,r[15]=1,r[0]=1-2*(l+u),r[1]=2*(c+h),r[2]=2*(_-d),r[4]=2*(c-h),r[5]=1-2*(u+s),r[6]=2*(f+m),r[8]=2*(_+d),r[9]=2*(f-m),r[10]=1-2*(l+s)}},{key:"createTranslate",value:function(e,t){var r=t.elements;r[4]=r[8]=r[1]=r[9]=r[2]=r[6]=r[3]=r[7]=r[11]=0,r[0]=r[5]=r[10]=r[15]=1,r[12]=e.x,r[13]=e.y,r[14]=e.z}},{key:"createScaling",value:function(e,t){var r=t.elements;r[0]=e.x,r[5]=e.y,r[10]=e.z,r[1]=r[4]=r[8]=r[12]=r[9]=r[13]=r[2]=r[6]=r[14]=r[3]=r[7]=r[11]=0,r[15]=1}},{key:"multiply",value:function(e,t,r){var n=t.elements,i=e.elements,a=r.elements,o=n[0],s=n[1],l=n[2],u=n[3],c=n[4],h=n[5],_=n[6],d=n[7],f=n[8],m=n[9],T=n[10],p=n[11],g=n[12],E=n[13],y=n[14],S=n[15],v=i[0],R=i[1],C=i[2],M=i[3],D=i[4],x=i[5],A=i[6],I=i[7],L=i[8],P=i[9],O=i[10],N=i[11],b=i[12],k=i[13],w=i[14],B=i[15];a[0]=o*v+s*D+l*L+u*b,a[1]=o*R+s*x+l*P+u*k,a[2]=o*C+s*A+l*O+u*w,a[3]=o*M+s*I+l*N+u*B,a[4]=c*v+h*D+_*L+d*b,a[5]=c*R+h*x+_*P+d*k,a[6]=c*C+h*A+_*O+d*w,a[7]=c*M+h*I+_*N+d*B,a[8]=f*v+m*D+T*L+p*b,a[9]=f*R+m*x+T*P+p*k,a[10]=f*C+m*A+T*O+p*w,a[11]=f*M+m*I+T*N+p*B,a[12]=g*v+E*D+y*L+S*b,a[13]=g*R+E*x+y*P+S*k,a[14]=g*C+E*A+y*O+S*w,a[15]=g*M+E*I+y*N+S*B}},{key:"multiplyForNative",value:function(e,r,n){t.LayaGL.instance.matrix4x4Multiply(e.elements,r.elements,n.elements)}},{key:"createFromQuaternion",value:function(e,t){var r=t.elements,n=e.x,i=e.y,a=e.z,o=e.w,s=n+n,l=i+i,u=a+a,c=n*s,h=i*s,_=i*l,d=a*s,f=a*l,m=a*u,T=o*s,p=o*l,g=o*u;r[0]=1-_-m,r[1]=h+g,r[2]=d-p,r[3]=0,r[4]=h-g,r[5]=1-c-m,r[6]=f+T,r[7]=0,r[8]=d+p,r[9]=f-T,r[10]=1-c-_,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1}},{key:"createAffineTransformation",value:function(e,t,r,n){var i=n.elements,a=t.x,o=t.y,s=t.z,l=t.w,u=a+a,c=o+o,h=s+s,_=a*u,d=a*c,f=a*h,m=o*c,T=o*h,p=s*h,g=l*u,E=l*c,y=l*h,S=r.x,v=r.y,R=r.z;i[0]=(1-(m+p))*S,i[1]=(d+y)*S,i[2]=(f-E)*S,i[3]=0,i[4]=(d-y)*v,i[5]=(1-(_+p))*v,i[6]=(T+g)*v,i[7]=0,i[8]=(f+E)*R,i[9]=(T-g)*R,i[10]=(1-(_+m))*R,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1}},{key:"createLookAt",value:function(e,t,r,n){var i=n.elements,a=Matrix4x4._tempVector0,s=Matrix4x4._tempVector1,l=Matrix4x4._tempVector2;o.subtract(e,t,l),o.normalize(l,l),o.cross(r,l,a),o.normalize(a,a),o.cross(l,a,s),i[3]=i[7]=i[11]=0,i[15]=1,i[0]=a.x,i[4]=a.y,i[8]=a.z,i[1]=s.x,i[5]=s.y,i[9]=s.z,i[2]=l.x,i[6]=l.y,i[10]=l.z,i[12]=-o.dot(a,e),i[13]=-o.dot(s,e),i[14]=-o.dot(l,e)}},{key:"createPerspective",value:function(e,t,r,n,i){var a=1/Math.tan(.5*e),o=r/(a/t),s=r/a;Matrix4x4.createPerspectiveOffCenter(-o,o,-s,s,r,n,i)}},{key:"createPerspectiveOffCenter",value:function(e,t,r,n,i,a,o){var s=o.elements,l=a/(a-i);s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[12]=s[13]=s[15]=0,s[0]=2*i/(t-e),s[5]=2*i/(n-r),s[8]=(e+t)/(t-e),s[9]=(n+r)/(n-r),s[10]=-l,s[11]=-1,s[14]=-i*l}},{key:"createOrthoOffCenter",value:function(e,t,r,n,i,a,o){var s=o.elements,l=1/(a-i);s[1]=s[2]=s[3]=s[4]=s[6]=s[8]=s[7]=s[9]=s[11]=0,s[15]=1,s[0]=2/(t-e),s[5]=2/(n-r),s[10]=-l,s[12]=(e+t)/(e-t),s[13]=(n+r)/(r-n),s[14]=-i*l}},{key:"billboard",value:function(e,t,n,i,a,s){o.subtract(e,t,Matrix4x4._tempVector0);var l=o.scalarLengthSquared(Matrix4x4._tempVector0);r.isZero(l)?(o.scale(a,-1,Matrix4x4._tempVector1),Matrix4x4._tempVector1.cloneTo(Matrix4x4._tempVector0)):o.scale(Matrix4x4._tempVector0,1/Math.sqrt(l),Matrix4x4._tempVector0),o.cross(i,Matrix4x4._tempVector0,Matrix4x4._tempVector2),o.normalize(Matrix4x4._tempVector2,Matrix4x4._tempVector2),o.cross(Matrix4x4._tempVector0,Matrix4x4._tempVector2,Matrix4x4._tempVector3);var u=Matrix4x4._tempVector2,c=Matrix4x4._tempVector3,h=Matrix4x4._tempVector0,_=e,d=s.elements;d[0]=u.x,d[1]=u.y,d[2]=u.z,d[3]=0,d[4]=c.x,d[5]=c.y,d[6]=c.z,d[7]=0,d[8]=h.x,d[9]=h.y,d[10]=h.z,d[11]=0,d[12]=_.x,d[13]=_.y,d[14]=_.z,d[15]=1}},{key:"translation",value:function(e,t){var r=t.elements;r[0]=r[5]=r[10]=r[15]=1,r[12]=e.x,r[13]=e.y,r[14]=e.z}}]),Matrix4x4}();c._tempMatrix4x4=new c,c.TEMPMatrix0=new c,c.TEMPMatrix1=new c,c._tempVector0=new o,c._tempVector1=new o,c._tempVector2=new o,c._tempVector3=new o,c._tempQuaternion=new u,c.DEFAULT=new c,c.ZERO=new c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var h=function(){function ColliderShape(){_classCallCheck(this,ColliderShape),this._scale=new o(1,1,1),this._centerMatrix=new c,this._attatched=!1,this._indexInCompound=-1,this._compoundParent=null,this._attatchedCollisionObject=null,this._referenceCount=0,this._localOffset=new o(0,0,0),this._localRotation=new u(0,0,0,1),this.needsCustomCollisionCallback=!1}return _createClass(ColliderShape,[{key:"_setScale",value:function(e){if(this._compoundParent)this.updateLocalTransformations();else{var t=l.Physics3D._bullet;t.btVector3_setValue(ColliderShape._btScale,e.x,e.y,e.z),t.btCollisionShape_setLocalScaling(this._btShape,ColliderShape._btScale)}}},{key:"_addReference",value:function(){this._referenceCount++}},{key:"_removeReference",value:function(){this._referenceCount--}},{key:"updateLocalTransformations",value:function(){if(this._compoundParent){var e=ColliderShape._tempVector30;o.multiply(this.localOffset,this._scale,e),ColliderShape._createAffineTransformation(e,this.localRotation,this._centerMatrix.elements)}else ColliderShape._createAffineTransformation(this.localOffset,this.localRotation,this._centerMatrix.elements)}},{key:"cloneTo",value:function(e){var t=e;this._localOffset.cloneTo(t.localOffset),this._localRotation.cloneTo(t.localRotation),t.localOffset=t.localOffset,t.localRotation=t.localRotation}},{key:"clone",value:function(){return null}},{key:"destroy",value:function(){this._btShape&&(l.Physics3D._bullet.btCollisionShape_destroy(this._btShape),this._btShape=null)}},{key:"type",get:function(){return this._type}},{key:"localOffset",get:function(){return this._localOffset},set:function(e){this._localOffset=e,this._compoundParent&&this._compoundParent._updateChildTransform(this)}},{key:"localRotation",get:function(){return this._localRotation},set:function(e){this._localRotation=e,this._compoundParent&&this._compoundParent._updateChildTransform(this)}}],[{key:"__init__",value:function(){var e=l.Physics3D._bullet;ColliderShape._btScale=e.btVector3_create(1,1,1),ColliderShape._btVector30=e.btVector3_create(0,0,0),ColliderShape._btQuaternion0=e.btQuaternion_create(0,0,0,1),ColliderShape._btTransform0=e.btTransform_create()}},{key:"_createAffineTransformation",value:function(e,t,r){var n=t.x,i=t.y,a=t.z,o=t.w,s=n+n,l=i+i,u=a+a,c=n*s,h=n*l,_=n*u,d=i*l,f=i*u,m=a*u,T=o*s,p=o*l,g=o*u;r[0]=1-(d+m),r[1]=h+g,r[2]=_-p,r[3]=0,r[4]=h-g,r[5]=1-(c+m),r[6]=f+T,r[7]=0,r[8]=_+p,r[9]=f-T,r[10]=1-(c+d),r[11]=0,r[12]=e.x,r[13]=e.y,r[14]=e.z,r[15]=1}}]),ColliderShape}();h.SHAPEORIENTATION_UPX=0,h.SHAPEORIENTATION_UPY=1,h.SHAPEORIENTATION_UPZ=2,h.SHAPETYPES_BOX=0,h.SHAPETYPES_SPHERE=1,h.SHAPETYPES_CYLINDER=2,h.SHAPETYPES_CAPSULE=3,h.SHAPETYPES_CONVEXHULL=4,h.SHAPETYPES_COMPOUND=5,h.SHAPETYPES_STATICPLANE=6,h.SHAPETYPES_CONE=7,h._tempVector30=new o;var _=function(e){function StaticPlaneColliderShape(e,t){var r;_classCallCheck(this,StaticPlaneColliderShape),(r=_possibleConstructorReturn(this,_getPrototypeOf(StaticPlaneColliderShape).call(this)))._normal=e,r._offset=t,r._type=h.SHAPETYPES_STATICPLANE;var n=l.Physics3D._bullet;return n.btVector3_setValue(StaticPlaneColliderShape._btNormal,-e.x,e.y,e.z),r._btShape=n.btStaticPlaneShape_create(StaticPlaneColliderShape._btNormal,t),r}return _inherits(StaticPlaneColliderShape,e),_createClass(StaticPlaneColliderShape,[{key:"clone",value:function(){var e=new StaticPlaneColliderShape(this._normal,this._offset);return this.cloneTo(e),e}}],[{key:"__init__",value:function(){StaticPlaneColliderShape._btNormal=l.Physics3D._bullet.btVector3_create(0,0,0)}}]),StaticPlaneColliderShape}(h),d=function(e){function CompoundColliderShape(){var e;return _classCallCheck(this,CompoundColliderShape),(e=_possibleConstructorReturn(this,_getPrototypeOf(CompoundColliderShape).call(this)))._childColliderShapes=[],e._type=h.SHAPETYPES_COMPOUND,e._btShape=l.Physics3D._bullet.btCompoundShape_create(),e}return _inherits(CompoundColliderShape,e),_createClass(CompoundColliderShape,[{key:"_clearChildShape",value:function(e){e._attatched=!1,e._compoundParent=null,e._indexInCompound=-1}},{key:"_addReference",value:function(){}},{key:"_removeReference",value:function(){}},{key:"_updateChildTransform",value:function(e){var t=l.Physics3D._bullet,r=e.localOffset,n=e.localRotation,i=h._btVector30,a=h._btQuaternion0,o=h._btTransform0;t.btVector3_setValue(i,-r.x,r.y,r.z),t.btQuaternion_setValue(a,-n.x,n.y,n.z,-n.w),t.btTransform_setOrigin(o,i),t.btTransform_setRotation(o,a),t.btCompoundShape_updateChildTransform(this._btShape,e._indexInCompound,o,!0)}},{key:"addChildShape",value:function(e){if(e._attatched)throw"CompoundColliderShape: this shape has attatched to other entity.";e._attatched=!0,e._compoundParent=this,e._indexInCompound=this._childColliderShapes.length,this._childColliderShapes.push(e);var t=e.localOffset,r=e.localRotation,n=l.Physics3D._bullet;n.btVector3_setValue(CompoundColliderShape._btOffset,-t.x,t.y,t.z),n.btQuaternion_setValue(CompoundColliderShape._btRotation,-r.x,r.y,r.z,-r.w),n.btTransform_setOrigin(CompoundColliderShape._btTransform,CompoundColliderShape._btOffset),n.btTransform_setRotation(CompoundColliderShape._btTransform,CompoundColliderShape._btRotation);var i=n.btCollisionShape_getLocalScaling(this._btShape);n.btCollisionShape_setLocalScaling(this._btShape,CompoundColliderShape._btVector3One),n.btCompoundShape_addChildShape(this._btShape,CompoundColliderShape._btTransform,e._btShape),n.btCollisionShape_setLocalScaling(this._btShape,i),this._attatchedCollisionObject&&(this._attatchedCollisionObject.colliderShape=this)}},{key:"removeChildShape",value:function(e){if(e._compoundParent===this){var t=e._indexInCompound;this._clearChildShape(e);var r=this._childColliderShapes[this._childColliderShapes.length-1];r._indexInCompound=t,this._childColliderShapes[t]=r,this._childColliderShapes.pop(),l.Physics3D._bullet.btCompoundShape_removeChildShapeByIndex(this._btShape,t)}}},{key:"clearChildShape",value:function(){for(var e=0,t=this._childColliderShapes.length;e<t;e++)this._clearChildShape(this._childColliderShapes[e]),l.Physics3D._bullet.btCompoundShape_removeChildShapeByIndex(this._btShape,0);this._childColliderShapes.length=0}},{key:"getChildShapeCount",value:function(){return this._childColliderShapes.length}},{key:"cloneTo",value:function(e){var t=e;t.clearChildShape();for(var r=0,n=this._childColliderShapes.length;r<n;r++)t.addChildShape(this._childColliderShapes[r].clone())}},{key:"clone",value:function(){var e=new CompoundColliderShape;return this.cloneTo(e),e}},{key:"destroy",value:function(){_get(_getPrototypeOf(CompoundColliderShape.prototype),"destroy",this).call(this);for(var e=0,t=this._childColliderShapes.length;e<t;e++){var r=this._childColliderShapes[e];0===r._referenceCount&&r.destroy()}}}],[{key:"__init__",value:function(){var e=l.Physics3D._bullet;CompoundColliderShape._btVector3One=e.btVector3_create(1,1,1),CompoundColliderShape._btTransform=e.btTransform_create(),CompoundColliderShape._btOffset=e.btVector3_create(0,0,0),CompoundColliderShape._btRotation=e.btQuaternion_create(0,0,0,1)}}]),CompoundColliderShape}(h),f=function(e){function Transform3D(e){var t;return _classCallCheck(this,Transform3D),(t=_possibleConstructorReturn(this,_getPrototypeOf(Transform3D).call(this)))._localPosition=new o(0,0,0),t._localRotation=new u(0,0,0,1),t._localScale=new o(1,1,1),t._localRotationEuler=new o(0,0,0),t._localMatrix=new c,t._position=new o(0,0,0),t._rotation=new u(0,0,0,1),t._scale=new o(1,1,1),t._rotationEuler=new o(0,0,0),t._worldMatrix=new c,t._children=null,t._parent=null,t._dummy=null,t._transformFlag=0,t._owner=e,t._children=[],t._setTransformFlag(Transform3D.TRANSFORM_LOCALQUATERNION|Transform3D.TRANSFORM_LOCALEULER|Transform3D.TRANSFORM_LOCALMATRIX,!1),t._setTransformFlag(Transform3D.TRANSFORM_WORLDPOSITION|Transform3D.TRANSFORM_WORLDQUATERNION|Transform3D.TRANSFORM_WORLDEULER|Transform3D.TRANSFORM_WORLDSCALE|Transform3D.TRANSFORM_WORLDMATRIX,!0),t}return _inherits(Transform3D,e),_createClass(Transform3D,[{key:"_getScaleMatrix",value:function(){var e=Transform3D._tempQuaternion0,t=Transform3D._tempMatrix3x30,r=Transform3D._tempMatrix3x31,n=Transform3D._tempMatrix3x32;return s.createFromMatrix4x4(this.worldMatrix,r),this.rotation.invert(e),s.createRotationQuaternion(e,t),s.multiply(t,r,n),n}},{key:"_setTransformFlag",value:function(e,t){t?this._transformFlag|=e:this._transformFlag&=~e}},{key:"_getTransformFlag",value:function(e){return 0!=(this._transformFlag&e)}},{key:"_setParent",value:function(e){if(this._parent!==e){if(this._parent){var t=this._parent._children,r=t.indexOf(this);t.splice(r,1)}e&&(e._children.push(this),e&&this._onWorldTransform()),this._parent=e}}},{key:"_onWorldPositionRotationTransform",value:function(){if(!(this._getTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX)&&this._getTransformFlag(Transform3D.TRANSFORM_WORLDPOSITION)&&this._getTransformFlag(Transform3D.TRANSFORM_WORLDQUATERNION)&&this._getTransformFlag(Transform3D.TRANSFORM_WORLDEULER))){this._setTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX|Transform3D.TRANSFORM_WORLDPOSITION|Transform3D.TRANSFORM_WORLDQUATERNION|Transform3D.TRANSFORM_WORLDEULER,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,r=this._children.length;e<r;e++)this._children[e]._onWorldPositionRotationTransform()}}},{key:"_onWorldPositionScaleTransform",value:function(){if(!this._getTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(Transform3D.TRANSFORM_WORLDPOSITION)||!this._getTransformFlag(Transform3D.TRANSFORM_WORLDSCALE)){this._setTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX|Transform3D.TRANSFORM_WORLDPOSITION|Transform3D.TRANSFORM_WORLDSCALE,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,r=this._children.length;e<r;e++)this._children[e]._onWorldPositionScaleTransform()}}},{key:"_onWorldPositionTransform",value:function(){if(!this._getTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(Transform3D.TRANSFORM_WORLDPOSITION)){this._setTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX|Transform3D.TRANSFORM_WORLDPOSITION,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,r=this._children.length;e<r;e++)this._children[e]._onWorldPositionTransform()}}},{key:"_onWorldRotationTransform",value:function(){if(!this._getTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(Transform3D.TRANSFORM_WORLDQUATERNION)||!this._getTransformFlag(Transform3D.TRANSFORM_WORLDEULER)){this._setTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX|Transform3D.TRANSFORM_WORLDQUATERNION|Transform3D.TRANSFORM_WORLDEULER,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,r=this._children.length;e<r;e++)this._children[e]._onWorldPositionRotationTransform()}}},{key:"_onWorldScaleTransform",value:function(){if(!this._getTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(Transform3D.TRANSFORM_WORLDSCALE)){this._setTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX|Transform3D.TRANSFORM_WORLDSCALE,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,r=this._children.length;e<r;e++)this._children[e]._onWorldPositionScaleTransform()}}},{key:"_onWorldTransform",value:function(){if(!(this._getTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX)&&this._getTransformFlag(Transform3D.TRANSFORM_WORLDPOSITION)&&this._getTransformFlag(Transform3D.TRANSFORM_WORLDQUATERNION)&&this._getTransformFlag(Transform3D.TRANSFORM_WORLDEULER)&&this._getTransformFlag(Transform3D.TRANSFORM_WORLDSCALE))){this._setTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX|Transform3D.TRANSFORM_WORLDPOSITION|Transform3D.TRANSFORM_WORLDQUATERNION|Transform3D.TRANSFORM_WORLDEULER|Transform3D.TRANSFORM_WORLDSCALE,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,r=this._children.length;e<r;e++)this._children[e]._onWorldTransform()}}},{key:"translate",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];t?(c.createFromQuaternion(this.localRotation,Transform3D._tempMatrix0),o.transformCoordinate(e,Transform3D._tempMatrix0,Transform3D._tempVector30),o.add(this.localPosition,Transform3D._tempVector30,this._localPosition),this.localPosition=this._localPosition):(o.add(this.position,e,this._position),this.position=this._position)}},{key:"rotate",value:function(e){var t,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];n?t=e:(o.scale(e,Math.PI/180,Transform3D._tempVector30),t=Transform3D._tempVector30),u.createFromYawPitchRoll(t.y,t.x,t.z,Transform3D._tempQuaternion0),r?(u.multiply(this._localRotation,Transform3D._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(u.multiply(Transform3D._tempQuaternion0,this.rotation,this._rotation),this.rotation=this._rotation)}},{key:"getForward",value:function(e){var t=this.worldMatrix.elements;e.x=-t[8],e.y=-t[9],e.z=-t[10]}},{key:"getUp",value:function(e){var t=this.worldMatrix.elements;e.x=t[4],e.y=t[5],e.z=t[6]}},{key:"getRight",value:function(e){var t=this.worldMatrix.elements;e.x=t[0],e.y=t[1],e.z=t[2]}},{key:"lookAt",value:function(e,t){var n,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(i){if(n=this._localPosition,Math.abs(n.x-e.x)<r.zeroTolerance&&Math.abs(n.y-e.y)<r.zeroTolerance&&Math.abs(n.z-e.z)<r.zeroTolerance)return;u.lookAt(this._localPosition,e,t,this._localRotation),this._localRotation.invert(this._localRotation),this.localRotation=this._localRotation}else{var a=this.position;if(n=a,Math.abs(n.x-e.x)<r.zeroTolerance&&Math.abs(n.y-e.y)<r.zeroTolerance&&Math.abs(n.z-e.z)<r.zeroTolerance)return;u.lookAt(a,e,t,this._rotation),this._rotation.invert(this._rotation),this.rotation=this._rotation}}},{key:"getWorldLossyScale",value:function(){if(this._getTransformFlag(Transform3D.TRANSFORM_WORLDSCALE)){if(null!==this._parent){var e=this._getScaleMatrix().elements;this._scale.x=e[0],this._scale.y=e[4],this._scale.z=e[8]}else this._localScale.cloneTo(this._scale);this._setTransformFlag(Transform3D.TRANSFORM_WORLDSCALE,!1)}return this._scale}},{key:"setWorldLossyScale",value:function(e){if(null!==this._parent){var t=Transform3D._tempMatrix3x33,r=Transform3D._tempMatrix3x33,n=r.elements,i=this._parent._getScaleMatrix();i.invert(i),s.createFromScaling(e,t),s.multiply(i,t,r),this._localScale.x=n[0],this._localScale.y=n[4],this._localScale.z=n[8]}else e.cloneTo(this._localScale);this.localScale=this._localScale,this._scale!==e&&e.cloneTo(this._scale),this._setTransformFlag(Transform3D.TRANSFORM_WORLDSCALE,!1)}},{key:"_isFrontFaceInvert",get:function(){var e=this.getWorldLossyScale(),t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t}},{key:"owner",get:function(){return this._owner}},{key:"worldNeedUpdate",get:function(){return this._getTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX)}},{key:"localPositionX",get:function(){return this._localPosition.x},set:function(e){this._localPosition.x=e,this.localPosition=this._localPosition}},{key:"localPositionY",get:function(){return this._localPosition.y},set:function(e){this._localPosition.y=e,this.localPosition=this._localPosition}},{key:"localPositionZ",get:function(){return this._localPosition.z},set:function(e){this._localPosition.z=e,this.localPosition=this._localPosition}},{key:"localPosition",get:function(){return this._localPosition},set:function(e){this._localPosition!==e&&e.cloneTo(this._localPosition),this._setTransformFlag(Transform3D.TRANSFORM_LOCALMATRIX,!0),this._onWorldPositionTransform()}},{key:"localRotationX",get:function(){return this.localRotation.x},set:function(e){this._localRotation.x=e,this.localRotation=this._localRotation}},{key:"localRotationY",get:function(){return this.localRotation.y},set:function(e){this._localRotation.y=e,this.localRotation=this._localRotation}},{key:"localRotationZ",get:function(){return this.localRotation.z},set:function(e){this._localRotation.z=e,this.localRotation=this._localRotation}},{key:"localRotationW",get:function(){return this.localRotation.w},set:function(e){this._localRotation.w=e,this.localRotation=this._localRotation}},{key:"localRotation",get:function(){if(this._getTransformFlag(Transform3D.TRANSFORM_LOCALQUATERNION)){var e=this._localRotationEuler;u.createFromYawPitchRoll(e.y/Transform3D._angleToRandin,e.x/Transform3D._angleToRandin,e.z/Transform3D._angleToRandin,this._localRotation),this._setTransformFlag(Transform3D.TRANSFORM_LOCALQUATERNION,!1)}return this._localRotation},set:function(e){this._localRotation!==e&&e.cloneTo(this._localRotation),this._localRotation.normalize(this._localRotation),this._setTransformFlag(Transform3D.TRANSFORM_LOCALEULER|Transform3D.TRANSFORM_LOCALMATRIX,!0),this._setTransformFlag(Transform3D.TRANSFORM_LOCALQUATERNION,!1),this._onWorldRotationTransform()}},{key:"localScaleX",get:function(){return this._localScale.x},set:function(e){this._localScale.x=e,this.localScale=this._localScale}},{key:"localScaleY",get:function(){return this._localScale.y},set:function(e){this._localScale.y=e,this.localScale=this._localScale}},{key:"localScaleZ",get:function(){return this._localScale.z},set:function(e){this._localScale.z=e,this.localScale=this._localScale}},{key:"localScale",get:function(){return this._localScale},set:function(e){this._localScale!==e&&e.cloneTo(this._localScale),this._setTransformFlag(Transform3D.TRANSFORM_LOCALMATRIX,!0),this._onWorldScaleTransform()}},{key:"localRotationEulerX",get:function(){return this.localRotationEuler.x},set:function(e){this._localRotationEuler.x=e,this.localRotationEuler=this._localRotationEuler}},{key:"localRotationEulerY",get:function(){return this.localRotationEuler.y},set:function(e){this._localRotationEuler.y=e,this.localRotationEuler=this._localRotationEuler}},{key:"localRotationEulerZ",get:function(){return this.localRotationEuler.z},set:function(e){this._localRotationEuler.z=e,this.localRotationEuler=this._localRotationEuler}},{key:"localRotationEuler",get:function(){if(this._getTransformFlag(Transform3D.TRANSFORM_LOCALEULER)){this._localRotation.getYawPitchRoll(Transform3D._tempVector30);var e=Transform3D._tempVector30,t=this._localRotationEuler;t.x=e.y*Transform3D._angleToRandin,t.y=e.x*Transform3D._angleToRandin,t.z=e.z*Transform3D._angleToRandin,this._setTransformFlag(Transform3D.TRANSFORM_LOCALEULER,!1)}return this._localRotationEuler},set:function(e){this._localRotationEuler!==e&&e.cloneTo(this._localRotationEuler),this._setTransformFlag(Transform3D.TRANSFORM_LOCALEULER,!1),this._setTransformFlag(Transform3D.TRANSFORM_LOCALQUATERNION|Transform3D.TRANSFORM_LOCALMATRIX,!0),this._onWorldRotationTransform()}},{key:"localMatrix",get:function(){return this._getTransformFlag(Transform3D.TRANSFORM_LOCALMATRIX)&&(c.createAffineTransformation(this._localPosition,this.localRotation,this._localScale,this._localMatrix),this._setTransformFlag(Transform3D.TRANSFORM_LOCALMATRIX,!1)),this._localMatrix},set:function(e){this._localMatrix!==e&&e.cloneTo(this._localMatrix),this._localMatrix.decomposeTransRotScale(this._localPosition,this._localRotation,this._localScale),this._setTransformFlag(Transform3D.TRANSFORM_LOCALEULER,!0),this._setTransformFlag(Transform3D.TRANSFORM_LOCALMATRIX,!1),this._onWorldTransform()}},{key:"position",get:function(){if(this._getTransformFlag(Transform3D.TRANSFORM_WORLDPOSITION)){if(null!=this._parent){var e=this.worldMatrix.elements;this._position.x=e[12],this._position.y=e[13],this._position.z=e[14]}else this._localPosition.cloneTo(this._position);this._setTransformFlag(Transform3D.TRANSFORM_WORLDPOSITION,!1)}return this._position},set:function(e){if(null!=this._parent){var t=Transform3D._tempMatrix0;this._parent.worldMatrix.invert(t),o.transformCoordinate(e,t,this._localPosition)}else e.cloneTo(this._localPosition);this.localPosition=this._localPosition,this._position!==e&&e.cloneTo(this._position),this._setTransformFlag(Transform3D.TRANSFORM_WORLDPOSITION,!1)}},{key:"rotation",get:function(){return this._getTransformFlag(Transform3D.TRANSFORM_WORLDQUATERNION)&&(null!=this._parent?u.multiply(this._parent.rotation,this.localRotation,this._rotation):this.localRotation.cloneTo(this._rotation),this._setTransformFlag(Transform3D.TRANSFORM_WORLDQUATERNION,!1)),this._rotation},set:function(e){null!=this._parent?(this._parent.rotation.invert(Transform3D._tempQuaternion0),u.multiply(Transform3D._tempQuaternion0,e,this._localRotation)):e.cloneTo(this._localRotation),this.localRotation=this._localRotation,e!==this._rotation&&e.cloneTo(this._rotation),this._setTransformFlag(Transform3D.TRANSFORM_WORLDQUATERNION,!1)}},{key:"rotationEuler",get:function(){if(this._getTransformFlag(Transform3D.TRANSFORM_WORLDEULER)){this.rotation.getYawPitchRoll(Transform3D._tempVector30);var e=Transform3D._tempVector30,t=this._rotationEuler;t.x=e.y*Transform3D._angleToRandin,t.y=e.x*Transform3D._angleToRandin,t.z=e.z*Transform3D._angleToRandin,this._setTransformFlag(Transform3D.TRANSFORM_WORLDEULER,!1)}return this._rotationEuler},set:function(e){u.createFromYawPitchRoll(e.y/Transform3D._angleToRandin,e.x/Transform3D._angleToRandin,e.z/Transform3D._angleToRandin,this._rotation),this.rotation=this._rotation,this._rotationEuler!==e&&e.cloneTo(this._rotationEuler),this._setTransformFlag(Transform3D.TRANSFORM_WORLDEULER,!1)}},{key:"worldMatrix",get:function(){return this._getTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX)&&(null!=this._parent?c.multiply(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._setTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX,!1)),this._worldMatrix},set:function(e){null===this._parent?e.cloneTo(this._localMatrix):(this._parent.worldMatrix.invert(this._localMatrix),c.multiply(this._localMatrix,e,this._localMatrix)),this.localMatrix=this._localMatrix,this._worldMatrix!==e&&e.cloneTo(this._worldMatrix),this._setTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX,!1)}},{key:"scale",get:function(){return console.warn("Transfrm3D: discard function,please use getWorldLossyScale instead."),this.getWorldLossyScale()},set:function(e){console.warn("Transfrm3D: discard function,please use setWorldLossyScale instead."),this.setWorldLossyScale(e)}}]),Transform3D}(t.EventDispatcher);f._tempVector30=new o,f._tempQuaternion0=new u,f._tempMatrix0=new c,f._tempMatrix3x30=new s,f._tempMatrix3x31=new s,f._tempMatrix3x32=new s,f._tempMatrix3x33=new s,f.TRANSFORM_LOCALQUATERNION=1,f.TRANSFORM_LOCALEULER=2,f.TRANSFORM_LOCALMATRIX=4,f.TRANSFORM_WORLDPOSITION=8,f.TRANSFORM_WORLDQUATERNION=16,f.TRANSFORM_WORLDSCALE=32,f.TRANSFORM_WORLDMATRIX=64,f.TRANSFORM_WORLDEULER=128,f._angleToRandin=180/Math.PI;var m=function(){function Physics3DUtils(){_classCallCheck(this,Physics3DUtils)}return _createClass(Physics3DUtils,null,[{key:"setColliderCollision",value:function(e,t,r){}},{key:"getIColliderCollision",value:function(e,t){return!1}}]),Physics3DUtils}();m.COLLISIONFILTERGROUP_DEFAULTFILTER=1,m.COLLISIONFILTERGROUP_STATICFILTER=2,m.COLLISIONFILTERGROUP_KINEMATICFILTER=4,m.COLLISIONFILTERGROUP_DEBRISFILTER=8,m.COLLISIONFILTERGROUP_SENSORTRIGGER=16,m.COLLISIONFILTERGROUP_CHARACTERFILTER=32,m.COLLISIONFILTERGROUP_CUSTOMFILTER1=64,m.COLLISIONFILTERGROUP_CUSTOMFILTER2=128,m.COLLISIONFILTERGROUP_CUSTOMFILTER3=256,m.COLLISIONFILTERGROUP_CUSTOMFILTER4=512,m.COLLISIONFILTERGROUP_CUSTOMFILTER5=1024,m.COLLISIONFILTERGROUP_CUSTOMFILTER6=2048,m.COLLISIONFILTERGROUP_CUSTOMFILTER7=4096,m.COLLISIONFILTERGROUP_CUSTOMFILTER8=8192,m.COLLISIONFILTERGROUP_CUSTOMFILTER9=16384,m.COLLISIONFILTERGROUP_CUSTOMFILTER10=32768,m.COLLISIONFILTERGROUP_ALLFILTER=-1,m.gravity=new o(0,-9.81,0);var T=function(e){function BoxColliderShape(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;_classCallCheck(this,BoxColliderShape),(e=_possibleConstructorReturn(this,_getPrototypeOf(BoxColliderShape).call(this)))._sizeX=t,e._sizeY=r,e._sizeZ=n,e._type=h.SHAPETYPES_BOX;var i=l.Physics3D._bullet;return i.btVector3_setValue(BoxColliderShape._btSize,t/2,r/2,n/2),e._btShape=i.btBoxShape_create(BoxColliderShape._btSize),e}return _inherits(BoxColliderShape,e),_createClass(BoxColliderShape,[{key:"clone",value:function(){var e=new BoxColliderShape(this._sizeX,this._sizeY,this._sizeZ);return this.cloneTo(e),e}},{key:"sizeX",get:function(){return this._sizeX}},{key:"sizeY",get:function(){return this._sizeY}},{key:"sizeZ",get:function(){return this._sizeZ}}],[{key:"__init__",value:function(){BoxColliderShape._btSize=l.Physics3D._bullet.btVector3_create(0,0,0)}}]),BoxColliderShape}(h),p=function(e){function CapsuleColliderShape(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1.25,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:h.SHAPEORIENTATION_UPY;_classCallCheck(this,CapsuleColliderShape),(e=_possibleConstructorReturn(this,_getPrototypeOf(CapsuleColliderShape).call(this)))._radius=t,e._length=r,e._orientation=n,e._type=h.SHAPETYPES_CAPSULE;var i=l.Physics3D._bullet;switch(n){case h.SHAPEORIENTATION_UPX:e._btShape=i.btCapsuleShapeX_create(t,r-2*t);break;case h.SHAPEORIENTATION_UPY:e._btShape=i.btCapsuleShape_create(t,r-2*t);break;case h.SHAPEORIENTATION_UPZ:e._btShape=i.btCapsuleShapeZ_create(t,r-2*t);break;default:throw"CapsuleColliderShape:unknown orientation."}return e}return _inherits(CapsuleColliderShape,e),_createClass(CapsuleColliderShape,[{key:"_setScale",value:function(e){var t=CapsuleColliderShape._tempVector30;switch(this.orientation){case h.SHAPEORIENTATION_UPX:t.x=e.x,t.y=t.z=Math.max(e.y,e.z);break;case h.SHAPEORIENTATION_UPY:t.y=e.y,t.x=t.z=Math.max(e.x,e.z);break;case h.SHAPEORIENTATION_UPZ:t.z=e.z,t.x=t.y=Math.max(e.x,e.y);break;default:throw"CapsuleColliderShape:unknown orientation."}_get(_getPrototypeOf(CapsuleColliderShape.prototype),"_setScale",this).call(this,t)}},{key:"clone",value:function(){var e=new CapsuleColliderShape(this._radius,this._length,this._orientation);return this.cloneTo(e),e}},{key:"radius",get:function(){return this._radius}},{key:"length",get:function(){return this._length}},{key:"orientation",get:function(){return this._orientation}}]),CapsuleColliderShape}(h);p._tempVector30=new o;var g=function(e){function ConeColliderShape(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:h.SHAPEORIENTATION_UPY;_classCallCheck(this,ConeColliderShape),(e=_possibleConstructorReturn(this,_getPrototypeOf(ConeColliderShape).call(this)))._radius=1,e._height=.5,e._radius=t,e._height=r,e._orientation=n,e._type=h.SHAPETYPES_CYLINDER;var i=l.Physics3D._bullet;switch(n){case h.SHAPEORIENTATION_UPX:e._btShape=i.btConeShapeX_create(t,r);break;case h.SHAPEORIENTATION_UPY:e._btShape=i.btConeShape_create(t,r);break;case h.SHAPEORIENTATION_UPZ:e._btShape=i.btConeShapeZ_create(t,r);break;default:throw"ConeColliderShape:unknown orientation."}return e}return _inherits(ConeColliderShape,e),_createClass(ConeColliderShape,[{key:"clone",value:function(){var e=new ConeColliderShape(this._radius,this._height,this._orientation);return this.cloneTo(e),e}},{key:"radius",get:function(){return this._radius}},{key:"height",get:function(){return this._height}},{key:"orientation",get:function(){return this._orientation}}]),ConeColliderShape}(h),E=function(e){function CylinderColliderShape(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:h.SHAPEORIENTATION_UPY;_classCallCheck(this,CylinderColliderShape),(e=_possibleConstructorReturn(this,_getPrototypeOf(CylinderColliderShape).call(this)))._radius=1,e._height=.5,e._radius=t,e._height=r,e._orientation=n,e._type=h.SHAPETYPES_CYLINDER;var i=l.Physics3D._bullet;switch(n){case h.SHAPEORIENTATION_UPX:i.btVector3_setValue(CylinderColliderShape._btSize,r/2,t,t),e._btShape=i.btCylinderShapeX_create(CylinderColliderShape._btSize);break;case h.SHAPEORIENTATION_UPY:i.btVector3_setValue(CylinderColliderShape._btSize,t,r/2,t),e._btShape=i.btCylinderShape_create(CylinderColliderShape._btSize);break;case h.SHAPEORIENTATION_UPZ:i.btVector3_setValue(CylinderColliderShape._btSize,t,t,r/2),e._btShape=i.btCylinderShapeZ_create(CylinderColliderShape._btSize);break;default:throw"CapsuleColliderShape:unknown orientation."}return e}return _inherits(CylinderColliderShape,e),_createClass(CylinderColliderShape,[{key:"clone",value:function(){var e=new CylinderColliderShape(this._radius,this._height,this._orientation);return this.cloneTo(e),e}},{key:"radius",get:function(){return this._radius}},{key:"height",get:function(){return this._height}},{key:"orientation",get:function(){return this._orientation}}],[{key:"__init__",value:function(){CylinderColliderShape._btSize=l.Physics3D._bullet.btVector3_create(0,0,0)}}]),CylinderColliderShape}(h),y=function(e){function MeshColliderShape(){var e;return _classCallCheck(this,MeshColliderShape),(e=_possibleConstructorReturn(this,_getPrototypeOf(MeshColliderShape).call(this)))._mesh=null,e._convex=!1,e}return _inherits(MeshColliderShape,e),_createClass(MeshColliderShape,[{key:"_setScale",value:function(e){if(this._compoundParent)this.updateLocalTransformations();else{var t=l.Physics3D._bullet;t.btVector3_setValue(h._btScale,e.x,e.y,e.z),t.btCollisionShape_setLocalScaling(this._btShape,h._btScale),t.btGImpactShapeInterface_updateBound(this._btShape)}}},{key:"cloneTo",value:function(e){var t=e;t.convex=this._convex,t.mesh=this._mesh,_get(_getPrototypeOf(MeshColliderShape.prototype),"cloneTo",this).call(this,e)}},{key:"clone",value:function(){var e=new MeshColliderShape;return this.cloneTo(e),e}},{key:"destroy",value:function(){this._btShape&&(l.Physics3D._bullet.btCollisionShape_destroy(this._btShape),this._btShape=null)}},{key:"mesh",get:function(){return this._mesh},set:function(e){if(this._mesh!==e){var t=l.Physics3D._bullet;this._mesh&&t.btCollisionShape_destroy(this._btShape),e&&(this._btShape=t.btGImpactMeshShape_create(e._getPhysicMesh()),t.btGImpactShapeInterface_updateBound(this._btShape)),this._mesh=e}}},{key:"convex",get:function(){return this._convex},set:function(e){this._convex=e}}]),MeshColliderShape}(h),S=function(e){function SphereColliderShape(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5;return _classCallCheck(this,SphereColliderShape),(e=_possibleConstructorReturn(this,_getPrototypeOf(SphereColliderShape).call(this)))._radius=t,e._type=h.SHAPETYPES_SPHERE,e._btShape=l.Physics3D._bullet.btSphereShape_create(t),e}return _inherits(SphereColliderShape,e),_createClass(SphereColliderShape,[{key:"clone",value:function(){var e=new SphereColliderShape(this._radius);return this.cloneTo(e),e}},{key:"radius",get:function(){return this._radius}}]),SphereColliderShape}(h),v=function(e){function PhysicsComponent(e,t){var r;return _classCallCheck(this,PhysicsComponent),(r=_possibleConstructorReturn(this,_getPrototypeOf(PhysicsComponent).call(this)))._restitution=0,r._friction=.5,r._rollingFriction=0,r._ccdMotionThreshold=0,r._ccdSweptSphereRadius=0,r._collisionGroup=m.COLLISIONFILTERGROUP_DEFAULTFILTER,r._canCollideWith=m.COLLISIONFILTERGROUP_ALLFILTER,r._colliderShape=null,r._transformFlag=2147483647,r._controlBySimulation=!1,r._enableProcessCollisions=!0,r._inPhysicUpdateListIndex=-1,r.canScaleShape=!0,r._collisionGroup=e,r._canCollideWith=t,PhysicsComponent._physicObjectsMap[r.id]=_assertThisInitialized(r),r}return _inherits(PhysicsComponent,e),_createClass(PhysicsComponent,[{key:"_parseShape",value:function(e){var t=e.length;if(1===t){var r=PhysicsComponent._creatShape(e[0]);this.colliderShape=r}else{for(var n=new d,i=0;i<t;i++)r=PhysicsComponent._creatShape(e[i]),n.addChildShape(r);this.colliderShape=n}}},{key:"_onScaleChange",value:function(e){this._colliderShape._setScale(e)}},{key:"_onEnable",value:function(){this._simulation=this.owner._scene.physicsSimulation,l.Physics3D._bullet.btCollisionObject_setContactProcessingThreshold(this._btColliderObject,1e30),this._colliderShape&&(this._derivePhysicsTransformation(!0),this._addToSimulation())}},{key:"_onDisable",value:function(){this._colliderShape&&(this._removeFromSimulation(),-1!==this._inPhysicUpdateListIndex&&this._simulation._physicsUpdateList.remove(this)),this._simulation=null}},{key:"_onDestroy",value:function(){delete PhysicsComponent._physicObjectsMap[this.id],l.Physics3D._bullet.btCollisionObject_destroy(this._btColliderObject),this._colliderShape.destroy(),_get(_getPrototypeOf(PhysicsComponent.prototype),"_onDestroy",this).call(this),this._btColliderObject=null,this._colliderShape=null,this._simulation=null,this.owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged)}},{key:"_isValid",value:function(){return this._simulation&&this._colliderShape&&this._enabled}},{key:"_parse",value:function(e){null!=e.collisionGroup&&(this.collisionGroup=e.collisionGroup),null!=e.canCollideWith&&(this.canCollideWith=e.canCollideWith),null!=e.ccdMotionThreshold&&(this.ccdMotionThreshold=e.ccdMotionThreshold),null!=e.ccdSweptSphereRadius&&(this.ccdSweptSphereRadius=e.ccdSweptSphereRadius)}},{key:"_setTransformFlag",value:function(e,t){t?this._transformFlag|=e:this._transformFlag&=~e}},{key:"_getTransformFlag",value:function(e){return 0!=(this._transformFlag&e)}},{key:"_addToSimulation",value:function(){}},{key:"_removeFromSimulation",value:function(){}},{key:"_derivePhysicsTransformation",value:function(e){var t=l.Physics3D._bullet,r=this._btColliderObject,n=t.btCollisionObject_getWorldTransform(r);this._innerDerivePhysicsTransformation(n,e),t.btCollisionObject_setWorldTransform(r,n)}},{key:"_innerDerivePhysicsTransformation",value:function(e,t){var r=l.Physics3D._bullet,n=this.owner._transform;if(t||this._getTransformFlag(f.TRANSFORM_WORLDPOSITION)){var i=this._colliderShape.localOffset,a=n.position,s=PhysicsComponent._btVector30;if(0!==i.x||0!==i.y||0!==i.z){var u=PhysicsComponent._tempVector30,c=n.worldMatrix;o.transformCoordinate(i,c,u),r.btVector3_setValue(s,-u.x,u.y,u.z)}else r.btVector3_setValue(s,-a.x,a.y,a.z);r.btTransform_setOrigin(e,s),this._setTransformFlag(f.TRANSFORM_WORLDPOSITION,!1)}if(t||this._getTransformFlag(f.TRANSFORM_WORLDQUATERNION)){var h=this._colliderShape.localRotation,_=PhysicsComponent._btQuaternion0,d=n.rotation;if(0!==h.x||0!==h.y||0!==h.z||1!==h.w){var m=PhysicsComponent._tempQuaternion0;PhysicsComponent.physicQuaternionMultiply(d.x,d.y,d.z,d.w,h,m),r.btQuaternion_setValue(_,-m.x,m.y,m.z,-m.w)}else r.btQuaternion_setValue(_,-d.x,d.y,d.z,-d.w);r.btTransform_setRotation(e,_),this._setTransformFlag(f.TRANSFORM_WORLDQUATERNION,!1)}(t||this._getTransformFlag(f.TRANSFORM_WORLDSCALE))&&(this._onScaleChange(n.getWorldLossyScale()),this._setTransformFlag(f.TRANSFORM_WORLDSCALE,!1))}},{key:"_updateTransformComponent",value:function(e){var t=l.Physics3D._bullet,r=this._colliderShape,n=r.localOffset,i=r.localRotation,a=this.owner._transform,s=a.position,u=a.rotation,c=t.btTransform_getOrigin(e),h=t.btTransform_getRotation(e),_=-t.btQuaternion_x(h),d=t.btQuaternion_y(h),f=t.btQuaternion_z(h),m=-t.btQuaternion_w(h);if(0!==i.x||0!==i.y||0!==i.z||1!==i.w){var T=PhysicsComponent._tempQuaternion0;i.invert(T),PhysicsComponent.physicQuaternionMultiply(_,d,f,m,T,u)}else u.x=_,u.y=d,u.z=f,u.w=m;if(a.rotation=u,0!==n.x||0!==n.y||0!==n.z){var p=t.btCollisionShape_getLocalScaling(r._btShape),g=PhysicsComponent._tempVector30;g.x=n.x*t.btVector3_x(p),g.y=n.y*t.btVector3_y(p),g.z=n.z*t.btVector3_z(p),o.transformQuat(g,u,g),s.x=-t.btVector3_x(c)-g.x,s.y=t.btVector3_y(c)-g.y,s.z=t.btVector3_z(c)-g.z}else s.x=-t.btVector3_x(c),s.y=t.btVector3_y(c),s.z=t.btVector3_z(c);a.position=s}},{key:"_onShapeChange",value:function(e){var t=this._btColliderObject,r=l.Physics3D._bullet,n=r.btCollisionObject_getCollisionFlags(t);e.needsCustomCollisionCallback?0==(n&PhysicsComponent.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK)&&r.btCollisionObject_setCollisionFlags(t,n|PhysicsComponent.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK):(n&PhysicsComponent.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK)>0&&r.btCollisionObject_setCollisionFlags(t,n^PhysicsComponent.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK)}},{key:"_onAdded",value:function(){this.enabled=this._enabled,this.restitution=this._restitution,this.friction=this._friction,this.rollingFriction=this._rollingFriction,this.ccdMotionThreshold=this._ccdMotionThreshold,this.ccdSweptSphereRadius=this._ccdSweptSphereRadius,this.owner.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged)}},{key:"_onTransformChanged",value:function(e){!PhysicsComponent._addUpdateList&&this._controlBySimulation||(e&=f.TRANSFORM_WORLDPOSITION|f.TRANSFORM_WORLDQUATERNION|f.TRANSFORM_WORLDSCALE)&&(this._transformFlag|=e,this._isValid()&&-1===this._inPhysicUpdateListIndex&&this._simulation._physicsUpdateList.add(this))}},{key:"_cloneTo",value:function(e){var t=e;t.restitution=this._restitution,t.friction=this._friction,t.rollingFriction=this._rollingFriction,t.ccdMotionThreshold=this._ccdMotionThreshold,t.ccdSweptSphereRadius=this._ccdSweptSphereRadius,t.collisionGroup=this._collisionGroup,t.canCollideWith=this._canCollideWith,t.canScaleShape=this.canScaleShape,this._colliderShape&&(t.colliderShape=this._colliderShape.clone())}},{key:"restitution",get:function(){return this._restitution},set:function(e){this._restitution=e,this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_setRestitution(this._btColliderObject,e)}},{key:"friction",get:function(){return this._friction},set:function(e){this._friction=e,this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_setFriction(this._btColliderObject,e)}},{key:"rollingFriction",get:function(){return this._rollingFriction},set:function(e){this._rollingFriction=e,this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_setRollingFriction(this._btColliderObject,e)}},{key:"ccdMotionThreshold",get:function(){return this._ccdMotionThreshold},set:function(e){this._ccdMotionThreshold=e,this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_setCcdMotionThreshold(this._btColliderObject,e)}},{key:"ccdSweptSphereRadius",get:function(){return this._ccdSweptSphereRadius},set:function(e){this._ccdSweptSphereRadius=e,this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_setCcdSweptSphereRadius(this._btColliderObject,e)}},{key:"isActive",get:function(){return!!this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_isActive(this._btColliderObject)}},{key:"colliderShape",get:function(){return this._colliderShape},set:function(e){var t=this._colliderShape;if(t&&(t._attatched=!1,t._attatchedCollisionObject=null),this._colliderShape=e,e){if(e._attatched)throw"PhysicsComponent: this shape has attatched to other entity.";if(e._attatched=!0,e._attatchedCollisionObject=this,this._btColliderObject){l.Physics3D._bullet.btCollisionObject_setCollisionShape(this._btColliderObject,e._btShape);var r=this._simulation&&this._enabled;r&&t&&this._removeFromSimulation(),this._onShapeChange(e),r&&(this._derivePhysicsTransformation(!0),this._addToSimulation())}}else this._simulation&&this._enabled&&t&&this._removeFromSimulation()}},{key:"simulation",get:function(){return this._simulation}},{key:"collisionGroup",get:function(){return this._collisionGroup},set:function(e){this._collisionGroup!==e&&(this._collisionGroup=e,this._simulation&&this._colliderShape&&this._enabled&&(this._removeFromSimulation(),this._addToSimulation()))}},{key:"canCollideWith",get:function(){return this._canCollideWith},set:function(e){this._canCollideWith!==e&&(this._canCollideWith=e,this._simulation&&this._colliderShape&&this._enabled&&(this._removeFromSimulation(),this._addToSimulation()))}}],[{key:"__init__",value:function(){var e=l.Physics3D._bullet;PhysicsComponent._btVector30=e.btVector3_create(0,0,0),PhysicsComponent._btQuaternion0=e.btQuaternion_create(0,0,0,1)}},{key:"_createAffineTransformationArray",value:function(e,t,r,n,i,a,o,s,l){var u=n+n,c=i+i,h=a+a,_=n*u,d=n*c,f=n*h,m=i*c,T=i*h,p=a*h,g=o*u,E=o*c,y=o*h,S=s[0],v=s[1],R=s[2];l[0]=(1-(m+p))*S,l[1]=(d+y)*S,l[2]=(f-E)*S,l[3]=0,l[4]=(d-y)*v,l[5]=(1-(_+p))*v,l[6]=(T+g)*v,l[7]=0,l[8]=(f+E)*R,l[9]=(T-g)*R,l[10]=(1-(_+m))*R,l[11]=0,l[12]=e,l[13]=t,l[14]=r,l[15]=1}},{key:"_creatShape",value:function(e){var r;switch(e.type){case"BoxColliderShape":var n=e.size;r=n?new T(n[0],n[1],n[2]):new T;break;case"SphereColliderShape":r=new S(e.radius);break;case"CapsuleColliderShape":r=new p(e.radius,e.height,e.orientation);break;case"MeshColliderShape":var i=new y;e.mesh&&(i.mesh=t.Loader.getRes(e.mesh)),r=i;break;case"ConeColliderShape":r=new g(e.radius,e.height,e.orientation);break;case"CylinderColliderShape":r=new E(e.radius,e.height,e.orientation);break;default:throw"unknown shape type."}if(e.center){var a=r.localOffset;a.fromArray(e.center),r.localOffset=a}return r}},{key:"physicVector3TransformQuat",value:function(e,t,r,n,i,a){var o=e.x,s=e.y,l=e.z,u=i*o+r*l-n*s,c=i*s+n*o-t*l,h=i*l+t*s-r*o,_=-t*o-r*s-n*l;a.x=u*i+_*-t+c*-n-h*-r,a.y=c*i+_*-r+h*-t-u*-n,a.z=h*i+_*-n+u*-r-c*-t}},{key:"physicQuaternionMultiply",value:function(e,t,r,n,i,a){var o=i.x,s=i.y,l=i.z,u=i.w,c=t*l-r*s,h=r*o-e*l,_=e*s-t*o,d=e*o+t*s+r*l;a.x=e*u+o*n+c,a.y=t*u+s*n+h,a.z=r*u+l*n+_,a.w=n*u-d}}]),PhysicsComponent}(t.Component);v.ACTIVATIONSTATE_ACTIVE_TAG=1,v.ACTIVATIONSTATE_ISLAND_SLEEPING=2,v.ACTIVATIONSTATE_WANTS_DEACTIVATION=3,v.ACTIVATIONSTATE_DISABLE_DEACTIVATION=4,v.ACTIVATIONSTATE_DISABLE_SIMULATION=5,v.COLLISIONFLAGS_STATIC_OBJECT=1,v.COLLISIONFLAGS_KINEMATIC_OBJECT=2,v.COLLISIONFLAGS_NO_CONTACT_RESPONSE=4,v.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK=8,v.COLLISIONFLAGS_CHARACTER_OBJECT=16,v.COLLISIONFLAGS_DISABLE_VISUALIZE_OBJECT=32,v.COLLISIONFLAGS_DISABLE_SPU_COLLISION_PROCESSING=64,v._tempVector30=new o,v._tempQuaternion0=new u,v._tempQuaternion1=new u,v._tempMatrix4x40=new c,v._physicObjectsMap={},v._addUpdateList=!0;var R=function(){function SingletonList(){_classCallCheck(this,SingletonList),this.elements=[],this.length=0}return _createClass(SingletonList,[{key:"_add",value:function(e){this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e}},{key:"add",value:function(e){this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e,this.length++}}]),SingletonList}(),C=function(e){function PhysicsUpdateList(){return _classCallCheck(this,PhysicsUpdateList),_possibleConstructorReturn(this,_getPrototypeOf(PhysicsUpdateList).call(this))}return _inherits(PhysicsUpdateList,e),_createClass(PhysicsUpdateList,[{key:"add",value:function(e){if(-1!==e._inPhysicUpdateListIndex)throw"PhysicsUpdateList:element has  in  PhysicsUpdateList.";this._add(e),e._inPhysicUpdateListIndex=this.length++}},{key:"remove",value:function(e){var t=e._inPhysicUpdateListIndex;if(this.length--,t!==this.length){var r=this.elements[this.length];this.elements[t]=r,r._inPhysicUpdateListIndex=t}e._inPhysicUpdateListIndex=-1}}]),PhysicsUpdateList}(R),M=function ContactPoint(){_classCallCheck(this,ContactPoint),this._idCounter=0,this.colliderA=null,this.colliderB=null,this.distance=0,this.normal=new o,this.positionOnA=new o,this.positionOnB=new o,this._id=++this._idCounter},D=function HitResult(){_classCallCheck(this,HitResult),this.succeeded=!1,this.collider=null,this.point=new o,this.normal=new o,this.hitFraction=0},x=function(){function Collision(){_classCallCheck(this,Collision),this._lastUpdateFrame=-2147483648,this._updateFrame=-2147483648,this._isTrigger=!1,this.contacts=[]}return _createClass(Collision,[{key:"_setUpdateFrame",value:function(e){this._lastUpdateFrame=this._updateFrame,this._updateFrame=e}}]),Collision}(),A=function(){function CollisionTool(){_classCallCheck(this,CollisionTool),this._hitResultsPoolIndex=0,this._hitResultsPool=[],this._contactPonintsPoolIndex=0,this._contactPointsPool=[],this._collisionsPool=[],this._collisions={}}return _createClass(CollisionTool,[{key:"getHitResult",value:function(){var e=this._hitResultsPool[this._hitResultsPoolIndex++];return e||(e=new D,this._hitResultsPool.push(e)),e}},{key:"recoverAllHitResultsPool",value:function(){this._hitResultsPoolIndex=0}},{key:"getContactPoints",value:function(){var e=this._contactPointsPool[this._contactPonintsPoolIndex++];return e||(e=new M,this._contactPointsPool.push(e)),e}},{key:"recoverAllContactPointsPool",value:function(){this._contactPonintsPoolIndex=0}},{key:"getCollision",value:function(e,t){var r,n=e.id,i=t.id,a=this._collisions[n];return a&&(r=a[i]),r||(a||(a={},this._collisions[n]=a),(r=0===this._collisionsPool.length?new x:this._collisionsPool.pop())._colliderA=e,r._colliderB=t,a[i]=r),r}},{key:"recoverCollision",value:function(e){var t=e._colliderA.id,r=e._colliderB.id;this._collisions[t][r]=null,this._collisionsPool.push(e)}},{key:"garbageCollection",value:function(){for(var e in this._hitResultsPoolIndex=0,this._hitResultsPool.length=0,this._contactPonintsPoolIndex=0,this._contactPointsPool.length=0,this._collisionsPool.length=0,this._collisionsPool){var t=this._collisionsPool[e],r=!0;for(var n in t)t[n]?r=!1:delete t[n];r&&delete this._collisionsPool[e]}}}]),CollisionTool}(),I=function(){function PhysicsSimulation(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];_classCallCheck(this,PhysicsSimulation),this._gravity=new o(0,-10,0),this._btVector3Zero=l.Physics3D._bullet.btVector3_create(0,0,0),this._btDefaultQuaternion=l.Physics3D._bullet.btQuaternion_create(0,0,0,-1),this._collisionsUtils=new A,this._previousFrameCollisions=[],this._currentFrameCollisions=[],this._currentConstraint={},this._physicsUpdateList=new C,this._characters=[],this._updatedRigidbodies=0,this.maxSubSteps=1,this.fixedTimeStep=1/60,this.maxSubSteps=e.maxSubSteps,this.fixedTimeStep=e.fixedTimeStep;var t=l.Physics3D._bullet;this._btCollisionConfiguration=t.btDefaultCollisionConfiguration_create(),this._btDispatcher=t.btCollisionDispatcher_create(this._btCollisionConfiguration),this._btBroadphase=t.btDbvtBroadphase_create(),t.btOverlappingPairCache_setInternalGhostPairCallback(t.btDbvtBroadphase_getOverlappingPairCache(this._btBroadphase),t.btGhostPairCallback_create());var r=e.flags;if(r&PhysicsSimulation.PHYSICSENGINEFLAGS_COLLISIONSONLY)this._btCollisionWorld=new t.btCollisionWorld(this._btDispatcher,this._btBroadphase,this._btCollisionConfiguration);else{if(r&PhysicsSimulation.PHYSICSENGINEFLAGS_SOFTBODYSUPPORT)throw"PhysicsSimulation:SoftBody processing is not yet available";var n=t.btSequentialImpulseConstraintSolver_create();this._btDiscreteDynamicsWorld=t.btDiscreteDynamicsWorld_create(this._btDispatcher,this._btBroadphase,n,this._btCollisionConfiguration),this._btCollisionWorld=this._btDiscreteDynamicsWorld}this._btDiscreteDynamicsWorld&&(this._btSolverInfo=t.btDynamicsWorld_getSolverInfo(this._btDiscreteDynamicsWorld),this._btDispatchInfo=t.btCollisionWorld_getDispatchInfo(this._btDiscreteDynamicsWorld)),this._btClosestRayResultCallback=t.ClosestRayResultCallback_create(this._btVector3Zero,this._btVector3Zero),this._btAllHitsRayResultCallback=t.AllHitsRayResultCallback_create(this._btVector3Zero,this._btVector3Zero),this._btClosestConvexResultCallback=t.ClosestConvexResultCallback_create(this._btVector3Zero,this._btVector3Zero),this._btAllConvexResultCallback=t.AllConvexResultCallback_create(this._btVector3Zero,this._btVector3Zero),this.setHitsRayResultCallbackFlag(),t.btGImpactCollisionAlgorithm_RegisterAlgorithm(this._btDispatcher)}return _createClass(PhysicsSimulation,[{key:"_simulate",value:function(e){this._updatedRigidbodies=0;var t=l.Physics3D._bullet;this._btDiscreteDynamicsWorld?t.btDiscreteDynamicsWorld_stepSimulation(this._btDiscreteDynamicsWorld,e,this.maxSubSteps,this.fixedTimeStep):t.PerformDiscreteCollisionDetection(this._btCollisionWorld)}},{key:"_destroy",value:function(){var e=l.Physics3D._bullet;this._btDiscreteDynamicsWorld?(e.btCollisionWorld_destroy(this._btDiscreteDynamicsWorld),this._btDiscreteDynamicsWorld=null):(e.btCollisionWorld_destroy(this._btCollisionWorld),this._btCollisionWorld=null),e.btDbvtBroadphase_destroy(this._btBroadphase),this._btBroadphase=null,e.btCollisionDispatcher_destroy(this._btDispatcher),this._btDispatcher=null,e.btDefaultCollisionConfiguration_destroy(this._btCollisionConfiguration),this._btCollisionConfiguration=null}},{key:"_addPhysicsCollider",value:function(e,t,r){l.Physics3D._bullet.btCollisionWorld_addCollisionObject(this._btCollisionWorld,e._btColliderObject,t,r)}},{key:"_removePhysicsCollider",value:function(e){l.Physics3D._bullet.btCollisionWorld_removeCollisionObject(this._btCollisionWorld,e._btColliderObject)}},{key:"_addRigidBody",value:function(e,t,r){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";l.Physics3D._bullet.btDiscreteDynamicsWorld_addRigidBody(this._btCollisionWorld,e._btColliderObject,t,r)}},{key:"_removeRigidBody",value:function(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";l.Physics3D._bullet.btDiscreteDynamicsWorld_removeRigidBody(this._btCollisionWorld,e._btColliderObject)}},{key:"_addCharacter",value:function(e,t,r){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";var n=l.Physics3D._bullet;n.btCollisionWorld_addCollisionObject(this._btCollisionWorld,e._btColliderObject,t,r),n.btDynamicsWorld_addAction(this._btCollisionWorld,e._btKinematicCharacter)}},{key:"_removeCharacter",value:function(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";var t=l.Physics3D._bullet;t.btCollisionWorld_removeCollisionObject(this._btCollisionWorld,e._btColliderObject),t.btDynamicsWorld_removeAction(this._btCollisionWorld,e._btKinematicCharacter)}},{key:"raycastFromTo",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:m.COLLISIONFILTERGROUP_ALLFILTER,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:m.COLLISIONFILTERGROUP_ALLFILTER,a=l.Physics3D._bullet,o=this._btClosestRayResultCallback,s=PhysicsSimulation._btTempVector30,u=PhysicsSimulation._btTempVector31;if(a.btVector3_setValue(s,-e.x,e.y,e.z),a.btVector3_setValue(u,-t.x,t.y,t.z),a.ClosestRayResultCallback_set_m_rayFromWorld(o,s),a.ClosestRayResultCallback_set_m_rayToWorld(o,u),a.RayResultCallback_set_m_collisionFilterGroup(o,n),a.RayResultCallback_set_m_collisionFilterMask(o,i),a.RayResultCallback_set_m_collisionObject(o,null),a.RayResultCallback_set_m_closestHitFraction(o,1),a.btCollisionWorld_rayTest(this._btCollisionWorld,s,u,o),a.RayResultCallback_hasHit(o)){if(r){r.succeeded=!0,r.collider=v._physicObjectsMap[a.btCollisionObject_getUserIndex(a.RayResultCallback_get_m_collisionObject(o))],r.hitFraction=a.RayResultCallback_get_m_closestHitFraction(o);var c=a.ClosestRayResultCallback_get_m_hitPointWorld(o),h=r.point;h.x=-a.btVector3_x(c),h.y=a.btVector3_y(c),h.z=a.btVector3_z(c);var _=a.ClosestRayResultCallback_get_m_hitNormalWorld(o),d=r.normal;d.x=-a.btVector3_x(_),d.y=a.btVector3_y(_),d.z=a.btVector3_z(_)}return!0}return r&&(r.succeeded=!1),!1}},{key:"raycastAllFromTo",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:m.COLLISIONFILTERGROUP_ALLFILTER,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:m.COLLISIONFILTERGROUP_ALLFILTER,a=l.Physics3D._bullet,o=this._btAllHitsRayResultCallback,s=PhysicsSimulation._btTempVector30,u=PhysicsSimulation._btTempVector31;r.length=0,a.btVector3_setValue(s,-e.x,e.y,e.z),a.btVector3_setValue(u,-t.x,t.y,t.z),a.AllHitsRayResultCallback_set_m_rayFromWorld(o,s),a.AllHitsRayResultCallback_set_m_rayToWorld(o,u),a.RayResultCallback_set_m_collisionFilterGroup(o,n),a.RayResultCallback_set_m_collisionFilterMask(o,i);var c=a.AllHitsRayResultCallback_get_m_collisionObjects(o),h=a.AllHitsRayResultCallback_get_m_hitPointWorld(o),_=a.AllHitsRayResultCallback_get_m_hitNormalWorld(o),d=a.AllHitsRayResultCallback_get_m_hitFractions(o);a.tBtCollisionObjectArray_clear(c),a.tVector3Array_clear(h),a.tVector3Array_clear(_),a.tScalarArray_clear(d),a.btCollisionWorld_rayTest(this._btCollisionWorld,s,u,o);var f=a.tBtCollisionObjectArray_size(c);if(f>0){this._collisionsUtils.recoverAllHitResultsPool();for(var T=0;T<f;T++){var p=this._collisionsUtils.getHitResult();r.push(p),p.succeeded=!0,p.collider=v._physicObjectsMap[a.btCollisionObject_getUserIndex(a.tBtCollisionObjectArray_at(c,T))],p.hitFraction=a.tScalarArray_at(d,T);var g=a.tVector3Array_at(h,T),E=p.point;E.x=-a.btVector3_x(g),E.y=a.btVector3_y(g),E.z=a.btVector3_z(g);var y=a.tVector3Array_at(_,T),S=p.normal;S.x=-a.btVector3_x(y),S.y=a.btVector3_y(y),S.z=a.btVector3_z(y)}return!0}return!1}},{key:"rayCast",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2147483647,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:m.COLLISIONFILTERGROUP_ALLFILTER,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:m.COLLISIONFILTERGROUP_ALLFILTER,a=e.origin,s=PhysicsSimulation._tempVector30;return o.normalize(e.direction,s),o.scale(s,r,s),o.add(a,s,s),this.raycastFromTo(a,s,t,n,i)}},{key:"rayCastAll",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2147483647,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:m.COLLISIONFILTERGROUP_ALLFILTER,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:m.COLLISIONFILTERGROUP_ALLFILTER,a=e.origin,s=PhysicsSimulation._tempVector30;return o.normalize(e.direction,s),o.scale(s,r,s),o.add(a,s,s),this.raycastAllFromTo(a,s,t,n,i)}},{key:"shapeCast",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:m.COLLISIONFILTERGROUP_ALLFILTER,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:m.COLLISIONFILTERGROUP_ALLFILTER,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,c=l.Physics3D._bullet,h=this._btClosestConvexResultCallback,_=PhysicsSimulation._btTempVector30,d=PhysicsSimulation._btTempVector31,f=PhysicsSimulation._btTempQuaternion0,T=PhysicsSimulation._btTempQuaternion1,p=PhysicsSimulation._btTempTransform0,g=PhysicsSimulation._btTempTransform1,E=e._btShape;if(c.btVector3_setValue(_,-t.x,t.y,t.z),c.btVector3_setValue(d,-r.x,r.y,r.z),c.ConvexResultCallback_set_m_collisionFilterGroup(h,o),c.ConvexResultCallback_set_m_collisionFilterMask(h,s),c.btTransform_setOrigin(p,_),c.btTransform_setOrigin(g,d),i?(c.btQuaternion_setValue(f,-i.x,i.y,i.z,-i.w),c.btTransform_setRotation(p,f)):c.btTransform_setRotation(p,this._btDefaultQuaternion),a?(c.btQuaternion_setValue(T,-a.x,a.y,a.z,-a.w),c.btTransform_setRotation(g,T)):c.btTransform_setRotation(g,this._btDefaultQuaternion),c.ClosestConvexResultCallback_set_m_hitCollisionObject(h,null),c.ConvexResultCallback_set_m_closestHitFraction(h,1),c.btCollisionWorld_convexSweepTest(this._btCollisionWorld,E,p,g,h,u),c.ConvexResultCallback_hasHit(h)){if(n){n.succeeded=!0,n.collider=v._physicObjectsMap[c.btCollisionObject_getUserIndex(c.ClosestConvexResultCallback_get_m_hitCollisionObject(h))],n.hitFraction=c.ConvexResultCallback_get_m_closestHitFraction(h);var y=c.ClosestConvexResultCallback_get_m_hitPointWorld(h),S=c.ClosestConvexResultCallback_get_m_hitNormalWorld(h),R=n.point,C=n.normal;R.x=-c.btVector3_x(y),R.y=c.btVector3_y(y),R.z=c.btVector3_z(y),C.x=-c.btVector3_x(S),C.y=c.btVector3_y(S),C.z=c.btVector3_z(S)}return!0}return n&&(n.succeeded=!1),!1}},{key:"shapeCastAll",value:function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:m.COLLISIONFILTERGROUP_ALLFILTER,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:m.COLLISIONFILTERGROUP_ALLFILTER,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,c=l.Physics3D._bullet,h=this._btAllConvexResultCallback,_=PhysicsSimulation._btTempVector30,d=PhysicsSimulation._btTempVector31,f=PhysicsSimulation._btTempQuaternion0,T=PhysicsSimulation._btTempQuaternion1,p=PhysicsSimulation._btTempTransform0,g=PhysicsSimulation._btTempTransform1,E=e._btShape;n.length=0,c.btVector3_setValue(_,-t.x,t.y,t.z),c.btVector3_setValue(d,-r.x,r.y,r.z),c.ConvexResultCallback_set_m_collisionFilterGroup(h,o),c.ConvexResultCallback_set_m_collisionFilterMask(h,s),c.btTransform_setOrigin(p,_),c.btTransform_setOrigin(g,d),i?(c.btQuaternion_setValue(f,-i.x,i.y,i.z,-i.w),c.btTransform_setRotation(p,f)):c.btTransform_setRotation(p,this._btDefaultQuaternion),a?(c.btQuaternion_setValue(T,-a.x,a.y,a.z,-a.w),c.btTransform_setRotation(g,T)):c.btTransform_setRotation(g,this._btDefaultQuaternion);var y=c.AllConvexResultCallback_get_m_collisionObjects(h),S=c.AllConvexResultCallback_get_m_hitPointWorld(h),R=c.AllConvexResultCallback_get_m_hitNormalWorld(h),C=c.AllConvexResultCallback_get_m_hitFractions(h);c.tVector3Array_clear(S),c.tVector3Array_clear(R),c.tScalarArray_clear(C),c.tBtCollisionObjectArray_clear(y),c.btCollisionWorld_convexSweepTest(this._btCollisionWorld,E,p,g,h,u);var M=c.tBtCollisionObjectArray_size(y);if(M>0){this._collisionsUtils.recoverAllHitResultsPool();for(var D=0;D<M;D++){var x=this._collisionsUtils.getHitResult();n.push(x),x.succeeded=!0,x.collider=v._physicObjectsMap[c.btCollisionObject_getUserIndex(c.tBtCollisionObjectArray_at(y,D))],x.hitFraction=c.tScalarArray_at(C,D);var A=c.tVector3Array_at(S,D),I=x.point;I.x=-c.btVector3_x(A),I.y=c.btVector3_y(A),I.z=c.btVector3_z(A);var L=c.tVector3Array_at(R,D),P=x.normal;P.x=-c.btVector3_x(L),P.y=c.btVector3_y(L),P.z=c.btVector3_z(L)}return!0}return!1}},{key:"addConstraint",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this._btDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";l.Physics3D._bullet.btCollisionWorld_addConstraint(this._btDiscreteDynamicsWorld,e._btConstraint,t),this._currentConstraint[e.id]=e}},{key:"removeConstraint",value:function(e){if(!this._btDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";l.Physics3D._bullet.btCollisionWorld_removeConstraint(this._btDiscreteDynamicsWorld,e._btConstraint),delete this._currentConstraint[e.id]}},{key:"setHitsRayResultCallbackFlag",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=l.Physics3D._bullet;t.RayResultCallback_set_m_flags(this._btAllHitsRayResultCallback,e),t.RayResultCallback_set_m_flags(this._btClosestRayResultCallback,e)}},{key:"_updatePhysicsTransformFromRender",value:function(){for(var e=this._physicsUpdateList.elements,t=0,r=this._physicsUpdateList.length;t<r;t++){var n=e[t];n._derivePhysicsTransformation(!1),n._inPhysicUpdateListIndex=-1}this._physicsUpdateList.length=0}},{key:"_updateCharacters",value:function(){for(var e=0,t=this._characters.length;e<t;e++){var r=this._characters[e];r._updateTransformComponent(l.Physics3D._bullet.btCollisionObject_getWorldTransform(r._btColliderObject))}}},{key:"_updateCollisions",value:function(){this._collisionsUtils.recoverAllContactPointsPool();var e=this._currentFrameCollisions;this._currentFrameCollisions=this._previousFrameCollisions,this._currentFrameCollisions.length=0,this._previousFrameCollisions=e;for(var r=t.Stat.loopCount,n=l.Physics3D._bullet,i=n.btDispatcher_getNumManifolds(this._btDispatcher),a=0;a<i;a++){var o,s=n.btDispatcher_getManifoldByIndexInternal(this._btDispatcher,a),u=v._physicObjectsMap[n.btCollisionObject_getUserIndex(n.btPersistentManifold_getBody0(s))],c=v._physicObjectsMap[n.btCollisionObject_getUserIndex(n.btPersistentManifold_getBody1(s))],h=null,_=null;if((u.isTrigger||c.isTrigger)&&(u.owner._needProcessTriggers||c.owner._needProcessTriggers))for(var d=n.btPersistentManifold_getNumContacts(s),f=0;f<d;f++){var m=n.btPersistentManifold_getContactPoint(s,f),T=n.btManifoldPoint_getDistance(m);if(T<=0){_=(h=this._collisionsUtils.getCollision(u,c)).contacts,(o=h._updateFrame!==r)&&(h._isTrigger=!0,_.length=0);break}}else if((u.owner._needProcessCollisions||c.owner._needProcessCollisions)&&(u._enableProcessCollisions||c._enableProcessCollisions))for(d=n.btPersistentManifold_getNumContacts(s),f=0;f<d;f++)if(m=n.btPersistentManifold_getContactPoint(s,f),(T=n.btManifoldPoint_getDistance(m))<=0){var p=this._collisionsUtils.getContactPoints();p.colliderA=u,p.colliderB=c,p.distance=T;var g=n.btManifoldPoint_get_m_normalWorldOnB(m),E=p.normal;E.x=-n.btVector3_x(g),E.y=n.btVector3_y(g),E.z=n.btVector3_z(g);var y=n.btManifoldPoint_get_m_positionWorldOnA(m),S=p.positionOnA;S.x=-n.btVector3_x(y),S.y=n.btVector3_y(y),S.z=n.btVector3_z(y);var R=n.btManifoldPoint_get_m_positionWorldOnB(m),C=p.positionOnB;C.x=-n.btVector3_x(R),C.y=n.btVector3_y(R),C.z=n.btVector3_z(R),h||(_=(h=this._collisionsUtils.getCollision(u,c)).contacts,(o=h._updateFrame!==r)&&(h._isTrigger=!1,_.length=0)),_.push(p)}h&&o&&(this._currentFrameCollisions.push(h),h._setUpdateFrame(r))}}},{key:"_eventScripts",value:function(){for(var e=t.Stat.loopCount,r=0,n=this._currentFrameCollisions.length;r<n;r++){var i=this._currentFrameCollisions[r],a=i._colliderA,o=i._colliderB;if(!a.destroyed&&!o.destroyed)if(e-i._lastUpdateFrame==1){var s=a.owner,l=s._scripts;if(l)if(i._isTrigger){if(s._needProcessTriggers)for(var u=0,c=l.length;u<c;u++)l[u].onTriggerStay(o)}else if(s._needProcessCollisions)for(u=0,c=l.length;u<c;u++)i.other=o,l[u].onCollisionStay(i);var h=o.owner,_=h._scripts;if(_)if(i._isTrigger){if(h._needProcessTriggers)for(u=0,c=_.length;u<c;u++)_[u].onTriggerStay(a)}else if(h._needProcessCollisions)for(u=0,c=_.length;u<c;u++)i.other=a,_[u].onCollisionStay(i)}else{if(l=(s=a.owner)._scripts)if(i._isTrigger){if(s._needProcessTriggers)for(u=0,c=l.length;u<c;u++)l[u].onTriggerEnter(o)}else if(s._needProcessCollisions)for(u=0,c=l.length;u<c;u++)i.other=o,l[u].onCollisionEnter(i);if(_=(h=o.owner)._scripts)if(i._isTrigger){if(h._needProcessTriggers)for(u=0,c=_.length;u<c;u++)_[u].onTriggerEnter(a)}else if(h._needProcessCollisions)for(u=0,c=_.length;u<c;u++)i.other=a,_[u].onCollisionEnter(i)}}for(r=0,n=this._previousFrameCollisions.length;r<n;r++){var d=this._previousFrameCollisions[r],f=d._colliderA,m=d._colliderB;if(!f.destroyed&&!m.destroyed&&e-d._updateFrame==1){if(this._collisionsUtils.recoverCollision(d),l=(s=f.owner)._scripts)if(d._isTrigger){if(s._needProcessTriggers)for(u=0,c=l.length;u<c;u++)l[u].onTriggerExit(m)}else if(s._needProcessCollisions)for(u=0,c=l.length;u<c;u++)d.other=m,l[u].onCollisionExit(d);if(_=(h=m.owner)._scripts)if(d._isTrigger){if(h._needProcessTriggers)for(u=0,c=_.length;u<c;u++)_[u].onTriggerExit(f)}else if(h._needProcessCollisions)for(u=0,c=_.length;u<c;u++)d.other=f,_[u].onCollisionExit(d)}}for(var T in this._currentConstraint){var p=this._currentConstraint[T],g=p.owner._scripts;if(p.enabled&&p._isBreakConstrained()&&g&&0!=g.length)for(r=0,n=g.length;r<n;r++)g[r].onJointBreak()}}},{key:"clearForces",value:function(){if(!this._btDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";l.Physics3D._bullet.btDiscreteDynamicsWorld_clearForces(this._btDiscreteDynamicsWorld)}},{key:"continuousCollisionDetection",get:function(){return l.Physics3D._bullet.btCollisionWorld_get_m_useContinuous(this._btDispatchInfo)},set:function(e){l.Physics3D._bullet.btCollisionWorld_set_m_useContinuous(this._btDispatchInfo,e)}},{key:"gravity",get:function(){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";return this._gravity},set:function(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._gravity=e;var t=l.Physics3D._bullet,r=PhysicsSimulation._btTempVector30;t.btVector3_setValue(r,-e.x,e.y,e.z),t.btDiscreteDynamicsWorld_setGravity(this._btDiscreteDynamicsWorld,r)}},{key:"speculativeContactRestitution",get:function(){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot Cannot perform this action when the physics engine is set to CollisionsOnly";return l.Physics3D._bullet.btDiscreteDynamicsWorld_getApplySpeculativeContactRestitution(this._btDiscreteDynamicsWorld)},set:function(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot Cannot perform this action when the physics engine is set to CollisionsOnly";l.Physics3D._bullet.btDiscreteDynamicsWorld_setApplySpeculativeContactRestitution(this._btDiscreteDynamicsWorld,e)}}],[{key:"__init__",value:function(){var e=l.Physics3D._bullet;PhysicsSimulation._btTempVector30=e.btVector3_create(0,0,0),PhysicsSimulation._btTempVector31=e.btVector3_create(0,0,0),PhysicsSimulation._btTempQuaternion0=e.btQuaternion_create(0,0,0,1),PhysicsSimulation._btTempQuaternion1=e.btQuaternion_create(0,0,0,1),PhysicsSimulation._btTempTransform0=e.btTransform_create(),PhysicsSimulation._btTempTransform1=e.btTransform_create()}},{key:"createConstraint",value:function(){}}]),PhysicsSimulation}();I.PHYSICSENGINEFLAGS_NONE=0,I.PHYSICSENGINEFLAGS_COLLISIONSONLY=1,I.PHYSICSENGINEFLAGS_SOFTBODYSUPPORT=2,I.PHYSICSENGINEFLAGS_MULTITHREADED=4,I.PHYSICSENGINEFLAGS_USEHARDWAREWHENPOSSIBLE=8,I.SOLVERMODE_RANDMIZE_ORDER=1,I.SOLVERMODE_FRICTION_SEPARATE=2,I.SOLVERMODE_USE_WARMSTARTING=4,I.SOLVERMODE_USE_2_FRICTION_DIRECTIONS=16,I.SOLVERMODE_ENABLE_FRICTION_DIRECTION_CACHING=32,I.SOLVERMODE_DISABLE_VELOCITY_DEPENDENT_FRICTION_DIRECTION=64,I.SOLVERMODE_CACHE_FRIENDLY=128,I.SOLVERMODE_SIMD=256,I.SOLVERMODE_INTERLEAVE_CONTACT_AND_FRICTION_CONSTRAINTS=512,I.SOLVERMODE_ALLOW_ZERO_LENGTH_FRICTION_DIRECTIONS=1024,I.HITSRAYRESULTCALLBACK_FLAG_NONE=0,I.HITSRAYRESULTCALLBACK_FLAG_FILTERBACKFACESS=1,I.HITSRAYRESULTCALLBACK_FLAG_KEEPUNFILIPPEDNORMAL=2,I.HITSRAYRESULTCALLBACK_FLAG_USESUBSIMPLEXCONVEXCASTRAYTEST=4,I.HITSRAYRESULTCALLBACK_FLAG_USEGJKCONVEXCASTRAYTEST=8,I.HITSRAYRESULTCALLBACK_FLAG_TERMINATOR=4294967295,I._tempVector30=new o,I.disableSimulation=!1;var L=function(){function TextureGenerator(){_classCallCheck(this,TextureGenerator)}return _createClass(TextureGenerator,null,[{key:"lightAttenTexture",value:function(e,t,r,n,i,a){var o=e/r,s=1/(1+25*o);o>=.64&&(o>1?s=0:s*=1-(o-.64)/.36),a[i]=Math.floor(255*s+.5)}},{key:"haloTexture",value:function(e,t,r,n,i,a){var o=(e-(r>>=1))/r,s=(t-(n>>=1))/n,l=o*o+s*s;l>1&&(l=1),a[i]=Math.floor(255*(1-l)+.5)}},{key:"_generateTexture2D",value:function(e,r,n,i){var a=0,o=0;switch(e.format){case t.TextureFormat.R8G8B8:o=3;break;case t.TextureFormat.R8G8B8A8:o=4;break;case t.TextureFormat.Alpha8:o=1;break;default:throw"GeneratedTexture._generateTexture: unkonw texture format."}for(var s=new Uint8Array(r*n*o),l=0;l<n;l++)for(var u=0;u<r;u++)i(u,l,r,n,a,s),a+=o;e.setPixels(s)}}]),TextureGenerator}(),P=function(){function Utils3D(){_classCallCheck(this,Utils3D)}return _createClass(Utils3D,null,[{key:"_createFloatTextureBuffer",value:function(e,r){var n=new t.Texture2D(e,r,t.TextureFormat.R32G32B32A32,!1,!1);return n.filterMode=t.FilterMode.Point,n.wrapModeU=t.WarpMode.Clamp,n.wrapModeV=t.WarpMode.Clamp,n.anisoLevel=0,n}},{key:"_convertToLayaVec3",value:function(e,t,r){var n=l.Physics3D._bullet;t.x=r?-n.btVector3_x(e):n.btVector3_x(e),t.y=n.btVector3_y(e),t.z=n.btVector3_z(e)}},{key:"_convertToBulletVec3",value:function(e,t,r){l.Physics3D._bullet.btVector3_setValue(t,r?-e.x:e.x,e.y,e.z)}},{key:"_rotationTransformScaleSkinAnimation",value:function(e,t,r,n,i,a,o,s,l,u,c,h){var _,d,f,m,T,p=Utils3D._tempArray16_0,g=Utils3D._tempArray16_1,E=Utils3D._tempArray16_2,y=n+n,S=i+i,v=a+a,R=n*y,C=i*y,M=i*S,D=a*y,x=a*S,A=a*v,I=o*y,L=o*S,P=o*v;for(p[15]=1,p[0]=1-M-A,p[1]=C+P,p[2]=D-L,p[4]=C-P,p[5]=1-R-A,p[6]=x+I,p[8]=D+L,p[9]=x-I,p[10]=1-R-M,g[15]=1,g[0]=s,g[5]=l,g[10]=u,_=0;_<4;_++)d=p[_],f=p[_+4],m=p[_+8],T=p[_+12],E[_]=d,E[_+4]=f,E[_+8]=m,E[_+12]=d*e+f*t+m*r+T;for(_=0;_<4;_++)d=E[_],f=E[_+4],m=E[_+8],T=E[_+12],c[_+h]=d*g[0]+f*g[1]+m*g[2]+T*g[3],c[_+h+4]=d*g[4]+f*g[5]+m*g[6]+T*g[7],c[_+h+8]=d*g[8]+f*g[9]+m*g[10]+T*g[11],c[_+h+12]=d*g[12]+f*g[13]+m*g[14]+T*g[15]}},{key:"_computeBoneAndAnimationDatasByBindPoseMatrxix",value:function(e,t,r,n,i,a){var o,s,l=0,u=0,c=e.length;for(o=0;o<c;l+=e[o].keyframeWidth,u+=16,o++)Utils3D._rotationTransformScaleSkinAnimation(t[l+0],t[l+1],t[l+2],t[l+3],t[l+4],t[l+5],t[l+6],t[l+7],t[l+8],t[l+9],n,u),0!=o&&(s=16*e[o].parentIndex,Utils3D.mulMatrixByArray(n,s,n,u,n,u));var h=r.length;for(o=0;o<h;o++)Utils3D.mulMatrixByArrayAndMatrixFast(n,16*a[o],r[o],i,16*o)}},{key:"_computeAnimationDatasByArrayAndMatrixFast",value:function(e,t,r,n){for(var i=0,a=e.length;i<a;i++)Utils3D.mulMatrixByArrayAndMatrixFast(t,16*n[i],e[i],r,16*i)}},{key:"_computeBoneAndAnimationDatasByBindPoseMatrxixOld",value:function(e,t,r,n,i){var a,o,s=0,l=0,u=e.length;for(a=0;a<u;s+=e[a].keyframeWidth,l+=16,a++)Utils3D._rotationTransformScaleSkinAnimation(t[s+7],t[s+8],t[s+9],t[s+3],t[s+4],t[s+5],t[s+6],t[s+0],t[s+1],t[s+2],n,l),0!=a&&(o=16*e[a].parentIndex,Utils3D.mulMatrixByArray(n,o,n,l,n,l));var c=r.length;for(a=0;a<c;a++){var h=16*a;Utils3D.mulMatrixByArrayAndMatrixFast(n,h,r[a],i,h)}}},{key:"_computeAnimationDatasByArrayAndMatrixFastOld",value:function(e,t,r){for(var n=e.length,i=0;i<n;i++){var a=16*i;Utils3D.mulMatrixByArrayAndMatrixFast(t,a,e[i],r,a)}}},{key:"_computeRootAnimationData",value:function(e,t,r){for(var n=0,i=0,a=0,o=e.length;n<o;i+=e[n].keyframeWidth,a+=16,n++)Utils3D.createAffineTransformationArray(t[i+0],t[i+1],t[i+2],t[i+3],t[i+4],t[i+5],t[i+6],t[i+7],t[i+8],t[i+9],r,a)}},{key:"transformVector3ArrayByQuat",value:function(e,t,r,n,i){var a=e[t],o=e[t+1],s=e[t+2],l=r.x,u=r.y,c=r.z,h=r.w,_=h*a+u*s-c*o,d=h*o+c*a-l*s,f=h*s+l*o-u*a,m=-l*a-u*o-c*s;n[i]=_*h+m*-l+d*-c-f*-u,n[i+1]=d*h+m*-u+f*-l-_*-c,n[i+2]=f*h+m*-c+_*-u-d*-l}},{key:"mulMatrixByArray",value:function(e,t,r,n,i,a){var o,s,l,u,c;if(i===r){for(r=Utils3D._tempArray16_3,o=0;o<16;++o)r[o]=i[a+o];n=0}for(o=0;o<4;o++)s=e[t+o],l=e[t+o+4],u=e[t+o+8],c=e[t+o+12],i[a+o]=s*r[n+0]+l*r[n+1]+u*r[n+2]+c*r[n+3],i[a+o+4]=s*r[n+4]+l*r[n+5]+u*r[n+6]+c*r[n+7],i[a+o+8]=s*r[n+8]+l*r[n+9]+u*r[n+10]+c*r[n+11],i[a+o+12]=s*r[n+12]+l*r[n+13]+u*r[n+14]+c*r[n+15]}},{key:"mulMatrixByArrayFast",value:function(e,t,r,n,i,a){var o,s,l,u,c;for(o=0;o<4;o++)s=e[t+o],l=e[t+o+4],u=e[t+o+8],c=e[t+o+12],i[a+o]=s*r[n+0]+l*r[n+1]+u*r[n+2]+c*r[n+3],i[a+o+4]=s*r[n+4]+l*r[n+5]+u*r[n+6]+c*r[n+7],i[a+o+8]=s*r[n+8]+l*r[n+9]+u*r[n+10]+c*r[n+11],i[a+o+12]=s*r[n+12]+l*r[n+13]+u*r[n+14]+c*r[n+15]}},{key:"mulMatrixByArrayAndMatrixFast",value:function(e,t,r,n,i){var a,o,s,l,u,c=r.elements,h=c[0],_=c[1],d=c[2],f=c[3],m=c[4],T=c[5],p=c[6],g=c[7],E=c[8],y=c[9],S=c[10],v=c[11],R=c[12],C=c[13],M=c[14],D=c[15],x=t,A=t+4,I=t+8,L=t+12,P=i,O=i+4,N=i+8,b=i+12;for(a=0;a<4;a++)o=e[x+a],s=e[A+a],l=e[I+a],u=e[L+a],n[P+a]=o*h+s*_+l*d+u*f,n[O+a]=o*m+s*T+l*p+u*g,n[N+a]=o*E+s*y+l*S+u*v,n[b+a]=o*R+s*C+l*M+u*D}},{key:"createAffineTransformationArray",value:function(e,t,r,n,i,a,o,s,l,u,c,h){var _=n+n,d=i+i,f=a+a,m=n*_,T=n*d,p=n*f,g=i*d,E=i*f,y=a*f,S=o*_,v=o*d,R=o*f;c[h+0]=(1-(g+y))*s,c[h+1]=(T+R)*s,c[h+2]=(p-v)*s,c[h+3]=0,c[h+4]=(T-R)*l,c[h+5]=(1-(m+y))*l,c[h+6]=(E+S)*l,c[h+7]=0,c[h+8]=(p+v)*u,c[h+9]=(E-S)*u,c[h+10]=(1-(m+g))*u,c[h+11]=0,c[h+12]=e,c[h+13]=t,c[h+14]=r,c[h+15]=1}},{key:"transformVector3ArrayToVector3ArrayCoordinate",value:function(e,t,r,n,i){var a=e[t+0],o=e[t+1],s=e[t+2],l=r.elements,u=a*l[3]+o*l[7]+s*l[11]+l[15];n[i]=a*l[0]+o*l[4]+s*l[8]+l[12]/u,n[i+1]=a*l[1]+o*l[5]+s*l[9]+l[13]/u,n[i+2]=a*l[2]+o*l[6]+s*l[10]+l[14]/u}},{key:"transformVector3ArrayToVector3ArrayNormal",value:function(e,t,r,n,i){var a=e[t+0],o=e[t+1],s=e[t+2],l=r.elements;n[i]=a*l[0]+o*l[4]+s*l[8],n[i+1]=a*l[1]+o*l[5]+s*l[9],n[i+2]=a*l[2]+o*l[6]+s*l[10]}},{key:"transformLightingMapTexcoordArray",value:function(e,t,r,n,i){n[i+0]=e[t+0]*r.x+r.z,n[i+1]=1-((1-e[t+1])*r.y+r.w)}},{key:"getURLVerion",value:function(e){var t=e.indexOf("?");return t>=0?e.substr(t):null}},{key:"_createAffineTransformationArray",value:function(e,t,r,n){var i=t.x,a=t.y,o=t.z,s=t.w,l=i+i,u=a+a,c=o+o,h=i*l,_=i*u,d=i*c,f=a*u,m=a*c,T=o*c,p=s*l,g=s*u,E=s*c,y=r.x,S=r.y,v=r.z;n[0]=(1-(f+T))*y,n[1]=(_+E)*y,n[2]=(d-g)*y,n[3]=0,n[4]=(_-E)*S,n[5]=(1-(h+T))*S,n[6]=(m+p)*S,n[7]=0,n[8]=(d+g)*v,n[9]=(m-p)*v,n[10]=(1-(h+f))*v,n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1}},{key:"_mulMatrixArray",value:function(e,t,r,n,i){var a=t,o=e,s=n,l=a[r],u=a[r+1],c=a[r+2],h=a[r+3],_=a[r+4],d=a[r+5],f=a[r+6],m=a[r+7],T=a[r+8],p=a[r+9],g=a[r+10],E=a[r+11],y=a[r+12],S=a[r+13],v=a[r+14],R=a[r+15],C=o[0],M=o[1],D=o[2],x=o[3],A=o[4],I=o[5],L=o[6],P=o[7],O=o[8],N=o[9],b=o[10],k=o[11],w=o[12],B=o[13],V=o[14],F=o[15];s[i]=l*C+u*A+c*O+h*w,s[i+1]=l*M+u*I+c*N+h*B,s[i+2]=l*D+u*L+c*b+h*V,s[i+3]=l*x+u*P+c*k+h*F,s[i+4]=_*C+d*A+f*O+m*w,s[i+5]=_*M+d*I+f*N+m*B,s[i+6]=_*D+d*L+f*b+m*V,s[i+7]=_*x+d*P+f*k+m*F,s[i+8]=T*C+p*A+g*O+E*w,s[i+9]=T*M+p*I+g*N+E*B,s[i+10]=T*D+p*L+g*b+E*V,s[i+11]=T*x+p*P+g*k+E*F,s[i+12]=y*C+S*A+v*O+R*w,s[i+13]=y*M+S*I+v*N+R*B,s[i+14]=y*D+S*L+v*b+R*V,s[i+15]=y*x+S*P+v*k+R*F}},{key:"arcTanAngle",value:function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}},{key:"angleTo",value:function(e,t,r){o.subtract(t,e,u.TEMPVector30),o.normalize(u.TEMPVector30,u.TEMPVector30),r.x=Math.asin(u.TEMPVector30.y),r.y=Utils3D.arcTanAngle(-u.TEMPVector30.z,-u.TEMPVector30.x)}},{key:"transformQuat",value:function(e,t,r){var n=t,i=e.x,a=e.y,o=e.z,s=n[0],l=n[1],u=n[2],c=n[3],h=c*i+l*o-u*a,_=c*a+u*i-s*o,d=c*o+s*a-l*i,f=-s*i-l*a-u*o;r.x=h*c+f*-s+_*-u-d*-l,r.y=_*c+f*-l+d*-s-h*-u,r.z=d*c+f*-u+h*-l-_*-s}},{key:"quaternionWeight",value:function(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t,r.w=e.w}},{key:"quaternionConjugate",value:function(e,t){t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w}},{key:"scaleWeight",value:function(e,t,r){var n=e.x,i=e.y,a=e.z;r.x=n>0?Math.pow(Math.abs(n),t):-Math.pow(Math.abs(n),t),r.y=i>0?Math.pow(Math.abs(i),t):-Math.pow(Math.abs(i),t),r.z=a>0?Math.pow(Math.abs(a),t):-Math.pow(Math.abs(a),t)}},{key:"scaleBlend",value:function(e,t,r,n){var i=Utils3D._tempVector3_0,a=Utils3D._tempVector3_1;Utils3D.scaleWeight(e,1-r,i),Utils3D.scaleWeight(t,r,a);var o=r>.5?t:e;n.x=o.x>0?Math.abs(i.x*a.x):-Math.abs(i.x*a.x),n.y=o.y>0?Math.abs(i.y*a.y):-Math.abs(i.y*a.y),n.z=o.z>0?Math.abs(i.z*a.z):-Math.abs(i.z*a.z)}},{key:"matrix4x4MultiplyFFF",value:function(e,t,r){var n,i,a,o,s;if(r===t)for(t=new Float32Array(16),n=0;n<16;++n)t[n]=r[n];var l=t[0],u=t[1],c=t[2],h=t[3],_=t[4],d=t[5],f=t[6],m=t[7],T=t[8],p=t[9],g=t[10],E=t[11],y=t[12],S=t[13],v=t[14],R=t[15];for(n=0;n<4;n++)i=e[n],a=e[n+4],o=e[n+8],s=e[n+12],r[n]=i*l+a*u+o*c+s*h,r[n+4]=i*_+a*d+o*f+s*m,r[n+8]=i*T+a*p+o*g+s*E,r[n+12]=i*y+a*S+o*v+s*R}},{key:"matrix4x4MultiplyFFFForNative",value:function(e,r,n){t.LayaGL.instance.matrix4x4Multiply(e,r,n)}},{key:"matrix4x4MultiplyMFM",value:function(e,t,r){Utils3D.matrix4x4MultiplyFFF(e.elements,t,r.elements)}},{key:"_buildTexture2D",value:function(e,r,n,i){var a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=new t.Texture2D(e,r,n,a,!0);return o.anisoLevel=1,o.filterMode=t.FilterMode.Point,L._generateTexture2D(o,e,r,i),o}},{key:"_drawBound",value:function(e,t,r){e.lineCount+12>e.maxLineCount&&(e.maxLineCount+=12);var n=Utils3D._tempVector3_0,i=Utils3D._tempVector3_1,a=t.min,o=t.max;n.setValue(a.x,a.y,a.z),i.setValue(o.x,a.y,a.z),e.addLine(n,i,r,r),n.setValue(a.x,a.y,a.z),i.setValue(a.x,a.y,o.z),e.addLine(n,i,r,r),n.setValue(o.x,a.y,a.z),i.setValue(o.x,a.y,o.z),e.addLine(n,i,r,r),n.setValue(a.x,a.y,o.z),i.setValue(o.x,a.y,o.z),e.addLine(n,i,r,r),n.setValue(a.x,a.y,a.z),i.setValue(a.x,o.y,a.z),e.addLine(n,i,r,r),n.setValue(a.x,a.y,o.z),i.setValue(a.x,o.y,o.z),e.addLine(n,i,r,r),n.setValue(o.x,a.y,a.z),i.setValue(o.x,o.y,a.z),e.addLine(n,i,r,r),n.setValue(o.x,a.y,o.z),i.setValue(o.x,o.y,o.z),e.addLine(n,i,r,r),n.setValue(a.x,o.y,a.z),i.setValue(o.x,o.y,a.z),e.addLine(n,i,r,r),n.setValue(a.x,o.y,a.z),i.setValue(a.x,o.y,o.z),e.addLine(n,i,r,r),n.setValue(o.x,o.y,a.z),i.setValue(o.x,o.y,o.z),e.addLine(n,i,r,r),n.setValue(a.x,o.y,o.z),i.setValue(o.x,o.y,o.z),e.addLine(n,i,r,r)}},{key:"_getHierarchyPath",value:function(e,t,r){r.length=0;for(var n=t;n!==e;){var i=n._parent;if(!i)return null;r.push(i.getChildIndex(n)),n=i}return r}},{key:"_getNodeByHierarchyPath",value:function(e,t){for(var r=e,n=t.length-1;n>=0;n--)r=r.getChildAt(t[n]);return r}}]),Utils3D}();P._tempVector3_0=new o,P._tempVector3_1=new o,P._tempArray16_0=new Float32Array(16),P._tempArray16_1=new Float32Array(16),P._tempArray16_2=new Float32Array(16),P._tempArray16_3=new Float32Array(16),P._compIdToNode=new Object;var O=function(e){function CharacterController(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:m.COLLISIONFILTERGROUP_DEFAULTFILTER,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:m.COLLISIONFILTERGROUP_ALLFILTER;return _classCallCheck(this,CharacterController),(e=_possibleConstructorReturn(this,_getPrototypeOf(CharacterController).call(this,n,i)))._upAxis=new o(0,1,0),e._maxSlope=45,e._jumpSpeed=10,e._fallSpeed=55,e._gravity=new o(0,3*-9.8,0),e._btKinematicCharacter=null,e._stepHeight=t,r&&(e._upAxis=r),e._controlBySimulation=!0,e}return _inherits(CharacterController,e),_createClass(CharacterController,[{key:"_constructCharacter",value:function(){var e=l.Physics3D._bullet;this._btKinematicCharacter&&e.btKinematicCharacterController_destroy(this._btKinematicCharacter);var t=CharacterController._btTempVector30;e.btVector3_setValue(t,this._upAxis.x,this._upAxis.y,this._upAxis.z),this._btKinematicCharacter=e.btKinematicCharacterController_create(this._btColliderObject,this._colliderShape._btShape,this._stepHeight,t),this.fallSpeed=this._fallSpeed,this.maxSlope=this._maxSlope,this.jumpSpeed=this._jumpSpeed,this.gravity=this._gravity}},{key:"_onShapeChange",value:function(e){_get(_getPrototypeOf(CharacterController.prototype),"_onShapeChange",this).call(this,e),this._constructCharacter()}},{key:"_onAdded",value:function(){var e=l.Physics3D._bullet,t=e.btPairCachingGhostObject_create();e.btCollisionObject_setUserIndex(t,this.id),e.btCollisionObject_setCollisionFlags(t,v.COLLISIONFLAGS_CHARACTER_OBJECT),this._btColliderObject=t,this._colliderShape&&this._constructCharacter(),_get(_getPrototypeOf(CharacterController.prototype),"_onAdded",this).call(this)}},{key:"_addToSimulation",value:function(){this._simulation._characters.push(this),this._simulation._addCharacter(this,this._collisionGroup,this._canCollideWith)}},{key:"_removeFromSimulation",value:function(){this._simulation._removeCharacter(this);var e=this._simulation._characters;e.splice(e.indexOf(this),1)}},{key:"_cloneTo",value:function(e){_get(_getPrototypeOf(CharacterController.prototype),"_cloneTo",this).call(this,e);var t=e;t.stepHeight=this._stepHeight,t.upAxis=this._upAxis,t.maxSlope=this._maxSlope,t.jumpSpeed=this._jumpSpeed,t.fallSpeed=this._fallSpeed,t.gravity=this._gravity}},{key:"_onDestroy",value:function(){l.Physics3D._bullet.btKinematicCharacterController_destroy(this._btKinematicCharacter),_get(_getPrototypeOf(CharacterController.prototype),"_onDestroy",this).call(this),this._btKinematicCharacter=null}},{key:"move",value:function(e){var t=CharacterController._btVector30,r=l.Physics3D._bullet;r.btVector3_setValue(t,-e.x,e.y,e.z),r.btKinematicCharacterController_setWalkDirection(this._btKinematicCharacter,t)}},{key:"jump",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=l.Physics3D._bullet,r=CharacterController._btVector30;e?(P._convertToBulletVec3(e,r,!0),t.btKinematicCharacterController_jump(this._btKinematicCharacter,r)):(t.btVector3_setValue(r,0,0,0),t.btKinematicCharacterController_jump(this._btKinematicCharacter,r))}},{key:"fallSpeed",get:function(){return this._fallSpeed},set:function(e){this._fallSpeed=e,l.Physics3D._bullet.btKinematicCharacterController_setFallSpeed(this._btKinematicCharacter,e)}},{key:"jumpSpeed",get:function(){return this._jumpSpeed},set:function(e){this._jumpSpeed=e,l.Physics3D._bullet.btKinematicCharacterController_setJumpSpeed(this._btKinematicCharacter,e)}},{key:"gravity",get:function(){return this._gravity},set:function(e){this._gravity=e;var t=l.Physics3D._bullet,r=CharacterController._btTempVector30;t.btVector3_setValue(r,-e.x,e.y,e.z),t.btKinematicCharacterController_setGravity(this._btKinematicCharacter,r)}},{key:"maxSlope",get:function(){return this._maxSlope},set:function(e){this._maxSlope=e,l.Physics3D._bullet.btKinematicCharacterController_setMaxSlope(this._btKinematicCharacter,e/180*Math.PI)}},{key:"isGrounded",get:function(){return l.Physics3D._bullet.btKinematicCharacterController_onGround(this._btKinematicCharacter)}},{key:"stepHeight",get:function(){return this._stepHeight},set:function(e){this._stepHeight=e,l.Physics3D._bullet.btKinematicCharacterController_setStepHeight(this._btKinematicCharacter,e)}},{key:"upAxis",get:function(){return this._upAxis},set:function(e){this._upAxis=e;var t=CharacterController._btTempVector30;P._convertToBulletVec3(e,t,!1),l.Physics3D._bullet.btKinematicCharacterController_setUp(this._btKinematicCharacter,t)}}],[{key:"__init__",value:function(){CharacterController._btTempVector30=l.Physics3D._bullet.btVector3_create(0,0,0)}}]),CharacterController}(v);O.UPAXIS_X=0,O.UPAXIS_Y=1,O.UPAXIS_Z=2;var N=function(e){function PhysicsTriggerComponent(e,t){var r;return _classCallCheck(this,PhysicsTriggerComponent),(r=_possibleConstructorReturn(this,_getPrototypeOf(PhysicsTriggerComponent).call(this,e,t)))._isTrigger=!1,r}return _inherits(PhysicsTriggerComponent,e),_createClass(PhysicsTriggerComponent,[{key:"_onAdded",value:function(){_get(_getPrototypeOf(PhysicsTriggerComponent.prototype),"_onAdded",this).call(this),this.isTrigger=this._isTrigger}},{key:"_cloneTo",value:function(e){_get(_getPrototypeOf(PhysicsTriggerComponent.prototype),"_cloneTo",this).call(this,e),e.isTrigger=this._isTrigger}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(e){this._isTrigger=e;var t=l.Physics3D._bullet;if(this._btColliderObject){var r=t.btCollisionObject_getCollisionFlags(this._btColliderObject);e?0==(r&v.COLLISIONFLAGS_NO_CONTACT_RESPONSE)&&t.btCollisionObject_setCollisionFlags(this._btColliderObject,r|v.COLLISIONFLAGS_NO_CONTACT_RESPONSE):0!=(r&v.COLLISIONFLAGS_NO_CONTACT_RESPONSE)&&t.btCollisionObject_setCollisionFlags(this._btColliderObject,r^v.COLLISIONFLAGS_NO_CONTACT_RESPONSE)}}}]),PhysicsTriggerComponent}(v),b=function(e){function Rigidbody3D(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:m.COLLISIONFILTERGROUP_DEFAULTFILTER,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:m.COLLISIONFILTERGROUP_ALLFILTER;return _classCallCheck(this,Rigidbody3D),(e=_possibleConstructorReturn(this,_getPrototypeOf(Rigidbody3D).call(this,t,r)))._isKinematic=!1,e._mass=1,e._gravity=new o(0,-10,0),e._angularDamping=0,e._linearDamping=0,e._overrideGravity=!1,e._totalTorque=new o(0,0,0),e._totalForce=new o(0,0,0),e._linearVelocity=new o,e._angularVelocity=new o,e._linearFactor=new o(1,1,1),e._angularFactor=new o(1,1,1),e._detectCollisions=!0,e._controlBySimulation=!0,e}return _inherits(Rigidbody3D,e),_createClass(Rigidbody3D,[{key:"_updateMass",value:function(e){if(this._btColliderObject&&this._colliderShape){var t=l.Physics3D._bullet;t.btCollisionShape_calculateLocalInertia(this._colliderShape._btShape,e,Rigidbody3D._btInertia),t.btRigidBody_setMassProps(this._btColliderObject,e,Rigidbody3D._btInertia),t.btRigidBody_updateInertiaTensor(this._btColliderObject)}}},{key:"_onScaleChange",value:function(e){_get(_getPrototypeOf(Rigidbody3D.prototype),"_onScaleChange",this).call(this,e),this._updateMass(this._isKinematic?0:this._mass)}},{key:"_derivePhysicsTransformation",value:function(e){var t=l.Physics3D._bullet,r=this._btColliderObject,n=t.btCollisionObject_getWorldTransform(r),i=Rigidbody3D._btTransform0;t.btTransform_equal(i,n),this._innerDerivePhysicsTransformation(i,e),t.btRigidBody_setCenterOfMassTransform(r,i)}},{key:"_onAdded",value:function(){var e=l.Physics3D._bullet,t=e.layaMotionState_create();e.layaMotionState_set_rigidBodyID(t,this._id),this._btLayaMotionState=t;var r=e.btRigidBodyConstructionInfo_create(0,t,null,Rigidbody3D._btVector3Zero),n=e.btRigidBody_create(r);e.btCollisionObject_setUserIndex(n,this.id),this._btColliderObject=n,_get(_getPrototypeOf(Rigidbody3D.prototype),"_onAdded",this).call(this),this.mass=this._mass,this.linearFactor=this._linearFactor,this.angularFactor=this._angularFactor,this.linearDamping=this._linearDamping,this.angularDamping=this._angularDamping,this.overrideGravity=this._overrideGravity,this.gravity=this._gravity,this.isKinematic=this._isKinematic,e.btRigidBodyConstructionInfo_destroy(r)}},{key:"_onEnable",value:function(){_get(_getPrototypeOf(Rigidbody3D.prototype),"_onEnable",this).call(this),this._constaintRigidbodyA&&this._constaintRigidbodyA.connectedBody._simulation&&(this._constaintRigidbodyA._createConstraint(),this._constaintRigidbodyA._onEnable()),this._constaintRigidbodyB&&this._constaintRigidbodyB.ownBody._simulation&&(this._constaintRigidbodyB._createConstraint(),this._constaintRigidbodyB._onEnable())}},{key:"_onShapeChange",value:function(e){if(_get(_getPrototypeOf(Rigidbody3D.prototype),"_onShapeChange",this).call(this,e),this._isKinematic)this._updateMass(0);else{var t=l.Physics3D._bullet;t.btRigidBody_setCenterOfMassTransform(this._btColliderObject,t.btCollisionObject_getWorldTransform(this._btColliderObject)),this._updateMass(this._mass)}}},{key:"_parse",value:function(e){if(null!=e.friction&&(this.friction=e.friction),null!=e.rollingFriction&&(this.rollingFriction=e.rollingFriction),null!=e.restitution&&(this.restitution=e.restitution),null!=e.isTrigger&&(this.isTrigger=e.isTrigger),null!=e.mass&&(this.mass=e.mass),null!=e.linearDamping&&(this.linearDamping=e.linearDamping),null!=e.angularDamping&&(this.angularDamping=e.angularDamping),null!=e.overrideGravity&&(this.overrideGravity=e.overrideGravity),null!=e.linearFactor){var t=this.linearFactor;t.fromArray(e.linearFactor),this.linearFactor=t}if(null!=e.angularFactor){var r=this.angularFactor;r.fromArray(e.angularFactor),this.angularFactor=r}e.gravity&&(this.gravity.fromArray(e.gravity),this.gravity=this.gravity),_get(_getPrototypeOf(Rigidbody3D.prototype),"_parse",this).call(this,e),this._parseShape(e.shapes),null!=e.isKinematic&&(this.isKinematic=e.isKinematic)}},{key:"_onDestroy",value:function(){l.Physics3D._bullet.btMotionState_destroy(this._btLayaMotionState),_get(_getPrototypeOf(Rigidbody3D.prototype),"_onDestroy",this).call(this),this._btLayaMotionState=null,this._gravity=null,this._totalTorque=null,this._linearVelocity=null,this._angularVelocity=null,this._linearFactor=null,this._angularFactor=null,this.constaintRigidbodyA&&this.constaintRigidbodyA._breakConstrained(),this.constaintRigidbodyB&&(this.constaintRigidbodyB.connectedBody=null,this.constaintRigidbodyB._onDisable())}},{key:"_addToSimulation",value:function(){this._simulation._addRigidBody(this,this._collisionGroup,this._detectCollisions?this._canCollideWith:0)}},{key:"_removeFromSimulation",value:function(){this._simulation._removeRigidBody(this)}},{key:"_cloneTo",value:function(e){_get(_getPrototypeOf(Rigidbody3D.prototype),"_cloneTo",this).call(this,e);var t=e;t.isKinematic=this._isKinematic,t.mass=this._mass,t.gravity=this._gravity,t.angularDamping=this._angularDamping,t.linearDamping=this._linearDamping,t.overrideGravity=this._overrideGravity,t.linearVelocity=this._linearVelocity,t.angularVelocity=this._angularVelocity,t.linearFactor=this._linearFactor,t.angularFactor=this._angularFactor,t.detectCollisions=this._detectCollisions}},{key:"applyForce",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var r=l.Physics3D._bullet,n=Rigidbody3D._btTempVector30;if(r.btVector3_setValue(n,-e.x,e.y,e.z),t){var i=Rigidbody3D._btTempVector31;r.btVector3_setValue(i,-t.x,t.y,t.z),r.btRigidBody_applyForce(this._btColliderObject,n,i)}else r.btRigidBody_applyCentralForce(this._btColliderObject,n)}},{key:"applyTorque",value:function(e){if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var t=l.Physics3D._bullet,r=Rigidbody3D._btTempVector30;t.btVector3_setValue(r,-e.x,e.y,e.z),t.btRigidBody_applyTorque(this._btColliderObject,r)}},{key:"applyImpulse",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var r=l.Physics3D._bullet;r.btVector3_setValue(Rigidbody3D._btImpulse,-e.x,e.y,e.z),t?(r.btVector3_setValue(Rigidbody3D._btImpulseOffset,-t.x,t.y,t.z),r.btRigidBody_applyImpulse(this._btColliderObject,Rigidbody3D._btImpulse,Rigidbody3D._btImpulseOffset)):r.btRigidBody_applyCentralImpulse(this._btColliderObject,Rigidbody3D._btImpulse)}},{key:"applyTorqueImpulse",value:function(e){if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var t=l.Physics3D._bullet,r=Rigidbody3D._btTempVector30;t.btVector3_setValue(r,-e.x,e.y,e.z),t.btRigidBody_applyTorqueImpulse(this._btColliderObject,r)}},{key:"wakeUp",value:function(){this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_activate(this._btColliderObject,!1)}},{key:"clearForces",value:function(){var e=this._btColliderObject;if(null==e)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var t=l.Physics3D._bullet;t.btRigidBody_clearForces(e);var r=Rigidbody3D._btVector3Zero;t.btCollisionObject_setInterpolationLinearVelocity(e,r),t.btRigidBody_setLinearVelocity(e,r),t.btCollisionObject_setInterpolationAngularVelocity(e,r),t.btRigidBody_setAngularVelocity(e,r)}},{key:"mass",get:function(){return this._mass},set:function(e){e=Math.max(e,1e-7),this._mass=e,this._isKinematic||this._updateMass(e)}},{key:"isKinematic",get:function(){return this._isKinematic},set:function(e){this._isKinematic=e,this._controlBySimulation=!e;var t=l.Physics3D._bullet,r=!!(this._simulation&&this._enabled&&this._colliderShape);r&&this._removeFromSimulation();var n=this._btColliderObject,i=t.btCollisionObject_getCollisionFlags(n);e?(i|=v.COLLISIONFLAGS_KINEMATIC_OBJECT,t.btCollisionObject_setCollisionFlags(n,i),t.btCollisionObject_forceActivationState(this._btColliderObject,v.ACTIVATIONSTATE_DISABLE_DEACTIVATION),this._enableProcessCollisions=!1,this._updateMass(0)):((i&v.COLLISIONFLAGS_KINEMATIC_OBJECT)>0&&(i^=v.COLLISIONFLAGS_KINEMATIC_OBJECT),t.btCollisionObject_setCollisionFlags(n,i),t.btCollisionObject_setActivationState(this._btColliderObject,v.ACTIVATIONSTATE_ACTIVE_TAG),this._enableProcessCollisions=!0,this._updateMass(this._mass));var a=Rigidbody3D._btVector3Zero;t.btCollisionObject_setInterpolationLinearVelocity(n,a),t.btRigidBody_setLinearVelocity(n,a),t.btCollisionObject_setInterpolationAngularVelocity(n,a),t.btRigidBody_setAngularVelocity(n,a),r&&this._addToSimulation()}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._btColliderObject&&l.Physics3D._bullet.btRigidBody_setDamping(this._btColliderObject,e,this._angularDamping)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._btColliderObject&&l.Physics3D._bullet.btRigidBody_setDamping(this._btColliderObject,this._linearDamping,e)}},{key:"overrideGravity",get:function(){return this._overrideGravity},set:function(e){this._overrideGravity=e;var t=l.Physics3D._bullet;if(this._btColliderObject){var r=t.btRigidBody_getFlags(this._btColliderObject);e?0==(r&Rigidbody3D._BT_DISABLE_WORLD_GRAVITY)&&t.btRigidBody_setFlags(this._btColliderObject,r|Rigidbody3D._BT_DISABLE_WORLD_GRAVITY):(r&Rigidbody3D._BT_DISABLE_WORLD_GRAVITY)>0&&t.btRigidBody_setFlags(this._btColliderObject,r^Rigidbody3D._BT_DISABLE_WORLD_GRAVITY)}}},{key:"gravity",get:function(){return this._gravity},set:function(e){this._gravity=e;var t=l.Physics3D._bullet;t.btVector3_setValue(Rigidbody3D._btGravity,-e.x,e.y,e.z),t.btRigidBody_setGravity(this._btColliderObject,Rigidbody3D._btGravity)}},{key:"totalForce",get:function(){if(this._btColliderObject){var e=l.Physics3D._bullet.btRigidBody_getTotalForce(this._btColliderObject);return P._convertToLayaVec3(e,this._totalForce,!0),this._totalForce}return null}},{key:"linearFactor",get:function(){return this._linearFactor},set:function(e){this._linearFactor=e;var t=Rigidbody3D._btTempVector30;P._convertToBulletVec3(e,t,!1),l.Physics3D._bullet.btRigidBody_setLinearFactor(this._btColliderObject,t)}},{key:"linearVelocity",get:function(){return this._btColliderObject&&P._convertToLayaVec3(l.Physics3D._bullet.btRigidBody_getLinearVelocity(this._btColliderObject),this._linearVelocity,!0),this._linearVelocity},set:function(e){if(this._linearVelocity=e,this._btColliderObject){var t=Rigidbody3D._btTempVector30;P._convertToBulletVec3(e,t,!0),this.isSleeping&&this.wakeUp(),l.Physics3D._bullet.btRigidBody_setLinearVelocity(this._btColliderObject,t)}}},{key:"angularFactor",get:function(){return this._angularFactor},set:function(e){this._angularFactor=e;var t=Rigidbody3D._btTempVector30;P._convertToBulletVec3(e,t,!1),l.Physics3D._bullet.btRigidBody_setAngularFactor(this._btColliderObject,t)}},{key:"angularVelocity",get:function(){return this._btColliderObject&&P._convertToLayaVec3(l.Physics3D._bullet.btRigidBody_getAngularVelocity(this._btColliderObject),this._angularVelocity,!0),this._angularVelocity},set:function(e){if(this._angularVelocity=e,this._btColliderObject){var t=Rigidbody3D._btTempVector30;P._convertToBulletVec3(e,t,!0),this.isSleeping&&this.wakeUp(),l.Physics3D._bullet.btRigidBody_setAngularVelocity(this._btColliderObject,t)}}},{key:"totalTorque",get:function(){if(this._btColliderObject){var e=l.Physics3D._bullet.btRigidBody_getTotalTorque(this._btColliderObject);return P._convertToLayaVec3(e,this._totalTorque,!0),this._totalTorque}return null}},{key:"detectCollisions",get:function(){return this._detectCollisions},set:function(e){this._detectCollisions!==e&&(this._detectCollisions=e,this._colliderShape&&this._enabled&&this._simulation&&(this._simulation._removeRigidBody(this),this._simulation._addRigidBody(this,this._collisionGroup,e?this._canCollideWith:0)))}},{key:"isSleeping",get:function(){return!!this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_getActivationState(this._btColliderObject)===v.ACTIVATIONSTATE_ISLAND_SLEEPING}},{key:"sleepLinearVelocity",get:function(){return l.Physics3D._bullet.btRigidBody_getLinearSleepingThreshold(this._btColliderObject)},set:function(e){var t=l.Physics3D._bullet;t.btRigidBody_setSleepingThresholds(this._btColliderObject,e,t.btRigidBody_getAngularSleepingThreshold(this._btColliderObject))}},{key:"sleepAngularVelocity",get:function(){return l.Physics3D._bullet.btRigidBody_getAngularSleepingThreshold(this._btColliderObject)},set:function(e){var t=l.Physics3D._bullet;t.btRigidBody_setSleepingThresholds(this._btColliderObject,t.btRigidBody_getLinearSleepingThreshold(this._btColliderObject),e)}},{key:"btColliderObject",get:function(){return this._btColliderObject}},{key:"constaintRigidbodyA",set:function(e){this._constaintRigidbodyA=e},get:function(){return this._constaintRigidbodyA}},{key:"constaintRigidbodyB",set:function(e){this._constaintRigidbodyB=e},get:function(){return this._constaintRigidbodyB}}],[{key:"__init__",value:function(){var e=l.Physics3D._bullet;Rigidbody3D._btTempVector30=e.btVector3_create(0,0,0),Rigidbody3D._btTempVector31=e.btVector3_create(0,0,0),Rigidbody3D._btVector3Zero=e.btVector3_create(0,0,0),Rigidbody3D._btInertia=e.btVector3_create(0,0,0),Rigidbody3D._btImpulse=e.btVector3_create(0,0,0),Rigidbody3D._btImpulseOffset=e.btVector3_create(0,0,0),Rigidbody3D._btGravity=e.btVector3_create(0,0,0),Rigidbody3D._btTransform0=e.btTransform_create()}}]),Rigidbody3D}(N);b.TYPE_STATIC=0,b.TYPE_DYNAMIC=1,b.TYPE_KINEMATIC=2,b._BT_DISABLE_WORLD_GRAVITY=1,b._BT_ENABLE_GYROPSCOPIC_FORCE=2;var k=function(){function Physics3D(){_classCallCheck(this,Physics3D)}return _createClass(Physics3D,null,[{key:"__bulletinit__",value:function(){this._bullet=window.Physics3D,this._bullet&&(_.__init__(),h.__init__(),d.__init__(),v.__init__(),I.__init__(),T.__init__(),E.__init__(),O.__init__(),b.__init__())}},{key:"__cannoninit__",value:function(){this._cannon=window.CANNON,this._cannon&&(t.CannonColliderShape.__init__(),t.CannonPhysicsComponent.__init__(),t.CannonPhysicsSimulation.__init__(),t.CannonBoxColliderShape.__init__(),t.CannonRigidbody3D.__init__())}}]),Physics3D}();k._bullet=null,k._cannon=null,k._enablePhysics=!1;var w=function(){function Config3D(){_classCallCheck(this,Config3D),this._defaultPhysicsMemory=16,this._maxLightCount=32,this._lightClusterCount=new o(12,12,12),this._editerEnvironment=!1,this.isAntialias=!0,this.isAlpha=!1,this.premultipliedAlpha=!0,this.isStencil=!0,this.enableMultiLight=!0,this.octreeCulling=!1,this.octreeInitialSize=64,this.octreeInitialCenter=new o(0,0,0),this.octreeMinNodeSize=2,this.octreeLooseness=1.25,this.debugFrustumCulling=!1,this.pbrRenderQuality=e.PBRRenderQuality.High,this.isUseCannonPhysicsEngine=!1,this._maxAreaLightCountPerClusterAverage=Math.min(4*Math.floor(2048/this._lightClusterCount.z-1),this._maxLightCount)}return _createClass(Config3D,[{key:"cloneTo",value:function(e){var t=e;t._defaultPhysicsMemory=this._defaultPhysicsMemory,t._editerEnvironment=this._editerEnvironment,t.isAntialias=this.isAntialias,t.isAlpha=this.isAlpha,t.premultipliedAlpha=this.premultipliedAlpha,t.isStencil=this.isStencil,t.octreeCulling=this.octreeCulling,this.octreeInitialCenter.cloneTo(t.octreeInitialCenter),t.octreeInitialSize=this.octreeInitialSize,t.octreeMinNodeSize=this.octreeMinNodeSize,t.octreeLooseness=this.octreeLooseness,t.debugFrustumCulling=this.debugFrustumCulling,t.maxLightCount=this.maxLightCount,t.enableMultiLight=this.enableMultiLight;var r=t.lightClusterCount;this.lightClusterCount.cloneTo(r),t.lightClusterCount=r,t.pbrRenderQuality=this.pbrRenderQuality}},{key:"clone",value:function(){var e=new Config3D;return this.cloneTo(e),e}},{key:"defaultPhysicsMemory",get:function(){return this._defaultPhysicsMemory},set:function(e){if(e<16)throw"defaultPhysicsMemory must large than 16M";this._defaultPhysicsMemory=e}},{key:"maxLightCount",get:function(){return this._maxLightCount},set:function(e){e>2048?(this._maxLightCount=2048,console.warn("Config3D: maxLightCount must less equal 2048.")):this._maxLightCount=e}},{key:"lightClusterCount",get:function(){return this._lightClusterCount},set:function(e){e.x>128||e.y>128||e.z>128?(this._lightClusterCount.setValue(Math.min(e.x,128),Math.min(e.y,128),Math.min(e.z,128)),console.warn("Config3D: lightClusterCount X and Y、Z must less equal 128.")):e.cloneTo(this._lightClusterCount);var t=4*Math.floor(2048/this._lightClusterCount.z-1);t<this._maxLightCount&&console.warn("Config3D: if the area light(PointLight、SpotLight) count is large than "+t+",maybe the far away culster will ingonre some light."),this._maxAreaLightCountPerClusterAverage=Math.min(t,this._maxLightCount)}}],[{key:"useCannonPhysics",get:function(){return Config3D._config.isUseCannonPhysicsEngine},set:function(e){Config3D._config.isUseCannonPhysicsEngine=e,e&&(k.__cannoninit__(),l.Scene3D.cannonPhysicsSettings||(l.Scene3D.cannonPhysicsSettings=new t.CannonPhysicsSettings))}}]),Config3D}();w._config=new w,window.Config3D=w;var B=function(){function KeyframeNode(){_classCallCheck(this,KeyframeNode),this._ownerPath=[],this._propertys=[],this._keyFrames=[]}return _createClass(KeyframeNode,[{key:"_setOwnerPathCount",value:function(e){this._ownerPath.length=e}},{key:"_setOwnerPathByIndex",value:function(e,t){this._ownerPath[e]=t}},{key:"_joinOwnerPath",value:function(e){return this._ownerPath.join(e)}},{key:"_setPropertyCount",value:function(e){this._propertys.length=e}},{key:"_setPropertyByIndex",value:function(e,t){this._propertys[e]=t}},{key:"_joinProperty",value:function(e){return this._propertys.join(e)}},{key:"_setKeyframeCount",value:function(e){this._keyFrames.length=e}},{key:"_setKeyframeByIndex",value:function(e,t){this._keyFrames[e]=t}},{key:"getOwnerPathByIndex",value:function(e){return this._ownerPath[e]}},{key:"getPropertyByIndex",value:function(e){return this._propertys[e]}},{key:"getKeyframeByIndex",value:function(e){return this._keyFrames[e]}},{key:"ownerPathCount",get:function(){return this._ownerPath.length}},{key:"propertyCount",get:function(){return this._propertys.length}},{key:"keyFramesCount",get:function(){return this._keyFrames.length}}]),KeyframeNode}(),V=function AnimationEvent(){_classCallCheck(this,AnimationEvent)},F=function(){function Keyframe(){_classCallCheck(this,Keyframe)}return _createClass(Keyframe,[{key:"cloneTo",value:function(e){e.time=this.time}},{key:"clone",value:function(){var e=new Keyframe;return this.cloneTo(e),e}}]),Keyframe}(),U=function(e){function FloatKeyframe(){return _classCallCheck(this,FloatKeyframe),_possibleConstructorReturn(this,_getPrototypeOf(FloatKeyframe).call(this))}return _inherits(FloatKeyframe,e),_createClass(FloatKeyframe,[{key:"cloneTo",value:function(e){_get(_getPrototypeOf(FloatKeyframe.prototype),"cloneTo",this).call(this,e);var t=e;t.inTangent=this.inTangent,t.outTangent=this.outTangent,t.value=this.value}}]),FloatKeyframe}(F),G=function(e){function QuaternionKeyframe(){var e;return _classCallCheck(this,QuaternionKeyframe),(e=_possibleConstructorReturn(this,_getPrototypeOf(QuaternionKeyframe).call(this))).inTangent=new i,e.outTangent=new i,e.value=new u,e}return _inherits(QuaternionKeyframe,e),_createClass(QuaternionKeyframe,[{key:"cloneTo",value:function(e){_get(_getPrototypeOf(QuaternionKeyframe.prototype),"cloneTo",this).call(this,e);var t=e;this.inTangent.cloneTo(t.inTangent),this.outTangent.cloneTo(t.outTangent),this.value.cloneTo(t.value)}}]),QuaternionKeyframe}(F),z=function(e){function Vector3Keyframe(){var e;return _classCallCheck(this,Vector3Keyframe),(e=_possibleConstructorReturn(this,_getPrototypeOf(Vector3Keyframe).call(this))).inTangent=new o,e.outTangent=new o,e.value=new o,e}return _inherits(Vector3Keyframe,e),_createClass(Vector3Keyframe,[{key:"cloneTo",value:function(e){_get(_getPrototypeOf(Vector3Keyframe.prototype),"cloneTo",this).call(this,e);var t=e;this.inTangent.cloneTo(t.inTangent),this.outTangent.cloneTo(t.outTangent),this.value.cloneTo(t.value)}}]),Vector3Keyframe}(F),H=function(){function AnimationClipParser03(){_classCallCheck(this,AnimationClipParser03)}return _createClass(AnimationClipParser03,null,[{key:"READ_DATA",value:function(){AnimationClipParser03._DATA.offset=AnimationClipParser03._reader.getUint32(),AnimationClipParser03._DATA.size=AnimationClipParser03._reader.getUint32()}},{key:"READ_BLOCK",value:function(){for(var e=AnimationClipParser03._BLOCK.count=AnimationClipParser03._reader.getUint16(),t=AnimationClipParser03._BLOCK.blockStarts=[],r=AnimationClipParser03._BLOCK.blockLengths=[],n=0;n<e;n++)t.push(AnimationClipParser03._reader.getUint32()),r.push(AnimationClipParser03._reader.getUint32())}},{key:"READ_STRINGS",value:function(){var e=AnimationClipParser03._reader.getUint32(),t=AnimationClipParser03._reader.getUint16(),r=AnimationClipParser03._reader.pos;AnimationClipParser03._reader.pos=e+AnimationClipParser03._DATA.offset;for(var n=0;n<t;n++)AnimationClipParser03._strings[n]=AnimationClipParser03._reader.readUTFString();AnimationClipParser03._reader.pos=r}},{key:"parse",value:function(e,t){AnimationClipParser03._animationClip=e,AnimationClipParser03._reader=t;t.__getBuffer();AnimationClipParser03.READ_DATA(),AnimationClipParser03.READ_BLOCK(),AnimationClipParser03.READ_STRINGS();for(var r=0,n=AnimationClipParser03._BLOCK.count;r<n;r++){var i=t.getUint16(),a=AnimationClipParser03._strings[i],o=AnimationClipParser03["READ_"+a];if(null==o)throw new Error("model file err,no this function:"+i+" "+a);o.call(null)}}},{key:"READ_ANIMATIONS",value:function(){var e,r,n,i=AnimationClipParser03._reader,a=(i.__getBuffer(),[]),o=i.getUint16();for(a.length=o,e=0;e<o;e++)a[e]=i.getFloat32();var s=AnimationClipParser03._animationClip;s.name=AnimationClipParser03._strings[i.getUint16()];var l=s._duration=i.getFloat32();s.islooping=!!i.getByte(),s._frameRate=i.getInt16();var u=i.getInt16(),c=s._nodes;c.count=u;var h=s._nodesMap={},_=s._nodesDic={};for(e=0;e<u;e++){n=new B,c.setNodeByIndex(e,n),n._indexInList=e;var d=n.type=i.getUint8(),f=i.getUint16();for(n._setOwnerPathCount(f),r=0;r<f;r++)n._setOwnerPathByIndex(r,AnimationClipParser03._strings[i.getUint16()]);var m=n._joinOwnerPath("/"),T=h[m];T||(h[m]=T=[]),T.push(n),n.propertyOwner=AnimationClipParser03._strings[i.getUint16()];var p=i.getUint16();for(n._setPropertyCount(p),r=0;r<p;r++)n._setPropertyByIndex(r,AnimationClipParser03._strings[i.getUint16()]);var g=m+"."+n.propertyOwner+"."+n._joinProperty(".");_[g]=n,n.fullPath=g;var E=i.getUint16();for(n._setKeyframeCount(E),r=0;r<E;r++)switch(d){case 0:var y=new U;n._setKeyframeByIndex(r,y),y.time=a[i.getUint16()],y.inTangent=i.getFloat32(),y.outTangent=i.getFloat32(),y.value=i.getFloat32();break;case 1:case 3:case 4:var S=new z;if(n._setKeyframeByIndex(r,S),S.time=a[i.getUint16()],t.Render.supportWebGLPlusAnimation){for(var v=S.data=new Float32Array(9),R=0;R<3;R++)v[R]=i.getFloat32();for(R=0;R<3;R++)v[3+R]=i.getFloat32();for(R=0;R<3;R++)v[6+R]=i.getFloat32()}else{var C=S.inTangent,M=S.outTangent,D=S.value;C.x=i.getFloat32(),C.y=i.getFloat32(),C.z=i.getFloat32(),M.x=i.getFloat32(),M.y=i.getFloat32(),M.z=i.getFloat32(),D.x=i.getFloat32(),D.y=i.getFloat32(),D.z=i.getFloat32()}break;case 2:var x=new G;if(n._setKeyframeByIndex(r,x),x.time=a[i.getUint16()],t.Render.supportWebGLPlusAnimation){for(v=x.data=new Float32Array(12),R=0;R<4;R++)v[R]=i.getFloat32();for(R=0;R<4;R++)v[4+R]=i.getFloat32();for(R=0;R<4;R++)v[8+R]=i.getFloat32()}else{var A=x.inTangent,I=x.outTangent,L=x.value;A.x=i.getFloat32(),A.y=i.getFloat32(),A.z=i.getFloat32(),A.w=i.getFloat32(),I.x=i.getFloat32(),I.y=i.getFloat32(),I.z=i.getFloat32(),I.w=i.getFloat32(),L.x=i.getFloat32(),L.y=i.getFloat32(),L.z=i.getFloat32(),L.w=i.getFloat32()}break;default:throw"AnimationClipParser03:unknown type."}}var P=i.getUint16();for(e=0;e<P;e++){var O,N=new V;N.time=Math.min(l,i.getFloat32()),N.eventName=AnimationClipParser03._strings[i.getUint16()];var b=i.getUint16();for(b>0&&(N.params=O=[]),r=0;r<b;r++){switch(i.getByte()){case 0:O.push(!!i.getByte());break;case 1:O.push(i.getInt32());break;case 2:O.push(i.getFloat32());break;case 3:O.push(AnimationClipParser03._strings[i.getUint16()]);break;default:throw new Error("unknown type.")}}s.addEvent(N)}}}]),AnimationClipParser03}();H._strings=[],H._BLOCK={count:0},H._DATA={offset:0,size:0};var W=function(){function HalfFloatUtils(){_classCallCheck(this,HalfFloatUtils)}return _createClass(HalfFloatUtils,null,[{key:"__init__",value:function(){for(var e=0;e<256;++e){var t=e-127;t<-27?(HalfFloatUtils._baseTable[0|e]=0,HalfFloatUtils._baseTable[256|e]=32768,HalfFloatUtils._shiftTable[0|e]=24,HalfFloatUtils._shiftTable[256|e]=24):t<-14?(HalfFloatUtils._baseTable[0|e]=1024>>-t-14,HalfFloatUtils._baseTable[256|e]=1024>>-t-14|32768,HalfFloatUtils._shiftTable[0|e]=-t-1,HalfFloatUtils._shiftTable[256|e]=-t-1):t<=15?(HalfFloatUtils._baseTable[0|e]=t+15<<10,HalfFloatUtils._baseTable[256|e]=t+15<<10|32768,HalfFloatUtils._shiftTable[0|e]=13,HalfFloatUtils._shiftTable[256|e]=13):t<128?(HalfFloatUtils._baseTable[0|e]=31744,HalfFloatUtils._baseTable[256|e]=64512,HalfFloatUtils._shiftTable[0|e]=24,HalfFloatUtils._shiftTable[256|e]=24):(HalfFloatUtils._baseTable[0|e]=31744,HalfFloatUtils._baseTable[256|e]=64512,HalfFloatUtils._shiftTable[0|e]=13,HalfFloatUtils._shiftTable[256|e]=13)}for(HalfFloatUtils._mantissaTable[0]=0,e=1;e<1024;++e){var r=e<<13;for(t=0;0==(8388608&r);)t-=8388608,r<<=1;r&=-8388609,t+=947912704,HalfFloatUtils._mantissaTable[e]=r|t}for(e=1024;e<2048;++e)HalfFloatUtils._mantissaTable[e]=939524096+(e-1024<<13);for(HalfFloatUtils._exponentTable[0]=0,e=1;e<31;++e)HalfFloatUtils._exponentTable[e]=e<<23;for(HalfFloatUtils._exponentTable[31]=1199570944,HalfFloatUtils._exponentTable[32]=2147483648,e=33;e<63;++e)HalfFloatUtils._exponentTable[e]=2147483648+(e-32<<23);for(HalfFloatUtils._exponentTable[63]=3347054592,HalfFloatUtils._offsetTable[0]=0,e=1;e<64;++e)HalfFloatUtils._offsetTable[e]=32===e?0:1024}},{key:"roundToFloat16Bits",value:function(e){HalfFloatUtils._floatView[0]=e;var t=HalfFloatUtils._uint32View[0],r=t>>23&511;return HalfFloatUtils._baseTable[r]+((8388607&t)>>HalfFloatUtils._shiftTable[r])}},{key:"convertToNumber",value:function(e){var t=e>>10;return HalfFloatUtils._uint32View[0]=HalfFloatUtils._mantissaTable[HalfFloatUtils._offsetTable[t]+(1023&e)]+HalfFloatUtils._exponentTable[t],HalfFloatUtils._floatView[0]}}]),HalfFloatUtils}();W._buffer=new ArrayBuffer(4),W._floatView=new Float32Array(W._buffer),W._uint32View=new Uint32Array(W._buffer),W._baseTable=new Uint32Array(512),W._shiftTable=new Uint32Array(512),W._mantissaTable=new Uint32Array(2048),W._exponentTable=new Uint32Array(64),W._offsetTable=new Uint32Array(64);var X=function(){function AnimationClipParser04(){_classCallCheck(this,AnimationClipParser04)}return _createClass(AnimationClipParser04,null,[{key:"READ_DATA",value:function(){AnimationClipParser04._DATA.offset=AnimationClipParser04._reader.getUint32(),AnimationClipParser04._DATA.size=AnimationClipParser04._reader.getUint32()}},{key:"READ_BLOCK",value:function(){for(var e=AnimationClipParser04._BLOCK.count=AnimationClipParser04._reader.getUint16(),t=AnimationClipParser04._BLOCK.blockStarts=[],r=AnimationClipParser04._BLOCK.blockLengths=[],n=0;n<e;n++)t.push(AnimationClipParser04._reader.getUint32()),r.push(AnimationClipParser04._reader.getUint32())}},{key:"READ_STRINGS",value:function(){var e=AnimationClipParser04._reader.getUint32(),t=AnimationClipParser04._reader.getUint16(),r=AnimationClipParser04._reader.pos;AnimationClipParser04._reader.pos=e+AnimationClipParser04._DATA.offset;for(var n=0;n<t;n++)AnimationClipParser04._strings[n]=AnimationClipParser04._reader.readUTFString();AnimationClipParser04._reader.pos=r}},{key:"parse",value:function(e,t,r){AnimationClipParser04._animationClip=e,AnimationClipParser04._reader=t,AnimationClipParser04._version=r,AnimationClipParser04.READ_DATA(),AnimationClipParser04.READ_BLOCK(),AnimationClipParser04.READ_STRINGS();for(var n=0,i=AnimationClipParser04._BLOCK.count;n<i;n++){var a=t.getUint16(),o=AnimationClipParser04._strings[a],s=AnimationClipParser04["READ_"+o];if(null==s)throw new Error("model file err,no this function:"+a+" "+o);s.call(null)}AnimationClipParser04._version=null,AnimationClipParser04._reader=null,AnimationClipParser04._animationClip=null}},{key:"READ_ANIMATIONS",value:function(){var e,r,n,i=AnimationClipParser04._reader,a=(i.__getBuffer(),[]),o=i.getUint16();for(a.length=o,e=0;e<o;e++)a[e]=i.getFloat32();var s=AnimationClipParser04._animationClip;s.name=AnimationClipParser04._strings[i.getUint16()];var l=s._duration=i.getFloat32();s.islooping=!!i.getByte(),s._frameRate=i.getInt16();var u=i.getInt16(),c=s._nodes;c.count=u;var h=s._nodesMap={},_=s._nodesDic={};for(e=0;e<u;e++){n=new B,c.setNodeByIndex(e,n),n._indexInList=e;var d=n.type=i.getUint8(),f=i.getUint16();for(n._setOwnerPathCount(f),r=0;r<f;r++)n._setOwnerPathByIndex(r,AnimationClipParser04._strings[i.getUint16()]);var m=n._joinOwnerPath("/"),T=h[m];T||(h[m]=T=[]),T.push(n),n.propertyOwner=AnimationClipParser04._strings[i.getUint16()];var p=i.getUint16();for(n._setPropertyCount(p),r=0;r<p;r++)n._setPropertyByIndex(r,AnimationClipParser04._strings[i.getUint16()]);var g=m+"."+n.propertyOwner+"."+n._joinProperty(".");_[g]=n,n.fullPath=g;var E=i.getUint16();switch(n._setKeyframeCount(E),AnimationClipParser04._version){case"LAYAANIMATION:04":for(r=0;r<E;r++)switch(d){case 0:var y=new U;n._setKeyframeByIndex(r,y),y.time=a[i.getUint16()],y.inTangent=i.getFloat32(),y.outTangent=i.getFloat32(),y.value=i.getFloat32();break;case 1:case 3:case 4:var S=new z;if(n._setKeyframeByIndex(r,S),S.time=a[i.getUint16()],t.Render.supportWebGLPlusAnimation){for(var v=S.data=new Float32Array(9),R=0;R<3;R++)v[R]=i.getFloat32();for(R=0;R<3;R++)v[3+R]=i.getFloat32();for(R=0;R<3;R++)v[6+R]=i.getFloat32()}else{var C=S.inTangent,M=S.outTangent,D=S.value;C.x=i.getFloat32(),C.y=i.getFloat32(),C.z=i.getFloat32(),M.x=i.getFloat32(),M.y=i.getFloat32(),M.z=i.getFloat32(),D.x=i.getFloat32(),D.y=i.getFloat32(),D.z=i.getFloat32()}break;case 2:var x=new G;if(n._setKeyframeByIndex(r,x),x.time=a[i.getUint16()],t.Render.supportWebGLPlusAnimation){for(v=x.data=new Float32Array(12),R=0;R<4;R++)v[R]=i.getFloat32();for(R=0;R<4;R++)v[4+R]=i.getFloat32();for(R=0;R<4;R++)v[8+R]=i.getFloat32()}else{var A=x.inTangent,I=x.outTangent,L=x.value;A.x=i.getFloat32(),A.y=i.getFloat32(),A.z=i.getFloat32(),A.w=i.getFloat32(),I.x=i.getFloat32(),I.y=i.getFloat32(),I.z=i.getFloat32(),I.w=i.getFloat32(),L.x=i.getFloat32(),L.y=i.getFloat32(),L.z=i.getFloat32(),L.w=i.getFloat32()}break;default:throw"AnimationClipParser04:unknown type."}break;case"LAYAANIMATION:COMPRESSION_04":for(r=0;r<E;r++)switch(d){case 0:y=new U,n._setKeyframeByIndex(r,y),y.time=a[i.getUint16()],y.inTangent=W.convertToNumber(i.getUint16()),y.outTangent=W.convertToNumber(i.getUint16()),y.value=W.convertToNumber(i.getUint16());break;case 1:case 3:case 4:if(S=new z,n._setKeyframeByIndex(r,S),S.time=a[i.getUint16()],t.Render.supportWebGLPlusAnimation){for(v=S.data=new Float32Array(9),R=0;R<3;R++)v[R]=W.convertToNumber(i.getUint16());for(R=0;R<3;R++)v[3+R]=W.convertToNumber(i.getUint16());for(R=0;R<3;R++)v[6+R]=W.convertToNumber(i.getUint16())}else C=S.inTangent,M=S.outTangent,D=S.value,C.x=W.convertToNumber(i.getUint16()),C.y=W.convertToNumber(i.getUint16()),C.z=W.convertToNumber(i.getUint16()),M.x=W.convertToNumber(i.getUint16()),M.y=W.convertToNumber(i.getUint16()),M.z=W.convertToNumber(i.getUint16()),D.x=W.convertToNumber(i.getUint16()),D.y=W.convertToNumber(i.getUint16()),D.z=W.convertToNumber(i.getUint16());break;case 2:if(x=new G,n._setKeyframeByIndex(r,x),x.time=a[i.getUint16()],t.Render.supportWebGLPlusAnimation){for(v=x.data=new Float32Array(12),R=0;R<4;R++)v[R]=W.convertToNumber(i.getUint16());for(R=0;R<4;R++)v[4+R]=W.convertToNumber(i.getUint16());for(R=0;R<4;R++)v[8+R]=W.convertToNumber(i.getUint16())}else A=x.inTangent,I=x.outTangent,L=x.value,A.x=W.convertToNumber(i.getUint16()),A.y=W.convertToNumber(i.getUint16()),A.z=W.convertToNumber(i.getUint16()),A.w=W.convertToNumber(i.getUint16()),I.x=W.convertToNumber(i.getUint16()),I.y=W.convertToNumber(i.getUint16()),I.z=W.convertToNumber(i.getUint16()),I.w=W.convertToNumber(i.getUint16()),L.x=W.convertToNumber(i.getUint16()),L.y=W.convertToNumber(i.getUint16()),L.z=W.convertToNumber(i.getUint16()),L.w=W.convertToNumber(i.getUint16());break;default:throw"AnimationClipParser04:unknown type."}}}var P=i.getUint16();for(e=0;e<P;e++){var O,N=new V;N.time=Math.min(l,i.getFloat32()),N.eventName=AnimationClipParser04._strings[i.getUint16()];var b=i.getUint16();for(b>0&&(N.params=O=[]),r=0;r<b;r++){switch(i.getByte()){case 0:O.push(!!i.getByte());break;case 1:O.push(i.getInt32());break;case 2:O.push(i.getFloat32());break;case 3:O.push(AnimationClipParser04._strings[i.getUint16()]);break;default:throw new Error("unknown type.")}}s.addEvent(N)}}}]),AnimationClipParser04}();X._strings=[],X._BLOCK={count:0},X._DATA={offset:0,size:0};var Y=function(){function KeyframeNodeList(){_classCallCheck(this,KeyframeNodeList),this._nodes=[]}return _createClass(KeyframeNodeList,[{key:"getNodeByIndex",value:function(e){return this._nodes[e]}},{key:"setNodeByIndex",value:function(e,t){this._nodes[e]=t}},{key:"count",get:function(){return this._nodes.length},set:function(e){this._nodes.length=e}}]),KeyframeNodeList}(),j=function(e){function AnimationClip(){var e;return _classCallCheck(this,AnimationClip),(e=_possibleConstructorReturn(this,_getPrototypeOf(AnimationClip).call(this)))._nodes=new Y,e._animationEvents=[],e}return _inherits(AnimationClip,e),_createClass(AnimationClip,[{key:"duration",value:function(){return this._duration}},{key:"_hermiteInterpolate",value:function(e,t,r,n){var i=e.outTangent,a=t.inTangent;if(Number.isFinite(i)&&Number.isFinite(a)){var o=r*r,s=o*r,l=s-2*o+r,u=s-o,c=-2*s+3*o;return(2*s-3*o+1)*e.value+l*i*n+u*a*n+c*t.value}return e.value}},{key:"_hermiteInterpolateVector3",value:function(e,t,r,n,i){var a=e.value,o=e.outTangent,s=t.value,l=t.inTangent,u=r*r,c=u*r,h=2*c-3*u+1,_=c-2*u+r,d=c-u,f=-2*c+3*u,m=o.x,T=l.x;Number.isFinite(m)&&Number.isFinite(T)?i.x=h*a.x+_*m*n+d*T*n+f*s.x:i.x=a.x,m=o.y,T=l.y,Number.isFinite(m)&&Number.isFinite(T)?i.y=h*a.y+_*m*n+d*T*n+f*s.y:i.y=a.y,m=o.z,T=l.z,Number.isFinite(m)&&Number.isFinite(T)?i.z=h*a.z+_*m*n+d*T*n+f*s.z:i.z=a.z}},{key:"_hermiteInterpolateQuaternion",value:function(e,t,r,n,i){var a=e.value,o=e.outTangent,s=t.value,l=t.inTangent,u=r*r,c=u*r,h=2*c-3*u+1,_=c-2*u+r,d=c-u,f=-2*c+3*u,m=o.x,T=l.x;Number.isFinite(m)&&Number.isFinite(T)?i.x=h*a.x+_*m*n+d*T*n+f*s.x:i.x=a.x,m=o.y,T=l.y,Number.isFinite(m)&&Number.isFinite(T)?i.y=h*a.y+_*m*n+d*T*n+f*s.y:i.y=a.y,m=o.z,T=l.z,Number.isFinite(m)&&Number.isFinite(T)?i.z=h*a.z+_*m*n+d*T*n+f*s.z:i.z=a.z,m=o.w,T=l.w,Number.isFinite(m)&&Number.isFinite(T)?i.w=h*a.w+_*m*n+d*T*n+f*s.w:i.w=a.w}},{key:"_evaluateClipDatasRealTime",value:function(e,t,r,n,i,a){for(var o=0,s=e.count;o<s;o++){var l,c=e.getNodeByIndex(o),h=c.type,_=c._keyFrames,d=_.length,f=r[o];if(i)for(-1!==f&&t<_[f].time&&(f=-1,r[o]=f),l=f+1;l<d&&!(_[l].time>t);)f++,l++,r[o]=f;else for((l=f+1)!==d&&t>_[l].time&&(f=d-1,r[o]=f),l=f+1;f>-1&&!(_[f].time<t);)f--,l--,r[o]=f;var m=l===d;switch(h){case 0:if(-1!==f){var T=_[f];if(m)a[o]=T.value;else{var p,g=_[l],E=g.time-T.time;p=0!==E?(t-T.time)/E:0,a[o]=this._hermiteInterpolate(T,g,p,E)}}else a[o]=_[0].value;n&&(a[o]=a[o]-_[0].value);break;case 1:case 4:var y=a[o];if(this._evaluateFrameNodeVector3DatasRealTime(_,f,m,t,y),n){var S=_[0].value;y.x-=S.x,y.y-=S.y,y.z-=S.z}break;case 2:var v=a[o];if(this._evaluateFrameNodeQuaternionDatasRealTime(_,f,m,t,v),n){var R=AnimationClip._tempQuaternion0,C=_[0].value;P.quaternionConjugate(C,R),u.multiply(R,v,v)}break;case 3:y=a[o],this._evaluateFrameNodeVector3DatasRealTime(_,f,m,t,y),n&&(S=_[0].value,y.x/=S.x,y.y/=S.y,y.z/=S.z);break;default:throw"AnimationClip:unknown node type."}}}},{key:"_evaluateClipDatasRealTimeForNative",value:function(e,r,n,i){t.LayaGL.instance.evaluateClipDatasRealTime(e._nativeObj,r,n,i)}},{key:"_evaluateFrameNodeVector3DatasRealTime",value:function(e,t,r,n,i){if(-1!==t){var a=e[t];if(r){var o=a.value;i.x=o.x,i.y=o.y,i.z=o.z}else{var s,l=e[t+1],u=a.time,c=l.time-u;s=0!==c?(n-u)/c:0,this._hermiteInterpolateVector3(a,l,s,c,i)}}else{var h=e[0].value;i.x=h.x,i.y=h.y,i.z=h.z}}},{key:"_evaluateFrameNodeQuaternionDatasRealTime",value:function(e,t,r,n,i){if(-1!==t){var a=e[t];if(r){var o=a.value;i.x=o.x,i.y=o.y,i.z=o.z,i.w=o.w}else{var s,l=e[t+1],u=a.time,c=l.time-u;s=0!==c?(n-u)/c:0,this._hermiteInterpolateQuaternion(a,l,s,c,i)}}else{var h=e[0].value;i.x=h.x,i.y=h.y,i.z=h.z,i.w=h.w}}},{key:"_binarySearchEventIndex",value:function(e){for(var t,r=0,n=this._animationEvents.length-1;r<=n;){t=Math.floor((r+n)/2);var i=this._animationEvents[t].time;if(i==e)return t;i>e?n=t-1:r=t+1}return r}},{key:"addEvent",value:function(e){var t=this._binarySearchEventIndex(e.time);this._animationEvents.splice(t,0,e)}},{key:"_disposeResource",value:function(){this._nodes=null,this._nodesMap=null}}],[{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var r=new AnimationClip,n=new t.Byte(e),i=n.readUTFString();switch(i){case"LAYAANIMATION:03":H.parse(r,n);break;case"LAYAANIMATION:04":case"LAYAANIMATION:COMPRESSION_04":X.parse(r,n,i);break;default:throw"unknown animationClip version."}return r}},{key:"load",value:function(e,r){t.ILaya.loader.create(e,r,null,AnimationClip.ANIMATIONCLIP)}}]),AnimationClip}(t.Resource);j.ANIMATIONCLIP="ANIMATIONCLIP",j._tempQuaternion0=new u;var Z=function(){function AnimatorPlayState(){_classCallCheck(this,AnimatorPlayState),this._currentState=null}return _createClass(AnimatorPlayState,[{key:"_resetPlayState",value:function(e){this._finish=!1,this._startPlayTime=e,this._elapsedTime=e,this._playEventIndex=0,this._lastIsFront=!0}},{key:"_cloneTo",value:function(e){e._finish=this._finish,e._startPlayTime=this._startPlayTime,e._elapsedTime=this._elapsedTime,e._normalizedTime=this._normalizedTime,e._normalizedPlayTime=this._normalizedPlayTime,e._playEventIndex=this._playEventIndex,e._lastIsFront=this._lastIsFront}},{key:"normalizedTime",get:function(){return this._normalizedTime}},{key:"duration",get:function(){return this._duration}},{key:"animatorState",get:function(){return this._currentState}}]),AnimatorPlayState}(),Q=function(){function AnimatorControllerLayer(e){_classCallCheck(this,AnimatorControllerLayer),this._defaultState=null,this._referenceCount=0,this._playType=-1,this._crossDuration=-1,this._crossMark=0,this._crossNodesOwnersCount=0,this._crossNodesOwners=[],this._crossNodesOwnersIndicesMap={},this._srcCrossClipNodeIndices=[],this._destCrossClipNodeIndices=[],this._statesMap={},this._states=[],this._playStateInfo=new Z,this._crossPlayStateInfo=new Z,this.blendingMode=AnimatorControllerLayer.BLENDINGMODE_OVERRIDE,this.defaultWeight=1,this.playOnWake=!0,this.name=e}return _createClass(AnimatorControllerLayer,[{key:"_removeClip",value:function(e,t,r,n){var i=n._clip,a=e[r];if(e.splice(r,1),delete t[n.name],this._animator){var o=i._nodes,s=a._nodeOwners;i._removeReference();for(var l=0,u=o.count;l<u;l++)this._animator._removeKeyframeNodeOwner(s,o.getNodeByIndex(l))}}},{key:"_getReferenceCount",value:function(){return this._referenceCount}},{key:"_addReference",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=0,r=this._states.length;t<r;t++)this._states[t]._addReference(e);this._referenceCount+=e}},{key:"_removeReference",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=0,r=this._states.length;t<r;t++)this._states[t]._removeReference(e);this._referenceCount-=e}},{key:"_clearReference",value:function(){this._removeReference(-this._referenceCount)}},{key:"getCurrentPlayState",value:function(){return this._playStateInfo}},{key:"getAnimatorState",value:function(e){var t=this._statesMap[e];return t||null}},{key:"addState",value:function(e){var t=e.name;if(this._statesMap[t])throw"AnimatorControllerLayer:this stat's name has exist.";this._statesMap[t]=e,this._states.push(e),this._animator&&(e._clip._addReference(),this._animator._getOwnersByClip(e))}},{key:"removeState",value:function(e){for(var t=this._states,r=-1,n=0,i=t.length;n<i;n++)if(t[n]===e){r=n;break}-1!==r&&this._removeClip(t,this._statesMap,r,e)}},{key:"destroy",value:function(){this._clearReference(),this._statesMap=null,this._states=null,this._playStateInfo=null,this._crossPlayStateInfo=null,this._defaultState=null}},{key:"cloneTo",value:function(e){var t=e;t.name=this.name,t.blendingMode=this.blendingMode,t.defaultWeight=this.defaultWeight,t.playOnWake=this.playOnWake}},{key:"clone",value:function(){var e=new AnimatorControllerLayer(this.name);return this.cloneTo(e),e}},{key:"defaultState",get:function(){return this._defaultState},set:function(e){this._defaultState=e,this._statesMap[e.name]=e}}]),AnimatorControllerLayer}();Q.BLENDINGMODE_OVERRIDE=0,Q.BLENDINGMODE_ADDTIVE=1;var q=function(){function ConchVector4(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;_classCallCheck(this,ConchVector4);var i=this.elements=new Float32Array(4);i[0]=e,i[1]=t,i[2]=r,i[3]=n}return _createClass(ConchVector4,[{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2],this.elements[3]=e[t+3]}},{key:"cloneTo",value:function(e){var t=e.elements,r=this.elements;t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3]}},{key:"clone",value:function(){var e=new ConchVector4;return this.cloneTo(e),e}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSquared",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}},{key:"x",get:function(){return this.elements[0]},set:function(e){this.elements[0]=e}},{key:"y",get:function(){return this.elements[1]},set:function(e){this.elements[1]=e}},{key:"z",get:function(){return this.elements[2]},set:function(e){this.elements[2]=e}},{key:"w",get:function(){return this.elements[3]},set:function(e){this.elements[3]=e}}],[{key:"lerp",value:function(e,t,r,n){var i=n.elements,a=e.elements,o=t.elements,s=a[0],l=a[1],u=a[2],c=a[3];i[0]=s+r*(o[0]-s),i[1]=l+r*(o[1]-l),i[2]=u+r*(o[2]-u),i[3]=c+r*(o[3]-c)}},{key:"transformByM4x4",value:function(e,t,r){var n=e.elements,i=n[0],a=n[1],o=n[2],s=n[3],l=t.elements,u=r.elements;u[0]=i*l[0]+a*l[4]+o*l[8]+s*l[12],u[1]=i*l[1]+a*l[5]+o*l[9]+s*l[13],u[2]=i*l[2]+a*l[6]+o*l[10]+s*l[14],u[3]=i*l[3]+a*l[7]+o*l[11]+s*l[15]}},{key:"equals",value:function(e,t){var n=e.elements,i=t.elements;return r.nearEqual(Math.abs(n[0]),Math.abs(i[0]))&&r.nearEqual(Math.abs(n[1]),Math.abs(i[1]))&&r.nearEqual(Math.abs(n[2]),Math.abs(i[2]))&&r.nearEqual(Math.abs(n[3]),Math.abs(i[3]))}},{key:"normalize",value:function(e,t){var r=e.elements,n=t.elements,i=e.length();i>0&&(n[0]=r[0]*i,n[1]=r[1]*i,n[2]=r[2]*i,n[3]=r[3]*i)}},{key:"add",value:function(e,t,r){var n=r.elements,i=e.elements,a=t.elements;n[0]=i[0]+a[0],n[1]=i[1]+a[1],n[2]=i[2]+a[2],n[3]=i[3]+a[3]}},{key:"subtract",value:function(e,t,r){var n=r.elements,i=e.elements,a=t.elements;n[0]=i[0]-a[0],n[1]=i[1]-a[1],n[2]=i[2]-a[2],n[3]=i[3]-a[3]}},{key:"multiply",value:function(e,t,r){var n=r.elements,i=e.elements,a=t.elements;n[0]=i[0]*a[0],n[1]=i[1]*a[1],n[2]=i[2]*a[2],n[3]=i[3]*a[3]}},{key:"scale",value:function(e,t,r){var n=r.elements,i=e.elements;n[0]=i[0]*t,n[1]=i[1]*t,n[2]=i[2]*t,n[3]=i[3]*t}},{key:"Clamp",value:function(e,t,r,n){var i=e.elements,a=i[0],o=i[1],s=i[2],l=i[3],u=t.elements,c=u[0],h=u[1],_=u[2],d=u[3],f=r.elements,m=f[0],T=f[1],p=f[2],g=f[3],E=n.elements;a=(a=a>m?m:a)<c?c:a,o=(o=o>T?T:o)<h?h:o,s=(s=s>p?p:s)<_?_:s,l=(l=l>g?g:l)<d?d:l,E[0]=a,E[1]=o,E[2]=s,E[3]=l}},{key:"distanceSquared",value:function(e,t){var r=e.elements,n=t.elements,i=r[0]-n[0],a=r[1]-n[1],o=r[2]-n[2],s=r[3]-n[3];return i*i+a*a+o*o+s*s}},{key:"distance",value:function(e,t){var r=e.elements,n=t.elements,i=r[0]-n[0],a=r[1]-n[1],o=r[2]-n[2],s=r[3]-n[3];return Math.sqrt(i*i+a*a+o*o+s*s)}},{key:"dot",value:function(e,t){var r=e.elements,n=t.elements;return r[0]*n[0]+r[1]*n[1]+r[2]*n[2]+r[3]*n[3]}},{key:"min",value:function(e,t,r){var n=r.elements,i=e.elements,a=t.elements;n[0]=Math.min(i[0],a[0]),n[1]=Math.min(i[1],a[1]),n[2]=Math.min(i[2],a[2]),n[3]=Math.min(i[3],a[3])}},{key:"max",value:function(e,t,r){var n=r.elements,i=e.elements,a=t.elements;n[0]=Math.max(i[0],a[0]),n[1]=Math.max(i[1],a[1]),n[2]=Math.max(i[2],a[2]),n[3]=Math.max(i[3],a[3])}}]),ConchVector4}();q.ZERO=new q,q.ONE=new q(1,1,1,1),q.UnitX=new q(1,0,0,0),q.UnitY=new q(0,1,0,0),q.UnitZ=new q(0,0,1,0),q.UnitW=new q(0,0,0,1);var K=function(){function ConchVector3(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;_classCallCheck(this,ConchVector3),e=i||new Float32Array(3),this.elements=e,e[0]=t,e[1]=r,e[2]=n}return _createClass(ConchVector3,[{key:"setValue",value:function(e,t,r){this.elements[0]=e,this.elements[1]=t,this.elements[2]=r}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2]}},{key:"cloneTo",value:function(e){var t=e.elements,r=this.elements;t[0]=r[0],t[1]=r[1],t[2]=r[2]}},{key:"clone",value:function(){var e=new ConchVector3;return this.cloneTo(e),e}},{key:"toDefault",value:function(){this.elements[0]=0,this.elements[1]=0,this.elements[2]=0}},{key:"x",get:function(){return this.elements[0]},set:function(e){this.elements[0]=e}},{key:"y",get:function(){return this.elements[1]},set:function(e){this.elements[1]=e}},{key:"z",get:function(){return this.elements[2]},set:function(e){this.elements[2]=e}}],[{key:"distanceSquared",value:function(e,t){var r=e.elements,n=t.elements,i=r[0]-n[0],a=r[1]-n[1],o=r[2]-n[2];return i*i+a*a+o*o}},{key:"distance",value:function(e,t){var r=e.elements,n=t.elements,i=r[0]-n[0],a=r[1]-n[1],o=r[2]-n[2];return Math.sqrt(i*i+a*a+o*o)}},{key:"min",value:function(e,t,r){var n=r.elements,i=e.elements,a=t.elements;n[0]=Math.min(i[0],a[0]),n[1]=Math.min(i[1],a[1]),n[2]=Math.min(i[2],a[2])}},{key:"max",value:function(e,t,r){var n=r.elements,i=e.elements,a=t.elements;n[0]=Math.max(i[0],a[0]),n[1]=Math.max(i[1],a[1]),n[2]=Math.max(i[2],a[2])}},{key:"transformQuat",value:function(e,t,r){var n=r.elements,i=e.elements,a=t.elements,o=i[0],s=i[1],l=i[2],u=a[0],c=a[1],h=a[2],_=a[3],d=_*o+c*l-h*s,f=_*s+h*o-u*l,m=_*l+u*s-c*o,T=-u*o-c*s-h*l;n[0]=d*_+T*-u+f*-h-m*-c,n[1]=f*_+T*-c+m*-u-d*-h,n[2]=m*_+T*-h+d*-c-f*-u}},{key:"scalarLength",value:function(e){var t=e.elements,r=t[0],n=t[1],i=t[2];return Math.sqrt(r*r+n*n+i*i)}},{key:"scalarLengthSquared",value:function(e){var t=e.elements,r=t[0],n=t[1],i=t[2];return r*r+n*n+i*i}},{key:"normalize",value:function(e,t){var r=e.elements,n=t.elements,i=r[0],a=r[1],o=r[2],s=i*i+a*a+o*o;s>0&&(s=1/Math.sqrt(s),n[0]=r[0]*s,n[1]=r[1]*s,n[2]=r[2]*s)}},{key:"multiply",value:function(e,t,r){var n=r.elements,i=e.elements,a=t.elements;n[0]=i[0]*a[0],n[1]=i[1]*a[1],n[2]=i[2]*a[2]}},{key:"scale",value:function(e,t,r){var n=r.elements,i=e.elements;n[0]=i[0]*t,n[1]=i[1]*t,n[2]=i[2]*t}},{key:"lerp",value:function(e,t,r,n){var i=n.elements,a=e.elements,o=t.elements,s=a[0],l=a[1],u=a[2];i[0]=s+r*(o[0]-s),i[1]=l+r*(o[1]-l),i[2]=u+r*(o[2]-u)}},{key:"transformV3ToV3",value:function(e,t,r){var n=ConchVector3._tempVector4;ConchVector3.transformV3ToV4(e,t,n);var i=n.elements,a=r.elements;a[0]=i[0],a[1]=i[1],a[2]=i[2]}},{key:"transformV3ToV4",value:function(e,t,r){var n=e.elements,i=n[0],a=n[1],o=n[2],s=t.elements,l=r.elements;l[0]=i*s[0]+a*s[4]+o*s[8]+s[12],l[1]=i*s[1]+a*s[5]+o*s[9]+s[13],l[2]=i*s[2]+a*s[6]+o*s[10]+s[14],l[3]=i*s[3]+a*s[7]+o*s[11]+s[15]}},{key:"TransformNormal",value:function(e,t,r){var n=e.elements,i=n[0],a=n[1],o=n[2],s=t.elements,l=r.elements;l[0]=i*s[0]+a*s[4]+o*s[8],l[1]=i*s[1]+a*s[5]+o*s[9],l[2]=i*s[2]+a*s[6]+o*s[10]}},{key:"transformCoordinate",value:function(e,t,r){var n=e.elements,i=n[0],a=n[1],o=n[2],s=t.elements,l=i*s[3]+a*s[7]+o*s[11]+s[15],u=r.elements;u[0]=i*s[0]+a*s[4]+o*s[8]+s[12]/l,u[1]=i*s[1]+a*s[5]+o*s[9]+s[13]/l,u[2]=i*s[2]+a*s[6]+o*s[10]+s[14]/l}},{key:"Clamp",value:function(e,t,r,n){var i=e.elements,a=i[0],o=i[1],s=i[2],l=t.elements,u=l[0],c=l[1],h=l[2],_=r.elements,d=_[0],f=_[1],m=_[2],T=n.elements;a=(a=a>d?d:a)<u?u:a,o=(o=o>f?f:o)<c?c:o,s=(s=s>m?m:s)<h?h:s,T[0]=a,T[1]=o,T[2]=s}},{key:"add",value:function(e,t,r){var n=r.elements,i=e.elements,a=t.elements;n[0]=i[0]+a[0],n[1]=i[1]+a[1],n[2]=i[2]+a[2]}},{key:"subtract",value:function(e,t,r){var n=r.elements,i=e.elements,a=t.elements;n[0]=i[0]-a[0],n[1]=i[1]-a[1],n[2]=i[2]-a[2]}},{key:"cross",value:function(e,t,r){var n=e.elements,i=t.elements,a=r.elements,o=n[0],s=n[1],l=n[2],u=i[0],c=i[1],h=i[2];a[0]=s*h-l*c,a[1]=l*u-o*h,a[2]=o*c-s*u}},{key:"dot",value:function(e,t){var r=e.elements,n=t.elements;return r[0]*n[0]+r[1]*n[1]+r[2]*n[2]}},{key:"equals",value:function(e,t){var n=e.elements,i=t.elements;return r.nearEqual(n[0],i[0])&&r.nearEqual(n[1],i[1])&&r.nearEqual(n[2],i[2])}}]),ConchVector3}();K._tempVector4=new q,K.ZERO=new K(0,0,0),K.ONE=new K(1,1,1),K.NegativeUnitX=new K(-1,0,0),K.UnitX=new K(1,0,0),K.UnitY=new K(0,1,0),K.UnitZ=new K(0,0,1),K.ForwardRH=new K(0,0,-1),K.ForwardLH=new K(0,0,1),K.Up=new K(0,1,0),K.NAN=new K(NaN,NaN,NaN);var J=function(){function ConchQuaternion(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;_classCallCheck(this,ConchQuaternion),(e=a||new Float32Array(4))[0]=t,e[1]=r,e[2]=n,e[3]=i,this.elements=e}return _createClass(ConchQuaternion,[{key:"scaling",value:function(e,t){var r=t.elements,n=this.elements;r[0]=n[0]*e,r[1]=n[1]*e,r[2]=n[2]*e,r[3]=n[3]*e}},{key:"normalize",value:function(e){ConchQuaternion._normalizeArray(this.elements,e.elements)}},{key:"length",value:function(){var e=this.elements,t=e[0],r=e[1],n=e[2],i=e[3];return Math.sqrt(t*t+r*r+n*n+i*i)}},{key:"rotateX",value:function(e,t){var r=t.elements,n=this.elements;e*=.5;var i=n[0],a=n[1],o=n[2],s=n[3],l=Math.sin(e),u=Math.cos(e);r[0]=i*u+s*l,r[1]=a*u+o*l,r[2]=o*u-a*l,r[3]=s*u-i*l}},{key:"rotateY",value:function(e,t){var r=t.elements,n=this.elements;e*=.5;var i=n[0],a=n[1],o=n[2],s=n[3],l=Math.sin(e),u=Math.cos(e);r[0]=i*u-o*l,r[1]=a*u+s*l,r[2]=o*u+i*l,r[3]=s*u-a*l}},{key:"rotateZ",value:function(e,t){var r=t.elements,n=this.elements;e*=.5;var i=n[0],a=n[1],o=n[2],s=n[3],l=Math.sin(e),u=Math.cos(e);r[0]=i*u+a*l,r[1]=a*u-i*l,r[2]=o*u+s*l,r[3]=s*u-o*l}},{key:"getYawPitchRoll",value:function(e){K.transformQuat(K.ForwardRH,this,ConchQuaternion.TEMPVector31),K.transformQuat(K.Up,this,ConchQuaternion.TEMPVector32);var t=ConchQuaternion.TEMPVector32.elements;ConchQuaternion.angleTo(K.ZERO,ConchQuaternion.TEMPVector31,ConchQuaternion.TEMPVector33);var r=ConchQuaternion.TEMPVector33.elements;r[0]==Math.PI/2?(r[1]=ConchQuaternion.arcTanAngle(t[2],t[0]),r[2]=0):r[0]==-Math.PI/2?(r[1]=ConchQuaternion.arcTanAngle(-t[2],-t[0]),r[2]=0):(c.createRotationY(-r[1],ConchQuaternion.TEMPMatrix0),c.createRotationX(-r[0],ConchQuaternion.TEMPMatrix1),K.transformCoordinate(ConchQuaternion.TEMPVector32,ConchQuaternion.TEMPMatrix0,ConchQuaternion.TEMPVector32),K.transformCoordinate(ConchQuaternion.TEMPVector32,ConchQuaternion.TEMPMatrix1,ConchQuaternion.TEMPVector32),r[2]=ConchQuaternion.arcTanAngle(t[1],-t[0])),r[1]<=-Math.PI&&(r[1]=Math.PI),r[2]<=-Math.PI&&(r[2]=Math.PI),r[1]>=Math.PI&&r[2]>=Math.PI&&(r[1]=0,r[2]=0,r[0]=Math.PI-r[0]);var n=e.elements;n[0]=r[1],n[1]=r[0],n[2]=r[2]}},{key:"invert",value:function(e){var t=e.elements,r=this.elements,n=r[0],i=r[1],a=r[2],o=r[3],s=n*n+i*i+a*a+o*o,l=s?1/s:0;t[0]=-n*l,t[1]=-i*l,t[2]=-a*l,t[3]=o*l}},{key:"identity",value:function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=1}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2],this.elements[3]=e[t+3]}},{key:"cloneTo",value:function(e){var t,r,n;if((r=this.elements)!==(n=e.elements))for(t=0;t<4;++t)n[t]=r[t]}},{key:"clone",value:function(){var e=new ConchQuaternion;return this.cloneTo(e),e}},{key:"equals",value:function(e){var t=this.elements,n=e.elements;return r.nearEqual(t[0],n[0])&&r.nearEqual(t[1],n[1])&&r.nearEqual(t[2],n[2])&&r.nearEqual(t[3],n[3])}},{key:"lengthSquared",value:function(){var e=this.elements[0],t=this.elements[1],r=this.elements[2],n=this.elements[3];return e*e+t*t+r*r+n*n}},{key:"x",get:function(){return this.elements[0]},set:function(e){this.elements[0]=e}},{key:"y",get:function(){return this.elements[1]},set:function(e){this.elements[1]=e}},{key:"z",get:function(){return this.elements[2]},set:function(e){this.elements[2]=e}},{key:"w",get:function(){return this.elements[3]},set:function(e){this.elements[3]=e}}],[{key:"_dotArray",value:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}},{key:"_normalizeArray",value:function(e,t){var r=e[0],n=e[1],i=e[2],a=e[3],o=r*r+n*n+i*i+a*a;o>0&&(o=1/Math.sqrt(o),t[0]=r*o,t[1]=n*o,t[2]=i*o,t[3]=a*o)}},{key:"_lerpArray",value:function(e,t,r,n){var i=1-r;ConchQuaternion._dotArray(e,t)>=0?(n[0]=i*e[0]+r*t[0],n[1]=i*e[1]+r*t[1],n[2]=i*e[2]+r*t[2],n[3]=i*e[3]+r*t[3]):(n[0]=i*e[0]-r*t[0],n[1]=i*e[1]-r*t[1],n[2]=i*e[2]-r*t[2],n[3]=i*e[3]-r*t[3]),ConchQuaternion._normalizeArray(n,n)}},{key:"createFromYawPitchRoll",value:function(e,t,r,n){var i=.5*r,a=.5*t,o=.5*e,s=Math.sin(i),l=Math.cos(i),u=Math.sin(a),c=Math.cos(a),h=Math.sin(o),_=Math.cos(o),d=n.elements;d[0]=_*u*l+h*c*s,d[1]=h*c*l-_*u*s,d[2]=_*c*s-h*u*l,d[3]=_*c*l+h*u*s}},{key:"multiply",value:function(e,t,r){var n=e.elements,i=t.elements,a=r.elements,o=n[0],s=n[1],l=n[2],u=n[3],c=i[0],h=i[1],_=i[2],d=i[3],f=s*_-l*h,m=l*c-o*_,T=o*h-s*c,p=o*c+s*h+l*_;a[0]=o*d+c*u+f,a[1]=s*d+h*u+m,a[2]=l*d+_*u+T,a[3]=u*d-p}},{key:"arcTanAngle",value:function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}},{key:"angleTo",value:function(e,t,r){K.subtract(t,e,ConchQuaternion.TEMPVector30),K.normalize(ConchQuaternion.TEMPVector30,ConchQuaternion.TEMPVector30),r.elements[0]=Math.asin(ConchQuaternion.TEMPVector30.y),r.elements[1]=ConchQuaternion.arcTanAngle(-ConchQuaternion.TEMPVector30.z,-ConchQuaternion.TEMPVector30.x)}},{key:"createFromAxisAngle",value:function(e,t,r){var n=r.elements,i=e.elements;t*=.5;var a=Math.sin(t);n[0]=a*i[0],n[1]=a*i[1],n[2]=a*i[2],n[3]=Math.cos(t)}},{key:"createFromMatrix3x3",value:function(e,t){var r,n=t.elements,i=e.elements,a=i[0]+i[4]+i[8];if(a>0)r=Math.sqrt(a+1),n[3]=.5*r,r=.5/r,n[0]=(i[5]-i[7])*r,n[1]=(i[6]-i[2])*r,n[2]=(i[1]-i[3])*r;else{var o=0;i[4]>i[0]&&(o=1),i[8]>i[3*o+o]&&(o=2);var s=(o+1)%3,l=(o+2)%3;r=Math.sqrt(i[3*o+o]-i[3*s+s]-i[3*l+l]+1),n[o]=.5*r,r=.5/r,n[3]=(i[3*s+l]-i[3*l+s])*r,n[s]=(i[3*s+o]+i[3*o+s])*r,n[l]=(i[3*l+o]+i[3*o+l])*r}}},{key:"createFromMatrix4x4",value:function(e,t){var r,n,i=e.elements,a=t.elements,o=i[0]+i[5]+i[10];o>0?(r=Math.sqrt(o+1),a[3]=.5*r,r=.5/r,a[0]=(i[6]-i[9])*r,a[1]=(i[8]-i[2])*r,a[2]=(i[1]-i[4])*r):i[0]>=i[5]&&i[0]>=i[10]?(n=.5/(r=Math.sqrt(1+i[0]-i[5]-i[10])),a[0]=.5*r,a[1]=(i[1]+i[4])*n,a[2]=(i[2]+i[8])*n,a[3]=(i[6]-i[9])*n):i[5]>i[10]?(n=.5/(r=Math.sqrt(1+i[5]-i[0]-i[10])),a[0]=(i[4]+i[1])*n,a[1]=.5*r,a[2]=(i[9]+i[6])*n,a[3]=(i[8]-i[2])*n):(n=.5/(r=Math.sqrt(1+i[10]-i[0]-i[5])),a[0]=(i[8]+i[2])*n,a[1]=(i[9]+i[6])*n,a[2]=.5*r,a[3]=(i[1]-i[4])*n)}},{key:"slerp",value:function(e,t,r,n){var i,a,o,s,l,u=e.elements,c=t.elements,h=n.elements,_=u[0],d=u[1],f=u[2],m=u[3],T=c[0],p=c[1],g=c[2],E=c[3];return(a=_*T+d*p+f*g+m*E)<0&&(a=-a,T=-T,p=-p,g=-g,E=-E),1-a>1e-6?(i=Math.acos(a),o=Math.sin(i),s=Math.sin((1-r)*i)/o,l=Math.sin(r*i)/o):(s=1-r,l=r),h[0]=s*_+l*T,h[1]=s*d+l*p,h[2]=s*f+l*g,h[3]=s*m+l*E,h}},{key:"lerp",value:function(e,t,r,n){ConchQuaternion._lerpArray(e.elements,t.elements,r,n.elements)}},{key:"add",value:function(e,t,r){var n=r.elements,i=e.elements,a=t.elements;n[0]=i[0]+a[0],n[1]=i[1]+a[1],n[2]=i[2]+a[2],n[3]=i[3]+a[3]}},{key:"dot",value:function(e,t){return ConchQuaternion._dotArray(e.elements,t.elements)}},{key:"rotationLookAt",value:function(e,t,r){ConchQuaternion.lookAt(K.ZERO,e,t,r)}},{key:"lookAt",value:function(e,t,r,n){s.lookAt(e,t,r,ConchQuaternion._tempMatrix3x3),ConchQuaternion.rotationMatrix(ConchQuaternion._tempMatrix3x3,n)}},{key:"invert",value:function(e,t){var n=e.elements,i=t.elements,a=e.lengthSquared();r.isZero(a)||(a=1/a,i[0]=-n[0]*a,i[1]=-n[1]*a,i[2]=-n[2]*a,i[3]=n[3]*a)}},{key:"rotationMatrix",value:function(e,t){var r,n,i=e.elements,a=i[0],o=i[1],s=i[2],l=i[3],u=i[4],c=i[5],h=i[6],_=i[7],d=i[8],f=t.elements,m=a+u+d;m>0?(r=Math.sqrt(m+1),f[3]=.5*r,r=.5/r,f[0]=(c-_)*r,f[1]=(h-s)*r,f[2]=(o-l)*r):a>=u&&a>=d?(n=.5/(r=Math.sqrt(1+a-u-d)),f[0]=.5*r,f[1]=(o+l)*n,f[2]=(s+h)*n,f[3]=(c-_)*n):u>d?(n=.5/(r=Math.sqrt(1+u-a-d)),f[0]=(l+o)*n,f[1]=.5*r,f[2]=(_+c)*n,f[3]=(h-s)*n):(n=.5/(r=Math.sqrt(1+d-a-u)),f[0]=(h+s)*n,f[1]=(_+c)*n,f[2]=.5*r,f[3]=(o-l)*n)}}]),ConchQuaternion}();J.TEMPVector30=new K,J.TEMPVector31=new K,J.TEMPVector32=new K,J.TEMPVector33=new K,J.TEMPMatrix0=new c,J.TEMPMatrix1=new c,J._tempMatrix3x3=new s,J.DEFAULT=new J,J.NAN=new J(NaN,NaN,NaN,NaN);var $=function(){function AnimatorState(){_classCallCheck(this,AnimatorState),this._referenceCount=0,this._clip=null,this._nodeOwners=[],this._currentFrameIndices=null,this._realtimeDatas=[],this._scripts=null,this.speed=1,this.clipStart=0,this.clipEnd=1}return _createClass(AnimatorState,[{key:"_getReferenceCount",value:function(){return this._referenceCount}},{key:"_addReference",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._clip&&this._clip._addReference(e),this._referenceCount+=e}},{key:"_removeReference",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._clip&&this._clip._removeReference(e),this._referenceCount-=e}},{key:"_clearReference",value:function(){this._removeReference(-this._referenceCount)}},{key:"_resetFrameIndices",value:function(){for(var e=0,t=this._currentFrameIndices.length;e<t;e++)this._currentFrameIndices[e]=-1}},{key:"addScript",value:function(e){var t=new e;return this._scripts=this._scripts||[],this._scripts.push(t),t}},{key:"getScript",value:function(e){if(this._scripts)for(var t=0,r=this._scripts.length;t<r;t++){var n=this._scripts[t];if(n instanceof e)return n}return null}},{key:"getScripts",value:function(e){var t;if(this._scripts)for(var r=0,n=this._scripts.length;r<n;r++){var i=this._scripts[r];i instanceof e&&(t=t||[]).push(i)}return t}},{key:"cloneTo",value:function(e){var t=e;t.name=this.name,t.speed=this.speed,t.clipStart=this.clipStart,t.clipEnd=this.clipEnd,t.clip=this._clip}},{key:"clone",value:function(){var e=new AnimatorState;return this.cloneTo(e),e}},{key:"clip",get:function(){return this._clip},set:function(e){if(this._clip!==e){if(this._clip&&this._referenceCount>0&&this._clip._removeReference(this._referenceCount),e){var r=this._realtimeDatas,n=e._nodes,i=n.count;this._currentFrameIndices=new Int16Array(i),this._resetFrameIndices(),this._referenceCount>0&&e._addReference(this._referenceCount),this._realtimeDatas.length=i;for(var a=0;a<i;a++)switch(n.getNodeByIndex(a).type){case 0:break;case 1:case 3:case 4:r[a]=t.Render.supportWebGLPlusAnimation?new K:new o;break;case 2:r[a]=t.Render.supportWebGLPlusAnimation?new J:new u;break;default:throw"AnimationClipParser04:unknown type."}}this._clip=e}}}]),AnimatorState}(),ee=function(){function KeyframeNodeOwner(){_classCallCheck(this,KeyframeNodeOwner),this.indexInList=-1,this.referenceCount=0,this.updateMark=-1,this.type=-1,this.fullPath=null,this.propertyOwner=null,this.property=null,this.defaultValue=null,this.value=null,this.crossFixedValue=null}return _createClass(KeyframeNodeOwner,[{key:"saveCrossFixedValue",value:function(){if(this.propertyOwner)switch(this.type){case 0:this.crossFixedValue=this.value;break;case 1:case 3:case 4:case 2:this.value.cloneTo(this.crossFixedValue);break;default:throw"Animator:unknown type."}}}]),KeyframeNodeOwner}(),te=function(e){function Animator(){var e;return _classCallCheck(this,Animator),(e=_possibleConstructorReturn(this,_getPrototypeOf(Animator).call(this)))._keyframeNodeOwners=[],e._linkAvatarSpritesData={},e._linkAvatarSprites=[],e._renderableSprites=[],e.cullingMode=Animator.CULLINGMODE_CULLCOMPLETELY,e._controllerLayers=[],e._linkSprites={},e._speed=1,e._keyframeNodeOwnerMap={},e._updateMark=0,e}return _inherits(Animator,e),_createClass(Animator,[{key:"_linkToSprites",value:function(e){for(var t in e){for(var r=this.owner,n=e[t],i=0,a=n.length;i<a;i++){var o=n[i];if(""===o)break;if(!(r=r.getChildByName(o)))break}r&&this.linkSprite3DToAvatarNode(t,r)}}},{key:"_addKeyframeNodeOwner",value:function(e,t,r){var n=t._indexInList,i=t.fullPath,a=this._keyframeNodeOwnerMap[i];if(a)a.referenceCount++,e[n]=a;else{for(var o=r,s=0,l=t.propertyCount;s<l&&(o=o[t.getPropertyByIndex(s)]);s++);(a=this._keyframeNodeOwnerMap[i]=new ee).fullPath=i,a.indexInList=this._keyframeNodeOwners.length,a.referenceCount=1,a.propertyOwner=r;var u=t.propertyCount,c=[];for(s=0;s<u;s++)c[s]=t.getPropertyByIndex(s);if(a.property=c,a.type=t.type,o)if(0===t.type)a.defaultValue=o;else{var h=new o.constructor;o.cloneTo(h),a.defaultValue=h,a.value=new o.constructor,a.crossFixedValue=new o.constructor}this._keyframeNodeOwners.push(a),e[n]=a}}},{key:"_removeKeyframeNodeOwner",value:function(e,t){var r=t.fullPath,n=this._keyframeNodeOwnerMap[r];n&&(n.referenceCount--,0===n.referenceCount&&(delete this._keyframeNodeOwnerMap[r],this._keyframeNodeOwners.splice(this._keyframeNodeOwners.indexOf(n),1)),e[t._indexInList]=null)}},{key:"_getOwnersByClip",value:function(e){var t=e._clip._nodes,r=t.count,n=e._nodeOwners;n.length=r;for(var i=0;i<r;i++){for(var a=t.getNodeByIndex(i),o=this._avatar?this._avatarNodeMap[this._avatar._rootNode.name]:this.owner,s=0,l=a.ownerPathCount;s<l;s++){var u=a.getOwnerPathByIndex(s);if(""===u)break;if(!(o=o.getChildByName(u)))break}if(o){var c=a.propertyOwner;c&&(o=o[c]),o&&this._addKeyframeNodeOwner(n,a,o)}}}},{key:"_updatePlayer",value:function(e,t,r,n){var i=e._clip._duration*(e.clipEnd-e.clipStart),a=t._elapsedTime,o=a+r;t._lastElapsedTime=a,t._elapsedTime=o;var s=o/i;t._normalizedTime=s;var l=s%1;t._normalizedPlayTime=l<0?l+1:l,t._duration=i;var u=e._scripts;if(!n&&o>=i){if(t._finish=!0,t._elapsedTime=i,t._normalizedPlayTime=1,u)for(var c=0,h=u.length;c<h;c++)u[c].onStateExit()}else if(u)for(c=0,h=u.length;c<h;c++)u[c].onStateUpdate()}},{key:"_eventScript",value:function(e,t,r,n,i){if(i)for(var a=t.length;r<a;r++){var o=t[r];if(!(o.time<=n))break;for(var s=0,l=e.length;s<l;s++){var u=e[s],c=u[o.eventName];c&&c.apply(u,o.params)}}else for(;r>=0&&(o=t[r]).time>=n;r--)for(s=0,l=e.length;s<l;s++)(c=(u=e[s])[o.eventName])&&c.apply(u,o.params);return r}},{key:"_updateEventScript",value:function(e,t){var r=this.owner._scripts;if(r){var n=e._clip,i=n._animationEvents,a=n._duration,o=t._elapsedTime,s=o%a,l=Math.abs(Math.floor(o/a)-Math.floor(t._lastElapsedTime/a)),u=t._elapsedTime>=t._lastElapsedTime;t._lastIsFront!==u&&(u?t._playEventIndex++:t._playEventIndex--,t._lastIsFront=u);var c=t._playEventIndex;if(u){var h=this._eventScript(r,i,t._playEventIndex,l>0?a:s,!0);c===t._playEventIndex&&(t._playEventIndex=h);for(var _=0,d=l-1;_<d;_++)this._eventScript(r,i,0,a,!0);l>0&&s>0&&(t._playEventIndex=this._eventScript(r,i,0,s,!0))}else{h=this._eventScript(r,i,t._playEventIndex,l>0?0:s,!1);c===t._playEventIndex&&(t._playEventIndex=h);var f=i.length-1;for(_=0,d=l-1;_<d;_++)this._eventScript(r,i,f,0,!1);l>0&&s>0&&(t._playEventIndex=this._eventScript(r,i,f,s,!1))}}}},{key:"_updateClipDatas",value:function(e,t,r,n){var i=e._clip,a=i._duration,o=e.clipStart*a+r._normalizedPlayTime*r._duration,s=e._currentFrameIndices,l=r._elapsedTime>r._lastElapsedTime;i._evaluateClipDatasRealTime(i._nodes,o,s,t,l,e._realtimeDatas)}},{key:"_applyFloat",value:function(e,t,r,n,i,a,o){if(r.updateMark===this._updateMark)if(n)e[t]+=i*o;else{var s=e[t];e[t]=s+i*(o-s)}else if(a)e[t]=n?r.defaultValue+o:o;else if(n)e[t]=r.defaultValue+i*o;else{var l=r.defaultValue;e[t]=l+i*(o-l)}}},{key:"_applyPositionAndRotationEuler",value:function(e,t,r,n,i,a){if(e.updateMark===this._updateMark)if(t)a.x+=r*i.x,a.y+=r*i.y,a.z+=r*i.z;else{var o=a.x,s=a.y,l=a.z;a.x=o+r*(i.x-o),a.y=s+r*(i.y-s),a.z=l+r*(i.z-l)}else if(n)if(t){var u=e.defaultValue;a.x=u.x+i.x,a.y=u.y+i.y,a.z=u.z+i.z}else a.x=i.x,a.y=i.y,a.z=i.z;else if(u=e.defaultValue,t)a.x=u.x+r*i.x,a.y=u.y+r*i.y,a.z=u.z+r*i.z;else{var c=u.x,h=u.y,_=u.z;a.x=c+r*(i.x-c),a.y=h+r*(i.y-h),a.z=_+r*(i.z-_)}}},{key:"_applyRotation",value:function(e,t,r,n,i,a){if(e.updateMark===this._updateMark)if(t){var o=Animator._tempQuaternion1;P.quaternionWeight(i,r,o),o.normalize(o),u.multiply(a,o,a)}else u.lerp(a,i,r,a);else if(n)if(t){var s=e.defaultValue;u.multiply(s,i,a)}else a.x=i.x,a.y=i.y,a.z=i.z,a.w=i.w;else s=e.defaultValue,t?(o=Animator._tempQuaternion1,P.quaternionWeight(i,r,o),o.normalize(o),u.multiply(s,o,a)):u.lerp(s,i,r,a)}},{key:"_applyScale",value:function(e,t,r,n,i,a){if(e.updateMark===this._updateMark)if(t){var o=Animator._tempVector31;P.scaleWeight(i,r,o),a.x=a.x*o.x,a.y=a.y*o.y,a.z=a.z*o.z}else P.scaleBlend(a,i,r,a);else if(n)if(t){var s=e.defaultValue;a.x=s.x*i.x,a.y=s.y*i.y,a.z=s.z*i.z}else a.x=i.x,a.y=i.y,a.z=i.z;else s=e.defaultValue,t?(o=Animator._tempVector31,P.scaleWeight(i,r,o),a.x=s.x*o.x,a.y=s.y*o.y,a.z=s.z*o.z):P.scaleBlend(s,i,r,a)}},{key:"_applyCrossData",value:function(e,t,r,n,i,a,o){var s=e.propertyOwner;if(s){switch(e.type){case 0:for(var l=e.property,c=l.length-1,h=0;h<c&&(s=s[l[h]]);h++);var _=i+o*(a-i);e.value=_,this._applyFloat(s,l[c],e,t,r,n,_);break;case 1:var d=s.localPosition,f=e.value,m=i.x,T=i.y,p=i.z;f.x=m+o*(a.x-m),f.y=T+o*(a.y-T),f.z=p+o*(a.z-p),this._applyPositionAndRotationEuler(e,t,r,n,f,d),s.localPosition=d;break;case 2:var g=s.localRotation,E=e.value;u.lerp(i,a,o,E),this._applyRotation(e,t,r,n,E,g),s.localRotation=g;break;case 3:var y=s.localScale,S=e.value;P.scaleBlend(i,a,o,S),this._applyScale(e,t,r,n,S,y),s.localScale=y;break;case 4:var v=s.localRotationEuler,R=e.value;m=i.x,T=i.y,p=i.z,R.x=m+o*(a.x-m),R.y=T+o*(a.y-T),R.z=p+o*(a.z-p),this._applyPositionAndRotationEuler(e,t,r,n,R,v),s.localRotationEuler=v}e.updateMark=this._updateMark}}},{key:"_setClipDatasToNode",value:function(e,t,r,n){for(var i=e._realtimeDatas,a=e._clip._nodes,o=e._nodeOwners,s=0,l=a.count;s<l;s++){var u=o[s];if(u){var c=u.propertyOwner;if(c){switch(u.type){case 0:for(var h=u.property,_=h.length-1,d=0;d<_&&(c=c[h[d]]);d++);this._applyFloat(c,h[_],u,t,r,n,i[s]);break;case 1:var f=c.localPosition;this._applyPositionAndRotationEuler(u,t,r,n,i[s],f),c.localPosition=f;break;case 2:var m=c.localRotation;this._applyRotation(u,t,r,n,i[s],m),c.localRotation=m;break;case 3:var T=c.localScale;this._applyScale(u,t,r,n,i[s],T),c.localScale=T;break;case 4:var p=c.localRotationEuler;this._applyPositionAndRotationEuler(u,t,r,n,i[s],p),c.localRotationEuler=p}u.updateMark=this._updateMark}}}}},{key:"_setCrossClipDatasToNode",value:function(e,t,r,n,i){for(var a=e._crossNodesOwners,o=e._crossNodesOwnersCount,s=e.blendingMode!==Q.BLENDINGMODE_OVERRIDE,l=e.defaultWeight,u=r._realtimeDatas,c=e._destCrossClipNodeIndices,h=r._nodeOwners,_=t._realtimeDatas,d=e._srcCrossClipNodeIndices,f=t._nodeOwners,m=0;m<o;m++){var T=a[m];if(T){var p=d[m],g=c[m],E=-1!==p?_[p]:h[g].defaultValue,y=-1!==g?u[g]:f[p].defaultValue;this._applyCrossData(T,s,l,i,E,y,n)}}}},{key:"_setFixedCrossClipDatasToNode",value:function(e,t,r,n){for(var i=e._crossNodesOwners,a=e._crossNodesOwnersCount,o=e.blendingMode!==Q.BLENDINGMODE_OVERRIDE,s=e.defaultWeight,l=t._realtimeDatas,u=e._destCrossClipNodeIndices,c=0;c<a;c++){var h=i[c];if(h){var _=u[c],d=h.crossFixedValue,f=-1!==_?l[_]:h.defaultValue;this._applyCrossData(h,o,s,n,d,f,r)}}}},{key:"_revertDefaultKeyframeNodes",value:function(e){for(var t=e._nodeOwners,r=0,n=t.length;r<n;r++){var i=t[r];if(i){var a=i.propertyOwner;if(a)switch(i.type){case 0:for(var o=i.property,s=o.length-1,l=0;l<s&&(a=a[o[l]]);l++);a[o[s]]=i.defaultValue;break;case 1:var u=a.localPosition,c=i.defaultValue;u.x=c.x,u.y=c.y,u.z=c.z,a.localPosition=u;break;case 2:var h=a.localRotation,_=i.defaultValue;h.x=_.x,h.y=_.y,h.z=_.z,h.w=_.w,a.localRotation=h;break;case 3:var d=a.localScale;c=i.defaultValue,d.x=c.x,d.y=c.y,d.z=c.z,a.localScale=d;break;case 4:var f=a.localRotationEuler;c=i.defaultValue,f.x=c.x,f.y=c.y,f.z=c.z,a.localRotationEuler=f;break;default:throw"Animator:unknown type."}}}}},{key:"_onAdded",value:function(){var e=this.owner._parent;this.owner._setHierarchyAnimator(this,e?e._hierarchyAnimator:null),this.owner._changeAnimatorToLinkSprite3DNoAvatar(this,!0,[])}},{key:"_onDestroy",value:function(){for(var e=0,t=this._controllerLayers.length;e<t;e++)this._controllerLayers[e]._removeReference();var r=this.owner._parent;this.owner._clearHierarchyAnimator(this,r?r._hierarchyAnimator:null)}},{key:"_onEnable",value:function(){this.owner._scene._animatorPool.add(this);for(var e=0,t=this._controllerLayers.length;e<t;e++){if(this._controllerLayers[e].playOnWake)this.getDefaultState(e)&&this.play(null,e,0)}}},{key:"_onDisable",value:function(){this.owner._scene._animatorPool.remove(this)}},{key:"_handleSpriteOwnersBySprite",value:function(e,t,r){for(var n=0,i=this._controllerLayers.length;n<i;n++)for(var a=this._controllerLayers[n]._states,o=0,s=a.length;o<s;o++){var l=a[o],u=l._clip,c=t.join("/"),h=u._nodesMap[c];if(h)for(var _=l._nodeOwners,d=0,f=h.length;d<f;d++)e?this._addKeyframeNodeOwner(_,h[d],r):this._removeKeyframeNodeOwner(_,h[d])}}},{key:"_parse",value:function(e){var r=e.avatar;if(r){this.avatar=t.Loader.getRes(r.path);var n=r.linkSprites;this._linkSprites=n,this._linkToSprites(n)}e.clipPaths;for(var i=e.playOnWake,a=e.layers,o=0;o<a.length;o++){var s=a[o],l=new Q(s.name);l.defaultWeight=0===o?1:s.weight;var u=s.blendingMode;u&&(l.blendingMode=u),this.addControllerLayer(l);for(var c=s.states,h=0,_=c.length;h<_;h++){var d=c[h],f=d.clipPath;if(f){var m,T=d.name;if(m=t.Loader.getRes(f)){var p=new $;p.name=T,p.clip=m,l.addState(p),0===h&&(this.getControllerLayer(o).defaultState=p)}}}void 0!==i&&(l.playOnWake=i)}var g=e.cullingMode;void 0!==g&&(this.cullingMode=g)}},{key:"_update",value:function(){var e=this.owner._scene.timer,t=e._delta/1e3;if(0!==this._speed&&0!==t){var r;if(this.cullingMode===Animator.CULLINGMODE_CULLCOMPLETELY){r=!1;for(var n=0,i=this._renderableSprites.length;n<i;n++)if(this._renderableSprites[n]._render.isRender){r=!0;break}}else r=!0;this._updateMark++;var a=e.scale;for(n=0,i=this._controllerLayers.length;n<i;n++){var o=this._controllerLayers[n],s=o._playStateInfo,l=o._crossPlayStateInfo;switch(d=o.blendingMode!==Q.BLENDINGMODE_OVERRIDE,o._playType){case 0:var u=s._currentState,c=u._clip,h=this._speed*u.speed,_=s._finish;if(_||this._updatePlayer(u,s,t*h,c.islooping),r){var d=o.blendingMode!==Q.BLENDINGMODE_OVERRIDE;this._updateClipDatas(u,d,s,a*h),this._setClipDatasToNode(u,d,o.defaultWeight,0===n),_||this._updateEventScript(u,s)}break;case 1:c=(u=s._currentState)._clip;var f=o._crossPlayState,m=f._clip,T=o._crossDuration,p=l._startPlayTime,g=m._duration-p,E=T>g?g/T:1,y=this._speed*f.speed;this._updatePlayer(f,l,t*E*y,m.islooping);var S=(l._elapsedTime-p)/E/T;S>=1?r&&(this._updateClipDatas(f,d,l,a*y),this._setClipDatasToNode(f,d,o.defaultWeight,0===n),o._playType=0,s._currentState=f,l._cloneTo(s)):(s._finish||(h=this._speed*u.speed,this._updatePlayer(u,s,t*h,c.islooping),r&&this._updateClipDatas(u,d,s,a*h)),r&&(this._updateClipDatas(f,d,l,a*E*y),this._setCrossClipDatasToNode(o,u,f,S,0===n))),r&&(this._updateEventScript(u,s),this._updateEventScript(f,l));break;case 2:m=(f=o._crossPlayState)._clip,T=o._crossDuration,p=l._startPlayTime,E=T>(g=m._duration-p)?g/T:1,y=this._speed*f.speed,this._updatePlayer(f,l,t*E*y,m.islooping),r&&((S=(l._elapsedTime-p)/E/T)>=1?(this._updateClipDatas(f,d,l,a*y),this._setClipDatasToNode(f,d,1,0===n),o._playType=0,s._currentState=f,l._cloneTo(s)):(this._updateClipDatas(f,d,l,a*E*y),this._setFixedCrossClipDatasToNode(o,f,S,0===n)),this._updateEventScript(f,l))}}r&&this._avatar&&this._updateAvatarNodesToSprite()}}},{key:"_cloneTo",value:function(e){var t=e;t.avatar=this.avatar,t.cullingMode=this.cullingMode;for(var r=0,n=this._controllerLayers.length;r<n;r++){var i=this._controllerLayers[r];t.addControllerLayer(i.clone());for(var a=i._states,o=0,s=a.length;o<s;o++){var l=a[o].clone(),u=t.getControllerLayer(r);u.addState(l),0==o&&(u.defaultState=l)}}t._linkSprites=this._linkSprites,t._linkToSprites(this._linkSprites)}},{key:"getDefaultState",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=this._controllerLayers[e];return t.defaultState}},{key:"addState",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=this._controllerLayers[t];r.addState(e),console.warn("Animator:this function is discard,please use animatorControllerLayer.addState() instead.")}},{key:"removeState",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=this._controllerLayers[t];r.removeState(e),console.warn("Animator:this function is discard,please use animatorControllerLayer.removeState() instead.")}},{key:"addControllerLayer",value:function(e){this._controllerLayers.push(e),e._animator=this,e._addReference();for(var t=e._states,r=0,n=t.length;r<n;r++)this._getOwnersByClip(t[r])}},{key:"getControllerLayer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._controllerLayers[e]}},{key:"play",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.NEGATIVE_INFINITY,n=this._controllerLayers[t];if(n){var i=n.defaultState;if(!e&&!i)throw new Error("Animator:must have default clip value,please set clip property.");var a=n._playStateInfo,o=a._currentState,s=e?n._statesMap[e]:i,l=s._clip._duration;o!==s?(r!==Number.NEGATIVE_INFINITY?a._resetPlayState(l*r):a._resetPlayState(0),null!==o&&o!==s&&this._revertDefaultKeyframeNodes(o),n._playType=0,a._currentState=s):r!==Number.NEGATIVE_INFINITY&&(a._resetPlayState(l*r),n._playType=0);var u=s._scripts;if(u)for(var c=0,h=u.length;c<h;c++)u[c].onStateEnter()}else console.warn("Invalid layerIndex "+t+".")}},{key:"crossFade",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Number.NEGATIVE_INFINITY,i=this._controllerLayers[r];if(i){var a=i._statesMap[e];if(a){var o=i._playType;if(-1===o)return void this.play(e,r,n);var s=i._crossPlayStateInfo,l=i._crossNodesOwners,u=i._crossNodesOwnersIndicesMap,c=i._playStateInfo._currentState,h=a._nodeOwners,_=i._destCrossClipNodeIndices,d=a._clip,f=d._nodes,m=d._nodesDic;switch(o){case 0:var T=c._nodeOwners,p=i._srcCrossClipNodeIndices,g=c._clip,E=g._nodes,y=g._nodesDic;i._playType=1;for(var S=++i._crossMark,v=i._crossNodesOwnersCount=0,R=0,C=E.count;R<C;R++){var M=E.getNodeByIndex(R),D=M._indexInList,x=T[D];if(x){var A=M.fullPath;p[v]=D;var I=m[A];_[v]=I?I._indexInList:-1,u[A]=S,l[v]=x,v++}}for(R=0,C=f.count;R<C;R++){var L=(I=f.getNodeByIndex(R))._indexInList,P=h[L];if(P){var O=I.fullPath;y[O]||(p[v]=-1,_[v]=L,u[O]=S,l[v]=P,v++)}}break;case 1:case 2:for(i._playType=2,R=0,C=l.length;R<C;R++){var N=l[R];N.saveCrossFixedValue(),I=m[N.fullPath],_[R]=I?I._indexInList:-1}for(v=i._crossNodesOwnersCount,S=i._crossMark,R=0,C=f.count;R<C;R++)(P=h[L=(I=f.getNodeByIndex(R))._indexInList])&&u[O=I.fullPath]!==S&&(_[v]=L,u[O]=S,N=h[L],l[v]=N,N.saveCrossFixedValue(),v++)}i._crossNodesOwnersCount=v,i._crossPlayState=a,i._crossDuration=c._clip._duration*t,n!==Number.NEGATIVE_INFINITY?s._resetPlayState(d._duration*n):s._resetPlayState(0);var b=a._scripts;if(b)for(R=0,C=b.length;R<C;R++)b[R].onStateEnter()}else console.warn("Invalid name "+r+".")}else console.warn("Invalid layerIndex "+r+".")}},{key:"getCurrentAnimatorPlayState",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._controllerLayers[e]._playStateInfo}},{key:"_isLinkSpriteToAnimationNodeData",value:function(e,t,r){var n=this._linkAvatarSpritesData[t];if(r)n||(this._linkAvatarSpritesData[t]=n=[]),n.push(e);else{var i=n.indexOf(e);n.splice(i,1)}}},{key:"_getAvatarOwnersAndInitDatasAsync",value:function(){for(var e=0,t=this._controllerLayers.length;e<t;e++)for(var r=this._controllerLayers[e]._states,n=0,i=r.length;n<i;n++)this._getOwnersByClip(r[n]);for(var a in this._avatar._cloneDatasToAnimator(this),this._linkAvatarSpritesData){var o=this._linkAvatarSpritesData[a];if(o)for(var s=0,l=o.length;s<l;s++)this._isLinkSpriteToAnimationNode(o[s],a,!0)}}},{key:"_isLinkSpriteToAnimationNode",value:function(e,t,r){if(this._avatar){var n=this._avatarNodeMap[t];if(n)if(r){e._transform._dummy=n.transform,this._linkAvatarSprites.push(e);var i=n.transform,a=e.transform;if(!a.owner.isStatic&&i){var o=a.worldMatrix,s=this.owner._transform._parent;if(s)P.matrix4x4MultiplyMFM(s.worldMatrix,i.getWorldMatrix(),o);else for(var l=o.elements,u=i.getWorldMatrix(),c=0;c<16;c++)l[c]=u[c];a.worldMatrix=o}}else e._transform._dummy=null,this._linkAvatarSprites.splice(this._linkAvatarSprites.indexOf(e),1)}}},{key:"_updateAvatarNodesToSprite",value:function(){for(var e=0,t=this._linkAvatarSprites.length;e<t;e++){var r=this._linkAvatarSprites[e],n=r.transform._dummy,i=r.transform;if(!i.owner.isStatic&&n){var a=i.worldMatrix,o=this.owner._transform;P.matrix4x4MultiplyMFM(o.worldMatrix,n.getWorldMatrix(),a),i.worldMatrix=a}}}},{key:"linkSprite3DToAvatarNode",value:function(e,t){return this._isLinkSpriteToAnimationNodeData(t,e,!0),this._isLinkSpriteToAnimationNode(t,e,!0),!0}},{key:"unLinkSprite3DToAvatarNode",value:function(e){var t=e.transform._dummy;if(t){var r=t._owner.name;return this._isLinkSpriteToAnimationNodeData(e,r,!1),this._isLinkSpriteToAnimationNode(e,r,!1),!0}return!1}},{key:"_updateAnimationNodeWorldMatix",value:function(e,r,n,i,a){t.LayaGL.instance.updateAnimationNodeWorldMatix(e,r,n,a,i)}},{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e}},{key:"avatar",get:function(){return this._avatar},set:function(e){if(this._avatar!==e)if(this._avatar=e,e)this._getAvatarOwnersAndInitDatasAsync(),this.owner._changeHierarchyAnimatorAvatar(this,e);else{var t=this.owner._parent;this.owner._changeHierarchyAnimatorAvatar(this,t?t._hierarchyAnimator._avatar:null)}}}],[{key:"_update",value:function(e){for(var t=e._animatorPool,r=t.elements,n=0,i=t.length;n<i;n++){var a=r[n];a&&a.enabled&&a._update()}}}]),Animator}(t.Component);te._tempVector30=new o,te._tempVector31=new o,te._tempQuaternion0=new u,te._tempQuaternion1=new u,te.CULLINGMODE_ALWAYSANIMATE=0,te.CULLINGMODE_CULLCOMPLETELY=2;var re=function PostProcessRenderContext(){_classCallCheck(this,PostProcessRenderContext),this.source=null,this.destination=null,this.camera=null,this.compositeShaderData=null,this.command=null,this.deferredReleaseTextures=[]},ne=function RenderContext3D(){_classCallCheck(this,RenderContext3D),this.invertY=!1};ne._instance=new ne;var ie=function(e){function RenderTexture(e,r){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.RenderTextureFormat.R8G8B8,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.RenderTextureDepthFormat.DEPTH_16;return _classCallCheck(this,RenderTexture),(n=_possibleConstructorReturn(this,_getPrototypeOf(RenderTexture).call(this,i,!1)))._inPool=!1,n._isCameraTarget=!1,n._glTextureType=t.LayaGL.instance.TEXTURE_2D,n._width=e,n._height=r,n._depthStencilFormat=a,n._mipmapCount=1,n._create(e,r),n}return _inherits(RenderTexture,e),_createClass(RenderTexture,[{key:"_create",value:function(e,r){var n=t.LayaGL.instance,i=n,a=this._glTextureType,o=t.LayaGL.layaGPUInstance,s=o._isWebGL2,l=this._format;if(this._frameBuffer=n.createFramebuffer(),n.bindFramebuffer(n.FRAMEBUFFER,this._frameBuffer),l!==t.RenderTextureFormat.Depth&&l!==t.RenderTextureFormat.ShadowMap){switch(t.WebGLContext.bindTexture(n,a,this._glTexture),l){case t.RenderTextureFormat.R8G8B8:s?i.texStorage2D(a,this._mipmapCount,i.RGB8,e,r):n.texImage2D(a,0,n.RGB,e,r,0,n.RGB,n.UNSIGNED_BYTE,null);break;case t.RenderTextureFormat.R8G8B8A8:s?i.texStorage2D(a,this._mipmapCount,i.RGBA8,e,r):n.texImage2D(a,0,n.RGBA,e,r,0,n.RGBA,n.UNSIGNED_BYTE,null);break;case t.RenderTextureFormat.Alpha8:s?i.texStorage2D(a,0,i.R8,e,r):n.texImage2D(a,0,n.ALPHA,e,r,0,n.ALPHA,n.UNSIGNED_BYTE,null);break;case t.RenderTextureFormat.R16G16B16A16:s?i.texStorage2D(a,this._mipmapCount,i.RGBA16F,e,r):n.texImage2D(a,0,n.RGBA,e,r,0,n.RGBA,o._oesTextureHalfFloat.HALF_FLOAT_OES,null)}n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,this._glTexture,0)}if(l==t.RenderTextureFormat.Depth||l==t.RenderTextureFormat.ShadowMap){switch(t.WebGLContext.bindTexture(n,a,this._glTexture),this._depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:s?i.texStorage2D(a,this._mipmapCount,i.DEPTH_COMPONENT16,e,r):n.texImage2D(a,0,n.DEPTH_COMPONENT,e,r,0,n.DEPTH_COMPONENT,n.UNSIGNED_SHORT,null),n.framebufferTexture2D(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.TEXTURE_2D,this._glTexture,0);break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_24_8:s?i.texStorage2D(a,this._mipmapCount,i.DEPTH24_STENCIL8,e,r):n.texImage2D(a,0,n.DEPTH_STENCIL,e,r,0,n.DEPTH_STENCIL,o._webgl_depth_texture.UNSIGNED_INT_24_8_WEBGL,null),n.framebufferTexture2D(n.FRAMEBUFFER,n.DEPTH_STENCIL_ATTACHMENT,n.TEXTURE_2D,this._glTexture,0);break;default:throw"RenderTexture: depth format RenderTexture must use depthFormat with DEPTH_16 and DEPTHSTENCIL_16_8."}s&&l==t.RenderTextureFormat.ShadowMap&&i.texParameteri(a,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)}else if(this._depthStencilFormat!==t.RenderTextureDepthFormat.DEPTHSTENCIL_NONE){switch(this._depthStencilBuffer=n.createRenderbuffer(),n.bindRenderbuffer(n.RENDERBUFFER,this._depthStencilBuffer),this._depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_COMPONENT16,e,r),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,this._depthStencilBuffer);break;case t.RenderTextureDepthFormat.STENCIL_8:n.renderbufferStorage(n.RENDERBUFFER,n.STENCIL_INDEX8,e,r),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.STENCIL_ATTACHMENT,n.RENDERBUFFER,this._depthStencilBuffer);break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_24_8:n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_STENCIL,e,r),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_STENCIL_ATTACHMENT,n.RENDERBUFFER,this._depthStencilBuffer);break;default:throw"RenderTexture: unkonw depth format."}n.bindRenderbuffer(n.RENDERBUFFER,null)}n.bindFramebuffer(n.FRAMEBUFFER,null),this._setWarpMode(n.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(n.TEXTURE_WRAP_T,this._wrapModeV),this._setFilterMode(this._filterMode),this._setAnisotropy(this._anisoLevel),this._readyed=!0,this._activeResource(),this._setGPUMemory(e*r*4)}},{key:"_start",value:function(){var e=t.LayaGL.instance;e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),RenderTexture._currentActive=this,this._isCameraTarget&&(ne._instance.invertY=!0),this._readyed=!1}},{key:"_end",value:function(){var e=t.LayaGL.instance;e.bindFramebuffer(e.FRAMEBUFFER,null),RenderTexture._currentActive=null,this._isCameraTarget&&(ne._instance.invertY=!1),this._readyed=!0}},{key:"getData",value:function(e,r,n,i,a){if(t.Render.isConchApp&&2==window.conchConfig.threadMode)throw"native 2 thread mode use getDataAsync";var o=t.LayaGL.instance;return o.bindFramebuffer(o.FRAMEBUFFER,this._frameBuffer),o.checkFramebufferStatus(o.FRAMEBUFFER)===o.FRAMEBUFFER_COMPLETE?(o.readPixels(e,r,n,i,o.RGBA,o.UNSIGNED_BYTE,a),o.bindFramebuffer(o.FRAMEBUFFER,null),a):(o.bindFramebuffer(o.FRAMEBUFFER,null),null)}},{key:"_disposeResource",value:function(){if(this._frameBuffer){var e=t.LayaGL.instance;e.deleteTexture(this._glTexture),e.deleteFramebuffer(this._frameBuffer),e.deleteRenderbuffer(this._depthStencilBuffer),this._glTexture=null,this._frameBuffer=null,this._depthStencilBuffer=null,this._setGPUMemory(0)}}},{key:"getDataAsync",value:function(e,r,n,i,a){var o=t.LayaGL.instance;o.bindFramebuffer(o.FRAMEBUFFER,this._frameBuffer),o.readPixelsAsync(e,r,n,i,o.RGBA,o.UNSIGNED_BYTE,(function(e){a(new Uint8Array(e))})),o.bindFramebuffer(o.FRAMEBUFFER,null)}},{key:"depthStencilFormat",get:function(){return this._depthStencilFormat}},{key:"defaulteTexture",get:function(){return t.Texture2D.grayTexture}}],[{key:"createFromPool",value:function(e,r){for(var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.RenderTextureFormat.R8G8B8,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.RenderTextureDepthFormat.DEPTH_16,o=0,s=RenderTexture._pool.length;o<s;o++)if((n=RenderTexture._pool[o])._width==e&&n._height==r&&n._format==i&&n._depthStencilFormat==a){n._inPool=!1;var l=RenderTexture._pool[s-1];return RenderTexture._pool[o]=l,RenderTexture._pool.length-=1,n}return(n=new RenderTexture(e,r,i,a)).lock=!0,n}},{key:"recoverToPool",value:function(e){e._inPool||(RenderTexture._pool.push(e),e._inPool=!0)}},{key:"currentActive",get:function(){return RenderTexture._currentActive}}]),RenderTexture}(t.BaseTexture);ie._pool=[];var ae=function(){function DefineDatas(){_classCallCheck(this,DefineDatas),this._mask=[],this._length=0}return _createClass(DefineDatas,[{key:"_intersectionDefineDatas",value:function(e){for(var t=e._mask,r=this._mask,n=this._length-1;n>=0;n--){var i=r[n]&t[n];0==i&&n==this._length-1?this._length--:r[n]=i}}},{key:"add",value:function(e){var t=e._index,r=t+1,n=this._mask,i=this._length;if(i<r){for(n.length<r&&(n.length=r);i<t;i++)n[i]=0;n[t]=e._value,this._length=r}else r>this._length?(n[t]=e._value,this._length=r):n[t]|=e._value}},{key:"remove",value:function(e){var t=e._index,r=this._mask,n=this._length-1;if(!(t>n)){var i=r[t]&~e._value;t==n&&0===i?this._length--:r[t]=i}}},{key:"addDefineDatas",value:function(e){var t=e._mask,r=e._length,n=this._mask,i=this._length;if(i<r){n.length=r;for(var a=0;a<i;a++)n[a]|=t[a];for(;a<r;a++)n[a]=t[a];this._length=r}else{for(a=0;a<r;a++)a<this._length?n[a]|=t[a]:n[a]=t[a];this._length=Math.max(this._length,r)}}},{key:"removeDefineDatas",value:function(e){for(var t=e._mask,r=this._mask,n=this._length-1,i=e._length-1;i>=0;i--)if(!(i>n)){var a=r[i]&~t[i];i==n&&0===a?(n--,this._length--):r[i]=a}}},{key:"has",value:function(e){var t=e._index;return!(t>=this._length)&&0!=(this._mask[t]&e._value)}},{key:"clear",value:function(){this._length=0}},{key:"cloneTo",value:function(e){var t=e,r=t._mask,n=this._mask,i=this._length;r.length=i;for(var a=0;a<i;a++)r[a]=n[a];t._length=i}},{key:"clone",value:function(){var e=new DefineDatas;return this.cloneTo(e),e}}]),DefineDatas}(),oe=function ShaderDefine(e,t){_classCallCheck(this,ShaderDefine),this._index=e,this._value=t},se=function(){function ShaderVariant(e,t,r,n){_classCallCheck(this,ShaderVariant),this._subShaderIndex=0,this._passIndex=0,this.setValue(e,t,r,n)}return _createClass(ShaderVariant,[{key:"setValue",value:function(e,t,r,n){if(!e)throw"ShaderVariantInfo:Shader can't be null.";var i=e.getSubShaderAt(t);if(!i)throw"ShaderVariantInfo:Shader don't have subShaderIndex of ".concat(t,".");var a=i._passes[r];if(!a)throw"ShaderVariantInfo:Shader don't have passIndex of ".concat(r,".");for(var o=a._validDefine,s=0,u=n.length;s<u;s++){var c=n[s];if(!o.has(l.Shader3D.getDefineByName(c)))throw"ShaderVariantInfo:Invalid defineName ".concat(c," in ").concat(e._name," subShaderIndex of ").concat(t," passIndex of ").concat(r,".")}this._shader=e,this._subShaderIndex=t,this._passIndex=r,this._defineNames=n}},{key:"equal",value:function(e){if(this._shader!==e._shader||this._subShaderIndex!==e._subShaderIndex||this._passIndex!==e._passIndex)return!1;var t=this._defineNames,r=e._defineNames;if(t.length!==r.length)return!1;for(var n=0,i=this._defineNames.length;n<i;n++)if(t[n]!==r[n])return!1;return!0}},{key:"clone",value:function(){return new ShaderVariant(this._shader,this._subShaderIndex,this._passIndex,this._defineNames.slice())}},{key:"shader",get:function(){return this._shader}},{key:"subShaderIndex",get:function(){return this._subShaderIndex}},{key:"passIndex",get:function(){return this._passIndex}},{key:"defineNames",get:function(){return this._defineNames}}]),ShaderVariant}(),le=function(){function ShaderVariantCollection(){_classCallCheck(this,ShaderVariantCollection),this._allCompiled=!1,this._variants=[]}return _createClass(ShaderVariantCollection,[{key:"add",value:function(e){for(var t=0,r=this._variants.length;t<r;t++)if(this._variants[t].equal(e))return!1;return this._variants.push(e.clone()),this._allCompiled=!1,!0}},{key:"remove",value:function(e){for(var t=0,r=this._variants.length;t<r;t++)if(this._variants[t].equal(e))return this._variants.splice(t,1),!0;return!1}},{key:"contatins",value:function(e){for(var t=0,r=this._variants.length;t<r;t++)if(this._variants[t].equal(e))return!0;return!1}},{key:"getByIndex",value:function(e){return this._variants[e]}},{key:"clear",value:function(){this._variants.length=0}},{key:"compile",value:function(){if(!this._allCompiled){for(var e=this._variants,t=0,r=e.length;t<r;t++){var n=e[t];l.Shader3D.compileShaderByDefineNames(n._shader._name,n._subShaderIndex,n._passIndex,n._defineNames)}this._allCompiled=!0}}},{key:"allCompiled",get:function(){return this._allCompiled}},{key:"variantCount",get:function(){return this._variants.length}}]),ShaderVariantCollection}(),ue=function(){function Shader3D(e,t,r,n){_classCallCheck(this,Shader3D),this._attributeMap=null,this._uniformMap=null,this._enableInstancing=!1,this._subShaders=[],this._name=e,this._attributeMap=t,this._uniformMap=r,this._enableInstancing=n}return _createClass(Shader3D,[{key:"addSubShader",value:function(e){this._subShaders.push(e),e._owner=this}},{key:"getSubShaderAt",value:function(e){return this._subShaders[e]}},{key:"name",get:function(){return this._name}}],[{key:"_getNamesByDefineData",value:function(e,t){var r=Shader3D._maskMap,n=e._mask;t.length=0;for(var i=0,a=e._length;i<a;i++)for(var o=r[i],s=n[i],l=0;l<32;l++){var u=1<<l;if(s>0&&u>s)break;s&u&&t.push(o[u])}}},{key:"getDefineByName",value:function(e){var t=Shader3D._defineMap[e];if(!t){var r=Shader3D._maskMap,n=Shader3D._defineCounter,i=Math.floor(n/32),a=1<<n%32;t=new oe(i,a),Shader3D._defineMap[e]=t,i==r.length&&(r.length++,r[i]={}),r[i][a]=e,Shader3D._defineCounter++}return t}},{key:"propertyNameToID",value:function(e){if(null!=Shader3D._propertyNameMap[e])return Shader3D._propertyNameMap[e];var t=Shader3D._propertyNameCounter++;return Shader3D._propertyNameMap[e]=t,t}},{key:"getAttributeMapByDefine",value:function(e,t){var r={};for(var n in t)r[n]=t[n];for(var i=0,a=e.length;i<a;i++){switch(e[i]){case"SIMPLEBONE":t.a_Texcoord1&&(r.a_SimpleTextureParams=t.a_Texcoord1,delete r.a_Texcoord1),r.a_SimpleTextureParams=7}}return r}},{key:"addInclude",value:function(e,r){r=r.replace(t.ShaderCompile._clearCR,""),t.ShaderCompile.addInclude(e,r)}},{key:"compileShaderByDefineNames",value:function(e,t,r,n){var i=Shader3D.find(e);if(i){var a=i.getSubShaderAt(t);if(a){var o=a._passes[r];if(o){var s=Shader3D._compileDefineDatas;s.clear();for(var l=0,u=n.length;l<u;l++)s.add(Shader3D.getDefineByName(n[l]));o.withCompile(s)}else console.warn("Shader3D: unknown passIndex.")}else console.warn("Shader3D: unknown subShaderIndex.")}else console.warn("Shader3D: unknown shader name.")}},{key:"add",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return Shader3D._preCompileShader[e]=new Shader3D(e,t,r,n)}},{key:"find",value:function(e){return Shader3D._preCompileShader[e]}},{key:"compileShader",value:function(e,t,r){var n=Shader3D.find(e);if(n){var i=n.getSubShaderAt(t);if(i){var a=i._passes[r];if(a){var o=Shader3D._compileDefineDatas,s=o._mask;s.length=0;for(var l=0,u=arguments.length<=3?0:arguments.length-3;l<u;l++)s.push(l+3<3||arguments.length<=l+3?void 0:arguments[l+3]);o._length=arguments.length<=3?0:arguments.length-3,a.withCompile(o)}else console.warn("Shader3D: unknown passIndex.")}else console.warn("Shader3D: unknown subShaderIndex.")}else console.warn("Shader3D: unknown shader name.")}}]),Shader3D}();ue._compileDefineDatas=new ae,ue.RENDER_STATE_CULL=0,ue.RENDER_STATE_BLEND=1,ue.RENDER_STATE_BLEND_SRC=2,ue.RENDER_STATE_BLEND_DST=3,ue.RENDER_STATE_BLEND_SRC_RGB=4,ue.RENDER_STATE_BLEND_DST_RGB=5,ue.RENDER_STATE_BLEND_SRC_ALPHA=6,ue.RENDER_STATE_BLEND_DST_ALPHA=7,ue.RENDER_STATE_BLEND_CONST_COLOR=8,ue.RENDER_STATE_BLEND_EQUATION=9,ue.RENDER_STATE_BLEND_EQUATION_RGB=10,ue.RENDER_STATE_BLEND_EQUATION_ALPHA=11,ue.RENDER_STATE_DEPTH_TEST=12,ue.RENDER_STATE_DEPTH_WRITE=13,ue.PERIOD_CUSTOM=0,ue.PERIOD_MATERIAL=1,ue.PERIOD_SPRITE=2,ue.PERIOD_CAMERA=3,ue.PERIOD_SCENE=4,ue._propertyNameCounter=0,ue._propertyNameMap={},ue._defineCounter=0,ue._defineMap={},ue._preCompileShader={},ue._maskMap=[],ue.debugMode=!1,ue.debugShaderVariantCollection=new le;var ce=function(){function ShaderData(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;_classCallCheck(this,ShaderData),this._ownerResource=null,this._data=null,this._defineDatas=new ae,this._runtimeCopyValues=[],this._ownerResource=e,this._initData()}return _createClass(ShaderData,[{key:"_initData",value:function(){this._data=new Object}},{key:"getData",value:function(){return this._data}},{key:"addDefine",value:function(e){this._defineDatas.add(e)}},{key:"removeDefine",value:function(e){this._defineDatas.remove(e)}},{key:"hasDefine",value:function(e){return this._defineDatas.has(e)}},{key:"clearDefine",value:function(){this._defineDatas.clear()}},{key:"getBool",value:function(e){return this._data[e]}},{key:"setBool",value:function(e,t){this._data[e]=t}},{key:"getInt",value:function(e){return this._data[e]}},{key:"setInt",value:function(e,t){this._data[e]=t}},{key:"getNumber",value:function(e){return this._data[e]}},{key:"setNumber",value:function(e,t){this._data[e]=t}},{key:"getVector2",value:function(e){return this._data[e]}},{key:"setVector2",value:function(e,t){this._data[e]=t}},{key:"getVector3",value:function(e){return this._data[e]}},{key:"setVector3",value:function(e,t){this._data[e]=t}},{key:"getVector",value:function(e){return this._data[e]}},{key:"setVector",value:function(e,t){this._data[e]=t}},{key:"getQuaternion",value:function(e){return this._data[e]}},{key:"setQuaternion",value:function(e,t){this._data[e]=t}},{key:"getMatrix4x4",value:function(e){return this._data[e]}},{key:"setMatrix4x4",value:function(e,t){this._data[e]=t}},{key:"getBuffer",value:function(e){return this._data[e]}},{key:"setBuffer",value:function(e,t){this._data[e]=t}},{key:"setTexture",value:function(e,t){var r=this._data[e];this._data[e]=t,this._ownerResource&&this._ownerResource.referenceCount>0&&(r&&r._removeReference(),t&&t._addReference())}},{key:"getTexture",value:function(e){return this._data[e]}},{key:"setAttribute",value:function(e,t){this._data[e]=t}},{key:"getAttribute",value:function(e){return this._data[e]}},{key:"getLength",value:function(){return this._data.length}},{key:"setLength",value:function(e){this._data.length=e}},{key:"cloneTo",value:function(e){var r=e,a=r._data;for(var s in this._data){var l=this._data[s];if(null!=l)if("number"==typeof l)a[s]=l;else if("number"==typeof l)a[s]=l;else if("boolean"==typeof l)a[s]=l;else if(l instanceof n){var u=a[s]||(a[s]=new n);l.cloneTo(u),a[s]=u}else if(l instanceof o){var h=a[s]||(a[s]=new o);l.cloneTo(h),a[s]=h}else if(l instanceof i){var _=a[s]||(a[s]=new i);l.cloneTo(_),a[s]=_}else if(l instanceof c){var d=a[s]||(a[s]=new c);l.cloneTo(d),a[s]=d}else l instanceof t.BaseTexture&&(a[s]=l)}this._defineDatas.cloneTo(r._defineDatas)}},{key:"clone",value:function(){var e=new ShaderData;return this.cloneTo(e),e}},{key:"cloneToForNative",value:function(e){var r=e;this._int32Data.length-r._int32Data.length>0&&r.needRenewArrayBufferForNative(this._int32Data.length),r._int32Data.set(this._int32Data,0);var a=r._nativeArray,s=this._nativeArray.length;a.length=s;for(var l=0;l<s;l++){var u=this._nativeArray[l];if(u)if("number"==typeof u)a[l]=u,r.setNumber(l,u);else if("number"==typeof u)a[l]=u,r.setInt(l,u);else if("boolean"==typeof u)a[l]=u,r.setBool(l,u);else if(u instanceof n){var h=a[l]||(a[l]=new n);u.cloneTo(h),a[l]=h,r.setVector2(l,h)}else if(u instanceof o){var _=a[l]||(a[l]=new o);u.cloneTo(_),a[l]=_,r.setVector3(l,_)}else if(u instanceof i){var d=a[l]||(a[l]=new i);u.cloneTo(d),a[l]=d,r.setVector(l,d)}else if(u instanceof c){var f=a[l]||(a[l]=new c);u.cloneTo(f),a[l]=f,r.setMatrix4x4(l,f)}else u instanceof t.BaseTexture&&(a[l]=u,r.setTexture(l,u))}this._defineDatas.cloneTo(r._defineDatas)}},{key:"_initDataForNative",value:function(){this._frameCount=-1,this._runtimeCopyValues.length=0,this._nativeArray=[],this._data=new ArrayBuffer(32),this._int32Data=new Int32Array(this._data),this._float32Data=new Float32Array(this._data),t.LayaGL.instance.createArrayBufferRef(this._data,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0)}},{key:"needRenewArrayBufferForNative",value:function(e){if(e>=this._int32Data.length){var r=4*(e+1),n=this._int32Data,i=this._data.conchRef,a=this._data._ptrID;this._data=new ArrayBuffer(r),this._int32Data=new Int32Array(this._data),this._float32Data=new Float32Array(this._data),this._data.conchRef=i,this._data._ptrID=a,n&&this._int32Data.set(n,0);var o=t.LayaGL.instance;o.updateArrayBufferRef?o.updateArrayBufferRef(this._data._ptrID,i.isSyncToRender(),this._data):window.conch.updateArrayBufferRef(this._data._ptrID,i.isSyncToRender(),this._data)}}},{key:"getDataForNative",value:function(){return this._nativeArray}},{key:"getIntForNative",value:function(e){return this._int32Data[e]}},{key:"setIntForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._int32Data[e]=t,this._nativeArray[e]=t}},{key:"getBoolForNative",value:function(e){return 1==this._int32Data[e]}},{key:"setBoolForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._int32Data[e]=t?1:0,this._nativeArray[e]=t}},{key:"getNumberForNative",value:function(e){return this._float32Data[e]}},{key:"setNumberForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._float32Data[e]=t,this._nativeArray[e]=t}},{key:"getMatrix4x4ForNative",value:function(e){return this._nativeArray[e]}},{key:"setMatrix4x4ForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t;var r=this.setReferenceForNative(t.elements);this._int32Data[e]=r}},{key:"getVectorForNative",value:function(e){return this._nativeArray[e]}},{key:"setVectorForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var r=this.setReferenceForNative(t.elements);this._int32Data[e]=r}},{key:"getVector2ForNative",value:function(e){return this._nativeArray[e]}},{key:"setVector2ForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var r=this.setReferenceForNative(t.elements);this._int32Data[e]=r}},{key:"getVector3ForNative",value:function(e){return this._nativeArray[e]}},{key:"setVector3ForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var r=this.setReferenceForNative(t.elements);this._int32Data[e]=r}},{key:"getQuaternionForNative",value:function(e){return this._nativeArray[e]}},{key:"setQuaternionForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var r=this.setReferenceForNative(t.elements);this._int32Data[e]=r}},{key:"getBufferForNative",value:function(e){return this._nativeArray[e]}},{key:"setBufferForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t;var r=this.setReferenceForNative(t);this._int32Data[e]=r}},{key:"getAttributeForNative",value:function(e){return this._nativeArray[e]}},{key:"setAttributeForNative",value:function(e,r){this._nativeArray[e]=r,r._ptrID||t.LayaGL.instance.createArrayBufferRef(r,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0),t.LayaGL.instance.syncBufferToRenderThread(r),this._int32Data[e]=r._ptrID}},{key:"getTextureForNative",value:function(e){return this._nativeArray[e]}},{key:"setTextureForNative",value:function(e,t){if(t){this.needRenewArrayBufferForNative(e);var r=this._nativeArray[e];this._nativeArray[e]=t;var n=t._getSource()||t.defaulteTexture._getSource();this._int32Data[e]=n.id,this._ownerResource&&this._ownerResource.referenceCount>0&&(r&&r._removeReference(),t&&t._addReference())}}},{key:"setReferenceForNative",value:function(e){this.clearRuntimeCopyArray();var r=0,n=0;return ShaderData._SET_RUNTIME_VALUE_MODE_REFERENCE_?(t.LayaGL.instance.createArrayBufferRefs(e,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0,t.LayaGL.ARRAY_BUFFER_REF_REFERENCE),r=0,n=e.getPtrID(r)):(t.LayaGL.instance.createArrayBufferRefs(e,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0,t.LayaGL.ARRAY_BUFFER_REF_COPY),r=e.getRefNum()-1,n=e.getPtrID(r),this._runtimeCopyValues.push({obj:e,refID:r,ptrID:n})),t.LayaGL.instance.syncBufferToRenderThread(e,r),n}},{key:"clearRuntimeCopyArray",value:function(){var e=t.Stat.loopCount;if(this._frameCount!=e){this._frameCount=e;for(var r=0,n=this._runtimeCopyValues.length;r<n;r++){this._runtimeCopyValues[r].obj.clearRefNum()}this._runtimeCopyValues.length=0}}}],[{key:"setRuntimeValueMode",value:function(e){ShaderData._SET_RUNTIME_VALUE_MODE_REFERENCE_=e}}]),ShaderData}();ce._SET_RUNTIME_VALUE_MODE_REFERENCE_=!0;var he=function(){function PostProcess(){_classCallCheck(this,PostProcess),this._compositeShader=ue.find("PostProcessComposite"),this._compositeShaderData=new ce,this._effects=[],this._context=null,this._context=new re,this._context.compositeShaderData=this._compositeShaderData}return _createClass(PostProcess,[{key:"_init",value:function(e,t){this._context.camera=e,this._context.command=t}},{key:"_render",value:function(){var e=ce._SET_RUNTIME_VALUE_MODE_REFERENCE_;t.ILaya.Render.supportWebGLPlusRendering&&ce.setRuntimeValueMode(!1);var r=this._context.camera,n=r.viewport,i=ie.createFromPool(ne.clientWidth,ne.clientHeight,r._getRenderTextureFormat(),t.RenderTextureDepthFormat.DEPTHSTENCIL_NONE),a=r._internalRenderTexture;this._context.command.clear(),this._context.source=i,this._context.destination=a,this._context.compositeShaderData.clearDefine(),this._context.command.blitScreenTriangle(a,i),this._context.compositeShaderData.setTexture(PostProcess.SHADERVALUE_AUTOEXPOSURETEX,t.Texture2D.whiteTexture);for(var o=0,s=this._effects.length;o<s;o++)this._effects[o].render(this._context);this._compositeShaderData.addDefine(PostProcess.SHADERDEFINE_FINALPASS);var l=r._offScreenRenderTexture,u=l||null;this._context.destination=u;var c=r._getCanvasWidth(),h=r._getCanvasHeight();r._screenOffsetScale.setValue(n.x/c,n.y/h,n.width/c,n.height/h),this._context.command.blitScreenTriangle(this._context.source,u,r._screenOffsetScale,this._compositeShader,this._compositeShaderData),ie.recoverToPool(i);var _=this._context.deferredReleaseTextures;for(o=0,s=_.length;o<s;o++)ie.recoverToPool(_[o]);_.length=0,t.ILaya.Render.supportWebGLPlusRendering&&ce.setRuntimeValueMode(e)}},{key:"addEffect",value:function(e){this._effects.push(e)}},{key:"removeEffect",value:function(e){var t=this._effects.indexOf(e);-1!==t&&this._effects.splice(t,1)}}],[{key:"__init__",value:function(){PostProcess.SHADERDEFINE_BLOOM_LOW=ue.getDefineByName("BLOOM_LOW"),PostProcess.SHADERDEFINE_BLOOM=ue.getDefineByName("BLOOM"),PostProcess.SHADERDEFINE_FINALPASS=ue.getDefineByName("FINALPASS")}}]),PostProcess}();he.SHADERVALUE_MAINTEX=ue.propertyNameToID("u_MainTex"),he.SHADERVALUE_BLOOMTEX=ue.propertyNameToID("u_BloomTex"),he.SHADERVALUE_AUTOEXPOSURETEX=ue.propertyNameToID("u_AutoExposureTex"),he.SHADERVALUE_BLOOM_DIRTTEX=ue.propertyNameToID("u_Bloom_DirtTex"),he.SHADERVALUE_BLOOMTEX_TEXELSIZE=ue.propertyNameToID("u_BloomTex_TexelSize"),he.SHADERVALUE_BLOOM_DIRTTILEOFFSET=ue.propertyNameToID("u_Bloom_DirtTileOffset"),he.SHADERVALUE_BLOOM_SETTINGS=ue.propertyNameToID("u_Bloom_Settings"),he.SHADERVALUE_BLOOM_COLOR=ue.propertyNameToID("u_Bloom_Color");var _e=function(e){function AnimationTransform3D(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return _classCallCheck(this,AnimationTransform3D),(r=_possibleConstructorReturn(this,_getPrototypeOf(AnimationTransform3D).call(this)))._owner=e,r._children=[],r._localMatrix=new Float32Array(16),t.Render.supportWebGLPlusAnimation?(r._localPosition=new K(0,0,0,n),r._localRotation=new J(0,0,0,1,i),r._localScale=new K(0,0,0,a),r._worldMatrix=s):(r._localPosition=new o,r._localRotation=new u,r._localScale=new o,r._worldMatrix=new Float32Array(16)),r._localQuaternionUpdate=!1,r._locaEulerlUpdate=!1,r._localUpdate=!1,r._worldUpdate=!0,r}return _inherits(AnimationTransform3D,e),_createClass(AnimationTransform3D,[{key:"_getlocalMatrix",value:function(){return this._localUpdate&&(P._createAffineTransformationArray(this._localPosition,this._localRotation,this._localScale,this._localMatrix),this._localUpdate=!1),this._localMatrix}},{key:"_onWorldTransform",value:function(){if(!this._worldUpdate){this._worldUpdate=!0,this.event(t.Event.TRANSFORM_CHANGED);for(var e=0,r=this._children.length;e<r;e++)this._children[e]._onWorldTransform()}}},{key:"getWorldMatrix",value:function(){if(!t.Render.supportWebGLPlusAnimation&&this._worldUpdate){if(null!=this._parent)P.matrix4x4MultiplyFFF(this._parent.getWorldMatrix(),this._getlocalMatrix(),this._worldMatrix);else{var e=this._worldMatrix;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1}this._worldUpdate=!1}return t.Render.supportWebGLPlusAnimation&&this._worldUpdate&&(this._worldUpdate=!1),this._worldMatrix}},{key:"setParent",value:function(e){if(this._parent!==e){if(this._parent){var t=this._parent._children,r=t.indexOf(this);t.splice(r,1)}e&&(e._children.push(this),e&&this._onWorldTransform()),this._parent=e}}},{key:"localPosition",get:function(){return this._localPosition},set:function(e){this._localPosition=e,this._localUpdate=!0,this._onWorldTransform()}},{key:"localRotation",get:function(){if(this._localQuaternionUpdate){var e=this._localRotationEuler;u.createFromYawPitchRoll(e.y/AnimationTransform3D._angleToRandin,e.x/AnimationTransform3D._angleToRandin,e.z/AnimationTransform3D._angleToRandin,this._localRotation),this._localQuaternionUpdate=!1}return this._localRotation},set:function(e){this._localRotation=e,this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._localUpdate=!0,this._onWorldTransform()}},{key:"localScale",get:function(){return this._localScale},set:function(e){this._localScale=e,this._localUpdate=!0,this._onWorldTransform()}},{key:"localRotationEuler",get:function(){if(this._locaEulerlUpdate){this._localRotation.getYawPitchRoll(AnimationTransform3D._tempVector3);var e=AnimationTransform3D._tempVector3,t=this._localRotationEuler;t.x=e.y*AnimationTransform3D._angleToRandin,t.y=e.x*AnimationTransform3D._angleToRandin,t.z=e.z*AnimationTransform3D._angleToRandin,this._locaEulerlUpdate=!1}return this._localRotationEuler},set:function(e){this._localRotationEuler=e,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!0,this._localUpdate=!0,this._onWorldTransform()}}]),AnimationTransform3D}(t.EventDispatcher);_e._tempVector3=new o,_e._angleToRandin=180/Math.PI;var de=function(){function AnimationNode(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;_classCallCheck(this,AnimationNode),this._children=[],this.transform=new _e(this,e,t,r,n)}return _createClass(AnimationNode,[{key:"addChild",value:function(e){e._parent=this,e.transform.setParent(this.transform),this._children.push(e)}},{key:"removeChild",value:function(e){var t=this._children.indexOf(e);-1!==t&&this._children.splice(t,1)}},{key:"getChildByName",value:function(e){for(var t=0,r=this._children.length;t<r;t++){var n=this._children[t];if(n.name===e)return n}return null}},{key:"getChildByIndex",value:function(e){return this._children[e]}},{key:"getChildCount",value:function(){return this._children.length}},{key:"cloneTo",value:function(e){var t=e;t.name=this.name;for(var r=0,n=this._children.length;r<n;r++){var i=this._children[r],a=i.clone();t.addChild(a);var o=i.transform,s=a.transform,l=s.localPosition,u=s.localRotation,c=s.localScale;o.localPosition.cloneTo(l),o.localRotation.cloneTo(u),o.localScale.cloneTo(c),s.localPosition=l,s.localRotation=u,s.localScale=c}}},{key:"clone",value:function(){var e=new AnimationNode;return this.cloneTo(e),e}},{key:"_cloneNative",value:function(e,t,r,n,i,a,o){var s=o._nativeCurCloneCount;i[s]=a;var l=new AnimationNode(new Float32Array(e.buffer,3*s*4,3),new Float32Array(t.buffer,4*s*4,4),new Float32Array(r.buffer,3*s*4,3),new Float32Array(n.buffer,16*s*4,16));return l._worldMatrixIndex=s,this._cloneToNative(l,e,t,r,n,i,s,o),l}},{key:"_cloneToNative",value:function(e,t,r,n,i,a,o,s){var l=e;l.name=this.name;for(var u=0,c=this._children.length;u<c;u++){var h=this._children[u];s._nativeCurCloneCount++;var _=h._cloneNative(t,r,n,i,a,o,s);l.addChild(_);var d=h.transform,f=_.transform,m=f.localPosition,T=f.localRotation,p=f.localScale;d.localPosition.cloneTo(m),d.localRotation.cloneTo(T),d.localScale.cloneTo(p),f.localPosition=m,f.localRotation=T,f.localScale=p}}}]),AnimationNode}(),fe=function(e){function Avatar(){var e;return _classCallCheck(this,Avatar),(e=_possibleConstructorReturn(this,_getPrototypeOf(Avatar).call(this)))._nativeNodeCount=0,e._nativeCurCloneCount=0,e}return _inherits(Avatar,e),_createClass(Avatar,[{key:"_initCloneToAnimator",value:function(e,t){t._avatarNodeMap[e.name]=e;for(var r=0,n=e.getChildCount();r<n;r++)this._initCloneToAnimator(e.getChildByIndex(r),t)}},{key:"_parseNode",value:function(e,r){var n=e.props.name;r.name=n;var i=e.props,a=r.transform,o=a.localPosition,s=a.localRotation,l=a.localScale;o.fromArray(i.translate),s.fromArray(i.rotation),l.fromArray(i.scale),a.localPosition=o,a.localRotation=s,a.localScale=l;for(var u=e.child,c=0,h=u.length;c<h;c++){var _=u[c],d=new de(new Float32Array(3),new Float32Array(4),new Float32Array(3),new Float32Array(16));r.addChild(d),t.Render.supportWebGLPlusAnimation&&this._nativeNodeCount++,this._parseNode(_,d)}}},{key:"_cloneDatasToAnimator",value:function(e){var t;t=this._rootNode.clone();var r=this._rootNode.transform,n=t.transform,i=n.localPosition,a=n.localRotation,o=n.localScale;r.localPosition.cloneTo(i),r.localRotation.cloneTo(a),r.localScale.cloneTo(o),n.localPosition=i,n.localRotation=a,n.localScale=o,e._avatarNodeMap={},this._initCloneToAnimator(t,e)}},{key:"cloneTo",value:function(e){var t=e,r=this._rootNode.clone();t._rootNode=r}},{key:"clone",value:function(){var e=new Avatar;return this.cloneTo(e),e}},{key:"_cloneDatasToAnimatorNative",value:function(e){var t=new Float32Array(3*this._nativeNodeCount),r=new Float32Array(4*this._nativeNodeCount),n=new Float32Array(3*this._nativeNodeCount),i=new Float32Array(16*this._nativeNodeCount),a=new Int16Array(this._nativeNodeCount);e._animationNodeLocalPositions=t,e._animationNodeLocalRotations=r,e._animationNodeLocalScales=n,e._animationNodeWorldMatrixs=i,e._animationNodeParentIndices=a,this._nativeCurCloneCount=0;var o=this._rootNode._cloneNative(t,r,n,i,a,-1,this),s=this._rootNode.transform,l=o.transform,u=l.localPosition,c=l.localRotation,h=l.localScale;s.localPosition.cloneTo(u),s.localRotation.cloneTo(c),s.localScale.cloneTo(h),l.localPosition=u,l.localRotation=c,l.localScale=h,e._avatarNodeMap={},this._initCloneToAnimator(o,e)}}],[{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var r=new Avatar;if(r._rootNode=new de(new Float32Array(3),new Float32Array(4),new Float32Array(3),new Float32Array(16)),t.Render.supportWebGLPlusAnimation&&r._nativeNodeCount++,e.version){var n=e.rootNode;n&&r._parseNode(n,r._rootNode)}return r}},{key:"load",value:function(e,r){t.ILaya.loader.create(e,r,null,Avatar.AVATAR)}}]),Avatar}(t.Resource);fe.AVATAR="AVATAR";var me=function(e){function Material(){var e;return _classCallCheck(this,Material),(e=_possibleConstructorReturn(this,_getPrototypeOf(Material).call(this)))._shaderValues=null,e._shaderValues=new ce(_assertThisInitialized(e)),e.renderQueue=Material.RENDERQUEUE_OPAQUE,e._alphaTest=!1,e}return _inherits(Material,e),_createClass(Material,[{key:"_removeTetxureReference",value:function(){var e=this._shaderValues.getData();for(var r in e){var n=e[r];n&&n instanceof t.BaseTexture&&n._removeReference()}}},{key:"_disposeResource",value:function(){this._referenceCount>0&&this._removeTetxureReference(),this._shaderValues=null}},{key:"_addReference",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;_get(_getPrototypeOf(Material.prototype),"_addReference",this).call(this,e);var r=this._shaderValues.getData();for(var n in r){var i=r[n];i&&i instanceof t.BaseTexture&&i._addReference()}}},{key:"_removeReference",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;_get(_getPrototypeOf(Material.prototype),"_removeReference",this).call(this,e),this._removeTetxureReference()}},{key:"setShaderName",value:function(e){if(this._shader=ue.find(e),!this._shader)throw new Error("BaseMaterial: unknown shader name.")}},{key:"cloneTo",value:function(e){var t=e;t.name=this.name,t.renderQueue=this.renderQueue,this._shaderValues.cloneTo(t._shaderValues)}},{key:"clone",value:function(){var e=new Material;return this.cloneTo(e),e}},{key:"shaderData",get:function(){return this._shaderValues}},{key:"alphaTestValue",get:function(){return this._shaderValues.getNumber(Material.ALPHATESTVALUE)},set:function(e){this._shaderValues.setNumber(Material.ALPHATESTVALUE,e)}},{key:"alphaTest",get:function(){return this._alphaTest},set:function(e){this._alphaTest=e,e?this._shaderValues.addDefine(Material.SHADERDEFINE_ALPHATEST):this._shaderValues.removeDefine(Material.SHADERDEFINE_ALPHATEST)}},{key:"_defineDatas",get:function(){return this._shaderValues._defineDatas}}],[{key:"load",value:function(e,r){t.Laya.loader.create(e,r,null,Material.MATERIAL)}},{key:"__initDefine__",value:function(){Material.SHADERDEFINE_ALPHATEST=ue.getDefineByName("ALPHATEST")}},{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var r,a=e,s=a.props,l=s.type,u=t.ClassUtils.getRegClass(l);if(!u)throw"_getSprite3DHierarchyInnerUrls 错误: "+e.type+" 不是类";switch(r=new u,a.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":var c,h;for(var _ in s)switch(_){case"type":break;case"vectors":var d=s[_];for(c=0,h=d.length;c<h;c++){var f=d[c],m=f.value;switch(m.length){case 2:r[f.name]=new n(m[0],m[1]);break;case 3:r[f.name]=new o(m[0],m[1],m[2]);break;case 4:r[f.name]=new i(m[0],m[1],m[2],m[3]);break;default:throw new Error("BaseMaterial:unkonwn color length.")}}break;case"textures":var T=s[_];for(c=0,h=T.length;c<h;c++){var p=T[c],g=p.path;g&&(r[p.name]=t.Loader.getRes(g))}break;case"defines":var E=s[_];for(c=0,h=E.length;c<h;c++){var y=ue.getDefineByName(E[c]);r._shaderValues.addDefine(y)}break;case"renderStates":var S=s[_],v=S[0],R=r;R.blend=v.blend,R.cull=v.cull,R.depthTest=v.depthTest,R.depthWrite=v.depthWrite,R.blendSrc=v.srcBlend,R.blendDst=v.dstBlend;break;case"cull":r.cull=s[_];break;case"blend":r.blend=s[_];break;case"depthWrite":r.depthWrite=s[_];break;case"srcBlend":r.blendSrc=s[_];break;case"dstBlend":r.blendDst=s[_];break;default:r[_]=s[_]}break;default:throw new Error("BaseMaterial:unkonwn version.")}return r}}]),Material}(t.Resource);me.MATERIAL="MATERIAL",me.RENDERQUEUE_OPAQUE=2e3,me.RENDERQUEUE_ALPHATEST=2450,me.RENDERQUEUE_TRANSPARENT=3e3,me.ALPHATESTVALUE=ue.propertyNameToID("u_AlphaTestValue"),me.SHADERDEFINE_ALPHATEST=null;var Te=function(){function BaseMaterial(){_classCallCheck(this,BaseMaterial)}return _createClass(BaseMaterial,null,[{key:"load",value:function(e,r){t.Laya.loader.create(e,r,null,me.MATERIAL)}},{key:"__initDefine__",value:function(){BaseMaterial.SHADERDEFINE_ALPHATEST=me.SHADERDEFINE_ALPHATEST}}]),BaseMaterial}();Te.MATERIAL="MATERIAL",Te.RENDERQUEUE_OPAQUE=2e3,Te.RENDERQUEUE_ALPHATEST=2450,Te.RENDERQUEUE_TRANSPARENT=3e3,Te.ALPHATESTVALUE=ue.propertyNameToID("u_AlphaTestValue"),Te.SHADERDEFINE_ALPHATEST=null;var pe=function(){function RenderState(){_classCallCheck(this,RenderState),this.cull=RenderState.CULL_BACK,this.blend=RenderState.BLEND_DISABLE,this.srcBlend=RenderState.BLENDPARAM_ONE,this.dstBlend=RenderState.BLENDPARAM_ZERO,this.srcBlendRGB=RenderState.BLENDPARAM_ONE,this.dstBlendRGB=RenderState.BLENDPARAM_ZERO,this.srcBlendAlpha=RenderState.BLENDPARAM_ONE,this.dstBlendAlpha=RenderState.BLENDPARAM_ZERO,this.blendConstColor=new i(1,1,1,1),this.blendEquation=RenderState.BLENDEQUATION_ADD,this.blendEquationRGB=RenderState.BLENDEQUATION_ADD,this.blendEquationAlpha=RenderState.BLENDEQUATION_ADD,this.depthTest=RenderState.DEPTHTEST_LEQUAL,this.depthWrite=!0}return _createClass(RenderState,[{key:"cloneTo",value:function(e){var t=e;t.cull=this.cull,t.blend=this.blend,t.srcBlend=this.srcBlend,t.dstBlend=this.dstBlend,t.srcBlendRGB=this.srcBlendRGB,t.dstBlendRGB=this.dstBlendRGB,t.srcBlendAlpha=this.srcBlendAlpha,t.dstBlendAlpha=this.dstBlendAlpha,this.blendConstColor.cloneTo(t.blendConstColor),t.blendEquation=this.blendEquation,t.blendEquationRGB=this.blendEquationRGB,t.blendEquationAlpha=this.blendEquationAlpha,t.depthTest=this.depthTest,t.depthWrite=this.depthWrite}},{key:"clone",value:function(){var e=new RenderState;return this.cloneTo(e),e}}]),RenderState}();pe.CULL_NONE=0,pe.CULL_FRONT=1,pe.CULL_BACK=2,pe.BLEND_DISABLE=0,pe.BLEND_ENABLE_ALL=1,pe.BLEND_ENABLE_SEPERATE=2,pe.BLENDPARAM_ZERO=0,pe.BLENDPARAM_ONE=1,pe.BLENDPARAM_SRC_COLOR=768,pe.BLENDPARAM_ONE_MINUS_SRC_COLOR=769,pe.BLENDPARAM_DST_COLOR=774,pe.BLENDPARAM_ONE_MINUS_DST_COLOR=775,pe.BLENDPARAM_SRC_ALPHA=770,pe.BLENDPARAM_ONE_MINUS_SRC_ALPHA=771,pe.BLENDPARAM_DST_ALPHA=772,pe.BLENDPARAM_ONE_MINUS_DST_ALPHA=773,pe.BLENDPARAM_SRC_ALPHA_SATURATE=776,pe.BLENDEQUATION_ADD=32774,pe.BLENDEQUATION_SUBTRACT=32778,pe.BLENDEQUATION_REVERSE_SUBTRACT=32779,pe.DEPTHTEST_OFF=0,pe.DEPTHTEST_NEVER=512,pe.DEPTHTEST_LESS=513,pe.DEPTHTEST_EQUAL=514,pe.DEPTHTEST_LEQUAL=515,pe.DEPTHTEST_GREATER=516,pe.DEPTHTEST_NOTEQUAL=517,pe.DEPTHTEST_GEQUAL=518,pe.DEPTHTEST_ALWAYS=519;var ge=function(e){function BlinnPhongMaterial(){var e;_classCallCheck(this,BlinnPhongMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(BlinnPhongMaterial).call(this)))._enableVertexColor=!1,e.setShaderName("BLINNPHONG"),e._albedoIntensity=1,e._albedoColor=new i(1,1,1,1);var t=e._shaderValues;return t.setVector(BlinnPhongMaterial.ALBEDOCOLOR,new i(1,1,1,1)),t.setVector(BlinnPhongMaterial.MATERIALSPECULAR,new i(1,1,1,1)),t.setNumber(BlinnPhongMaterial.SHININESS,.078125),t.setNumber(me.ALPHATESTVALUE,.5),t.setVector(BlinnPhongMaterial.TILINGOFFSET,new i(1,1,0,0)),e._enableLighting=!0,e.renderMode=BlinnPhongMaterial.RENDERMODE_OPAQUE,e}return _inherits(BlinnPhongMaterial,e),_createClass(BlinnPhongMaterial,[{key:"clone",value:function(){var e=new BlinnPhongMaterial;return this.cloneTo(e),e}},{key:"cloneTo",value:function(e){_get(_getPrototypeOf(BlinnPhongMaterial.prototype),"cloneTo",this).call(this,e);var t=e;t._enableLighting=this._enableLighting,t._albedoIntensity=this._albedoIntensity,t._enableVertexColor=this._enableVertexColor,this._albedoColor.cloneTo(t._albedoColor)}},{key:"_ColorR",get:function(){return this._albedoColor.x},set:function(e){this._albedoColor.x=e,this.albedoColor=this._albedoColor}},{key:"_ColorG",get:function(){return this._albedoColor.y},set:function(e){this._albedoColor.y=e,this.albedoColor=this._albedoColor}},{key:"_ColorB",get:function(){return this._albedoColor.z},set:function(e){this._albedoColor.z=e,this.albedoColor=this._albedoColor}},{key:"_ColorA",get:function(){return this._albedoColor.w},set:function(e){this._albedoColor.w=e,this.albedoColor=this._albedoColor}},{key:"_Color",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.ALBEDOCOLOR)},set:function(e){this.albedoColor=e}},{key:"_SpecColorR",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).x},set:function(e){this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).x=e}},{key:"_SpecColorG",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).y},set:function(e){this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).y=e}},{key:"_SpecColorB",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).z},set:function(e){this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).z=e}},{key:"_SpecColorA",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).w},set:function(e){this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).w=e}},{key:"_SpecColor",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR)},set:function(e){this.specularColor=e}},{key:"_AlbedoIntensity",get:function(){return this._albedoIntensity},set:function(e){if(this._albedoIntensity!==e){var t=this._shaderValues.getVector(BlinnPhongMaterial.ALBEDOCOLOR);i.scale(this._albedoColor,e,t),this._albedoIntensity=e,this._shaderValues.setVector(BlinnPhongMaterial.ALBEDOCOLOR,t)}}},{key:"_Shininess",get:function(){return this._shaderValues.getNumber(BlinnPhongMaterial.SHININESS)},set:function(e){e=Math.max(0,Math.min(1,e)),this._shaderValues.setNumber(BlinnPhongMaterial.SHININESS,e)}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET).x},set:function(e){var t=this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET);t.x=e,this.tilingOffset=t}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET).y},set:function(e){var t=this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET);t.y=e,this.tilingOffset=t}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET).z},set:function(e){var t=this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET);t.z=e,this.tilingOffset=t}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET).w},set:function(e){var t=this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET);t.w=e,this.tilingOffset=t}},{key:"_MainTex_ST",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET)},set:function(e){this.tilingOffset=e}},{key:"_Cutoff",get:function(){return this.alphaTestValue},set:function(e){this.alphaTestValue=e}},{key:"renderMode",set:function(e){switch(e){case BlinnPhongMaterial.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=me.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=pe.CULL_BACK,this.blend=pe.BLEND_DISABLE,this.depthTest=pe.DEPTHTEST_LESS;break;case BlinnPhongMaterial.RENDERMODE_CUTOUT:this.renderQueue=me.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=pe.CULL_BACK,this.blend=pe.BLEND_DISABLE,this.depthTest=pe.DEPTHTEST_LESS;break;case BlinnPhongMaterial.RENDERMODE_TRANSPARENT:this.renderQueue=me.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=pe.CULL_BACK,this.blend=pe.BLEND_ENABLE_ALL,this.blendSrc=pe.BLENDPARAM_SRC_ALPHA,this.blendDst=pe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=pe.DEPTHTEST_LESS;break;default:throw new Error("Material:renderMode value error.")}}},{key:"enableVertexColor",get:function(){return this._enableVertexColor},set:function(e){this._enableVertexColor=e,e?this._shaderValues.addDefine(BlinnPhongMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR):this._shaderValues.removeDefine(BlinnPhongMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET)},set:function(e){e&&(1!=e.x||1!=e.y||0!=e.z||0!=e.w)?this._shaderValues.addDefine(BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(BlinnPhongMaterial.TILINGOFFSET,e)}},{key:"albedoColorR",get:function(){return this._ColorR},set:function(e){this._ColorR=e}},{key:"albedoColorG",get:function(){return this._ColorG},set:function(e){this._ColorG=e}},{key:"albedoColorB",get:function(){return this._ColorB},set:function(e){this._ColorB=e}},{key:"albedoColorA",get:function(){return this._ColorA},set:function(e){this._ColorA=e}},{key:"albedoColor",get:function(){return this._albedoColor},set:function(e){var t=this._shaderValues.getVector(BlinnPhongMaterial.ALBEDOCOLOR);i.scale(e,this._albedoIntensity,t),this._albedoColor=e,this._shaderValues.setVector(BlinnPhongMaterial.ALBEDOCOLOR,t)}},{key:"albedoIntensity",get:function(){return this._albedoIntensity},set:function(e){this._AlbedoIntensity=e}},{key:"specularColorR",get:function(){return this._SpecColorR},set:function(e){this._SpecColorR=e}},{key:"specularColorG",get:function(){return this._SpecColorG},set:function(e){this._SpecColorG=e}},{key:"specularColorB",get:function(){return this._SpecColorB},set:function(e){this._SpecColorB=e}},{key:"specularColorA",get:function(){return this._SpecColorA},set:function(e){this._SpecColorA=e}},{key:"specularColor",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR)},set:function(e){this._shaderValues.setVector(BlinnPhongMaterial.MATERIALSPECULAR,e)}},{key:"shininess",get:function(){return this._Shininess},set:function(e){this._Shininess=e}},{key:"albedoTexture",get:function(){return this._shaderValues.getTexture(BlinnPhongMaterial.ALBEDOTEXTURE)},set:function(e){e?this._shaderValues.addDefine(BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP):this._shaderValues.removeDefine(BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP),this._shaderValues.setTexture(BlinnPhongMaterial.ALBEDOTEXTURE,e)}},{key:"normalTexture",get:function(){return this._shaderValues.getTexture(BlinnPhongMaterial.NORMALTEXTURE)},set:function(e){e?this._shaderValues.addDefine(BlinnPhongMaterial.SHADERDEFINE_NORMALMAP):this._shaderValues.removeDefine(BlinnPhongMaterial.SHADERDEFINE_NORMALMAP),this._shaderValues.setTexture(BlinnPhongMaterial.NORMALTEXTURE,e)}},{key:"specularTexture",get:function(){return this._shaderValues.getTexture(BlinnPhongMaterial.SPECULARTEXTURE)},set:function(e){e?this._shaderValues.addDefine(BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP):this._shaderValues.removeDefine(BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP),this._shaderValues.setTexture(BlinnPhongMaterial.SPECULARTEXTURE,e)}},{key:"depthWrite",get:function(){return this._shaderValues.getBool(BlinnPhongMaterial.DEPTH_WRITE)},set:function(e){this._shaderValues.setBool(BlinnPhongMaterial.DEPTH_WRITE,e)}},{key:"cull",get:function(){return this._shaderValues.getInt(BlinnPhongMaterial.CULL)},set:function(e){this._shaderValues.setInt(BlinnPhongMaterial.CULL,e)}},{key:"blend",get:function(){return this._shaderValues.getInt(BlinnPhongMaterial.BLEND)},set:function(e){this._shaderValues.setInt(BlinnPhongMaterial.BLEND,e)}},{key:"blendSrc",get:function(){return this._shaderValues.getInt(BlinnPhongMaterial.BLEND_SRC)},set:function(e){this._shaderValues.setInt(BlinnPhongMaterial.BLEND_SRC,e)}},{key:"blendDst",get:function(){return this._shaderValues.getInt(BlinnPhongMaterial.BLEND_DST)},set:function(e){this._shaderValues.setInt(BlinnPhongMaterial.BLEND_DST,e)}},{key:"depthTest",get:function(){return this._shaderValues.getInt(BlinnPhongMaterial.DEPTH_TEST)},set:function(e){this._shaderValues.setInt(BlinnPhongMaterial.DEPTH_TEST,e)}}],[{key:"__initDefine__",value:function(){BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP=ue.getDefineByName("DIFFUSEMAP"),BlinnPhongMaterial.SHADERDEFINE_NORMALMAP=ue.getDefineByName("NORMALMAP"),BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP=ue.getDefineByName("SPECULARMAP"),BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET=ue.getDefineByName("TILINGOFFSET"),BlinnPhongMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR=ue.getDefineByName("ENABLEVERTEXCOLOR")}}]),BlinnPhongMaterial}(me);ge.RENDERMODE_OPAQUE=0,ge.RENDERMODE_CUTOUT=1,ge.RENDERMODE_TRANSPARENT=2,ge.ALBEDOTEXTURE=ue.propertyNameToID("u_DiffuseTexture"),ge.NORMALTEXTURE=ue.propertyNameToID("u_NormalTexture"),ge.SPECULARTEXTURE=ue.propertyNameToID("u_SpecularTexture"),ge.ALBEDOCOLOR=ue.propertyNameToID("u_DiffuseColor"),ge.MATERIALSPECULAR=ue.propertyNameToID("u_MaterialSpecular"),ge.SHININESS=ue.propertyNameToID("u_Shininess"),ge.TILINGOFFSET=ue.propertyNameToID("u_TilingOffset"),ge.CULL=ue.propertyNameToID("s_Cull"),ge.BLEND=ue.propertyNameToID("s_Blend"),ge.BLEND_SRC=ue.propertyNameToID("s_BlendSrc"),ge.BLEND_DST=ue.propertyNameToID("s_BlendDst"),ge.DEPTH_TEST=ue.propertyNameToID("s_DepthTest"),ge.DEPTH_WRITE=ue.propertyNameToID("s_DepthWrite");var Ee=function(e){function EffectMaterial(){var e;return _classCallCheck(this,EffectMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(EffectMaterial).call(this))).setShaderName("Effect"),e._color=new i(1,1,1,1),e._shaderValues.setVector(EffectMaterial.TINTCOLOR,new i(1,1,1,1)),e.renderMode=EffectMaterial.RENDERMODE_ADDTIVE,e}return _inherits(EffectMaterial,e),_createClass(EffectMaterial,[{key:"clone",value:function(){var e=new EffectMaterial;return this.cloneTo(e),e}},{key:"_TintColorR",get:function(){return this._color.x},set:function(e){this._color.x=e,this.color=this._color}},{key:"_TintColorG",get:function(){return this._color.y},set:function(e){this._color.y=e,this.color=this._color}},{key:"_TintColorB",get:function(){return this._color.z},set:function(e){this._color.z=e,this.color=this._color}},{key:"_TintColorA",get:function(){return this._color.w},set:function(e){this._color.w=e,this.color=this._color}},{key:"_TintColor",get:function(){return this._shaderValues.getVector(EffectMaterial.TINTCOLOR)},set:function(e){this.color=e}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(EffectMaterial.TILINGOFFSET).x},set:function(e){var t=this._shaderValues.getVector(EffectMaterial.TILINGOFFSET);t.x=e,this.tilingOffset=t}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(EffectMaterial.TILINGOFFSET).y},set:function(e){var t=this._shaderValues.getVector(EffectMaterial.TILINGOFFSET);t.y=e,this.tilingOffset=t}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(EffectMaterial.TILINGOFFSET).z},set:function(e){var t=this._shaderValues.getVector(EffectMaterial.TILINGOFFSET);t.z=e,this.tilingOffset=t}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(EffectMaterial.TILINGOFFSET).w},set:function(e){var t=this._shaderValues.getVector(EffectMaterial.TILINGOFFSET);t.w=e,this.tilingOffset=t}},{key:"_MainTex_ST",get:function(){return this._shaderValues.getVector(EffectMaterial.TILINGOFFSET)},set:function(e){this.tilingOffset=e}},{key:"renderMode",set:function(e){switch(e){case EffectMaterial.RENDERMODE_ADDTIVE:this.renderQueue=me.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=pe.CULL_NONE,this.blend=pe.BLEND_ENABLE_ALL,this.blendSrc=pe.BLENDPARAM_SRC_ALPHA,this.blendDst=pe.BLENDPARAM_ONE,this.depthTest=pe.DEPTHTEST_LESS,this._shaderValues.addDefine(EffectMaterial.SHADERDEFINE_ADDTIVEFOG);break;case EffectMaterial.RENDERMODE_ALPHABLENDED:this.renderQueue=me.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=pe.CULL_NONE,this.blend=pe.BLEND_ENABLE_ALL,this.blendSrc=pe.BLENDPARAM_SRC_ALPHA,this.blendDst=pe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=pe.DEPTHTEST_LESS,this._shaderValues.removeDefine(EffectMaterial.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("MeshEffectMaterial : renderMode value error.")}}},{key:"colorR",get:function(){return this._TintColorR},set:function(e){this._TintColorR=e}},{key:"colorG",get:function(){return this._TintColorG},set:function(e){this._TintColorG=e}},{key:"colorB",get:function(){return this._TintColorB},set:function(e){this._TintColorB=e}},{key:"colorA",get:function(){return this._TintColorA},set:function(e){this._TintColorA=e}},{key:"color",get:function(){return this._shaderValues.getVector(EffectMaterial.TINTCOLOR)},set:function(e){this._shaderValues.setVector(EffectMaterial.TINTCOLOR,e)}},{key:"texture",get:function(){return this._shaderValues.getTexture(EffectMaterial.MAINTEXTURE)},set:function(e){e?this._shaderValues.addDefine(EffectMaterial.SHADERDEFINE_MAINTEXTURE):this._shaderValues.removeDefine(EffectMaterial.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(EffectMaterial.MAINTEXTURE,e)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(EffectMaterial.TILINGOFFSET)},set:function(e){e&&(1!=e.x||1!=e.y||0!=e.z||0!=e.w)?this._shaderValues.addDefine(EffectMaterial.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(EffectMaterial.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(EffectMaterial.TILINGOFFSET,e)}},{key:"depthWrite",get:function(){return this._shaderValues.getBool(EffectMaterial.DEPTH_WRITE)},set:function(e){this._shaderValues.setBool(EffectMaterial.DEPTH_WRITE,e)}},{key:"cull",get:function(){return this._shaderValues.getInt(EffectMaterial.CULL)},set:function(e){this._shaderValues.setInt(EffectMaterial.CULL,e)}},{key:"blend",get:function(){return this._shaderValues.getInt(EffectMaterial.BLEND)},set:function(e){this._shaderValues.setInt(EffectMaterial.BLEND,e)}},{key:"blendSrc",get:function(){return this._shaderValues.getInt(EffectMaterial.BLEND_SRC)},set:function(e){this._shaderValues.setInt(EffectMaterial.BLEND_SRC,e)}},{key:"blendDst",get:function(){return this._shaderValues.getInt(EffectMaterial.BLEND_DST)},set:function(e){this._shaderValues.setInt(EffectMaterial.BLEND_DST,e)}},{key:"depthTest",get:function(){return this._shaderValues.getInt(EffectMaterial.DEPTH_TEST)},set:function(e){this._shaderValues.setInt(EffectMaterial.DEPTH_TEST,e)}}],[{key:"__initDefine__",value:function(){EffectMaterial.SHADERDEFINE_MAINTEXTURE=ue.getDefineByName("MAINTEXTURE"),EffectMaterial.SHADERDEFINE_TILINGOFFSET=ue.getDefineByName("TILINGOFFSET"),EffectMaterial.SHADERDEFINE_ADDTIVEFOG=ue.getDefineByName("ADDTIVEFOG")}}]),EffectMaterial}(me);Ee.RENDERMODE_ADDTIVE=0,Ee.RENDERMODE_ALPHABLENDED=1,Ee.MAINTEXTURE=ue.propertyNameToID("u_AlbedoTexture"),Ee.TINTCOLOR=ue.propertyNameToID("u_AlbedoColor"),Ee.TILINGOFFSET=ue.propertyNameToID("u_TilingOffset"),Ee.CULL=ue.propertyNameToID("s_Cull"),Ee.BLEND=ue.propertyNameToID("s_Blend"),Ee.BLEND_SRC=ue.propertyNameToID("s_BlendSrc"),Ee.BLEND_DST=ue.propertyNameToID("s_BlendDst"),Ee.DEPTH_TEST=ue.propertyNameToID("s_DepthTest"),Ee.DEPTH_WRITE=ue.propertyNameToID("s_DepthWrite");var ye,Se=function(e){function ExtendTerrainMaterial(){var e;return _classCallCheck(this,ExtendTerrainMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(ExtendTerrainMaterial).call(this)))._enableLighting=!0,e.setShaderName("ExtendTerrain"),e.renderMode=ExtendTerrainMaterial.RENDERMODE_OPAQUE,e}return _inherits(ExtendTerrainMaterial,e),_createClass(ExtendTerrainMaterial,[{key:"_setDetailNum",value:function(e){switch(e){case 1:this._shaderValues.addDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 2:this._shaderValues.addDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 3:this._shaderValues.addDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 4:this._shaderValues.addDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 5:this._shaderValues.addDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4)}}},{key:"clone",value:function(){var e=new ExtendTerrainMaterial;return this.cloneTo(e),e}},{key:"splatAlphaTexture",get:function(){return this._shaderValues.getTexture(ExtendTerrainMaterial.SPLATALPHATEXTURE)},set:function(e){this._shaderValues.setTexture(ExtendTerrainMaterial.SPLATALPHATEXTURE,e)}},{key:"diffuseTexture1",get:function(){return this._shaderValues.getTexture(ExtendTerrainMaterial.DIFFUSETEXTURE1)},set:function(e){this._shaderValues.setTexture(ExtendTerrainMaterial.DIFFUSETEXTURE1,e),this._setDetailNum(1)}},{key:"diffuseTexture2",get:function(){return this._shaderValues.getTexture(ExtendTerrainMaterial.DIFFUSETEXTURE2)},set:function(e){this._shaderValues.setTexture(ExtendTerrainMaterial.DIFFUSETEXTURE2,e),this._setDetailNum(2)}},{key:"diffuseTexture3",get:function(){return this._shaderValues.getTexture(ExtendTerrainMaterial.DIFFUSETEXTURE3)},set:function(e){this._shaderValues.setTexture(ExtendTerrainMaterial.DIFFUSETEXTURE3,e),this._setDetailNum(3)}},{key:"diffuseTexture4",get:function(){return this._shaderValues.getTexture(ExtendTerrainMaterial.DIFFUSETEXTURE4)},set:function(e){this._shaderValues.setTexture(ExtendTerrainMaterial.DIFFUSETEXTURE4,e),this._setDetailNum(4)}},{key:"diffuseTexture5",get:function(){return this._shaderValues.getTexture(ExtendTerrainMaterial.DIFFUSETEXTURE5)},set:function(e){this._shaderValues.setTexture(ExtendTerrainMaterial.DIFFUSETEXTURE5,e),this._setDetailNum(5)}},{key:"diffuseScaleOffset1",set:function(e){this._shaderValues.setVector(ExtendTerrainMaterial.DIFFUSESCALEOFFSET1,e)}},{key:"diffuseScaleOffset2",set:function(e){this._shaderValues.setVector(ExtendTerrainMaterial.DIFFUSESCALEOFFSET2,e)}},{key:"diffuseScaleOffset3",set:function(e){this._shaderValues.setVector(ExtendTerrainMaterial.DIFFUSESCALEOFFSET3,e)}},{key:"diffuseScaleOffset4",set:function(e){this._shaderValues.setVector(ExtendTerrainMaterial.DIFFUSESCALEOFFSET4,e)}},{key:"diffuseScaleOffset5",set:function(e){this._shaderValues.setVector(ExtendTerrainMaterial.DIFFUSESCALEOFFSET5,e)}},{key:"renderMode",set:function(e){switch(e){case ExtendTerrainMaterial.RENDERMODE_OPAQUE:this.renderQueue=me.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=pe.CULL_BACK,this.blend=pe.BLEND_DISABLE,this.depthTest=pe.DEPTHTEST_LESS;break;case ExtendTerrainMaterial.RENDERMODE_TRANSPARENT:this.renderQueue=me.RENDERQUEUE_OPAQUE,this.depthWrite=!1,this.cull=pe.CULL_BACK,this.blend=pe.BLEND_ENABLE_ALL,this.blendSrc=pe.BLENDPARAM_SRC_ALPHA,this.blendDst=pe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=pe.DEPTHTEST_LEQUAL;break;default:throw new Error("ExtendTerrainMaterial:renderMode value error.")}}},{key:"depthWrite",get:function(){return this._shaderValues.getBool(ExtendTerrainMaterial.DEPTH_WRITE)},set:function(e){this._shaderValues.setBool(ExtendTerrainMaterial.DEPTH_WRITE,e)}},{key:"cull",get:function(){return this._shaderValues.getInt(ExtendTerrainMaterial.CULL)},set:function(e){this._shaderValues.setInt(ExtendTerrainMaterial.CULL,e)}},{key:"blend",get:function(){return this._shaderValues.getInt(ExtendTerrainMaterial.BLEND)},set:function(e){this._shaderValues.setInt(ExtendTerrainMaterial.BLEND,e)}},{key:"blendSrc",get:function(){return this._shaderValues.getInt(ExtendTerrainMaterial.BLEND_SRC)},set:function(e){this._shaderValues.setInt(ExtendTerrainMaterial.BLEND_SRC,e)}},{key:"blendDst",get:function(){return this._shaderValues.getInt(ExtendTerrainMaterial.BLEND_DST)},set:function(e){this._shaderValues.setInt(ExtendTerrainMaterial.BLEND_DST,e)}},{key:"depthTest",get:function(){return this._shaderValues.getInt(ExtendTerrainMaterial.DEPTH_TEST)},set:function(e){this._shaderValues.setInt(ExtendTerrainMaterial.DEPTH_TEST,e)}}],[{key:"__initDefine__",value:function(){ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1=ue.getDefineByName("ExtendTerrain_DETAIL_NUM1"),ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2=ue.getDefineByName("ExtendTerrain_DETAIL_NUM2"),ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3=ue.getDefineByName("ExtendTerrain_DETAIL_NUM3"),ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4=ue.getDefineByName("ExtendTerrain_DETAIL_NUM4"),ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5=ue.getDefineByName("ExtendTerrain_DETAIL_NUM5")}}]),ExtendTerrainMaterial}(me);Se.RENDERMODE_OPAQUE=1,Se.RENDERMODE_TRANSPARENT=2,Se.SPLATALPHATEXTURE=ue.propertyNameToID("u_SplatAlphaTexture"),Se.DIFFUSETEXTURE1=ue.propertyNameToID("u_DiffuseTexture1"),Se.DIFFUSETEXTURE2=ue.propertyNameToID("u_DiffuseTexture2"),Se.DIFFUSETEXTURE3=ue.propertyNameToID("u_DiffuseTexture3"),Se.DIFFUSETEXTURE4=ue.propertyNameToID("u_DiffuseTexture4"),Se.DIFFUSETEXTURE5=ue.propertyNameToID("u_DiffuseTexture5"),Se.DIFFUSESCALEOFFSET1=ue.propertyNameToID("u_DiffuseScaleOffset1"),Se.DIFFUSESCALEOFFSET2=ue.propertyNameToID("u_DiffuseScaleOffset2"),Se.DIFFUSESCALEOFFSET3=ue.propertyNameToID("u_DiffuseScaleOffset3"),Se.DIFFUSESCALEOFFSET4=ue.propertyNameToID("u_DiffuseScaleOffset4"),Se.DIFFUSESCALEOFFSET5=ue.propertyNameToID("u_DiffuseScaleOffset5"),Se.CULL=ue.propertyNameToID("s_Cull"),Se.BLEND=ue.propertyNameToID("s_Blend"),Se.BLEND_SRC=ue.propertyNameToID("s_BlendSrc"),Se.BLEND_DST=ue.propertyNameToID("s_BlendDst"),Se.DEPTH_TEST=ue.propertyNameToID("s_DepthTest"),Se.DEPTH_WRITE=ue.propertyNameToID("s_DepthWrite"),(ye=e.PBRRenderMode||(e.PBRRenderMode={}))[ye.Opaque=0]="Opaque",ye[ye.Cutout=1]="Cutout",ye[ye.Fade=2]="Fade",ye[ye.Transparent=3]="Transparent";var ve=function(t){function PBRMaterial(){var t;return _classCallCheck(this,PBRMaterial),(t=_possibleConstructorReturn(this,_getPrototypeOf(PBRMaterial).call(this)))._enableEmission=!1,t._shaderValues.setVector(PBRMaterial.ALBEDOCOLOR,new i(1,1,1,1)),t._shaderValues.setVector(PBRMaterial.EMISSIONCOLOR,new i(1,1,1,1)),t._shaderValues.setNumber(PBRMaterial.SMOOTHNESS,.5),t._shaderValues.setNumber(PBRMaterial.SMOOTHNESSSCALE,1),t._shaderValues.setNumber(PBRMaterial.OCCLUSIONSTRENGTH,1),t._shaderValues.setNumber(PBRMaterial.NORMALSCALE,1),t._shaderValues.setNumber(PBRMaterial.PARALLAXSCALE,.001),t._shaderValues.setNumber(me.ALPHATESTVALUE,.5),t.renderMode=e.PBRRenderMode.Opaque,t}return _inherits(PBRMaterial,t),_createClass(PBRMaterial,[{key:"albedoColor",get:function(){return this._shaderValues.getVector(PBRMaterial.ALBEDOCOLOR)},set:function(e){this._shaderValues.setVector(PBRMaterial.ALBEDOCOLOR,e)}},{key:"albedoTexture",get:function(){return this._shaderValues.getTexture(PBRMaterial.ALBEDOTEXTURE)},set:function(e){e?this._shaderValues.addDefine(PBRMaterial.SHADERDEFINE_ALBEDOTEXTURE):this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(PBRMaterial.ALBEDOTEXTURE,e)}},{key:"normalTexture",get:function(){return this._shaderValues.getTexture(PBRMaterial.NORMALTEXTURE)},set:function(e){e?this._shaderValues.addDefine(PBRMaterial.SHADERDEFINE_NORMALTEXTURE):this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_NORMALTEXTURE),this._shaderValues.setTexture(PBRMaterial.NORMALTEXTURE,e)}},{key:"normalTextureScale",get:function(){return this._shaderValues.getNumber(PBRMaterial.NORMALSCALE)},set:function(e){this._shaderValues.setNumber(PBRMaterial.NORMALSCALE,e)}},{key:"parallaxTexture",get:function(){return this._shaderValues.getTexture(PBRMaterial.PARALLAXTEXTURE)},set:function(e){e?this._shaderValues.addDefine(PBRMaterial.SHADERDEFINE_PARALLAXTEXTURE):this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_PARALLAXTEXTURE),this._shaderValues.setTexture(PBRMaterial.PARALLAXTEXTURE,e)}},{key:"parallaxTextureScale",get:function(){return this._shaderValues.getNumber(PBRMaterial.PARALLAXSCALE)},set:function(e){this._shaderValues.setNumber(PBRMaterial.PARALLAXSCALE,Math.max(.005,Math.min(.08,e)))}},{key:"occlusionTexture",get:function(){return this._shaderValues.getTexture(PBRMaterial.OCCLUSIONTEXTURE)},set:function(e){e?this._shaderValues.addDefine(PBRMaterial.SHADERDEFINE_OCCLUSIONTEXTURE):this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_OCCLUSIONTEXTURE),this._shaderValues.setTexture(PBRMaterial.OCCLUSIONTEXTURE,e)}},{key:"occlusionTextureStrength",get:function(){return this._shaderValues.getNumber(PBRMaterial.OCCLUSIONSTRENGTH)},set:function(e){this._shaderValues.setNumber(PBRMaterial.OCCLUSIONSTRENGTH,Math.max(0,Math.min(1,e)))}},{key:"smoothness",get:function(){return this._shaderValues.getNumber(PBRMaterial.SMOOTHNESS)},set:function(e){this._shaderValues.setNumber(PBRMaterial.SMOOTHNESS,Math.max(0,Math.min(1,e)))}},{key:"smoothnessTextureScale",get:function(){return this._shaderValues.getNumber(PBRMaterial.SMOOTHNESSSCALE)},set:function(e){this._shaderValues.setNumber(PBRMaterial.SMOOTHNESSSCALE,Math.max(0,Math.min(1,e)))}},{key:"enableEmission",get:function(){return this._enableEmission},set:function(e){e?this._shaderValues.addDefine(PBRMaterial.SHADERDEFINE_EMISSION):this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_EMISSION),this._enableEmission=e}},{key:"emissionColor",get:function(){return this._shaderValues.getVector(PBRMaterial.EMISSIONCOLOR)},set:function(e){this._shaderValues.setVector(PBRMaterial.EMISSIONCOLOR,e)}},{key:"emissionTexture",get:function(){return this._shaderValues.getTexture(PBRMaterial.EMISSIONTEXTURE)},set:function(e){e?this._shaderValues.addDefine(PBRMaterial.SHADERDEFINE_EMISSIONTEXTURE):this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_EMISSIONTEXTURE),this._shaderValues.setTexture(PBRMaterial.EMISSIONTEXTURE,e)}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(PBRMaterial.TILINGOFFSET)},set:function(e){e&&(1!=e.x||1!=e.y||0!=e.z||0!=e.w)?this._shaderValues.addDefine(PBRMaterial.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(PBRMaterial.TILINGOFFSET,e)}},{key:"depthWrite",get:function(){return this._shaderValues.getBool(PBRMaterial.DEPTH_WRITE)},set:function(e){this._shaderValues.setBool(PBRMaterial.DEPTH_WRITE,e)}},{key:"cull",get:function(){return this._shaderValues.getInt(PBRMaterial.CULL)},set:function(e){this._shaderValues.setInt(PBRMaterial.CULL,e)}},{key:"blend",get:function(){return this._shaderValues.getInt(PBRMaterial.BLEND)},set:function(e){this._shaderValues.setInt(PBRMaterial.BLEND,e)}},{key:"blendSrc",get:function(){return this._shaderValues.getInt(PBRMaterial.BLEND_SRC)},set:function(e){this._shaderValues.setInt(PBRMaterial.BLEND_SRC,e)}},{key:"blendDst",get:function(){return this._shaderValues.getInt(PBRMaterial.BLEND_DST)},set:function(e){this._shaderValues.setInt(PBRMaterial.BLEND_DST,e)}},{key:"depthTest",get:function(){return this._shaderValues.getInt(PBRMaterial.DEPTH_TEST)},set:function(e){this._shaderValues.setInt(PBRMaterial.DEPTH_TEST,e)}},{key:"renderMode",set:function(t){switch(t){case e.PBRRenderMode.Opaque:this.alphaTest=!1,this.renderQueue=me.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=pe.CULL_BACK,this.blend=pe.BLEND_DISABLE,this.depthTest=pe.DEPTHTEST_LESS,this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_TRANSPARENTBLEND);break;case e.PBRRenderMode.Cutout:this.renderQueue=me.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=pe.CULL_BACK,this.blend=pe.BLEND_DISABLE,this.depthTest=pe.DEPTHTEST_LESS,this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_TRANSPARENTBLEND);break;case e.PBRRenderMode.Fade:this.renderQueue=me.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=pe.CULL_BACK,this.blend=pe.BLEND_ENABLE_ALL,this.blendSrc=pe.BLENDPARAM_SRC_ALPHA,this.blendDst=pe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=pe.DEPTHTEST_LESS,this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_TRANSPARENTBLEND);break;case e.PBRRenderMode.Transparent:this.renderQueue=me.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=pe.CULL_BACK,this.blend=pe.BLEND_ENABLE_ALL,this.blendSrc=pe.BLENDPARAM_ONE,this.blendDst=pe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=pe.DEPTHTEST_LESS,this._shaderValues.addDefine(PBRMaterial.SHADERDEFINE_TRANSPARENTBLEND);break;default:throw new Error("PBRMaterial:unknown renderMode value.")}}},{key:"enableReflection",get:function(){return!0},set:function(e){}}],[{key:"__init__",value:function(){PBRMaterial.SHADERDEFINE_ALBEDOTEXTURE=ue.getDefineByName("ALBEDOTEXTURE"),PBRMaterial.SHADERDEFINE_NORMALTEXTURE=ue.getDefineByName("NORMALTEXTURE"),PBRMaterial.SHADERDEFINE_PARALLAXTEXTURE=ue.getDefineByName("PARALLAXTEXTURE"),PBRMaterial.SHADERDEFINE_OCCLUSIONTEXTURE=ue.getDefineByName("OCCLUSIONTEXTURE"),PBRMaterial.SHADERDEFINE_EMISSION=ue.getDefineByName("EMISSION"),PBRMaterial.SHADERDEFINE_EMISSIONTEXTURE=ue.getDefineByName("EMISSIONTEXTURE"),PBRMaterial.SHADERDEFINE_TILINGOFFSET=ue.getDefineByName("TILINGOFFSET"),PBRMaterial.SHADERDEFINE_TRANSPARENTBLEND=ue.getDefineByName("TRANSPARENTBLEND"),PBRMaterial.SHADERDEFINE_LAYA_PBR_BRDF_HIGH=ue.getDefineByName("LAYA_PBR_BRDF_HIGH"),PBRMaterial.SHADERDEFINE_LAYA_PBR_BRDF_LOW=ue.getDefineByName("LAYA_PBR_BRDF_LOW")}}]),PBRMaterial}(me);ve.ALBEDOTEXTURE=ue.propertyNameToID("u_AlbedoTexture"),ve.ALBEDOCOLOR=ue.propertyNameToID("u_AlbedoColor"),ve.TILINGOFFSET=ue.propertyNameToID("u_TilingOffset"),ve.NORMALTEXTURE=ue.propertyNameToID("u_NormalTexture"),ve.NORMALSCALE=ue.propertyNameToID("u_NormalScale"),ve.SMOOTHNESS=ue.propertyNameToID("u_Smoothness"),ve.SMOOTHNESSSCALE=ue.propertyNameToID("u_SmoothnessScale"),ve.OCCLUSIONTEXTURE=ue.propertyNameToID("u_OcclusionTexture"),ve.OCCLUSIONSTRENGTH=ue.propertyNameToID("u_occlusionStrength"),ve.PARALLAXTEXTURE=ue.propertyNameToID("u_ParallaxTexture"),ve.PARALLAXSCALE=ue.propertyNameToID("u_ParallaxScale"),ve.EMISSIONTEXTURE=ue.propertyNameToID("u_EmissionTexture"),ve.EMISSIONCOLOR=ue.propertyNameToID("u_EmissionColor"),ve.CULL=ue.propertyNameToID("s_Cull"),ve.BLEND=ue.propertyNameToID("s_Blend"),ve.BLEND_SRC=ue.propertyNameToID("s_BlendSrc"),ve.BLEND_DST=ue.propertyNameToID("s_BlendDst"),ve.DEPTH_TEST=ue.propertyNameToID("s_DepthTest"),ve.DEPTH_WRITE=ue.propertyNameToID("s_DepthWrite"),ve.renderQuality=e.PBRRenderQuality.High;var Re=function ShaderVariable(){_classCallCheck(this,ShaderVariable),this.textureID=-1},Ce=function(e){function ShaderInstance(e,t,r,n,i){var a;return _classCallCheck(this,ShaderInstance),(a=_possibleConstructorReturn(this,_getPrototypeOf(ShaderInstance).call(this)))._stateParamsMap=[],a._uploadMark=-1,a._uploadRenderType=-1,a._vs=e,a._ps=t,a._attributeMap=r,a._uniformMap=n,a._shaderPass=i,a._create(),a.lock=!0,a}return _inherits(ShaderInstance,e),_createClass(ShaderInstance,[{key:"_create",value:function(){var e=t.LayaGL.instance;for(var r in this._program=e.createProgram(),this._vshader=this._createShader(e,this._vs,e.VERTEX_SHADER),this._pshader=this._createShader(e,this._ps,e.FRAGMENT_SHADER),e.attachShader(this._program,this._vshader),e.attachShader(this._program,this._pshader),this._attributeMap)e.bindAttribLocation(this._program,this._attributeMap[r],r);if(e.linkProgram(this._program),!t.Render.isConchApp&&ue.debugMode&&!e.getProgramParameter(this._program,e.LINK_STATUS))throw e.getProgramInfoLog(this._program);var n=[],i=[],a=[],o=[],s=[];this._customUniformParamsMap=[];var l,u,c,h=e.getProgramParameter(this._program,e.ACTIVE_UNIFORMS);for(t.WebGLContext.useProgram(e,this._program),this._curActTexIndex=0,u=0;u<h;u++){var _=e.getActiveUniform(this._program,u),d=_.name;(l=new Re).location=e.getUniformLocation(this._program,d),d.indexOf("[0]")>0?(l.name=d=d.substr(0,d.length-3),l.isArray=!0):(l.name=d,l.isArray=!1),l.type=_.type,this._addShaderUnifiormFun(l);var f=this._uniformMap[d];if(null!=f)switch(l.dataOffset=ue.propertyNameToID(d),f){case ue.PERIOD_CUSTOM:s.push(l);break;case ue.PERIOD_MATERIAL:o.push(l);break;case ue.PERIOD_SPRITE:a.push(l);break;case ue.PERIOD_CAMERA:i.push(l);break;case ue.PERIOD_SCENE:n.push(l);break;default:throw new Error("Shader3D: period is unkonw.")}}for(this._sceneUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*n.length*5+4,64,!0),u=0,c=n.length;u<c;u++)this._sceneUniformParamsMap.addShaderUniform(n[u]);for(this._cameraUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*i.length*5+4,64,!0),u=0,c=i.length;u<c;u++)this._cameraUniformParamsMap.addShaderUniform(i[u]);for(this._spriteUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*a.length*5+4,64,!0),u=0,c=a.length;u<c;u++)this._spriteUniformParamsMap.addShaderUniform(a[u]);for(this._materialUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*o.length*5+4,64,!0),u=0,c=o.length;u<c;u++)this._materialUniformParamsMap.addShaderUniform(o[u]);for(this._customUniformParamsMap.length=s.length,u=0,c=s.length;u<c;u++){var m=s[u];this._customUniformParamsMap[m.dataOffset]=m}var T=this._shaderPass._stateMap;for(var p in T)this._stateParamsMap[T[p]]=ue.propertyNameToID(p)}},{key:"_getRenderState",value:function(e,t){var r=this._stateParamsMap[t];return null==r?null:e[r]}},{key:"_disposeResource",value:function(){t.LayaGL.instance.deleteShader(this._vshader),t.LayaGL.instance.deleteShader(this._pshader),t.LayaGL.instance.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._setGPUMemory(0),this._curActTexIndex=0}},{key:"_addShaderUnifiormFun",value:function(e){var r=t.LayaGL.instance;e.caller=this;var n=e.isArray;switch(e.type){case r.BOOL:e.fun=this._uniform1i,e.uploadedValue=new Array(1);break;case r.INT:e.fun=n?this._uniform1iv:this._uniform1i,e.uploadedValue=new Array(1);break;case r.FLOAT:e.fun=n?this._uniform1fv:this._uniform1f,e.uploadedValue=new Array(1);break;case r.FLOAT_VEC2:e.fun=n?this._uniform_vec2v:this._uniform_vec2,e.uploadedValue=new Array(2);break;case r.FLOAT_VEC3:e.fun=n?this._uniform_vec3v:this._uniform_vec3,e.uploadedValue=new Array(3);break;case r.FLOAT_VEC4:e.fun=n?this._uniform_vec4v:this._uniform_vec4,e.uploadedValue=new Array(4);break;case r.FLOAT_MAT2:e.fun=this._uniformMatrix2fv;break;case r.FLOAT_MAT3:e.fun=this._uniformMatrix3fv;break;case r.FLOAT_MAT4:e.fun=n?this._uniformMatrix4fv:this._uniformMatrix4f;break;case r.SAMPLER_2D:case r.SAMPLER_2D_SHADOW:r.uniform1i(e.location,this._curActTexIndex),e.textureID=t.WebGLContext._glTextureIDs[this._curActTexIndex++],e.fun=this._uniform_sampler2D;break;case 35679:r.uniform1i(e.location,this._curActTexIndex),e.textureID=t.WebGLContext._glTextureIDs[this._curActTexIndex++],e.fun=this._uniform_sampler3D;break;case r.SAMPLER_CUBE:r.uniform1i(e.location,this._curActTexIndex),e.textureID=t.WebGLContext._glTextureIDs[this._curActTexIndex++],e.fun=this._uniform_samplerCube;break;default:throw new Error("compile shader err!")}}},{key:"_createShader",value:function(e,t,r){var n=e.createShader(r);if(e.shaderSource(n,t),e.compileShader(n),ue.debugMode&&!e.getShaderParameter(n,e.COMPILE_STATUS))throw e.getShaderInfoLog(n);return n}},{key:"_uniform1f",value:function(e,r){var n=e.uploadedValue;return n[0]!==r?(t.LayaGL.instance.uniform1f(e.location,n[0]=r),1):0}},{key:"_uniform1fv",value:function(e,r){if(r.length<4){var n=e.uploadedValue;return n[0]!==r[0]||n[1]!==r[1]||n[2]!==r[2]||n[3]!==r[3]?(t.LayaGL.instance.uniform1fv(e.location,r),n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],1):0}return t.LayaGL.instance.uniform1fv(e.location,r),1}},{key:"_uniform_vec2",value:function(e,r){var n=e.uploadedValue;return n[0]!==r.x||n[1]!==r.y?(t.LayaGL.instance.uniform2f(e.location,n[0]=r.x,n[1]=r.y),1):0}},{key:"_uniform_vec2v",value:function(e,r){if(r.length<2){var n=e.uploadedValue;return n[0]!==r[0]||n[1]!==r[1]||n[2]!==r[2]||n[3]!==r[3]?(t.LayaGL.instance.uniform2fv(e.location,r),n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],1):0}return t.LayaGL.instance.uniform2fv(e.location,r),1}},{key:"_uniform_vec3",value:function(e,r){var n=e.uploadedValue;return n[0]!==r.x||n[1]!==r.y||n[2]!==r.z?(t.LayaGL.instance.uniform3f(e.location,n[0]=r.x,n[1]=r.y,n[2]=r.z),1):0}},{key:"_uniform_vec3v",value:function(e,r){return t.LayaGL.instance.uniform3fv(e.location,r),1}},{key:"_uniform_vec4",value:function(e,r){var n=e.uploadedValue;return n[0]!==r.x||n[1]!==r.y||n[2]!==r.z||n[3]!==r.w?(t.LayaGL.instance.uniform4f(e.location,n[0]=r.x,n[1]=r.y,n[2]=r.z,n[3]=r.w),1):0}},{key:"_uniform_vec4v",value:function(e,r){return t.LayaGL.instance.uniform4fv(e.location,r),1}},{key:"_uniformMatrix2fv",value:function(e,r){return t.LayaGL.instance.uniformMatrix2fv(e.location,!1,r),1}},{key:"_uniformMatrix3fv",value:function(e,r){return t.LayaGL.instance.uniformMatrix3fv(e.location,!1,r),1}},{key:"_uniformMatrix4f",value:function(e,r){var n=r.elements;return t.LayaGL.instance.uniformMatrix4fv(e.location,!1,n),1}},{key:"_uniformMatrix4fv",value:function(e,r){return t.LayaGL.instance.uniformMatrix4fv(e.location,!1,r),1}},{key:"_uniform1i",value:function(e,r){var n=e.uploadedValue;return n[0]!==r?(t.LayaGL.instance.uniform1i(e.location,n[0]=r),1):0}},{key:"_uniform1iv",value:function(e,r){return t.LayaGL.instance.uniform1iv(e.location,r),1}},{key:"_uniform_ivec2",value:function(e,r){var n=e.uploadedValue;return n[0]!==r[0]||n[1]!==r[1]?(t.LayaGL.instance.uniform2i(e.location,n[0]=r[0],n[1]=r[1]),1):0}},{key:"_uniform_ivec2v",value:function(e,r){return t.LayaGL.instance.uniform2iv(e.location,r),1}},{key:"_uniform_vec3i",value:function(e,r){var n=e.uploadedValue;return n[0]!==r[0]||n[1]!==r[1]||n[2]!==r[2]?(t.LayaGL.instance.uniform3i(e.location,n[0]=r[0],n[1]=r[1],n[2]=r[2]),1):0}},{key:"_uniform_vec3vi",value:function(e,r){return t.LayaGL.instance.uniform3iv(e.location,r),1}},{key:"_uniform_vec4i",value:function(e,r){var n=e.uploadedValue;return n[0]!==r[0]||n[1]!==r[1]||n[2]!==r[2]||n[3]!==r[3]?(t.LayaGL.instance.uniform4i(e.location,n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3]),1):0}},{key:"_uniform_vec4vi",value:function(e,r){return t.LayaGL.instance.uniform4iv(e.location,r),1}},{key:"_uniform_sampler2D",value:function(e,r){var n=r._getSource()||r.defaulteTexture._getSource(),i=t.LayaGL.instance;return t.WebGLContext.activeTexture(i,e.textureID),t.WebGLContext.bindTexture(i,i.TEXTURE_2D,n),0}},{key:"_uniform_sampler3D",value:function(e,r){var n=r._getSource()||r.defaulteTexture._getSource(),i=t.LayaGL.instance;return t.WebGLContext.activeTexture(i,e.textureID),t.WebGLContext.bindTexture(i,WebGL2RenderingContext.TEXTURE_3D,n),0}},{key:"_uniform_samplerCube",value:function(e,r){var n=r._getSource()||r.defaulteTexture._getSource(),i=t.LayaGL.instance;return t.WebGLContext.activeTexture(i,e.textureID),t.WebGLContext.bindTexture(i,i.TEXTURE_CUBE_MAP,n),0}},{key:"bind",value:function(){return t.WebGLContext.useProgram(t.LayaGL.instance,this._program)}},{key:"uploadUniforms",value:function(e,r,n){t.Stat.shaderCall+=t.LayaGLRunner.uploadShaderUniforms(t.LayaGL.instance,e,r,n)}},{key:"uploadRenderStateBlendDepth",value:function(e){var r=t.LayaGL.instance,n=this._shaderPass.renderState,i=e.getData(),a=this._getRenderState(i,ue.RENDER_STATE_DEPTH_WRITE),o=this._getRenderState(i,ue.RENDER_STATE_DEPTH_TEST),s=this._getRenderState(i,ue.RENDER_STATE_BLEND);switch(null==a&&(a=n.depthWrite),null==o&&(o=n.depthTest),null==s&&(s=n.blend),t.WebGLContext.setDepthMask(r,a),o===pe.DEPTHTEST_OFF?t.WebGLContext.setDepthTest(r,!1):(t.WebGLContext.setDepthTest(r,!0),t.WebGLContext.setDepthFunc(r,o)),s){case pe.BLEND_DISABLE:t.WebGLContext.setBlend(r,!1);break;case pe.BLEND_ENABLE_ALL:var l=this._getRenderState(i,ue.RENDER_STATE_BLEND_EQUATION),u=this._getRenderState(i,ue.RENDER_STATE_BLEND_SRC),c=this._getRenderState(i,ue.RENDER_STATE_BLEND_DST);null==l&&(l=n.blendEquation),null==u&&(u=n.srcBlend),null==c&&(c=n.dstBlend),t.WebGLContext.setBlend(r,!0),t.WebGLContext.setBlendEquation(r,l),t.WebGLContext.setBlendFunc(r,u,c);break;case pe.BLEND_ENABLE_SEPERATE:var h=this._getRenderState(i,ue.RENDER_STATE_BLEND_EQUATION_RGB),_=this._getRenderState(i,ue.RENDER_STATE_BLEND_EQUATION_ALPHA),d=this._getRenderState(i,ue.RENDER_STATE_BLEND_SRC_RGB),f=this._getRenderState(i,ue.RENDER_STATE_BLEND_DST_RGB),m=this._getRenderState(i,ue.RENDER_STATE_BLEND_SRC_ALPHA),T=this._getRenderState(i,ue.RENDER_STATE_BLEND_DST_ALPHA);null==h&&(h=n.blendEquationRGB),null==_&&(_=n.blendEquationAlpha),null==d&&(d=n.srcBlendRGB),null==f&&(f=n.dstBlendRGB),null==m&&(m=n.srcBlendAlpha),null==T&&(T=n.dstBlendAlpha),t.WebGLContext.setBlend(r,!0),t.WebGLContext.setBlendEquationSeparate(r,h,_),t.WebGLContext.setBlendFuncSeperate(r,d,f,m,T)}}},{key:"uploadRenderStateFrontFace",value:function(e,r,n){var i,a=t.LayaGL.instance,o=this._shaderPass.renderState,s=e.getData(),l=this._getRenderState(s,ue.RENDER_STATE_CULL);switch(null==l&&(l=o.cull),l){case pe.CULL_NONE:t.WebGLContext.setCullFace(a,!1);break;case pe.CULL_FRONT:t.WebGLContext.setCullFace(a,!0),i=r?n?a.CCW:a.CW:n?a.CW:a.CCW,t.WebGLContext.setFrontFace(a,i);break;case pe.CULL_BACK:t.WebGLContext.setCullFace(a,!0),i=r?n?a.CW:a.CCW:n?a.CCW:a.CW,t.WebGLContext.setFrontFace(a,i)}}},{key:"uploadCustomUniform",value:function(e,r){t.Stat.shaderCall+=t.LayaGLRunner.uploadCustomUniform(t.LayaGL.instance,this._customUniformParamsMap,e,r)}},{key:"_uniformMatrix2fvForNative",value:function(e,r){return t.LayaGL.instance.uniformMatrix2fvEx(e.location,!1,r),1}},{key:"_uniformMatrix3fvForNative",value:function(e,r){return t.LayaGL.instance.uniformMatrix3fvEx(e.location,!1,r),1}},{key:"_uniformMatrix4fvForNative",value:function(e,r){return t.LayaGL.instance.uniformMatrix4fvEx(e.location,!1,r),1}}]),ShaderInstance}(t.Resource),Me=function(e){function SimpleSingletonList(){return _classCallCheck(this,SimpleSingletonList),_possibleConstructorReturn(this,_getPrototypeOf(SimpleSingletonList).call(this))}return _inherits(SimpleSingletonList,e),_createClass(SimpleSingletonList,[{key:"add",value:function(e){if(-1!==e._getIndexInList())throw"SimpleSingletonList:"+e+" has  in  SingletonList.";this._add(e),e._setIndexInList(this.length++)}},{key:"remove",value:function(e){var t=e._getIndexInList();if(this.length--,t!==this.length){var r=this.elements[this.length];this.elements[t]=r,r._setIndexInList(t)}e._setIndexInList(-1)}},{key:"clear",value:function(){for(var e=this.elements,t=0,r=this.length;t<r;t++)e[t]._setIndexInList(-1);this.length=0}}]),SimpleSingletonList}(R),De=function(){function Color(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;_classCallCheck(this,Color),this.r=e,this.g=t,this.b=r,this.a=n}return _createClass(Color,[{key:"toLinear",value:function(e){e.r=Color.gammaToLinearSpace(this.r),e.g=Color.gammaToLinearSpace(this.g),e.b=Color.gammaToLinearSpace(this.b)}},{key:"toGamma",value:function(e){e.r=Color.linearToGammaSpace(this.r),e.g=Color.linearToGammaSpace(this.g),e.b=Color.linearToGammaSpace(this.b)}},{key:"cloneTo",value:function(e){var t=e;t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a}},{key:"clone",value:function(){var e=new Color;return this.cloneTo(e),e}},{key:"forNativeElement",value:function(){}}],[{key:"gammaToLinearSpace",value:function(e){return e<=.04045?e/12.92:e<1?Math.pow((e+.055)/1.055,2.4):Math.pow(e,2.4)}},{key:"linearToGammaSpace",value:function(e){return e<=0?0:e<=.0031308?12.92*e:e<=1?1.055*Math.pow(e,.41666)-.055:Math.pow(e,.41666)}}]),Color}();De.RED=new De(1,0,0,1),De.GREEN=new De(0,1,0,1),De.BLUE=new De(0,0,1,1),De.CYAN=new De(0,1,1,1),De.YELLOW=new De(1,.92,.016,1),De.MAGENTA=new De(1,0,1,1),De.GRAY=new De(.5,.5,.5,1),De.WHITE=new De(1,1,1,1),De.BLACK=new De(0,0,0,1);var xe=function CameraCullInfo(){_classCallCheck(this,CameraCullInfo)},Ae=function ShadowCullInfo(){_classCallCheck(this,ShadowCullInfo)},Ie=function(){function FrustumCulling(){_classCallCheck(this,FrustumCulling)}return _createClass(FrustumCulling,null,[{key:"__init__",value:function(){t.Render.supportWebGLPlusCulling&&(FrustumCulling._cullingBufferLength=0,FrustumCulling._cullingBuffer=new Float32Array(4096))}},{key:"_drawTraversalCullingBound",value:function(e,t){for(var r=e.elements,n=0,i=e.length;n<i;n++){var a=FrustumCulling._tempColor0;a.r=0,a.g=1,a.b=0,a.a=1,P._drawBound(t,r[n].bounds._getBoundBox(),a)}}},{key:"_traversalCulling",value:function(e,r,n,i,a,s,l){for(var u=i.elements,c=e.boundFrustum,h=e.position,_=e.cullingMask,d=t.Stat.loopCount,f=0,m=i.length;f<m;f++){var T=u[f];if((l?T._castShadow&&T._enable:0!=(Math.pow(2,T._owner._layer)&_)&&T._enable)&&(t.Stat.frustumCulling++,!e.useOcclusionCulling||T._needRender(c,n))){T._renderMark=d,T._distanceForSort=o.distance(T.bounds.getCenter(),h);for(var p=T._renderElements,g=0,E=p.length;g<E;g++)p[g]._update(r,n,a,s)}}}},{key:"renderObjectCulling",value:function(e,t,r,n,i,a){var o=t._opaqueQueue,s=t._transparentQueue,l=t._renders;t._clearRenderQueue();var u=t._octree;if(u&&(u.updateMotionObjects(),u.shrinkRootIfPossible(),u.getCollidingWithFrustum(e,r,n,i,a)),FrustumCulling._traversalCulling(e,t,r,l,n,i,a),FrustumCulling.debugFrustumCulling){var c=t._debugTool;c.clear(),u&&(u.drawAllBounds(c),u.drawAllObjects(c)),FrustumCulling._drawTraversalCullingBound(l,c)}var h=o.elements.length;h>0&&o._quickSort(0,h-1),(h=s.elements.length)>0&&s._quickSort(0,h-1)}},{key:"cullingShadow",value:function(e,r,n){var i=r._renders;r._clearRenderQueue();for(var a=r._opaqueQueue,s=e.position,l=e.cullPlaneCount,u=e.cullPlanes,c=(e.cullSphere,e.direction,i.elements),h=t.Stat.loopCount,_=0,d=i.length;_<d;_++){var f=c[_];if(f._castShadow&&f._enable){t.Stat.frustumCulling++;for(var m=f.bounds,T=m.getMin(),p=m.getMax(),g=T.x,E=T.y,y=T.z,S=p.x,v=p.y,R=p.z,C=!0,M=0;M<l;M++){var D=u[M],x=D.normal;if(D.distance+x.x*(x.x<0?g:S)+x.y*(x.y<0?E:v)+x.z*(x.z<0?y:R)<0){C=!1;break}}if(C){f._renderMark=h,f._distanceForSort=o.distance(m.getCenter(),s);for(var A=f._renderElements,I=(M=0,A.length);M<I;M++)A[M]._update(r,n,null,null)}}}return a.elements.length>0}},{key:"cullingSpotShadow",value:function(e,r,n){var i=r._renders;r._clearRenderQueue();for(var a=r._opaqueQueue,s=i.elements,l=t.Stat.loopCount,u=0,c=i.length;u<c;u++){var h=s[u];if(h._castShadow&&h._enable&&h._needRender(e.boundFrustum,n)){var _=h.bounds;h._renderMark=l,h._distanceForSort=o.distance(_.getCenter(),e.position);for(var d=h._renderElements,f=0,m=d.length;f<m;f++)d[f]._update(r,n,null,null)}}return a.elements.length>0}},{key:"renderObjectCullingNative",value:function(e,r,n,i,a,s){var l,u,c,h=r._opaqueQueue,_=r._transparentQueue;r._clearRenderQueue();var d=i.length,f=i.elements;for(l=0;l<d;l++)f[l].bounds,f[l]._updateForNative&&f[l]._updateForNative(n);e.boundFrustum;FrustumCulling.cullingNative(e._boundFrustumBuffer,FrustumCulling._cullingBuffer,r._cullingBufferIndices,d,r._cullingBufferResult);var m=t.Stat.loopCount,T=n.camera._transform.position;for(l=0;l<d;l++){var p=f[l];if(!e.useOcclusionCulling||e._isLayerVisible(p._owner._layer)&&p._enable&&r._cullingBufferResult[l]){p._renderMark=m,p._distanceForSort=o.distance(p.bounds.getCenter(),T);var g=p._renderElements;for(u=0,c=g.length;u<c;u++){g[u]._update(r,n,a,s)}}}var E=h.elements.length;E>0&&h._quickSort(0,E-1),(E=_.elements.length)>0&&_._quickSort(0,E-1)}},{key:"cullingNative",value:function(e,r,n,i,a){return t.LayaGL.instance.culling(e,r,n,i,a)}}]),FrustumCulling}();Ie._tempColor0=new De,Ie._tempVector0=new o,Ie._cameraCullInfo=new xe,Ie._shadowCullInfo=new Ae,Ie.debugFrustumCulling=!1;var Le=function ClusterData(){_classCallCheck(this,ClusterData),this.updateMark=-1,this.pointLightCount=0,this.spotLightCount=0,this.indices=[]},Pe=function(){function Cluster(e,t,r,i){_classCallCheck(this,Cluster),this._updateMark=0,this._depthSliceParam=new n,this._xSlices=e,this._ySlices=t,this._zSlices=r;var a=e*t,o=r*(1+Math.ceil(i/4));this._clusterTexture=P._createFloatTextureBuffer(a,o),this._clusterTexture.lock=!0,this._clusterPixels=new Float32Array(a*o*4);for(var s=new Array(this._zSlices),l=0;l<this._zSlices;l++){s[l]=new Array(this._ySlices);for(var u=0;u<this._ySlices;u++){s[l][u]=new Array(this._xSlices);for(var c=0;c<this._xSlices;c++)s[l][u][c]=new Le}}this._clusterDatas=s}return _createClass(Cluster,[{key:"_insertSpotLightSphere",value:function(e,t,r,n,i){var a=Cluster._tempVector35;a.x=i.x-e.x,a.y=i.y-e.y,a.z=i.z-e.z;var s=o.dot(a,a),l=i.w;if(!(s>l*l))return!1;var u=o.dot(a,t);return!(Math.cos(n)*Math.sqrt(s-u*u)-u*Math.sin(n)>l||u>l+r||u<-l)}},{key:"_placePointLightToClusters",value:function(e,t){for(var r=this._clusterDatas,n=this._updateMark,i=t.zMin,a=t.zMax;i<a;i++)for(var o=t.yMin,s=t.yMax;o<s;o++)for(var l=t.xMin,u=t.xMax;l<u;l++){var c=r[i][o][l];c.updateMark!=n&&(c.pointLightCount=0,c.spotLightCount=0,c.updateMark=n);var h=c.indices,_=c.pointLightCount++;_<h.length?h[_]=e:h.push(e)}}},{key:"_placeSpotLightToClusters",value:function(e,t){for(var r=this._clusterDatas,n=this._updateMark,i=t.zMin,a=t.zMax;i<a;i++)for(var o=t.yMin,s=t.yMax;o<s;o++)for(var l=t.xMin,u=t.xMax;l<u;l++){var c=r[i][o][l];c.updateMark!=n&&(c.pointLightCount=0,c.spotLightCount=0,c.updateMark=n);var h=c.indices,_=c.pointLightCount+c.spotLightCount++;_<h.length?h[_]=e:h.push(e)}}},{key:"_insertConePlane",value:function(e,t,r,n,i){var a=Cluster._tempVector36,s=Cluster._tempVector37;o.cross(i,t,a),o.cross(a,t,s),o.normalize(s,s);var l=r*Math.tan(n),u=e.x+r*t.x+l*s.x,c=e.y+r*t.y+l*s.y,h=e.z+r*t.z+l*s.z;return u*i.x+c*i.y+h*i.z<=0||e.x*i.x+e.y*i.y+e.z*i.z<=0}},{key:"_shrinkSphereLightZPerspective",value:function(e,t,r,n,i){var a=r.z,o=a-n,s=a+n;if(o>t||s<=e)return!1;var l=this._depthSliceParam;return i.zMin=Math.floor(Math.log2(Math.max(o,e))*l.x-l.y),i.zMax=Math.min(Math.ceil(Math.log2(s)*l.x-l.y),this._zSlices),!0}},{key:"_shrinkSpotLightZPerspective",value:function(e,t,r,n,i,a,o){var s=n.x,l=n.y,u=n.z,c=Math.tan(a)*i,h=r.x,_=r.y,d=r.z,f=s-h,m=l-_,T=u-d,p=f*f+m*m+T*T,g=Math.sqrt(1-T*T/p),E=Math.max(Math.min(d,u-g*c),r.z-i),y=Math.min(Math.max(d,u+g*c),r.z+i);if(E>t||y<=e)return!1;var S=this._depthSliceParam;return o.zMin=Math.floor(Math.log2(Math.max(E,e))*S.x-S.y),o.zMax=Math.min(Math.ceil(Math.log2(y)*S.x-S.y),this._zSlices),!0}},{key:"_shrinkSphereLightByBoundOrth",value:function(e,t,r,n,i,a,o){var s=i.z,l=s-a,u=s+a;if(l>n||u<=r)return!1;var c=i.x,h=c-a,_=c+a;if(h>e||_<=-e)return!1;var d=i.y,f=d-a,m=d+a;if(f>t||m<=-t)return!1;var T=this._xSlices,p=this._ySlices,g=this._depthSliceParam,E=2*e/T,y=2*t/p;return o.xMin=Math.max(Math.floor((h+e)/E),0),o.xMax=Math.min(Math.ceil((_+e)/E),T),o.yMin=Math.max(Math.floor((t-m)/y),0),o.yMax=Math.min(Math.ceil((t-f)/y),p),o.zMin=Math.floor(Math.log2(Math.max(l,r))*g.x-g.y),o.zMax=Math.min(Math.ceil(Math.log2(u)*g.x-g.y),this._zSlices),!0}},{key:"_shrinkSpotLightByBoundOrth",value:function(e,t,r,n,i,a,o,s,l){var u=a.x,c=a.y,h=a.z,_=Math.tan(s)*o,d=i.x,f=i.y,m=i.z,T=u-d,p=c-f,g=h-m,E=T*T+p*p+g*g,y=Math.sqrt(1-g*g/E),S=Math.max(Math.min(m,h-y*_),i.z-o),v=Math.min(Math.max(m,h+y*_),i.z+o);if(S>n||v<=r)return!1;var R=Math.sqrt(1-T*T/E),C=Math.max(Math.min(d,u-R*_),i.x-o),M=Math.min(Math.max(d,u+R*_),i.x+o);if(C>e||M<=-e)return!1;var D=Math.sqrt(1-p*p/E),x=Math.max(Math.min(f,c-D*_),i.y-o),A=Math.min(Math.max(f,c+D*_),i.y+o);if(x>t||A<=-t)return!1;var I=this._xSlices,L=this._ySlices,P=this._depthSliceParam,O=2*e/I,N=2*t/L;return l.xMin=Math.max(Math.floor((C+e)/O),0),l.xMax=Math.min(Math.ceil((M+e)/O),I),l.yMin=Math.max(Math.floor((t-A)/N),0),l.yMax=Math.min(Math.ceil((t-x)/N),L),l.zMin=Math.floor(Math.log2(Math.max(S,r))*P.x-P.y),l.zMax=Math.min(Math.ceil(Math.log2(v)*P.x-P.y),this._zSlices),!0}},{key:"_shrinkXYByRadiusPerspective",value:function(e,t,r,n,i){var a,o,s,l,u,c=e.x,h=e.y,_=e.z,d=this._ySlices+1;for(u=0;u<d;u++){if(h*(f=i[u]).y+_*f.z<t){o=Math.max(0,u-1);break}}if(u==d)return!1;for(l=this._ySlices,u=o+1;u<d;u++){if(h*(f=i[u]).y+_*f.z<=-t){l=Math.max(0,u);break}}for(d=this._xSlices+1,u=0;u<d;u++){if(c*(f=n[u]).x+_*f.z<t){a=Math.max(0,u-1);break}}for(s=this._xSlices,u=a+1;u<d;u++){var f;if(c*(f=n[u]).x+_*f.z<=-t){s=Math.max(0,u);break}}return r.xMin=a,r.xMax=s,r.yMin=o,r.yMax=l,!0}},{key:"_shrinkSpotXYByConePerspective",value:function(e,t,r,n,i,a,o){for(var s,l,u,c,h=Cluster._tempVector32,_=i.yMax+1,d=i.yMin+1;d<_;d++)if(this._insertConePlane(e,t,r,n,o[d])){l=Math.max(0,d-1);break}c=i.yMax;for(d=l+1;d<_;d++){var f=o[d];if(h.setValue(0,-f.y,-f.z),!this._insertConePlane(e,t,r,n,h)){c=Math.max(0,d);break}}_=i.xMax+1;for(d=i.xMin+1;d<_;d++)if(this._insertConePlane(e,t,r,n,a[d])){s=Math.max(0,d-1);break}u=i.xMax;for(d=s+1;d<_;d++){f=a[d];if(h.setValue(-f.x,0,-f.z),!this._insertConePlane(e,t,r,n,h)){u=Math.max(0,d);break}}i.xMin=s,i.xMax=u,i.yMin=l,i.yMax=c}},{key:"_updatePointLightPerspective",value:function(e,t,r,n,i,a,s){var l=Cluster._tempLightBound,u=Cluster._tempVector30;o.transformV3ToV3(n._transform.position,r,u),u.z*=-1,this._shrinkSphereLightZPerspective(e,t,u,n.range,l)&&this._shrinkXYByRadiusPerspective(u,n.range,l,a,s)&&this._placePointLightToClusters(i,l)}},{key:"_updateSpotLightPerspective",value:function(e,t,r,n,i,a,s){var l=Cluster._tempLightBound,u=Cluster._tempVector30,c=Cluster._tempVector31,h=Cluster._tempVector34,_=n._transform.position,d=n.range;n._transform.worldMatrix.getForward(c),o.normalize(c,c),o.scale(c,d,h),o.add(_,h,h),o.transformV3ToV3(_,r,u),o.transformV3ToV3(h,r,h),u.z*=-1,h.z*=-1;var f=n.spotAngle/2*Math.PI/180;if(this._shrinkSpotLightZPerspective(e,t,u,h,d,f,l)&&this._shrinkXYByRadiusPerspective(u,d,l,a,s)){var m=Cluster._tempVector33;m.x=h.x-u.x,m.y=h.y-u.y,m.z=h.z-u.z,o.normalize(m,m),this._shrinkSpotXYByConePerspective(u,m,d,f,l,a,s),this._placeSpotLightToClusters(i,l)}}},{key:"_updatePointLightOrth",value:function(e,t,r,n,i,a,s){var l=Cluster._tempLightBound,u=Cluster._tempVector30;o.transformV3ToV3(a._transform.position,i,u),u.z*=-1,this._shrinkSphereLightByBoundOrth(e,t,r,n,u,a.range,l)&&this._placePointLightToClusters(s,l)}},{key:"_updateSpotLightOrth",value:function(e,t,r,n,i,a,s){var l=Cluster._tempLightBound,u=Cluster._tempVector30,c=Cluster._tempVector31,h=Cluster._tempVector34,_=a._transform.position,d=a.range;a._transform.worldMatrix.getForward(c),o.normalize(c,c),o.scale(c,d,h),o.add(_,h,h),o.transformV3ToV3(_,i,u),o.transformV3ToV3(h,i,h),u.z*=-1,h.z*=-1;var f=a.spotAngle/2*Math.PI/180;this._shrinkSpotLightByBoundOrth(e,t,r,n,u,h,d,f,l)&&this._placeSpotLightToClusters(s,l)}},{key:"update",value:function(e,t){this._updateMark++;var r=e.nearPlane;this._depthSliceParam.x=w._config.lightClusterCount.z/Math.log2(e.farPlane/r),this._depthSliceParam.y=Math.log2(r)*this._depthSliceParam.x;var n=e.nearPlane,i=e.farPlane,a=e.viewMatrix,o=t._directionLights._length,s=t._pointLights,l=s._length,u=s._elements,c=t._spotLights,h=c._length,_=c._elements;if(e.orthographic){for(var d=e.orthographicVerticalSize/2,f=d*e.aspectRatio,m=0;m<l;m++,o++)this._updatePointLightOrth(f,d,n,i,a,u[m],o);for(m=0;m<h;m++,o++)this._updateSpotLightOrth(f,d,n,i,a,_[m],o)}else{e._updateClusterPlaneXY();var T=e._clusterXPlanes,p=e._clusterYPlanes;for(m=0;m<l;m++,o++)this._updatePointLightPerspective(n,i,a,u[m],o,T,p);for(m=0;m<h;m++,o++)this._updateSpotLightPerspective(n,i,a,_[m],o,T,p)}if(l+h>0){for(var g=this._xSlices,E=this._ySlices,y=this._zSlices,S=g*E*4,v=S*y,R=this._clusterPixels,C=R.length,M=this._clusterDatas,D=this._updateMark,x=!0,A=0;A<y;A++)for(var I=0;I<E;I++)for(var L=0;L<g;L++){var P=M[A][I][L],O=4*(L+I*g+A*g*E);if(P.updateMark!==D)R[O]=0,R[O+1]=0;else if(x){var N=P.indices,b=P.pointLightCount,k=P.spotLightCount,B=b+k;if(v+B<C){R[O]=b,R[O+1]=k,R[O+2]=Math.floor(v/S),R[O+3]=v%S;for(m=0;m<B;m++)R[v++]=N[m]}else{B=C-(v+B),b=Math.min(b,B),R[O]=b,R[O+1]=Math.min(k,B-b),R[O+2]=Math.floor(v/S),R[O+3]=v%S;for(m=0;m<B;m++)R[v++]=N[m];x=!1}}}var V=this._clusterTexture.width;this._clusterTexture.setSubPixels(0,0,V,Math.ceil(v/(4*V)),R)}}}]),Cluster}();Pe._tempVector30=new o,Pe._tempVector31=new o,Pe._tempVector32=new o,Pe._tempVector33=new o,Pe._tempVector34=new o,Pe._tempVector35=new o,Pe._tempVector36=new o,Pe._tempVector37=new o,Pe._tempLightBound=new function LightBound(){_classCallCheck(this,LightBound)};var Oe=function(){function SphericalHarmonicsL2(){_classCallCheck(this,SphericalHarmonicsL2),this._coefficients=new Float32Array(27)}return _createClass(SphericalHarmonicsL2,[{key:"getCoefficient",value:function(e,t){return this._coefficients[9*e+t]}},{key:"setCoefficient",value:function(e,t,r){this._coefficients[9*e+t]=r}},{key:"setCoefficients",value:function(e,t,r,n,i,a,o,s,l,u){var c=9*e;this._coefficients[c]=t,this._coefficients[++c]=r,this._coefficients[++c]=n,this._coefficients[++c]=i,this._coefficients[++c]=a,this._coefficients[++c]=o,this._coefficients[++c]=s,this._coefficients[++c]=l,this._coefficients[++c]=u}},{key:"cloneTo",value:function(e){if(this!==e)for(var t=this._coefficients,r=e._coefficients,n=0;n<27;n++)r[n]=t[n]}}]),SphericalHarmonicsL2}();Oe._default=new Oe;var Ne=function MouseTouch(){_classCallCheck(this,MouseTouch),this._pressedSprite=null,this._pressedLoopCount=-1,this.sprite=null,this.mousePositionX=0,this.mousePositionY=0},be=function(){function Touch(){_classCallCheck(this,Touch),this._indexInList=-1,this._identifier=-1,this._position=new n}return _createClass(Touch,[{key:"_getIndexInList",value:function(){return this._indexInList}},{key:"_setIndexInList",value:function(e){this._indexInList=e}},{key:"identifier",get:function(){return this._identifier}},{key:"position",get:function(){return this._position}}]),Touch}(),ke=function(){function Plane(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;_classCallCheck(this,Plane),this.normal=e,this.distance=t}return _createClass(Plane,[{key:"normalize",value:function(){var e=this.normal.x,t=this.normal.y,r=this.normal.z,n=1/Math.sqrt(e*e+t*t+r*r);this.normal.x=e*n,this.normal.y=t*n,this.normal.z=r*n,this.distance*=n}},{key:"cloneTo",value:function(e){var t=e;this.normal.cloneTo(t.normal),t.distance=this.distance}},{key:"clone",value:function(){var e=new Plane(new o);return this.cloneTo(e),e}}],[{key:"createPlaneBy3P",value:function(e,t,r,n){var i=t.x-e.x,a=t.y-e.y,o=t.z-e.z,s=r.x-e.x,l=r.y-e.y,u=r.z-e.z,c=a*u-o*l,h=o*s-i*u,_=i*l-a*s,d=1/Math.sqrt(c*c+h*h+_*_),f=c*d,m=h*d,T=_*d,p=n.normal;p.x=f,p.y=m,p.z=T,n.distance=-(f*e.x+m*e.y+T*e.z)}}]),Plane}();ke.PlaneIntersectionType_Back=0,ke.PlaneIntersectionType_Front=1,ke.PlaneIntersectionType_Intersecting=2;var we=function Ray(e,t){_classCallCheck(this,Ray),this.origin=e,this.direction=t},Be=function ContainmentType(){_classCallCheck(this,ContainmentType)};Be.Disjoint=0,Be.Contains=1,Be.Intersects=2;var Ve,Fe=function(){function CollisionUtils(){_classCallCheck(this,CollisionUtils)}return _createClass(CollisionUtils,null,[{key:"distancePlaneToPoint",value:function(e,t){return o.dot(e.normal,t)-e.distance}},{key:"distanceBoxToPoint",value:function(e,t){var r=e.min,n=r.x,i=r.y,a=r.z,o=e.max,s=o.x,l=o.y,u=o.z,c=t.x,h=t.y,_=t.z,d=0;return c<n&&(d+=(n-c)*(n-c)),c>s&&(d+=(s-c)*(s-c)),h<i&&(d+=(i-h)*(i-h)),h>l&&(d+=(l-h)*(l-h)),_<a&&(d+=(a-_)*(a-_)),_>u&&(d+=(u-_)*(u-_)),Math.sqrt(d)}},{key:"distanceBoxToBox",value:function(e,t){var r,n=e.min,i=n.x,a=n.y,o=n.z,s=e.max,l=s.x,u=s.y,c=s.z,h=t.min,_=h.x,d=h.y,f=h.z,m=t.max,T=m.x,p=m.y,g=m.z,E=0;return i>T?E+=(r=i-T)*r:_>l&&(E+=(r=_-l)*r),a>p?E+=(r=a-p)*r:d>u&&(E+=(r=d-u)*r),o>g?E+=(r=o-g)*r:f>c&&(E+=(r=f-c)*r),Math.sqrt(E)}},{key:"distanceSphereToPoint",value:function(e,t){var r=Math.sqrt(o.distanceSquared(e.center,t));return r-=e.radius,Math.max(r,0)}},{key:"distanceSphereToSphere",value:function(e,t){var r=Math.sqrt(o.distanceSquared(e.center,t.center));return r-=e.radius+t.radius,Math.max(r,0)}},{key:"intersectsRayAndTriangleRD",value:function(e,t,n,i,a){var o=e.origin,s=o.x,l=o.y,u=o.z,c=e.direction,h=c.x,_=c.y,d=c.z,f=t.x,m=t.y,T=t.z,p=n.x,g=n.y,E=n.z,y=i.x,S=i.y,v=i.z,R=CollisionUtils._tempV30.x,C=CollisionUtils._tempV30.y,M=CollisionUtils._tempV30.z;R=p-f,C=g-m,M=E-T;var D=CollisionUtils._tempV31.x,x=CollisionUtils._tempV31.y,A=CollisionUtils._tempV31.z;D=y-f,x=S-m,A=v-T;var I=CollisionUtils._tempV32.x,L=CollisionUtils._tempV32.y,P=CollisionUtils._tempV32.z,O=R*(I=_*A-d*x)+C*(L=d*D-h*A)+M*(P=h*x-_*D);if(r.isZero(O))return!1;var N=1/O,b=CollisionUtils._tempV33.x,k=CollisionUtils._tempV33.y,w=CollisionUtils._tempV33.z,B=(b=s-f)*I+(k=l-m)*L+(w=u-T)*P;if((B*=N)<0||B>1)return!1;var V=CollisionUtils._tempV34.x,F=CollisionUtils._tempV34.y,U=CollisionUtils._tempV34.z,G=h*(V=k*M-w*C)+_*(F=w*R-b*M)+d*(U=b*C-k*R);if((G*=N)<0||B+G>1)return!1;var z=D*V+x*F+A*U;return!((z*=N)<0)}},{key:"intersectsRayAndTriangleRP",value:function(e,t,r,n,i){return CollisionUtils.intersectsRayAndTriangleRD(e,t,r,n,void 0)?(o.scale(e.direction,void 0,CollisionUtils._tempV30),o.add(e.origin,CollisionUtils._tempV30,i),!0):(i=o._ZERO,!1)}},{key:"intersectsRayAndPoint",value:function(e,t){o.subtract(e.origin,t,CollisionUtils._tempV30);var n=o.dot(CollisionUtils._tempV30,e.direction),i=o.dot(CollisionUtils._tempV30,CollisionUtils._tempV30)-r.zeroTolerance;return!(i>0&&n>0)&&!(n*n-i<0)}},{key:"intersectsRayAndRay",value:function(e,t,n){var i=e.origin,a=i.x,s=i.y,l=i.z,u=e.direction,c=u.x,h=u.y,_=u.z,d=t.origin,f=d.x,m=d.y,T=d.z,p=t.direction,g=p.x,E=p.y,y=p.z;o.cross(u,p,CollisionUtils._tempV30);var S=CollisionUtils._tempV30,v=o.scalarLength(CollisionUtils._tempV30);if(r.isZero(v)&&r.nearEqual(f,a)&&r.nearEqual(m,s)&&r.nearEqual(T,l))return!0;v*=v;var R=f-a,C=m-s,M=T-l,D=g,x=E,A=y,I=S.x,L=S.y,P=S.z,O=R*x*P+C*A*I+M*D*L-R*A*L-C*D*P-M*x*I;D=c,x=h,A=_;var N=O/v;o.scale(u,N,CollisionUtils._tempV30),o.scale(p,N,CollisionUtils._tempV31),o.add(i,CollisionUtils._tempV30,CollisionUtils._tempV32),o.add(d,CollisionUtils._tempV31,CollisionUtils._tempV33);var b=CollisionUtils._tempV32,k=CollisionUtils._tempV33;return!!(r.nearEqual(k.x,b.x)&&r.nearEqual(k.y,b.y)&&r.nearEqual(k.z,b.z))}},{key:"intersectsPlaneAndTriangle",value:function(e,t,r,n){var i=CollisionUtils.intersectsPlaneAndPoint(e,t),a=CollisionUtils.intersectsPlaneAndPoint(e,r),o=CollisionUtils.intersectsPlaneAndPoint(e,n);return i==ke.PlaneIntersectionType_Front&&a==ke.PlaneIntersectionType_Front&&o==ke.PlaneIntersectionType_Front?ke.PlaneIntersectionType_Front:i==ke.PlaneIntersectionType_Back&&a==ke.PlaneIntersectionType_Back&&o==ke.PlaneIntersectionType_Back?ke.PlaneIntersectionType_Back:ke.PlaneIntersectionType_Intersecting}},{key:"intersectsRayAndPlaneRD",value:function(e,t){var n=t.normal,i=o.dot(n,e.direction);if(Math.abs(i)<r.zeroTolerance)return-1;var a=o.dot(n,e.origin),s=(-t.distance-a)/i;if(s<0){if(s<-r.zeroTolerance)return-1;s=0}return s}},{key:"intersectsRayAndPlaneRP",value:function(e,t,r){var n=CollisionUtils.intersectsRayAndPlaneRD(e,t);if(-1==n)return r.setValue(0,0,0),!1;var i=CollisionUtils._tempV30;return o.scale(e.direction,n,i),o.add(e.origin,i,r),!0}},{key:"intersectsRayAndBoxRD",value:function(e,t){var n=e.origin,i=n.x,a=n.y,o=n.z,s=e.direction,l=s.x,u=s.y,c=s.z,h=t.min,_=h.x,d=h.y,f=h.z,m=t.max,T=m.x,p=m.y,g=m.z,E=0,y=r.MaxValue;if(r.isZero(l)){if(i<_||i>T)return-1}else{var S=1/l,v=(_-i)*S,R=(T-i)*S;if(v>R){var C=v;v=R,R=C}if((E=Math.max(v,E))>(y=Math.min(R,y)))return-1}if(r.isZero(u)){if(a<d||a>p)return-1}else{var M=1/u,D=(d-a)*M,x=(p-a)*M;if(D>x){var A=D;D=x,x=A}if((E=Math.max(D,E))>(y=Math.min(x,y)))return-1}if(r.isZero(c)){if(o<f||o>g)return-1}else{var I=1/c,L=(f-o)*I,P=(g-o)*I;if(L>P){var O=L;L=P,P=O}if((E=Math.max(L,E))>(y=Math.min(P,y)))return-1}return E}},{key:"intersectsRayAndBoxRP",value:function(e,t,r){var n=CollisionUtils.intersectsRayAndBoxRD(e,t);return-1===n?(o._ZERO.cloneTo(r),n):(o.scale(e.direction,n,CollisionUtils._tempV30),o.add(e.origin,CollisionUtils._tempV30,CollisionUtils._tempV31),CollisionUtils._tempV31.cloneTo(r),n)}},{key:"intersectsRayAndSphereRD",value:function(e,t){var r=t.radius;o.subtract(e.origin,t.center,CollisionUtils._tempV30);var n=o.dot(CollisionUtils._tempV30,e.direction),i=o.dot(CollisionUtils._tempV30,CollisionUtils._tempV30)-r*r;if(i>0&&n>0)return-1;var a=n*n-i;if(a<0)return-1;var s=-n-Math.sqrt(a);return s<0&&(s=0),s}},{key:"intersectsRayAndSphereRP",value:function(e,t,r){var n=CollisionUtils.intersectsRayAndSphereRD(e,t);return-1===n?(o._ZERO.cloneTo(r),n):(o.scale(e.direction,n,CollisionUtils._tempV30),o.add(e.origin,CollisionUtils._tempV30,CollisionUtils._tempV31),CollisionUtils._tempV31.cloneTo(r),n)}},{key:"intersectsSphereAndTriangle",value:function(e,t,r,n){var i=e.center,a=e.radius;return CollisionUtils.closestPointPointTriangle(i,t,r,n,CollisionUtils._tempV30),o.subtract(CollisionUtils._tempV30,i,CollisionUtils._tempV31),o.dot(CollisionUtils._tempV31,CollisionUtils._tempV31)<=a*a}},{key:"intersectsPlaneAndPoint",value:function(e,t){var r=o.dot(e.normal,t)+e.distance;return r>0?ke.PlaneIntersectionType_Front:r<0?ke.PlaneIntersectionType_Back:ke.PlaneIntersectionType_Intersecting}},{key:"intersectsPlaneAndPlane",value:function(e,t){o.cross(e.normal,t.normal,CollisionUtils._tempV30);var n=o.dot(CollisionUtils._tempV30,CollisionUtils._tempV30);return!r.isZero(n)}},{key:"intersectsPlaneAndPlaneRL",value:function(e,t,n){var i=e.normal,a=t.normal;o.cross(i,a,CollisionUtils._tempV34);var s=o.dot(CollisionUtils._tempV34,CollisionUtils._tempV34);return!r.isZero(s)&&(o.scale(a,e.distance,CollisionUtils._tempV30),o.scale(i,t.distance,CollisionUtils._tempV31),o.subtract(CollisionUtils._tempV30,CollisionUtils._tempV31,CollisionUtils._tempV32),o.cross(CollisionUtils._tempV32,CollisionUtils._tempV34,CollisionUtils._tempV33),o.normalize(CollisionUtils._tempV34,CollisionUtils._tempV34),!0)}},{key:"intersectsPlaneAndBox",value:function(e,t){var r=e.distance,n=e.normal,i=n.x,a=n.y,s=n.z,l=t.min,u=l.x,c=l.y,h=l.z,_=t.max,d=_.x,f=_.y,m=_.z;CollisionUtils._tempV30.x=i>0?u:d,CollisionUtils._tempV30.y=a>0?c:f,CollisionUtils._tempV30.z=s>0?h:m,CollisionUtils._tempV31.x=i>0?d:u,CollisionUtils._tempV31.y=a>0?f:c,CollisionUtils._tempV31.z=s>0?m:h;var T=o.dot(n,CollisionUtils._tempV30);return T+r>0?ke.PlaneIntersectionType_Front:(T=o.dot(n,CollisionUtils._tempV31))+r<0?ke.PlaneIntersectionType_Back:ke.PlaneIntersectionType_Intersecting}},{key:"intersectsPlaneAndSphere",value:function(e,t){var r=t.radius,n=o.dot(e.normal,t.center)+e.distance;return n>r?ke.PlaneIntersectionType_Front:n<-r?ke.PlaneIntersectionType_Back:ke.PlaneIntersectionType_Intersecting}},{key:"intersectsBoxAndBox",value:function(e,t){var r=e.min,n=e.max,i=t.min,a=t.max;return!(r.x>a.x||i.x>n.x)&&(!(r.y>a.y||i.y>n.y)&&!(r.z>a.z||i.z>n.z))}},{key:"intersectsBoxAndSphere",value:function(e,t){var r=t.center,n=t.radius,i=CollisionUtils._tempV30;return o.Clamp(r,e.min,e.max,i),o.distanceSquared(r,i)<=n*n}},{key:"intersectsSphereAndSphere",value:function(e,t){var r=e.radius+t.radius;return o.distanceSquared(e.center,t.center)<=r*r}},{key:"boxContainsPoint",value:function(e,t){var r=e.min,n=e.max;return r.x<=t.x&&n.x>=t.x&&r.y<=t.y&&n.y>=t.y&&r.z<=t.z&&n.z>=t.z?Be.Contains:Be.Disjoint}},{key:"boxContainsBox",value:function(e,t){var r=e.min,n=r.x,i=r.y,a=r.z,o=e.max,s=o.x,l=o.y,u=o.z,c=t.min,h=c.x,_=c.y,d=c.z,f=t.max,m=f.x,T=f.y,p=f.z;return s<h||n>m?Be.Disjoint:l<_||i>T?Be.Disjoint:u<d||a>p?Be.Disjoint:n<=h&&m<=s&&i<=_&&T<=l&&a<=d&&p<=u?Be.Contains:Be.Intersects}},{key:"boxContainsSphere",value:function(e,t){var r=e.min,n=r.x,i=r.y,a=r.z,s=e.max,l=s.x,u=s.y,c=s.z,h=t.center,_=h.x,d=h.y,f=h.z,m=t.radius;return o.Clamp(h,r,s,CollisionUtils._tempV30),o.distanceSquared(h,CollisionUtils._tempV30)>m*m?Be.Disjoint:n+m<=_&&_<=l-m&&l-n>m&&i+m<=d&&d<=u-m&&u-i>m&&a+m<=f&&f<=c-m&&c-a>m?Be.Contains:Be.Intersects}},{key:"sphereContainsPoint",value:function(e,t){return o.distanceSquared(t,e.center)<=e.radius*e.radius?Be.Contains:Be.Disjoint}},{key:"sphereContainsTriangle",value:function(e,t,r,n){var i=CollisionUtils.sphereContainsPoint(e,t),a=CollisionUtils.sphereContainsPoint(e,r),o=CollisionUtils.sphereContainsPoint(e,n);return i==Be.Contains&&a==Be.Contains&&o==Be.Contains?Be.Contains:CollisionUtils.intersectsSphereAndTriangle(e,t,r,n)?Be.Intersects:Be.Disjoint}},{key:"sphereContainsBox",value:function(e,t){var r=e.center,n=r.x,i=r.y,a=r.z,s=e.radius,l=t.min,u=l.x,c=l.y,h=l.z,_=t.max,d=_.x,f=_.y,m=_.z,T=CollisionUtils._tempV30;T.x,T.y,T.z;if(!CollisionUtils.intersectsBoxAndSphere(t,e))return Be.Disjoint;var p=s*s;return n-u,i-f,a-m,o.scalarLengthSquared(CollisionUtils._tempV30)>p?Be.Intersects:(n-d,i-f,a-m,o.scalarLengthSquared(CollisionUtils._tempV30)>p?Be.Intersects:(n-d,i-c,a-m,o.scalarLengthSquared(CollisionUtils._tempV30)>p?Be.Intersects:(n-u,i-c,a-m,o.scalarLengthSquared(CollisionUtils._tempV30)>p?Be.Intersects:(n-u,i-f,a-h,o.scalarLengthSquared(CollisionUtils._tempV30)>p?Be.Intersects:(n-d,i-f,a-h,o.scalarLengthSquared(CollisionUtils._tempV30)>p?Be.Intersects:(n-d,i-c,a-h,o.scalarLengthSquared(CollisionUtils._tempV30)>p?Be.Intersects:(n-u,i-c,a-h,o.scalarLengthSquared(CollisionUtils._tempV30)>p?Be.Intersects:Be.Contains)))))))}},{key:"sphereContainsSphere",value:function(e,t){var r=e.radius,n=t.radius,i=o.distance(e.center,t.center);return r+n<i?Be.Disjoint:r-n<i?Be.Intersects:Be.Contains}},{key:"closestPointPointTriangle",value:function(e,t,r,n,i){o.subtract(r,t,CollisionUtils._tempV30),o.subtract(n,t,CollisionUtils._tempV31),o.subtract(e,t,CollisionUtils._tempV32),o.subtract(e,r,CollisionUtils._tempV33),o.subtract(e,n,CollisionUtils._tempV34);var a=o.dot(CollisionUtils._tempV30,CollisionUtils._tempV32),s=o.dot(CollisionUtils._tempV31,CollisionUtils._tempV32),l=o.dot(CollisionUtils._tempV30,CollisionUtils._tempV33),u=o.dot(CollisionUtils._tempV31,CollisionUtils._tempV33),c=o.dot(CollisionUtils._tempV30,CollisionUtils._tempV34),h=o.dot(CollisionUtils._tempV31,CollisionUtils._tempV34);if(a<=0&&s<=0)t.cloneTo(i);else if(l>=0&&u<=l)r.cloneTo(i);else{var _=a*u-l*s;if(_<=0&&a>=0&&l<=0){var d=a/(a-l);return o.scale(CollisionUtils._tempV30,d,i),void o.add(t,i,i)}if(h>=0&&c<=h)n.cloneTo(i);else{var f=c*s-a*h;if(f<=0&&s>=0&&h<=0){var m=s/(s-h);return o.scale(CollisionUtils._tempV31,m,i),void o.add(t,i,i)}var T=l*h-c*u;if(T<=0&&u-l>=0&&c-h>=0){var p=(u-l)/(u-l+(c-h));return o.subtract(n,r,i),o.scale(i,p,i),void o.add(r,i,i)}var g=1/(T+f+_),E=f*g,y=_*g;o.scale(CollisionUtils._tempV30,E,CollisionUtils._tempV35),o.scale(CollisionUtils._tempV31,y,CollisionUtils._tempV36),o.add(CollisionUtils._tempV35,CollisionUtils._tempV36,i),o.add(t,i,i)}}}},{key:"closestPointPlanePoint",value:function(e,t,r){var n=e.normal,i=o.dot(n,t)-e.distance;o.scale(n,i,CollisionUtils._tempV30),o.subtract(t,CollisionUtils._tempV30,r)}},{key:"closestPointBoxPoint",value:function(e,t,r){o.max(t,e.min,CollisionUtils._tempV30),o.min(CollisionUtils._tempV30,e.max,r)}},{key:"closestPointSpherePoint",value:function(e,t,r){var n=e.center;o.subtract(t,n,r),o.normalize(r,r),o.scale(r,e.radius,r),o.add(r,n,r)}},{key:"closestPointSphereSphere",value:function(e,t,r){var n=e.center;o.subtract(t.center,n,r),o.normalize(r,r),o.scale(r,e.radius,r),o.add(r,n,r)}}]),CollisionUtils}();Fe._tempV30=new o,Fe._tempV31=new o,Fe._tempV32=new o,Fe._tempV33=new o,Fe._tempV34=new o,Fe._tempV35=new o,Fe._tempV36=new o,(Ve=e.FrustumCorner||(e.FrustumCorner={}))[Ve.FarBottomLeft=0]="FarBottomLeft",Ve[Ve.FarTopLeft=1]="FarTopLeft",Ve[Ve.FarTopRight=2]="FarTopRight",Ve[Ve.FarBottomRight=3]="FarBottomRight",Ve[Ve.nearBottomLeft=4]="nearBottomLeft",Ve[Ve.nearTopLeft=5]="nearTopLeft",Ve[Ve.nearTopRight=6]="nearTopRight",Ve[Ve.nearBottomRight=7]="nearBottomRight",Ve[Ve.unknown=8]="unknown";var Ue=function(){function BoundFrustum(e){_classCallCheck(this,BoundFrustum),this._matrix=e,this._near=new ke(new o),this._far=new ke(new o),this._left=new ke(new o),this._right=new ke(new o),this._top=new ke(new o),this._bottom=new ke(new o),BoundFrustum.getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}return _createClass(BoundFrustum,[{key:"equalsBoundFrustum",value:function(e){return this._matrix.equalsOtherMatrix(e.matrix)}},{key:"equalsObj",value:function(e){if(e instanceof BoundFrustum){var t=e;return this.equalsBoundFrustum(t)}return!1}},{key:"getPlane",value:function(e){switch(e){case 0:return this._near;case 1:return this._far;case 2:return this._left;case 3:return this._right;case 4:return this._top;case 5:return this._bottom;default:return null}}},{key:"getCorners",value:function(t){BoundFrustum.get3PlaneInterPoint(this._near,this._bottom,this._right,t[e.FrustumCorner.nearBottomRight]),BoundFrustum.get3PlaneInterPoint(this._near,this._top,this._right,t[e.FrustumCorner.nearTopRight]),BoundFrustum.get3PlaneInterPoint(this._near,this._top,this._left,t[e.FrustumCorner.nearTopLeft]),BoundFrustum.get3PlaneInterPoint(this._near,this._bottom,this._left,t[e.FrustumCorner.nearBottomLeft]),BoundFrustum.get3PlaneInterPoint(this._far,this._bottom,this._right,t[e.FrustumCorner.FarBottomRight]),BoundFrustum.get3PlaneInterPoint(this._far,this._top,this._right,t[e.FrustumCorner.FarTopRight]),BoundFrustum.get3PlaneInterPoint(this._far,this._top,this._left,t[e.FrustumCorner.FarTopLeft]),BoundFrustum.get3PlaneInterPoint(this._far,this._bottom,this._left,t[e.FrustumCorner.FarBottomLeft])}},{key:"containsPoint",value:function(e){for(var t=ke.PlaneIntersectionType_Front,r=ke.PlaneIntersectionType_Front,n=0;n<6;n++){switch(n){case 0:r=Fe.intersectsPlaneAndPoint(this._near,e);break;case 1:r=Fe.intersectsPlaneAndPoint(this._far,e);break;case 2:r=Fe.intersectsPlaneAndPoint(this._left,e);break;case 3:r=Fe.intersectsPlaneAndPoint(this._right,e);break;case 4:r=Fe.intersectsPlaneAndPoint(this._top,e);break;case 5:r=Fe.intersectsPlaneAndPoint(this._bottom,e)}switch(r){case ke.PlaneIntersectionType_Back:return Be.Disjoint;case ke.PlaneIntersectionType_Intersecting:t=ke.PlaneIntersectionType_Intersecting}}switch(t){case ke.PlaneIntersectionType_Intersecting:return Be.Intersects;default:return Be.Contains}}},{key:"intersects",value:function(e){var t=e.min,r=e.max,n=t.x,i=t.y,a=t.z,o=r.x,s=r.y,l=r.z,u=this._near.normal;if(this._near.distance+u.x*(u.x<0?n:o)+u.y*(u.y<0?i:s)+u.z*(u.z<0?a:l)<0)return!1;var c=this._left.normal;if(this._left.distance+c.x*(c.x<0?n:o)+c.y*(c.y<0?i:s)+c.z*(c.z<0?a:l)<0)return!1;var h=this._right.normal;if(this._right.distance+h.x*(h.x<0?n:o)+h.y*(h.y<0?i:s)+h.z*(h.z<0?a:l)<0)return!1;var _=this._bottom.normal;if(this._bottom.distance+_.x*(_.x<0?n:o)+_.y*(_.y<0?i:s)+_.z*(_.z<0?a:l)<0)return!1;var d=this._top.normal;if(this._top.distance+d.x*(d.x<0?n:o)+d.y*(d.y<0?i:s)+d.z*(d.z<0?a:l)<0)return!1;var f=this._far.normal;return!(this._far.distance+f.x*(f.x<0?n:o)+f.y*(f.y<0?i:s)+f.z*(f.z<0?a:l)<0)}},{key:"containsBoundBox",value:function(e){for(var t=BoundFrustum._tempV30,r=BoundFrustum._tempV31,n=e.min,i=e.max,a=Be.Contains,o=0;o<6;o++){var s=this.getPlane(o),l=s.normal;if(l.x>=0?(t.x=i.x,r.x=n.x):(t.x=n.x,r.x=i.x),l.y>=0?(t.y=i.y,r.y=n.y):(t.y=n.y,r.y=i.y),l.z>=0?(t.z=i.z,r.z=n.z):(t.z=n.z,r.z=i.z),Fe.intersectsPlaneAndPoint(s,t)===ke.PlaneIntersectionType_Back)return Be.Disjoint;Fe.intersectsPlaneAndPoint(s,r)===ke.PlaneIntersectionType_Back&&(a=Be.Intersects)}return a}},{key:"containsBoundSphere",value:function(e){for(var t=ke.PlaneIntersectionType_Front,r=ke.PlaneIntersectionType_Front,n=0;n<6;n++){switch(n){case 0:r=Fe.intersectsPlaneAndSphere(this._near,e);break;case 1:r=Fe.intersectsPlaneAndSphere(this._far,e);break;case 2:r=Fe.intersectsPlaneAndSphere(this._left,e);break;case 3:r=Fe.intersectsPlaneAndSphere(this._right,e);break;case 4:r=Fe.intersectsPlaneAndSphere(this._top,e);break;case 5:r=Fe.intersectsPlaneAndSphere(this._bottom,e)}switch(r){case ke.PlaneIntersectionType_Back:return Be.Disjoint;case ke.PlaneIntersectionType_Intersecting:t=ke.PlaneIntersectionType_Intersecting}}switch(t){case ke.PlaneIntersectionType_Intersecting:return Be.Intersects;default:return Be.Contains}}},{key:"matrix",get:function(){return this._matrix},set:function(e){e.cloneTo(this._matrix),BoundFrustum.getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}},{key:"near",get:function(){return this._near}},{key:"far",get:function(){return this._far}},{key:"left",get:function(){return this._left}},{key:"right",get:function(){return this._right}},{key:"top",get:function(){return this._top}},{key:"bottom",get:function(){return this._bottom}}],[{key:"getPlanesFromMatrix",value:function(e,t,r,n,i,a,o){var s=e.elements,l=s[0],u=s[1],c=s[2],h=s[3],_=s[4],d=s[5],f=s[6],m=s[7],T=s[8],p=s[9],g=s[10],E=s[11],y=s[12],S=s[13],v=s[14],R=s[15],C=t.normal;C.x=c,C.y=f,C.z=g,t.distance=v,t.normalize();var M=r.normal;M.x=h-c,M.y=m-f,M.z=E-g,r.distance=R-v,r.normalize();var D=n.normal;D.x=h+l,D.y=m+_,D.z=E+T,n.distance=R+y,n.normalize();var x=i.normal;x.x=h-l,x.y=m-_,x.z=E-T,i.distance=R-y,i.normalize();var A=a.normal;A.x=h-u,A.y=m-d,A.z=E-p,a.distance=R-S,a.normalize();var I=o.normal;I.x=h+u,I.y=m+d,I.z=E+p,o.distance=R+S,o.normalize()}},{key:"get3PlaneInterPoint",value:function(e,t,r,n){var i=e.normal,a=t.normal,s=r.normal;o.cross(a,s,BoundFrustum._tempV30),o.cross(s,i,BoundFrustum._tempV31),o.cross(i,a,BoundFrustum._tempV32);var l=o.dot(i,BoundFrustum._tempV30),u=o.dot(a,BoundFrustum._tempV31),c=o.dot(s,BoundFrustum._tempV32);o.scale(BoundFrustum._tempV30,-e.distance/l,BoundFrustum._tempV33),o.scale(BoundFrustum._tempV31,-t.distance/u,BoundFrustum._tempV34),o.scale(BoundFrustum._tempV32,-r.distance/c,BoundFrustum._tempV35),o.add(BoundFrustum._tempV33,BoundFrustum._tempV34,BoundFrustum._tempV36),o.add(BoundFrustum._tempV35,BoundFrustum._tempV36,n)}}]),BoundFrustum}();Ue._tempV30=new o,Ue._tempV31=new o,Ue._tempV32=new o,Ue._tempV33=new o,Ue._tempV34=new o,Ue._tempV35=new o,Ue._tempV36=new o;var Ge=function(){function Viewport(e,t,r,n){_classCallCheck(this,Viewport),this.minDepth=0,this.maxDepth=1,this.x=e,this.y=t,this.width=r,this.height=n}return _createClass(Viewport,[{key:"project",value:function(e,t,r){o.transformV3ToV4(e,t,r);var n=r.x,i=r.y,a=r.z,s=r.w;1!==s&&(n/=s,i/=s,a/=s),r.x=.5*(n+1)*this.width+this.x,r.y=.5*(1-i)*this.height+this.y,r.z=a*(this.maxDepth-this.minDepth)+this.minDepth}},{key:"unprojectFromMat",value:function(e,t,r){var n=t.elements;r.x=(e.x-this.x)/this.width*2-1,r.y=-((e.y-this.y)/this.height*2-1),r.z=(e.z-this.minDepth)/(this.maxDepth-this.minDepth);var i=r.x*n[3]+r.y*n[7]+r.z*n[11]+n[15];o.transformV3ToV3(r,t,r),1!==i&&(r.x=r.x/i,r.y=r.y/i,r.z=r.z/i)}},{key:"unprojectFromWVP",value:function(e,t,r,n,i){c.multiply(t,r,Viewport._tempMatrix4x4),n&&c.multiply(Viewport._tempMatrix4x4,n,Viewport._tempMatrix4x4),Viewport._tempMatrix4x4.invert(Viewport._tempMatrix4x4),this.unprojectFromMat(e,Viewport._tempMatrix4x4,i)}},{key:"cloneTo",value:function(e){e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e.minDepth=this.minDepth,e.maxDepth=this.maxDepth}}]),Viewport}();Ge._tempMatrix4x4=new c;var ze=function(){function Picker(){_classCallCheck(this,Picker)}return _createClass(Picker,null,[{key:"calculateCursorRay",value:function(e,t,r,n,i,a){var s=e.x,l=e.y,u=Picker._tempVector30,c=u;c.x=s,c.y=l,c.z=t.minDepth;var h=Picker._tempVector31,_=h;_.x=s,_.y=l,_.z=t.maxDepth;var d=a.origin,f=Picker._tempVector32;t.unprojectFromWVP(u,r,n,i,d),t.unprojectFromWVP(h,r,n,i,f);var m=a.direction;m.x=f.x-d.x,m.y=f.y-d.y,m.z=f.z-d.z,o.normalize(a.direction,a.direction)}},{key:"rayIntersectsTriangle",value:function(e,t,r,n){var i=Picker._tempVector30,a=Picker._tempVector31;o.subtract(r,t,i),o.subtract(n,t,a);var s,l=Picker._tempVector32;if(o.cross(e.direction,a,l),(s=o.dot(i,l))>-Number.MIN_VALUE&&s<Number.MIN_VALUE)return Number.NaN;var u,c=1/s,h=Picker._tempVector33;if(o.subtract(e.origin,t,h),u=o.dot(h,l),(u*=c)<0||u>1)return Number.NaN;var _,d,f=Picker._tempVector34;return o.cross(h,i,f),_=o.dot(e.direction,f),(_*=c)<0||u+_>1?Number.NaN:(d=o.dot(a,f),(d*=c)<0?Number.NaN:d)}}]),Picker}();ze._tempVector30=new o,ze._tempVector31=new o,ze._tempVector32=new o,ze._tempVector33=new o,ze._tempVector34=new o;var He,We=function(e){function BufferState(){return _classCallCheck(this,BufferState),_possibleConstructorReturn(this,_getPrototypeOf(BufferState).call(this))}return _inherits(BufferState,e),_createClass(BufferState,[{key:"applyVertexBuffer",value:function(e){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";var r=t.LayaGL.instance,n=e.vertexDeclaration,i=n._shaderValues.getData();for(var a in this.vertexDeclaration=n,e.bind(),i){var o=parseInt(a),s=i[a];r.enableVertexAttribArray(o),r.vertexAttribPointer(o,s[0],s[1],!!s[2],s[3],s[4])}}},{key:"applyVertexBuffers",value:function(e){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";for(var r=t.LayaGL.instance,n=0,i=e.length;n<i;n++){var a=e[n],o=a.vertexDeclaration._shaderValues.getData();for(var s in a.bind(),o){var l=parseInt(s),u=o[s];r.enableVertexAttribArray(l),r.vertexAttribPointer(l,u[0],u[1],!!u[2],u[3],u[4])}}}},{key:"applyInstanceVertexBuffer",value:function(e){if(t.LayaGL.layaGPUInstance.supportInstance()){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";var r=t.LayaGL.instance,n=e.vertexDeclaration._shaderValues.getData();for(var i in e.bind(),n){var a=parseInt(i),o=n[i];r.enableVertexAttribArray(a),r.vertexAttribPointer(a,o[0],o[1],!!o[2],o[3],o[4]),t.LayaGL.layaGPUInstance.vertexAttribDivisor(a,1)}}}},{key:"applyIndexBuffer",value:function(e){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";this._bindedIndexBuffer!==e&&(e._bindForVAO(),this._bindedIndexBuffer=e)}}]),BufferState}(t.BufferStateBase);(He=e.IndexFormat||(e.IndexFormat={}))[He.UInt8=0]="UInt8",He[He.UInt16=1]="UInt16",He[He.UInt32=2]="UInt32";var Xe=function(r){function IndexBuffer3D(r,n){var i,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:35044,o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];switch(_classCallCheck(this,IndexBuffer3D),(i=_possibleConstructorReturn(this,_getPrototypeOf(IndexBuffer3D).call(this)))._indexType=r,i._indexCount=n,i._bufferUsage=a,i._bufferType=t.LayaGL.instance.ELEMENT_ARRAY_BUFFER,i._canRead=o,r){case e.IndexFormat.UInt32:i._indexTypeByteCount=4;break;case e.IndexFormat.UInt16:i._indexTypeByteCount=2;break;case e.IndexFormat.UInt8:i._indexTypeByteCount=1;break;default:throw new Error("unidentification index type.")}var s=i._indexTypeByteCount*n,l=t.BufferStateBase._curBindedBufferState;if(i._byteLength=s,l?l._bindedIndexBuffer===_assertThisInitialized(i)?t.LayaGL.instance.bufferData(i._bufferType,s,i._bufferUsage):(l.unBind(),i.bind(),t.LayaGL.instance.bufferData(i._bufferType,s,i._bufferUsage),l.bind()):(i.bind(),t.LayaGL.instance.bufferData(i._bufferType,s,i._bufferUsage)),o)switch(r){case e.IndexFormat.UInt32:i._buffer=new Uint32Array(n);break;case e.IndexFormat.UInt16:i._buffer=new Uint16Array(n);break;case e.IndexFormat.UInt8:i._buffer=new Uint8Array(n)}return i}return _inherits(IndexBuffer3D,r),_createClass(IndexBuffer3D,[{key:"_bindForVAO",value:function(){if(!t.BufferStateBase._curBindedBufferState)throw"IndexBuffer3D: must bind current BufferState.";var e=t.LayaGL.instance;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._glBuffer)}},{key:"bind",value:function(){if(t.BufferStateBase._curBindedBufferState)throw"IndexBuffer3D: must unbind current BufferState.";if(t.Buffer._bindedIndexBuffer!==this._glBuffer){var e=t.LayaGL.instance;return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._glBuffer),t.Buffer._bindedIndexBuffer=this._glBuffer,!0}return!1}},{key:"setData",value:function(r){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4294967295,o=this._indexTypeByteCount;if(0!==i||4294967295!==a)switch(this._indexType){case e.IndexFormat.UInt32:r=new Uint32Array(r.buffer,i*o,a);break;case e.IndexFormat.UInt16:r=new Uint16Array(r.buffer,i*o,a);break;case e.IndexFormat.UInt8:r=new Uint8Array(r.buffer,i*o,a)}var s=t.BufferStateBase._curBindedBufferState;if(s?s._bindedIndexBuffer===this?t.LayaGL.instance.bufferSubData(this._bufferType,n*o,r):(s.unBind(),this.bind(),t.LayaGL.instance.bufferSubData(this._bufferType,n*o,r),s.bind()):(this.bind(),t.LayaGL.instance.bufferSubData(this._bufferType,n*o,r)),this._canRead)if(0!==n||0!==i||4294967295!==a){var l=this._buffer.length-n;a>l&&(a=l);for(var u=0;u<a;u++)this._buffer[n+u]=r[u]}else this._buffer=r}},{key:"getData",value:function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")}},{key:"destroy",value:function(){_get(_getPrototypeOf(IndexBuffer3D.prototype),"destroy",this).call(this),this._buffer=null,this._byteLength=0,this._indexCount=0}},{key:"indexType",get:function(){return this._indexType}},{key:"indexTypeByteCount",get:function(){return this._indexTypeByteCount}},{key:"indexCount",get:function(){return this._indexCount}},{key:"canRead",get:function(){return this._canRead}}]),IndexBuffer3D}(t.Buffer),Ye=function(){function VertexElementFormat(){_classCallCheck(this,VertexElementFormat)}return _createClass(VertexElementFormat,null,[{key:"__init__",value:function(){var e=t.LayaGL.instance;VertexElementFormat._elementInfos={single:[1,e.FLOAT,0],vector2:[2,e.FLOAT,0],vector3:[3,e.FLOAT,0],vector4:[4,e.FLOAT,0],color:[4,e.FLOAT,0],byte4:[4,e.UNSIGNED_BYTE,0],short2:[2,e.FLOAT,0],short4:[4,e.FLOAT,0],normalizedshort2:[2,e.FLOAT,0],normalizedshort4:[4,e.FLOAT,0],halfvector2:[2,e.FLOAT,0],halfvector4:[4,e.FLOAT,0]}}},{key:"getElementInfos",value:function(e){var t=VertexElementFormat._elementInfos[e];if(t)return t;throw"VertexElementFormat: this vertexElementFormat is not implement."}}]),VertexElementFormat}();Ye.Single="single",Ye.Vector2="vector2",Ye.Vector3="vector3",Ye.Vector4="vector4",Ye.Color="color",Ye.Byte4="byte4",Ye.Short2="short2",Ye.Short4="short4",Ye.NormalizedShort2="normalizedshort2",Ye.NormalizedShort4="normalizedshort4",Ye.HalfVector2="halfvector2",Ye.HalfVector4="halfvector4";var je=function(){function VertexDeclaration(e,t){_classCallCheck(this,VertexDeclaration),this._id=++VertexDeclaration._uniqueIDCounter,this._vertexElementsDic={},this._vertexStride=e,this._vertexElements=t;var r=t.length;this._shaderValues=new ce(null);for(var n=0;n<r;n++){var i=t[n],a=i._elementUsage;this._vertexElementsDic[a]=i;var o=new Int32Array(5),s=Ye.getElementInfos(i._elementFormat);o[0]=s[0],o[1]=s[1],o[2]=s[2],o[3]=this._vertexStride,o[4]=i._offset,this._shaderValues.setAttribute(a,o)}}return _createClass(VertexDeclaration,[{key:"getVertexElementByIndex",value:function(e){return this._vertexElements[e]}},{key:"getVertexElementByUsage",value:function(e){return this._vertexElementsDic[e]}},{key:"id",get:function(){return this._id}},{key:"vertexStride",get:function(){return this._vertexStride}},{key:"vertexElementCount",get:function(){return this._vertexElements.length}}]),VertexDeclaration}();je._uniqueIDCounter=1;var Ze=function(){function VertexElement(e,t,r){_classCallCheck(this,VertexElement),this._offset=e,this._elementFormat=t,this._elementUsage=r}return _createClass(VertexElement,[{key:"offset",get:function(){return this._offset}},{key:"elementFormat",get:function(){return this._elementFormat}},{key:"elementUsage",get:function(){return this._elementUsage}}]),VertexElement}(),Qe=function(){function VertexMesh(){_classCallCheck(this,VertexMesh)}return _createClass(VertexMesh,null,[{key:"__init__",value:function(){VertexMesh.instanceWorldMatrixDeclaration=new je(64,[new Ze(0,Ye.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW0),new Ze(16,Ye.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW1),new Ze(32,Ye.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW2),new Ze(48,Ye.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW3)]),VertexMesh.instanceMVPMatrixDeclaration=new je(64,[new Ze(0,Ye.Vector4,VertexMesh.MESH_MVPMATRIX_ROW0),new Ze(16,Ye.Vector4,VertexMesh.MESH_MVPMATRIX_ROW1),new Ze(32,Ye.Vector4,VertexMesh.MESH_MVPMATRIX_ROW2),new Ze(48,Ye.Vector4,VertexMesh.MESH_MVPMATRIX_ROW3)]),VertexMesh.instanceSimpleAnimatorDeclaration=new je(16,[new Ze(0,Ye.Vector4,VertexMesh.MESH_SIMPLEANIMATOR)])}},{key:"getVertexDeclaration",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=VertexMesh._vertexDeclarationMap[e+(t?"_0":"_1")];if(!r){for(var n=e.split(","),i=0,a=[],o=0,s=n.length;o<s;o++){var l;switch(n[o]){case"POSITION":l=new Ze(i,Ye.Vector3,VertexMesh.MESH_POSITION0),i+=12;break;case"NORMAL":l=new Ze(i,Ye.Vector3,VertexMesh.MESH_NORMAL0),i+=12;break;case"COLOR":l=new Ze(i,Ye.Vector4,VertexMesh.MESH_COLOR0),i+=16;break;case"UV":l=new Ze(i,Ye.Vector2,VertexMesh.MESH_TEXTURECOORDINATE0),i+=8;break;case"UV1":l=new Ze(i,Ye.Vector2,VertexMesh.MESH_TEXTURECOORDINATE1),i+=8;break;case"BLENDWEIGHT":l=new Ze(i,Ye.Vector4,VertexMesh.MESH_BLENDWEIGHT0),i+=16;break;case"BLENDINDICES":t?(l=new Ze(i,Ye.Vector4,VertexMesh.MESH_BLENDINDICES0),i+=16):(l=new Ze(i,Ye.Byte4,VertexMesh.MESH_BLENDINDICES0),i+=4);break;case"TANGENT":l=new Ze(i,Ye.Vector4,VertexMesh.MESH_TANGENT0),i+=16;break;default:throw"VertexMesh: unknown vertex flag."}a.push(l)}r=new je(i,a),VertexMesh._vertexDeclarationMap[e+(t?"_0":"_1")]=r}return r}}]),VertexMesh}();Qe.MESH_POSITION0=0,Qe.MESH_COLOR0=1,Qe.MESH_TEXTURECOORDINATE0=2,Qe.MESH_NORMAL0=3,Qe.MESH_TANGENT0=4,Qe.MESH_BLENDINDICES0=5,Qe.MESH_BLENDWEIGHT0=6,Qe.MESH_TEXTURECOORDINATE1=7,Qe.MESH_WORLDMATRIX_ROW0=8,Qe.MESH_WORLDMATRIX_ROW1=9,Qe.MESH_WORLDMATRIX_ROW2=10,Qe.MESH_WORLDMATRIX_ROW3=11,Qe.MESH_MVPMATRIX_ROW0=12,Qe.MESH_MVPMATRIX_ROW1=13,Qe.MESH_MVPMATRIX_ROW2=14,Qe.MESH_MVPMATRIX_ROW3=15,Qe.MESH_SIMPLEANIMATOR=7,Qe._vertexDeclarationMap={};var qe=function(e){function VertexBuffer3D(e,r){var n,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];_classCallCheck(this,VertexBuffer3D),(n=_possibleConstructorReturn(this,_getPrototypeOf(VertexBuffer3D).call(this)))._vertexDeclaration=null,n._float32Reader=null;var a=t.LayaGL.instance;return n._bufferUsage=r,n._bufferType=a.ARRAY_BUFFER,n._canRead=i,n._byteLength=e,n.bind(),a.bufferData(n._bufferType,n._byteLength,n._bufferUsage),i&&(n._buffer=new Uint8Array(e),n._float32Reader=new Float32Array(n._buffer.buffer)),n}return _inherits(VertexBuffer3D,e),_createClass(VertexBuffer3D,[{key:"bind",value:function(){if(t.Buffer._bindedVertexBuffer!==this._glBuffer){var e=t.LayaGL.instance;return e.bindBuffer(e.ARRAY_BUFFER,this._glBuffer),t.Buffer._bindedVertexBuffer=this._glBuffer,!0}return!1}},{key:"orphanStorage",value:function(){this.bind(),t.LayaGL.instance.bufferData(this._bufferType,this._byteLength,this._bufferUsage)}},{key:"setData",value:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Number.MAX_SAFE_INTEGER;this.bind();var a=0!==n||i!==Number.MAX_SAFE_INTEGER;if(a){var o=new Uint8Array(e,n,i);t.LayaGL.instance.bufferSubData(this._bufferType,r,o),this._canRead&&this._buffer.set(o,r)}else t.LayaGL.instance.bufferSubData(this._bufferType,r,e),this._canRead&&this._buffer.set(new Uint8Array(e),r)}},{key:"getUint8Data",value:function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")}},{key:"getFloat32Data",value:function(){if(this._canRead)return this._float32Reader;throw new Error("Can't read data from VertexBuffer with only write flag!")}},{key:"markAsUnreadbale",value:function(){this._canRead=!1,this._buffer=null,this._float32Reader=null}},{key:"destroy",value:function(){_get(_getPrototypeOf(VertexBuffer3D.prototype),"destroy",this).call(this),this._buffer=null,this._float32Reader=null,this._vertexDeclaration=null,this._byteLength=0}},{key:"vertexDeclaration",get:function(){return this._vertexDeclaration},set:function(e){this._vertexDeclaration=e}},{key:"canRead",get:function(){return this._canRead}}]),VertexBuffer3D}(t.Buffer);qe.DATATYPE_FLOAT32ARRAY=0,qe.DATATYPE_UINT8ARRAY=1;var Ke=function(){function SkyMesh(){_classCallCheck(this,SkyMesh)}return _createClass(SkyMesh,[{key:"_render",value:function(e){}}]),SkyMesh}(),Je=function(r){function SkyBox(){var r;_classCallCheck(this,SkyBox),r=_possibleConstructorReturn(this,_getPrototypeOf(SkyBox).call(this));var n=t.LayaGL.instance,i=new Float32Array([-1,1,-1,1,1,-1,1,1,1,-1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1]),a=new Uint8Array([0,1,2,2,3,0,4,7,6,6,5,4,0,3,7,7,4,0,1,5,6,6,2,1,3,2,6,6,7,3,0,4,5,5,1,0]),o=Qe.getVertexDeclaration("POSITION");r._vertexBuffer=new qe(8*o.vertexStride,n.STATIC_DRAW,!1),r._vertexBuffer.vertexDeclaration=o,r._indexBuffer=new Xe(e.IndexFormat.UInt8,36,n.STATIC_DRAW,!1),r._vertexBuffer.setData(i.buffer),r._indexBuffer.setData(a);var s=new We;return s.bind(),s.applyVertexBuffer(r._vertexBuffer),s.applyIndexBuffer(r._indexBuffer),s.unBind(),r._bufferState=s,r}return _inherits(SkyBox,r),_createClass(SkyBox,[{key:"_render",value:function(e){var r=t.LayaGL.instance;r.drawElements(r.TRIANGLES,36,r.UNSIGNED_BYTE,0),t.Stat.trianglesFaces+=12,t.Stat.renderBatches++}}],[{key:"__init__",value:function(){SkyBox.instance=new SkyBox}}]),SkyBox}(Ke),$e=function(){function SkyRenderer(){_classCallCheck(this,SkyRenderer),this._mesh=Je.instance}return _createClass(SkyRenderer,[{key:"_isAvailable",value:function(){return!(!this._material||!this._mesh)}},{key:"_render",value:function(e){if(this._material&&this._mesh){var r=t.LayaGL.instance,n=e.scene,i=e.cameraShaderValue,a=e.camera,s=ce._SET_RUNTIME_VALUE_MODE_REFERENCE_;t.ILaya.Render.supportWebGLPlusRendering&&ce.setRuntimeValueMode(!1),t.WebGLContext.setCullFace(r,!1),t.WebGLContext.setDepthFunc(r,r.LEQUAL),t.WebGLContext.setDepthMask(r,!1);var l=SkyRenderer._compileDefine;this._material._shaderValues._defineDatas.cloneTo(l);var u=e.shader=this._material._shader.getSubShaderAt(0)._passes[0].withCompile(l),h=u.bind(),_=t.Stat.loopCount!==u._uploadMark,d=u._uploadScene!==n||_;(d||h)&&(u.uploadUniforms(u._sceneUniformParamsMap,n._shaderValues,d),u._uploadScene=n);a._getRenderTexture();var f=u._uploadCameraShaderValue!==i||_;if(f||h){var m=SkyRenderer._tempMatrix0,T=SkyRenderer._tempMatrix1;a.viewMatrix.cloneTo(m),a.projectionMatrix.cloneTo(T),m.setTranslationVector(o._ZERO),a.orthographic&&c.createPerspective(a.fieldOfView,a.aspectRatio,a.nearPlane,a.farPlane,T);var p=1/Math.tan(3.1416*a.fieldOfView/180*.5);T.elements[0]=p/a.aspectRatio,T.elements[5]=p,T.elements[10]=1e-6-1,T.elements[11]=-1,T.elements[14]=-0,a._applyViewProject(e,m,T),u.uploadUniforms(u._cameraUniformParamsMap,i,f),u._uploadCameraShaderValue=i}var g=u._uploadMaterial!==this._material||_;(g||h)&&(u.uploadUniforms(u._materialUniformParamsMap,this._material._shaderValues,g),u._uploadMaterial=this._material),this._mesh._bufferState.bind(),this._mesh._render(e),t.ILaya.Render.supportWebGLPlusRendering&&ce.setRuntimeValueMode(s),t.WebGLContext.setDepthFunc(r,r.LESS),t.WebGLContext.setDepthMask(r,!0),a._applyViewProject(e,a.viewMatrix,a.projectionMatrix)}}},{key:"destroy",value:function(){this._material&&(this._material._removeReference(),this._material=null)}},{key:"material",get:function(){return this._material},set:function(e){this._material!==e&&(this._material&&this._material._removeReference(),e&&e._addReference(),this._material=e)}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh!==e&&(this._mesh=e)}}]),SkyRenderer}();$e._tempMatrix0=new c,$e._tempMatrix1=new c,$e._compileDefine=new ae;var et=function(e){function Sprite3D(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return _classCallCheck(this,Sprite3D),(e=_possibleConstructorReturn(this,_getPrototypeOf(Sprite3D).call(this)))._needProcessCollisions=!1,e._needProcessTriggers=!1,e._id=++Sprite3D._uniqueIDCounter,e._transform=new f(_assertThisInitialized(e)),e._isStatic=r,e.layer=0,e.name=t||"New Sprite3D",e}return _inherits(Sprite3D,e),_createClass(Sprite3D,[{key:"_setCreateURL",value:function(e){this._url=t.URL.formatURL(e)}},{key:"_changeAnimatorsToLinkSprite3D",value:function(e,t,r){var n=this.getComponent(te);if(n&&(n.avatar||e._changeAnimatorToLinkSprite3DNoAvatar(n,t,r)),this._parent&&this._parent instanceof Sprite3D){r.unshift(this._parent.name);var i=this._parent;i._hierarchyAnimator&&i._changeAnimatorsToLinkSprite3D(e,t,r)}}},{key:"_setHierarchyAnimator",value:function(e,t){this._changeHierarchyAnimator(e),this._changeAnimatorAvatar(e.avatar);for(var r=0,n=this._children.length;r<n;r++){var i=this._children[r];i._hierarchyAnimator==t&&i._setHierarchyAnimator(e,t)}}},{key:"_clearHierarchyAnimator",value:function(e,t){this._changeHierarchyAnimator(t),this._changeAnimatorAvatar(t?t.avatar:null);for(var r=0,n=this._children.length;r<n;r++){var i=this._children[r];i._hierarchyAnimator==e&&i._clearHierarchyAnimator(e,t)}}},{key:"_changeHierarchyAnimatorAvatar",value:function(e,t){this._changeAnimatorAvatar(t);for(var r=0,n=this._children.length;r<n;r++){var i=this._children[r];i._hierarchyAnimator==e&&i._changeHierarchyAnimatorAvatar(e,t)}}},{key:"_changeAnimatorToLinkSprite3DNoAvatar",value:function(e,t,r){e._handleSpriteOwnersBySprite(t,r,this);for(var n=0,i=this._children.length;n<i;n++){var a=this._children[n],o=r.length;r.push(a.name),a._changeAnimatorToLinkSprite3DNoAvatar(e,t,r),r.splice(o,1)}}},{key:"_changeHierarchyAnimator",value:function(e){this._hierarchyAnimator=e}},{key:"_changeAnimatorAvatar",value:function(e){}},{key:"_onAdded",value:function(){if(this._parent instanceof Sprite3D){var e=this._parent;this.transform._setParent(e.transform),e._hierarchyAnimator&&(!this._hierarchyAnimator&&this._setHierarchyAnimator(e._hierarchyAnimator,null),e._changeAnimatorsToLinkSprite3D(this,!0,[this.name]))}_get(_getPrototypeOf(Sprite3D.prototype),"_onAdded",this).call(this)}},{key:"_onRemoved",value:function(){if(_get(_getPrototypeOf(Sprite3D.prototype),"_onRemoved",this).call(this),this._parent instanceof Sprite3D){var e=this._parent;this.transform._setParent(null),e._hierarchyAnimator&&(this._hierarchyAnimator==e._hierarchyAnimator&&this._clearHierarchyAnimator(e._hierarchyAnimator,null),e._changeAnimatorsToLinkSprite3D(this,!1,[this.name]))}}},{key:"_parse",value:function(e,t){if(void 0!==e.isStatic&&(this._isStatic=e.isStatic),void 0!==e.active&&(this.active=e.active),null!=e.name&&(this.name=e.name),void 0!==e.position){var r=this.transform.localPosition;r.fromArray(e.position),this.transform.localPosition=r}if(void 0!==e.rotationEuler){var n=this.transform.localRotationEuler;n.fromArray(e.rotationEuler),this.transform.localRotationEuler=n}if(void 0!==e.rotation){var i=this.transform.localRotation;i.fromArray(e.rotation),this.transform.localRotation=i}if(void 0!==e.scale){var a=this.transform.localScale;a.fromArray(e.scale),this.transform.localScale=a}null!=e.layer&&(this.layer=e.layer)}},{key:"_cloneTo",value:function(e,t,r){if(this.destroyed)throw new Error("Sprite3D: Can't be cloned if the Sprite3D has destroyed.");var n=e,i=this._transform,a=n._transform;n.name=this.name,n.destroyed=this.destroyed,n.active=this.active,a.localPosition=i.localPosition,a.localRotation=i.localRotation,a.localScale=i.localScale,n._isStatic=this._isStatic,n.layer=this.layer,_get(_getPrototypeOf(Sprite3D.prototype),"_cloneTo",this).call(this,n,t,r)}},{key:"clone",value:function(){var e=Sprite3D._createSprite3DInstance(this);return Sprite3D._parseSprite3DInstance(this,e,this,e),e}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(Sprite3D.prototype),"destroy",this).call(this,e),this._transform=null,this._scripts=null,this._url&&t.Loader.clearRes(this._url))}},{key:"_create",value:function(){return new Sprite3D}},{key:"id",get:function(){return this._id}},{key:"layer",get:function(){return this._layer},set:function(e){if(this._layer!==e){if(!(e>=0&&e<=30))throw new Error("Layer value must be 0-30.");this._layer=e}}},{key:"url",get:function(){return this._url}},{key:"isStatic",get:function(){return this._isStatic}},{key:"transform",get:function(){return this._transform}}],[{key:"__init__",value:function(){}},{key:"instantiate",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=e.clone();t&&t.addChild(a);var o=a.transform;if(r){var s=o.worldMatrix;e.transform.worldMatrix.cloneTo(s),o.worldMatrix=s}else n&&(o.position=n),i&&(o.rotation=i);return a}},{key:"load",value:function(e,r){t.Laya.loader.create(e,r,null,Sprite3D.HIERARCHY)}},{key:"_createSprite3DInstance",value:function(e){for(var t=e._create(),r=e._children,n=0,i=r.length;n<i;n++){var a=Sprite3D._createSprite3DInstance(r[n]);t.addChild(a)}return t}},{key:"_parseSprite3DInstance",value:function(e,t,r,n){for(var i=r._children,a=n._children,o=0,s=i.length;o<s;o++)Sprite3D._parseSprite3DInstance(e,t,i[o],a[o]);r._cloneTo(n,e,t)}}]),Sprite3D}(t.Node);et.HIERARCHY="HIERARCHY",et.WORLDMATRIX=ue.propertyNameToID("u_WorldMat"),et.MVPMATRIX=ue.propertyNameToID("u_MvpMatrix"),et._uniqueIDCounter=0;var tt,rt=function(e){function BaseCamera(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.3,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;return _classCallCheck(this,BaseCamera),(e=_possibleConstructorReturn(this,_getPrototypeOf(BaseCamera).call(this)))._skyRenderer=new $e,e._forward=new o,e._up=new o,e.clearColor=new i(100/255,149/255,237/255,1),e._shaderValues=new ce(null),e._fieldOfView=60,e._useUserProjectionMatrix=!1,e._orthographic=!1,e._orthographicVerticalSize=10,e.renderingOrder=0,e._nearPlane=t,e._farPlane=r,e.cullingMask=2147483647,e.useOcclusionCulling=!0,e}return _inherits(BaseCamera,e),_createClass(BaseCamera,[{key:"_sortCamerasByRenderingOrder",value:function(){if(this.displayedInStage)for(var e=this.scene._cameraPool,t=e.length-1,r=0;r<t;r++)if(e[r].renderingOrder>e[t].renderingOrder){var n=e[r];e[r]=e[t],e[t]=n}}},{key:"_calculateProjectionMatrix",value:function(){}},{key:"_onScreenSizeChanged",value:function(){this._calculateProjectionMatrix()}},{key:"_prepareCameraToRender",value:function(){var e=this._shaderValues;this.transform.getForward(this._forward),this.transform.getUp(this._up),e.setVector3(BaseCamera.CAMERAPOS,this.transform.position),e.setVector3(BaseCamera.CAMERADIRECTION,this._forward),e.setVector3(BaseCamera.CAMERAUP,this._up)}},{key:"render",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0],arguments.length>1&&void 0!==arguments[1]&&arguments[1]}},{key:"addLayer",value:function(e){this.cullingMask|=Math.pow(2,e)}},{key:"removeLayer",value:function(e){this.cullingMask&=~Math.pow(2,e)}},{key:"addAllLayers",value:function(){this.cullingMask=2147483647}},{key:"removeAllLayers",value:function(){this.cullingMask=0}},{key:"resetProjectionMatrix",value:function(){this._useUserProjectionMatrix=!1,this._calculateProjectionMatrix()}},{key:"_onActive",value:function(){this._scene._addCamera(this),_get(_getPrototypeOf(BaseCamera.prototype),"_onActive",this).call(this)}},{key:"_onInActive",value:function(){this._scene._removeCamera(this),_get(_getPrototypeOf(BaseCamera.prototype),"_onInActive",this).call(this)}},{key:"_parse",value:function(e,r){_get(_getPrototypeOf(BaseCamera.prototype),"_parse",this).call(this,e,r),this.orthographic=e.orthographic,void 0!==e.orthographicVerticalSize&&(this.orthographicVerticalSize=e.orthographicVerticalSize),void 0!==e.fieldOfView&&(this.fieldOfView=e.fieldOfView),this.nearPlane=e.nearPlane,this.farPlane=e.farPlane;var n=e.clearColor;this.clearColor=new i(n[0],n[1],n[2],n[3]);var a=e.skyboxMaterial;a&&(this._skyRenderer.material=t.Loader.getRes(a.path))}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._skyRenderer.destroy(),this._skyRenderer=null,t.Laya.stage.off(t.Event.RESIZE,this,this._onScreenSizeChanged),_get(_getPrototypeOf(BaseCamera.prototype),"destroy",this).call(this,e)}},{key:"_create",value:function(){return new BaseCamera}},{key:"skyRenderer",get:function(){return this._skyRenderer}},{key:"fieldOfView",get:function(){return this._fieldOfView},set:function(e){this._fieldOfView=e,this._calculateProjectionMatrix()}},{key:"nearPlane",get:function(){return this._nearPlane},set:function(e){this._nearPlane=e,this._calculateProjectionMatrix()}},{key:"farPlane",get:function(){return this._farPlane},set:function(e){this._farPlane=e,this._calculateProjectionMatrix()}},{key:"orthographic",get:function(){return this._orthographic},set:function(e){this._orthographic=e,this._calculateProjectionMatrix()}},{key:"orthographicVerticalSize",get:function(){return this._orthographicVerticalSize},set:function(e){this._orthographicVerticalSize=e,this._calculateProjectionMatrix()}},{key:"renderingOrder",get:function(){return this._renderingOrder},set:function(e){this._renderingOrder=e,this._sortCamerasByRenderingOrder()}}]),BaseCamera}(et);rt._tempMatrix4x40=new c,rt.CAMERAPOS=ue.propertyNameToID("u_CameraPos"),rt.VIEWMATRIX=ue.propertyNameToID("u_View"),rt.PROJECTMATRIX=ue.propertyNameToID("u_Projection"),rt.VIEWPROJECTMATRIX=ue.propertyNameToID("u_ViewProjection"),rt.CAMERADIRECTION=ue.propertyNameToID("u_CameraDirection"),rt.CAMERAUP=ue.propertyNameToID("u_CameraUp"),rt.VIEWPORT=ue.propertyNameToID("u_Viewport"),rt.PROJECTION_PARAMS=ue.propertyNameToID("u_ProjectionParams"),rt.RENDERINGTYPE_DEFERREDLIGHTING="DEFERREDLIGHTING",rt.RENDERINGTYPE_FORWARDRENDERING="FORWARDRENDERING",rt._invertYScaleMatrix=new c(1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1),rt._invertYProjectionMatrix=new c,rt._invertYProjectionViewMatrix=new c,rt.CLEARFLAG_SOLIDCOLOR=0,rt.CLEARFLAG_SKY=1,rt.CLEARFLAG_DEPTHONLY=2,rt.CLEARFLAG_NONE=3,(tt=e.ShadowMode||(e.ShadowMode={}))[tt.None=0]="None",tt[tt.Hard=1]="Hard",tt[tt.SoftLow=2]="SoftLow",tt[tt.SoftHigh=3]="SoftHigh";var nt=function(e){function ScreenQuad(){var e;_classCallCheck(this,ScreenQuad),(e=_possibleConstructorReturn(this,_getPrototypeOf(ScreenQuad).call(this)))._bufferState=new We,e._bufferStateInvertUV=new We;var r=t.LayaGL.instance;return e._vertexBuffer=new qe(64,r.STATIC_DRAW,!1),e._vertexBuffer.vertexDeclaration=ScreenQuad._vertexDeclaration,e._vertexBuffer.setData(ScreenQuad._vertices.buffer),e._bufferState.bind(),e._bufferState.applyVertexBuffer(e._vertexBuffer),e._bufferState.unBind(),e._vertexBufferInvertUV=new qe(64,r.STATIC_DRAW,!1),e._vertexBufferInvertUV.vertexDeclaration=ScreenQuad._vertexDeclaration,e._vertexBufferInvertUV.setData(ScreenQuad._verticesInvertUV.buffer),e._bufferStateInvertUV.bind(),e._bufferStateInvertUV.applyVertexBuffer(e._vertexBufferInvertUV),e._bufferStateInvertUV.unBind(),e._setGPUMemory(e._vertexBuffer._byteLength+e._vertexBufferInvertUV._byteLength),e}return _inherits(ScreenQuad,e),_createClass(ScreenQuad,[{key:"render",value:function(){var e=t.LayaGL.instance;this._bufferState.bind(),e.drawArrays(e.TRIANGLE_STRIP,0,4),t.Stat.renderBatches++}},{key:"renderInvertUV",value:function(){var e=t.LayaGL.instance;this._bufferStateInvertUV.bind(),e.drawArrays(e.TRIANGLE_STRIP,0,4),t.Stat.renderBatches++}},{key:"destroy",value:function(){_get(_getPrototypeOf(ScreenQuad.prototype),"destroy",this).call(this),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferStateInvertUV.destroy(),this._vertexBufferInvertUV.destroy(),this._setGPUMemory(0)}}],[{key:"__init__",value:function(){ScreenQuad._vertexDeclaration=new je(16,[new Ze(0,Ye.Vector4,ScreenQuad.SCREENQUAD_POSITION_UV)]),ScreenQuad.instance=new ScreenQuad,ScreenQuad.instance.lock=!0}}]),ScreenQuad}(t.Resource);nt.SCREENQUAD_POSITION_UV=0,nt._vertices=new Float32Array([1,1,1,1,1,-1,1,0,-1,1,0,1,-1,-1,0,0]),nt._verticesInvertUV=new Float32Array([1,1,1,0,1,-1,1,1,-1,1,0,0,-1,-1,0,1]);var it=function(e){function ScreenTriangle(){var e;_classCallCheck(this,ScreenTriangle),(e=_possibleConstructorReturn(this,_getPrototypeOf(ScreenTriangle).call(this)))._bufferState=new We,e._bufferStateInvertUV=new We;var r=t.LayaGL.instance;return e._vertexBuffer=new qe(48,r.STATIC_DRAW,!1),e._vertexBuffer.vertexDeclaration=ScreenTriangle._vertexDeclaration,e._vertexBuffer.setData(ScreenTriangle._vertices.buffer),e._bufferState.bind(),e._bufferState.applyVertexBuffer(e._vertexBuffer),e._bufferState.unBind(),e._vertexBufferInvertUV=new qe(48,r.STATIC_DRAW,!1),e._vertexBufferInvertUV.vertexDeclaration=ScreenTriangle._vertexDeclaration,e._vertexBufferInvertUV.setData(ScreenTriangle._verticesInvertUV.buffer),e._bufferStateInvertUV.bind(),e._bufferStateInvertUV.applyVertexBuffer(e._vertexBufferInvertUV),e._bufferStateInvertUV.unBind(),e._setGPUMemory(e._vertexBuffer._byteLength+e._vertexBufferInvertUV._byteLength),e}return _inherits(ScreenTriangle,e),_createClass(ScreenTriangle,[{key:"render",value:function(){var e=t.LayaGL.instance;this._bufferState.bind(),e.drawArrays(e.TRIANGLES,0,3),t.Stat.renderBatches++}},{key:"renderInvertUV",value:function(){var e=t.LayaGL.instance;this._bufferStateInvertUV.bind(),e.drawArrays(e.TRIANGLES,0,3),t.Stat.renderBatches++}},{key:"destroy",value:function(){_get(_getPrototypeOf(ScreenTriangle.prototype),"destroy",this).call(this),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferStateInvertUV.destroy(),this._vertexBufferInvertUV.destroy(),this._setGPUMemory(0)}}],[{key:"__init__",value:function(){ScreenTriangle._vertexDeclaration=new je(16,[new Ze(0,Ye.Vector4,ScreenTriangle.SCREENTRIANGLE_POSITION_UV)]),ScreenTriangle.instance=new ScreenTriangle,ScreenTriangle.instance.lock=!0}}]),ScreenTriangle}(t.Resource);it.SCREENTRIANGLE_POSITION_UV=0,it._vertices=new Float32Array([-1,-1,0,0,-1,3,0,2,3,-1,2,0]),it._verticesInvertUV=new Float32Array([-1,-1,0,1,-1,3,0,-1,3,-1,2,1]);var at=function(){function Command(){_classCallCheck(this,Command),this._commandBuffer=null}return _createClass(Command,[{key:"run",value:function(){}},{key:"recover",value:function(){this._commandBuffer=null}}],[{key:"__init__",value:function(){Command._screenShaderData=new ce,Command._screenShader=ue.find("BlitScreen")}}]),Command}();at.SCREENTEXTURE_NAME="u_MainTex",at.SCREENTEXTUREOFFSETSCALE_NAME="u_OffsetScale",at.MAINTEXTURE_TEXELSIZE_NAME="u_MainTex_TexelSize",at.SCREENTEXTURE_ID=ue.propertyNameToID(at.SCREENTEXTURE_NAME),at.SCREENTEXTUREOFFSETSCALE_ID=ue.propertyNameToID(at.SCREENTEXTUREOFFSETSCALE_NAME),at.MAINTEXTURE_TEXELSIZE_ID=ue.propertyNameToID(at.MAINTEXTURE_TEXELSIZE_NAME);var ot=function(e){function BlitScreenQuadCMD(){var e;return _classCallCheck(this,BlitScreenQuadCMD),(e=_possibleConstructorReturn(this,_getPrototypeOf(BlitScreenQuadCMD).apply(this,arguments)))._source=null,e._dest=null,e._offsetScale=null,e._shader=null,e._shaderData=null,e._subShader=0,e._sourceTexelSize=new i,e._screenType=0,e}return _inherits(BlitScreenQuadCMD,e),_createClass(BlitScreenQuadCMD,[{key:"run",value:function(){var e=this._shader||at._screenShader,r=this._shaderData||at._screenShaderData,n=this._dest;t.LayaGL.instance.viewport(0,0,n?n.width:ne.clientWidth,n?n.height:ne.clientHeight),r.setTexture(at.SCREENTEXTURE_ID,this._source),r.setVector(at.SCREENTEXTUREOFFSETSCALE_ID,this._offsetScale||BlitScreenQuadCMD._defaultOffsetScale),this._sourceTexelSize.setValue(1/this._source.width,1/this._source.height,this._source.width,this._source.height),r.setVector(at.MAINTEXTURE_TEXELSIZE_ID,this._sourceTexelSize),n&&n._start();for(var i=e.getSubShaderAt(this._subShader)._passes,a=0,o=i.length;a<o;a++){var s=BlitScreenQuadCMD._compileDefine;r._defineDatas.cloneTo(s);var l=i[a].withCompile(s);switch(l.bind(),l.uploadUniforms(l._materialUniformParamsMap,r,!0),l.uploadRenderStateBlendDepth(r),l.uploadRenderStateFrontFace(r,!1,null),this._screenType){case BlitScreenQuadCMD._SCREENTYPE_QUAD:ne._instance.invertY?nt.instance.renderInvertUV():nt.instance.render();break;case BlitScreenQuadCMD._SCREENTYPE_TRIANGLE:ne._instance.invertY?it.instance.renderInvertUV():it.instance.render();break;default:throw"BlitScreenQuadCMD:unknown screen Type."}}n&&n._end()}},{key:"recover",value:function(){BlitScreenQuadCMD._pool.push(this),this._source=null,this._dest=null,this._offsetScale=null,this._shader=null,this._shaderData=null,_get(_getPrototypeOf(BlitScreenQuadCMD.prototype),"recover",this).call(this)}}],[{key:"create",value:function(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:BlitScreenQuadCMD._SCREENTYPE_QUAD;return(r=BlitScreenQuadCMD._pool.length>0?BlitScreenQuadCMD._pool.pop():new BlitScreenQuadCMD)._source=e,r._dest=t,r._offsetScale=n,r._shader=i,r._shaderData=a,r._subShader=o,r._screenType=s,r}}]),BlitScreenQuadCMD}(at);ot._SCREENTYPE_QUAD=0,ot._SCREENTYPE_TRIANGLE=1,ot._compileDefine=new ae,ot._pool=[],ot._defaultOffsetScale=new i(0,0,1,1);var st=function(e){function SetRenderTargetCMD(){var e;return _classCallCheck(this,SetRenderTargetCMD),(e=_possibleConstructorReturn(this,_getPrototypeOf(SetRenderTargetCMD).apply(this,arguments)))._renderTexture=null,e}return _inherits(SetRenderTargetCMD,e),_createClass(SetRenderTargetCMD,[{key:"run",value:function(){this._renderTexture._start()}},{key:"recover",value:function(){SetRenderTargetCMD._pool.push(this),this._renderTexture=null}}],[{key:"create",value:function(e){var t;return(t=SetRenderTargetCMD._pool.length>0?SetRenderTargetCMD._pool.pop():new SetRenderTargetCMD)._renderTexture=e,t}}]),SetRenderTargetCMD}(at);st._pool=[];var lt=function(e){function SetShaderDataTextureCMD(){var e;return _classCallCheck(this,SetShaderDataTextureCMD),(e=_possibleConstructorReturn(this,_getPrototypeOf(SetShaderDataTextureCMD).apply(this,arguments)))._shaderData=null,e._nameID=0,e._texture=null,e}return _inherits(SetShaderDataTextureCMD,e),_createClass(SetShaderDataTextureCMD,[{key:"run",value:function(){this._shaderData.setTexture(this._nameID,this._texture)}},{key:"recover",value:function(){SetShaderDataTextureCMD._pool.push(this),this._shaderData=null,this._nameID=0,this._texture=null}}],[{key:"create",value:function(e,t,r){var n;return(n=SetShaderDataTextureCMD._pool.length>0?SetShaderDataTextureCMD._pool.pop():new SetShaderDataTextureCMD)._shaderData=e,n._nameID=t,n._texture=r,n}}]),SetShaderDataTextureCMD}(at);lt._pool=[];var ut,ct=function(){function CommandBuffer(){_classCallCheck(this,CommandBuffer),this._camera=null,this._commands=[]}return _createClass(CommandBuffer,[{key:"_apply",value:function(){for(var e=0,t=this._commands.length;e<t;e++)this._commands[e].run()}},{key:"setShaderDataTexture",value:function(e,t,r){this._commands.push(lt.create(e,t,r))}},{key:"blitScreenQuad",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;this._commands.push(ot.create(e,t,r,n,i,a,ot._SCREENTYPE_QUAD))}},{key:"blitScreenTriangle",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;this._commands.push(ot.create(e,t,r,n,i,a,ot._SCREENTYPE_TRIANGLE))}},{key:"setRenderTarget",value:function(e){this._commands.push(st.create(e))}},{key:"clear",value:function(){for(var e=0,t=this._commands.length;e<t;e++)this._commands[e].recover();this._commands.length=0}}]),CommandBuffer}(),ht=function Scene3DShaderDeclaration(){_classCallCheck(this,Scene3DShaderDeclaration)};(ut=e.LightType||(e.LightType={}))[ut.Directional=0]="Directional",ut[ut.Spot=1]="Spot",ut[ut.Point=2]="Point";var _t,dt,ft=function(t){function LightSprite(){var t;return _classCallCheck(this,LightSprite),(t=_possibleConstructorReturn(this,_getPrototypeOf(LightSprite).call(this)))._shadowMode=e.ShadowMode.None,t._isAlternate=!1,t._shadowResolution=2048,t._shadowDistance=50,t._shadowDepthBias=1,t._shadowNormalBias=1,t._shadowNearPlane=.1,t._shadowStrength=1,t._lightWoldMatrix=new c,t._intensity=1,t._intensityColor=new o,t.color=new o(1,1,1),t._lightmapBakedType=LightSprite.LIGHTMAPBAKEDTYPE_REALTIME,t}return _inherits(LightSprite,t),_createClass(LightSprite,[{key:"_parse",value:function(e,t){_get(_getPrototypeOf(LightSprite.prototype),"_parse",this).call(this,e,t);var r=e.color;this.color.fromArray(r),this.intensity=e.intensity,this.lightmapBakedType=e.lightmapBakedType}},{key:"_addToScene",value:function(){var e=this._scene,t=w._config.maxLightCount;e._lightCount<t?(e._lightCount++,this._addToLightQueue(),this._isAlternate=!1):(e._alternateLights.add(this),this._isAlternate=!0,console.warn("LightSprite:light count has large than maxLightCount,the latest added light will be ignore."))}},{key:"_removeFromScene",value:function(){var e=this._scene;if(this._isAlternate)e._alternateLights.remove(this);else if(e._lightCount--,this._removeFromLightQueue(),e._alternateLights._length>0){var t=e._alternateLights.shift();t._addToLightQueue(),t._isAlternate=!1,e._lightCount++}}},{key:"_addToLightQueue",value:function(){}},{key:"_removeFromLightQueue",value:function(){}},{key:"_onActive",value:function(){_get(_getPrototypeOf(LightSprite.prototype),"_onActive",this).call(this),this.lightmapBakedType!==LightSprite.LIGHTMAPBAKEDTYPE_BAKED&&this._addToScene()}},{key:"_onInActive",value:function(){_get(_getPrototypeOf(LightSprite.prototype),"_onInActive",this).call(this),this.lightmapBakedType!==LightSprite.LIGHTMAPBAKEDTYPE_BAKED&&this._removeFromScene()}},{key:"_create",value:function(){return new LightSprite}},{key:"intensity",get:function(){return this._intensity},set:function(e){this._intensity=e}},{key:"shadowMode",get:function(){return this._shadowMode},set:function(e){this._shadowMode=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=e}},{key:"shadowResolution",get:function(){return this._shadowResolution},set:function(e){this._shadowResolution=e}},{key:"shadowDepthBias",get:function(){return this._shadowDepthBias},set:function(e){this._shadowDepthBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"shadowStrength",get:function(){return this._shadowStrength},set:function(e){this._shadowStrength=e}},{key:"shadowNearPlane",get:function(){return this._shadowNearPlane},set:function(e){this._shadowNearPlane=e}},{key:"lightmapBakedType",get:function(){return this._lightmapBakedType},set:function(e){this._lightmapBakedType!==e&&(this._lightmapBakedType=e,this.activeInHierarchy&&(e!==LightSprite.LIGHTMAPBAKEDTYPE_BAKED?this._addToScene():this._removeFromScene()))}},{key:"lightWorldMatrix",get:function(){var e=this.transform.position,t=this.transform.rotation;return c.createAffineTransformation(e,t,o._ONE,this._lightWoldMatrix),this._lightWoldMatrix}},{key:"diffuseColor",get:function(){return console.log("LightSprite: discard property,please use color property instead."),this.color},set:function(e){console.log("LightSprite: discard property,please use color property instead."),this.color=e}}]),LightSprite}(et);ft.LIGHTMAPBAKEDTYPE_REALTIME=0,ft.LIGHTMAPBAKEDTYPE_MIXED=1,ft.LIGHTMAPBAKEDTYPE_BAKED=2,(_t=e.ShadowCascadesMode||(e.ShadowCascadesMode={}))[_t.NoCascades=0]="NoCascades",_t[_t.TwoCascades=1]="TwoCascades",_t[_t.FourCascades=2]="FourCascades",function(e){e[e.Near=0]="Near",e[e.Far=1]="Far",e[e.Left=2]="Left",e[e.Right=3]="Right",e[e.Bottom=4]="Bottom",e[e.Top=5]="Top"}(dt||(dt={}));var mt,Tt=function(){function ShadowUtils(){_classCallCheck(this,ShadowUtils)}return _createClass(ShadowUtils,null,[{key:"supportShadow",value:function(){return t.LayaGL.layaGPUInstance._isWebGL2||t.SystemUtils.supportRenderTextureFormat(t.RenderTextureFormat.Depth)}},{key:"init",value:function(){t.LayaGL.layaGPUInstance._isWebGL2?ShadowUtils._shadowTextureFormat=t.RenderTextureFormat.ShadowMap:ShadowUtils._shadowTextureFormat=t.RenderTextureFormat.Depth}},{key:"getTemporaryShadowTexture",value:function(e,r,n){var i=ie.createFromPool(e,r,ShadowUtils._shadowTextureFormat,n);return i.filterMode=t.FilterMode.Bilinear,i.wrapModeU=t.WarpMode.Clamp,i.wrapModeV=t.WarpMode.Clamp,i}},{key:"getShadowBias",value:function(t,n,i,a){var o;t._lightType==e.LightType.Directional?o=2/n.elements[0]:t._lightType==e.LightType.Spot?o=Math.tan(.5*t.spotAngle*r.Deg2Rad)*t.range:(console.warn("ShadowUtils:Only spot and directional shadow casters are supported now."),o=0);var s=o/i,l=-t._shadowDepthBias*s,u=-t._shadowNormalBias*s;if(t.shadowMode==e.ShadowMode.SoftHigh){l*=2.5,u*=2.5}a.setValue(l,u,0,0)}},{key:"getCameraFrustumPlanes",value:function(e,t){Ue.getPlanesFromMatrix(e,t[dt.Near],t[dt.Far],t[dt.Left],t[dt.Right],t[dt.Top],t[dt.Bottom])}},{key:"getFarWithRadius",value:function(e,t){return Math.sqrt(e*e/t)}},{key:"getCascadesSplitDistance",value:function(t,r,n,i,a,o,s,l){l[0]=n;var u=i-n,c=Math.tan(.5*a),h=1+c*c*(o*o+1);switch(s){case e.ShadowCascadesMode.NoCascades:l[1]=ShadowUtils.getFarWithRadius(i,h);break;case e.ShadowCascadesMode.TwoCascades:l[1]=ShadowUtils.getFarWithRadius(n+u*t,h),l[2]=ShadowUtils.getFarWithRadius(i,h);break;case e.ShadowCascadesMode.FourCascades:l[1]=ShadowUtils.getFarWithRadius(n+u*r.x,h),l[2]=ShadowUtils.getFarWithRadius(n+u*r.y,h),l[3]=ShadowUtils.getFarWithRadius(n+u*r.z,h),l[4]=ShadowUtils.getFarWithRadius(i,h)}}},{key:"applySliceTransform",value:function(e,t,r,n,i){var a=ShadowUtils._tempMatrix0.elements,o=1/t,s=1/r;a[0]=e.resolution*o,a[5]=e.resolution*s,a[12]=e.offsetX*o,a[13]=e.offsetY*s,a[1]=a[2]=a[2]=a[4]=a[6]=a[7]=a[8]=a[9]=a[11]=a[14]=0,a[10]=a[15]=1;var l=16*n;P._mulMatrixArray(a,i,l,i,l)}},{key:"getDirectionLightShadowCullPlanes",value:function(t,r,n,i,a,s){var l=ShadowUtils._frustumCorners,u=ShadowUtils._backPlaneFaces,c=ShadowUtils._frustumPlaneNeighbors,h=ShadowUtils._frustumTwoPlaneCorners,_=ShadowUtils._edgePlanePoint2,d=s.cullPlanes,f=t[dt.Near],m=t[dt.Far],T=t[dt.Left],p=t[dt.Right],g=t[dt.Bottom],E=t[dt.Top],y=n[r]-i,S=ShadowUtils._adjustNearPlane,v=ShadowUtils._adjustFarPlane;f.normal.cloneTo(S.normal),m.normal.cloneTo(v.normal),S.distance=f.distance-y,v.distance=Math.min(-f.distance+s.sphereCenterZ+s.splitBoundSphere.radius,m.distance),Ue.get3PlaneInterPoint(S,g,p,l[e.FrustumCorner.nearBottomRight]),Ue.get3PlaneInterPoint(S,E,p,l[e.FrustumCorner.nearTopRight]),Ue.get3PlaneInterPoint(S,E,T,l[e.FrustumCorner.nearTopLeft]),Ue.get3PlaneInterPoint(S,g,T,l[e.FrustumCorner.nearBottomLeft]),Ue.get3PlaneInterPoint(v,g,p,l[e.FrustumCorner.FarBottomRight]),Ue.get3PlaneInterPoint(v,E,p,l[e.FrustumCorner.FarTopRight]),Ue.get3PlaneInterPoint(v,E,T,l[e.FrustumCorner.FarTopLeft]),Ue.get3PlaneInterPoint(v,g,T,l[e.FrustumCorner.FarBottomLeft]);for(var R=0,C=0;C<6;C++){var M;switch(C){case dt.Near:M=S;break;case dt.Far:M=v;break;default:M=t[C]}o.dot(M.normal,a)<0&&(M.cloneTo(d[R]),u[R]=C,R++)}var D=R;for(C=0;C<R;C++)for(var x=u[C],A=c[x],I=0;I<4;I++){for(var L=A[I],P=!0,O=0;O<R;O++)if(L==u[O]){P=!1;break}if(P){var N=h[x][L],b=l[N[0]],k=l[N[1]];o.add(b,a,_),ke.createPlaneBy3P(b,k,_,d[D++])}}s.cullPlaneCount=D}},{key:"getBoundSphereByFrustum",value:function(e,t,r,n,i,a,s){var l,u,c=Math.sqrt(1+n*n)*Math.tan(r/2),h=c*c,_=t-e,d=t+e;h>_/d?(l=t,u=t*c):(l=.5*d*(1+h),u=.5*Math.sqrt(_*_+2*(t*t+e*e)*h+d*d*h*h));var f=s.center;return s.radius=u,o.scale(a,l,f),o.add(i,f,f),l}},{key:"getMaxTileResolutionInAtlas",value:function(e,t,r){for(var n=Math.min(e,t),i=Math.floor(e/n)*Math.floor(t/n);i<r;)n=Math.floor(n>>1),i=Math.floor(e/n)*Math.floor(t/n);return n}},{key:"getDirectionalLightMatrices",value:function(e,t,r,n,i,a,s,l){var u=s.splitBoundSphere,h=u.center,_=u.radius,d=a/2,f=_*d/(d-ShadowUtils.atlasBorderSize),m=2*f,T=a/m,p=m/a,g=Math.ceil(o.dot(h,e)*T)*p,E=Math.ceil(o.dot(h,t)*T)*p,y=o.dot(h,r);h.x=e.x*g+t.x*E+r.x*y,h.y=e.y*g+t.y*E+r.y*y,h.z=e.z*g+t.z*E+r.z*y;var S=s.position,v=s.viewMatrix,R=s.projectionMatrix,C=s.viewProjectMatrix;s.resolution=a,s.offsetX=n%2*a,s.offsetY=Math.floor(n/2)*a,o.scale(r,_+i,S),o.subtract(h,S,S),c.createLookAt(S,h,e,v),c.createOrthoOffCenter(-f,f,-f,f,0,2*_+i,R),c.multiply(R,v,C),P._mulMatrixArray(ShadowUtils._shadowMapScaleOffsetMatrix.elements,C.elements,0,l,16*n)}},{key:"getSpotLightShadowData",value:function(e,t,r,n,i,a){var o=e.position=t.transform.position;e.resolution=r,a.setValue(1/r,1/r,r,r),e.offsetX=0,e.offsetY=0;var s=t.lightWorldMatrix,l=e.viewMatrix,u=e.projectionMatrix,h=e.viewProjectMatrix,_=e.cameraCullInfo.boundFrustum;s.invert(l),c.createPerspective(3.1416*t.spotAngle/180,1,.1,t.range,u),n.y=t.shadowStrength,c.multiply(u,l,h),_.matrix=h,h.cloneTo(i),e.cameraCullInfo.position=o}},{key:"prepareShadowReceiverShaderValues",value:function(e,t,r,n,i,a,o,s,l){if(a.setValue(1/t,1/r,t,r),o.setValue(e._shadowStrength,0,0,0),i>1){for(var u=16*i,c=64;u<c;u++)s[u]=0;for(u=0;u<i;u++){var h=n[u].splitBoundSphere,_=h.center,d=h.radius,f=4*u;l[f]=_.x,l[f+1]=_.y,l[f+2]=_.z,l[f+3]=d*d}for(u=4*i,c=16;u<c;u++)l[u]=0}}}]),ShadowUtils}();Tt._tempMatrix0=new c,Tt._shadowMapScaleOffsetMatrix=new c(.5,0,0,0,0,.5,0,0,0,0,1,0,.5,.5,0,1),Tt._frustumCorners=[new o,new o,new o,new o,new o,new o,new o,new o],Tt._adjustNearPlane=new ke(new o),Tt._adjustFarPlane=new ke(new o),Tt._backPlaneFaces=new Array(5),Tt._edgePlanePoint2=new o,Tt._frustumPlaneNeighbors=[[dt.Left,dt.Right,dt.Top,dt.Bottom],[dt.Left,dt.Right,dt.Top,dt.Bottom],[dt.Near,dt.Far,dt.Top,dt.Bottom],[dt.Near,dt.Far,dt.Top,dt.Bottom],[dt.Near,dt.Far,dt.Left,dt.Right],[dt.Near,dt.Far,dt.Left,dt.Right]],Tt._frustumTwoPlaneCorners=[[[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.nearBottomLeft,e.FrustumCorner.nearTopLeft],[e.FrustumCorner.nearTopRight,e.FrustumCorner.nearBottomRight],[e.FrustumCorner.nearBottomRight,e.FrustumCorner.nearBottomLeft],[e.FrustumCorner.nearTopLeft,e.FrustumCorner.nearTopRight]],[[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.FarTopLeft,e.FrustumCorner.FarBottomLeft],[e.FrustumCorner.FarBottomRight,e.FrustumCorner.FarTopRight],[e.FrustumCorner.FarBottomLeft,e.FrustumCorner.FarBottomRight],[e.FrustumCorner.FarTopRight,e.FrustumCorner.FarTopLeft]],[[e.FrustumCorner.nearTopLeft,e.FrustumCorner.nearBottomLeft],[e.FrustumCorner.FarBottomLeft,e.FrustumCorner.FarTopLeft],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.nearBottomLeft,e.FrustumCorner.FarBottomLeft],[e.FrustumCorner.FarTopLeft,e.FrustumCorner.nearTopLeft]],[[e.FrustumCorner.nearBottomRight,e.FrustumCorner.nearTopRight],[e.FrustumCorner.FarTopRight,e.FrustumCorner.FarBottomRight],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.FarBottomRight,e.FrustumCorner.nearBottomRight],[e.FrustumCorner.nearTopRight,e.FrustumCorner.FarTopRight]],[[e.FrustumCorner.nearBottomLeft,e.FrustumCorner.nearBottomRight],[e.FrustumCorner.FarBottomRight,e.FrustumCorner.FarBottomLeft],[e.FrustumCorner.FarBottomLeft,e.FrustumCorner.nearBottomLeft],[e.FrustumCorner.nearBottomRight,e.FrustumCorner.FarBottomRight],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown]],[[e.FrustumCorner.nearTopRight,e.FrustumCorner.nearTopLeft],[e.FrustumCorner.FarTopLeft,e.FrustumCorner.FarTopRight],[e.FrustumCorner.nearTopLeft,e.FrustumCorner.FarTopLeft],[e.FrustumCorner.FarTopRight,e.FrustumCorner.nearTopRight],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown]]],Tt.atlasBorderSize=4,(mt=e.CameraClearFlags||(e.CameraClearFlags={}))[mt.SolidColor=0]="SolidColor",mt[mt.Sky=1]="Sky",mt[mt.DepthOnly=2]="DepthOnly",mt[mt.Nothing=3]="Nothing";var pt=function(r){function Camera(){var r,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;return _classCallCheck(this,Camera),(r=_possibleConstructorReturn(this,_getPrototypeOf(Camera).call(this,o,s)))._updateViewMatrix=!0,r._postProcess=null,r._enableHDR=!1,r._viewportParams=new i,r._projectionParams=new i,r._offScreenRenderTexture=null,r._internalRenderTexture=null,r._postProcessCommandBuffers=[],r._clusterPlaneCacheFlag=new n(-1,-1),r._screenOffsetScale=new i,r.enableRender=!0,r.clearFlag=e.CameraClearFlags.SolidColor,r._viewMatrix=new c,r._projectionMatrix=new c,r._projectionViewMatrix=new c,r._viewport=new Ge(0,0,0,0),r._normalizedViewport=new Ge(0,0,1,1),r._aspectRatio=a,r._boundFrustum=new Ue(new c),t.Render.supportWebGLPlusCulling&&(r._boundFrustumBuffer=new Float32Array(24)),r._calculateProjectionMatrix(),t.Laya.stage.on(t.Event.RESIZE,_assertThisInitialized(r),r._onScreenSizeChanged),r.transform.on(t.Event.TRANSFORM_CHANGED,_assertThisInitialized(r),r._onTransformChanged),r}return _inherits(Camera,r),_createClass(Camera,[{key:"_calculationViewport",value:function(e,t,r){var n=e.x*t,i=e.y*r,a=n+Math.max(e.width*t,0),o=i+Math.max(e.height*r,0),s=Math.ceil(n),l=Math.ceil(i),u=Math.floor(a),c=Math.floor(o),h=s-n>=.5?Math.floor(n):s,_=l-i>=.5?Math.floor(i):l,d=a-u>=.5?Math.ceil(a):u,f=o-c>=.5?Math.ceil(o):c;this._viewport.x=h,this._viewport.y=_,this._viewport.width=d-h,this._viewport.height=f-_}},{key:"_calculateProjectionMatrix",value:function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var e=.5*this.orthographicVerticalSize,t=e*this.aspectRatio;c.createOrthoOffCenter(-t,t,-e,e,this.nearPlane,this.farPlane,this._projectionMatrix)}else c.createPerspective(3.1416*this.fieldOfView/180,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix)}},{key:"_isLayerVisible",value:function(e){return 0!=(Math.pow(2,e)&this.cullingMask)}},{key:"_onTransformChanged",value:function(e){(e&=f.TRANSFORM_WORLDMATRIX)&&(this._updateViewMatrix=!0)}},{key:"_parse",value:function(e,t){_get(_getPrototypeOf(Camera.prototype),"_parse",this).call(this,e,t);var r=e.clearFlag;void 0!==r&&(this.clearFlag=r);var n=e.viewport;this.normalizedViewport=new Ge(n[0],n[1],n[2],n[3]);var i=e.enableHDR;void 0!==i&&(this.enableHDR=i)}},{key:"_getCanvasWidth",value:function(){return this._offScreenRenderTexture?this._offScreenRenderTexture.width:ne.clientWidth}},{key:"_getCanvasHeight",value:function(){return this._offScreenRenderTexture?this._offScreenRenderTexture.height:ne.clientHeight}},{key:"_getRenderTexture",value:function(){return this._internalRenderTexture||this._offScreenRenderTexture}},{key:"_needInternalRenderTexture",value:function(){return!(!this._postProcess&&!this._enableHDR)}},{key:"_applyPostProcessCommandBuffers",value:function(){for(var e=0,t=this._postProcessCommandBuffers.length;e<t;e++)this._postProcessCommandBuffers[e]._apply()}},{key:"_getRenderTextureFormat",value:function(){return this._enableHDR?t.RenderTextureFormat.R16G16B16A16:t.RenderTextureFormat.R8G8B8}},{key:"_prepareCameraToRender",value:function(){_get(_getPrototypeOf(Camera.prototype),"_prepareCameraToRender",this).call(this);var e=this.viewport;this._viewportParams.setValue(e.x,e.y,e.width,e.height),this._projectionParams.setValue(this._nearPlane,this._farPlane,ne._instance.invertY?-1:1,0),this._shaderValues.setVector(rt.VIEWPORT,this._viewportParams),this._shaderValues.setVector(rt.PROJECTION_PARAMS,this._projectionParams)}},{key:"_applyViewProject",value:function(e,t,r){var n,i=this._shaderValues;e.invertY?(c.multiply(rt._invertYScaleMatrix,r,rt._invertYProjectionMatrix),c.multiply(rt._invertYProjectionMatrix,t,rt._invertYProjectionViewMatrix),r=rt._invertYProjectionMatrix,n=rt._invertYProjectionViewMatrix):(c.multiply(r,t,this._projectionViewMatrix),n=this._projectionViewMatrix),e.viewMatrix=t,e.projectionMatrix=r,e.projectionViewMatrix=n,i.setMatrix4x4(rt.VIEWMATRIX,t),i.setMatrix4x4(rt.PROJECTMATRIX,r),i.setMatrix4x4(rt.VIEWPROJECTMATRIX,n)}},{key:"_updateClusterPlaneXY",value:function(){var e=this.fieldOfView,t=this.aspectRatio;if(this._clusterPlaneCacheFlag.x!==e||this._clusterPlaneCacheFlag.y!==t){var r=w._config.lightClusterCount,n=r.x,i=r.y,a=n+1,s=i+1,l=this._clusterXPlanes,u=this._clusterYPlanes;if(!l){l=this._clusterXPlanes=new Array(a),u=this._clusterYPlanes=new Array(s);for(var c=0;c<a;c++)l[c]=new o;for(c=0;c<s;c++)u[c]=new o}var h=Math.tan(this.fieldOfView/2*Math.PI/180),_=this.aspectRatio*h,d=2*h/n,f=2*_/i;for(c=0;c<a;c++){var m=f*c-_,T=1/Math.sqrt(1+m*m);l[c].setValue(T,0,-m*T)}for(c=0;c<s;c++){m=h-d*c;var p=-1/Math.sqrt(1+m*m);u[c].setValue(0,p,-m*p)}this._clusterPlaneCacheFlag.x=e,this._clusterPlaneCacheFlag.y=t}}},{key:"render",value:function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(this.activeInHierarchy){var i,a=this.viewport,o=this._needInternalRenderTexture(),s=t.LayaGL.instance,u=ne._instance,c=u.scene=this._scene;u.pipelineMode="Forward",o?(this._internalRenderTexture=ie.createFromPool(a.width,a.height,this._getRenderTextureFormat(),t.RenderTextureDepthFormat.DEPTH_16),this._internalRenderTexture.filterMode=t.FilterMode.Bilinear):this._internalRenderTexture=null;var h=c._mainDirectionLight,_=h&&h.shadowMode!==e.ShadowMode.None&&Tt.supportShadow();_?(c._shaderValues.removeDefine(ht.SHADERDEFINE_SHADOW_SPOT),c._shaderValues.addDefine(ht.SHADERDEFINE_SHADOW),(i=l.Scene3D._shadowCasterPass).update(this,h,l.ShadowLightType.DirectionLight),i.render(u,c,l.ShadowLightType.DirectionLight)):c._shaderValues.removeDefine(ht.SHADERDEFINE_SHADOW);var d=c._mainSpotLight,f=d&&d.shadowMode!==e.ShadowMode.None&&Tt.supportShadow();if(f?(c._shaderValues.removeDefine(ht.SHADERDEFINE_SHADOW),c._shaderValues.addDefine(ht.SHADERDEFINE_SHADOW_SPOT),(i=l.Scene3D._shadowCasterPass).update(this,d,l.ShadowLightType.SpotLight),i.render(u,c,l.ShadowLightType.SpotLight)):c._shaderValues.removeDefine(ht.SHADERDEFINE_SHADOW_SPOT),_&&c._shaderValues.addDefine(ht.SHADERDEFINE_SHADOW),f&&c._shaderValues.addDefine(ht.SHADERDEFINE_SHADOW_SPOT),u.camera=this,u.cameraShaderValue=this._shaderValues,Camera._updateMark++,c._preRenderScript(),o&&!this._offScreenRenderTexture&&(this.clearFlag==e.CameraClearFlags.DepthOnly||this.clearFlag==e.CameraClearFlags.Nothing))if(this._enableHDR){var m=ie.createFromPool(a.width,a.height,t.RenderTextureFormat.R8G8B8,t.RenderTextureDepthFormat.DEPTH_16);m.filterMode=t.FilterMode.Bilinear,t.WebGLContext.bindTexture(s,s.TEXTURE_2D,m._getSource()),s.copyTexSubImage2D(s.TEXTURE_2D,0,0,0,a.x,ne.clientHeight-(a.y+a.height),a.width,a.height),(g=ot.create(m,this._internalRenderTexture)).run(),g.recover(),ie.recoverToPool(m)}else t.WebGLContext.bindTexture(s,s.TEXTURE_2D,this._internalRenderTexture._getSource()),s.copyTexSubImage2D(s.TEXTURE_2D,0,0,0,a.x,ne.clientHeight-(a.y+a.height),a.width,a.height);var T=this._getRenderTexture();T&&T._start(),u.viewport=a,this._prepareCameraToRender();var p=w._config._multiLighting;if(p&&Pe.instance.update(this,this._scene),this._applyViewProject(u,this.viewMatrix,this._projectionMatrix),c._preCulling(u,this,r,n),c._clear(s,u),c._renderScene(u),c._postRenderScript(),T&&T._end(),o){if(this._postProcess)this._postProcess._render(),this._applyPostProcessCommandBuffers();else if(this._enableHDR){var g,E=this._getCanvasWidth(),y=this._getCanvasHeight();this._screenOffsetScale.setValue(a.x/E,a.y/y,a.width/E,a.height/y),(g=ot.create(this._internalRenderTexture,this._offScreenRenderTexture?this._offScreenRenderTexture:null,this._screenOffsetScale)).run(),g.recover()}ie.recoverToPool(this._internalRenderTexture)}(_||f)&&i.cleanUp()}}},{key:"viewportPointToRay",value:function(e,t){ze.calculateCursorRay(e,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)}},{key:"normalizedViewportPointToRay",value:function(e,t){var r=Camera._tempVector20,n=this.viewport;r.x=e.x*n.width,r.y=e.y*n.height,ze.calculateCursorRay(r,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)}},{key:"worldToViewportPoint",value:function(e,r){c.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.viewport.project(e,this._projectionViewMatrix,r),r.x=r.x/t.Laya.stage.clientScaleX,r.y=r.y/t.Laya.stage.clientScaleY}},{key:"worldToNormalizedViewportPoint",value:function(e,r){c.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.normalizedViewport.project(e,this._projectionViewMatrix,r),r.x=r.x/t.Laya.stage.clientScaleX,r.y=r.y/t.Laya.stage.clientScaleY}},{key:"convertScreenCoordToOrthographicCoord",value:function(e,r){if(this._orthographic){var n=ne.clientWidth,i=ne.clientHeight,a=this.orthographicVerticalSize*this.aspectRatio/n,s=this.orthographicVerticalSize/i;return r.x=(-n/2+e.x*t.Laya.stage.clientScaleX)*a,r.y=(i/2-e.y*t.Laya.stage.clientScaleY)*s,r.z=(this.nearPlane-this.farPlane)*(e.z+1)/2-this.nearPlane,o.transformCoordinate(r,this.transform.worldMatrix,r),!0}return!1}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._offScreenRenderTexture=null,this.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged),_get(_getPrototypeOf(Camera.prototype),"destroy",this).call(this,e)}},{key:"addCommandBuffer",value:function(e,t){switch(e){case Camera.CAMERAEVENT_POSTPROCESS:this._postProcessCommandBuffers.push(t),t._camera=this;break;default:throw"Camera:unknown event."}}},{key:"removeCommandBuffer",value:function(e,t){switch(e){case Camera.CAMERAEVENT_POSTPROCESS:var r=this._postProcessCommandBuffers.indexOf(t);-1!==r&&this._postProcessCommandBuffers.splice(r,1);break;default:throw"Camera:unknown event."}}},{key:"removeCommandBuffers",value:function(e){switch(e){case Camera.CAMERAEVENT_POSTPROCESS:this._postProcessCommandBuffers.length=0;break;default:throw"Camera:unknown event."}}},{key:"_create",value:function(){return new Camera}},{key:"aspectRatio",get:function(){if(0===this._aspectRatio){var e=this.viewport;return e.width/e.height}return this._aspectRatio},set:function(e){if(e<0)throw new Error("Camera: the aspect ratio has to be a positive real number.");this._aspectRatio=e,this._calculateProjectionMatrix()}},{key:"viewport",get:function(){return this._offScreenRenderTexture?this._calculationViewport(this._normalizedViewport,this._offScreenRenderTexture.width,this._offScreenRenderTexture.height):this._calculationViewport(this._normalizedViewport,ne.clientWidth,ne.clientHeight),this._viewport},set:function(e){var t,r;this._offScreenRenderTexture?(t=this._offScreenRenderTexture.width,r=this._offScreenRenderTexture.height):(t=ne.clientWidth,r=ne.clientHeight),this._normalizedViewport.x=e.x/t,this._normalizedViewport.y=e.y/r,this._normalizedViewport.width=e.width/t,this._normalizedViewport.height=e.height/r,this._calculationViewport(this._normalizedViewport,t,r),this._calculateProjectionMatrix()}},{key:"normalizedViewport",get:function(){return this._normalizedViewport},set:function(e){var t,r;this._offScreenRenderTexture?(t=this._offScreenRenderTexture.width,r=this._offScreenRenderTexture.height):(t=ne.clientWidth,r=ne.clientHeight),this._normalizedViewport!==e&&e.cloneTo(this._normalizedViewport),this._calculationViewport(e,t,r),this._calculateProjectionMatrix()}},{key:"viewMatrix",get:function(){if(this._updateViewMatrix){var e=this.transform.getWorldLossyScale(),t=e.x,r=e.y,n=e.z,i=this._viewMatrix.elements;this.transform.worldMatrix.cloneTo(this._viewMatrix),i[0]/=t,i[1]/=t,i[2]/=t,i[4]/=r,i[5]/=r,i[6]/=r,i[8]/=n,i[9]/=n,i[10]/=n,this._viewMatrix.invert(this._viewMatrix),this._updateViewMatrix=!1}return this._viewMatrix}},{key:"projectionMatrix",get:function(){return this._projectionMatrix},set:function(e){this._projectionMatrix=e,this._useUserProjectionMatrix=!0}},{key:"projectionViewMatrix",get:function(){return c.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._projectionViewMatrix}},{key:"boundFrustum",get:function(){if(this._boundFrustum.matrix=this.projectionViewMatrix,t.Render.supportWebGLPlusCulling){var e=this._boundFrustum.near,r=this._boundFrustum.far,n=this._boundFrustum.left,i=this._boundFrustum.right,a=this._boundFrustum.top,o=this._boundFrustum.bottom,s=e.normal,l=r.normal,u=n.normal,c=i.normal,h=a.normal,_=o.normal,d=this._boundFrustumBuffer;d[0]=s.x,d[1]=s.y,d[2]=s.z,d[3]=e.distance,d[4]=l.x,d[5]=l.y,d[6]=l.z,d[7]=r.distance,d[8]=u.x,d[9]=u.y,d[10]=u.z,d[11]=n.distance,d[12]=c.x,d[13]=c.y,d[14]=c.z,d[15]=i.distance,d[16]=h.x,d[17]=h.y,d[18]=h.z,d[19]=a.distance,d[20]=_.x,d[21]=_.y,d[22]=_.z,d[23]=o.distance}return this._boundFrustum}},{key:"renderTarget",get:function(){return this._offScreenRenderTexture},set:function(e){var t=this._offScreenRenderTexture;t!==e&&(t&&(t._isCameraTarget=!1),e&&(e._isCameraTarget=!0),this._offScreenRenderTexture=e,this._calculateProjectionMatrix())}},{key:"postProcess",get:function(){return this._postProcess},set:function(e){this._postProcess=e;var t=new ct;this.addCommandBuffer(Camera.CAMERAEVENT_POSTPROCESS,t),e._init(this,t)}},{key:"enableHDR",get:function(){return this._enableHDR},set:function(e){!e||t.SystemUtils.supportRenderTextureFormat(t.RenderTextureFormat.R16G16B16A16)?this._enableHDR=e:console.warn("Camera:can't enable HDR in this device.")}}]),Camera}(rt);pt.CAMERAEVENT_POSTPROCESS=0,pt._tempVector20=new n,pt._updateMark=0;var gt=function(){function Input3D(){var e=this;_classCallCheck(this,Input3D),this._eventList=[],this._mouseTouch=new Ne,this._touchPool=[],this._touches=new Me,this._multiTouchEnabled=!0,this._pushEventList=function(t){t.cancelable&&t.preventDefault(),e._eventList.push(t)}.bind(this)}return _createClass(Input3D,[{key:"__init__",value:function(e,t){this._scene=t,e.oncontextmenu=function(e){return!1}}},{key:"_onCanvasEvent",value:function(e){e.addEventListener("mousedown",this._pushEventList),e.addEventListener("mouseup",this._pushEventList,!0),e.addEventListener("mousemove",this._pushEventList,!0),e.addEventListener("touchstart",this._pushEventList),e.addEventListener("touchend",this._pushEventList,!0),e.addEventListener("touchmove",this._pushEventList,!0),e.addEventListener("touchcancel",this._pushEventList,!0)}},{key:"_offCanvasEvent",value:function(e){e.removeEventListener("mousedown",this._pushEventList),e.removeEventListener("mouseup",this._pushEventList,!0),e.removeEventListener("mousemove",this._pushEventList,!0),e.removeEventListener("touchstart",this._pushEventList),e.removeEventListener("touchend",this._pushEventList,!0),e.removeEventListener("touchmove",this._pushEventList,!0),e.removeEventListener("touchcancel",this._pushEventList,!0),this._eventList.length=0,this._touches.clear()}},{key:"touchCount",value:function(){return this._touches.length}},{key:"_getTouch",value:function(e,t){var r=this._touchPool[e];return 0==t&&r&&-1!=r._getIndexInList()?null:1==t&&r&&-1==r._getIndexInList()?null:(r||(r=new be,this._touchPool[e]=r,r._identifier=e),r)}},{key:"_mouseTouchDown",value:function(){var e=this._mouseTouch,r=e.sprite;if(e._pressedSprite=r,e._pressedLoopCount=t.Stat.loopCount,r){var n=r._scripts;if(n)for(var i=0,a=n.length;i<a;i++)n[i].onMouseDown()}}},{key:"_mouseTouchUp",value:function(){var e,t,r=this._mouseTouch,n=r._pressedSprite;r._pressedSprite=null,r._pressedLoopCount=-1;var i=r.sprite;if(i&&i===n){var a=i._scripts;if(a)for(e=0,t=a.length;e<t;e++)a[e].onMouseClick()}if(n){var o=n._scripts;if(o)for(e=0,t=o.length;e<t;e++)o[e].onMouseUp()}}},{key:"_mouseTouchRayCast",value:function(t){var r=Input3D._tempHitResult0,n=Input3D._tempVector20,i=Input3D._tempRay0;r.succeeded=!1;var a=this._mouseTouch.mousePositionX,o=this._mouseTouch.mousePositionY;n.x=a,n.y=o;for(var s=t.length-1;s>=0;s--){var l=t[s],u=l.viewport;if(n.x>=u.x&&n.y>=u.y&&n.x<=u.width&&n.y<=u.height)if(l.viewportPointToRay(n,i),this._scene._physicsSimulation.rayCast(i,r)||l.clearFlag===e.CameraClearFlags.SolidColor||l.clearFlag===e.CameraClearFlags.Sky)break}var c=this._mouseTouch,h=c.sprite;if(r.succeeded){var _=r.collider.owner;c.sprite=_;var d=_._scripts;if(h!==_&&d)for(var f=0,m=d.length;f<m;f++)d[f].onMouseEnter()}else c.sprite=null;if(h&&h!==_){var T=h._scripts;if(T)for(f=0,m=T.length;f<m;f++)T[f].onMouseOut()}}},{key:"_changeTouches",value:function(e,r){for(var n=0,i=0,a=this._touches.length,o=0,s=e.length;o<s;o++){var l=e[o],u=l.identifier;if(this._multiTouchEnabled||0===u){var c=this._getTouch(u,r),h=this._touchPool[u]._position,_=Input3D._tempPoint;_.setTo(l.pageX,l.pageY),t.ILaya.stage._canvasTransform.invertTransformPoint(_);var d=_.x,f=_.y;switch(r){case 0:c&&this._touches.add(c),n+=d,i+=f;break;case 1:c&&this._touches.remove(c),n-=d,i-=f;break;case 2:n=d-h.x,i=f-h.y}h.x=d,h.y=f}}var m=this._touches.length;0===m?(this._mouseTouch.mousePositionX=0,this._mouseTouch.mousePositionY=0):(this._mouseTouch.mousePositionX=(this._mouseTouch.mousePositionX*a+n)/m,this._mouseTouch.mousePositionY=(this._mouseTouch.mousePositionY*a+i)/m)}},{key:"_update",value:function(){var e,r,n,i,a=k._enablePhysics&&!I.disableSimulation;r=this._eventList.length;var o=this._scene._cameraPool;if(r>0){var s=!1;for(e=0;e<r;e++){var l=this._eventList[e];switch(l.type){case"mousedown":a&&this._mouseTouchDown();break;case"mouseup":a&&this._mouseTouchUp();break;case"mousemove":var u=Input3D._tempPoint;u.setTo(l.pageX,l.pageY),t.ILaya.stage._canvasTransform.invertTransformPoint(u),this._mouseTouch.mousePositionX=u.x,this._mouseTouch.mousePositionY=u.y,a&&(s=!0);break;case"touchstart":var c=this._touches.length;this._changeTouches(l.changedTouches,0),a&&(!w._config.isUseCannonPhysicsEngine&&this._mouseTouchRayCast(o),0===c&&this._mouseTouchDown());break;case"touchend":case"touchcancel":this._changeTouches(l.changedTouches,1),a&&0===this._touches.length&&this._mouseTouchUp();break;case"touchmove":this._changeTouches(l.changedTouches,2),a&&(s=!0);break;default:throw"Input3D:unkonwn event type."}}s&&!w._config.isUseCannonPhysicsEngine&&this._mouseTouchRayCast(o),this._eventList.length=0}if(a){var h=this._mouseTouch,_=h._pressedSprite;if(_&&t.Stat.loopCount>h._pressedLoopCount){var d=_._scripts;if(d)for(n=0,i=d.length;n<i;n++)d[n].onMouseDrag()}var f=h.sprite;if(f){var m=f._scripts;if(m)for(n=0,i=m.length;n<i;n++)m[n].onMouseOver()}}}},{key:"getTouch",value:function(e){return e<this._touches.length?this._touches.elements[e]:null}},{key:"multiTouchEnabled",get:function(){return this._multiTouchEnabled},set:function(e){this._multiTouchEnabled=e}}]),Input3D}();gt._tempPoint=new t.Point,gt._tempVector20=new n,gt._tempRay0=new we(new o,new o),gt._tempHitResult0=new D;var Et,yt=function PhysicsSettings(){_classCallCheck(this,PhysicsSettings),this.flags=0,this.maxSubSteps=1,this.fixedTimeStep=1/60},St=function(){function VertexPositionTexture0(e,t){_classCallCheck(this,VertexPositionTexture0),this._position=e,this._textureCoordinate0=t}return _createClass(VertexPositionTexture0,[{key:"position",get:function(){return this._position}},{key:"textureCoordinate0",get:function(){return this._textureCoordinate0}},{key:"vertexDeclaration",get:function(){return VertexPositionTexture0._vertexDeclaration}}],[{key:"__init__",value:function(){VertexPositionTexture0._vertexDeclaration=new je(20,[new Ze(0,Ye.Vector3,Qe.MESH_POSITION0),new Ze(12,Ye.Vector2,Qe.MESH_TEXTURECOORDINATE0)])}},{key:"vertexDeclaration",get:function(){return VertexPositionTexture0._vertexDeclaration}}]),VertexPositionTexture0}(),vt=function(r){function SkyDome(){var r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:48,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:48;_classCallCheck(this,SkyDome),r=_possibleConstructorReturn(this,_getPrototypeOf(SkyDome).call(this));var a=t.LayaGL.instance;r._stacks=n,r._slices=i;for(var o=St.vertexDeclaration,s=o.vertexStride/4,l=(r._stacks+1)*(r._slices+1),u=3*r._stacks*(r._slices+1)*2,c=new Float32Array(l*s),h=new Uint16Array(u),_=Math.PI/r._stacks,d=2*Math.PI/r._slices,f=0,m=0,T=0,p=0;p<r._stacks+1;p++)for(var g=Math.sin(p*_),E=Math.cos(p*_),y=0;y<r._slices+1;y++){var S=g*Math.sin(y*d),v=g*Math.cos(y*d);c[m+0]=S*SkyDome._radius,c[m+1]=E*SkyDome._radius,c[m+2]=v*SkyDome._radius,c[m+3]=-y/r._slices+.75,c[m+4]=p/r._stacks,m+=s,p!=r._stacks-1&&(h[T++]=f+1,h[T++]=f,h[T++]=f+(r._slices+1),h[T++]=f+(r._slices+1),h[T++]=f,h[T++]=f+r._slices,f++)}r._vertexBuffer=new qe(4*c.length,a.STATIC_DRAW,!1),r._vertexBuffer.vertexDeclaration=o,r._indexBuffer=new Xe(e.IndexFormat.UInt16,h.length,a.STATIC_DRAW,!1),r._vertexBuffer.setData(c.buffer),r._indexBuffer.setData(h);var R=new We;return R.bind(),R.applyVertexBuffer(r._vertexBuffer),R.applyIndexBuffer(r._indexBuffer),R.unBind(),r._bufferState=R,r}return _inherits(SkyDome,r),_createClass(SkyDome,[{key:"_render",value:function(e){var r=t.LayaGL.instance,n=this._indexBuffer.indexCount;r.drawElements(r.TRIANGLES,n,r.UNSIGNED_SHORT,0),t.Stat.trianglesFaces+=n/3,t.Stat.renderBatches++}},{key:"stacks",get:function(){return this._stacks}},{key:"slices",get:function(){return this._slices}}],[{key:"__init__",value:function(){SkyDome.instance=new SkyDome}}]),SkyDome}(Ke);vt._radius=1,(Et=e.TextureCubeFace||(e.TextureCubeFace={}))[Et.PositiveX=0]="PositiveX",Et[Et.NegativeX=1]="NegativeX",Et[Et.PositiveY=2]="PositiveY",Et[Et.NegativeY=3]="NegativeY",Et[Et.PositiveZ=4]="PositiveZ",Et[Et.NegativeZ=5]="NegativeZ";var Rt=function(r){function TextureCube(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.TextureFormat.R8G8B8,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];_classCallCheck(this,TextureCube),(r=_possibleConstructorReturn(this,_getPrototypeOf(TextureCube).call(this,n,i)))._glTextureType=t.LayaGL.instance.TEXTURE_CUBE_MAP,r._width=e,r._height=e;var a=t.LayaGL.instance;if(r._setWarpMode(a.TEXTURE_WRAP_S,r._wrapModeU),r._setWarpMode(a.TEXTURE_WRAP_T,r._wrapModeV),r._setFilterMode(r._filterMode),r._setAnisotropy(r._anisoLevel),r._mipmap){r._mipmapCount=Math.ceil(Math.log2(e))+1;for(var o=0;o<r._mipmapCount;o++)r._setPixels([],o,Math.max(e>>o,1),Math.max(e>>o,1));r._setGPUMemory(e*e*4*(1+1/3)*6)}else r._mipmapCount=1,r._setGPUMemory(e*e*4*6);return r}return _inherits(TextureCube,r),_createClass(TextureCube,[{key:"_setPixels",value:function(e,r,n,i){var a=t.LayaGL.instance,o=this._getGLFormat();t.WebGLContext.bindTexture(a,this._glTextureType,this._glTexture),this.format===t.TextureFormat.R8G8B8?(a.pixelStorei(a.UNPACK_ALIGNMENT,1),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Z,r,o,n,i,0,o,a.UNSIGNED_BYTE,e[0]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Z,r,o,n,i,0,o,a.UNSIGNED_BYTE,e[1]),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X,r,o,n,i,0,o,a.UNSIGNED_BYTE,e[2]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_X,r,o,n,i,0,o,a.UNSIGNED_BYTE,e[3]),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Y,r,o,n,i,0,o,a.UNSIGNED_BYTE,e[4]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Y,r,o,n,i,0,o,a.UNSIGNED_BYTE,e[5]),a.pixelStorei(a.UNPACK_ALIGNMENT,4)):(a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Z,r,o,n,i,0,o,a.UNSIGNED_BYTE,e[0]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Z,r,o,n,i,0,o,a.UNSIGNED_BYTE,e[1]),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X,r,o,n,i,0,o,a.UNSIGNED_BYTE,e[2]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_X,r,o,n,i,0,o,a.UNSIGNED_BYTE,e[3]),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Y,r,o,n,i,0,o,a.UNSIGNED_BYTE,e[4]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Y,r,o,n,i,0,o,a.UNSIGNED_BYTE,e[5]))}},{key:"setSixSideImageSources",value:function(e){for(var r,n,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=0;a<6;a++){var o=e[a];if(!o)return void console.log("TextureCube: image Source can't be null.");var s=o.width,l=o.height;if(a>0&&r!==s)return void console.log("TextureCube: each side image's width and height must same.");if((r=s)!==(n=l))return void console.log("TextureCube: each side image's width and height must same.")}this._width=r,this._height=n;var u=t.LayaGL.instance;t.WebGLContext.bindTexture(u,this._glTextureType,this._glTexture);var c=this._getGLFormat();if(t.Render.isConchApp){if(1==i)for(var h=0;h<6;h++)e[h].setPremultiplyAlpha(i);u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_Z,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e[0]),u.texImage2D(u.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e[1]),u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e[2]),u.texImage2D(u.TEXTURE_CUBE_MAP_NEGATIVE_X,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e[3]),u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_Y,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e[4]),u.texImage2D(u.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e[5])}else i&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_Z,0,c,c,u.UNSIGNED_BYTE,e[0]),u.texImage2D(u.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,c,c,u.UNSIGNED_BYTE,e[1]),u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X,0,c,c,u.UNSIGNED_BYTE,e[2]),u.texImage2D(u.TEXTURE_CUBE_MAP_NEGATIVE_X,0,c,c,u.UNSIGNED_BYTE,e[3]),u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_Y,0,c,c,u.UNSIGNED_BYTE,e[4]),u.texImage2D(u.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,c,c,u.UNSIGNED_BYTE,e[5]),i&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);this._mipmap&&this._isPot(r)&&this._isPot(n)?(u.generateMipmap(this._glTextureType),this._setGPUMemory(r*n*4*(1+1/3)*6)):this._setGPUMemory(r*n*4*6),this._setWarpMode(u.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(u.TEXTURE_WRAP_T,this._wrapModeV),this._setFilterMode(this._filterMode),this._readyed=!0,this._activeResource()}},{key:"setSixSidePixels",value:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!e)throw new Error("TextureCube:pixels can't be null.");var n=Math.max(this._width>>r,1),i=Math.max(this._height>>r,1),a=n*i*this._getFormatByteCount();if(e[0].length<a)throw"TextureCube:pixels length should at least "+a+".";if(this._setPixels(e,r,n,i),0===r){var o=t.LayaGL.instance;this._setWarpMode(o.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(o.TEXTURE_WRAP_T,this._wrapModeV)}this._readyed=!0,this._activeResource()}},{key:"setImageSource",value:function(r,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=this._width,o=this._height;if(!n||a===n.width&&o===n.height){var s=t.LayaGL.instance;t.WebGLContext.bindTexture(s,this._glTextureType,this._glTexture);var l=this._getGLFormat();switch(r){case e.TextureCubeFace.NegativeX:s.texImage2D(s.TEXTURE_CUBE_MAP_NEGATIVE_X,i,l,l,s.UNSIGNED_BYTE,n);break;case e.TextureCubeFace.PositiveX:s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X,i,l,l,s.UNSIGNED_BYTE,n);break;case e.TextureCubeFace.NegativeY:s.texImage2D(s.TEXTURE_CUBE_MAP_NEGATIVE_Y,i,l,l,s.UNSIGNED_BYTE,n);break;case e.TextureCubeFace.PositiveY:s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_Y,i,l,l,s.UNSIGNED_BYTE,n);break;case e.TextureCubeFace.NegativeZ:s.texImage2D(s.TEXTURE_CUBE_MAP_NEGATIVE_Z,i,l,l,s.UNSIGNED_BYTE,n);break;case e.TextureCubeFace.PositiveZ:s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_Z,i,l,l,s.UNSIGNED_BYTE,n)}this._mipmap&&this._isPot(a)&&this._isPot(o)?(s.generateMipmap(this._glTextureType),this._setGPUMemory(a*o*4*(1+1/3)*6)):this._setGPUMemory(a*o*4*6),this._setWarpMode(s.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(s.TEXTURE_WRAP_T,this._wrapModeV),this._setFilterMode(this._filterMode),this._readyed=!0}else console.log("TextureCube: imageSource's width and height must same.")}},{key:"defaulteTexture",get:function(){return TextureCube.grayTexture}}],[{key:"__init__",value:function(){var e=new TextureCube(1,t.TextureFormat.R8G8B8,!1),r=new TextureCube(1,t.TextureFormat.R8G8B8,!1),n=new Uint8Array(3);n[0]=0,n[1]=0,n[2]=0,e.setSixSidePixels([n,n,n,n,n,n]),e.lock=!0,n[0]=128,n[1]=128,n[2]=128,r.setSixSidePixels([n,n,n,n,n,n]),r.lock=!0,TextureCube._grayTexture=r,TextureCube._blackTexture=e}},{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=t?new TextureCube(0,t[0],t[1]):new TextureCube(0);return r.setSixSideImageSources(e),r}},{key:"_parseBin",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=t?new TextureCube(0,t[0],t[1]):new TextureCube(0);return r.setSixSideImageSources(e),r}},{key:"load",value:function(e,r){t.ILaya.loader.create(e,r,null,TextureCube.TEXTURECUBE)}},{key:"blackTexture",get:function(){return TextureCube._blackTexture}},{key:"grayTexture",get:function(){return TextureCube._grayTexture}}]),TextureCube}(t.BaseTexture);Rt.TEXTURECUBE="TEXTURECUBE";var Ct=function(){function LightQueue(){_classCallCheck(this,LightQueue),this._length=0,this._elements=[]}return _createClass(LightQueue,[{key:"add",value:function(e){this._length===this._elements.length?this._elements.push(e):this._elements[this._length]=e,this._length++}},{key:"remove",value:function(e){var t=this._elements.indexOf(e);if(this._length--,t!==this._length){var r=this._elements[this._length];this._elements[t]=r}}},{key:"shift",value:function(){return this._length--,this._elements.shift()}},{key:"getBrightestLight",value:function(){for(var e,t=-1,r=this._elements,n=0;n<this._length;n++){var i=r[n]._intensity;t<i&&(t=i,e=n)}return e}},{key:"normalLightOrdering",value:function(e){this._elements;var t=this._elements[0];this._elements[0]=this._elements[e],this._elements[e]=t}}]),LightQueue}(),Mt=function(e){function AlternateLightQueue(){return _classCallCheck(this,AlternateLightQueue),_possibleConstructorReturn(this,_getPrototypeOf(AlternateLightQueue).apply(this,arguments))}return _inherits(AlternateLightQueue,e),_createClass(AlternateLightQueue,[{key:"remove",value:function(e){var t=this._elements.indexOf(e);this._elements.splice(t,1),this._length--}}]),AlternateLightQueue}(Ct),Dt=function(e){function PixelLineMaterial(){var e;return _classCallCheck(this,PixelLineMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(PixelLineMaterial).call(this))).setShaderName("LineShader"),e._shaderValues.setVector(PixelLineMaterial.COLOR,new i(1,1,1,1)),e}return _inherits(PixelLineMaterial,e),_createClass(PixelLineMaterial,[{key:"clone",value:function(){var e=new PixelLineMaterial;return this.cloneTo(e),e}},{key:"color",get:function(){return this._shaderValues.getVector(PixelLineMaterial.COLOR)},set:function(e){this._shaderValues.setVector(PixelLineMaterial.COLOR,e)}},{key:"depthWrite",set:function(e){this._shaderValues.setBool(PixelLineMaterial.DEPTH_WRITE,e)},get:function(){return this._shaderValues.getBool(PixelLineMaterial.DEPTH_WRITE)}},{key:"cull",set:function(e){this._shaderValues.setInt(PixelLineMaterial.CULL,e)},get:function(){return this._shaderValues.getInt(PixelLineMaterial.CULL)}},{key:"blend",set:function(e){this._shaderValues.setInt(PixelLineMaterial.BLEND,e)},get:function(){return this._shaderValues.getInt(PixelLineMaterial.BLEND)}},{key:"blendSrc",set:function(e){this._shaderValues.setInt(PixelLineMaterial.BLEND_SRC,e)},get:function(){return this._shaderValues.getInt(PixelLineMaterial.BLEND_SRC)}},{key:"blendDst",set:function(e){this._shaderValues.setInt(PixelLineMaterial.BLEND_DST,e)},get:function(){return this._shaderValues.getInt(PixelLineMaterial.BLEND_DST)}},{key:"depthTest",set:function(e){this._shaderValues.setInt(PixelLineMaterial.DEPTH_TEST,e)},get:function(){return this._shaderValues.getInt(PixelLineMaterial.DEPTH_TEST)}}],[{key:"__initDefine__",value:function(){}}]),PixelLineMaterial}(me);Dt.COLOR=ue.propertyNameToID("u_Color"),Dt.CULL=ue.propertyNameToID("s_Cull"),Dt.BLEND=ue.propertyNameToID("s_Blend"),Dt.BLEND_SRC=ue.propertyNameToID("s_BlendSrc"),Dt.BLEND_DST=ue.propertyNameToID("s_BlendDst"),Dt.DEPTH_TEST=ue.propertyNameToID("s_DepthTest"),Dt.DEPTH_WRITE=ue.propertyNameToID("s_DepthWrite");var xt=function(){function BoundBox(e,t){_classCallCheck(this,BoundBox),this.min=e,this.max=t}return _createClass(BoundBox,[{key:"_rotateExtents",value:function(e,t,r){var n=e.x,i=e.y,a=e.z,o=t.elements;r.x=Math.abs(o[0]*n)+Math.abs(o[4]*i)+Math.abs(o[8]*a),r.y=Math.abs(o[1]*n)+Math.abs(o[5]*i)+Math.abs(o[9]*a),r.z=Math.abs(o[2]*n)+Math.abs(o[6]*i)+Math.abs(o[10]*a)}},{key:"getCorners",value:function(e){e.length=8;var t=this.min.x,r=this.min.y,n=this.min.z,i=this.max.x,a=this.max.y,s=this.max.z;e[0]=new o(t,a,s),e[1]=new o(i,a,s),e[2]=new o(i,r,s),e[3]=new o(t,r,s),e[4]=new o(t,a,n),e[5]=new o(i,a,n),e[6]=new o(i,r,n),e[7]=new o(t,r,n)}},{key:"getCenter",value:function(e){o.add(this.min,this.max,e),o.scale(e,.5,e)}},{key:"getExtent",value:function(e){o.subtract(this.max,this.min,e),o.scale(e,.5,e)}},{key:"setCenterAndExtent",value:function(e,t){o.subtract(e,t,this.min),o.add(e,t,this.max)}},{key:"tranform",value:function(e,t){var r=BoundBox._tempVector30,n=BoundBox._tempVector31;this.getCenter(r),this.getExtent(n),o.transformCoordinate(r,e,r),this._rotateExtents(n,e,n),t.setCenterAndExtent(r,n)}},{key:"toDefault",value:function(){this.min.toDefault(),this.max.toDefault()}},{key:"cloneTo",value:function(e){var t=e;this.min.cloneTo(t.min),this.max.cloneTo(t.max)}},{key:"clone",value:function(){var e=new BoundBox(new o,new o);return this.cloneTo(e),e}}],[{key:"createfromPoints",value:function(e,t){if(null==e)throw new Error("points");var r=t.min,n=t.max;r.x=Number.MAX_VALUE,r.y=Number.MAX_VALUE,r.z=Number.MAX_VALUE,n.x=-Number.MAX_VALUE,n.y=-Number.MAX_VALUE,n.z=-Number.MAX_VALUE;for(var i=0,a=e.length;i<a;++i)o.min(r,e[i],r),o.max(n,e[i],n)}},{key:"merge",value:function(e,t,r){o.min(e.min,t.min,r.min),o.max(e.max,t.max,r.max)}}]),BoundBox}();xt._tempVector30=new o,xt._tempVector31=new o;var At=function(){function Bounds(e,t){_classCallCheck(this,Bounds),this._updateFlag=0,this._center=new o,this._extent=new o,this._boundBox=new xt(new o,new o),e.cloneTo(this._boundBox.min),t.cloneTo(this._boundBox.max),this._setUpdateFlag(Bounds._UPDATE_CENTER|Bounds._UPDATE_EXTENT,!0)}return _createClass(Bounds,[{key:"setMin",value:function(e){var t=this._boundBox.min;e!==t&&e.cloneTo(t),this._setUpdateFlag(Bounds._UPDATE_CENTER|Bounds._UPDATE_EXTENT,!0),this._setUpdateFlag(Bounds._UPDATE_MIN,!1)}},{key:"getMin",value:function(){var e=this._boundBox.min;return this._getUpdateFlag(Bounds._UPDATE_MIN)&&(this._getMin(this.getCenter(),this.getExtent(),e),this._setUpdateFlag(Bounds._UPDATE_MIN,!1)),e}},{key:"setMax",value:function(e){var t=this._boundBox.max;e!==t&&e.cloneTo(t),this._setUpdateFlag(Bounds._UPDATE_CENTER|Bounds._UPDATE_EXTENT,!0),this._setUpdateFlag(Bounds._UPDATE_MAX,!1)}},{key:"getMax",value:function(){var e=this._boundBox.max;return this._getUpdateFlag(Bounds._UPDATE_MAX)&&(this._getMax(this.getCenter(),this.getExtent(),e),this._setUpdateFlag(Bounds._UPDATE_MAX,!1)),e}},{key:"setCenter",value:function(e){e!==this._center&&e.cloneTo(this._center),this._setUpdateFlag(Bounds._UPDATE_MIN|Bounds._UPDATE_MAX,!0),this._setUpdateFlag(Bounds._UPDATE_CENTER,!1)}},{key:"getCenter",value:function(){return this._getUpdateFlag(Bounds._UPDATE_CENTER)&&(this._getCenter(this.getMin(),this.getMax(),this._center),this._setUpdateFlag(Bounds._UPDATE_CENTER,!1)),this._center}},{key:"setExtent",value:function(e){e!==this._extent&&e.cloneTo(this._extent),this._setUpdateFlag(Bounds._UPDATE_MIN|Bounds._UPDATE_MAX,!0),this._setUpdateFlag(Bounds._UPDATE_EXTENT,!1)}},{key:"getExtent",value:function(){return this._getUpdateFlag(Bounds._UPDATE_EXTENT)&&(this._getExtent(this.getMin(),this.getMax(),this._extent),this._setUpdateFlag(Bounds._UPDATE_EXTENT,!1)),this._extent}},{key:"_getUpdateFlag",value:function(e){return 0!=(this._updateFlag&e)}},{key:"_setUpdateFlag",value:function(e,t){t?this._updateFlag|=e:this._updateFlag&=~e}},{key:"_getCenter",value:function(e,t,r){o.add(e,t,r),o.scale(r,.5,r)}},{key:"_getExtent",value:function(e,t,r){o.subtract(t,e,r),o.scale(r,.5,r)}},{key:"_getMin",value:function(e,t,r){o.subtract(e,t,r)}},{key:"_getMax",value:function(e,t,r){o.add(e,t,r)}},{key:"_rotateExtents",value:function(e,t,r){var n=e.x,i=e.y,a=e.z,o=t.elements;r.x=Math.abs(o[0]*n)+Math.abs(o[4]*i)+Math.abs(o[8]*a),r.y=Math.abs(o[1]*n)+Math.abs(o[5]*i)+Math.abs(o[9]*a),r.z=Math.abs(o[2]*n)+Math.abs(o[6]*i)+Math.abs(o[10]*a)}},{key:"_tranform",value:function(e,t){var r=t._center,n=t._extent;o.transformCoordinate(this.getCenter(),e,r),this._rotateExtents(this.getExtent(),e,n),t._boundBox.setCenterAndExtent(r,n),t._updateFlag=0}},{key:"_getBoundBox",value:function(){if(this._updateFlag&Bounds._UPDATE_MIN){var e=this._boundBox.min;this._getMin(this.getCenter(),this.getExtent(),e),this._setUpdateFlag(Bounds._UPDATE_MIN,!1)}if(this._updateFlag&Bounds._UPDATE_MAX){var t=this._boundBox.max;this._getMax(this.getCenter(),this.getExtent(),t),this._setUpdateFlag(Bounds._UPDATE_MAX,!1)}return this._boundBox}},{key:"cloneTo",value:function(e){var t=e;this.getMin().cloneTo(t._boundBox.min),this.getMax().cloneTo(t._boundBox.max),this.getCenter().cloneTo(t._center),this.getExtent().cloneTo(t._extent),t._updateFlag=0}},{key:"clone",value:function(){var e=new Bounds(new o,new o);return this.cloneTo(e),e}}]),Bounds}();At._UPDATE_MIN=1,At._UPDATE_MAX=2,At._UPDATE_CENTER=4,At._UPDATE_EXTENT=8;var It=function(){function GeometryElement(){_classCallCheck(this,GeometryElement),this._destroyed=!1}return _createClass(GeometryElement,[{key:"_getType",value:function(){throw"GeometryElement:must override it."}},{key:"_prepareRender",value:function(e){return!0}},{key:"_render",value:function(e){throw"GeometryElement:must override it."}},{key:"destroy",value:function(){this._destroyed||(this._destroyed=!0)}},{key:"destroyed",get:function(){return this._destroyed}}]),GeometryElement}();It._typeCounter=0;var Lt=function(){function PixelLineVertex(){_classCallCheck(this,PixelLineVertex)}return _createClass(PixelLineVertex,[{key:"vertexDeclaration",get:function(){return PixelLineVertex._vertexDeclaration}}],[{key:"__init__",value:function(){PixelLineVertex._vertexDeclaration=new je(28,[new Ze(0,Ye.Vector3,Qe.MESH_POSITION0),new Ze(12,Ye.Vector4,Qe.MESH_COLOR0)])}},{key:"vertexDeclaration",get:function(){return PixelLineVertex._vertexDeclaration}}]),PixelLineVertex}(),Pt=function(e){function PixelLineFilter(e,r){var n;_classCallCheck(this,PixelLineFilter),(n=_possibleConstructorReturn(this,_getPrototypeOf(PixelLineFilter).call(this)))._floatCountPerVertices=7,n._minUpdate=Number.MAX_VALUE,n._maxUpdate=Number.MIN_VALUE,n._bufferState=new We,n._floatBound=new Float32Array(6),n._calculateBound=!1,n._maxLineCount=0,n._lineCount=0;var i=2*r;n._owner=e,n._maxLineCount=r,n._vertices=new Float32Array(i*n._floatCountPerVertices),n._vertexBuffer=new qe(Lt.vertexDeclaration.vertexStride*i,t.LayaGL.instance.STATIC_DRAW,!1),n._vertexBuffer.vertexDeclaration=Lt.vertexDeclaration,n._bufferState.bind(),n._bufferState.applyVertexBuffer(n._vertexBuffer),n._bufferState.unBind();var a=PixelLineFilter._tempVector0,o=PixelLineFilter._tempVector1;return a.setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o.setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n._bounds=new At(a,o),n}return _inherits(PixelLineFilter,e),_createClass(PixelLineFilter,[{key:"_getType",value:function(){return PixelLineFilter._type}},{key:"_resizeLineData",value:function(e){var r=2*e,n=this._vertices;this._vertexBuffer.destroy(),this._maxLineCount=e;var i=r*this._floatCountPerVertices;this._vertices=new Float32Array(i),this._vertexBuffer=new qe(Lt.vertexDeclaration.vertexStride*r,t.LayaGL.instance.STATIC_DRAW,!1),this._vertexBuffer.vertexDeclaration=Lt.vertexDeclaration,i<n.length?(this._vertices.set(new Float32Array(n.buffer,0,i)),this._vertexBuffer.setData(this._vertices.buffer,0,0,4*i)):(this._vertices.set(n),this._vertexBuffer.setData(this._vertices.buffer,0,0,4*n.length)),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.unBind()}},{key:"_updateLineVertices",value:function(e,t,r,n,i){t&&(this._vertices[e+0]=t.x,this._vertices[e+1]=t.y,this._vertices[e+2]=t.z),n&&(this._vertices[e+3]=n.r,this._vertices[e+4]=n.g,this._vertices[e+5]=n.b,this._vertices[e+6]=n.a),r&&(this._vertices[e+7]=r.x,this._vertices[e+8]=r.y,this._vertices[e+9]=r.z),i&&(this._vertices[e+10]=i.r,this._vertices[e+11]=i.g,this._vertices[e+12]=i.b,this._vertices[e+13]=i.a),this._minUpdate=Math.min(this._minUpdate,e),this._maxUpdate=Math.max(this._maxUpdate,e+2*this._floatCountPerVertices);var a=this._bounds,s=this._floatBound,l=a.getMin(),u=a.getMax();o.min(l,t,l),o.min(l,r,l),o.max(u,t,u),o.max(u,r,u),a.setMin(l),a.setMax(u),s[0]=l.x,s[1]=l.y,s[2]=l.z,s[3]=u.x,s[4]=u.y,s[5]=u.z}},{key:"_reCalculateBound",value:function(){if(this._calculateBound){var e=this._vertices,t=PixelLineFilter._tempVector0,r=PixelLineFilter._tempVector1;t.setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r.setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var n=0;n<2*this._lineCount;++n){var i=this._floatCountPerVertices*n,a=e[i+0],o=e[i+1],s=e[i+2];t.x=Math.min(a,t.x),t.y=Math.min(o,t.y),t.z=Math.min(s,t.z),r.x=Math.max(a,r.x),r.y=Math.max(o,r.y),r.z=Math.max(s,r.z)}this._bounds.setMin(t),this._bounds.setMax(r);var l=this._floatBound;l[0]=t.x,l[1]=t.y,l[2]=t.z,l[3]=r.x,l[4]=r.y,l[5]=r.z,this._calculateBound=!1}}},{key:"_removeLineData",value:function(e){var t=2*this._floatCountPerVertices,r=e+1,n=e*t,i=this._vertices,a=new Float32Array(i.buffer,r*t*4,(this._lineCount-r)*t);i.set(a,n),this._minUpdate=Math.min(this._minUpdate,n),this._maxUpdate=Math.max(this._maxUpdate,n+a.length),this._lineCount--;var o=this._floatBound,s=i[n],l=i[n+1],u=i[n+2],c=i[n+7],h=i[n+8],_=i[n+9],d=o[0],f=o[1],m=o[2],T=o[3],p=o[4],g=o[5];s!==d&&s!==T&&l!==f&&l!==p&&u!==m&&u!==g&&c!==d&&c!==T&&h!==f&&h!==p&&_!==m&&_!==g||(this._calculateBound=!0)}},{key:"_updateLineData",value:function(e,t,r,n,i){var a=2*this._floatCountPerVertices;this._updateLineVertices(e*a,t,r,n,i)}},{key:"_updateLineDatas",value:function(e,t){for(var r=2*this._floatCountPerVertices,n=t.length,i=0;i<n;i++){var a=t[i];this._updateLineVertices((e+i)*r,a.startPosition,a.endPosition,a.startColor,a.endColor)}}},{key:"_getLineData",value:function(e,t){var r=t.startPosition,n=t.startColor,i=t.endPosition,a=t.endColor,o=this._vertices,s=e*this._floatCountPerVertices*2;r.x=o[s+0],r.y=o[s+1],r.z=o[s+2],n.r=o[s+3],n.g=o[s+4],n.b=o[s+5],n.a=o[s+6],i.x=o[s+7],i.y=o[s+8],i.z=o[s+9],a.r=o[s+10],a.g=o[s+11],a.b=o[s+12],a.a=o[s+13]}},{key:"_prepareRender",value:function(e){return!0}},{key:"_render",value:function(e){if(this._minUpdate!==Number.MAX_VALUE&&this._maxUpdate!==Number.MIN_VALUE&&(this._vertexBuffer.setData(this._vertices.buffer,4*this._minUpdate,4*this._minUpdate,4*(this._maxUpdate-this._minUpdate)),this._minUpdate=Number.MAX_VALUE,this._maxUpdate=Number.MIN_VALUE),this._lineCount>0){this._bufferState.bind();var r=t.LayaGL.instance;r.drawArrays(r.LINES,0,2*this._lineCount),t.Stat.renderBatches++}}},{key:"destroy",value:function(){this._destroyed||(_get(_getPrototypeOf(PixelLineFilter.prototype),"destroy",this).call(this),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferState=null,this._vertexBuffer=null,this._vertices=null)}}]),PixelLineFilter}(It);Pt._tempVector0=new o,Pt._tempVector1=new o,Pt._type=It._typeCounter++;var Ot=function(e){function RenderableSprite3D(e){return _classCallCheck(this,RenderableSprite3D),_possibleConstructorReturn(this,_getPrototypeOf(RenderableSprite3D).call(this,e))}return _inherits(RenderableSprite3D,e),_createClass(RenderableSprite3D,[{key:"_onInActive",value:function(){_get(_getPrototypeOf(RenderableSprite3D.prototype),"_onInActive",this).call(this),this._scene._removeRenderObject(this._render)}},{key:"_onActive",value:function(){_get(_getPrototypeOf(RenderableSprite3D.prototype),"_onActive",this).call(this),this._scene._addRenderObject(this._render)}},{key:"_onActiveInScene",value:function(){if(_get(_getPrototypeOf(RenderableSprite3D.prototype),"_onActiveInScene",this).call(this),l.Laya3D._editerEnvironment){var e=this._scene,t=new i;e._allotPickColorByID(this.id,t),e._pickIdToSprite[this.id]=this,this._render._shaderValues.setVector(RenderableSprite3D.PICKCOLOR,t)}}},{key:"_addToInitStaticBatchManager",value:function(){}},{key:"_setBelongScene",value:function(e){_get(_getPrototypeOf(RenderableSprite3D.prototype),"_setBelongScene",this).call(this,e),this._render._setBelongScene(e)}},{key:"_setUnBelongScene",value:function(){this._render._shaderValues.removeDefine(RenderableSprite3D.SAHDERDEFINE_LIGHTMAP),_get(_getPrototypeOf(RenderableSprite3D.prototype),"_setUnBelongScene",this).call(this)}},{key:"_changeHierarchyAnimator",value:function(e){if(this._hierarchyAnimator){var t=this._hierarchyAnimator._renderableSprites;t.splice(t.indexOf(this),1)}e&&e._renderableSprites.push(this),_get(_getPrototypeOf(RenderableSprite3D.prototype),"_changeHierarchyAnimator",this).call(this,e)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];_get(_getPrototypeOf(RenderableSprite3D.prototype),"destroy",this).call(this,e),this._render._destroy(),this._render=null}},{key:"_create",value:function(){return new RenderableSprite3D(this.name)}}],[{key:"__init__",value:function(){RenderableSprite3D.SHADERDEFINE_RECEIVE_SHADOW=ue.getDefineByName("RECEIVESHADOW"),RenderableSprite3D.SAHDERDEFINE_LIGHTMAP=ue.getDefineByName("LIGHTMAP"),RenderableSprite3D.SHADERDEFINE_LIGHTMAP_DIRECTIONAL=ue.getDefineByName("LIGHTMAP_DIRECTIONAL")}}]),RenderableSprite3D}(et);Ot.LIGHTMAPSCALEOFFSET=ue.propertyNameToID("u_LightmapScaleOffset"),Ot.LIGHTMAP=ue.propertyNameToID("u_LightMap"),Ot.LIGHTMAP_DIRECTION=ue.propertyNameToID("u_LightMapDirection"),Ot.PICKCOLOR=ue.propertyNameToID("u_PickColor");var Nt=function BatchMark(){_classCallCheck(this,BatchMark),this.updateMark=-1,this.indexInList=-1,this.batched=!1},bt=function(e){function SubMeshInstanceBatch(){var e;_classCallCheck(this,SubMeshInstanceBatch),(e=_possibleConstructorReturn(this,_getPrototypeOf(SubMeshInstanceBatch).call(this))).maxInstanceCount=1024,e.instanceWorldMatrixData=new Float32Array(16*e.maxInstanceCount),e.instanceMVPMatrixData=new Float32Array(16*e.maxInstanceCount),e.instanceSimpleAnimatorData=new Float32Array(4*e.maxInstanceCount);var r=t.LayaGL.instance;return e.instanceWorldMatrixBuffer=new qe(4*e.instanceWorldMatrixData.length,r.DYNAMIC_DRAW),e.instanceMVPMatrixBuffer=new qe(4*e.instanceMVPMatrixData.length,r.DYNAMIC_DRAW),e.instanceWorldMatrixBuffer.vertexDeclaration=Qe.instanceWorldMatrixDeclaration,e.instanceMVPMatrixBuffer.vertexDeclaration=Qe.instanceMVPMatrixDeclaration,e.instanceSimpleAnimatorBuffer=new qe(4*e.instanceSimpleAnimatorData.length,r.DYNAMIC_DRAW),e.instanceSimpleAnimatorBuffer.vertexDeclaration=Qe.instanceSimpleAnimatorDeclaration,e}return _inherits(SubMeshInstanceBatch,e),_createClass(SubMeshInstanceBatch,[{key:"_render",value:function(e){var r=t.LayaGL.instance,n=e.renderElement,i=n.instanceSubMesh,a=n.instanceBatchElementList.length,o=i._indexCount;i._mesh._instanceBufferState.bind(),t.LayaGL.layaGPUInstance.drawElementsInstanced(r.TRIANGLES,o,r.UNSIGNED_SHORT,2*i._indexStart,a),t.Stat.renderBatches++,t.Stat.savedRenderBatches+=a-1,t.Stat.trianglesFaces+=o*a/3}}],[{key:"__init__",value:function(){SubMeshInstanceBatch.instance=new SubMeshInstanceBatch}}]),SubMeshInstanceBatch}(It),kt=function(){function RenderElement(){_classCallCheck(this,RenderElement),this.renderSubShader=null,this.renderType=RenderElement.RENDERTYPE_NORMAL}return _createClass(RenderElement,[{key:"getInvertFront",value:function(){return this._transform._isFrontFaceInvert}},{key:"setTransform",value:function(e){this._transform=e}},{key:"setGeometry",value:function(e){this._geometry=e}},{key:"addToOpaqueRenderQueue",value:function(e,t){t.elements.add(this)}},{key:"addToTransparentRenderQueue",value:function(e,t){t.elements.add(this),t.lastTransparentBatched=!1,t.lastTransparentRenderElement=this}},{key:"_update",value:function(e,t,r,n){if(this.material){var i=this.material._shader.getSubShaderAt(0);if(this.renderSubShader=null,r)if(n){var a=i.getFlag(n);if(!a)return;for(var o=r._subShaders,s=0,l=o.length;s<l;s++){var u=o[s];if(a===u.getFlag(n)){this.renderSubShader=u;break}}if(!this.renderSubShader)return}else this.renderSubShader=r.getSubShaderAt(0);else this.renderSubShader=i;var c=e._getRenderQueue(this.material.renderQueue);c.isTransparent?this.addToTransparentRenderQueue(t,c):this.addToOpaqueRenderQueue(t,c)}}},{key:"_render",value:function(e){var t,r,n,i=e.invertY,a=pt._updateMark,o=e.scene,s=e.cameraShaderValue,l=this._transform,u=this._geometry;e.renderElement=this,a!==this.render._updateMark||this.renderType!==this.render._updateRenderType?(this.render._renderUpdate(e,l),this.render._renderUpdateWithCamera(e,l),this.render._updateMark=a,this.render._updateRenderType=this.renderType):this.renderType==RenderElement.RENDERTYPE_INSTANCEBATCH&&(this.render._renderUpdate(e,l),this.render._renderUpdateWithCamera(e,l));var c=e.pipelineMode;if(u._prepareRender(e))for(var h=this.renderSubShader._passes,_=0,d=h.length;_<d;_++){var f=h[_];if(f._pipelineMode===c){var m=RenderElement._compileDefine;o._shaderValues._defineDatas.cloneTo(m),m.addDefineDatas(this.render._shaderValues._defineDatas),m.addDefineDatas(this.material._shaderValues._defineDatas);var T=e.shader=f.withCompile(m),p=T.bind(),g=a!==T._uploadMark,E=T._uploadScene!==o||g;(E||p)&&(T.uploadUniforms(T._sceneUniformParamsMap,o._shaderValues,E),T._uploadScene=o);var y=T._uploadRender!==this.render||T._uploadRenderType!==this.renderType||g;(y||p)&&(T.uploadUniforms(T._spriteUniformParamsMap,this.render._shaderValues,y),T._uploadRender=this.render,T._uploadRenderType=this.renderType);var S=T._uploadCameraShaderValue!==s||g;(S||p)&&(T.uploadUniforms(T._cameraUniformParamsMap,s,S),T._uploadCameraShaderValue=s);var v=T._uploadMaterial!==this.material||g;(v||p)&&(T.uploadUniforms(T._materialUniformParamsMap,this.material._shaderValues,v),T._uploadMaterial=this.material);var R=this.material._shaderValues;t!==this.material||r!==T?(T.uploadRenderStateBlendDepth(R),T.uploadRenderStateFrontFace(R,i,this.getInvertFront()),t=this.material,r=T,n=this.render):n!==this.render&&(T.uploadRenderStateFrontFace(R,i,this.getInvertFront()),n=this.render),u._render(e),T._uploadMark=a}}this.renderType!==RenderElement.RENDERTYPE_NORMAL&&this.render._revertBatchRenderUpdate(e)}},{key:"destroy",value:function(){this._transform=null,this._geometry=null,this.material=null,this.render=null}}]),RenderElement}();kt.RENDERTYPE_NORMAL=0,kt.RENDERTYPE_STATICBATCH=1,kt.RENDERTYPE_INSTANCEBATCH=2,kt.RENDERTYPE_VERTEXBATCH=3,kt._compileDefine=new ae;var wt=function(e){function SubMeshRenderElement(){var e;return _classCallCheck(this,SubMeshRenderElement),(e=_possibleConstructorReturn(this,_getPrototypeOf(SubMeshRenderElement).call(this)))._dynamicWorldPositionNormalNeedUpdate=!0,e}return _inherits(SubMeshRenderElement,e),_createClass(SubMeshRenderElement,[{key:"_onWorldMatrixChanged",value:function(){this._dynamicWorldPositionNormalNeedUpdate=!0}},{key:"_computeWorldPositionsAndNormals",value:function(e,t,r,n){if(this._dynamicWorldPositionNormalNeedUpdate){for(var i=this._geometry,a=i._vertexBuffer,o=a.vertexDeclaration.vertexStride/4,s=a.getFloat32Data(),l=this._transform.worldMatrix,u=this._transform.rotation,c=i._indices,h=0;h<n;h++){var _=(r?c[h]:h)*o,d=3*h;P.transformVector3ArrayToVector3ArrayCoordinate(s,_+e,l,this._dynamicWorldPositions,d),-1!==t&&P.transformVector3ArrayByQuat(s,_+t,u,this._dynamicWorldNormals,d)}this._dynamicWorldPositionNormalNeedUpdate=!1}}},{key:"setTransform",value:function(e){this._transform!==e&&(this._transform&&this._transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatrixChanged),e&&e.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatrixChanged),this._dynamicWorldPositionNormalNeedUpdate=!0,this._transform=e)}},{key:"setGeometry",value:function(e){if(this._geometry!==e){var t=e,r=t._mesh;if(r){var n=r._subMeshes.length>1,i=n?t._indexCount:r._vertexCount;if(i<=l.SubMeshDynamicBatch.maxAllowVertexCount){var a=3*i;this._dynamicVertexBatch=!0,this._dynamicWorldPositions=new Float32Array(a),this._dynamicWorldNormals=new Float32Array(a),this._dynamicVertexCount=i,this._dynamicMultiSubMesh=n}else this._dynamicVertexBatch=!1}this._geometry=e}}},{key:"addToOpaqueRenderQueue",value:function(e,r){var n=this.staticBatch,i=r.elements,a=i.elements;if(n){var o=l.MeshRenderStaticBatchManager.instance,s=o.getBatchOpaquaMark(this.render.lightmapIndex+1,this.render.receiveShadow,this.material.id,n._batchID);if(o._updateCountMark===s.updateMark){var u=s.indexInList;if(s.batched)a[u].staticBatchElementList.add(this);else{var c=a[u],h=c.render,_=o._getBatchRenderElementFromPool();_.renderType=kt.RENDERTYPE_STATICBATCH,_.setGeometry(n),_.material=c.material;var d=n.batchOwner,f=d?d._transform:null;_.setTransform(f),_.render=h,_.renderSubShader=c.renderSubShader;var m=_.staticBatchElementList;m.length=0,m.add(c),m.add(this),a[u]=_,s.batched=!0}}else s.updateMark=o._updateCountMark,s.indexInList=i.length,s.batched=!1,i.add(this)}else if(this.renderSubShader._owner._enableInstancing&&t.LayaGL.layaGPUInstance.supportInstance()&&this.render.lightmapIndex<0){var T=this._geometry,p=l.MeshRenderDynamicBatchManager.instance,g=p.getInstanceBatchOpaquaMark(this.render.receiveShadow,this.material.id,T._id,this._transform._isFrontFaceInvert);if(p._updateCountMark===g.updateMark){var E=g.indexInList;if(g.batched){var y=a[E].instanceBatchElementList;y.length===bt.instance.maxInstanceCount?(g.updateMark=p._updateCountMark,g.indexInList=i.length,g.batched=!1,i.add(this)):y.add(this)}else{var S=a[E],v=S.render,R=p._getBatchRenderElementFromPool();R.renderType=kt.RENDERTYPE_INSTANCEBATCH,R.setGeometry(bt.instance),R.material=S.material,R.setTransform(null),R.render=v,R.instanceSubMesh=T,R.renderSubShader=S.renderSubShader;var C=R.instanceBatchElementList;C.length=0,C.add(S),C.add(this),a[E]=R,g.batched=!0}}else g.updateMark=p._updateCountMark,g.indexInList=i.length,g.batched=!1,i.add(this)}else if(this._dynamicVertexBatch){var M=this._geometry._vertexBuffer.vertexDeclaration,D=l.MeshRenderDynamicBatchManager.instance,x=D.getVertexBatchOpaquaMark(this.render.lightmapIndex+1,this.render.receiveShadow,this.material.id,M.id);if(D._updateCountMark===x.updateMark){var A=x.indexInList;if(x.batched)a[A].vertexBatchElementList.add(this);else{var I=a[A],L=I.render,P=D._getBatchRenderElementFromPool();P.renderType=kt.RENDERTYPE_VERTEXBATCH,P.setGeometry(l.SubMeshDynamicBatch.instance),P.material=I.material,P.setTransform(null),P.render=L,P.vertexBatchVertexDeclaration=M,P.renderSubShader=I.renderSubShader;var O=P.vertexBatchElementList;O.length=0,O.add(I),O.add(this),a[A]=P,x.batched=!0}}else x.updateMark=D._updateCountMark,x.indexInList=i.length,x.batched=!1,i.add(this)}else i.add(this)}},{key:"addToTransparentRenderQueue",value:function(e,r){var n=this.staticBatch,i=r.elements,a=i.elements;if(n){var o=l.MeshRenderStaticBatchManager.instance,s=r.lastTransparentRenderElement;if(s){var u=s.render;if(s._geometry._getType()!==this._geometry._getType()||s.staticBatch!==n||s.material!==this.material||u.receiveShadow!==this.render.receiveShadow||u.lightmapIndex!==this.render.lightmapIndex)i.add(this),r.lastTransparentBatched=!1;else{if(r.lastTransparentBatched)a[i.length-1].staticBatchElementList.add(this);else{var c=o._getBatchRenderElementFromPool();c.renderType=kt.RENDERTYPE_STATICBATCH,c.setGeometry(n),c.material=s.material;var h=n.batchOwner,_=h?h._transform:null;c.setTransform(_),c.render=this.render,c.renderSubShader=s.renderSubShader;var d=c.staticBatchElementList;d.length=0,d.add(s),d.add(this),a[i.length-1]=c}r.lastTransparentBatched=!0}}else i.add(this),r.lastTransparentBatched=!1}else if(this.renderSubShader._owner._enableInstancing&&t.LayaGL.layaGPUInstance.supportInstance()&&this.render.lightmapIndex<0){var f=this._geometry,m=l.MeshRenderDynamicBatchManager.instance,T=r.lastTransparentRenderElement;if(T){var p=T.render;if(T._geometry._getType()!==this._geometry._getType()||T._geometry!==f||T.material!==this.material||p.receiveShadow!==this.render.receiveShadow)i.add(this),r.lastTransparentBatched=!1;else if(r.lastTransparentBatched){var g=a[i.length-1].instanceBatchElementList;g.length===bt.instance.maxInstanceCount?(i.add(this),r.lastTransparentBatched=!1):(g.add(this),r.lastTransparentBatched=!0)}else{var E=m._getBatchRenderElementFromPool();E.renderType=kt.RENDERTYPE_INSTANCEBATCH,E.setGeometry(bt.instance),E.material=T.material,E.setTransform(null),E.render=this.render,E.instanceSubMesh=f,E.renderSubShader=T.renderSubShader;var y=E.instanceBatchElementList;y.length=0,y.add(T),y.add(this),a[i.length-1]=E,r.lastTransparentBatched=!0}}else i.add(this),r.lastTransparentBatched=!1}else if(this._dynamicVertexBatch){var S=this._geometry._vertexBuffer.vertexDeclaration,v=l.MeshRenderDynamicBatchManager.instance,R=r.lastTransparentRenderElement;if(R){var C=R.render;if(R._dynamicVertexBatch&&R._geometry._getType()===this._geometry._getType()&&R._geometry._vertexBuffer._vertexDeclaration===S&&R.material===this.material&&C.receiveShadow===this.render.receiveShadow&&C.lightmapIndex===this.render.lightmapIndex){if(r.lastTransparentBatched)a[i.length-1].vertexBatchElementList.add(this);else{var M=v._getBatchRenderElementFromPool();M.renderType=kt.RENDERTYPE_VERTEXBATCH,M.setGeometry(l.SubMeshDynamicBatch.instance),M.material=R.material,M.setTransform(null),M.render=this.render,M.vertexBatchVertexDeclaration=S,M.renderSubShader=R.renderSubShader;var D=M.vertexBatchElementList;D.length=0,D.add(R),D.add(this),a[i.length-1]=M}r.lastTransparentBatched=!0}else i.add(this),r.lastTransparentBatched=!1}else i.add(this),r.lastTransparentBatched=!1}else i.add(this);r.lastTransparentRenderElement=this}},{key:"getInvertFront",value:function(){switch(this.renderType){case kt.RENDERTYPE_NORMAL:return this._transform._isFrontFaceInvert;case kt.RENDERTYPE_STATICBATCH:case kt.RENDERTYPE_VERTEXBATCH:return!1;case kt.RENDERTYPE_INSTANCEBATCH:return this.instanceBatchElementList.elements[0]._transform._isFrontFaceInvert;default:throw"SubMeshRenderElement: unknown renderType"}}},{key:"destroy",value:function(){_get(_getPrototypeOf(SubMeshRenderElement.prototype),"destroy",this).call(this),this._dynamicWorldPositions=null,this._dynamicWorldNormals=null,this.staticBatch=null,this.staticBatchElementList=null,this.vertexBatchElementList=null,this.vertexBatchVertexDeclaration=null}}]),SubMeshRenderElement}(kt),Bt=function(){function StaticBatchManager(){_classCallCheck(this,StaticBatchManager),this._initBatchSprites=[],this._staticBatches={},this._batchRenderElementPoolIndex=0,this._batchRenderElementPool=[]}return _createClass(StaticBatchManager,[{key:"_partition",value:function(e,t,r){for(var n=e[Math.floor((r+t)/2)];t<=r;){for(;this._compare(e[t],n)<0;)t++;for(;this._compare(e[r],n)>0;)r--;if(t<r){var i=e[t];e[t]=e[r],e[r]=i,t++,r--}else if(t===r){t++;break}}return t}},{key:"_quickSort",value:function(e,t,r){if(e.length>1){var n=this._partition(e,t,r),i=n-1;t<i&&this._quickSort(e,t,i),n<r&&this._quickSort(e,n,r)}}},{key:"_compare",value:function(e,t){throw"StaticBatch:must override this function."}},{key:"_initStaticBatchs",value:function(e){throw"StaticBatch:must override this function."}},{key:"_getBatchRenderElementFromPool",value:function(){throw"StaticBatch:must override this function."}},{key:"_addBatchSprite",value:function(e){this._initBatchSprites.push(e)}},{key:"_clear",value:function(){this._batchRenderElementPoolIndex=0}},{key:"_garbageCollection",value:function(){throw"StaticBatchManager: must override it."}},{key:"dispose",value:function(){this._staticBatches=null}}],[{key:"_addToStaticBatchQueue",value:function(e,t){e instanceof Ot&&t.push(e);for(var r=0,n=e.numChildren;r<n;r++)StaticBatchManager._addToStaticBatchQueue(e._children[r],t)}},{key:"_registerManager",value:function(e){StaticBatchManager._managers.push(e)}},{key:"combine",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t||(t=[],e&&StaticBatchManager._addToStaticBatchQueue(e,t));var r=t.length;if(r>0){for(var n=0;n<r;n++){var i=t[n];i.destroyed||(i._render._isPartOfStaticBatch?console.warn("StaticBatchManager: Sprite "+i.name+" has a part of Static Batch,it will be ignore."):i._addToInitStaticBatchManager())}for(var a=0,o=StaticBatchManager._managers.length;a<o;a++){var s=StaticBatchManager._managers[a];s._initStaticBatchs(e)}}}}]),StaticBatchManager}();Bt._managers=[];var Vt=function(r){function SubMeshStaticBatch(e,t){var r;return _classCallCheck(this,SubMeshStaticBatch),(r=_possibleConstructorReturn(this,_getPrototypeOf(SubMeshStaticBatch).call(this)))._bufferState=new We,r._batchID=SubMeshStaticBatch._batchIDCounter++,r._batchElements=[],r._currentBatchVertexCount=0,r._currentBatchIndexCount=0,r._vertexDeclaration=t,r.batchOwner=e,r}return _inherits(SubMeshStaticBatch,r),_createClass(SubMeshStaticBatch,[{key:"_getStaticBatchBakedVertexs",value:function(e,t,r,n,i,a){var o,s=a._vertexBuffer,l=s.vertexDeclaration,u=l.getVertexElementByUsage(Qe.MESH_POSITION0)._offset/4,h=l.getVertexElementByUsage(Qe.MESH_NORMAL0),_=h?h._offset/4:-1,d=l.getVertexElementByUsage(Qe.MESH_COLOR0),f=d?d._offset/4:-1,m=l.getVertexElementByUsage(Qe.MESH_TEXTURECOORDINATE0),T=m?m._offset/4:-1,p=l.getVertexElementByUsage(Qe.MESH_TEXTURECOORDINATE1),g=p?p._offset/4:-1,E=l.getVertexElementByUsage(Qe.MESH_TANGENT0),y=E?E._offset/4:-1,S=l.vertexStride/4,v=s.getFloat32Data();r?(r.worldMatrix.invert(SubMeshStaticBatch._tempMatrix4x40),o=SubMeshStaticBatch._tempMatrix4x41,c.multiply(SubMeshStaticBatch._tempMatrix4x40,n.worldMatrix,o)):o=n.worldMatrix;var R=SubMeshStaticBatch._tempMatrix4x42;o.invert(R),R.transpose();var C=SubMeshStaticBatch._tempQuaternion0;o.decomposeTransRotScale(SubMeshStaticBatch._tempVector30,C,SubMeshStaticBatch._tempVector31);for(var M=i.lightmapScaleOffset,D=a.vertexCount,x=0;x<D;x++){var A,I,L=x*S,O=18*(x+t);P.transformVector3ArrayToVector3ArrayCoordinate(v,L+u,o,e,O+0),-1!==_&&P.transformVector3ArrayToVector3ArrayNormal(v,L+_,R,e,O+3);var N=O+6;if(-1!==f){var b=L+f;for(A=0,I=4;A<I;A++)e[N+A]=v[b+A]}else for(A=0,I=4;A<I;A++)e[N+A]=1;if(-1!==T){var k=L+T;e[O+10]=v[k],e[O+11]=v[k+1]}if(M&&(-1!==g?P.transformLightingMapTexcoordArray(v,L+g,M,e,O+12):P.transformLightingMapTexcoordArray(v,L+T,M,e,O+12)),-1!==y){var w=L+y;e[O+14]=v[w],e[O+15]=v[w+1],e[O+16]=v[w+2],e[O+17]=v[w+3]}}return D}},{key:"addTest",value:function(e){var t=e.meshFilter.sharedMesh.vertexCount;return!(this._currentBatchVertexCount+t>SubMeshStaticBatch.maxBatchVertexCount)}},{key:"add",value:function(e){var t=e.meshFilter.sharedMesh,r=t.vertexCount;this._batchElements.push(e);var n=e._render;n._isPartOfStaticBatch=!0,n._staticBatch=this;for(var i=n._renderElements,a=0,o=i.length;a<o;a++)i[a].staticBatch=this;this._currentBatchIndexCount+=t._indexBuffer.indexCount,this._currentBatchVertexCount+=r}},{key:"remove",value:function(e){var t=e.meshFilter.sharedMesh,r=this._batchElements.indexOf(e);if(-1!==r){this._batchElements.splice(r,1);for(var n=e._render._renderElements,i=0,a=n.length;i<a;i++)n[i].staticBatch=null;this._currentBatchIndexCount=this._currentBatchIndexCount-t._indexBuffer.indexCount,this._currentBatchVertexCount=this._currentBatchVertexCount-t.vertexCount,e._render._isPartOfStaticBatch=!1}}},{key:"finishInit",value:function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._indexBuffer.destroy(),t.Resource._addGPUMemory(-(this._vertexBuffer._byteLength+this._indexBuffer._byteLength)));var r=t.LayaGL.instance,n=0,i=0,a=this.batchOwner,o=this._vertexDeclaration.vertexStride/4,s=new Float32Array(o*this._currentBatchVertexCount),l=new Uint16Array(this._currentBatchIndexCount);this._vertexBuffer=new qe(this._vertexDeclaration.vertexStride*this._currentBatchVertexCount,r.STATIC_DRAW),this._vertexBuffer.vertexDeclaration=this._vertexDeclaration,this._indexBuffer=new Xe(e.IndexFormat.UInt16,this._currentBatchIndexCount,r.STATIC_DRAW);for(var u=0,c=this._batchElements.length;u<c;u++){for(var h,_=this._batchElements[u],d=_.meshFilter.sharedMesh,f=this._getStaticBatchBakedVertexs(s,n,a?a._transform:null,_._transform,_._render,d),m=d._indexBuffer.getData(),T=n,p=i+m.length,g=_._render._renderElements,E=0,y=d.subMeshCount;E<y;E++){var S=d._subMeshes[E],v=i+S._indexStart,R=g[E];R.staticBatchIndexStart=v,R.staticBatchIndexEnd=v+S._indexCount}if(l.set(m,i),a?_._transform._isFrontFaceInvert!==a.transform._isFrontFaceInvert:_._transform._isFrontFaceInvert)for(h=i;h<p;h+=3){l[h]=T+l[h];var C=l[h+1],M=l[h+2];l[h+1]=T+M,l[h+2]=T+C}else for(h=i;h<p;h+=3)l[h]=T+l[h],l[h+1]=T+l[h+1],l[h+2]=T+l[h+2];i+=m.length,n+=f}this._vertexBuffer.setData(s.buffer),this._indexBuffer.setData(l);var D=this._vertexBuffer._byteLength+this._indexBuffer._byteLength;t.Resource._addGPUMemory(D),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()}},{key:"_render",value:function(e){this._bufferState.bind();for(var r=t.LayaGL.instance,n=e.renderElement.staticBatchElementList,i=n.elements,a=0,o=0,s=n.length,l=1;l<s;l++){if(i[l-1].staticBatchIndexEnd!==i[l].staticBatchIndexStart){var u=i[a].staticBatchIndexStart,c=i[o].staticBatchIndexEnd-u;r.drawElements(r.TRIANGLES,c,r.UNSIGNED_SHORT,2*u),a=++o,t.Stat.trianglesFaces+=c/3}else o++}u=i[a].staticBatchIndexStart,c=i[o].staticBatchIndexEnd-u,r.drawElements(r.TRIANGLES,c,r.UNSIGNED_SHORT,2*u),t.Stat.renderBatches++,t.Stat.savedRenderBatches+=s-1,t.Stat.trianglesFaces+=c/3}},{key:"dispose",value:function(){var e=this._vertexBuffer._byteLength+this._indexBuffer._byteLength;t.Resource._addGPUMemory(-e),this._batchElements=null,this.batchOwner=null,this._vertexDeclaration=null,this._bufferState.destroy(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._vertexBuffer=null,this._indexBuffer=null,this._bufferState=null}}]),SubMeshStaticBatch}(It);Vt._tempVector30=new o,Vt._tempVector31=new o,Vt._tempQuaternion0=new u,Vt._tempMatrix4x40=new c,Vt._tempMatrix4x41=new c,Vt._tempMatrix4x42=new c,Vt.maxBatchVertexCount=65535,Vt._batchIDCounter=0;var Ft=function(e){function MeshRenderStaticBatchManager(){var e;return _classCallCheck(this,MeshRenderStaticBatchManager),(e=_possibleConstructorReturn(this,_getPrototypeOf(MeshRenderStaticBatchManager).call(this)))._opaqueBatchMarks=[],e._updateCountMark=0,e}return _inherits(MeshRenderStaticBatchManager,e),_createClass(MeshRenderStaticBatchManager,[{key:"_compare",value:function(e,t){var r=e._render,n=t._render,i=e.meshFilter.sharedMesh,a=t.meshFilter.sharedMesh,o=r.lightmapIndex-n.lightmapIndex;if(0===o){var s=(r.receiveShadow?1:0)-(n.receiveShadow?1:0);if(0===s){var l=r.sharedMaterial&&n.sharedMaterial?r.sharedMaterial.id-n.sharedMaterial.id:0;if(0===l){var u=i._vertexBuffer.vertexDeclaration.id-a._vertexBuffer.vertexDeclaration.id;return 0===u?a._indexBuffer.indexCount-i._indexBuffer.indexCount:u}return l}return s}return o}},{key:"_getBatchRenderElementFromPool",value:function(){var e=this._batchRenderElementPool[this._batchRenderElementPoolIndex++];return e||(e=new wt,this._batchRenderElementPool[this._batchRenderElementPoolIndex-1]=e,e.staticBatchElementList=new R),e}},{key:"_getStaticBatch",value:function(e,t,r){var n=e[r];return n||(n=e[r]=new Vt(t,MeshRenderStaticBatchManager._verDec),this._staticBatches[n._batchID]=n),n}},{key:"_initStaticBatchs",value:function(e){var t=this._initBatchSprites;this._quickSort(t,0,t.length-1);for(var r,n=[],i=!1,a=0,o=0,s=t.length;o<s;o++){var l=t[o];if(i)r.addTest(l)?r.add(l):(i=!1,a++);else o!==s-1&&((r=this._getStaticBatch(n,e,a)).add(l),i=!0)}for(o=0,s=n.length;o<s;o++){var u=n[o];u&&u.finishInit()}this._initBatchSprites.length=0}},{key:"_removeRenderSprite",value:function(e){var t=e._render,r=t._staticBatch,n=r._batchElements,i=n.indexOf(e);if(-1!==i){n.splice(i,1),t._staticBatch=null;for(var a=t._renderElements,o=0,s=a.length;o<s;o++)a[o].staticBatch=null}0===n.length&&(delete this._staticBatches[r._batchID],r.dispose())}},{key:"_clear",value:function(){_get(_getPrototypeOf(MeshRenderStaticBatchManager.prototype),"_clear",this).call(this),this._updateCountMark++}},{key:"_garbageCollection",value:function(){for(var e in this._staticBatches){var t=this._staticBatches[e];0===t._batchElements.length&&(t.dispose(),delete this._staticBatches[e])}}},{key:"getBatchOpaquaMark",value:function(e,t,r,n){var i=t?1:0,a=this._opaqueBatchMarks[e]||(this._opaqueBatchMarks[e]=[]),o=a[i]||(a[i]=[]),s=o[r]||(o[r]=[]);return s[n]||(s[n]=new Nt)}}],[{key:"__init__",value:function(){MeshRenderStaticBatchManager._verDec=Qe.getVertexDeclaration("POSITION,NORMAL,COLOR,UV,UV1,TANGENT")}}]),MeshRenderStaticBatchManager}(Bt);Ft.instance=new Ft;var Ut=function(e){function BaseRender(e){var r;if(_classCallCheck(this,BaseRender),(r=_possibleConstructorReturn(this,_getPrototypeOf(BaseRender).call(this)))._lightmapScaleOffset=new i(1,1,0,0),r._indexInList=-1,r._indexInCastShadowList=-1,r._boundsChange=!0,r._castShadow=!1,r._supportOctree=!0,r._sharedMaterials=[],r._renderMark=-1,r._indexInOctreeMotionList=-1,r._updateMark=-1,r._updateRenderType=-1,r._isPartOfStaticBatch=!1,r._staticBatch=null,r._id=++BaseRender._uniqueIDCounter,r._indexInCastShadowList=-1,r._bounds=new At(o._ZERO,o._ZERO),t.Render.supportWebGLPlusCulling){var n=Ie._cullingBufferLength;r._cullingBufferIndex=n;var a=Ie._cullingBuffer,s=n+7;if(s>=a.length){var l=a;(a=Ie._cullingBuffer=new Float32Array(a.length+4096)).set(l,0)}a[n]=2,Ie._cullingBufferLength=s}return r._renderElements=[],r._owner=e,r._enable=!0,r._materialsInstance=[],r._shaderValues=new ce(null),r.lightmapIndex=-1,r.receiveShadow=!1,r.sortingFudge=0,e&&r._owner.transform.on(t.Event.TRANSFORM_CHANGED,_assertThisInitialized(r),r._onWorldMatNeedChange),r}return _inherits(BaseRender,e),_createClass(BaseRender,[{key:"_getOctreeNode",value:function(){return this._octreeNode}},{key:"_setOctreeNode",value:function(e){this._octreeNode=e}},{key:"_getIndexInMotionList",value:function(){return this._indexInOctreeMotionList}},{key:"_setIndexInMotionList",value:function(e){this._indexInOctreeMotionList=e}},{key:"_changeMaterialReference",value:function(e,t){e&&e._removeReference(),t._addReference()}},{key:"_getInstanceMaterial",value:function(e,t){var r=e.clone();return r.name=r.name+"(Instance)",this._materialsInstance[t]=!0,this._changeMaterialReference(this._sharedMaterials[t],r),this._sharedMaterials[t]=r,r}},{key:"_applyLightMapParams",value:function(){var e=this._scene.lightmaps,t=this._shaderValues,r=this._lightmapIndex;if(r>=0&&r<e.length){var n=e[r];t.setTexture(Ot.LIGHTMAP,n.lightmapColor),t.addDefine(Ot.SAHDERDEFINE_LIGHTMAP),n.lightmapDirection?(t.setTexture(Ot.LIGHTMAP_DIRECTION,n.lightmapDirection),t.addDefine(Ot.SHADERDEFINE_LIGHTMAP_DIRECTIONAL)):t.removeDefine(Ot.SHADERDEFINE_LIGHTMAP_DIRECTIONAL)}else t.removeDefine(Ot.SAHDERDEFINE_LIGHTMAP),t.removeDefine(Ot.SHADERDEFINE_LIGHTMAP_DIRECTIONAL)}},{key:"_onWorldMatNeedChange",value:function(e){this._boundsChange=!0,this._octreeNode&&(e&=f.TRANSFORM_WORLDPOSITION|f.TRANSFORM_WORLDQUATERNION|f.TRANSFORM_WORLDSCALE)&&-1===this._indexInOctreeMotionList&&this._octreeNode._octree.addMotionObject(this)}},{key:"_calculateBoundingBox",value:function(){throw"BaseRender: must override it."}},{key:"_getIndexInList",value:function(){return this._indexInList}},{key:"_setIndexInList",value:function(e){this._indexInList=e}},{key:"_setBelongScene",value:function(e){this._scene=e}},{key:"_needRender",value:function(e,t){return!0}},{key:"_renderUpdate",value:function(e,t){}},{key:"_renderUpdateWithCamera",value:function(e,t){}},{key:"_revertBatchRenderUpdate",value:function(e){}},{key:"_destroy",value:function(){-1!==this._indexInOctreeMotionList&&this._octreeNode._octree.removeMotionObject(this),this.offAll();var e=0,t=0;for(e=0,t=this._renderElements.length;e<t;e++)this._renderElements[e].destroy();for(e=0,t=this._sharedMaterials.length;e<t;e++)this._sharedMaterials[e].destroyed||this._sharedMaterials[e]._removeReference();this._renderElements=null,this._owner=null,this._sharedMaterials=null,this._bounds=null,this._lightmapScaleOffset=null}},{key:"markAsUnStatic",value:function(){this._isPartOfStaticBatch&&(Ft.instance._removeRenderSprite(this._owner),this._isPartOfStaticBatch=!1)}},{key:"id",get:function(){return this._id}},{key:"lightmapIndex",get:function(){return this._lightmapIndex},set:function(e){this._lightmapIndex=e}},{key:"lightmapScaleOffset",get:function(){return this._lightmapScaleOffset},set:function(e){if(!e)throw"BaseRender: lightmapScaleOffset can't be null.";this._lightmapScaleOffset=e,this._shaderValues.setVector(Ot.LIGHTMAPSCALEOFFSET,e)}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=!!e}},{key:"material",get:function(){var e=this._sharedMaterials[0];if(e&&!this._materialsInstance[0]){var t=this._getInstanceMaterial(e,0),r=this._renderElements[0];r&&(r.material=t)}return this._sharedMaterials[0]},set:function(e){this.sharedMaterial=e}},{key:"materials",get:function(){for(var e=0,t=this._sharedMaterials.length;e<t;e++)if(!this._materialsInstance[e]){var r=this._getInstanceMaterial(this._sharedMaterials[e],e),n=this._renderElements[e];n&&(n.material=r)}return this._sharedMaterials.slice()},set:function(e){this.sharedMaterials=e}},{key:"sharedMaterial",get:function(){return this._sharedMaterials[0]},set:function(e){var t=this._sharedMaterials[0];if(t!==e){this._sharedMaterials[0]=e,this._materialsInstance[0]=!1,this._changeMaterialReference(t,e);var r=this._renderElements[0];r&&(r.material=e)}}},{key:"sharedMaterials",get:function(){return this._sharedMaterials.slice()},set:function(e){for(var t=this._materialsInstance,r=this._sharedMaterials,n=0,i=r.length;n<i;n++){var a=r[n];a&&a._removeReference()}if(!e)throw new Error("BaseRender: shadredMaterials value can't be null.");var o=e.length;for(t.length=o,r.length=o,n=0;n<o;n++){a=r[n];var s=e[n];if(a!==s){t[n]=!1;var l=this._renderElements[n];l&&(l.material=s)}s&&s._addReference(),r[n]=s}}},{key:"bounds",get:function(){return this._boundsChange&&(this._calculateBoundingBox(),this._boundsChange=!1),this._bounds}},{key:"receiveShadow",set:function(e){this._receiveShadow!==e&&(this._receiveShadow=e,e?this._shaderValues.addDefine(Ot.SHADERDEFINE_RECEIVE_SHADOW):this._shaderValues.removeDefine(Ot.SHADERDEFINE_RECEIVE_SHADOW))},get:function(){return this._receiveShadow}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"isPartOfStaticBatch",get:function(){return this._isPartOfStaticBatch}},{key:"isRender",get:function(){return-1==this._renderMark||this._renderMark==t.Stat.loopCount-1}}]),BaseRender}(t.EventDispatcher);Ut._tempBoundBoxCorners=[new o,new o,new o,new o,new o,new o,new o,new o],Ut._uniqueIDCounter=0,Ut._defaultLightmapScaleOffset=new i(1,1,0,0);var Gt=function(e){function PixelLineRenderer(e){var t;return _classCallCheck(this,PixelLineRenderer),(t=_possibleConstructorReturn(this,_getPrototypeOf(PixelLineRenderer).call(this,e)))._projectionViewWorldMatrix=new c,t}return _inherits(PixelLineRenderer,e),_createClass(PixelLineRenderer,[{key:"_calculateBoundingBox",value:function(){var e=this._owner.transform.worldMatrix,r=this._owner._geometryFilter;if(r._reCalculateBound(),r._bounds._tranform(e,this._bounds),t.Render.supportWebGLPlusCulling){var n=this._bounds.getMin(),i=this._bounds.getMax(),a=Ie._cullingBuffer;a[this._cullingBufferIndex+1]=n.x,a[this._cullingBufferIndex+2]=n.y,a[this._cullingBufferIndex+3]=n.z,a[this._cullingBufferIndex+4]=i.x,a[this._cullingBufferIndex+5]=i.y,a[this._cullingBufferIndex+6]=i.z}}},{key:"_renderUpdateWithCamera",value:function(e,t){var r=e.projectionViewMatrix,n=this._shaderValues;if(t){var i=t.worldMatrix;n.setMatrix4x4(et.WORLDMATRIX,i),c.multiply(r,i,this._projectionViewWorldMatrix),n.setMatrix4x4(et.MVPMATRIX,this._projectionViewWorldMatrix)}else n.setMatrix4x4(et.WORLDMATRIX,c.DEFAULT),n.setMatrix4x4(et.MVPMATRIX,r)}}]),PixelLineRenderer}(Ut),zt=function(e){function PixelLineSprite3D(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return _classCallCheck(this,PixelLineSprite3D),(e=_possibleConstructorReturn(this,_getPrototypeOf(PixelLineSprite3D).call(this,r)))._geometryFilter=new Pt(_assertThisInitialized(e),t),e._render=new Gt(_assertThisInitialized(e)),e._changeRenderObjects(e._render,0,Dt.defaultMaterial),e}return _inherits(PixelLineSprite3D,e),_createClass(PixelLineSprite3D,[{key:"_changeRenderObjects",value:function(e,t,r){var n=this._render._renderElements;r||(r=Dt.defaultMaterial);var i=n[t];i||(i=n[t]=new kt),i.setTransform(this._transform),i.setGeometry(this._geometryFilter),i.render=this._render,i.material=r}},{key:"addLine",value:function(e,t,r,n){if(this._geometryFilter._lineCount===this._geometryFilter._maxLineCount)throw"PixelLineSprite3D: lineCount has equal with maxLineCount.";this._geometryFilter._updateLineData(this._geometryFilter._lineCount++,e,t,r,n)}},{key:"addLines",value:function(e){var t=this._geometryFilter._lineCount,r=e.length;if(t+r>this._geometryFilter._maxLineCount)throw"PixelLineSprite3D: lineCount plus lines count must less than maxLineCount.";this._geometryFilter._updateLineDatas(t,e),this._geometryFilter._lineCount+=r}},{key:"removeLine",value:function(e){if(!(e<this._geometryFilter._lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._removeLineData(e)}},{key:"setLine",value:function(e,t,r,n,i){if(!(e<this._geometryFilter._lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._updateLineData(e,t,r,n,i)}},{key:"getLine",value:function(e,t){if(!(e<this.lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._getLineData(e,t)}},{key:"clear",value:function(){this._geometryFilter._lineCount=0}},{key:"_create",value:function(){return new PixelLineSprite3D}},{key:"maxLineCount",get:function(){return this._geometryFilter._maxLineCount},set:function(e){this._geometryFilter._resizeLineData(e),this._geometryFilter._lineCount=Math.min(this._geometryFilter._lineCount,e)}},{key:"lineCount",get:function(){return this._geometryFilter._lineCount},set:function(e){if(e>this.maxLineCount)throw"PixelLineSprite3D: lineCount can't large than maxLineCount";this._geometryFilter._lineCount=e}},{key:"pixelLineRenderer",get:function(){return this._render}}]),PixelLineSprite3D}(Ot),Ht=function(){function RenderQueue(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];_classCallCheck(this,RenderQueue),this.isTransparent=!1,this.elements=new R,this.lastTransparentRenderElement=null,this.lastTransparentBatched=!1,this.isTransparent=e}return _createClass(RenderQueue,[{key:"_compare",value:function(e,t){var r=e.material.renderQueue-t.material.renderQueue;return 0===r?(this.isTransparent?t.render._distanceForSort-e.render._distanceForSort:e.render._distanceForSort-t.render._distanceForSort)+t.render.sortingFudge-e.render.sortingFudge:r}},{key:"_partitionRenderObject",value:function(e,t){for(var r=this.elements.elements,n=r[Math.floor((t+e)/2)];e<=t;){for(;this._compare(r[e],n)<0;)e++;for(;this._compare(r[t],n)>0;)t--;if(e<t){var i=r[e];r[e]=r[t],r[t]=i,e++,t--}else if(e===t){e++;break}}return e}},{key:"_quickSort",value:function(e,t){if(this.elements.length>1){var r=this._partitionRenderObject(e,t),n=r-1;e<n&&this._quickSort(e,n),r<t&&this._quickSort(r,t)}}},{key:"_render",value:function(e){for(var t=this.elements.elements,r=0,n=this.elements.length;r<n;r++)t[r]._render(e)}},{key:"clear",value:function(){this.elements.length=0,this.lastTransparentRenderElement=null,this.lastTransparentBatched=!1}}]),RenderQueue}(),Wt=function(){function BoundsOctreeNode(e,t,r,n){_classCallCheck(this,BoundsOctreeNode),this._bounds=new xt(new o,new o),this._objects=[],this._isContaion=!1,this.center=new o,this.baseLength=0,this._setValues(e,t,r,n)}return _createClass(BoundsOctreeNode,[{key:"_setValues",value:function(e,t,r,n){this._octree=e,this._parent=t,this.baseLength=r,n.cloneTo(this.center);var i=this._bounds.min,a=this._bounds.max,o=e._looseness*r/2;i.setValue(n.x-o,n.y-o,n.z-o),a.setValue(n.x+o,n.y+o,n.z+o)}},{key:"_getChildBound",value:function(e){if(null!=this._children&&this._children[e])return this._children[e]._bounds;var t=this.baseLength/4,r=this.baseLength/2*this._octree._looseness/2,n=BoundsOctreeNode._tempBoundBox,i=n.min,a=n.max;switch(e){case 0:i.x=this.center.x-t-r,i.y=this.center.y+t-r,i.z=this.center.z-t-r,a.x=this.center.x-t+r,a.y=this.center.y+t+r,a.z=this.center.z-t+r;break;case 1:i.x=this.center.x+t-r,i.y=this.center.y+t-r,i.z=this.center.z-t-r,a.x=this.center.x+t+r,a.y=this.center.y+t+r,a.z=this.center.z-t+r;break;case 2:i.x=this.center.x-t-r,i.y=this.center.y+t-r,i.z=this.center.z+t-r,a.x=this.center.x-t+r,a.y=this.center.y+t+r,a.z=this.center.z+t+r;break;case 3:i.x=this.center.x+t-r,i.y=this.center.y+t-r,i.z=this.center.z+t-r,a.x=this.center.x+t+r,a.y=this.center.y+t+r,a.z=this.center.z+t+r;break;case 4:i.x=this.center.x-t-r,i.y=this.center.y-t-r,i.z=this.center.z-t-r,a.x=this.center.x-t+r,a.y=this.center.y-t+r,a.z=this.center.z-t+r;break;case 5:i.x=this.center.x+t-r,i.y=this.center.y-t-r,i.z=this.center.z-t-r,a.x=this.center.x+t+r,a.y=this.center.y-t+r,a.z=this.center.z-t+r;break;case 6:i.x=this.center.x-t-r,i.y=this.center.y-t-r,i.z=this.center.z+t-r,a.x=this.center.x-t+r,a.y=this.center.y-t+r,a.z=this.center.z+t+r;break;case 7:i.x=this.center.x+t-r,i.y=this.center.y-t-r,i.z=this.center.z+t-r,a.x=this.center.x+t+r,a.y=this.center.y-t+r,a.z=this.center.z+t+r}return n}},{key:"_getChildCenter",value:function(e){if(null!=this._children)return this._children[e].center;var t=this.baseLength/4,r=BoundsOctreeNode._tempVector30;switch(e){case 0:r.x=this.center.x-t,r.y=this.center.y+t,r.z=this.center.z-t;break;case 1:r.x=this.center.x+t,r.y=this.center.y+t,r.z=this.center.z-t;break;case 2:r.x=this.center.x-t,r.y=this.center.y+t,r.z=this.center.z+t;break;case 3:r.x=this.center.x+t,r.y=this.center.y+t,r.z=this.center.z+t;break;case 4:r.x=this.center.x-t,r.y=this.center.y-t,r.z=this.center.z-t;break;case 5:r.x=this.center.x+t,r.y=this.center.y-t,r.z=this.center.z-t;break;case 6:r.x=this.center.x-t,r.y=this.center.y-t,r.z=this.center.z+t;break;case 7:r.x=this.center.x+t,r.y=this.center.y-t,r.z=this.center.z+t}return r}},{key:"_getChild",value:function(e){var t=this.baseLength/4;switch(this._children||(this._children=[]),e){case 0:return this._children[0]||(this._children[0]=new BoundsOctreeNode(this._octree,this,this.baseLength/2,new o(this.center.x+-t,this.center.y+t,this.center.z-t)));case 1:return this._children[1]||(this._children[1]=new BoundsOctreeNode(this._octree,this,this.baseLength/2,new o(this.center.x+t,this.center.y+t,this.center.z-t)));case 2:return this._children[2]||(this._children[2]=new BoundsOctreeNode(this._octree,this,this.baseLength/2,new o(this.center.x-t,this.center.y+t,this.center.z+t)));case 3:return this._children[3]||(this._children[3]=new BoundsOctreeNode(this._octree,this,this.baseLength/2,new o(this.center.x+t,this.center.y+t,this.center.z+t)));case 4:return this._children[4]||(this._children[4]=new BoundsOctreeNode(this._octree,this,this.baseLength/2,new o(this.center.x-t,this.center.y-t,this.center.z-t)));case 5:return this._children[5]||(this._children[5]=new BoundsOctreeNode(this._octree,this,this.baseLength/2,new o(this.center.x+t,this.center.y-t,this.center.z-t)));case 6:return this._children[6]||(this._children[6]=new BoundsOctreeNode(this._octree,this,this.baseLength/2,new o(this.center.x-t,this.center.y-t,this.center.z+t)));case 7:return this._children[7]||(this._children[7]=new BoundsOctreeNode(this._octree,this,this.baseLength/2,new o(this.center.x+t,this.center.y-t,this.center.z+t)));default:throw"BoundsOctreeNode: unknown index."}}},{key:"_shouldMerge",value:function(){for(var e=this._objects.length,t=0;t<8;t++){var r=this._children[t];if(r){if(null!=r._children)return!1;e+=r._objects.length}}return e<=BoundsOctreeNode._NUM_OBJECTS_ALLOWED}},{key:"_mergeChildren",value:function(){for(var e=0;e<8;e++){var t=this._children[e];if(t){t._parent=null;for(var r=t._objects,n=r.length-1;n>=0;n--){var i=r[n];this._objects.push(i),i._setOctreeNode(this)}}}this._children=null}},{key:"_merge",value:function(){if(null===this._children){var e=this._parent;e&&e._shouldMerge()&&(e._mergeChildren(),e._merge())}}},{key:"_checkAddNode",value:function(e){if(null==this._children){if(this._objects.length<BoundsOctreeNode._NUM_OBJECTS_ALLOWED||this.baseLength/2<this._octree._minSize)return this;for(var t=this._objects.length-1;t>=0;t--){var r=this._objects[t],n=this._bestFitChild(r.bounds.getCenter());BoundsOctreeNode._encapsulates(this._getChildBound(n),r.bounds._getBoundBox())&&(this._objects.splice(this._objects.indexOf(r),1),this._getChild(n)._add(r))}}var i=this._bestFitChild(e.bounds.getCenter());return BoundsOctreeNode._encapsulates(this._getChildBound(i),e.bounds._getBoundBox())?this._getChild(i)._checkAddNode(e):this}},{key:"_add",value:function(e){var t=this._checkAddNode(e);t._objects.push(e),e._setOctreeNode(t)}},{key:"_remove",value:function(e){var t=this._objects.indexOf(e);this._objects.splice(t,1),e._setOctreeNode(null),this._merge()}},{key:"_addUp",value:function(e){return Fe.boxContainsBox(this._bounds,e.bounds._getBoundBox())===Be.Contains?(this._add(e),!0):!!this._parent&&this._parent._addUp(e)}},{key:"_getCollidingWithFrustum",value:function(e,r,n,i,a,s){var l=e.boundFrustum,u=e.position,c=e.cullingMask;if(n){var h=l.containsBoundBox(this._bounds);if(t.Stat.octreeNodeCulling++,h===Be.Disjoint)return;n=h===Be.Intersects}this._isContaion=!n;for(var _=r.scene,d=t.Stat.loopCount,f=0,m=this._objects.length;f<m;f++){var T=this._objects[f];if(s?T._castShadow&&T._enable:0!=(Math.pow(2,T._owner._layer)&c)&&T._enable){if(n&&(t.Stat.frustumCulling++,!T._needRender(l,r)))continue;T._renderMark=d,T._distanceForSort=o.distance(T.bounds.getCenter(),u);for(var p=T._renderElements,g=0,E=p.length;g<E;g++){p[g]._update(_,r,i,a)}}}if(null!=this._children)for(f=0;f<8;f++){var y=this._children[f];y&&y._getCollidingWithFrustum(e,r,n,i,a,s)}}},{key:"_getCollidingWithBoundBox",value:function(e,t,r){if(t){var n=Fe.boxContainsBox(this._bounds,e);if(n===Be.Disjoint)return;t=n===Be.Intersects}if(t)for(var i=0,a=this._objects.length;i<a;i++){var o=this._objects[i];Fe.intersectsBoxAndBox(o.bounds._getBoundBox(),e)&&r.push(o)}if(null!=this._children)for(i=0;i<8;i++){this._children[i]._getCollidingWithBoundBox(e,t,r)}}},{key:"_bestFitChild",value:function(e){return(e.x<=this.center.x?0:1)+(e.y>=this.center.y?0:4)+(e.z<=this.center.z?0:2)}},{key:"_update",value:function(e){if(Fe.boxContainsBox(this._bounds,e.bounds._getBoundBox())===Be.Contains){var t=this._checkAddNode(e);if(t!==e._getOctreeNode()){t._objects.push(e),e._setOctreeNode(t);var r=this._objects.indexOf(e);this._objects.splice(r,1),this._merge()}return!0}if(this._parent){var n=this._parent._addUp(e);return n&&(r=this._objects.indexOf(e),this._objects.splice(r,1),this._merge()),n}return!1}},{key:"add",value:function(e){return!!BoundsOctreeNode._encapsulates(this._bounds,e.bounds._getBoundBox())&&(this._add(e),!0)}},{key:"remove",value:function(e){return e._getOctreeNode()===this&&(this._remove(e),!0)}},{key:"update",value:function(e){return e._getOctreeNode()===this&&this._update(e)}},{key:"shrinkIfPossible",value:function(e){if(this.baseLength<2*e)return this;for(var t=-1,r=0,n=this._objects.length;r<n;r++){var i=this._objects[r],a=this._bestFitChild(i.bounds.getCenter());if(0!=r&&a!=t)return this;var o=this._getChildBound(a);if(!BoundsOctreeNode._encapsulates(o,i.bounds._getBoundBox()))return this;0==r&&(t=a)}if(null==this._children){if(-1!=t){var s=this._getChildCenter(t);this._setValues(this._octree,null,this.baseLength/2,s)}return this}var l=!1;for(r=0,n=this._children.length;r<n;r++){var u=this._children[r];if(u&&u.hasAnyObjects()){if(l)return this;if(t>=0&&t!=r)return this;l=!0,t=r}}if(-1!=t){var c=this._children[t];return c._parent=null,c}return this}},{key:"hasAnyObjects",value:function(){if(this._objects.length>0)return!0;if(null!=this._children)for(var e=0;e<8;e++){var t=this._children[e];if(t&&t.hasAnyObjects())return!0}return!1}},{key:"getCollidingWithBoundBox",value:function(e,t){this._getCollidingWithBoundBox(e,!0,t)}},{key:"getCollidingWithRay",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.MAX_VALUE,n=Fe.intersectsRayAndBoxRD(e,this._bounds);if(!(-1==n||n>r)){for(var i=0,a=this._objects.length;i<a;i++){var o=this._objects[i];-1!==(n=Fe.intersectsRayAndBoxRD(e,o.bounds._getBoundBox()))&&n<=r&&t.push(o)}if(null!=this._children)for(i=0;i<8;i++){var s=this._children[i];s.getCollidingWithRay(e,t,r)}}}},{key:"getCollidingWithFrustum",value:function(e,t,r,n,i){this._getCollidingWithFrustum(e,t,!0,r,n,i)}},{key:"isCollidingWithBoundBox",value:function(e){if(!Fe.intersectsBoxAndBox(this._bounds,e))return!1;for(var t=0,r=this._objects.length;t<r;t++){var n=this._objects[t];if(Fe.intersectsBoxAndBox(n.bounds._getBoundBox(),e))return!0}if(null!=this._children)for(t=0;t<8;t++){if(this._children[t].isCollidingWithBoundBox(e))return!0}return!1}},{key:"isCollidingWithRay",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Number.MAX_VALUE,r=Fe.intersectsRayAndBoxRD(e,this._bounds);if(-1==r||r>t)return!1;for(var n=0,i=this._objects.length;n<i;n++){var a=this._objects[n];if(-1!==(r=Fe.intersectsRayAndBoxRD(e,a.bounds._getBoundBox()))&&r<=t)return!0}if(null!=this._children)for(n=0;n<8;n++){var o=this._children[n];if(o.isCollidingWithRay(e,t))return!0}return!1}},{key:"getBound",value:function(){return this._bounds}},{key:"drawAllBounds",value:function(e,t,r){if(null!==this._children||0!=this._objects.length){t++;var n=BoundsOctreeNode._tempColor0;if(this._isContaion)n.r=0,n.g=0,n.b=1;else{var i=r?t/r:0;n.r=1-i,n.g=i,n.b=0}if(n.a=.3,P._drawBound(e,this._bounds,n),null!=this._children)for(var a=0;a<8;a++){var o=this._children[a];o&&o.drawAllBounds(e,t,r)}}}},{key:"drawAllObjects",value:function(e,t,r){t++;var n=BoundsOctreeNode._tempColor0;if(this._isContaion)n.r=0,n.g=0,n.b=1;else{var i=r?t/r:0;n.r=1-i,n.g=i,n.b=0}n.a=1;for(var a=0,o=this._objects.length;a<o;a++)P._drawBound(e,this._objects[a].bounds._getBoundBox(),n);if(null!=this._children)for(a=0;a<8;a++){var s=this._children[a];s&&s.drawAllObjects(e,t,r)}}}],[{key:"_encapsulates",value:function(e,t){return Fe.boxContainsBox(e,t)==Be.Contains}}]),BoundsOctreeNode}();Wt._tempVector3=new o,Wt._tempVector30=new o,Wt._tempVector31=new o,Wt._tempColor0=new De,Wt._tempBoundBox=new xt(new o,new o),Wt._NUM_OBJECTS_ALLOWED=8;var Xt=function(e){function OctreeMotionList(){return _classCallCheck(this,OctreeMotionList),_possibleConstructorReturn(this,_getPrototypeOf(OctreeMotionList).call(this))}return _inherits(OctreeMotionList,e),_createClass(OctreeMotionList,[{key:"add",value:function(e){if(-1!==e._getIndexInMotionList())throw"OctreeMotionList:element has  in  PhysicsUpdateList.";this._add(e),e._setIndexInMotionList(this.length++)}},{key:"remove",value:function(e){var t=e._getIndexInMotionList();if(this.length--,t!==this.length){var r=this.elements[this.length];this.elements[t]=r,r._setIndexInMotionList(t)}e._setIndexInMotionList(-1)}}]),OctreeMotionList}(R),Yt=function(){function BoundsOctree(e,t,r,n){_classCallCheck(this,BoundsOctree),this._motionObjects=new Xt,this.count=0,r>e&&(console.warn("Minimum node size must be at least as big as the initial world size. Was: "+r+" Adjusted to: "+e),r=e),this._initialSize=e,this._minSize=r,this._looseness=Math.min(Math.max(n,1),2),this._rootNode=new Wt(this,null,e,t)}return _createClass(BoundsOctree,[{key:"_getMaxDepth",value:function(e,t){t++;var r=e._children;if(null!=r)for(var n=t,i=0,a=r.length;i<a;i++){var o=r[i];o&&(t=Math.max(this._getMaxDepth(o,n),t))}return t}},{key:"_grow",value:function(e){var t=e.x>=0?1:-1,r=e.y>=0?1:-1,n=e.z>=0?1:-1,i=this._rootNode,a=this._rootNode.baseLength/2,s=2*this._rootNode.baseLength,l=this._rootNode.center,u=new o(l.x+t*a,l.y+r*a,l.z+n*a);if(this._rootNode=new Wt(this,null,s,u),i.hasAnyObjects()){for(var c=this._rootNode._bestFitChild(i.center),h=[],_=0;_<8;_++)_==c&&(i._parent=this._rootNode,h[_]=i);this._rootNode._children=h}}},{key:"add",value:function(e){for(var t=0;!this._rootNode.add(e);){var r=BoundsOctree._tempVector30;if(o.subtract(e.bounds.getCenter(),this._rootNode.center,r),this._grow(r),++t>20)throw"Aborted Add operation as it seemed to be going on forever ("+(t-1)+") attempts at growing the octree."}this.count++}},{key:"remove",value:function(e){var t=e._getOctreeNode().remove(e);return t&&this.count--,t}},{key:"update",value:function(e){var t=0,r=e._getOctreeNode();if(r){for(;!r._update(e);){var n=BoundsOctree._tempVector30;if(o.subtract(e.bounds.getCenter(),this._rootNode.center,n),this._grow(n),++t>20)throw"Aborted Add operation as it seemed to be going on forever ("+(t-1)+") attempts at growing the octree."}return!0}return!1}},{key:"shrinkRootIfPossible",value:function(){this._rootNode=this._rootNode.shrinkIfPossible(this._initialSize)}},{key:"addMotionObject",value:function(e){this._motionObjects.add(e)}},{key:"removeMotionObject",value:function(e){this._motionObjects.remove(e)}},{key:"updateMotionObjects",value:function(){for(var e=this._motionObjects.elements,t=0,r=this._motionObjects.length;t<r;t++){var n=e[t];this.update(n),n._setIndexInMotionList(-1)}this._motionObjects.length=0}},{key:"isCollidingWithBoundBox",value:function(e){return this._rootNode.isCollidingWithBoundBox(e)}},{key:"isCollidingWithRay",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Number.MAX_VALUE;return this._rootNode.isCollidingWithRay(e,t)}},{key:"getCollidingWithBoundBox",value:function(e,t){this._rootNode.getCollidingWithBoundBox(e,t)}},{key:"getCollidingWithRay",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.MAX_VALUE;this._rootNode.getCollidingWithRay(e,t,r)}},{key:"getCollidingWithFrustum",value:function(e,t,r,n,i){this._rootNode.getCollidingWithFrustum(e,t,r,n,i)}},{key:"getMaxBounds",value:function(){return this._rootNode.getBound()}},{key:"drawAllBounds",value:function(e){var t=this._getMaxDepth(this._rootNode,-1);this._rootNode.drawAllBounds(e,-1,t)}},{key:"drawAllObjects",value:function(e){var t=this._getMaxDepth(this._rootNode,-1);this._rootNode.drawAllObjects(e,-1,t)}}]),BoundsOctree}();Yt._tempVector30=new o;var jt=function Lightmap(){_classCallCheck(this,Lightmap)},Zt=function(){function BoundSphere(e,t){_classCallCheck(this,BoundSphere),this.center=e,this.radius=t}return _createClass(BoundSphere,[{key:"toDefault",value:function(){this.center.toDefault(),this.radius=0}},{key:"intersectsRayDistance",value:function(e){return Fe.intersectsRayAndSphereRD(e,this)}},{key:"intersectsRayPoint",value:function(e,t){return Fe.intersectsRayAndSphereRP(e,this,t)}},{key:"cloneTo",value:function(e){var t=e;this.center.cloneTo(t.center),t.radius=this.radius}},{key:"clone",value:function(){var e=new BoundSphere(new o,0);return this.cloneTo(e),e}}],[{key:"createFromSubPoints",value:function(e,t,r,n){if(null==e)throw new Error("points");if(t<0||t>=e.length)throw new Error("start"+t+"Must be in the range [0, "+(e.length-1)+"]");if(r<0||t+r>e.length)throw new Error("count"+r+"Must be in the range <= "+e.length+"}");var i=t+r,a=BoundSphere._tempVector3;a.x=0,a.y=0,a.z=0;for(var s=t;s<i;++s)o.add(e[s],a,a);var l=n.center;o.scale(a,1/r,l);var u=0;for(s=t;s<i;++s){var c=o.distanceSquared(l,e[s]);c>u&&(u=c)}n.radius=Math.sqrt(u)}},{key:"createfromPoints",value:function(e,t){if(null==e)throw new Error("points");BoundSphere.createFromSubPoints(e,0,e.length,t)}}]),BoundSphere}();Zt._tempVector3=new o;var Qt,qt=function ShadowSliceData(){_classCallCheck(this,ShadowSliceData),this.cameraShaderValue=new ce,this.position=new o,this.viewMatrix=new c,this.projectionMatrix=new c,this.viewProjectMatrix=new c,this.cullPlanes=[new ke(new o),new ke(new o),new ke(new o),new ke(new o),new ke(new o),new ke(new o),new ke(new o),new ke(new o),new ke(new o),new ke(new o)],this.splitBoundSphere=new Zt(new o,0)},Kt=function ShadowSpotData(){_classCallCheck(this,ShadowSpotData),this.cameraShaderValue=new ce,this.position=new o,this.viewMatrix=new c,this.projectionMatrix=new c,this.viewProjectMatrix=new c,this.cameraCullInfo=new xe};(Qt=e.ShadowLightType||(e.ShadowLightType={}))[Qt.DirectionLight=0]="DirectionLight",Qt[Qt.SpotLight=1]="SpotLight",Qt[Qt.PointLight=2]="PointLight";var Jt=function(){function ShadowCasterPass(){_classCallCheck(this,ShadowCasterPass),this._shadowBias=new i,this._shadowParams=new i,this._shadowMapSize=new i,this._shadowMatrices=new Float32Array(16*ShadowCasterPass._maxCascades),this._shadowSpotMatrices=new c,this._splitBoundSpheres=new Float32Array(4*ShadowCasterPass._maxCascades),this._cascadeCount=0,this._shadowMapWidth=0,this._shadowMapHeight=0,this._shadowSliceDatas=[new qt,new qt,new qt,new qt],this._shadowSpotData=new Kt,this._lightUp=new o,this._lightSide=new o,this._lightForward=new o,this._shadowSpotData.cameraCullInfo.boundFrustum=new Ue(new c)}return _createClass(ShadowCasterPass,[{key:"_setupShadowCasterShaderValues",value:function(t,r,n,i,a,o,s){switch(r.setVector(ShadowCasterPass.SHADOW_BIAS,o),s){case e.LightType.Directional:r.setVector3(ShadowCasterPass.SHADOW_LIGHT_DIRECTION,i);break;case e.LightType.Spot:r.setVector(ShadowCasterPass.SHADOW_PARAMS,a);break;case e.LightType.Point:}var l=n.cameraShaderValue;l.setMatrix4x4(rt.VIEWMATRIX,n.viewMatrix),l.setMatrix4x4(rt.PROJECTMATRIX,n.projectionMatrix),l.setMatrix4x4(rt.VIEWPROJECTMATRIX,n.viewProjectMatrix),t.viewMatrix=n.viewMatrix,t.projectionMatrix=n.projectionMatrix,t.projectionViewMatrix=n.viewProjectMatrix}},{key:"_setupShadowReceiverShaderValues",value:function(t){var r=this._light;switch(r.shadowCascadesMode!==e.ShadowCascadesMode.NoCascades?t.addDefine(ht.SHADERDEFINE_SHADOW_CASCADE):t.removeDefine(ht.SHADERDEFINE_SHADOW_CASCADE),r.shadowMode){case e.ShadowMode.Hard:t.removeDefine(ht.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW),t.removeDefine(ht.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH);break;case e.ShadowMode.SoftLow:t.addDefine(ht.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW),t.removeDefine(ht.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH);break;case e.ShadowMode.SoftHigh:t.addDefine(ht.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH),t.removeDefine(ht.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW)}t.setTexture(ShadowCasterPass.SHADOW_MAP,this._shadowDirectLightMap),t.setBuffer(ShadowCasterPass.SHADOW_MATRICES,this._shadowMatrices),t.setVector(ShadowCasterPass.SHADOW_MAP_SIZE,this._shadowMapSize),t.setVector(ShadowCasterPass.SHADOW_PARAMS,this._shadowParams),t.setBuffer(ShadowCasterPass.SHADOW_SPLIT_SPHERES,this._splitBoundSpheres)}},{key:"_setupSpotShadowReceiverShaderValues",value:function(t){switch(this._light.shadowMode){case e.ShadowMode.Hard:t.removeDefine(ht.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH),t.removeDefine(ht.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW);break;case e.ShadowMode.SoftLow:t.addDefine(ht.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW),t.removeDefine(ht.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH);break;case e.ShadowMode.SoftHigh:t.addDefine(ht.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH),t.removeDefine(ht.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW)}t.setTexture(ShadowCasterPass.SHADOW_SPOTMAP,this._shadowSpotLightMap),t.setMatrix4x4(ShadowCasterPass.SHADOW_SPOTMATRICES,this._shadowSpotMatrices),t.setVector(ShadowCasterPass.SHADOW_MAP_SIZE,this._shadowMapSize),t.setVector(ShadowCasterPass.SHADOW_PARAMS,this._shadowParams)}},{key:"update",value:function(t,n,i){switch(i){case e.ShadowLightType.DirectionLight:this._light=n;var a=(D=ShadowCasterPass._tempMatrix0).elements,s=this._lightUp,l=this._lightSide,u=this._lightForward;c.createFromQuaternion(n._transform.rotation,D),l.setValue(a[0],a[1],a[2]),s.setValue(a[4],a[5],a[6]),u.setValue(-a[8],-a[9],-a[10]);var h,_,d,f,m=n._shadowResolution,T=n._shadowCascadesMode;T==e.ShadowCascadesMode.NoCascades?(h=1,_=m,d=m,f=m):(h=T==e.ShadowCascadesMode.TwoCascades?2:4,d=2*(_=Tt.getMaxTileResolutionInAtlas(m,m,h)),f=T==e.ShadowCascadesMode.TwoCascades?_:2*_),this._cascadeCount=h,this._shadowMapWidth=d,this._shadowMapHeight=f;var p=ShadowCasterPass._cascadesSplitDistance,g=ShadowCasterPass._frustumPlanes,E=t.nearPlane,y=Math.min(t.farPlane,n._shadowDistance),S=this._shadowMatrices,v=this._splitBoundSpheres;Tt.getCascadesSplitDistance(n._shadowTwoCascadeSplits,n._shadowFourCascadeSplits,E,y,t.fieldOfView*r.Deg2Rad,t.aspectRatio,T,p),Tt.getCameraFrustumPlanes(t.projectionViewMatrix,g);var R=ShadowCasterPass._tempVector30;t._transform.getForward(R),o.normalize(R,R);for(var C=0;C<h;C++){var M=this._shadowSliceDatas[C];M.sphereCenterZ=Tt.getBoundSphereByFrustum(p[C],p[C+1],t.fieldOfView*r.Deg2Rad,t.aspectRatio,t._transform.position,R,M.splitBoundSphere),Tt.getDirectionLightShadowCullPlanes(g,C,p,E,u,M),Tt.getDirectionalLightMatrices(s,l,u,C,n._shadowNearPlane,_,M,S),h>1&&Tt.applySliceTransform(M,d,f,C,S)}Tt.prepareShadowReceiverShaderValues(n,d,f,this._shadowSliceDatas,h,this._shadowMapSize,this._shadowParams,S,v);break;case e.ShadowLightType.SpotLight:this._light=n;var D=ShadowCasterPass._tempMatrix0,x=(u=this._lightForward,this._light._shadowResolution);this._shadowMapWidth=x,this._shadowMapHeight=x;var A=this._shadowSpotData;Tt.getSpotLightShadowData(A,this._light,x,this._shadowParams,this._shadowSpotMatrices,this._shadowMapSize);break;case e.ShadowLightType.PointLight:break;default:throw"There is no shadow of this type"}}},{key:"render",value:function(r,n,i){switch(i){case e.ShadowLightType.DirectionLight:var a=n._shaderValues;r.pipelineMode="ShadowCaster",ce.setRuntimeValueMode(!1),(T=this._shadowDirectLightMap=Tt.getTemporaryShadowTexture(this._shadowMapWidth,this._shadowMapHeight,t.RenderTextureDepthFormat.DEPTH_16))._start();for(var o=this._light,s=0,l=this._cascadeCount;s<l;s++){var u=this._shadowSliceDatas[s];Tt.getShadowBias(o,u.projectionMatrix,u.resolution,this._shadowBias),this._setupShadowCasterShaderValues(r,a,u,this._lightForward,this._shadowParams,this._shadowBias,e.LightType.Directional);var c=Ie._shadowCullInfo;c.position=u.position,c.cullPlanes=u.cullPlanes,c.cullPlaneCount=u.cullPlaneCount,c.cullSphere=u.splitBoundSphere,c.direction=this._lightForward;var h=Ie.cullingShadow(c,n,r);r.cameraShaderValue=u.cameraShaderValue,pt._updateMark++;var _=t.LayaGL.instance,d=u.resolution,f=u.offsetX,m=u.offsetY;_.enable(_.SCISSOR_TEST),_.viewport(f,m,d,d),_.scissor(f,m,d,d),_.clear(_.DEPTH_BUFFER_BIT),h&&(_.scissor(f+1,m+1,d-2,d-2),n._opaqueQueue._render(r))}T._end(),this._setupShadowReceiverShaderValues(a),ce.setRuntimeValueMode(!0),r.pipelineMode="Forward";break;case e.ShadowLightType.SpotLight:a=n._shaderValues;r.pipelineMode="ShadowCaster",ce.setRuntimeValueMode(!1);var T,p=this._light;(T=this._shadowSpotLightMap=Tt.getTemporaryShadowTexture(this._shadowMapWidth,this._shadowMapHeight,t.RenderTextureDepthFormat.DEPTH_16))._start();var g=this._shadowSpotData;Tt.getShadowBias(p,g.projectionMatrix,g.resolution,this._shadowBias),this._setupShadowCasterShaderValues(r,a,g,this._light.transform.position,this._shadowParams,this._shadowBias,e.LightType.Spot);h=Ie.cullingSpotShadow(g.cameraCullInfo,n,r);r.cameraShaderValue=g.cameraShaderValue,pt._updateMark++,(_=t.LayaGL.instance).enable(_.SCISSOR_TEST),_.viewport(g.offsetX,g.offsetY,g.resolution,g.resolution),_.scissor(g.offsetX,g.offsetY,g.resolution,g.resolution),_.clear(_.DEPTH_BUFFER_BIT),h&&(_.scissor(g.offsetX,g.offsetY,g.resolution,g.resolution),n._opaqueQueue._render(r)),T._end(),this._setupSpotShadowReceiverShaderValues(a),ce.setRuntimeValueMode(!0),r.pipelineMode="Forward";break;case e.ShadowLightType.PointLight:break;default:throw"There is no shadow of this type"}}},{key:"cleanUp",value:function(){this._shadowDirectLightMap&&ie.recoverToPool(this._shadowDirectLightMap),this._shadowSpotLightMap&&ie.recoverToPool(this._shadowSpotLightMap),this._shadowDirectLightMap=null,this._shadowSpotLightMap=null,this._light=null}}]),ShadowCasterPass}();Jt._tempVector30=new o,Jt._tempMatrix0=new c,Jt.SHADOW_BIAS=ue.propertyNameToID("u_ShadowBias"),Jt.SHADOW_LIGHT_DIRECTION=ue.propertyNameToID("u_ShadowLightDirection"),Jt.SHADOW_SPLIT_SPHERES=ue.propertyNameToID("u_ShadowSplitSpheres"),Jt.SHADOW_MATRICES=ue.propertyNameToID("u_ShadowMatrices"),Jt.SHADOW_MAP_SIZE=ue.propertyNameToID("u_ShadowMapSize"),Jt.SHADOW_MAP=ue.propertyNameToID("u_ShadowMap"),Jt.SHADOW_PARAMS=ue.propertyNameToID("u_ShadowParams"),Jt.SHADOW_SPOTMAP=ue.propertyNameToID("u_SpotShadowMap"),Jt.SHADOW_SPOTMATRICES=ue.propertyNameToID("u_SpotViewProjectMatrix"),Jt._maxCascades=4,Jt._cascadesSplitDistance=new Array(Jt._maxCascades+1),Jt._frustumPlanes=new Array(new ke(new o),new ke(new o),new ke(new o),new ke(new o),new ke(new o),new ke(new o));var $t,er=function(){function DynamicBatchManager(){_classCallCheck(this,DynamicBatchManager),this._batchRenderElementPool=[]}return _createClass(DynamicBatchManager,[{key:"_clear",value:function(){this._batchRenderElementPoolIndex=0}},{key:"_getBatchRenderElementFromPool",value:function(){throw"StaticBatch:must override this function."}},{key:"dispose",value:function(){}}],[{key:"_registerManager",value:function(e){DynamicBatchManager._managers.push(e)}}]),DynamicBatchManager}();er._managers=[],($t=e.AmbientMode||(e.AmbientMode={}))[$t.SolidColor=0]="SolidColor",$t[$t.SphericalHarmonics=1]="SphericalHarmonics";var tr=function(r){function Scene3D(){var r;_classCallCheck(this,Scene3D),(r=_possibleConstructorReturn(this,_getPrototypeOf(Scene3D).call(this)))._lightCount=0,r._pointLights=new Ct,r._spotLights=new Ct,r._directionLights=new Ct,r._alternateLights=new Mt,r._lightmaps=[],r._skyRenderer=new $e,r._input=new gt,r._timer=t.ILaya.timer,r._time=0,r._shCoefficients=new Array(7),r._ambientMode=e.AmbientMode.SolidColor,r._ambientSphericalHarmonics=new Oe,r._ambientSphericalHarmonicsIntensity=1,r._reflectionDecodeFormat=t.TextureDecodeFormat.Normal,r._reflectionIntensity=1,r._collsionTestList=[],r._renders=new Me,r._opaqueQueue=new Ht(!1),r._transparentQueue=new Ht(!0),r._cameraPool=[],r._animatorPool=new Me,r._scriptPool=new Array,r._tempScriptPool=new Array,r._needClearScriptPool=!1,r._reflectionCubeHDRParams=new i,r.currentCreationLayer=Math.pow(2,0),r.enableLight=!0,r._key=new t.SubmitKey,r._pickIdToSprite=new Object,r._reflectionMode=0,!w._config.isUseCannonPhysicsEngine&&k._bullet?r._physicsSimulation=new I(Scene3D.physicsSettings):k._cannon&&(r._cannonPhysicsSimulation=new t.CannonPhysicsSimulation(Scene3D.cannonPhysicsSettings)),r._shaderValues=new ce(null),r.enableFog=!1,r.fogStart=300,r.fogRange=1e3,r.fogColor=new o(.7,.7,.7),r.ambientColor=new o(.212,.227,.259),r.reflectionIntensity=1,r.reflection=Rt.blackTexture;for(var n=0;n<7;n++)r._shCoefficients[n]=new i;if(r._shaderValues.setVector(Scene3D.REFLECTIONCUBE_HDR_PARAMS,r._reflectionCubeHDRParams),t.Render.supportWebGLPlusCulling&&(r._cullingBufferIndices=new Int32Array(1024),r._cullingBufferResult=new Int32Array(1024)),r._scene=_assertThisInitialized(r),r._input.__init__(t.Render.canvas,_assertThisInitialized(r)),Scene3D.octreeCulling&&(r._octree=new Yt(Scene3D.octreeInitialSize,Scene3D.octreeInitialCenter,Scene3D.octreeMinNodeSize,Scene3D.octreeLooseness)),Ie.debugFrustumCulling){r._debugTool=new zt;var a=new Dt;a.renderQueue=me.RENDERQUEUE_TRANSPARENT,a.alphaTest=!1,a.depthWrite=!1,a.cull=pe.CULL_BACK,a.blend=pe.BLEND_ENABLE_ALL,a.blendSrc=pe.BLENDPARAM_SRC_ALPHA,a.blendDst=pe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,a.depthTest=pe.DEPTHTEST_LESS,r._debugTool.pixelLineRenderer.sharedMaterial=a}return r}return _inherits(Scene3D,r),_createClass(Scene3D,[{key:"_applySHCoefficients",value:function(e,t){for(var r=this._shCoefficients,n=0;n<3;n++){var i=r[n],a=r[n+3];i.setValue(e.getCoefficient(n,3)*t,e.getCoefficient(n,1)*t,e.getCoefficient(n,2)*t,(e.getCoefficient(n,0)-e.getCoefficient(n,6))*t),a.setValue(e.getCoefficient(n,4)*t,e.getCoefficient(n,5)*t,3*e.getCoefficient(n,6)*t,e.getCoefficient(n,7)*t)}r[6].setValue(e.getCoefficient(0,8)*t,e.getCoefficient(1,8)*t,e.getCoefficient(2,8)*t,1);var o=this._shaderValues;o.setVector(Scene3D.AMBIENTSHAR,r[0]),o.setVector(Scene3D.AMBIENTSHAG,r[1]),o.setVector(Scene3D.AMBIENTSHAB,r[2]),o.setVector(Scene3D.AMBIENTSHBR,r[3]),o.setVector(Scene3D.AMBIENTSHBG,r[4]),o.setVector(Scene3D.AMBIENTSHBB,r[5]),o.setVector(Scene3D.AMBIENTSHC,r[6])}},{key:"_update",value:function(){var e=this.timer._delta/1e3;this._time+=e,this._shaderValues.setNumber(Scene3D.TIME,this._time);var r=this._physicsSimulation;if(!k._enablePhysics||I.disableSimulation||w._config.isUseCannonPhysicsEngine||(r._updatePhysicsTransformFromRender(),v._addUpdateList=!1,r._simulate(e),r._updateCharacters(),v._addUpdateList=!0,r._updateCollisions(),r._eventScripts()),k._cannon&&w._config.isUseCannonPhysicsEngine){var n=this._cannonPhysicsSimulation;n._updatePhysicsTransformFromRender(),t.CannonPhysicsComponent._addUpdateList=!1,n._simulate(e),t.CannonPhysicsComponent._addUpdateList=!0,n._updateCollisions(),n._eventScripts()}this._input._update(),this._clearScript(),this._updateScript(),te._update(this),t.VideoTexture._update(),this._lateUpdateScript()}},{key:"_binarySearchIndexInCameraPool",value:function(e){for(var t,r=0,n=this._cameraPool.length-1;r<=n;){t=Math.floor((r+n)/2);var i=this._cameraPool[t]._renderingOrder;if(i==e._renderingOrder)return t;i>e._renderingOrder?n=t-1:r=t+1}return r}},{key:"_allotPickColorByID",value:function(e,t){var r=Math.floor(e/65025);e-=255*r*255;var n=Math.floor(e/255),i=e-=255*n;t.x=r/255,t.y=n/255,t.z=i/255,t.w=1}},{key:"_searchIDByPickColor",value:function(e){return 255*e.x*255+255*e.y+e.z}},{key:"onEnable",value:function(){this._input._onCanvasEvent(t.Render.canvas)}},{key:"onDisable",value:function(){this._input._offCanvasEvent(t.Render.canvas)}},{key:"_setCreateURL",value:function(e){this._url=t.URL.formatURL(e)}},{key:"_getGroup",value:function(){return this._group}},{key:"_setGroup",value:function(e){this._group=e}},{key:"_clearScript",value:function(){if(this._needClearScriptPool){for(var e=this._scriptPool,t=0,r=e.length;t<r;t++){var n=e[t];n&&(n._indexInPool=this._tempScriptPool.length,this._tempScriptPool.push(n))}this._scriptPool=this._tempScriptPool,e.length=0,this._tempScriptPool=e,this._needClearScriptPool=!1}}},{key:"_updateScript",value:function(){for(var e=this._scriptPool,t=0,r=e.length;t<r;t++){var n=e[t];n&&n.enabled&&n.onUpdate()}}},{key:"_lateUpdateScript",value:function(){for(var e=this._scriptPool,t=0,r=e.length;t<r;t++){var n=e[t];n&&n.enabled&&n.onLateUpdate()}}},{key:"_onActive",value:function(){_get(_getPrototypeOf(Scene3D.prototype),"_onActive",this).call(this),t.ILaya.stage._scene3Ds.push(this)}},{key:"_onInActive",value:function(){_get(_getPrototypeOf(Scene3D.prototype),"_onInActive",this).call(this);var e=t.ILaya.stage._scene3Ds;e.splice(e.indexOf(this),1)}},{key:"_prepareSceneToRender",value:function(){var e=this._shaderValues;if(w._config._multiLighting){var t=Scene3D._lightTexture,r=Scene3D._lightPixles,n=t.width,i=4*n,a=0,s=this._directionLights._length,l=this._directionLights._elements;if(s>0){var u=this._directionLights.getBrightestLight();this._mainDirectionLight=l[u],this._directionLights.normalLightOrdering(u);for(var c=0;c<s;c++,a++){var h=(v=l[c])._direction,_=v._intensityColor,d=i*a;o.scale(v.color,v._intensity,_),v.transform.worldMatrix.getForward(h),o.normalize(h,h),r[d]=_.x,r[d+1]=_.y,r[d+2]=_.z,r[d+4]=h.x,r[d+5]=h.y,r[d+6]=h.z,0==c&&(e.setVector3(Scene3D.SUNLIGHTDIRCOLOR,_),e.setVector3(Scene3D.SUNLIGHTDIRECTION,h))}e.addDefine(ht.SHADERDEFINE_DIRECTIONLIGHT)}else e.removeDefine(ht.SHADERDEFINE_DIRECTIONLIGHT);var f=this._pointLights._length;if(f>0){var m=this._pointLights._elements,T=this._pointLights.getBrightestLight();this._mainPointLight=m[T],this._pointLights.normalLightOrdering(T);for(c=0;c<f;c++,a++){var p=(R=m[c]).transform.position;_=R._intensityColor,d=i*a;o.scale(R.color,R._intensity,_),r[d]=_.x,r[d+1]=_.y,r[d+2]=_.z,r[d+3]=R.range,r[d+4]=p.x,r[d+5]=p.y,r[d+6]=p.z}e.addDefine(ht.SHADERDEFINE_POINTLIGHT)}else e.removeDefine(ht.SHADERDEFINE_POINTLIGHT);var g=this._spotLights._length;if(g>0){var E=this._spotLights._elements,y=this._spotLights.getBrightestLight();this._mainSpotLight=E[y],this._spotLights.normalLightOrdering(y);for(c=0;c<g;c++,a++){var S=E[c];h=S._direction,p=S.transform.position,_=S._intensityColor,d=i*a;o.scale(S.color,S._intensity,_),S.transform.worldMatrix.getForward(h),o.normalize(h,h),r[d]=_.x,r[d+1]=_.y,r[d+2]=_.z,r[d+3]=S.range,r[d+4]=p.x,r[d+5]=p.y,r[d+6]=p.z,r[d+7]=S.spotAngle*Math.PI/180,r[d+8]=h.x,r[d+9]=h.y,r[d+10]=h.z}e.addDefine(ht.SHADERDEFINE_SPOTLIGHT)}else e.removeDefine(ht.SHADERDEFINE_SPOTLIGHT);a>0&&t.setSubPixels(0,0,n,a,r,0),e.setTexture(Scene3D.LIGHTBUFFER,t),e.setInt(Scene3D.DIRECTIONLIGHTCOUNT,this._directionLights._length),e.setTexture(Scene3D.CLUSTERBUFFER,Pe.instance._clusterTexture)}else{if(this._directionLights._length>0){var v=this._directionLights._elements[0];this._mainDirectionLight=v,o.scale(v.color,v._intensity,v._intensityColor),v.transform.worldMatrix.getForward(v._direction),o.normalize(v._direction,v._direction),e.setVector3(Scene3D.LIGHTDIRCOLOR,v._intensityColor),e.setVector3(Scene3D.LIGHTDIRECTION,v._direction),e.setVector3(Scene3D.SUNLIGHTDIRCOLOR,v._intensityColor),e.setVector3(Scene3D.SUNLIGHTDIRECTION,v._direction),e.addDefine(ht.SHADERDEFINE_DIRECTIONLIGHT)}else e.removeDefine(ht.SHADERDEFINE_DIRECTIONLIGHT);if(this._pointLights._length>0){var R=this._pointLights._elements[0];this._mainPointLight=R,o.scale(R.color,R._intensity,R._intensityColor),e.setVector3(Scene3D.POINTLIGHTCOLOR,R._intensityColor),e.setVector3(Scene3D.POINTLIGHTPOS,R.transform.position),e.setNumber(Scene3D.POINTLIGHTRANGE,R.range),e.addDefine(ht.SHADERDEFINE_POINTLIGHT)}else e.removeDefine(ht.SHADERDEFINE_POINTLIGHT);if(this._spotLights._length>0){var C=this._spotLights._elements[0];this._mainSpotLight=C,o.scale(C.color,C._intensity,C._intensityColor),e.setVector3(Scene3D.SPOTLIGHTCOLOR,C._intensityColor),e.setVector3(Scene3D.SPOTLIGHTPOS,C.transform.position),C.transform.worldMatrix.getForward(C._direction),o.normalize(C._direction,C._direction),e.setVector3(Scene3D.SPOTLIGHTDIRECTION,C._direction),e.setNumber(Scene3D.SPOTLIGHTRANGE,C.range),e.setNumber(Scene3D.SPOTLIGHTSPOTANGLE,C.spotAngle*Math.PI/180),e.addDefine(ht.SHADERDEFINE_SPOTLIGHT)}else e.removeDefine(ht.SHADERDEFINE_SPOTLIGHT)}}},{key:"_addScript",value:function(e){var t=this._scriptPool;e._indexInPool=t.length,t.push(e)}},{key:"_removeScript",value:function(e){this._scriptPool[e._indexInPool]=null,e._indexInPool=-1,this._needClearScriptPool=!0}},{key:"_preRenderScript",value:function(){for(var e=this._scriptPool,t=0,r=e.length;t<r;t++){var n=e[t];n&&n.enabled&&n.onPreRender()}}},{key:"_postRenderScript",value:function(){for(var e=this._scriptPool,t=0,r=e.length;t<r;t++){var n=e[t];n&&n.enabled&&n.onPostRender()}}},{key:"_addCamera",value:function(e){for(var t=this._binarySearchIndexInCameraPool(e),r=e._renderingOrder,n=this._cameraPool.length;t<n&&this._cameraPool[t]._renderingOrder<=r;)t++;this._cameraPool.splice(t,0,e)}},{key:"_removeCamera",value:function(e){this._cameraPool.splice(this._cameraPool.indexOf(e),1)}},{key:"_preCulling",value:function(e,t,r,n){var i=Ie._cameraCullInfo;i.position=t._transform.position,i.cullingMask=t.cullingMask,i.boundFrustum=t.boundFrustum,i.useOcclusionCulling=t.useOcclusionCulling,Ie.renderObjectCulling(i,this,e,r,n,!1)}},{key:"_clear",value:function(r,n){var i,a,o,s=n.viewport,l=n.camera,u=l._getRenderTexture(),c=s.width,h=s.height;l._needInternalRenderTexture()?(i=0,a=0):(i=s.x,a=l._getCanvasHeight()-s.y-h),r.viewport(i,a,c,h);var _=l.clearFlag;switch(_!==e.CameraClearFlags.Sky||l.skyRenderer._isAvailable()||this._skyRenderer._isAvailable()||(_=e.CameraClearFlags.SolidColor),_){case e.CameraClearFlags.SolidColor:var d=l.clearColor;if(r.enable(r.SCISSOR_TEST),r.scissor(i,a,c,h),d?r.clearColor(d.x,d.y,d.z,d.w):r.clearColor(0,0,0,0),u)switch(o=r.COLOR_BUFFER_BIT,u.depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:o|=r.DEPTH_BUFFER_BIT;break;case t.RenderTextureDepthFormat.STENCIL_8:o|=r.STENCIL_BUFFER_BIT;break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_24_8:o|=r.DEPTH_BUFFER_BIT,o|=r.STENCIL_BUFFER_BIT}else o=r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT;t.WebGLContext.setDepthMask(r,!0),r.clear(o),r.disable(r.SCISSOR_TEST);break;case e.CameraClearFlags.Sky:case e.CameraClearFlags.DepthOnly:if(r.enable(r.SCISSOR_TEST),r.scissor(i,a,c,h),u)switch(u.depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:o=r.DEPTH_BUFFER_BIT;break;case t.RenderTextureDepthFormat.STENCIL_8:o=r.STENCIL_BUFFER_BIT;break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_24_8:o=r.DEPTH_BUFFER_BIT|r.STENCIL_BUFFER_BIT}else o=r.DEPTH_BUFFER_BIT;t.WebGLContext.setDepthMask(r,!0),r.clear(o),r.disable(r.SCISSOR_TEST);break;case e.CameraClearFlags.Nothing:break;default:throw new Error("Scene3D:camera clearFlag invalid.")}}},{key:"_renderScene",value:function(t){var r=t.camera;if(this._opaqueQueue._render(t),r.clearFlag===e.CameraClearFlags.Sky&&(r.skyRenderer._isAvailable()?r.skyRenderer._render(t):this._skyRenderer._isAvailable()&&this._skyRenderer._render(t)),this._transparentQueue._render(t),Ie.debugFrustumCulling)for(var n=this._debugTool._render._renderElements,i=0,a=n.length;i<a;i++)n[i]._update(this,t,null,null),n[i]._render(t)}},{key:"_parse",value:function(e,r){var n=e.lightmaps;if(n){for(var i=n.length,a=new Array(i),o=0;o<i;o++){var s=new jt,l=n[o];l.path?s.lightmapColor=t.Loader.getRes(l.path):(s.lightmapColor=t.Loader.getRes(l.color.path),l.direction&&(s.lightmapDirection=t.Loader.getRes(l.direction.path))),a[o]=s}this.lightmaps=a}var u=e.ambientColor;if(u){var c=this.ambientColor;c.fromArray(u),this.ambientColor=c}var h=e.sky;if(h)switch(this._skyRenderer.material=t.Loader.getRes(h.material.path),h.mesh){case"SkyBox":this._skyRenderer.mesh=Je.instance;break;case"SkyDome":this._skyRenderer.mesh=vt.instance;break;default:this.skyRenderer.mesh=Je.instance}this.enableFog=e.enableFog,this.fogStart=e.fogStart,this.fogRange=e.fogRange;var _=e.fogColor;if(_){var d=this.fogColor;d.fromArray(_),this.fogColor=d}var f=e.ambientSphericalHarmonics;if(f){var m=this.ambientSphericalHarmonics;for(o=0;o<3;o++){var T=9*o;m.setCoefficients(o,f[T],f[T+1],f[T+2],f[T+3],f[T+4],f[T+5],f[T+6],f[T+7],f[T+8])}this.ambientSphericalHarmonics=m}var p=e.reflection;null!=p&&(this.reflection=t.Loader.getRes(p));var g=e.reflectionDecodingFormat;null!=g&&(this.reflectionDecodingFormat=g);var E=e.ambientMode;null!=E&&(this.ambientMode=E);var y=e.ambientSphericalHarmonicsIntensity;null!=y&&(this.ambientSphericalHarmonicsIntensity=y);var S=e.reflectionIntensity;null!=S&&(this.reflectionIntensity=S)}},{key:"_addRenderObject",value:function(e){if(this._octree&&e._supportOctree)this._octree.add(e);else if(this._renders.add(e),t.Render.supportWebGLPlusCulling){var r=e._getIndexInList(),n=this._cullingBufferIndices.length;if(r>=n){var i=this._cullingBufferIndices,a=this._cullingBufferResult;this._cullingBufferIndices=new Int32Array(n+1024),this._cullingBufferResult=new Int32Array(n+1024),this._cullingBufferIndices.set(i,0),this._cullingBufferResult.set(a,0)}this._cullingBufferIndices[r]=e._cullingBufferIndex}}},{key:"_removeRenderObject",value:function(e){var r;this._octree&&e._supportOctree?this._octree.remove(e):(t.Render.supportWebGLPlusCulling&&(r=this._renders.elements[this._renders.length-1]),this._renders.remove(e),t.Render.supportWebGLPlusCulling&&(this._cullingBufferIndices[r._getIndexInList()]=r._cullingBufferIndex))}},{key:"_getRenderQueue",value:function(e){return e<=2500?this._opaqueQueue:this._transparentQueue}},{key:"_clearRenderQueue",value:function(){this._opaqueQueue.clear(),this._transparentQueue.clear();for(var e=Bt._managers,t=0,r=e.length;t<r;t++)e[t]._clear();var n=er._managers;for(t=0,r=n.length;t<r;t++)n[t]._clear()}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!this.destroyed){_get(_getPrototypeOf(Scene3D.prototype),"destroy",this).call(this,e),this._skyRenderer.destroy(),this._skyRenderer=null,this._directionLights=null,this._pointLights=null,this._spotLights=null,this._alternateLights=null,this._shaderValues=null,this._renders=null,this._cameraPool=null,this._octree=null,this._physicsSimulation&&this._physicsSimulation._destroy(),this._reflection._removeReference(),this._reflection=null;var r=this._lightmaps;if(r)for(var n=0,i=r.length;n<i;n++){var a=r[n];a.lightmapColor&&a.lightmapColor._removeReference(),a.lightmapDirection&&a.lightmapDirection._removeReference()}this._lightmaps=null,t.Loader.clearRes(this.url)}}},{key:"render",value:function(e,r,n){e._curSubmit=t.SubmitBase.RENDERBASE,this._children.length>0&&e.addRenderObject(this)}},{key:"renderSubmit",value:function(){var e,r,n;t.LayaGL.instance;for(this._prepareSceneToRender(),e=0,n=(r=this._cameraPool.length)-1;e<r;e++){t.Render.supportWebGLPlusRendering&&ce.setRuntimeValueMode(e==n);var i=this._cameraPool[e];i.enableRender&&i.render()}return t.Context.set2DRenderConfig(),1}},{key:"getRenderType",value:function(){return 0}},{key:"releaseRender",value:function(){}},{key:"reUse",value:function(e,t){return 0}},{key:"setlightmaps",value:function(e){for(var t=this._lightmaps,r=0,n=t.length;r<n;r++)t[r].lightmapColor._removeReference();if(!e)throw new Error("Scene3D: value value can't be null.");var i=e.length;for(t.length=i,r=0;r<i;r++){var a=e[r];a._addReference(),t[r]||(t[r]=new jt),t[r].lightmapColor=a}}},{key:"getlightmaps",value:function(){for(var e=new Array(this._lightmaps.length),t=0;t<this._lightmaps.length;t++)e[t]=this._lightmaps[t].lightmapColor;return e}},{key:"url",get:function(){return this._url}},{key:"enableFog",get:function(){return this._enableFog},set:function(e){this._enableFog!==e&&(this._enableFog=e,e?this._shaderValues.addDefine(ht.SHADERDEFINE_FOG):this._shaderValues.removeDefine(ht.SHADERDEFINE_FOG))}},{key:"fogColor",get:function(){return this._shaderValues.getVector3(Scene3D.FOGCOLOR)},set:function(e){this._shaderValues.setVector3(Scene3D.FOGCOLOR,e)}},{key:"fogStart",get:function(){return this._shaderValues.getNumber(Scene3D.FOGSTART)},set:function(e){this._shaderValues.setNumber(Scene3D.FOGSTART,e)}},{key:"fogRange",get:function(){return this._shaderValues.getNumber(Scene3D.FOGRANGE)},set:function(e){this._shaderValues.setNumber(Scene3D.FOGRANGE,e)}},{key:"ambientMode",get:function(){return this._ambientMode},set:function(t){if(this._ambientMode!==t){switch(t){case e.AmbientMode.SolidColor:this._shaderValues.removeDefine(ht.SHADERDEFINE_GI_AMBIENT_SH);break;case e.AmbientMode.SphericalHarmonics:this._shaderValues.addDefine(ht.SHADERDEFINE_GI_AMBIENT_SH);break;default:throw"Scene3D: unknown ambientMode."}this._ambientMode=t}}},{key:"ambientColor",get:function(){return this._shaderValues.getVector3(Scene3D.AMBIENTCOLOR)},set:function(e){this._shaderValues.setVector3(Scene3D.AMBIENTCOLOR,e)}},{key:"ambientSphericalHarmonics",get:function(){return this._ambientSphericalHarmonics},set:function(e){var t=e||Oe._default;this._applySHCoefficients(t,Math.pow(this._ambientSphericalHarmonicsIntensity,2.2)),this._ambientSphericalHarmonics!=e&&e.cloneTo(this._ambientSphericalHarmonics)}},{key:"ambientSphericalHarmonicsIntensity",get:function(){return this._ambientSphericalHarmonicsIntensity},set:function(e){if(e=Math.max(Math.min(e,8),0),this._ambientSphericalHarmonicsIntensity!==e){var t=this._ambientSphericalHarmonics||Oe._default;this._applySHCoefficients(t,Math.pow(e,2.2)),this._ambientSphericalHarmonicsIntensity=e}}},{key:"reflection",get:function(){return this._reflection},set:function(e){this._reflection!=e&&(e._addReference(),this._shaderValues.setTexture(Scene3D.REFLECTIONTEXTURE,e||Rt.blackTexture),this._reflection=e)}},{key:"reflectionDecodingFormat",get:function(){return this._reflectionDecodeFormat},set:function(e){this._reflectionDecodeFormat!=e&&(this._reflectionCubeHDRParams.x=this._reflectionIntensity,this._reflectionDecodeFormat==t.TextureDecodeFormat.RGBM&&(this._reflectionCubeHDRParams.x*=5),this._reflectionDecodeFormat=e)}},{key:"reflectionIntensity",get:function(){return this._reflectionIntensity},set:function(e){e=Math.max(Math.min(e,1),0),this._reflectionCubeHDRParams.x=e,this._reflectionDecodeFormat==t.TextureDecodeFormat.RGBM&&(this._reflectionCubeHDRParams.x*=5),this._reflectionIntensity=e}},{key:"skyRenderer",get:function(){return this._skyRenderer}},{key:"physicsSimulation",get:function(){return this._physicsSimulation}},{key:"cannonPhysicsSimulation",get:function(){return this._cannonPhysicsSimulation}},{key:"timer",get:function(){return this._timer},set:function(e){this._timer=e}},{key:"input",get:function(){return this._input}},{key:"lightmaps",get:function(){return this._lightmaps.slice()},set:function(e){var t=this._lightmaps;if(t)for(var r=0,n=t.length;r<n;r++){(a=t[r]).lightmapColor._removeReference(),a.lightmapDirection._removeReference()}if(e){var i=e.length;for(t.length=i,r=0;r<i;r++){var a;(a=e[r]).lightmapColor&&a.lightmapColor._addReference(),a.lightmapDirection&&a.lightmapDirection._addReference(),t[r]=a}}else t.length=0}},{key:"customReflection",get:function(){return this._reflection},set:function(e){this._reflection!=e&&(this._shaderValues.setTexture(Scene3D.REFLECTIONTEXTURE,e||Rt.blackTexture),this._reflection=e)}},{key:"reflectionMode",get:function(){return this._reflectionMode},set:function(e){this._reflectionMode=e}}],[{key:"__init__",value:function(){var r=w._config;if(r._multiLighting){var n=r.maxLightCount,i=r.lightClusterCount;Pe.instance=new Pe(i.x,i.y,i.z,Math.min(r.maxLightCount,r._maxAreaLightCountPerClusterAverage)),Scene3D._lightTexture=P._createFloatTextureBuffer(4,n),Scene3D._lightTexture.lock=!0,Scene3D._lightPixles=new Float32Array(4*n*4)}ht.SHADERDEFINE_FOG=ue.getDefineByName("FOG"),ht.SHADERDEFINE_DIRECTIONLIGHT=ue.getDefineByName("DIRECTIONLIGHT"),ht.SHADERDEFINE_POINTLIGHT=ue.getDefineByName("POINTLIGHT"),ht.SHADERDEFINE_SPOTLIGHT=ue.getDefineByName("SPOTLIGHT"),ht.SHADERDEFINE_SHADOW=ue.getDefineByName("SHADOW"),ht.SHADERDEFINE_SHADOW_CASCADE=ue.getDefineByName("SHADOW_CASCADE"),ht.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW=ue.getDefineByName("SHADOW_SOFT_SHADOW_LOW"),ht.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH=ue.getDefineByName("SHADOW_SOFT_SHADOW_HIGH"),ht.SHADERDEFINE_GI_AMBIENT_SH=ue.getDefineByName("GI_AMBIENT_SH"),ht.SHADERDEFINE_SHADOW_SPOT=ue.getDefineByName("SHADOW_SPOT"),ht.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW=ue.getDefineByName("SHADOW_SPOT_SOFT_SHADOW_LOW"),ht.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH=ue.getDefineByName("SHADOW_SPOT_SOFT_SHADOW_HIGH");var a=w._config,o=Scene3D._configDefineValues;switch(a._multiLighting||o.add(ue.SHADERDEFINE_LEGACYSINGALLIGHTING),t.LayaGL.layaGPUInstance._isWebGL2?o.add(ue.SHADERDEFINE_GRAPHICS_API_GLES3):o.add(ue.SHADERDEFINE_GRAPHICS_API_GLES2),a.pbrRenderQuality){case e.PBRRenderQuality.High:o.add(ve.SHADERDEFINE_LAYA_PBR_BRDF_HIGH);break;case e.PBRRenderQuality.Low:o.add(ve.SHADERDEFINE_LAYA_PBR_BRDF_LOW);break;default:throw"Scene3D:unknown shader quality."}a.isUseCannonPhysicsEngine?Scene3D.cannonPhysicsSettings=new t.CannonPhysicsSettings:Scene3D.physicsSettings=new yt}},{key:"load",value:function(e,r){t.ILaya.loader.create(e,r,null,Scene3D.HIERARCHY)}}]),Scene3D}(t.Sprite);tr._shadowCasterPass=new Jt,tr.HIERARCHY="HIERARCHY",tr.octreeCulling=!1,tr.octreeInitialSize=64,tr.octreeInitialCenter=new o(0,0,0),tr.octreeMinNodeSize=2,tr.octreeLooseness=1.25,tr.REFLECTIONMODE_SKYBOX=0,tr.REFLECTIONMODE_CUSTOM=1,tr.FOGCOLOR=ue.propertyNameToID("u_FogColor"),tr.FOGSTART=ue.propertyNameToID("u_FogStart"),tr.FOGRANGE=ue.propertyNameToID("u_FogRange"),tr.DIRECTIONLIGHTCOUNT=ue.propertyNameToID("u_DirationLightCount"),tr.LIGHTBUFFER=ue.propertyNameToID("u_LightBuffer"),tr.CLUSTERBUFFER=ue.propertyNameToID("u_LightClusterBuffer"),tr.SUNLIGHTDIRECTION=ue.propertyNameToID("u_SunLight.direction"),tr.SUNLIGHTDIRCOLOR=ue.propertyNameToID("u_SunLight.color"),tr.AMBIENTSHAR=ue.propertyNameToID("u_AmbientSHAr"),tr.AMBIENTSHAG=ue.propertyNameToID("u_AmbientSHAg"),tr.AMBIENTSHAB=ue.propertyNameToID("u_AmbientSHAb"),tr.AMBIENTSHBR=ue.propertyNameToID("u_AmbientSHBr"),tr.AMBIENTSHBG=ue.propertyNameToID("u_AmbientSHBg"),tr.AMBIENTSHBB=ue.propertyNameToID("u_AmbientSHBb"),tr.AMBIENTSHC=ue.propertyNameToID("u_AmbientSHC"),tr.REFLECTIONPROBE=ue.propertyNameToID("u_ReflectionProbe"),tr.REFLECTIONCUBE_HDR_PARAMS=ue.propertyNameToID("u_ReflectCubeHDRParams"),tr.LIGHTDIRECTION=ue.propertyNameToID("u_DirectionLight.direction"),tr.LIGHTDIRCOLOR=ue.propertyNameToID("u_DirectionLight.color"),tr.POINTLIGHTPOS=ue.propertyNameToID("u_PointLight.position"),tr.POINTLIGHTRANGE=ue.propertyNameToID("u_PointLight.range"),tr.POINTLIGHTATTENUATION=ue.propertyNameToID("u_PointLight.attenuation"),tr.POINTLIGHTCOLOR=ue.propertyNameToID("u_PointLight.color"),tr.SPOTLIGHTPOS=ue.propertyNameToID("u_SpotLight.position"),tr.SPOTLIGHTDIRECTION=ue.propertyNameToID("u_SpotLight.direction"),tr.SPOTLIGHTSPOTANGLE=ue.propertyNameToID("u_SpotLight.spot"),tr.SPOTLIGHTRANGE=ue.propertyNameToID("u_SpotLight.range"),tr.SPOTLIGHTCOLOR=ue.propertyNameToID("u_SpotLight.color"),tr.AMBIENTCOLOR=ue.propertyNameToID("u_AmbientColor"),tr.REFLECTIONTEXTURE=ue.propertyNameToID("u_ReflectTexture"),tr.TIME=ue.propertyNameToID("u_Time"),tr._configDefineValues=new ae;var rr=function(e){function ShaderPass(e,t,r,n){var i;for(var a in _classCallCheck(this,ShaderPass),(i=_possibleConstructorReturn(this,_getPrototypeOf(ShaderPass).call(this,t,r,null)))._cacheSharders={},i._cacheShaderHierarchy=1,i._renderState=new pe,i._validDefine=new ae,i._tags={},i._owner=e,i._stateMap=n,i.defs)i._validDefine.add(ue.getDefineByName(a));return i}return _inherits(ShaderPass,e),_createClass(ShaderPass,[{key:"_compileToTree",value:function(e,r,n,i,a){var o,s,l,u,c,h,_,d,f,m,T;for(f=n;f<r.length;f++)if(!((l=r[f]).length<1)&&0!==(h=l.indexOf("//"))){if(h>=0&&(l=l.substr(0,h)),o=d||new t.ShaderNode(i),d=null,o.text=l,(h=l.indexOf("#"))>=0){for(u="#",T=h+1,m=l.length;T<m;T++){var p=l.charAt(T);if(" "===p||"\t"===p||"?"===p)break;u+=p}switch(o.name=u,u){case"#ifdef":case"#ifndef":if(o.setParent(e),e=o,a)for(_=l.substr(T).split(t.ShaderCompile._splitToWordExps3),T=0;T<_.length;T++)(l=_[T]).length&&(a[l]=!0);continue;case"#if":case"#elif":if(o.setParent(e),e=o,a)for(_=l.substr(T).split(t.ShaderCompile._splitToWordExps3),T=0;T<_.length;T++)(l=_[T]).length&&"defined"!=l&&(a[l]=!0);continue;case"#else":s=(e=e.parent).childs[e.childs.length-1],o.setParent(e),e=o;continue;case"#endif":s=(e=e.parent).childs[e.childs.length-1],o.setParent(e);continue;case"#include":_=t.ShaderCompile.splitToWords(l,null);var g=t.ShaderCompile.includes[_[1]];if(!g)throw"ShaderCompile error no this include file:"+_[1];if((h=_[0].indexOf("?"))<0){o.setParent(e),l=g.getWith("with"==_[2]?_[3]:null),this._compileToTree(o,l.split("\n"),0,i,a),o.text="";continue}o.setCondition(_[0].substr(h+1),t.ShaderCompile.IFDEF_YES),o.text=g.getWith("with"==_[2]?_[3]:null);break;case"#import":c=(_=t.ShaderCompile.splitToWords(l,null))[1],i.push({node:o,file:t.ShaderCompile.includes[c],ofs:o.text.length});continue}}else{if((s=e.childs[e.childs.length-1])&&!s.name){i.length>0&&t.ShaderCompile.splitToWords(l,s),d=o,s.text+="\n"+l;continue}i.length>0&&t.ShaderCompile.splitToWords(l,o)}o.setParent(e)}}},{key:"_resizeCacheShaderMap",value:function(e,t,r){var n=this._cacheShaderHierarchy-1;if(t==n){for(var i in e)for(var a=e[i],o=0,s=r-n;o<s;o++)o==s-1?e[0]=a:e=e[0==o?i:0]={};this._cacheShaderHierarchy=r}else for(var i in e)this._resizeCacheShaderMap(e[i],++t,r)}},{key:"_addDebugShaderVariantCollection",value:function(e,t,r){var n=ue._debugShaderVariantInfo,i=this._owner,a=i._owner,o=e._mask;ue._getNamesByDefineData(e,t),r.length=o.length;for(var s=0,l=o.length;s<l;s++)r[s]=o[s];n?n.setValue(a,a._subShaders.indexOf(i),i._passes.indexOf(this),t):ue._debugShaderVariantInfo=n=new se(a,a._subShaders.indexOf(i),i._passes.indexOf(this),t),ue.debugShaderVariantCollection.add(n)}},{key:"withCompile",value:function(e){var r,n=ShaderPass._debugDefineString,i=ShaderPass._debugDefineMask;e._intersectionDefineDatas(this._validDefine),ue.debugMode&&(r=e._length,this._addDebugShaderVariantCollection(e,n,i)),e.addDefineDatas(tr._configDefineValues);var a=this._cacheSharders,o=e._length;o>this._cacheShaderHierarchy&&(this._resizeCacheShaderMap(a,0,o),this._cacheShaderHierarchy=o);for(var s=e._mask,l=e._length-1,u=this._cacheShaderHierarchy-1,c=0;c<u;c++){var h=l<c?0:s[c],_=a[h];_||(a[h]=_={}),a=_}var d=l<u?0:s[u],f=a[d];if(f)return f;var m=ShaderPass._defineString;ue._getNamesByDefineData(e,m);var T,p,g=w._config,E=g.lightClusterCount,y={},S="";t.WebGL._isWebGL2?(T="#version 300 es\n\n\t\t\t\t#define attribute in\n\t\t\t\t#define varying out\n\t\t\t\t#define texture2D texture\n",p="#version 300 es\n\n\t\t\t\t#define varying in\n\t\t\t\tout highp vec4 pc_fragColor;\n\t\t\t\t#define gl_FragColor pc_fragColor\n\t\t\t\t#define gl_FragDepthEXT gl_FragDepth\n\t\t\t\t#define texture2D texture\n\t\t\t\t#define textureCube texture\n\t\t\t\t#define texture2DProj textureProj\n\t\t\t\t#define texture2DLodEXT textureLod\n\t\t\t\t#define texture2DProjLodEXT textureProjLod\n\t\t\t\t#define textureCubeLodEXT textureLod\n\t\t\t\t#define texture2DGradEXT textureGrad\n\t\t\t\t#define texture2DProjGradEXT textureProjGrad\n\t\t\t\t#define textureCubeGradEXT textureGrad\n"):(T="",p="#ifdef GL_EXT_shader_texture_lod\n\t\t\t\t\t#extension GL_EXT_shader_texture_lod : enable\n\t\t\t\t#endif\n\t\t\t\t#if !defined(GL_EXT_shader_texture_lod)\n\t\t\t\t\t#define texture1DLodEXT texture1D\n\t\t\t\t\t#define texture2DLodEXT texture2D\n\t\t\t\t\t#define texture2DProjLodEXT texture2DProj\n\t\t\t\t\t#define texture3DLodEXT texture3D\n\t\t\t\t\t#define textureCubeLodEXT textureCube\n\t\t\t\t#endif\n"),S+="#define MAX_LIGHT_COUNT "+g.maxLightCount+"\n",S+="#define MAX_LIGHT_COUNT_PER_CLUSTER "+g._maxAreaLightCountPerClusterAverage+"\n",S+="#define CLUSTER_X_COUNT "+E.x+"\n",S+="#define CLUSTER_Y_COUNT "+E.y+"\n",S+="#define CLUSTER_Z_COUNT "+E.z+"\n",S+="#define SHADER_CAPAILITY_LEVEL "+t.SystemUtils._shaderCapailityLevel+"\n";c=0;for(var v=m.length;c<v;c++){var R=m[c];S+="#define "+R+"\n",y[R]=!0}var C=this._VS.toscript(y,[]),M="";0==C[0].indexOf("#version")&&(M=C[0]+"\n",C.shift());var D=this._PS.toscript(y,[]),x="";0==D[0].indexOf("#version")&&(x=D[0]+"\n",D.shift());var A=ue.getAttributeMapByDefine(m,this._owner._attributeMap);if(f=new Ce(M+T+S+C.join("\n"),x+p+S+D.join("\n"),A,this._owner._uniformMap||this._owner._owner._uniformMap,this),a[d]=f,ue.debugMode){var I="",L="";for(c=0,v=r;c<v;c++)L+=c==v-1?i[c]:i[c]+",";for(c=0,v=n.length;c<v;c++)I+=c==v-1?n[c]:n[c]+",";console.log("%cLayaAir: Shader Compile Information---ShaderName:"+this._owner._owner._name+" SubShaderIndex:"+this._owner._owner._subShaders.indexOf(this._owner)+" PassIndex:"+this._owner._passes.indexOf(this)+" DefineMask:["+L+"] DefineNames:["+I+"]","color:green")}return f}},{key:"setTag",value:function(e,t){t?this._tags[e]=t:delete this._tags[e]}},{key:"getTag",value:function(e){return this._tags[e]}},{key:"renderState",get:function(){return this._renderState}}]),ShaderPass}(t.ShaderCompile);rr._defineString=[],rr._debugDefineString=[],rr._debugDefineMask=[];var nr,ir=function(){function SubShader(e,t){_classCallCheck(this,SubShader),this._flags={},this._passes=[],this._attributeMap=e,this._uniformMap=t}return _createClass(SubShader,[{key:"setFlag",value:function(e,t){t?this._flags[e]=t:delete this._flags[e]}},{key:"getFlag",value:function(e){return this._flags[e]}},{key:"addShaderPass",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"Forward",i=new rr(this,e,t,r);return i._pipelineMode=n,this._passes.push(i),i}}]),SubShader}();(nr=e.PBRSpecularSmoothnessSource||(e.PBRSpecularSmoothnessSource={}))[nr.SpecularTextureAlpha=0]="SpecularTextureAlpha",nr[nr.AlbedoTextureAlpha=1]="AlbedoTextureAlpha";var ar=function(e){function PBRSpecularMaterial(){var e;return _classCallCheck(this,PBRSpecularMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(PBRSpecularMaterial).call(this))).setShaderName("PBRSpecular"),e._shaderValues.setVector(PBRSpecularMaterial.SPECULARCOLOR,new i(.2,.2,.2,1)),e}return _inherits(PBRSpecularMaterial,e),_createClass(PBRSpecularMaterial,[{key:"clone",value:function(){var e=new PBRSpecularMaterial;return this.cloneTo(e),e}},{key:"specularTexture",get:function(){return this._shaderValues.getTexture(PBRSpecularMaterial.SPECULARTEXTURE)},set:function(e){e?this._shaderValues.addDefine(PBRSpecularMaterial.SHADERDEFINE_SPECULARGLOSSTEXTURE):this._shaderValues.removeDefine(PBRSpecularMaterial.SHADERDEFINE_SPECULARGLOSSTEXTURE),this._shaderValues.setTexture(PBRSpecularMaterial.SPECULARTEXTURE,e)}},{key:"specularColor",get:function(){return this._shaderValues.getVector(PBRSpecularMaterial.SPECULARCOLOR)},set:function(e){this._shaderValues.setVector(PBRSpecularMaterial.SPECULARCOLOR,e)}}],[{key:"__init__",value:function(){PBRSpecularMaterial.SHADERDEFINE_SPECULARGLOSSTEXTURE=ue.getDefineByName("SPECULARGLOSSTEXTURE"),PBRSpecularMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=ue.getDefineByName("SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA");var e={a_Position:Qe.MESH_POSITION0,a_Normal:Qe.MESH_NORMAL0,a_Tangent0:Qe.MESH_TANGENT0,a_Texcoord0:Qe.MESH_TEXTURECOORDINATE0,a_Texcoord1:Qe.MESH_TEXTURECOORDINATE1,a_BoneWeights:Qe.MESH_BLENDWEIGHT0,a_BoneIndices:Qe.MESH_BLENDINDICES0,a_MvpMatrix:Qe.MESH_MVPMATRIX_ROW0,a_WorldMat:Qe.MESH_WORLDMATRIX_ROW0},t={u_Bones:ue.PERIOD_CUSTOM,u_MvpMatrix:ue.PERIOD_SPRITE,u_WorldMat:ue.PERIOD_SPRITE,u_LightmapScaleOffset:ue.PERIOD_SPRITE,u_LightMap:ue.PERIOD_SPRITE,u_LightMapDirection:ue.PERIOD_SPRITE,u_SimpleAnimatorTexture:ue.PERIOD_SPRITE,u_SimpleAnimatorParams:ue.PERIOD_SPRITE,u_SimpleAnimatorTextureSize:ue.PERIOD_SPRITE,u_CameraPos:ue.PERIOD_CAMERA,u_View:ue.PERIOD_CAMERA,u_ProjectionParams:ue.PERIOD_CAMERA,u_Viewport:ue.PERIOD_CAMERA,u_ViewProjection:ue.PERIOD_CAMERA,u_AlphaTestValue:ue.PERIOD_MATERIAL,u_AlbedoColor:ue.PERIOD_MATERIAL,u_EmissionColor:ue.PERIOD_MATERIAL,u_AlbedoTexture:ue.PERIOD_MATERIAL,u_NormalTexture:ue.PERIOD_MATERIAL,u_ParallaxTexture:ue.PERIOD_MATERIAL,u_OcclusionTexture:ue.PERIOD_MATERIAL,u_EmissionTexture:ue.PERIOD_MATERIAL,u_Smoothness:ue.PERIOD_MATERIAL,u_SmoothnessScale:ue.PERIOD_MATERIAL,u_occlusionStrength:ue.PERIOD_MATERIAL,u_NormalScale:ue.PERIOD_MATERIAL,u_ParallaxScale:ue.PERIOD_MATERIAL,u_TilingOffset:ue.PERIOD_MATERIAL,u_SpecGlossTexture:ue.PERIOD_MATERIAL,u_SpecularColor:ue.PERIOD_MATERIAL,u_ReflectTexture:ue.PERIOD_SCENE,u_ReflectIntensity:ue.PERIOD_SCENE,u_AmbientColor:ue.PERIOD_SCENE,u_FogStart:ue.PERIOD_SCENE,u_FogRange:ue.PERIOD_SCENE,u_FogColor:ue.PERIOD_SCENE,u_DirationLightCount:ue.PERIOD_SCENE,u_LightBuffer:ue.PERIOD_SCENE,u_LightClusterBuffer:ue.PERIOD_SCENE,u_ShadowBias:ue.PERIOD_SCENE,u_ShadowLightDirection:ue.PERIOD_SCENE,u_ShadowMap:ue.PERIOD_SCENE,u_ShadowParams:ue.PERIOD_SCENE,u_ShadowSplitSpheres:ue.PERIOD_SCENE,u_ShadowMatrices:ue.PERIOD_SCENE,u_ShadowMapSize:ue.PERIOD_SCENE,u_SpotShadowMap:ue.PERIOD_SCENE,u_SpotViewProjectMatrix:ue.PERIOD_SCENE,u_ShadowLightPosition:ue.PERIOD_SCENE,u_AmbientSHAr:ue.PERIOD_SCENE,u_AmbientSHAg:ue.PERIOD_SCENE,u_AmbientSHAb:ue.PERIOD_SCENE,u_AmbientSHBr:ue.PERIOD_SCENE,u_AmbientSHBg:ue.PERIOD_SCENE,u_AmbientSHBb:ue.PERIOD_SCENE,u_AmbientSHC:ue.PERIOD_SCENE,u_ReflectionProbe:ue.PERIOD_SCENE,u_ReflectCubeHDRParams:ue.PERIOD_SCENE,"u_DirectionLight.direction":ue.PERIOD_SCENE,"u_DirectionLight.color":ue.PERIOD_SCENE,"u_PointLight.position":ue.PERIOD_SCENE,"u_PointLight.range":ue.PERIOD_SCENE,"u_PointLight.color":ue.PERIOD_SCENE,"u_SpotLight.position":ue.PERIOD_SCENE,"u_SpotLight.direction":ue.PERIOD_SCENE,"u_SpotLight.range":ue.PERIOD_SCENE,"u_SpotLight.spot":ue.PERIOD_SCENE,"u_SpotLight.color":ue.PERIOD_SCENE},r={s_Cull:ue.RENDER_STATE_CULL,s_Blend:ue.RENDER_STATE_BLEND,s_BlendSrc:ue.RENDER_STATE_BLEND_SRC,s_BlendDst:ue.RENDER_STATE_BLEND_DST,s_DepthTest:ue.RENDER_STATE_DEPTH_TEST,s_DepthWrite:ue.RENDER_STATE_DEPTH_WRITE},n=ue.add("PBRSpecular",e,t,!0),i=new ir(e,t);n.addSubShader(i),i.addShaderPass('#include "PBRVSInput.glsl";\r\n#include "Lighting.glsl";\r\n#include "PBRVertex.glsl";\r\n\r\nvoid main()\r\n{\r\n\tvertexForward();\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n\tprecision highp int;\r\n#else\r\n\tprecision mediump float;\r\n\tprecision mediump int;\r\n#endif\r\n\r\n#define SETUP_BRDF_INPUT specularSetup\r\n\r\n#include "Lighting.glsl";\r\n#include "PBRFSInput.glsl";\r\n#include "LayaPBRBRDF.glsl";\r\n#include "GlobalIllumination.glsl";\r\n#include "Shadow.glsl"\r\n#include "PBRCore.glsl";\r\n\r\nvoid main()\r\n{\r\n\tfragmentForward();\r\n}',r,"Forward"),i.addShaderPass('#include "ShadowCasterVS.glsl"\r\n\r\nvoid main()\r\n{\r\n\tvec4 positionCS =  shadowCasterVertex();\r\n\tgl_Position=remapGLPositionZ(positionCS);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n\tprecision highp int;\r\n#else\r\n\tprecision mediump float;\r\n\tprecision mediump int;\r\n#endif\r\n\r\n#include "ShadowCasterFS.glsl"\r\n\r\nvoid main()\r\n{\r\n\tgl_FragColor=shadowCasterFragment();\r\n}',r,"ShadowCaster")}}]),PBRSpecularMaterial}(ve);ar.SPECULARTEXTURE=ue.propertyNameToID("u_SpecGlossTexture"),ar.SPECULARCOLOR=ue.propertyNameToID("u_SpecularColor");var or;(or=e.PBRMetallicSmoothnessSource||(e.PBRMetallicSmoothnessSource={}))[or.MetallicGlossTextureAlpha=0]="MetallicGlossTextureAlpha",or[or.AlbedoTextureAlpha=1]="AlbedoTextureAlpha";var sr=function(e){function PBRStandardMaterial(){var e;return _classCallCheck(this,PBRStandardMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(PBRStandardMaterial).call(this)))._smoothnessSource=0,e.setShaderName("PBR"),e._shaderValues.setNumber(PBRStandardMaterial.METALLIC,0),e}return _inherits(PBRStandardMaterial,e),_createClass(PBRStandardMaterial,[{key:"clone",value:function(){var e=new PBRStandardMaterial;return this.cloneTo(e),e}},{key:"metallicGlossTexture",get:function(){return this._shaderValues.getTexture(PBRStandardMaterial.METALLICGLOSSTEXTURE)},set:function(e){e?this._shaderValues.addDefine(PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE):this._shaderValues.removeDefine(PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE),this._shaderValues.setTexture(PBRStandardMaterial.METALLICGLOSSTEXTURE,e)}},{key:"metallic",get:function(){return this._shaderValues.getNumber(PBRStandardMaterial.METALLIC)},set:function(e){this._shaderValues.setNumber(PBRStandardMaterial.METALLIC,Math.max(0,Math.min(1,e)))}},{key:"smoothnessSource",get:function(){return this._smoothnessSource},set:function(e){e?this._shaderValues.addDefine(PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA):this._shaderValues.removeDefine(PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA),this._smoothnessSource=e}}],[{key:"__init__",value:function(){PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE=ue.getDefineByName("METALLICGLOSSTEXTURE"),PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=ue.getDefineByName("SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA");var e={a_Position:Qe.MESH_POSITION0,a_Normal:Qe.MESH_NORMAL0,a_Tangent0:Qe.MESH_TANGENT0,a_Texcoord0:Qe.MESH_TEXTURECOORDINATE0,a_Texcoord1:Qe.MESH_TEXTURECOORDINATE1,a_BoneWeights:Qe.MESH_BLENDWEIGHT0,a_BoneIndices:Qe.MESH_BLENDINDICES0,a_MvpMatrix:Qe.MESH_MVPMATRIX_ROW0,a_WorldMat:Qe.MESH_WORLDMATRIX_ROW0},t={u_Bones:ue.PERIOD_CUSTOM,u_MvpMatrix:ue.PERIOD_SPRITE,u_WorldMat:ue.PERIOD_SPRITE,u_LightmapScaleOffset:ue.PERIOD_SPRITE,u_LightMap:ue.PERIOD_SPRITE,u_LightMapDirection:ue.PERIOD_SPRITE,u_SimpleAnimatorTexture:ue.PERIOD_SPRITE,u_SimpleAnimatorParams:ue.PERIOD_SPRITE,u_SimpleAnimatorTextureSize:ue.PERIOD_SPRITE,u_CameraPos:ue.PERIOD_CAMERA,u_View:ue.PERIOD_CAMERA,u_ProjectionParams:ue.PERIOD_CAMERA,u_Viewport:ue.PERIOD_CAMERA,u_ViewProjection:ue.PERIOD_CAMERA,u_AlphaTestValue:ue.PERIOD_MATERIAL,u_AlbedoColor:ue.PERIOD_MATERIAL,u_EmissionColor:ue.PERIOD_MATERIAL,u_AlbedoTexture:ue.PERIOD_MATERIAL,u_NormalTexture:ue.PERIOD_MATERIAL,u_ParallaxTexture:ue.PERIOD_MATERIAL,u_OcclusionTexture:ue.PERIOD_MATERIAL,u_EmissionTexture:ue.PERIOD_MATERIAL,u_Smoothness:ue.PERIOD_MATERIAL,u_SmoothnessScale:ue.PERIOD_MATERIAL,u_occlusionStrength:ue.PERIOD_MATERIAL,u_NormalScale:ue.PERIOD_MATERIAL,u_ParallaxScale:ue.PERIOD_MATERIAL,u_TilingOffset:ue.PERIOD_MATERIAL,u_MetallicGlossTexture:ue.PERIOD_MATERIAL,u_Metallic:ue.PERIOD_MATERIAL,u_ReflectTexture:ue.PERIOD_SCENE,u_ReflectIntensity:ue.PERIOD_SCENE,u_AmbientColor:ue.PERIOD_SCENE,u_FogStart:ue.PERIOD_SCENE,u_FogRange:ue.PERIOD_SCENE,u_FogColor:ue.PERIOD_SCENE,u_DirationLightCount:ue.PERIOD_SCENE,u_LightBuffer:ue.PERIOD_SCENE,u_LightClusterBuffer:ue.PERIOD_SCENE,u_ShadowBias:ue.PERIOD_SCENE,u_ShadowLightDirection:ue.PERIOD_SCENE,u_ShadowMap:ue.PERIOD_SCENE,u_ShadowParams:ue.PERIOD_SCENE,u_ShadowSplitSpheres:ue.PERIOD_SCENE,u_ShadowMatrices:ue.PERIOD_SCENE,u_ShadowMapSize:ue.PERIOD_SCENE,u_SpotShadowMap:ue.PERIOD_SCENE,u_SpotViewProjectMatrix:ue.PERIOD_SCENE,u_ShadowLightPosition:ue.PERIOD_SCENE,u_AmbientSHAr:ue.PERIOD_SCENE,u_AmbientSHAg:ue.PERIOD_SCENE,u_AmbientSHAb:ue.PERIOD_SCENE,u_AmbientSHBr:ue.PERIOD_SCENE,u_AmbientSHBg:ue.PERIOD_SCENE,u_AmbientSHBb:ue.PERIOD_SCENE,u_AmbientSHC:ue.PERIOD_SCENE,u_ReflectionProbe:ue.PERIOD_SCENE,u_ReflectCubeHDRParams:ue.PERIOD_SCENE,"u_DirectionLight.direction":ue.PERIOD_SCENE,"u_DirectionLight.color":ue.PERIOD_SCENE,"u_PointLight.position":ue.PERIOD_SCENE,"u_PointLight.range":ue.PERIOD_SCENE,"u_PointLight.color":ue.PERIOD_SCENE,"u_SpotLight.position":ue.PERIOD_SCENE,"u_SpotLight.direction":ue.PERIOD_SCENE,"u_SpotLight.range":ue.PERIOD_SCENE,"u_SpotLight.spot":ue.PERIOD_SCENE,"u_SpotLight.color":ue.PERIOD_SCENE},r={s_Cull:ue.RENDER_STATE_CULL,s_Blend:ue.RENDER_STATE_BLEND,s_BlendSrc:ue.RENDER_STATE_BLEND_SRC,s_BlendDst:ue.RENDER_STATE_BLEND_DST,s_DepthTest:ue.RENDER_STATE_DEPTH_TEST,s_DepthWrite:ue.RENDER_STATE_DEPTH_WRITE},n=ue.add("PBR",e,t,!0),i=new ir(e,t);n.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n#include "Shadow.glsl"\r\n#include "PBRVSInput.glsl";\r\n#include "PBRVertex.glsl";\r\n\r\nvoid main()\r\n{\r\n\tvertexForward();\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n\tprecision highp int;\r\n#else\r\n\tprecision mediump float;\r\n\tprecision mediump int;\r\n#endif\r\n\r\n#include "Lighting.glsl";\r\n#include "Shadow.glsl"\r\n#include "PBRFSInput.glsl";\r\n#include "LayaPBRBRDF.glsl";\r\n#include "GlobalIllumination.glsl";\r\n#include "PBRCore.glsl";\r\n\r\nvoid main()\r\n{\r\n\tfragmentForward();\r\n}',r,"Forward"),i.addShaderPass('#include "ShadowCasterVS.glsl"\r\n\r\nvoid main()\r\n{\r\n\tvec4 positionCS =  shadowCasterVertex();\r\n\tgl_Position=remapGLPositionZ(positionCS);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n\tprecision highp int;\r\n#else\r\n\tprecision mediump float;\r\n\tprecision mediump int;\r\n#endif\r\n\r\n#include "ShadowCasterFS.glsl"\r\n\r\nvoid main()\r\n{\r\n\tgl_FragColor=shadowCasterFragment();\r\n}',r,"ShadowCaster")}}]),PBRStandardMaterial}(ve);sr.METALLICGLOSSTEXTURE=ue.propertyNameToID("u_MetallicGlossTexture"),sr.METALLIC=ue.propertyNameToID("u_Metallic");var lr=function(e){function SkyBoxMaterial(){var e;return _classCallCheck(this,SkyBoxMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(SkyBoxMaterial).call(this))).setShaderName("SkyBox"),e.tintColor=new i(.5,.5,.5,.5),e.exposure=1,e.rotation=0,e}return _inherits(SkyBoxMaterial,e),_createClass(SkyBoxMaterial,[{key:"clone",value:function(){var e=new SkyBoxMaterial;return this.cloneTo(e),e}},{key:"tintColor",get:function(){return this._shaderValues.getVector(SkyBoxMaterial.TINTCOLOR)},set:function(e){this._shaderValues.setVector(SkyBoxMaterial.TINTCOLOR,e)}},{key:"exposure",get:function(){return this._shaderValues.getNumber(SkyBoxMaterial.EXPOSURE)},set:function(e){this._shaderValues.setNumber(SkyBoxMaterial.EXPOSURE,e)}},{key:"rotation",get:function(){return this._shaderValues.getNumber(SkyBoxMaterial.ROTATION)},set:function(e){this._shaderValues.setNumber(SkyBoxMaterial.ROTATION,e)}},{key:"textureCube",get:function(){return this._shaderValues.getTexture(SkyBoxMaterial.TEXTURECUBE)},set:function(e){this._shaderValues.setTexture(SkyBoxMaterial.TEXTURECUBE,e)}}],[{key:"__initDefine__",value:function(){}}]),SkyBoxMaterial}(me);lr.TINTCOLOR=ue.propertyNameToID("u_TintColor"),lr.EXPOSURE=ue.propertyNameToID("u_Exposure"),lr.ROTATION=ue.propertyNameToID("u_Rotation"),lr.TEXTURECUBE=ue.propertyNameToID("u_CubeTexture");var ur=function(e){function SkyProceduralMaterial(){var e;return _classCallCheck(this,SkyProceduralMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(SkyProceduralMaterial).call(this))).setShaderName("SkyBoxProcedural"),e.sunDisk=SkyProceduralMaterial.SUN_HIGH_QUALITY,e.sunSize=.04,e.sunSizeConvergence=5,e.atmosphereThickness=1,e.skyTint=new i(.5,.5,.5,1),e.groundTint=new i(.369,.349,.341,1),e.exposure=1.3,e}return _inherits(SkyProceduralMaterial,e),_createClass(SkyProceduralMaterial,[{key:"clone",value:function(){var e=new SkyProceduralMaterial;return this.cloneTo(e),e}},{key:"sunDisk",get:function(){return this._sunDisk},set:function(e){switch(e){case SkyProceduralMaterial.SUN_HIGH_QUALITY:this._shaderValues.removeDefine(SkyProceduralMaterial.SHADERDEFINE_SUN_SIMPLE),this._shaderValues.addDefine(SkyProceduralMaterial.SHADERDEFINE_SUN_HIGH_QUALITY);break;case SkyProceduralMaterial.SUN_SIMPLE:this._shaderValues.removeDefine(SkyProceduralMaterial.SHADERDEFINE_SUN_HIGH_QUALITY),this._shaderValues.addDefine(SkyProceduralMaterial.SHADERDEFINE_SUN_SIMPLE);break;case SkyProceduralMaterial.SUN_NODE:this._shaderValues.removeDefine(SkyProceduralMaterial.SHADERDEFINE_SUN_HIGH_QUALITY),this._shaderValues.removeDefine(SkyProceduralMaterial.SHADERDEFINE_SUN_SIMPLE);break;default:throw"SkyBoxProceduralMaterial: unknown sun value."}this._sunDisk=e}},{key:"sunSize",get:function(){return this._shaderValues.getNumber(SkyProceduralMaterial.SUNSIZE)},set:function(e){e=Math.min(Math.max(0,e),1),this._shaderValues.setNumber(SkyProceduralMaterial.SUNSIZE,e)}},{key:"sunSizeConvergence",get:function(){return this._shaderValues.getNumber(SkyProceduralMaterial.SUNSIZECONVERGENCE)},set:function(e){e=Math.min(Math.max(0,e),20),this._shaderValues.setNumber(SkyProceduralMaterial.SUNSIZECONVERGENCE,e)}},{key:"atmosphereThickness",get:function(){return this._shaderValues.getNumber(SkyProceduralMaterial.ATMOSPHERETHICKNESS)},set:function(e){e=Math.min(Math.max(0,e),5),this._shaderValues.setNumber(SkyProceduralMaterial.ATMOSPHERETHICKNESS,e)}},{key:"skyTint",get:function(){return this._shaderValues.getVector(SkyProceduralMaterial.SKYTINT)},set:function(e){this._shaderValues.setVector(SkyProceduralMaterial.SKYTINT,e)}},{key:"groundTint",get:function(){return this._shaderValues.getVector(SkyProceduralMaterial.GROUNDTINT)},set:function(e){this._shaderValues.setVector(SkyProceduralMaterial.GROUNDTINT,e)}},{key:"exposure",get:function(){return this._shaderValues.getNumber(SkyProceduralMaterial.EXPOSURE)},set:function(e){e=Math.min(Math.max(0,e),8),this._shaderValues.setNumber(SkyProceduralMaterial.EXPOSURE,e)}}],[{key:"__initDefine__",value:function(){SkyProceduralMaterial.SHADERDEFINE_SUN_HIGH_QUALITY=ue.getDefineByName("SUN_HIGH_QUALITY"),SkyProceduralMaterial.SHADERDEFINE_SUN_SIMPLE=ue.getDefineByName("SUN_SIMPLE")}}]),SkyProceduralMaterial}(me);ur.SUN_NODE=0,ur.SUN_SIMPLE=1,ur.SUN_HIGH_QUALITY=2,ur.SUNSIZE=ue.propertyNameToID("u_SunSize"),ur.SUNSIZECONVERGENCE=ue.propertyNameToID("u_SunSizeConvergence"),ur.ATMOSPHERETHICKNESS=ue.propertyNameToID("u_AtmosphereThickness"),ur.SKYTINT=ue.propertyNameToID("u_SkyTint"),ur.GROUNDTINT=ue.propertyNameToID("u_GroundTint"),ur.EXPOSURE=ue.propertyNameToID("u_Exposure");var cr=function(e){function UnlitMaterial(){var e;return _classCallCheck(this,UnlitMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(UnlitMaterial).call(this)))._albedoColor=new i(1,1,1,1),e._albedoIntensity=1,e._enableVertexColor=!1,e.setShaderName("Unlit"),e._shaderValues.setVector(UnlitMaterial.ALBEDOCOLOR,new i(1,1,1,1)),e.renderMode=UnlitMaterial.RENDERMODE_OPAQUE,e}return _inherits(UnlitMaterial,e),_createClass(UnlitMaterial,[{key:"clone",value:function(){var e=new UnlitMaterial;return this.cloneTo(e),e}},{key:"_ColorR",get:function(){return this._albedoColor.x},set:function(e){this._albedoColor.x=e,this.albedoColor=this._albedoColor}},{key:"_ColorG",get:function(){return this._albedoColor.y},set:function(e){this._albedoColor.y=e,this.albedoColor=this._albedoColor}},{key:"_ColorB",get:function(){return this._albedoColor.z},set:function(e){this._albedoColor.z=e,this.albedoColor=this._albedoColor}},{key:"_ColorA",get:function(){return this._albedoColor.w},set:function(e){this._albedoColor.w=e,this.albedoColor=this._albedoColor}},{key:"_Color",get:function(){return this._shaderValues.getVector(UnlitMaterial.ALBEDOCOLOR)},set:function(e){this.albedoColor=e}},{key:"_AlbedoIntensity",get:function(){return this._albedoIntensity},set:function(e){if(this._albedoIntensity!==e){var t=this._shaderValues.getVector(UnlitMaterial.ALBEDOCOLOR);i.scale(this._albedoColor,e,t),this._albedoIntensity=e,this._shaderValues.setVector(UnlitMaterial.ALBEDOCOLOR,t)}}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET).x},set:function(e){var t=this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET);t.x=e,this.tilingOffset=t}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET).y},set:function(e){var t=this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET);t.y=e,this.tilingOffset=t}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET).z},set:function(e){var t=this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET);t.z=e,this.tilingOffset=t}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET).w},set:function(e){var t=this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET);t.w=e,this.tilingOffset=t}},{key:"_MainTex_ST",get:function(){return this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET)},set:function(e){this.tilingOffset=e}},{key:"_Cutoff",get:function(){return this.alphaTestValue},set:function(e){this.alphaTestValue=e}},{key:"albedoColorR",get:function(){return this._ColorR},set:function(e){this._ColorR=e}},{key:"albedoColorG",get:function(){return this._ColorG},set:function(e){this._ColorG=e}},{key:"albedoColorB",get:function(){return this._ColorB},set:function(e){this._ColorB=e}},{key:"albedoColorA",get:function(){return this._ColorA},set:function(e){this._ColorA=e}},{key:"albedoColor",get:function(){return this._albedoColor},set:function(e){var t=this._shaderValues.getVector(UnlitMaterial.ALBEDOCOLOR);i.scale(e,this._albedoIntensity,t),this._albedoColor=e,this._shaderValues.setVector(UnlitMaterial.ALBEDOCOLOR,t)}},{key:"albedoIntensity",get:function(){return this._albedoIntensity},set:function(e){this._AlbedoIntensity=e}},{key:"albedoTexture",get:function(){return this._shaderValues.getTexture(UnlitMaterial.ALBEDOTEXTURE)},set:function(e){e?this._shaderValues.addDefine(UnlitMaterial.SHADERDEFINE_ALBEDOTEXTURE):this._shaderValues.removeDefine(UnlitMaterial.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(UnlitMaterial.ALBEDOTEXTURE,e)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET)},set:function(e){e&&(1!=e.x||1!=e.y||0!=e.z||0!=e.w)?this._shaderValues.addDefine(UnlitMaterial.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(UnlitMaterial.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(UnlitMaterial.TILINGOFFSET,e)}},{key:"enableVertexColor",get:function(){return this._enableVertexColor},set:function(e){this._enableVertexColor=e,e?this._shaderValues.addDefine(UnlitMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR):this._shaderValues.removeDefine(UnlitMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR)}},{key:"renderMode",set:function(e){switch(e){case UnlitMaterial.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=me.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=pe.CULL_BACK,this.blend=pe.BLEND_DISABLE,this.depthTest=pe.DEPTHTEST_LESS;break;case UnlitMaterial.RENDERMODE_CUTOUT:this.renderQueue=me.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=pe.CULL_BACK,this.blend=pe.BLEND_DISABLE,this.depthTest=pe.DEPTHTEST_LESS;break;case UnlitMaterial.RENDERMODE_TRANSPARENT:this.renderQueue=me.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=pe.CULL_BACK,this.blend=pe.BLEND_ENABLE_ALL,this.blendSrc=pe.BLENDPARAM_SRC_ALPHA,this.blendDst=pe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=pe.DEPTHTEST_LESS;break;default:throw new Error("UnlitMaterial : renderMode value error.")}}},{key:"depthWrite",get:function(){return this._shaderValues.getBool(UnlitMaterial.DEPTH_WRITE)},set:function(e){this._shaderValues.setBool(UnlitMaterial.DEPTH_WRITE,e)}},{key:"cull",get:function(){return this._shaderValues.getInt(UnlitMaterial.CULL)},set:function(e){this._shaderValues.setInt(UnlitMaterial.CULL,e)}},{key:"blend",get:function(){return this._shaderValues.getInt(UnlitMaterial.BLEND)},set:function(e){this._shaderValues.setInt(UnlitMaterial.BLEND,e)}},{key:"blendSrc",get:function(){return this._shaderValues.getInt(UnlitMaterial.BLEND_SRC)},set:function(e){this._shaderValues.setInt(UnlitMaterial.BLEND_SRC,e)}},{key:"blendDst",get:function(){return this._shaderValues.getInt(UnlitMaterial.BLEND_DST)},set:function(e){this._shaderValues.setInt(UnlitMaterial.BLEND_DST,e)}},{key:"depthTest",get:function(){return this._shaderValues.getInt(UnlitMaterial.DEPTH_TEST)},set:function(e){this._shaderValues.setInt(UnlitMaterial.DEPTH_TEST,e)}}],[{key:"__initDefine__",value:function(){UnlitMaterial.SHADERDEFINE_ALBEDOTEXTURE=ue.getDefineByName("ALBEDOTEXTURE"),UnlitMaterial.SHADERDEFINE_TILINGOFFSET=ue.getDefineByName("TILINGOFFSET"),UnlitMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR=ue.getDefineByName("ENABLEVERTEXCOLOR")}}]),UnlitMaterial}(me);cr.RENDERMODE_OPAQUE=0,cr.RENDERMODE_CUTOUT=1,cr.RENDERMODE_TRANSPARENT=2,cr.RENDERMODE_ADDTIVE=3,cr.ALBEDOTEXTURE=ue.propertyNameToID("u_AlbedoTexture"),cr.ALBEDOCOLOR=ue.propertyNameToID("u_AlbedoColor"),cr.TILINGOFFSET=ue.propertyNameToID("u_TilingOffset"),cr.CULL=ue.propertyNameToID("s_Cull"),cr.BLEND=ue.propertyNameToID("s_Blend"),cr.BLEND_SRC=ue.propertyNameToID("s_BlendSrc"),cr.BLEND_DST=ue.propertyNameToID("s_BlendDst"),cr.DEPTH_TEST=ue.propertyNameToID("s_DepthTest"),cr.DEPTH_WRITE=ue.propertyNameToID("s_DepthWrite");var hr=function(e){function WaterPrimaryMaterial(){var e;return _classCallCheck(this,WaterPrimaryMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(WaterPrimaryMaterial).call(this))).setShaderName("WaterPrimary"),e._shaderValues.setVector(WaterPrimaryMaterial.HORIZONCOLOR,new i(.172,.463,.435,0)),e._shaderValues.setNumber(WaterPrimaryMaterial.WAVESCALE,.15),e._shaderValues.setVector(WaterPrimaryMaterial.WAVESPEED,new i(19,9,-16,-7)),e}return _inherits(WaterPrimaryMaterial,e),_createClass(WaterPrimaryMaterial,[{key:"clone",value:function(){var e=new WaterPrimaryMaterial;return this.cloneTo(e),e}},{key:"horizonColor",get:function(){return this._shaderValues.getVector(WaterPrimaryMaterial.HORIZONCOLOR)},set:function(e){this._shaderValues.setVector(WaterPrimaryMaterial.HORIZONCOLOR,e)}},{key:"mainTexture",get:function(){return this._shaderValues.getTexture(WaterPrimaryMaterial.MAINTEXTURE)},set:function(e){e?this._shaderValues.addDefine(WaterPrimaryMaterial.SHADERDEFINE_MAINTEXTURE):this._shaderValues.removeDefine(WaterPrimaryMaterial.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(WaterPrimaryMaterial.MAINTEXTURE,e)}},{key:"normalTexture",get:function(){return this._shaderValues.getTexture(WaterPrimaryMaterial.NORMALTEXTURE)},set:function(e){e?this._shaderValues.addDefine(WaterPrimaryMaterial.SHADERDEFINE_NORMALTEXTURE):this._shaderValues.removeDefine(WaterPrimaryMaterial.SHADERDEFINE_NORMALTEXTURE),this._shaderValues.setTexture(WaterPrimaryMaterial.NORMALTEXTURE,e)}},{key:"waveScale",get:function(){return this._shaderValues.getNumber(WaterPrimaryMaterial.WAVESCALE)},set:function(e){this._shaderValues.setNumber(WaterPrimaryMaterial.WAVESCALE,e)}},{key:"waveSpeed",get:function(){return this._shaderValues.getVector(WaterPrimaryMaterial.WAVESPEED)},set:function(e){this._shaderValues.setVector(WaterPrimaryMaterial.WAVESPEED,e)}}],[{key:"__initDefine__",value:function(){WaterPrimaryMaterial.SHADERDEFINE_MAINTEXTURE=ue.getDefineByName("MAINTEXTURE"),WaterPrimaryMaterial.SHADERDEFINE_NORMALTEXTURE=ue.getDefineByName("NORMALTEXTURE")}}]),WaterPrimaryMaterial}(me);hr.HORIZONCOLOR=ue.propertyNameToID("u_HorizonColor"),hr.MAINTEXTURE=ue.propertyNameToID("u_MainTexture"),hr.NORMALTEXTURE=ue.propertyNameToID("u_NormalTexture"),hr.WAVESCALE=ue.propertyNameToID("u_WaveScale"),hr.WAVESPEED=ue.propertyNameToID("u_WaveSpeed");var _r=function MeshSprite3DShaderDeclaration(){_classCallCheck(this,MeshSprite3DShaderDeclaration)},dr=function(e){function MeshRenderer(e){var t;return _classCallCheck(this,MeshRenderer),(t=_possibleConstructorReturn(this,_getPrototypeOf(MeshRenderer).call(this,e)))._revertStaticBatchDefineUV1=!1,t._projectionViewWorldMatrix=new c,t}return _inherits(MeshRenderer,e),_createClass(MeshRenderer,[{key:"_createRenderElement",value:function(){return new wt}},{key:"_onMeshChange",value:function(e){if(e){var t=e.subMeshCount;this._renderElements.length=t;for(var r=0;r<t;r++){var n=this._renderElements[r];if(!n){var i=this.sharedMaterials[r];(n=this._renderElements[r]=this._createRenderElement()).setTransform(this._owner._transform),n.render=this,n.material=i||ge.defaultMaterial}n.setGeometry(e.getSubMesh(r))}}else this._renderElements.length=0;this._boundsChange=!0}},{key:"_calculateBoundingBox",value:function(){var e=this._owner.meshFilter.sharedMesh;if(e){var r=this._owner.transform.worldMatrix;e.bounds._tranform(r,this._bounds)}if(t.Render.supportWebGLPlusCulling){var n=this._bounds.getMin(),i=this._bounds.getMax(),a=Ie._cullingBuffer;a[this._cullingBufferIndex+1]=n.x,a[this._cullingBufferIndex+2]=n.y,a[this._cullingBufferIndex+3]=n.z,a[this._cullingBufferIndex+4]=i.x,a[this._cullingBufferIndex+5]=i.y,a[this._cullingBufferIndex+6]=i.z}}},{key:"_needRender",value:function(e,t){return!e||e.intersects(this.bounds._getBoundBox())}},{key:"_renderUpdate",value:function(e,t){this._applyLightMapParams();var r=e.renderElement;switch(r.renderType){case kt.RENDERTYPE_NORMAL:this._shaderValues.setMatrix4x4(et.WORLDMATRIX,t.worldMatrix);break;case kt.RENDERTYPE_STATICBATCH:t?this._shaderValues.setMatrix4x4(et.WORLDMATRIX,t.worldMatrix):this._shaderValues.setMatrix4x4(et.WORLDMATRIX,c.DEFAULT),this._shaderValues.hasDefine(_r.SHADERDEFINE_UV1)?this._revertStaticBatchDefineUV1=!1:(this._shaderValues.addDefine(_r.SHADERDEFINE_UV1),this._revertStaticBatchDefineUV1=!0),this._shaderValues.setVector(Ot.LIGHTMAPSCALEOFFSET,Ut._defaultLightmapScaleOffset);break;case kt.RENDERTYPE_VERTEXBATCH:this._shaderValues.setMatrix4x4(et.WORLDMATRIX,c.DEFAULT);break;case kt.RENDERTYPE_INSTANCEBATCH:for(var n=bt.instance.instanceWorldMatrixData,i=r.instanceBatchElementList,a=i.elements,o=i.length,s=0;s<o;s++)n.set(a[s]._transform.worldMatrix.elements,16*s);var l=bt.instance.instanceWorldMatrixBuffer;l.orphanStorage(),l.setData(n.buffer,0,0,16*o*4),this._shaderValues.addDefine(_r.SHADERDEFINE_GPU_INSTANCE)}}},{key:"_renderUpdateWithCamera",value:function(e,t){var r=e.projectionViewMatrix;if(r){var n=e.renderElement;switch(n.renderType){case kt.RENDERTYPE_NORMAL:case kt.RENDERTYPE_STATICBATCH:case kt.RENDERTYPE_VERTEXBATCH:t?(c.multiply(r,t.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(et.MVPMATRIX,this._projectionViewWorldMatrix)):this._shaderValues.setMatrix4x4(et.MVPMATRIX,r);break;case kt.RENDERTYPE_INSTANCEBATCH:for(var i=bt.instance.instanceMVPMatrixData,a=n.instanceBatchElementList,o=a.elements,s=a.length,l=0;l<s;l++){var u=o[l]._transform.worldMatrix;P.mulMatrixByArray(r.elements,0,u.elements,0,i,16*l)}var h=bt.instance.instanceMVPMatrixBuffer;h.orphanStorage(),h.setData(i.buffer,0,0,16*s*4)}}}},{key:"_revertBatchRenderUpdate",value:function(e){switch(e.renderElement.renderType){case kt.RENDERTYPE_STATICBATCH:this._revertStaticBatchDefineUV1&&this._shaderValues.removeDefine(_r.SHADERDEFINE_UV1),this._shaderValues.setVector(Ot.LIGHTMAPSCALEOFFSET,this.lightmapScaleOffset);break;case kt.RENDERTYPE_INSTANCEBATCH:this._shaderValues.removeDefine(_r.SHADERDEFINE_GPU_INSTANCE)}}},{key:"_destroy",value:function(){this._isPartOfStaticBatch&&Ft.instance._removeRenderSprite(this._owner),_get(_getPrototypeOf(MeshRenderer.prototype),"_destroy",this).call(this)}}]),MeshRenderer}(Ut),fr=function(){function MeshFilter(e){_classCallCheck(this,MeshFilter),this._owner=e}return _createClass(MeshFilter,[{key:"_getMeshDefine",value:function(e,t){t.length=0;for(var r=0,n=e._subMeshes.length;r<n;r++)for(var i=e.getSubMesh(r)._vertexBuffer._vertexDeclaration._vertexElements,a=0,o=i.length;a<o;a++){switch(i[a]._elementUsage){case Qe.MESH_COLOR0:t.push(_r.SHADERDEFINE_COLOR);break;case Qe.MESH_TEXTURECOORDINATE0:t.push(_r.SHADERDEFINE_UV0);break;case Qe.MESH_TEXTURECOORDINATE1:t.push(_r.SHADERDEFINE_UV1)}}}},{key:"destroy",value:function(){this._owner=null,this._sharedMesh&&(this._sharedMesh._removeReference(),this._sharedMesh=null)}},{key:"sharedMesh",get:function(){return this._sharedMesh},set:function(e){if(this._sharedMesh!==e){var t=this._owner._render._shaderValues,r=this._sharedMesh;if(r){r._removeReference(),this._getMeshDefine(r,MeshFilter._meshVerticeDefine);for(var n=0,i=MeshFilter._meshVerticeDefine.length;n<i;n++)t.removeDefine(MeshFilter._meshVerticeDefine[n])}if(e){e._addReference(),this._getMeshDefine(e,MeshFilter._meshVerticeDefine);for(n=0,i=MeshFilter._meshVerticeDefine.length;n<i;n++)t.addDefine(MeshFilter._meshVerticeDefine[n])}this._owner._render._onMeshChange(e),this._sharedMesh=e}}}]),MeshFilter}();fr._meshVerticeDefine=[];var mr=function(r){function SubMeshDynamicBatch(){var r;_classCallCheck(this,SubMeshDynamicBatch),(r=_possibleConstructorReturn(this,_getPrototypeOf(SubMeshDynamicBatch).call(this)))._bufferState=new We;var n=t.LayaGL.instance,i=Qe.getVertexDeclaration("POSITION,NORMAL,COLOR,UV,UV1,TANGENT").vertexStride*SubMeshDynamicBatch.maxIndicesCount;r._vertices=new Float32Array(i/4),r._vertexBuffer=new qe(i,n.DYNAMIC_DRAW),r._indices=new Int16Array(SubMeshDynamicBatch.maxIndicesCount),r._indexBuffer=new Xe(e.IndexFormat.UInt16,r._indices.length,n.DYNAMIC_DRAW);var a=r._vertexBuffer._byteLength+r._indexBuffer._byteLength;return t.Resource._addMemory(a,a),r}return _inherits(SubMeshDynamicBatch,r),_createClass(SubMeshDynamicBatch,[{key:"_getBatchVertices",value:function(e,t,r,n,i,a){var o=e.vertexStride/4,s=a._vertexBuffer.getFloat32Data(),l=(i.render.lightmapScaleOffset,i._dynamicMultiSubMesh),u=i._dynamicVertexCount;i._computeWorldPositionsAndNormals(this._positionOffset,this._normalOffset,l,u);for(var c=i._dynamicWorldPositions,h=i._dynamicWorldNormals,_=a._indices,d=0;d<u;d++){var f=(l?_[d]:d)*o,m=(d+r)*o,T=3*d,p=m+this._positionOffset;t[p]=c[T],t[p+1]=c[T+1],t[p+2]=c[T+2],-1!==this._normalOffset&&(t[p=m+this._normalOffset]=h[T],t[p+1]=h[T+1],t[p+2]=h[T+2]),-1!==this._colorOffset&&(p=m+this._colorOffset,T=f+this._colorOffset,t[p]=s[T],t[p+1]=s[T+1],t[p+2]=s[T+2],t[p+3]=s[T+3]),-1!==this._uv0Offset&&(p=m+this._uv0Offset,T=f+this._uv0Offset,t[p]=s[T],t[p+1]=s[T+1]),-1!==this._sTangentOffset&&(p=m+this._sTangentOffset,T=f+this._sTangentOffset,t[p]=s[T],t[p+1]=s[T+1],t[p+2]=s[T+2],t[p+3]=s[T+3],p=m+this._sTangentOffset,T=f+this._sTangentOffset,t[p]=s[T],t[p+1]=s[T+1],t[p+2]=s[T+2],t[p+3]=s[T+3])}}},{key:"_getBatchIndices",value:function(e,t,r,n,i,a){var o,s,l,u=i._indices,c=n._isFrontFaceInvert;if(a)if(c)for(o=0,s=u.length;o<s;o+=3){var h=r+o;e[l=t+o]=h,e[l+1]=h+2,e[l+2]=h+1}else for(o=0,s=u.length;o<s;o+=3)h=r+o,e[l=t+o]=h,e[l+1]=h+1,e[l+2]=h+2;else if(c)for(o=0,s=u.length;o<s;o+=3)e[l=t+o]=r+u[o],e[l+1]=r+u[o+2],e[l+2]=r+u[o+1];else for(o=0,s=u.length;o<s;o+=3)e[l=t+o]=r+u[o],e[l+1]=r+u[o+1],e[l+2]=r+u[o+2]}},{key:"_flush",value:function(e,r){var n=t.LayaGL.instance;this._vertexBuffer.setData(this._vertices.buffer,0,0,e*this._bufferState.vertexDeclaration.vertexStride),this._indexBuffer.setData(this._indices,0,0,r),n.drawElements(n.TRIANGLES,r,n.UNSIGNED_SHORT,0)}},{key:"_prepareRender",value:function(e){var t=e.renderElement.vertexBatchVertexDeclaration;this._bufferState=l.MeshRenderDynamicBatchManager.instance._getBufferState(t),this._positionOffset=t.getVertexElementByUsage(Qe.MESH_POSITION0)._offset/4;var r=t.getVertexElementByUsage(Qe.MESH_NORMAL0);this._normalOffset=r?r._offset/4:-1;var n=t.getVertexElementByUsage(Qe.MESH_COLOR0);this._colorOffset=n?n._offset/4:-1;var i=t.getVertexElementByUsage(Qe.MESH_TEXTURECOORDINATE0);this._uv0Offset=i?i._offset/4:-1;var a=t.getVertexElementByUsage(Qe.MESH_TEXTURECOORDINATE1);this._uv1Offset=a?a._offset/4:-1;var o=t.getVertexElementByUsage(Qe.MESH_TANGENT0);return this._sTangentOffset=o?o._offset/4:-1,!0}},{key:"_render",value:function(e){this._bufferState.bind();for(var r=e.renderElement,n=r.vertexBatchVertexDeclaration,i=r.vertexBatchElementList,a=0,o=0,s=(n.vertexStride,0),l=i.length,u=i.elements,c=0;c<l;c++){var h=u[c],_=h._geometry,d=_._indexCount;o+d>SubMeshDynamicBatch.maxIndicesCount&&(this._flush(a,o),s++,t.Stat.trianglesFaces+=o/3,a=o=0);var f=h._transform;this._getBatchVertices(n,this._vertices,a,f,h,_),this._getBatchIndices(this._indices,o,a,f,_,h._dynamicMultiSubMesh),a+=h._dynamicVertexCount,o+=d}this._flush(a,o),s++,t.Stat.renderBatches+=s,t.Stat.savedRenderBatches+=l-s,t.Stat.trianglesFaces+=o/3}}],[{key:"__init__",value:function(){SubMeshDynamicBatch.instance=new SubMeshDynamicBatch}}]),SubMeshDynamicBatch}(It);mr.maxAllowVertexCount=10,mr.maxAllowAttribueCount=900,mr.maxIndicesCount=32e3;var Tr=function(e){function MeshRenderDynamicBatchManager(){var e;return _classCallCheck(this,MeshRenderDynamicBatchManager),(e=_possibleConstructorReturn(this,_getPrototypeOf(MeshRenderDynamicBatchManager).call(this)))._instanceBatchOpaqueMarks=[],e._vertexBatchOpaqueMarks=[],e._cacheBufferStates=[],e._updateCountMark=0,e}return _inherits(MeshRenderDynamicBatchManager,e),_createClass(MeshRenderDynamicBatchManager,[{key:"getInstanceBatchOpaquaMark",value:function(e,t,r,n){var i=this._instanceBatchOpaqueMarks[e?0:1]||(this._instanceBatchOpaqueMarks[e?0:1]=[]),a=i[t]||(i[t]=[]),o=a[r]||(a[r]=[]);return o[n?1:0]||(o[n?1:0]=new Nt)}},{key:"getVertexBatchOpaquaMark",value:function(e,t,r,n){var i=this._vertexBatchOpaqueMarks[e]||(this._vertexBatchOpaqueMarks[e]=[]),a=i[t?0:1]||(i[t?0:1]=[]),o=a[r]||(a[r]=[]);return o[n]||(o[n]=new Nt)}},{key:"_getBufferState",value:function(e){var t=this._cacheBufferStates[e.id];if(!t){var r=mr.instance;(t=new We).bind();var n=r._vertexBuffer;n.vertexDeclaration=e,t.applyVertexBuffer(n),t.applyIndexBuffer(r._indexBuffer),t.unBind(),this._cacheBufferStates[e.id]=t}return t}},{key:"_getBatchRenderElementFromPool",value:function(){var e=this._batchRenderElementPool[this._batchRenderElementPoolIndex++];return e||(e=new wt,this._batchRenderElementPool[this._batchRenderElementPoolIndex-1]=e,e.vertexBatchElementList=new R,e.instanceBatchElementList=new R),e}},{key:"_clear",value:function(){_get(_getPrototypeOf(MeshRenderDynamicBatchManager.prototype),"_clear",this).call(this),this._updateCountMark++}}]),MeshRenderDynamicBatchManager}(er);Tr.instance=new Tr;var pr=function(e){function MeshSprite3D(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return _classCallCheck(this,MeshSprite3D),(e=_possibleConstructorReturn(this,_getPrototypeOf(MeshSprite3D).call(this,r)))._meshFilter=new fr(_assertThisInitialized(e)),e._render=new dr(_assertThisInitialized(e)),t&&(e._meshFilter.sharedMesh=t),e}return _inherits(MeshSprite3D,e),_createClass(MeshSprite3D,[{key:"_parse",value:function(e,r){_get(_getPrototypeOf(MeshSprite3D.prototype),"_parse",this).call(this,e,r);var n=this.meshRenderer,a=e.lightmapIndex;null!=a&&(n.lightmapIndex=a);var o=e.lightmapScaleOffset;o&&(n.lightmapScaleOffset=new i(o[0],o[1],o[2],o[3])),null!=e.meshPath&&(this.meshFilter.sharedMesh=t.Loader.getRes(e.meshPath)),null!=e.enableRender&&(n.enable=e.enableRender),null!=e.receiveShadows&&(n.receiveShadow=e.receiveShadows),null!=e.castShadow&&(n.castShadow=e.castShadow);var s=e.materials;if(s){var l=n.sharedMaterials,u=s.length;l.length=u;for(var c=0;c<u;c++)l[c]=t.Loader.getRes(s[c].path);n.sharedMaterials=l}}},{key:"_addToInitStaticBatchManager",value:function(){this.meshFilter.sharedMesh&&Ft.instance._addBatchSprite(this)}},{key:"_cloneTo",value:function(e,t,r){var n=e;n._meshFilter.sharedMesh=this._meshFilter.sharedMesh;var i=this._render,a=n._render;a.enable=i.enable,a.sharedMaterials=i.sharedMaterials,a.castShadow=i.castShadow;var o=i.lightmapScaleOffset;o&&(a.lightmapScaleOffset=o.clone()),a.lightmapIndex=i.lightmapIndex,a.receiveShadow=i.receiveShadow,a.sortingFudge=i.sortingFudge,_get(_getPrototypeOf(MeshSprite3D.prototype),"_cloneTo",this).call(this,e,t,r)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(MeshSprite3D.prototype),"destroy",this).call(this,e),this._meshFilter.destroy())}},{key:"_create",value:function(){return new MeshSprite3D}},{key:"meshFilter",get:function(){return this._meshFilter}},{key:"meshRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){_r.SHADERDEFINE_UV0=ue.getDefineByName("UV"),_r.SHADERDEFINE_COLOR=ue.getDefineByName("COLOR"),_r.SHADERDEFINE_UV1=ue.getDefineByName("UV1"),_r.SHADERDEFINE_GPU_INSTANCE=ue.getDefineByName("GPU_INSTANCE"),Bt._registerManager(Ft.instance),er._registerManager(Tr.instance)}}]),MeshSprite3D}(Ot),gr=function GradientMode(){_classCallCheck(this,GradientMode)};gr.Blend=0,gr.Fixed=1;var Er,yr=function(){function Gradient(e,t){_classCallCheck(this,Gradient),this._mode=0,this._maxColorRGBKeysCount=0,this._maxColorAlphaKeysCount=0,this._colorRGBKeysCount=0,this._colorAlphaKeysCount=0,this._alphaElements=null,this._rgbElements=null,this._maxColorRGBKeysCount=e,this._maxColorAlphaKeysCount=t,this._rgbElements=new Float32Array(4*e),this._alphaElements=new Float32Array(2*t)}return _createClass(Gradient,[{key:"addColorRGB",value:function(e,t){if(this._colorRGBKeysCount<this._maxColorRGBKeysCount){var r=4*this._colorRGBKeysCount;this._rgbElements[r]=e,this._rgbElements[r+1]=t.r,this._rgbElements[r+2]=t.g,this._rgbElements[r+3]=t.b,this._colorRGBKeysCount++}else console.warn("Gradient:warning:data count must lessEqual than "+this._maxColorRGBKeysCount)}},{key:"addColorAlpha",value:function(e,t){if(this._colorAlphaKeysCount<this._maxColorAlphaKeysCount){var r=2*this._colorAlphaKeysCount;this._alphaElements[r]=e,this._alphaElements[r+1]=t,this._colorAlphaKeysCount++}else console.warn("Gradient:warning:data count must lessEqual than "+this._maxColorAlphaKeysCount)}},{key:"updateColorRGB",value:function(e,t,r){if(e<this._colorRGBKeysCount){var n=4*e;this._rgbElements[n]=t,this._rgbElements[n+1]=r.r,this._rgbElements[n+2]=r.g,this._rgbElements[n+3]=r.b}else console.warn("Gradient:warning:index must lessEqual than colorRGBKeysCount:"+this._colorRGBKeysCount)}},{key:"updateColorAlpha",value:function(e,t,r){if(e<this._colorAlphaKeysCount){var n=2*e;this._alphaElements[n]=t,this._alphaElements[n+1]=r}else console.warn("Gradient:warning:index must lessEqual than colorAlphaKeysCount:"+this._colorAlphaKeysCount)}},{key:"evaluateColorRGB",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e=Math.min(Math.max(e,0),1);var i=this._rgbElements,a=r;if(n)for(var o=a;o>=0;o--){var s=4*o;if(e===(d=i[s]))return t.r=i[s+1],t.g=i[s+2],t.b=i[s+3],a;switch(this._mode){case gr.Blend:if(e>d){if(e>(_=i[s+4]))throw"Gradient:wrong startSearchIndex.";var l=_-d,u=_-e,c=e-d;return t.r=(u*i[s+1]+c*i[s+5])/l,t.g=(u*i[s+2]+c*i[s+6])/l,t.b=(u*i[s+3]+c*i[s+7])/l,a}a--;continue;case gr.Fixed:if(e>d){if(e>i[s+4])throw"Gradient:wrong startSearchIndex.";return t.r=i[s+5],t.g=i[s+6],t.b=i[s+7],a}a--;continue;default:throw"Gradient:unknown mode."}}else{o=0;for(var h=this._rgbElements.length;o<h;o++){var _;if(e===(_=i[s=4*o]))return t.r=i[s+1],t.g=i[s+2],t.b=i[s+3],a;switch(this._mode){case gr.Blend:if(e<_){var d;if(e<(d=i[s-4]))throw"Gradient:wrong startSearchIndex.";l=_-d,u=_-e,c=e-d;return t.r=(u*i[s-3]+c*i[s+1])/l,t.g=(u*i[s-2]+c*i[s+2])/l,t.b=(u*i[s-1]+c*i[s+3])/l,a}a++;continue;case gr.Fixed:if(e<_){if(e<i[s-4])throw"Gradient:wrong startSearchIndex.";return t.r=i[s+1],t.g=i[s+2],t.b=i[s+3],a}a++;continue;default:throw"Gradient:unknown mode."}}}return a}},{key:"evaluateColorAlpha",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e=Math.min(Math.max(e,0),1);var i=this._alphaElements,a=r;if(n)for(var o=a;o>=0;o--){if(e===(d=i[h=2*o]))return t.a=i[h+1],a;switch(this._mode){case gr.Blend:if(e>d){if(e>(_=i[h+2]))throw"Gradient:wrong startSearchIndex.";var s=_-d,l=_-e,u=e-d;return t.a=(l*i[h+1]+u*i[h+3])/s,a}a--;continue;case gr.Fixed:if(e>d){if(e>i[h+2])throw"Gradient:wrong startSearchIndex.";return t.a=i[h+3],a}a--;continue;default:throw"Gradient:unknown mode."}}else{o=a;for(var c=this._alphaElements.length;o<c;o++){var h,_;if(e===(_=i[h=2*o]))return t.a=i[h+1],a;switch(this._mode){case gr.Blend:if(e<_){var d;if(e<(d=i[h-2]))throw"Gradient:wrong startSearchIndex.";s=_-d,l=_-e,u=e-d;return t.a=(l*i[h-1]+u*i[h+1])/s,a}a++;continue;case gr.Fixed:if(e<_){if(e<i[h-2])throw"Gradient:wrong startSearchIndex.";return t.a=i[h+1],a}a++;continue;default:throw"Gradient:unknown mode."}}}return a}},{key:"cloneTo",value:function(e){var t,r,n=e;n._colorAlphaKeysCount=this._colorAlphaKeysCount;var i=n._alphaElements;for(t=0,r=this._alphaElements.length;t<r;t++)i[t]=this._alphaElements[t];n._colorRGBKeysCount=this._colorRGBKeysCount;var a=n._rgbElements;for(t=0,r=this._rgbElements.length;t<r;t++)a[t]=this._rgbElements[t]}},{key:"clone",value:function(){var e=new Gradient(this._maxColorRGBKeysCount,this._maxColorAlphaKeysCount);return this.cloneTo(e),e}},{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}},{key:"colorRGBKeysCount",get:function(){return this._colorRGBKeysCount}},{key:"colorAlphaKeysCount",get:function(){return this._colorAlphaKeysCount}},{key:"maxColorRGBKeysCount",get:function(){return this._maxColorRGBKeysCount}},{key:"maxColorAlphaKeysCount",get:function(){return this._maxColorAlphaKeysCount}}]),Gradient}(),Sr=function(){function Burst(e,t,r){_classCallCheck(this,Burst),this._time=e,this._minCount=t,this._maxCount=r}return _createClass(Burst,[{key:"cloneTo",value:function(e){var t=e;t._time=this._time,t._minCount=this._minCount,t._maxCount=this._maxCount}},{key:"clone",value:function(){var e=new Burst(this._time,this._minCount,this._maxCount);return this.cloneTo(e),e}},{key:"time",get:function(){return this._time}},{key:"minCount",get:function(){return this._minCount}},{key:"maxCount",get:function(){return this._maxCount}}]),Burst}(),vr=function(){function GradientColor(){_classCallCheck(this,GradientColor),this._type=0,this._constant=null,this._constantMin=null,this._constantMax=null,this._gradient=null,this._gradientMin=null,this._gradientMax=null}return _createClass(GradientColor,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,this._constant.cloneTo(t._constant),this._constantMin.cloneTo(t._constantMin),this._constantMax.cloneTo(t._constantMax),this._gradient.cloneTo(t._gradient),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax)}},{key:"clone",value:function(){var e=new GradientColor;return this.cloneTo(e),e}},{key:"type",get:function(){return this._type}},{key:"constant",get:function(){return this._constant}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"gradient",get:function(){return this._gradient}},{key:"gradientMin",get:function(){return this._gradientMin}},{key:"gradientMax",get:function(){return this._gradientMax}}],[{key:"createByConstant",value:function(e){var t=new GradientColor;return t._type=0,t._constant=e,t}},{key:"createByGradient",value:function(e){var t=new GradientColor;return t._type=1,t._gradient=e,t}},{key:"createByRandomTwoConstant",value:function(e,t){var r=new GradientColor;return r._type=2,r._constantMin=e,r._constantMax=t,r}},{key:"createByRandomTwoGradient",value:function(e,t){var r=new GradientColor;return r._type=3,r._gradientMin=e,r._gradientMax=t,r}}]),GradientColor}(),Rr=function(){function ColorOverLifetime(e){_classCallCheck(this,ColorOverLifetime),this._color=e}return _createClass(ColorOverLifetime,[{key:"cloneTo",value:function(e){var t=e;this._color.cloneTo(t._color),t.enable=this.enable}},{key:"clone",value:function(){var e;switch(this._color.type){case 0:e=vr.createByConstant(this._color.constant.clone());break;case 1:e=vr.createByGradient(this._color.gradient.clone());break;case 2:e=vr.createByRandomTwoConstant(this._color.constantMin.clone(),this._color.constantMax.clone());break;case 3:e=vr.createByRandomTwoGradient(this._color.gradientMin.clone(),this._color.gradientMax.clone())}var t=new ColorOverLifetime(e);return t.enable=this.enable,t}},{key:"color",get:function(){return this._color}}]),ColorOverLifetime}(),Cr=function(){function FrameOverTime(){_classCallCheck(this,FrameOverTime),this._type=0,this._constant=0,this._overTime=null,this._constantMin=0,this._constantMax=0,this._overTimeMin=null,this._overTimeMax=null}return _createClass(FrameOverTime,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,t._constant=this._constant,this._overTime&&this._overTime.cloneTo(t._overTime),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._overTimeMin&&this._overTimeMin.cloneTo(t._overTimeMin),this._overTimeMax&&this._overTimeMax.cloneTo(t._overTimeMax)}},{key:"clone",value:function(){var e=new FrameOverTime;return this.cloneTo(e),e}},{key:"type",get:function(){return this._type}},{key:"constant",get:function(){return this._constant}},{key:"frameOverTimeData",get:function(){return this._overTime}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"frameOverTimeDataMin",get:function(){return this._overTimeMin}},{key:"frameOverTimeDataMax",get:function(){return this._overTimeMax}}],[{key:"createByConstant",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=new FrameOverTime;return t._type=0,t._constant=e,t}},{key:"createByOverTime",value:function(e){var t=new FrameOverTime;return t._type=1,t._overTime=e,t}},{key:"createByRandomTwoConstant",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=new FrameOverTime;return r._type=2,r._constantMin=e,r._constantMax=t,r}},{key:"createByRandomTwoOverTime",value:function(e,t){var r=new FrameOverTime;return r._type=3,r._overTimeMin=e,r._overTimeMax=t,r}}]),FrameOverTime}(),Mr=function(){function GradientAngularVelocity(){_classCallCheck(this,GradientAngularVelocity),this._type=0,this._separateAxes=!1,this._constant=0,this._constantSeparate=null,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._gradientW=null,this._constantMin=0,this._constantMax=0,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null,this._gradientWMin=null,this._gradientWMax=null}return _createClass(GradientAngularVelocity,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,t._separateAxes=this._separateAxes,t._constant=this._constant,this._constantSeparate.cloneTo(t._constantSeparate),this._gradient.cloneTo(t._gradient),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(t._constantMinSeparate),this._constantMaxSeparate.cloneTo(t._constantMaxSeparate),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)}},{key:"clone",value:function(){var e=new GradientAngularVelocity;return this.cloneTo(e),e}},{key:"type",get:function(){return this._type}},{key:"separateAxes",get:function(){return this._separateAxes}},{key:"constant",get:function(){return this._constant}},{key:"constantSeparate",get:function(){return this._constantSeparate}},{key:"gradient",get:function(){return this._gradient}},{key:"gradientX",get:function(){return this._gradientX}},{key:"gradientY",get:function(){return this._gradientY}},{key:"gradientZ",get:function(){return this._gradientZ}},{key:"gradientW",get:function(){return this._gradientW}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"constantMinSeparate",get:function(){return this._constantMinSeparate}},{key:"constantMaxSeparate",get:function(){return this._constantMaxSeparate}},{key:"gradientMin",get:function(){return this._gradientMin}},{key:"gradientMax",get:function(){return this._gradientMax}},{key:"gradientXMin",get:function(){return this._gradientXMin}},{key:"gradientXMax",get:function(){return this._gradientXMax}},{key:"gradientYMin",get:function(){return this._gradientYMin}},{key:"gradientYMax",get:function(){return this._gradientYMax}},{key:"gradientZMin",get:function(){return this._gradientZMin}},{key:"gradientZMax",get:function(){return this._gradientZMax}},{key:"gradientWMin",get:function(){return this._gradientWMin}},{key:"gradientWMax",get:function(){return this._gradientWMax}}],[{key:"createByConstant",value:function(e){var t=new GradientAngularVelocity;return t._type=0,t._separateAxes=!1,t._constant=e,t}},{key:"createByConstantSeparate",value:function(e){var t=new GradientAngularVelocity;return t._type=0,t._separateAxes=!0,t._constantSeparate=e,t}},{key:"createByGradient",value:function(e){var t=new GradientAngularVelocity;return t._type=1,t._separateAxes=!1,t._gradient=e,t}},{key:"createByGradientSeparate",value:function(e,t,r){var n=new GradientAngularVelocity;return n._type=1,n._separateAxes=!0,n._gradientX=e,n._gradientY=t,n._gradientZ=r,n}},{key:"createByRandomTwoConstant",value:function(e,t){var r=new GradientAngularVelocity;return r._type=2,r._separateAxes=!1,r._constantMin=e,r._constantMax=t,r}},{key:"createByRandomTwoConstantSeparate",value:function(e,t){var r=new GradientAngularVelocity;return r._type=2,r._separateAxes=!0,r._constantMinSeparate=e,r._constantMaxSeparate=t,r}},{key:"createByRandomTwoGradient",value:function(e,t){var r=new GradientAngularVelocity;return r._type=3,r._separateAxes=!1,r._gradientMin=e,r._gradientMax=t,r}},{key:"createByRandomTwoGradientSeparate",value:function(e,t,r,n,i,a,o,s){var l=new GradientAngularVelocity;return l._type=3,l._separateAxes=!0,l._gradientXMin=e,l._gradientXMax=t,l._gradientYMin=r,l._gradientYMax=n,l._gradientZMin=i,l._gradientZMax=a,l._gradientWMin=o,l._gradientWMax=s,l}}]),GradientAngularVelocity}(),Dr=function(){function GradientDataInt(){_classCallCheck(this,GradientDataInt),this._currentLength=0,this._elements=new Float32Array(8)}return _createClass(GradientDataInt,[{key:"add",value:function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("Warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t):console.log("Warning:data count must lessEqual than 4")}},{key:"cloneTo",value:function(e){var t=e;t._currentLength=this._currentLength;for(var r=t._elements,n=0,i=this._elements.length;n<i;n++)r[n]=this._elements[n]}},{key:"clone",value:function(){var e=new GradientDataInt;return this.cloneTo(e),e}},{key:"gradientCount",get:function(){return this._currentLength/2}}]),GradientDataInt}(),xr=function(){function GradientDataNumber(){_classCallCheck(this,GradientDataNumber),this._currentLength=0,this._elements=new Float32Array(8)}return _createClass(GradientDataNumber,[{key:"add",value:function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("GradientDataNumber warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t):console.log("GradientDataNumber warning:data count must lessEqual than 4")}},{key:"getKeyByIndex",value:function(e){return this._elements[2*e]}},{key:"getValueByIndex",value:function(e){return this._elements[2*e+1]}},{key:"getAverageValue",value:function(){for(var e=0,t=0,r=0,n=this._currentLength-2;r<n;r+=2){var i=this._elements[r+1];i+=this._elements[r+3],e+=i*=this._elements[r+2]-this._elements[r],t++}return e/t}},{key:"cloneTo",value:function(e){var t=e;t._currentLength=this._currentLength;for(var r=t._elements,n=0,i=this._elements.length;n<i;n++)r[n]=this._elements[n]}},{key:"clone",value:function(){var e=new GradientDataNumber;return this.cloneTo(e),e}},{key:"gradientCount",get:function(){return this._currentLength/2}}]),GradientDataNumber}(),Ar=function(){function GradientSize(){_classCallCheck(this,GradientSize),this._type=0,this._separateAxes=!1,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=0,this._constantMax=0,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}return _createClass(GradientSize,[{key:"getMaxSizeInGradient",value:function(){var e,t,r=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=-Number.MAX_VALUE;switch(this._type){case 0:if(this._separateAxes){for(e=0,t=this._gradientX.gradientCount;e<t;e++)n=Math.max(n,this._gradientX.getValueByIndex(e));for(e=0,t=this._gradientY.gradientCount;e<t;e++)n=Math.max(n,this._gradientY.getValueByIndex(e));if(r)for(e=0,t=this._gradientZ.gradientCount;e<t;e++)n=Math.max(n,this._gradientZ.getValueByIndex(e))}else for(e=0,t=this._gradient.gradientCount;e<t;e++)n=Math.max(n,this._gradient.getValueByIndex(e));break;case 1:this._separateAxes?(n=Math.max(this._constantMinSeparate.x,this._constantMaxSeparate.x),n=Math.max(n,this._constantMinSeparate.y),r&&(n=n=Math.max(n,this._constantMaxSeparate.z))):n=Math.max(this._constantMin,this._constantMax);break;case 2:if(this._separateAxes){for(e=0,t=this._gradientXMin.gradientCount;e<t;e++)n=Math.max(n,this._gradientXMin.getValueByIndex(e));for(e=0,t=this._gradientXMax.gradientCount;e<t;e++)n=Math.max(n,this._gradientXMax.getValueByIndex(e));for(e=0,t=this._gradientYMin.gradientCount;e<t;e++)n=Math.max(n,this._gradientYMin.getValueByIndex(e));for(e=0,t=this._gradientZMax.gradientCount;e<t;e++)n=Math.max(n,this._gradientZMax.getValueByIndex(e));if(r){for(e=0,t=this._gradientZMin.gradientCount;e<t;e++)n=Math.max(n,this._gradientZMin.getValueByIndex(e));for(e=0,t=this._gradientZMax.gradientCount;e<t;e++)n=Math.max(n,this._gradientZMax.getValueByIndex(e))}}else{for(e=0,t=this._gradientMin.gradientCount;e<t;e++)n=Math.max(n,this._gradientMin.getValueByIndex(e));for(e=0,t=this._gradientMax.gradientCount;e<t;e++)n=Math.max(n,this._gradientMax.getValueByIndex(e))}}return n}},{key:"cloneTo",value:function(e){var t=e;t._type=this._type,t._separateAxes=this._separateAxes,this._gradient.cloneTo(t._gradient),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(t._constantMinSeparate),this._constantMaxSeparate.cloneTo(t._constantMaxSeparate),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)}},{key:"clone",value:function(){var e=new GradientSize;return this.cloneTo(e),e}},{key:"type",get:function(){return this._type}},{key:"separateAxes",get:function(){return this._separateAxes}},{key:"gradient",get:function(){return this._gradient}},{key:"gradientX",get:function(){return this._gradientX}},{key:"gradientY",get:function(){return this._gradientY}},{key:"gradientZ",get:function(){return this._gradientZ}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"constantMinSeparate",get:function(){return this._constantMinSeparate}},{key:"constantMaxSeparate",get:function(){return this._constantMaxSeparate}},{key:"gradientMin",get:function(){return this._gradientMin}},{key:"gradientMax",get:function(){return this._gradientMax}},{key:"gradientXMin",get:function(){return this._gradientXMin}},{key:"gradientXMax",get:function(){return this._gradientXMax}},{key:"gradientYMin",get:function(){return this._gradientYMin}},{key:"gradientYMax",get:function(){return this._gradientYMax}},{key:"gradientZMin",get:function(){return this._gradientZMin}},{key:"gradientZMax",get:function(){return this._gradientZMax}}],[{key:"createByGradient",value:function(e){var t=new GradientSize;return t._type=0,t._separateAxes=!1,t._gradient=e,t}},{key:"createByGradientSeparate",value:function(e,t,r){var n=new GradientSize;return n._type=0,n._separateAxes=!0,n._gradientX=e,n._gradientY=t,n._gradientZ=r,n}},{key:"createByRandomTwoConstant",value:function(e,t){var r=new GradientSize;return r._type=1,r._separateAxes=!1,r._constantMin=e,r._constantMax=t,r}},{key:"createByRandomTwoConstantSeparate",value:function(e,t){var r=new GradientSize;return r._type=1,r._separateAxes=!0,r._constantMinSeparate=e,r._constantMaxSeparate=t,r}},{key:"createByRandomTwoGradient",value:function(e,t){var r=new GradientSize;return r._type=2,r._separateAxes=!1,r._gradientMin=e,r._gradientMax=t,r}},{key:"createByRandomTwoGradientSeparate",value:function(e,t,r,n,i,a){var o=new GradientSize;return o._type=2,o._separateAxes=!0,o._gradientXMin=e,o._gradientXMax=t,o._gradientYMin=r,o._gradientYMax=n,o._gradientZMin=i,o._gradientZMax=a,o}}]),GradientSize}(),Ir=function(){function GradientVelocity(){_classCallCheck(this,GradientVelocity),this._type=0,this._constant=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=null,this._constantMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}return _createClass(GradientVelocity,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,this._constant.cloneTo(t._constant),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),this._constantMin.cloneTo(t._constantMin),this._constantMax.cloneTo(t._constantMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)}},{key:"clone",value:function(){var e=new GradientVelocity;return this.cloneTo(e),e}},{key:"type",get:function(){return this._type}},{key:"constant",get:function(){return this._constant}},{key:"gradientX",get:function(){return this._gradientX}},{key:"gradientY",get:function(){return this._gradientY}},{key:"gradientZ",get:function(){return this._gradientZ}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"gradientXMin",get:function(){return this._gradientXMin}},{key:"gradientXMax",get:function(){return this._gradientXMax}},{key:"gradientYMin",get:function(){return this._gradientYMin}},{key:"gradientYMax",get:function(){return this._gradientYMax}},{key:"gradientZMin",get:function(){return this._gradientZMin}},{key:"gradientZMax",get:function(){return this._gradientZMax}}],[{key:"createByConstant",value:function(e){var t=new GradientVelocity;return t._type=0,t._constant=e,t}},{key:"createByGradient",value:function(e,t,r){var n=new GradientVelocity;return n._type=1,n._gradientX=e,n._gradientY=t,n._gradientZ=r,n}},{key:"createByRandomTwoConstant",value:function(e,t){var r=new GradientVelocity;return r._type=2,r._constantMin=e,r._constantMax=t,r}},{key:"createByRandomTwoGradient",value:function(e,t,r,n,i,a){var o=new GradientVelocity;return o._type=3,o._gradientXMin=e,o._gradientXMax=t,o._gradientYMin=r,o._gradientYMax=n,o._gradientZMin=i,o._gradientZMax=a,o}}]),GradientVelocity}(),Lr=function(){function RotationOverLifetime(e){_classCallCheck(this,RotationOverLifetime),this._angularVelocity=e}return _createClass(RotationOverLifetime,[{key:"cloneTo",value:function(e){var t=e;this._angularVelocity.cloneTo(t._angularVelocity),t.enable=this.enable}},{key:"clone",value:function(){var e;switch(this._angularVelocity.type){case 0:e=this._angularVelocity.separateAxes?Mr.createByConstantSeparate(this._angularVelocity.constantSeparate.clone()):Mr.createByConstant(this._angularVelocity.constant);break;case 1:e=this._angularVelocity.separateAxes?Mr.createByGradientSeparate(this._angularVelocity.gradientX.clone(),this._angularVelocity.gradientY.clone(),this._angularVelocity.gradientZ.clone()):Mr.createByGradient(this._angularVelocity.gradient.clone());break;case 2:e=this._angularVelocity.separateAxes?Mr.createByRandomTwoConstantSeparate(this._angularVelocity.constantMinSeparate.clone(),this._angularVelocity.constantMaxSeparate.clone()):Mr.createByRandomTwoConstant(this._angularVelocity.constantMin,this._angularVelocity.constantMax);break;case 3:e=this._angularVelocity.separateAxes?Mr.createByRandomTwoGradientSeparate(this._angularVelocity.gradientXMin.clone(),this._angularVelocity.gradientYMin.clone(),this._angularVelocity.gradientZMin.clone(),this._angularVelocity.gradientWMin.clone(),this._angularVelocity.gradientXMax.clone(),this._angularVelocity.gradientYMax.clone(),this._angularVelocity.gradientZMax.clone(),this._angularVelocity.gradientWMax.clone()):Mr.createByRandomTwoGradient(this._angularVelocity.gradientMin.clone(),this._angularVelocity.gradientMax.clone())}var t=new RotationOverLifetime(e);return t.enable=this.enable,t}},{key:"angularVelocity",get:function(){return this._angularVelocity}}]),RotationOverLifetime}();(Er=e.ParticleSystemShapeType||(e.ParticleSystemShapeType={}))[Er.Box=0]="Box",Er[Er.Circle=1]="Circle",Er[Er.Cone=2]="Cone",Er[Er.Hemisphere=3]="Hemisphere",Er[Er.Sphere=4]="Sphere";var Pr=function(){function BaseShape(){_classCallCheck(this,BaseShape),this.enable=!0,this.randomDirection=0}return _createClass(BaseShape,[{key:"_getShapeBoundBox",value:function(e){throw new Error("BaseShape: must override it.")}},{key:"_getSpeedBoundBox",value:function(e){throw new Error("BaseShape: must override it.")}},{key:"generatePositionAndDirection",value:function(e,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3];throw new Error("BaseShape: must override it.")}},{key:"_calculateProceduralBounds",value:function(e,t,r){this._getShapeBoundBox(e);var n=e.min,i=e.max;o.multiply(n,t,n),o.multiply(i,t,i);var a=new xt(new o,new o);this.randomDirection?(a.min=new o(-1,-1,-1),a.max=new o(1,1,1)):this._getSpeedBoundBox(a);var s=new xt(new o,new o),l=s.min,u=s.max;o.scale(a.min,r.y,l),o.scale(a.max,r.y,u),o.add(e.min,l,l),o.add(e.max,u,u),o.min(e.min,l,e.min),o.max(e.max,l,e.max);var c=new xt(new o,new o),h=c.min,_=c.max;o.scale(a.min,r.x,h),o.scale(a.max,r.x,_),o.min(c.min,_,l),o.max(c.min,_,u),o.min(e.min,l,e.min),o.max(e.max,l,e.max)}},{key:"cloneTo",value:function(e){e.enable=this.enable}},{key:"clone",value:function(){var e=new BaseShape;return this.cloneTo(e),e}}]),BaseShape}(),Or=function(){function ShapeUtils(){_classCallCheck(this,ShapeUtils)}return _createClass(ShapeUtils,null,[{key:"_randomPointUnitArcCircle",value:function(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;r=n?n.getFloat()*e:Math.random()*e,t.x=Math.cos(r),t.y=Math.sin(r)}},{key:"_randomPointInsideUnitArcCircle",value:function(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;ShapeUtils._randomPointUnitArcCircle(e,t,n),r=n?Math.pow(n.getFloat(),.5):Math.pow(Math.random(),.5),t.x=t.x*r,t.y=t.y*r}},{key:"_randomPointUnitCircle",value:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t=r?r.getFloat()*Math.PI*2:Math.random()*Math.PI*2,e.x=Math.cos(t),e.y=Math.sin(t)}},{key:"_randomPointInsideUnitCircle",value:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;ShapeUtils._randomPointUnitCircle(e),t=r?Math.pow(r.getFloat(),.5):Math.pow(Math.random(),.5),e.x=e.x*t,e.y=e.y*t}},{key:"_randomPointUnitSphere",value:function(e){var t,r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;n?(t=e.z=2*n.getFloat()-1,r=n.getFloat()*Math.PI*2):(t=e.z=2*Math.random()-1,r=Math.random()*Math.PI*2);var i=Math.sqrt(1-t*t);e.x=i*Math.cos(r),e.y=i*Math.sin(r)}},{key:"_randomPointInsideUnitSphere",value:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;ShapeUtils._randomPointUnitSphere(e),t=r?Math.pow(r.getFloat(),1/3):Math.pow(Math.random(),1/3),e.x=e.x*t,e.y=e.y*t,e.z=e.z*t}},{key:"_randomPointInsideHalfUnitBox",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t?(e.x=t.getFloat()-.5,e.y=t.getFloat()-.5,e.z=t.getFloat()-.5):(e.x=Math.random()-.5,e.y=Math.random()-.5,e.z=Math.random()-.5)}}]),ShapeUtils}(),Nr=function(t){function BoxShape(){var t;return _classCallCheck(this,BoxShape),(t=_possibleConstructorReturn(this,_getPrototypeOf(BoxShape).call(this))).shapeType=e.ParticleSystemShapeType.Box,t.x=1,t.y=1,t.z=1,t}return _inherits(BoxShape,t),_createClass(BoxShape,[{key:"_getShapeBoundBox",value:function(e){var t=e.min;t.x=.5*-this.x,t.y=.5*-this.y,t.z=.5*-this.z;var r=e.max;r.x=.5*this.x,r.y=.5*this.y,r.z=.5*this.z}},{key:"_getSpeedBoundBox",value:function(e){var t=e.min;t.x=0,t.y=0,t.z=0;var r=e.max;r.x=0,r.y=1,r.z=0}},{key:"generatePositionAndDirection",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;r?(r.seed=n[16],Or._randomPointInsideHalfUnitBox(e,r),n[16]=r.seed):Or._randomPointInsideHalfUnitBox(e),e.x=this.x*e.x,e.y=this.y*e.y,e.z=this.z*e.z,this.randomDirection?r?(r.seed=n[17],Or._randomPointUnitSphere(t,r),n[17]=r.seed):Or._randomPointUnitSphere(t):(t.x=0,t.y=0,t.z=1)}},{key:"cloneTo",value:function(e){_get(_getPrototypeOf(BoxShape.prototype),"cloneTo",this).call(this,e);var t=e;t.x=this.x,t.y=this.y,t.z=this.z,t.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new BoxShape;return this.cloneTo(e),e}}]),BoxShape}(Pr),br=function(t){function CircleShape(){var t;return _classCallCheck(this,CircleShape),(t=_possibleConstructorReturn(this,_getPrototypeOf(CircleShape).call(this))).shapeType=e.ParticleSystemShapeType.Circle,t.radius=1,t.arc=2*Math.PI,t.emitFromEdge=!1,t}return _inherits(CircleShape,t),_createClass(CircleShape,[{key:"_getShapeBoundBox",value:function(e){var t=e.min;t.x=t.z=-this.radius,t.y=0;var r=e.max;r.x=r.z=this.radius,r.y=0}},{key:"_getSpeedBoundBox",value:function(e){var t=e.min;t.x=t.y=-1,t.z=0;var r=e.max;r.x=r.y=1,r.z=0}},{key:"generatePositionAndDirection",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=CircleShape._tempPositionPoint;r?(r.seed=n[16],this.emitFromEdge?Or._randomPointUnitArcCircle(this.arc,CircleShape._tempPositionPoint,r):Or._randomPointInsideUnitArcCircle(this.arc,CircleShape._tempPositionPoint,r),n[16]=r.seed):this.emitFromEdge?Or._randomPointUnitArcCircle(this.arc,CircleShape._tempPositionPoint):Or._randomPointInsideUnitArcCircle(this.arc,CircleShape._tempPositionPoint),e.x=-i.x,e.y=i.y,e.z=0,o.scale(e,this.radius,e),this.randomDirection?r?(r.seed=n[17],Or._randomPointUnitSphere(t,r),n[17]=r.seed):Or._randomPointUnitSphere(t):e.cloneTo(t)}},{key:"cloneTo",value:function(e){_get(_getPrototypeOf(CircleShape.prototype),"cloneTo",this).call(this,e);var t=e;t.radius=this.radius,t.arc=this.arc,t.emitFromEdge=this.emitFromEdge,t.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new CircleShape;return this.cloneTo(e),e}}]),CircleShape}(Pr);br._tempPositionPoint=new n;var kr=function(t){function ConeShape(){var t;return _classCallCheck(this,ConeShape),(t=_possibleConstructorReturn(this,_getPrototypeOf(ConeShape).call(this))).shapeType=e.ParticleSystemShapeType.Cone,t.angle=25/180*Math.PI,t.radius=1,t.length=5,t.emitType=0,t}return _inherits(ConeShape,t),_createClass(ConeShape,[{key:"_getShapeBoundBox",value:function(e){var t=this.radius+this.length*Math.sin(this.angle),r=this.length*Math.cos(this.angle),n=e.min;n.x=n.y=-t,n.z=0;var i=e.max;i.x=i.y=t,i.z=r}},{key:"_getSpeedBoundBox",value:function(e){var t=Math.sin(this.angle),r=e.min;r.x=r.y=-t,r.z=0;var n=e.max;n.x=n.y=t,n.z=1}},{key:"generatePositionAndDirection",value:function(e,t){var r,n,i,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,l=ConeShape._tempPositionPoint,u=Math.cos(this.angle),c=Math.sin(this.angle);switch(this.emitType){case 0:a?(a.seed=s[16],Or._randomPointInsideUnitCircle(ConeShape._tempPositionPoint,a),s[16]=a.seed):Or._randomPointInsideUnitCircle(ConeShape._tempPositionPoint),r=l.x,n=l.y,e.x=r*this.radius,e.y=n*this.radius,e.z=0,this.randomDirection?(a?(a.seed=s[17],Or._randomPointInsideUnitCircle(ConeShape._tempDirectionPoint,a),s[17]=a.seed):Or._randomPointInsideUnitCircle(ConeShape._tempDirectionPoint),i=ConeShape._tempDirectionPoint,t.x=i.x*c,t.y=i.y*c):(t.x=r*c,t.y=n*c),t.z=u;break;case 1:a?(a.seed=s[16],Or._randomPointUnitCircle(ConeShape._tempPositionPoint,a),s[16]=a.seed):Or._randomPointUnitCircle(ConeShape._tempPositionPoint),r=l.x,n=l.y,e.x=r*this.radius,e.y=n*this.radius,e.z=0,this.randomDirection?(a?(a.seed=s[17],Or._randomPointInsideUnitCircle(ConeShape._tempDirectionPoint,a),s[17]=a.seed):Or._randomPointInsideUnitCircle(ConeShape._tempDirectionPoint),i=ConeShape._tempDirectionPoint,t.x=i.x*c,t.y=i.y*c):(t.x=r*c,t.y=n*c),t.z=u;break;case 2:a?(a.seed=s[16],Or._randomPointInsideUnitCircle(ConeShape._tempPositionPoint,a)):Or._randomPointInsideUnitCircle(ConeShape._tempPositionPoint),r=l.x,n=l.y,e.x=r*this.radius,e.y=n*this.radius,e.z=0,t.x=r*c,t.y=n*c,t.z=u,o.normalize(t,t),a?(o.scale(t,this.length*a.getFloat(),t),s[16]=a.seed):o.scale(t,this.length*Math.random(),t),o.add(e,t,e),this.randomDirection&&(a?(a.seed=s[17],Or._randomPointUnitSphere(t,a),s[17]=a.seed):Or._randomPointUnitSphere(t));break;case 3:a?(a.seed=s[16],Or._randomPointUnitCircle(ConeShape._tempPositionPoint,a)):Or._randomPointUnitCircle(ConeShape._tempPositionPoint),r=l.x,n=l.y,e.x=r*this.radius,e.y=n*this.radius,e.z=0,t.x=r*c,t.y=n*c,t.z=u,o.normalize(t,t),a?(o.scale(t,this.length*a.getFloat(),t),s[16]=a.seed):o.scale(t,this.length*Math.random(),t),o.add(e,t,e),this.randomDirection&&(a?(a.seed=s[17],Or._randomPointUnitSphere(t,a),s[17]=a.seed):Or._randomPointUnitSphere(t));break;default:throw new Error("ConeShape:emitType is invalid.")}}},{key:"cloneTo",value:function(e){_get(_getPrototypeOf(ConeShape.prototype),"cloneTo",this).call(this,e);var t=e;t.angle=this.angle,t.radius=this.radius,t.length=this.length,t.emitType=this.emitType,t.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new ConeShape;return this.cloneTo(e),e}}]),ConeShape}(Pr);kr._tempPositionPoint=new n,kr._tempDirectionPoint=new n;var wr=function(t){function HemisphereShape(){var t;return _classCallCheck(this,HemisphereShape),(t=_possibleConstructorReturn(this,_getPrototypeOf(HemisphereShape).call(this))).shapeType=e.ParticleSystemShapeType.Hemisphere,t.radius=1,t.emitFromShell=!1,t}return _inherits(HemisphereShape,t),_createClass(HemisphereShape,[{key:"_getShapeBoundBox",value:function(e){var t=e.min;t.x=t.y=t.z=-this.radius;var r=e.max;r.x=r.y=this.radius,r.z=0}},{key:"_getSpeedBoundBox",value:function(e){var t=e.min;t.x=t.y=-1,t.z=0;var r=e.max;r.x=r.y=r.z=1}},{key:"generatePositionAndDirection",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;r?(r.seed=n[16],this.emitFromShell?Or._randomPointUnitSphere(e,r):Or._randomPointInsideUnitSphere(e,r),n[16]=r.seed):this.emitFromShell?Or._randomPointUnitSphere(e):Or._randomPointInsideUnitSphere(e),o.scale(e,this.radius,e);var i=e.z;i<0&&(e.z=-1*i),this.randomDirection?r?(r.seed=n[17],Or._randomPointUnitSphere(t,r),n[17]=r.seed):Or._randomPointUnitSphere(t):e.cloneTo(t)}},{key:"cloneTo",value:function(e){_get(_getPrototypeOf(HemisphereShape.prototype),"cloneTo",this).call(this,e);var t=e;t.radius=this.radius,t.emitFromShell=this.emitFromShell,t.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new HemisphereShape;return this.cloneTo(e),e}}]),HemisphereShape}(Pr),Br=function(t){function SphereShape(){var t;return _classCallCheck(this,SphereShape),(t=_possibleConstructorReturn(this,_getPrototypeOf(SphereShape).call(this))).shapeType=e.ParticleSystemShapeType.Sphere,t.radius=1,t.emitFromShell=!1,t}return _inherits(SphereShape,t),_createClass(SphereShape,[{key:"_getShapeBoundBox",value:function(e){var t=e.min;t.x=t.y=t.z=-this.radius;var r=e.max;r.x=r.y=r.z=this.radius}},{key:"_getSpeedBoundBox",value:function(e){var t=e.min;t.x=t.y=t.z=-1;var r=e.max;r.x=r.y=r.z=1}},{key:"generatePositionAndDirection",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;r?(r.seed=n[16],this.emitFromShell?Or._randomPointUnitSphere(e,r):Or._randomPointInsideUnitSphere(e,r),n[16]=r.seed):this.emitFromShell?Or._randomPointUnitSphere(e):Or._randomPointInsideUnitSphere(e),o.scale(e,this.radius,e),this.randomDirection?r?(r.seed=n[17],Or._randomPointUnitSphere(t,r),n[17]=r.seed):Or._randomPointUnitSphere(t):e.cloneTo(t)}},{key:"cloneTo",value:function(e){_get(_getPrototypeOf(SphereShape.prototype),"cloneTo",this).call(this,e);var t=e;t.radius=this.radius,t.emitFromShell=this.emitFromShell,t.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new SphereShape;return this.cloneTo(e),e}}]),SphereShape}(Pr),Vr=function(){function SizeOverLifetime(e){_classCallCheck(this,SizeOverLifetime),this._size=e}return _createClass(SizeOverLifetime,[{key:"cloneTo",value:function(e){var t=e;this._size.cloneTo(t._size),t.enable=this.enable}},{key:"clone",value:function(){var e;switch(this._size.type){case 0:e=this._size.separateAxes?Ar.createByGradientSeparate(this._size.gradientX.clone(),this._size.gradientY.clone(),this._size.gradientZ.clone()):Ar.createByGradient(this._size.gradient.clone());break;case 1:e=this._size.separateAxes?Ar.createByRandomTwoConstantSeparate(this._size.constantMinSeparate.clone(),this._size.constantMaxSeparate.clone()):Ar.createByRandomTwoConstant(this._size.constantMin,this._size.constantMax);break;case 2:e=this._size.separateAxes?Ar.createByRandomTwoGradientSeparate(this._size.gradientXMin.clone(),this._size.gradientYMin.clone(),this._size.gradientZMin.clone(),this._size.gradientXMax.clone(),this._size.gradientYMax.clone(),this._size.gradientZMax.clone()):Ar.createByRandomTwoGradient(this._size.gradientMin.clone(),this._size.gradientMax.clone())}var t=new SizeOverLifetime(e);return t.enable=this.enable,t}},{key:"size",get:function(){return this._size}}]),SizeOverLifetime}(),Fr=function(){function StartFrame(){_classCallCheck(this,StartFrame),this._type=0,this._constant=0,this._constantMin=0,this._constantMax=0}return _createClass(StartFrame,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,t._constant=this._constant,t._constantMin=this._constantMin,t._constantMax=this._constantMax}},{key:"clone",value:function(){var e=new StartFrame;return this.cloneTo(e),e}},{key:"type",get:function(){return this._type}},{key:"constant",get:function(){return this._constant}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}}],[{key:"createByConstant",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=new StartFrame;return t._type=0,t._constant=e,t}},{key:"createByRandomTwoConstant",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=new StartFrame;return r._type=1,r._constantMin=e,r._constantMax=t,r}}]),StartFrame}(),Ur=function(){function TextureSheetAnimation(e,t){_classCallCheck(this,TextureSheetAnimation),this.type=0,this.randomRow=!1,this.rowIndex=0,this.cycles=0,this.enableUVChannels=0,this.enable=!1,this.tiles=new n(1,1),this.type=0,this.randomRow=!0,this.rowIndex=0,this.cycles=1,this.enableUVChannels=1,this._frame=e,this._startFrame=t}return _createClass(TextureSheetAnimation,[{key:"cloneTo",value:function(e){var t=e;this.tiles.cloneTo(t.tiles),t.type=this.type,t.randomRow=this.randomRow,t.rowIndex=this.rowIndex,t.cycles=this.cycles,t.enableUVChannels=this.enableUVChannels,t.enable=this.enable,this._frame.cloneTo(t._frame),this._startFrame.cloneTo(t._startFrame)}},{key:"clone",value:function(){var e,t;switch(this._frame.type){case 0:e=Cr.createByConstant(this._frame.constant);break;case 1:e=Cr.createByOverTime(this._frame.frameOverTimeData.clone());break;case 2:e=Cr.createByRandomTwoConstant(this._frame.constantMin,this._frame.constantMax);break;case 3:e=Cr.createByRandomTwoOverTime(this._frame.frameOverTimeDataMin.clone(),this._frame.frameOverTimeDataMax.clone())}switch(this._startFrame.type){case 0:t=Fr.createByConstant(this._startFrame.constant);break;case 1:t=Fr.createByRandomTwoConstant(this._startFrame.constantMin,this._startFrame.constantMax)}var r=new TextureSheetAnimation(e,t);return this.cloneTo(r),r}},{key:"frame",get:function(){return this._frame}},{key:"startFrame",get:function(){return this._startFrame}}]),TextureSheetAnimation}(),Gr=function(){function VelocityOverLifetime(e){_classCallCheck(this,VelocityOverLifetime),this.enable=!1,this.space=0,this._velocity=e}return _createClass(VelocityOverLifetime,[{key:"cloneTo",value:function(e){var t=e;this._velocity.cloneTo(t._velocity),t.enable=this.enable,t.space=this.space}},{key:"clone",value:function(){var e;switch(this._velocity.type){case 0:e=Ir.createByConstant(this._velocity.constant.clone());break;case 1:e=Ir.createByGradient(this._velocity.gradientX.clone(),this._velocity.gradientY.clone(),this._velocity.gradientZ.clone());break;case 2:e=Ir.createByRandomTwoConstant(this._velocity.constantMin.clone(),this._velocity.constantMax.clone());break;case 3:e=Ir.createByRandomTwoGradient(this._velocity.gradientXMin.clone(),this._velocity.gradientYMin.clone(),this._velocity.gradientZMin.clone(),this._velocity.gradientXMax.clone(),this._velocity.gradientYMax.clone(),this._velocity.gradientZMax.clone())}var t=new VelocityOverLifetime(e);return t.enable=this.enable,t.space=this.space,t}},{key:"velocity",get:function(){return this._velocity}}]),VelocityOverLifetime}(),zr=function ShuriKenParticle3DShaderDeclaration(){_classCallCheck(this,ShuriKenParticle3DShaderDeclaration)};zr.WORLDPOSITION=ue.propertyNameToID("u_WorldPosition"),zr.WORLDROTATION=ue.propertyNameToID("u_WorldRotation"),zr.POSITIONSCALE=ue.propertyNameToID("u_PositionScale"),zr.SIZESCALE=ue.propertyNameToID("u_SizeScale"),zr.SCALINGMODE=ue.propertyNameToID("u_ScalingMode"),zr.GRAVITY=ue.propertyNameToID("u_Gravity"),zr.THREEDSTARTROTATION=ue.propertyNameToID("u_ThreeDStartRotation"),zr.STRETCHEDBILLBOARDLENGTHSCALE=ue.propertyNameToID("u_StretchedBillboardLengthScale"),zr.STRETCHEDBILLBOARDSPEEDSCALE=ue.propertyNameToID("u_StretchedBillboardSpeedScale"),zr.SIMULATIONSPACE=ue.propertyNameToID("u_SimulationSpace"),zr.CURRENTTIME=ue.propertyNameToID("u_CurrentTime"),zr.VOLVELOCITYCONST=ue.propertyNameToID("u_VOLVelocityConst"),zr.VOLVELOCITYGRADIENTX=ue.propertyNameToID("u_VOLVelocityGradientX"),zr.VOLVELOCITYGRADIENTY=ue.propertyNameToID("u_VOLVelocityGradientY"),zr.VOLVELOCITYGRADIENTZ=ue.propertyNameToID("u_VOLVelocityGradientZ"),zr.VOLVELOCITYCONSTMAX=ue.propertyNameToID("u_VOLVelocityConstMax"),zr.VOLVELOCITYGRADIENTXMAX=ue.propertyNameToID("u_VOLVelocityGradientMaxX"),zr.VOLVELOCITYGRADIENTYMAX=ue.propertyNameToID("u_VOLVelocityGradientMaxY"),zr.VOLVELOCITYGRADIENTZMAX=ue.propertyNameToID("u_VOLVelocityGradientMaxZ"),zr.VOLSPACETYPE=ue.propertyNameToID("u_VOLSpaceType"),zr.COLOROVERLIFEGRADIENTALPHAS=ue.propertyNameToID("u_ColorOverLifeGradientAlphas"),zr.COLOROVERLIFEGRADIENTCOLORS=ue.propertyNameToID("u_ColorOverLifeGradientColors"),zr.MAXCOLOROVERLIFEGRADIENTALPHAS=ue.propertyNameToID("u_MaxColorOverLifeGradientAlphas"),zr.MAXCOLOROVERLIFEGRADIENTCOLORS=ue.propertyNameToID("u_MaxColorOverLifeGradientColors"),zr.SOLSIZEGRADIENT=ue.propertyNameToID("u_SOLSizeGradient"),zr.SOLSIZEGRADIENTX=ue.propertyNameToID("u_SOLSizeGradientX"),zr.SOLSIZEGRADIENTY=ue.propertyNameToID("u_SOLSizeGradientY"),zr.SOLSizeGradientZ=ue.propertyNameToID("u_SOLSizeGradientZ"),zr.SOLSizeGradientMax=ue.propertyNameToID("u_SOLSizeGradientMax"),zr.SOLSIZEGRADIENTXMAX=ue.propertyNameToID("u_SOLSizeGradientMaxX"),zr.SOLSIZEGRADIENTYMAX=ue.propertyNameToID("u_SOLSizeGradientMaxY"),zr.SOLSizeGradientZMAX=ue.propertyNameToID("u_SOLSizeGradientMaxZ"),zr.ROLANGULARVELOCITYCONST=ue.propertyNameToID("u_ROLAngularVelocityConst"),zr.ROLANGULARVELOCITYCONSTSEPRARATE=ue.propertyNameToID("u_ROLAngularVelocityConstSeprarate"),zr.ROLANGULARVELOCITYGRADIENT=ue.propertyNameToID("u_ROLAngularVelocityGradient"),zr.ROLANGULARVELOCITYGRADIENTX=ue.propertyNameToID("u_ROLAngularVelocityGradientX"),zr.ROLANGULARVELOCITYGRADIENTY=ue.propertyNameToID("u_ROLAngularVelocityGradientY"),zr.ROLANGULARVELOCITYGRADIENTZ=ue.propertyNameToID("u_ROLAngularVelocityGradientZ"),zr.ROLANGULARVELOCITYCONSTMAX=ue.propertyNameToID("u_ROLAngularVelocityConstMax"),zr.ROLANGULARVELOCITYCONSTMAXSEPRARATE=ue.propertyNameToID("u_ROLAngularVelocityConstMaxSeprarate"),zr.ROLANGULARVELOCITYGRADIENTMAX=ue.propertyNameToID("u_ROLAngularVelocityGradientMax"),zr.ROLANGULARVELOCITYGRADIENTXMAX=ue.propertyNameToID("u_ROLAngularVelocityGradientMaxX"),zr.ROLANGULARVELOCITYGRADIENTYMAX=ue.propertyNameToID("u_ROLAngularVelocityGradientMaxY"),zr.ROLANGULARVELOCITYGRADIENTZMAX=ue.propertyNameToID("u_ROLAngularVelocityGradientMaxZ"),zr.ROLANGULARVELOCITYGRADIENTWMAX=ue.propertyNameToID("u_ROLAngularVelocityGradientMaxW"),zr.TEXTURESHEETANIMATIONCYCLES=ue.propertyNameToID("u_TSACycles"),zr.TEXTURESHEETANIMATIONSUBUVLENGTH=ue.propertyNameToID("u_TSASubUVLength"),zr.TEXTURESHEETANIMATIONGRADIENTUVS=ue.propertyNameToID("u_TSAGradientUVs"),zr.TEXTURESHEETANIMATIONGRADIENTMAXUVS=ue.propertyNameToID("u_TSAMaxGradientUVs");var Hr=function(e){function ShurikenParticleMaterial(){var e;return _classCallCheck(this,ShurikenParticleMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(ShurikenParticleMaterial).call(this))).setShaderName("PARTICLESHURIKEN"),e._color=new i(1,1,1,1),e.renderMode=ShurikenParticleMaterial.RENDERMODE_ALPHABLENDED,e}return _inherits(ShurikenParticleMaterial,e),_createClass(ShurikenParticleMaterial,[{key:"clone",value:function(){var e=new ShurikenParticleMaterial;return this.cloneTo(e),e}},{key:"_TintColor",get:function(){return this.color},set:function(e){this.color=e}},{key:"_TintColorR",get:function(){return this._color.x},set:function(e){this._color.x=e,this.color=this._color}},{key:"_TintColorG",get:function(){return this._color.y},set:function(e){this._color.y=e,this.color=this._color}},{key:"_TintColorB",get:function(){return this._color.z},set:function(e){this._color.z=e,this.color=this._color}},{key:"_TintColorA",get:function(){return this._color.w},set:function(e){this._color.w=e,this.color=this._color}},{key:"_MainTex_ST",get:function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET)},set:function(e){var t=this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET);t.setValue(e.x,e.y,e.z,e.w),this.tilingOffset=t}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET).x},set:function(e){var t=this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET);t.x=e,this.tilingOffset=t}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET).y},set:function(e){var t=this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET);t.y=e,this.tilingOffset=t}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET).z},set:function(e){var t=this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET);t.z=e,this.tilingOffset=t}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET).w},set:function(e){var t=this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET);t.w=e,this.tilingOffset=t}},{key:"renderMode",set:function(e){switch(e){case ShurikenParticleMaterial.RENDERMODE_ADDTIVE:this.renderQueue=me.RENDERQUEUE_TRANSPARENT,this.depthWrite=!1,this.cull=pe.CULL_NONE,this.blend=pe.BLEND_ENABLE_ALL,this.blendSrc=pe.BLENDPARAM_SRC_ALPHA,this.blendDst=pe.BLENDPARAM_ONE,this.alphaTest=!1,this._shaderValues.addDefine(ShurikenParticleMaterial.SHADERDEFINE_ADDTIVEFOG);break;case ShurikenParticleMaterial.RENDERMODE_ALPHABLENDED:this.renderQueue=me.RENDERQUEUE_TRANSPARENT,this.depthWrite=!1,this.cull=pe.CULL_NONE,this.blend=pe.BLEND_ENABLE_ALL,this.blendSrc=pe.BLENDPARAM_SRC_ALPHA,this.blendDst=pe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.alphaTest=!1,this._shaderValues.removeDefine(ShurikenParticleMaterial.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("ShurikenParticleMaterial : renderMode value error.")}}},{key:"colorR",get:function(){return this._TintColorR},set:function(e){this._TintColorR=e}},{key:"colorG",get:function(){return this._TintColorG},set:function(e){this._TintColorG=e}},{key:"colorB",get:function(){return this._TintColorB},set:function(e){this._TintColorB=e}},{key:"colorA",get:function(){return this._TintColorA},set:function(e){this._TintColorA=e}},{key:"color",get:function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TINTCOLOR)},set:function(e){e?this._shaderValues.addDefine(ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR):this._shaderValues.removeDefine(ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR),this._shaderValues.setVector(ShurikenParticleMaterial.TINTCOLOR,e)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET)},set:function(e){e&&(1!=e.x||1!=e.y||0!=e.z||0!=e.w)?this._shaderValues.addDefine(ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(ShurikenParticleMaterial.TILINGOFFSET,e)}},{key:"texture",get:function(){return this._shaderValues.getTexture(ShurikenParticleMaterial.DIFFUSETEXTURE)},set:function(e){e?this._shaderValues.addDefine(ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP):this._shaderValues.removeDefine(ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP),this._shaderValues.setTexture(ShurikenParticleMaterial.DIFFUSETEXTURE,e)}},{key:"depthWrite",get:function(){return this._shaderValues.getBool(ShurikenParticleMaterial.DEPTH_WRITE)},set:function(e){this._shaderValues.setBool(ShurikenParticleMaterial.DEPTH_WRITE,e)}},{key:"cull",get:function(){return this._shaderValues.getInt(ShurikenParticleMaterial.CULL)},set:function(e){this._shaderValues.setInt(ShurikenParticleMaterial.CULL,e)}},{key:"blend",get:function(){return this._shaderValues.getInt(ShurikenParticleMaterial.BLEND)},set:function(e){this._shaderValues.setInt(ShurikenParticleMaterial.BLEND,e)}},{key:"blendSrc",get:function(){return this._shaderValues.getInt(ShurikenParticleMaterial.BLEND_SRC)},set:function(e){this._shaderValues.setInt(ShurikenParticleMaterial.BLEND_SRC,e)}},{key:"blendDst",get:function(){return this._shaderValues.getInt(ShurikenParticleMaterial.BLEND_DST)},set:function(e){this._shaderValues.setInt(ShurikenParticleMaterial.BLEND_DST,e)}},{key:"depthTest",get:function(){return this._shaderValues.getInt(ShurikenParticleMaterial.DEPTH_TEST)},set:function(e){this._shaderValues.setInt(ShurikenParticleMaterial.DEPTH_TEST,e)}}],[{key:"__initDefine__",value:function(){ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP=ue.getDefineByName("DIFFUSEMAP"),ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR=ue.getDefineByName("TINTCOLOR"),ShurikenParticleMaterial.SHADERDEFINE_ADDTIVEFOG=ue.getDefineByName("ADDTIVEFOG"),ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET=ue.getDefineByName("TILINGOFFSET")}}]),ShurikenParticleMaterial}(me);Hr.RENDERMODE_ALPHABLENDED=0,Hr.RENDERMODE_ADDTIVE=1,Hr.DIFFUSETEXTURE=ue.propertyNameToID("u_texture"),Hr.TINTCOLOR=ue.propertyNameToID("u_Tintcolor"),Hr.TILINGOFFSET=ue.propertyNameToID("u_TilingOffset"),Hr.CULL=ue.propertyNameToID("s_Cull"),Hr.BLEND=ue.propertyNameToID("s_Blend"),Hr.BLEND_SRC=ue.propertyNameToID("s_BlendSrc"),Hr.BLEND_DST=ue.propertyNameToID("s_BlendDst"),Hr.DEPTH_TEST=ue.propertyNameToID("s_DepthTest"),Hr.DEPTH_WRITE=ue.propertyNameToID("s_DepthWrite");var Wr=function(e){function ShurikenParticleRenderer(e){var t;return _classCallCheck(this,ShurikenParticleRenderer),(t=_possibleConstructorReturn(this,_getPrototypeOf(ShurikenParticleRenderer).call(this,e)))._finalGravity=new o,t._tempRotationMatrix=new c,t._mesh=null,t.stretchedBillboardCameraSpeedScale=0,t.stretchedBillboardSpeedScale=0,t.stretchedBillboardLengthScale=2,t._defaultBoundBox=new xt(new o,new o),t.renderMode=0,t._supportOctree=!1,t}return _inherits(ShurikenParticleRenderer,e),_createClass(ShurikenParticleRenderer,[{key:"_calculateBoundingBox",value:function(){var e=this._owner.particleSystem;if(e._useCustomBounds)e.customBounds._tranform(this._owner.transform.worldMatrix,this._bounds);else if(e._simulationSupported()){if(e._generateBounds(),e._bounds._tranform(this._owner.transform.worldMatrix,this._bounds),0!=e.gravityModifier){var t=this._bounds.getMax(),r=this._bounds.getMin(),n=e._gravityOffset;t.y-=n.x,r.y-=n.y,this._bounds.setMax(t),this._bounds.setMin(r)}}else{(r=this._bounds.getMin()).setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._bounds.setMin(r),(t=this._bounds.getMax()).setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._bounds.setMax(t)}}},{key:"_needRender",value:function(e,t){return!e||!!e.intersects(this.bounds._getBoundBox())&&!!this._owner.particleSystem.isAlive}},{key:"_renderUpdate",value:function(e,t){var r=this._owner.particleSystem,n=this._shaderValues,i=this._owner.transform;switch(r.simulationSpace){case 0:break;case 1:n.setVector3(zr.WORLDPOSITION,i.position),n.setQuaternion(zr.WORLDROTATION,i.rotation);break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}switch(r.scaleMode){case 0:var a=i.getWorldLossyScale();n.setVector3(zr.POSITIONSCALE,a),n.setVector3(zr.SIZESCALE,a);break;case 1:var s=i.localScale;n.setVector3(zr.POSITIONSCALE,s),n.setVector3(zr.SIZESCALE,s);break;case 2:n.setVector3(zr.POSITIONSCALE,i.getWorldLossyScale()),n.setVector3(zr.SIZESCALE,o._ONE)}o.scale(m.gravity,r.gravityModifier,this._finalGravity),n.setVector3(zr.GRAVITY,this._finalGravity),n.setInt(zr.SIMULATIONSPACE,r.simulationSpace),n.setBool(zr.THREEDSTARTROTATION,r.threeDStartRotation),n.setInt(zr.SCALINGMODE,r.scaleMode),n.setNumber(zr.STRETCHEDBILLBOARDLENGTHSCALE,this.stretchedBillboardLengthScale),n.setNumber(zr.STRETCHEDBILLBOARDSPEEDSCALE,this.stretchedBillboardSpeedScale),n.setNumber(zr.CURRENTTIME,r._currentTime)}},{key:"_destroy",value:function(){_get(_getPrototypeOf(ShurikenParticleRenderer.prototype),"_destroy",this).call(this),this._mesh&&(this._mesh._removeReference(),this._mesh=null)}},{key:"renderMode",get:function(){return this._renderMode},set:function(e){if(this._renderMode!==e){var t=this._shaderValues;switch(this._renderMode){case 0:t.removeDefine(zr.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:t.removeDefine(zr.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:t.removeDefine(zr.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:t.removeDefine(zr.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:t.removeDefine(zr.SHADERDEFINE_RENDERMODE_MESH)}switch(this._renderMode=e,e){case 0:t.addDefine(zr.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:t.addDefine(zr.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:t.addDefine(zr.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:t.addDefine(zr.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:t.addDefine(zr.SHADERDEFINE_RENDERMODE_MESH);break;default:throw new Error("ShurikenParticleRender: unknown renderMode Value.")}var r=this._owner.particleSystem;r&&r._initBufferDatas()}}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh!==e&&(this._mesh&&this._mesh._removeReference(),this._mesh=e,e&&e._addReference(),this._owner.particleSystem._initBufferDatas())}},{key:"bounds",get:function(){return this._boundsChange&&(this._calculateBoundingBox(),this._boundsChange=!1),this._bounds}}]),ShurikenParticleRenderer}(Ut),Xr=function VertexShuriKenParticle(){_classCallCheck(this,VertexShuriKenParticle)};Xr.PARTICLE_CORNERTEXTURECOORDINATE0=5,Xr.PARTICLE_POSITION0=1,Xr.PARTICLE_COLOR0=2,Xr.PARTICLE_TEXTURECOORDINATE0=3,Xr.PARTICLE_SHAPEPOSITIONSTARTLIFETIME=4,Xr.PARTICLE_DIRECTIONTIME=0,Xr.PARTICLE_STARTCOLOR0=6,Xr.PARTICLE_ENDCOLOR0=7,Xr.PARTICLE_STARTSIZE=8,Xr.PARTICLE_STARTROTATION=9,Xr.PARTICLE_STARTSPEED=10,Xr.PARTICLE_RANDOM0=11,Xr.PARTICLE_RANDOM1=12,Xr.PARTICLE_SIMULATIONWORLDPOSTION=13,Xr.PARTICLE_SIMULATIONWORLDROTATION=14;var Yr=function(e){function VertexShurikenParticleBillboard(e,t,r,n,i,a,o,s,l,u,c,h,_,d){var f;return _classCallCheck(this,VertexShurikenParticleBillboard),(f=_possibleConstructorReturn(this,_getPrototypeOf(VertexShurikenParticleBillboard).call(this)))._cornerTextureCoordinate=e,f._positionStartLifeTime=t,f._velocity=r,f._startColor=n,f._startSize=i,f._startRotation0=a,f._startRotation1=o,f._startRotation2=s,f._startLifeTime=l,f._time=u,f._startSpeed=c,f._randoms0=f.random0,f._randoms1=f.random1,f._simulationWorldPostion=d,f}return _inherits(VertexShurikenParticleBillboard,e),_createClass(VertexShurikenParticleBillboard,[{key:"cornerTextureCoordinate",get:function(){return this._cornerTextureCoordinate}},{key:"positionStartLifeTime",get:function(){return this._positionStartLifeTime}},{key:"velocity",get:function(){return this._velocity}},{key:"startColor",get:function(){return this._startColor}},{key:"startSize",get:function(){return this._startSize}},{key:"startRotation0",get:function(){return this._startRotation0}},{key:"startRotation1",get:function(){return this._startRotation1}},{key:"startRotation2",get:function(){return this._startRotation2}},{key:"startLifeTime",get:function(){return this._startLifeTime}},{key:"time",get:function(){return this._time}},{key:"startSpeed",get:function(){return this._startSpeed}},{key:"random0",get:function(){return this._randoms0}},{key:"random1",get:function(){return this._randoms1}},{key:"simulationWorldPostion",get:function(){return this._simulationWorldPostion}}],[{key:"__init__",value:function(){VertexShurikenParticleBillboard._vertexDeclaration=new je(152,[new Ze(0,Ye.Vector4,Xr.PARTICLE_CORNERTEXTURECOORDINATE0),new Ze(16,Ye.Vector4,Xr.PARTICLE_SHAPEPOSITIONSTARTLIFETIME),new Ze(32,Ye.Vector4,Xr.PARTICLE_DIRECTIONTIME),new Ze(48,Ye.Vector4,Xr.PARTICLE_STARTCOLOR0),new Ze(64,Ye.Vector3,Xr.PARTICLE_STARTSIZE),new Ze(76,Ye.Vector3,Xr.PARTICLE_STARTROTATION),new Ze(88,Ye.Single,Xr.PARTICLE_STARTSPEED),new Ze(92,Ye.Vector4,Xr.PARTICLE_RANDOM0),new Ze(108,Ye.Vector4,Xr.PARTICLE_RANDOM1),new Ze(124,Ye.Vector3,Xr.PARTICLE_SIMULATIONWORLDPOSTION),new Ze(136,Ye.Vector4,Xr.PARTICLE_SIMULATIONWORLDROTATION)])}},{key:"vertexDeclaration",get:function(){return VertexShurikenParticleBillboard._vertexDeclaration}}]),VertexShurikenParticleBillboard}(Xr),jr=function(e){function VertexShurikenParticleMesh(e,t,r,n,i,a,o,s,l,u,c,h,_,d){var f;return _classCallCheck(this,VertexShurikenParticleMesh),(f=_possibleConstructorReturn(this,_getPrototypeOf(VertexShurikenParticleMesh).call(this)))._cornerTextureCoordinate=e,f._positionStartLifeTime=t,f._velocity=r,f._startColor=n,f._startSize=i,f._startRotation0=a,f._startRotation1=o,f._startRotation2=s,f._startLifeTime=l,f._time=u,f._startSpeed=c,f._randoms0=f.random0,f._randoms1=f.random1,f._simulationWorldPostion=d,f}return _inherits(VertexShurikenParticleMesh,e),_createClass(VertexShurikenParticleMesh,[{key:"cornerTextureCoordinate",get:function(){return this._cornerTextureCoordinate}},{key:"position",get:function(){return this._positionStartLifeTime}},{key:"velocity",get:function(){return this._velocity}},{key:"startColor",get:function(){return this._startColor}},{key:"startSize",get:function(){return this._startSize}},{key:"startRotation0",get:function(){return this._startRotation0}},{key:"startRotation1",get:function(){return this._startRotation1}},{key:"startRotation2",get:function(){return this._startRotation2}},{key:"startLifeTime",get:function(){return this._startLifeTime}},{key:"time",get:function(){return this._time}},{key:"startSpeed",get:function(){return this._startSpeed}},{key:"random0",get:function(){return this._randoms0}},{key:"random1",get:function(){return this._randoms1}},{key:"simulationWorldPostion",get:function(){return this._simulationWorldPostion}}],[{key:"__init__",value:function(){VertexShurikenParticleMesh._vertexDeclaration=new je(172,[new Ze(0,Ye.Vector3,Xr.PARTICLE_POSITION0),new Ze(12,Ye.Vector4,Xr.PARTICLE_COLOR0),new Ze(28,Ye.Vector2,Xr.PARTICLE_TEXTURECOORDINATE0),new Ze(36,Ye.Vector4,Xr.PARTICLE_SHAPEPOSITIONSTARTLIFETIME),new Ze(52,Ye.Vector4,Xr.PARTICLE_DIRECTIONTIME),new Ze(68,Ye.Vector4,Xr.PARTICLE_STARTCOLOR0),new Ze(84,Ye.Vector3,Xr.PARTICLE_STARTSIZE),new Ze(96,Ye.Vector3,Xr.PARTICLE_STARTROTATION),new Ze(108,Ye.Single,Xr.PARTICLE_STARTSPEED),new Ze(112,Ye.Vector4,Xr.PARTICLE_RANDOM0),new Ze(128,Ye.Vector4,Xr.PARTICLE_RANDOM1),new Ze(144,Ye.Vector3,Xr.PARTICLE_SIMULATIONWORLDPOSTION),new Ze(156,Ye.Vector4,Xr.PARTICLE_SIMULATIONWORLDROTATION)])}},{key:"vertexDeclaration",get:function(){return VertexShurikenParticleMesh._vertexDeclaration}}]),VertexShurikenParticleMesh}(Xr),Zr=function(){function Rand(e){_classCallCheck(this,Rand),this._temp=new Uint32Array(1),this.seeds=new Uint32Array(4),this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}return _createClass(Rand,[{key:"getUint",value:function(){return this._temp[0]=this.seeds[0]^this.seeds[0]<<11,this.seeds[0]=this.seeds[1],this.seeds[1]=this.seeds[2],this.seeds[2]=this.seeds[3],this.seeds[3]=this.seeds[3]^this.seeds[3]>>>19^this._temp[0]^this._temp[0]>>>8,this.seeds[3]}},{key:"getFloat",value:function(){return this.getUint(),(8388607&this.seeds[3])*(1/8388607)}},{key:"getSignedFloat",value:function(){return 2*this.getFloat()-1}},{key:"seed",get:function(){return this.seeds[0]},set:function(e){this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}}],[{key:"getFloatFromInt",value:function(e){return 1/8388607*(8388607&e)}},{key:"getByteFromInt",value:function(e){return(8388607&e)>>>15}}]),Rand}(),Qr=function(){function Emission(){_classCallCheck(this,Emission),this._emissionRate=10,this._destroyed=!1,this._bursts=[]}return _createClass(Emission,[{key:"destroy",value:function(){this._bursts=null,this._destroyed=!0}},{key:"getBurstsCount",value:function(){return this._bursts.length}},{key:"getBurstByIndex",value:function(e){return this._bursts[e]}},{key:"addBurst",value:function(e){var t=this._bursts.length;if(t>0)for(var r=0;r<t;r++)this._bursts[r].time>e.time&&this._bursts.splice(r,0,e);this._bursts.push(e)}},{key:"removeBurst",value:function(e){var t=this._bursts.indexOf(e);-1!==t&&this._bursts.splice(t,1)}},{key:"removeBurstByIndex",value:function(e){this._bursts.splice(e,1)}},{key:"clearBurst",value:function(){this._bursts.length=0}},{key:"cloneTo",value:function(e){var t=e,r=t._bursts;r.length=this._bursts.length;for(var n=0,i=this._bursts.length;n<i;n++){var a=r[n];a?this._bursts[n].cloneTo(a):r[n]=this._bursts[n].clone()}t._emissionRate=this._emissionRate,t.enable=this.enable}},{key:"clone",value:function(){var e=new Emission;return this.cloneTo(e),e}},{key:"emissionRate",set:function(e){if(e<0)throw new Error("ParticleBaseShape:emissionRate value must large or equal than 0.");this._emissionRate=e},get:function(){return this._emissionRate}},{key:"destroyed",get:function(){return this._destroyed}}]),Emission}(),qr=function(){function ShurikenParticleData(){_classCallCheck(this,ShurikenParticleData)}return _createClass(ShurikenParticleData,null,[{key:"_getStartLifetimeFromGradient",value:function(e,r){for(var n=1,i=e.gradientCount;n<i;n++){var a=e.getKeyByIndex(n);if(a>=r){var o=e.getKeyByIndex(n-1),s=(r-o)/(a-o);return t.MathUtil.lerp(e.getValueByIndex(n-1),e.getValueByIndex(n),s)}}throw new Error("ShurikenParticleData: can't get value foam startLifeTimeGradient.")}},{key:"_randomInvertRoationArray",value:function(e,t,r,n,i){var a;n?(n.seed=i[6],a=n.getFloat(),i[6]=n.seed):a=Math.random(),a<r?(t.x=-e.x,t.y=-e.y,t.z=-e.z):(t.x=e.x,t.y=e.y,t.z=e.z)}},{key:"_randomInvertRoation",value:function(e,t,r,n){var i;return r?(r.seed=n[6],i=r.getFloat(),n[6]=r.seed):i=Math.random(),i<t&&(e=-e),e}},{key:"create",value:function(e,r,n){var a=e.autoRandomSeed,o=e._rand,s=e._randomSeeds;switch(e.startColorType){case 0:var l=e.startColorConstant;ShurikenParticleData.startColor.x=l.x,ShurikenParticleData.startColor.y=l.y,ShurikenParticleData.startColor.z=l.z,ShurikenParticleData.startColor.w=l.w;break;case 2:a?i.lerp(e.startColorConstantMin,e.startColorConstantMax,Math.random(),ShurikenParticleData.startColor):(o.seed=s[3],i.lerp(e.startColorConstantMin,e.startColorConstantMax,o.getFloat(),ShurikenParticleData.startColor),s[3]=o.seed)}var u=e.colorOverLifetime;if(u&&u.enable){var c=u.color;switch(c.type){case 0:ShurikenParticleData.startColor.x=ShurikenParticleData.startColor.x*c.constant.x,ShurikenParticleData.startColor.y=ShurikenParticleData.startColor.y*c.constant.y,ShurikenParticleData.startColor.z=ShurikenParticleData.startColor.z*c.constant.z,ShurikenParticleData.startColor.w=ShurikenParticleData.startColor.w*c.constant.w;break;case 2:var h;a?h=Math.random():(o.seed=s[10],h=o.getFloat(),s[10]=o.seed);var _=c.constantMin,d=c.constantMax;ShurikenParticleData.startColor.x=ShurikenParticleData.startColor.x*t.MathUtil.lerp(_.x,d.x,h),ShurikenParticleData.startColor.y=ShurikenParticleData.startColor.y*t.MathUtil.lerp(_.y,d.y,h),ShurikenParticleData.startColor.z=ShurikenParticleData.startColor.z*t.MathUtil.lerp(_.z,d.z,h),ShurikenParticleData.startColor.w=ShurikenParticleData.startColor.w*t.MathUtil.lerp(_.w,d.w,h)}}var f=ShurikenParticleData.startSize;switch(e.startSizeType){case 0:if(e.threeDStartSize){var m=e.startSizeConstantSeparate;f[0]=m.x,f[1]=m.y,f[2]=m.z}else f[0]=f[1]=f[2]=e.startSizeConstant;break;case 2:if(e.threeDStartSize){var T=e.startSizeConstantMinSeparate,p=e.startSizeConstantMaxSeparate;a?(f[0]=t.MathUtil.lerp(T.x,p.x,Math.random()),f[1]=t.MathUtil.lerp(T.y,p.y,Math.random()),f[2]=t.MathUtil.lerp(T.z,p.z,Math.random())):(o.seed=s[4],f[0]=t.MathUtil.lerp(T.x,p.x,o.getFloat()),f[1]=t.MathUtil.lerp(T.y,p.y,o.getFloat()),f[2]=t.MathUtil.lerp(T.z,p.z,o.getFloat()),s[4]=o.seed)}else a?f[0]=f[1]=f[2]=t.MathUtil.lerp(e.startSizeConstantMin,e.startSizeConstantMax,Math.random()):(o.seed=s[4],f[0]=f[1]=f[2]=t.MathUtil.lerp(e.startSizeConstantMin,e.startSizeConstantMax,o.getFloat()),s[4]=o.seed)}var g=e.sizeOverLifetime;if(g&&g.enable&&1===g.size.type){var E,y=g.size;if(y.separateAxes)a?(f[0]=f[0]*t.MathUtil.lerp(y.constantMinSeparate.x,y.constantMaxSeparate.x,Math.random()),f[1]=f[1]*t.MathUtil.lerp(y.constantMinSeparate.y,y.constantMaxSeparate.y,Math.random()),f[2]=f[2]*t.MathUtil.lerp(y.constantMinSeparate.z,y.constantMaxSeparate.z,Math.random())):(o.seed=s[11],f[0]=f[0]*t.MathUtil.lerp(y.constantMinSeparate.x,y.constantMaxSeparate.x,o.getFloat()),f[1]=f[1]*t.MathUtil.lerp(y.constantMinSeparate.y,y.constantMaxSeparate.y,o.getFloat()),f[2]=f[2]*t.MathUtil.lerp(y.constantMinSeparate.z,y.constantMaxSeparate.z,o.getFloat()),s[11]=o.seed);else a?E=t.MathUtil.lerp(y.constantMin,y.constantMax,Math.random()):(o.seed=s[11],E=t.MathUtil.lerp(y.constantMin,y.constantMax,o.getFloat()),s[11]=o.seed),f[0]=f[0]*E,f[1]=f[1]*E,f[2]=f[2]*E}var S=r.renderMode;if(1!==S)switch(e.startRotationType){case 0:if(e.threeDStartRotation){var v=e.startRotationConstantSeparate,R=ShurikenParticleData._tempVector30;ShurikenParticleData._randomInvertRoationArray(v,R,e.randomizeRotationDirection,a?null:o,s),ShurikenParticleData.startRotation[0]=R.x,ShurikenParticleData.startRotation[1]=R.y,ShurikenParticleData.startRotation[2]=4!==S?-R.z:R.z}else ShurikenParticleData.startRotation[0]=ShurikenParticleData._randomInvertRoation(e.startRotationConstant,e.randomizeRotationDirection,a?null:o,s),ShurikenParticleData.startRotation[1]=0,ShurikenParticleData.startRotation[2]=0;break;case 2:if(e.threeDStartRotation){var C=e.startRotationConstantMinSeparate,M=e.startRotationConstantMaxSeparate,D=ShurikenParticleData._tempVector30;a?(D.x=t.MathUtil.lerp(C.x,M.x,Math.random()),D.y=t.MathUtil.lerp(C.y,M.y,Math.random()),D.z=t.MathUtil.lerp(C.z,M.z,Math.random())):(o.seed=s[5],D.x=t.MathUtil.lerp(C.x,M.x,o.getFloat()),D.y=t.MathUtil.lerp(C.y,M.y,o.getFloat()),D.z=t.MathUtil.lerp(C.z,M.z,o.getFloat()),s[5]=o.seed),ShurikenParticleData._randomInvertRoationArray(D,D,e.randomizeRotationDirection,a?null:o,s),ShurikenParticleData.startRotation[0]=D.x,ShurikenParticleData.startRotation[1]=D.y,ShurikenParticleData.startRotation[2]=4!==S?-D.z:D.z}else a?ShurikenParticleData.startRotation[0]=ShurikenParticleData._randomInvertRoation(t.MathUtil.lerp(e.startRotationConstantMin,e.startRotationConstantMax,Math.random()),e.randomizeRotationDirection,a?null:o,s):(o.seed=s[5],ShurikenParticleData.startRotation[0]=ShurikenParticleData._randomInvertRoation(t.MathUtil.lerp(e.startRotationConstantMin,e.startRotationConstantMax,o.getFloat()),e.randomizeRotationDirection,a?null:o,s),s[5]=o.seed)}switch(e.startLifetimeType){case 0:ShurikenParticleData.startLifeTime=e.startLifetimeConstant;break;case 1:ShurikenParticleData.startLifeTime=ShurikenParticleData._getStartLifetimeFromGradient(e.startLifeTimeGradient,e.emissionTime);break;case 2:a?ShurikenParticleData.startLifeTime=t.MathUtil.lerp(e.startLifetimeConstantMin,e.startLifetimeConstantMax,Math.random()):(o.seed=s[7],ShurikenParticleData.startLifeTime=t.MathUtil.lerp(e.startLifetimeConstantMin,e.startLifetimeConstantMax,o.getFloat()),s[7]=o.seed);break;case 3:var x=e.emissionTime;a?ShurikenParticleData.startLifeTime=t.MathUtil.lerp(ShurikenParticleData._getStartLifetimeFromGradient(e.startLifeTimeGradientMin,x),ShurikenParticleData._getStartLifetimeFromGradient(e.startLifeTimeGradientMax,x),Math.random()):(o.seed=s[7],ShurikenParticleData.startLifeTime=t.MathUtil.lerp(ShurikenParticleData._getStartLifetimeFromGradient(e.startLifeTimeGradientMin,x),ShurikenParticleData._getStartLifetimeFromGradient(e.startLifeTimeGradientMax,x),o.getFloat()),s[7]=o.seed)}var A=e.textureSheetAnimation;if(A&&A.enable){var I,L=A.tiles,P=L.x,O=L.y,N=1/P,b=1/O,k=A.startFrame;switch(k.type){case 0:I=k.constant;break;case 1:a?I=t.MathUtil.lerp(k.constantMin,k.constantMax,Math.random()):(o.seed=s[14],I=t.MathUtil.lerp(k.constantMin,k.constantMax,o.getFloat()),s[14]=o.seed)}var w=A.frame,B=A.cycles;switch(w.type){case 0:I+=w.constant*B;break;case 2:a?I+=t.MathUtil.lerp(w.constantMin,w.constantMax,Math.random())*B:(o.seed=s[15],I+=t.MathUtil.lerp(w.constantMin,w.constantMax,o.getFloat())*B,s[15]=o.seed)}var V=0;switch(A.type){case 0:V=Math.floor(I/P);break;case 1:A.randomRow?a?V=Math.floor(Math.random()*O):(o.seed=s[13],V=Math.floor(o.getFloat()*O),s[13]=o.seed):V=A.rowIndex}var F=Math.floor(I%P);ShurikenParticleData.startUVInfo=ShurikenParticleData.startUVInfo,ShurikenParticleData.startUVInfo[0]=N,ShurikenParticleData.startUVInfo[1]=b,ShurikenParticleData.startUVInfo[2]=F*N,ShurikenParticleData.startUVInfo[3]=V*b}else ShurikenParticleData.startUVInfo=ShurikenParticleData.startUVInfo,ShurikenParticleData.startUVInfo[0]=1,ShurikenParticleData.startUVInfo[1]=1,ShurikenParticleData.startUVInfo[2]=0,ShurikenParticleData.startUVInfo[3]=0}}]),ShurikenParticleData}();qr._tempVector30=new o,qr.startColor=new i,qr.startSize=new Float32Array(3),qr.startRotation=new Float32Array(3),qr.startUVInfo=new Float32Array(4);var Kr=function(r){function ShurikenParticleSystem(e){var t;return _classCallCheck(this,ShurikenParticleSystem),(t=_possibleConstructorReturn(this,_getPrototypeOf(ShurikenParticleSystem).call(this)))._boundingSphere=null,t._boundingBox=null,t._boundingBoxCorners=null,t._bounds=null,t._gravityOffset=new n,t._customBounds=null,t._useCustomBounds=!1,t._owner=null,t._ownerRender=null,t._vertices=null,t._floatCountPerVertex=0,t._startLifeTimeIndex=0,t._timeIndex=0,t._simulateUpdate=!1,t._firstActiveElement=0,t._firstNewElement=0,t._firstFreeElement=0,t._firstRetiredElement=0,t._drawCounter=0,t._bufferMaxParticles=0,t._emission=null,t._shape=null,t._isEmitting=!1,t._isPlaying=!1,t._isPaused=!1,t._playStartDelay=0,t._frameRateTime=0,t._emissionTime=0,t._totalDelayTime=0,t._burstsIndex=0,t._velocityOverLifetime=null,t._colorOverLifetime=null,t._sizeOverLifetime=null,t._rotationOverLifetime=null,t._textureSheetAnimation=null,t._startLifetimeType=0,t._startLifetimeConstant=0,t._startLifeTimeGradient=null,t._startLifetimeConstantMin=0,t._startLifetimeConstantMax=0,t._startLifeTimeGradientMin=null,t._startLifeTimeGradientMax=null,t._maxStartLifetime=0,t._uvLength=new n,t._vertexStride=0,t._indexStride=0,t._vertexBuffer=null,t._indexBuffer=null,t._bufferState=new We,t._updateMask=0,t._currentTime=0,t._startUpdateLoopCount=0,t._rand=null,t._randomSeeds=null,t.duration=0,t.looping=!1,t.prewarm=!1,t.startDelayType=0,t.startDelay=0,t.startDelayMin=0,t.startDelayMax=0,t.startSpeedType=0,t.startSpeedConstant=0,t.startSpeedConstantMin=0,t.startSpeedConstantMax=0,t.threeDStartSize=!1,t.startSizeType=0,t.startSizeConstant=0,t.startSizeConstantSeparate=null,t.startSizeConstantMin=0,t.startSizeConstantMax=0,t.startSizeConstantMinSeparate=null,t.startSizeConstantMaxSeparate=null,t.threeDStartRotation=!1,t.startRotationType=0,t.startRotationConstant=0,t.startRotationConstantSeparate=null,t.startRotationConstantMin=0,t.startRotationConstantMax=0,t.startRotationConstantMinSeparate=null,t.startRotationConstantMaxSeparate=null,t.randomizeRotationDirection=0,t.startColorType=0,t.startColorConstant=new i(1,1,1,1),t.startColorConstantMin=new i(0,0,0,0),t.startColorConstantMax=new i(1,1,1,1),t.gravityModifier=0,t.simulationSpace=0,t.simulationSpeed=1,t.scaleMode=1,t.playOnAwake=!1,t.randomSeed=null,t.autoRandomSeed=!1,t.isPerformanceMode=!1,t._firstActiveElement=0,t._firstNewElement=0,t._firstFreeElement=0,t._firstRetiredElement=0,t._owner=e,t._ownerRender=e.particleRenderer,t._boundingBoxCorners=[],t._boundingSphere=new Zt(new o,Number.MAX_VALUE),t._boundingBox=new xt(new o(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),new o(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)),t._bounds=new At(t._boundingBox.min,t._boundingBox.max),t._useCustomBounds=!1,t._currentTime=0,t._isEmitting=!1,t._isPlaying=!1,t._isPaused=!1,t._burstsIndex=0,t._frameRateTime=0,t._emissionTime=0,t._totalDelayTime=0,t._simulateUpdate=!1,t._bufferMaxParticles=1,t.duration=5,t.looping=!0,t.prewarm=!1,t.startDelayType=0,t.startDelay=0,t.startDelayMin=0,t.startDelayMax=0,t._startLifetimeType=0,t._startLifetimeConstant=5,t._startLifeTimeGradient=new xr,t._startLifetimeConstantMin=0,t._startLifetimeConstantMax=5,t._startLifeTimeGradientMin=new xr,t._startLifeTimeGradientMax=new xr,t._maxStartLifetime=5,t.startSpeedType=0,t.startSpeedConstant=5,t.startSpeedConstantMin=0,t.startSpeedConstantMax=5,t.threeDStartSize=!1,t.startSizeType=0,t.startSizeConstant=1,t.startSizeConstantSeparate=new o(1,1,1),t.startSizeConstantMin=0,t.startSizeConstantMax=1,t.startSizeConstantMinSeparate=new o(0,0,0),t.startSizeConstantMaxSeparate=new o(1,1,1),t.threeDStartRotation=!1,t.startRotationType=0,t.startRotationConstant=0,t.startRotationConstantSeparate=new o(0,0,0),t.startRotationConstantMin=0,t.startRotationConstantMax=0,t.startRotationConstantMinSeparate=new o(0,0,0),t.startRotationConstantMaxSeparate=new o(0,0,0),t.gravityModifier=0,t.simulationSpace=1,t.scaleMode=1,t.playOnAwake=!0,t._rand=new Zr(0),t.autoRandomSeed=!0,t.randomSeed=new Uint32Array(1),t._randomSeeds=new Uint32Array(ShurikenParticleSystem._RANDOMOFFSET.length),t.isPerformanceMode=!0,t._emission=new Qr,t._emission.enable=!0,t}return _inherits(ShurikenParticleSystem,r),_createClass(ShurikenParticleSystem,[{key:"_getVertexBuffer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return 0===e?this._vertexBuffer:null}},{key:"_getIndexBuffer",value:function(){return this._indexBuffer}},{key:"_generateBoundingSphere",value:function(){var e=this._boundingSphere.center;e.x=0,e.y=0,e.z=0,this._boundingSphere.radius=Number.MAX_VALUE}},{key:"_generateBoundingBox",value:function(){var e,t,r,n,i,a,s,l,u,c=this._owner.particleRenderer,h=this._boundingBox.min,_=this._boundingBox.max;switch(this.startLifetimeType){case 0:r=this.startLifetimeConstant;break;case 1:r=-Number.MAX_VALUE;var d=d;for(e=0,t=d.gradientCount;e<t;e++)r=Math.max(r,d.getValueByIndex(e));break;case 2:r=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:r=-Number.MAX_VALUE;var f=f;for(e=0,t=f.gradientCount;e<t;e++)r=Math.max(r,f.getValueByIndex(e));var m=m;for(e=0,t=m.gradientCount;e<t;e++)r=Math.max(r,m.getValueByIndex(e))}switch(this.startSpeedType){case 0:n=i=this.startSpeedConstant;break;case 1:break;case 2:n=this.startLifetimeConstantMin,i=this.startLifetimeConstantMax}this._shape&&this._shape.enable||(a=s=o._ZERO,l=o._ZERO,u=o._UnitZ);var T,p,g=new o(l.x*n,l.y*n,l.z*n),E=new o(u.x*i,u.y*i,u.z*i);if(this._velocityOverLifetime&&this._velocityOverLifetime.enable){var y=this._velocityOverLifetime.velocity;switch(y.type){case 0:y.constant;break;case 1:new o(y.gradientX.getAverageValue(),y.gradientY.getAverageValue(),y.gradientZ.getAverageValue());break;case 2:y.constantMin,y.constantMax;break;case 3:new o(y.gradientXMin.getAverageValue(),y.gradientYMin.getAverageValue(),y.gradientZMin.getAverageValue()),new o(y.gradientXMax.getAverageValue(),y.gradientYMax.getAverageValue(),y.gradientZMax.getAverageValue())}}var S,v,R,C,M=this._owner.transform,D=M.position,x=ShurikenParticleSystem._tempVector39,A=c.renderMode;switch(this.scaleMode){case 0:var I=M.getWorldLossyScale();T=I,x.x=I.x,x.y=I.z,x.z=I.y,1===A&&(p=I);break;case 1:var L=M.localScale;T=L,x.x=L.x,x.y=L.z,x.z=L.y,1===A&&(p=L);break;case 2:T=M.getWorldLossyScale(),x.x=x.y=x.z=1,1===A&&(p=o._ONE)}switch(this._velocityOverLifetime&&this._velocityOverLifetime.enable||(S=new o(g.x*r,g.y*r,g.z*r),v=new o(E.x*r,E.y*r,E.z*r),2!=this.scaleMode?(o.add(a,S,h),o.multiply(T,h,h),o.add(s,v,_),o.multiply(T,_,_)):(o.multiply(T,a,h),o.add(h,S,h),o.multiply(T,s,_),o.add(_,v,_))),this.simulationSpace){case 0:break;case 1:o.add(h,D,h),o.add(_,D,_)}switch(this.startSizeType){case 0:if(this.threeDStartSize){var P=P;R=Math.max(P.x,P.y),1===A&&(C=P.y)}else R=this.startSizeConstant,1===A&&(C=this.startSizeConstant);break;case 1:break;case 2:if(this.threeDStartSize){var O=O;R=Math.max(O.x,O.y),1===A&&(C=O.y)}else R=this.startSizeConstantMax,1===A&&(C=this.startSizeConstantMax)}if(this._sizeOverLifetime&&this._sizeOverLifetime.enable){this._sizeOverLifetime.size;R*=this._sizeOverLifetime.size.getMaxSizeInGradient()}var N,b,k=ShurikenParticleSystem._tempVector30;switch(A){case 0:N=R*ShurikenParticleSystem.halfKSqrtOf2,o.scale(x,R,k),o.subtract(h,k,h),o.add(_,k,_);break;case 1:var w=ShurikenParticleSystem._tempVector31,B=ShurikenParticleSystem._tempVector32,V=ShurikenParticleSystem._tempVector33,F=ShurikenParticleSystem._tempVector34;this._velocityOverLifetime&&this._velocityOverLifetime.enable||(o.multiply(p,E,B),o.multiply(p,g,V));var U=C*c.stretchedBillboardLengthScale,G=o.scalarLength(B)*c.stretchedBillboardSpeedScale+U,z=o.scalarLength(V)*c.stretchedBillboardSpeedScale+U,H=ShurikenParticleSystem._tempVector35,W=ShurikenParticleSystem._tempVector36;o.normalize(B,H),o.scale(H,G,F),o.subtract(v,F,F),o.normalize(V,W),o.scale(W,z,w),o.add(S,w,w),N=R*ShurikenParticleSystem.halfKSqrtOf2,o.scale(x,N,k);var X=ShurikenParticleSystem._tempVector37,Y=ShurikenParticleSystem._tempVector38;o.scale(H,.5,X),o.scale(W,.5,Y),o.multiply(X,x,X),o.multiply(Y,x,Y),o.add(h,Y,h),o.min(h,F,h),o.subtract(h,k,h),o.subtract(_,X,_),o.max(_,w,_),o.add(_,k,_);break;case 2:b=.5*(R*=Math.cos(.7853981633974483)),k.x=x.x*b,k.y=x.z*b,o.subtract(h,k,h),o.add(_,k,_);break;case 3:b=.5*(R*=Math.cos(.7853981633974483)),o.scale(x,b,k),o.subtract(h,k,h),o.add(_,k,_)}this._boundingBox.getCorners(this._boundingBoxCorners)}},{key:"_generateBounds",value:function(){var t=this._owner.particleRenderer,r=this._bounds.getMin(),n=this._bounds.getMax(),i=0;switch(this.startLifetimeType){case 0:i=this._startLifetimeConstant;break;case 2:i=this._startLifetimeConstantMax}var a=0;switch(this.startSpeedType){case 0:a=this.startSpeedConstant;break;case 2:a=this.startSpeedConstantMax}var s=0;if(this.threeDStartSize)switch(this.startSizeType){case 0:s=Math.max(this.startSizeConstantSeparate.x,this.startSizeConstantSeparate.y,this.startSizeConstantSeparate.z);break;case 2:s=Math.max(this.startSizeConstantMaxSeparate.x,this.startSizeConstantMaxSeparate.y,this.startSizeConstantMaxSeparate.z)}else switch(this.startSizeType){case 0:s=this.startSizeConstant;break;case 2:s=this.startSizeConstantMax}var l=ShurikenParticleSystem._tempVector30,u=ShurikenParticleSystem._tempVector31,c=ShurikenParticleSystem._tempVector32,h=ShurikenParticleSystem._tempVector33;if(l.setValue(0,0,1),u.setValue(0,0,0),c.setValue(0,0,0),h.setValue(0,0,0),this.shape&&this.shape.enable)switch(this.shape.shapeType){case e.ParticleSystemShapeType.Sphere:var _=this.shape;l.setValue(1,1,1),u.setValue(1,1,1),c.setValue(_.radius,_.radius,_.radius),h.setValue(_.radius,_.radius,_.radius);break;case e.ParticleSystemShapeType.Hemisphere:var d=this.shape;l.setValue(1,1,1),u.setValue(1,1,1),c.setValue(d.radius,d.radius,d.radius),h.setValue(d.radius,d.radius,0);break;case e.ParticleSystemShapeType.Cone:var f=this.shape;if(0==f.emitType||1==f.emitType){var m=f.angle,T=Math.sin(m);l.setValue(T,T,1),u.setValue(T,T,0),c.setValue(f.radius,f.radius,0),h.setValue(f.radius,f.radius,0);break}if(2==f.emitType||3==f.emitType){m=f.angle,T=Math.sin(m);var p=f.length;l.setValue(T,T,1),u.setValue(T,T,0);var g=Math.tan(m),E=f.radius+p*g;c.setValue(E,E,p),h.setValue(E,E,0)}break;case e.ParticleSystemShapeType.Box:var y=this.shape;0!=this.shape.randomDirection&&(l.setValue(1,1,1),u.setValue(1,1,1)),c.setValue(y.x/2,y.y/2,y.z/2),h.setValue(y.x/2,y.y/2,y.z/2);break;case e.ParticleSystemShapeType.Circle:var S=this.shape;l.setValue(1,1,1),u.setValue(1,1,1),c.setValue(S.radius,S.radius,0),h.setValue(S.radius,S.radius,0)}var v=0,R=4==t.renderMode;switch(t.renderMode){case 0:case 1:case 2:case 3:v=ShurikenParticleSystem.halfKSqrtOf2;break;case 4:var C=t.mesh.bounds;v=Math.sqrt(Math.pow(C.getExtent().x,2)+Math.pow(C.getExtent().y,2)+Math.pow(C.getExtent().z,2))}var M=ShurikenParticleSystem._tempVector36;if(M.setValue(1,1,1),this.sizeOverLifetime&&this.sizeOverLifetime.enable){var D=this.sizeOverLifetime.size.getMaxSizeInGradient(R);M.setValue(D,D,D)}var x=v*s;o.scale(M,x,M);var A=ShurikenParticleSystem._tempVector34,I=ShurikenParticleSystem._tempVector35;if(a>0?(o.scale(l,a,A),o.scale(u,a,I)):(o.scale(l,-a,I),o.scale(u,-a,A)),this.velocityOverLifetime&&this.velocityOverLifetime.enable){var L=this.velocityOverLifetime.velocity,P=ShurikenParticleSystem._tempVector37;switch(P.setValue(0,0,0),L.type){case 0:L.constant.cloneTo(P);break;case 2:L.constantMax.cloneTo(P);break;case 1:var O=L.gradientX.getAverageValue(),N=L.gradientY.getAverageValue(),b=L.gradientZ.getAverageValue();P.setValue(O,N,b);break;case 3:var k=L.gradientXMax.getAverageValue(),w=L.gradientYMax.getAverageValue(),B=L.gradientZMax.getAverageValue();P.setValue(k,w,B)}1==this.velocityOverLifetime.space&&o.transformV3ToV3(P,this._owner.transform.worldMatrix,P),o.add(A,P,A),o.subtract(I,P,I),o.max(A,o._ZERO,A),o.max(I,o._ZERO,I)}o.scale(A,i,A),o.scale(I,i,I);var V=this.gravityModifier;if(0!=V){var F=.5*ShurikenParticleSystem.g*V*i*i,U=A.y-F,G=I.y+F;U=U>0?U:0,G=G>0?G:0,this._gravityOffset.setValue(A.y-U,G-I.y)}o.add(A,M,n),o.add(n,c,n),o.add(I,M,r),o.add(r,h,r),o.scale(r,-1,r),this._bounds.setMin(r),this._bounds.setMax(n)}},{key:"_simulationSupported",value:function(){return 0!=this.simulationSpace}},{key:"_updateEmission",value:function(){if(this.isAlive)if(this._simulateUpdate)this._simulateUpdate=!1;else{var e=this._startUpdateLoopCount===t.Stat.loopCount||this._isPaused?0:this._owner._scene.timer._delta/1e3;e=Math.min(ShurikenParticleSystem._maxElapsedTime,e*this.simulationSpeed),this._updateParticles(e)}}},{key:"_updateParticles",value:function(e){(4!==this._ownerRender.renderMode||this._ownerRender.mesh)&&(this._currentTime+=e,this._retireActiveParticles(),this._freeRetiredParticles(),this._totalDelayTime+=e,this._totalDelayTime<this._playStartDelay||this._emission.enable&&this._isEmitting&&!this._isPaused&&this._advanceTime(e,this._currentTime))}},{key:"_updateParticlesSimulationRestart",value:function(e){this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._burstsIndex=0,this._frameRateTime=e,this._emissionTime=0,this._totalDelayTime=0,this._currentTime=e;var t=e;t<this._playStartDelay?this._totalDelayTime=t:this._emission.enable&&this._advanceTime(e,e)}},{key:"_retireActiveParticles",value:function(){for(;this._firstActiveElement!=this._firstNewElement;){var e=this._firstActiveElement*this._floatCountPerVertex*this._vertexStride,t=e+this._timeIndex;if(this._currentTime-this._vertices[t]+1e-4<this._vertices[e+this._startLifeTimeIndex])break;this._vertices[t]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this._bufferMaxParticles&&(this._firstActiveElement=0)}}},{key:"_freeRetiredParticles",value:function(){for(;this._firstRetiredElement!=this._firstActiveElement;){var e=this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*this._vertexStride+this._timeIndex];if(this.isPerformanceMode&&e<3)break;this._firstRetiredElement++,this._firstRetiredElement>=this._bufferMaxParticles&&(this._firstRetiredElement=0)}}},{key:"_burst",value:function(e,r){for(var n=0,i=this._emission._bursts,a=i.length;this._burstsIndex<a;this._burstsIndex++){var o,s=i[this._burstsIndex],l=s.time;if(!(e<=l&&l<r))break;this.autoRandomSeed?o=t.MathUtil.lerp(s.minCount,s.maxCount,Math.random()):(this._rand.seed=this._randomSeeds[0],o=t.MathUtil.lerp(s.minCount,s.maxCount,this._rand.getFloat()),this._randomSeeds[0]=this._rand.seed),n+=o}return n}},{key:"_advanceTime",value:function(e,t){var r,n=this._emissionTime;this._emissionTime+=e;var i=0;if(this._emissionTime>this.duration){if(!this.looping){for(i=Math.min(this.maxParticles-this.aliveParticleCount,i),r=0;r<i;r++)this.emit(t);return this._isPlaying=!1,void this.stop()}i+=this._burst(n,this._emissionTime),this._emissionTime-=this.duration,this._burstsIndex=0,i+=this._burst(0,this._emissionTime)}else i+=this._burst(n,this._emissionTime);for(i=Math.min(this.maxParticles-this.aliveParticleCount,i),r=0;r<i;r++)this.emit(t);var a=this.emission.emissionRate;if(a>0){var o=1/a;for(this._frameRateTime+=o,this._frameRateTime=this._currentTime-(this._currentTime-this._frameRateTime)%this._maxStartLifetime;this._frameRateTime<=t&&this.emit(this._frameRateTime);)this._frameRateTime+=o;this._frameRateTime=Math.floor(t/o)*o}}},{key:"_initBufferDatas",value:function(){if(this._vertexBuffer){var r=this._vertexBuffer._byteLength+2*this._indexBuffer.indexCount;this._vertexBuffer.destroy(),this._indexBuffer.destroy(),t.Resource._addMemory(-r,-r)}var n=t.LayaGL.instance,i=this._ownerRender,a=i.renderMode;if(-1!==a&&this.maxParticles>0){var o,s,l,u,c,h,_,d=0,f=(r=0,i.mesh);if(4===a){if(f){_=jr.vertexDeclaration,this._floatCountPerVertex=_.vertexStride/4,this._startLifeTimeIndex=12,this._timeIndex=16,this._vertexStride=f._vertexCount;var m=this._bufferMaxParticles*this._vertexStride,T=m%65535;if(Math.floor(m/65535)+1>1)throw new Error("ShurikenParticleSystem:the maxParticleCount multiply mesh vertexCount is large than 65535.");d=_.vertexStride*T,this._vertexBuffer=new qe(d,n.DYNAMIC_DRAW),this._vertexBuffer.vertexDeclaration=_,this._vertices=new Float32Array(this._floatCountPerVertex*T),this._indexStride=f._indexBuffer.indexCount;var p=f._indexBuffer.getData(),g=this._bufferMaxParticles*this._indexStride;for(this._indexBuffer=new Xe(e.IndexFormat.UInt16,g,n.STATIC_DRAW),o=new Uint16Array(g),r=d+2*g,c=0,s=0;s<this._bufferMaxParticles;s++){var E=s*this._vertexStride;for(l=0,u=p.length;l<u;l++)o[c++]=E+p[l]}this._indexBuffer.setData(o),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()}}else{for(_=Yr.vertexDeclaration,this._floatCountPerVertex=_.vertexStride/4,this._startLifeTimeIndex=7,this._timeIndex=11,this._vertexStride=4,d=_.vertexStride*this._bufferMaxParticles*this._vertexStride,this._vertexBuffer=new qe(d,n.DYNAMIC_DRAW),this._vertexBuffer.vertexDeclaration=_,this._vertices=new Float32Array(this._floatCountPerVertex*this._bufferMaxParticles*this._vertexStride),s=0;s<this._bufferMaxParticles;s++)h=s*this._floatCountPerVertex*this._vertexStride,this._vertices[h]=-.5,this._vertices[h+1]=-.5,this._vertices[h+2]=0,this._vertices[h+3]=1,h+=this._floatCountPerVertex,this._vertices[h]=.5,this._vertices[h+1]=-.5,this._vertices[h+2]=1,this._vertices[h+3]=1,h+=this._floatCountPerVertex,this._vertices[h]=.5,this._vertices[h+1]=.5,this._vertices[h+2]=1,this._vertices[h+3]=0,h+=this._floatCountPerVertex,this._vertices[h]=-.5,this._vertices[h+1]=.5,this._vertices[h+2]=0,this._vertices[h+3]=0;for(this._indexStride=6,this._indexBuffer=new Xe(e.IndexFormat.UInt16,6*this._bufferMaxParticles,n.STATIC_DRAW),o=new Uint16Array(6*this._bufferMaxParticles),s=0;s<this._bufferMaxParticles;s++){c=6*s;var y=s*this._vertexStride,S=y+2;o[c++]=y,o[c++]=S,o[c++]=y+1,o[c++]=y,o[c++]=y+3,o[c++]=S}this._indexBuffer.setData(o),r=d+6*this._bufferMaxParticles*2,this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()}t.Resource._addMemory(r,r)}}},{key:"destroy",value:function(){_get(_getPrototypeOf(ShurikenParticleSystem.prototype),"destroy",this).call(this);var e=this._vertexBuffer._byteLength+2*this._indexBuffer.indexCount;t.Resource._addMemory(-e,-e),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._emission.destroy(),this._boundingBox=null,this._boundingSphere=null,this._boundingBoxCorners=null,this._bounds=null,this._customBounds=null,this._bufferState=null,this._vertexBuffer=null,this._indexBuffer=null,this._owner=null,this._vertices=null,this._indexBuffer=null,this._emission=null,this._shape=null,this.startLifeTimeGradient=null,this.startLifeTimeGradientMin=null,this.startLifeTimeGradientMax=null,this.startSizeConstantSeparate=null,this.startSizeConstantMinSeparate=null,this.startSizeConstantMaxSeparate=null,this.startRotationConstantSeparate=null,this.startRotationConstantMinSeparate=null,this.startRotationConstantMaxSeparate=null,this.startColorConstant=null,this.startColorConstantMin=null,this.startColorConstantMax=null,this._velocityOverLifetime=null,this._colorOverLifetime=null,this._sizeOverLifetime=null,this._rotationOverLifetime=null,this._textureSheetAnimation=null}},{key:"emit",value:function(e){var t=ShurikenParticleSystem._tempPosition,r=ShurikenParticleSystem._tempDirection;return this._shape&&this._shape.enable?this.autoRandomSeed?this._shape.generatePositionAndDirection(t,r):this._shape.generatePositionAndDirection(t,r,this._rand,this._randomSeeds):(t.x=t.y=t.z=0,r.x=r.y=0,r.z=1),this.addParticle(t,r,e)}},{key:"addParticle",value:function(e,r,n){o.normalize(r,r);var i=this._firstFreeElement+1;if(i>=this._bufferMaxParticles&&(i=0),i===this._firstRetiredElement)return!1;var a,s,l,u,c,h,_,d,f,m,T=this._owner.transform;if(qr.create(this,this._ownerRender,T),this._currentTime-n>=qr.startLifeTime)return!0;switch(0==this.simulationSpace&&(a=T.position,s=T.rotation),this.startSpeedType){case 0:l=this.startSpeedConstant;break;case 2:this.autoRandomSeed?l=t.MathUtil.lerp(this.startSpeedConstantMin,this.startSpeedConstantMax,Math.random()):(this._rand.seed=this._randomSeeds[8],l=t.MathUtil.lerp(this.startSpeedConstantMin,this.startSpeedConstantMax,this._rand.getFloat()),this._randomSeeds[8]=this._rand.seed)}var p=this._velocityOverLifetime&&this._velocityOverLifetime.enable;if(p){var g=this._velocityOverLifetime.velocity.type;2===g||3===g?this.autoRandomSeed?(u=Math.random(),c=Math.random(),h=Math.random()):(this._rand.seed=this._randomSeeds[9],u=this._rand.getFloat(),c=this._rand.getFloat(),h=this._rand.getFloat(),this._randomSeeds[9]=this._rand.seed):p=!1}else p=!1;var E=this._colorOverLifetime&&this._colorOverLifetime.enable;E?3===this._colorOverLifetime.color.type?this.autoRandomSeed?_=Math.random():(this._rand.seed=this._randomSeeds[10],_=this._rand.getFloat(),this._randomSeeds[10]=this._rand.seed):E=!1:E=!1;var y=this._sizeOverLifetime&&this._sizeOverLifetime.enable;y?3===this._sizeOverLifetime.size.type?this.autoRandomSeed?d=Math.random():(this._rand.seed=this._randomSeeds[11],d=this._rand.getFloat(),this._randomSeeds[11]=this._rand.seed):y=!1:y=!1;var S=this._rotationOverLifetime&&this._rotationOverLifetime.enable;if(S){var v=this._rotationOverLifetime.angularVelocity.type;2===v||3===v?this.autoRandomSeed?f=Math.random():(this._rand.seed=this._randomSeeds[12],f=this._rand.getFloat(),this._randomSeeds[12]=this._rand.seed):S=!1}else S=!1;var R=this._textureSheetAnimation&&this._textureSheetAnimation.enable;R?3===this._textureSheetAnimation.frame.type?this.autoRandomSeed?m=Math.random():(this._rand.seed=this._randomSeeds[15],m=this._rand.getFloat(),this._randomSeeds[15]=this._rand.seed):R=!1:R=!1;var C,M,D,x,A,I,L=this._firstFreeElement*this._floatCountPerVertex*this._vertexStride,P=qr.startUVInfo[0],O=qr.startUVInfo[1],N=qr.startUVInfo[2],b=qr.startUVInfo[3],k=this._ownerRender;if(4===k.renderMode){var w=k.mesh._vertexBuffer;C=w.getFloat32Data();var B=w.vertexDeclaration;D=B.getVertexElementByUsage(Qe.MESH_POSITION0)._offset/4;var V=B.getVertexElementByUsage(Qe.MESH_COLOR0);x=V?V._offset/4:-1;var F=B.getVertexElementByUsage(Qe.MESH_TEXTURECOORDINATE0);A=F?F._offset/4:-1,M=B.vertexStride/4,I=0}else{this._vertices[L+2]=N,this._vertices[L+3]=b+O;var U=L+this._floatCountPerVertex;this._vertices[U+2]=N+P,this._vertices[U+3]=b+O;var G=U+this._floatCountPerVertex;this._vertices[G+2]=N+P,this._vertices[G+3]=b;var z=G+this._floatCountPerVertex;this._vertices[z+2]=N,this._vertices[z+3]=b}for(var H=L,W=L+this._floatCountPerVertex*this._vertexStride;H<W;H+=this._floatCountPerVertex){var X;if(4===k.renderMode){X=H;var Y=M*I++,j=Y+D;this._vertices[X++]=C[j++],this._vertices[X++]=C[j++],this._vertices[X++]=C[j],-1===x?(this._vertices[X++]=1,this._vertices[X++]=1,this._vertices[X++]=1,this._vertices[X++]=1):(j=Y+x,this._vertices[X++]=C[j++],this._vertices[X++]=C[j++],this._vertices[X++]=C[j++],this._vertices[X++]=C[j]),-1===A?(this._vertices[X++]=0,this._vertices[X++]=0):(j=Y+A,this._vertices[X++]=N+C[j++]*P,this._vertices[X++]=b+C[j]*O)}else X=H+4;switch(this._vertices[X++]=e.x,this._vertices[X++]=e.y,this._vertices[X++]=e.z,this._vertices[X++]=qr.startLifeTime,this._vertices[X++]=r.x,this._vertices[X++]=r.y,this._vertices[X++]=r.z,this._vertices[X++]=n,this._vertices[X++]=qr.startColor.x,this._vertices[X++]=qr.startColor.y,this._vertices[X++]=qr.startColor.z,this._vertices[X++]=qr.startColor.w,this._vertices[X++]=qr.startSize[0],this._vertices[X++]=qr.startSize[1],this._vertices[X++]=qr.startSize[2],this._vertices[X++]=qr.startRotation[0],this._vertices[X++]=qr.startRotation[1],this._vertices[X++]=qr.startRotation[2],this._vertices[X++]=l,E&&(this._vertices[X+1]=_),y&&(this._vertices[X+2]=d),S&&(this._vertices[X+3]=f),R&&(this._vertices[X+4]=m),p&&(this._vertices[X+5]=u,this._vertices[X+6]=c,this._vertices[X+7]=h),this.simulationSpace){case 0:X+=8,this._vertices[X++]=a.x,this._vertices[X++]=a.y,this._vertices[X++]=a.z,this._vertices[X++]=s.x,this._vertices[X++]=s.y,this._vertices[X++]=s.z,this._vertices[X++]=s.w;break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}}return this._firstFreeElement=i,!0}},{key:"addNewParticlesToVertexBuffer",value:function(){var e,t=this._vertexStride*this._floatCountPerVertex*4;this._firstNewElement<this._firstFreeElement?(e=this._firstNewElement*t,this._vertexBuffer.setData(this._vertices.buffer,e,e,(this._firstFreeElement-this._firstNewElement)*t)):(e=this._firstNewElement*t,this._vertexBuffer.setData(this._vertices.buffer,e,e,(this._bufferMaxParticles-this._firstNewElement)*t),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices.buffer,0,0,this._firstFreeElement*t)),this._firstNewElement=this._firstFreeElement}},{key:"_getType",value:function(){return ShurikenParticleSystem._type}},{key:"_prepareRender",value:function(e){return this._updateMask!=t.Stat.loopCount&&(this._updateMask=t.Stat.loopCount,this._updateEmission(),this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._drawCounter++),this._firstActiveElement!=this._firstFreeElement}},{key:"_render",value:function(e){var r;this._bufferState.bind();var n=t.LayaGL.instance;this._firstActiveElement<this._firstFreeElement?(r=(this._firstFreeElement-this._firstActiveElement)*this._indexStride,n.drawElements(n.TRIANGLES,r,n.UNSIGNED_SHORT,2*this._firstActiveElement*this._indexStride),t.Stat.trianglesFaces+=r/3,t.Stat.renderBatches++):(r=(this._bufferMaxParticles-this._firstActiveElement)*this._indexStride,n.drawElements(n.TRIANGLES,r,n.UNSIGNED_SHORT,2*this._firstActiveElement*this._indexStride),t.Stat.trianglesFaces+=r/3,t.Stat.renderBatches++,this._firstFreeElement>0&&(r=this._firstFreeElement*this._indexStride,n.drawElements(n.TRIANGLES,r,n.UNSIGNED_SHORT,0),t.Stat.trianglesFaces+=r/3,t.Stat.renderBatches++))}},{key:"play",value:function(){if(this._burstsIndex=0,this._isEmitting=!0,this._isPlaying=!0,this._isPaused=!1,this._emissionTime=0,this._totalDelayTime=0,!this.autoRandomSeed)for(var e=0,r=this._randomSeeds.length;e<r;e++)this._randomSeeds[e]=this.randomSeed[0]+ShurikenParticleSystem._RANDOMOFFSET[e];switch(this.startDelayType){case 0:this._playStartDelay=this.startDelay;break;case 1:this.autoRandomSeed?this._playStartDelay=t.MathUtil.lerp(this.startDelayMin,this.startDelayMax,Math.random()):(this._rand.seed=this._randomSeeds[2],this._playStartDelay=t.MathUtil.lerp(this.startDelayMin,this.startDelayMax,this._rand.getFloat()),this._randomSeeds[2]=this._rand.seed);break;default:throw new Error("Utils3D: startDelayType is invalid.")}this._frameRateTime=this._currentTime+this._playStartDelay,this._startUpdateLoopCount=t.Stat.loopCount}},{key:"pause",value:function(){this._isPaused=!0}},{key:"simulate",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._simulateUpdate=!0,t?this._updateParticlesSimulationRestart(e):(this._isPaused=!1,this._updateParticles(e)),this.pause()}},{key:"stop",value:function(){this._burstsIndex=0,this._isEmitting=!1,this._emissionTime=0}},{key:"cloneTo",value:function(e){var t=e;t._useCustomBounds=this._useCustomBounds,this._customBounds&&this._customBounds.cloneTo(t._customBounds),t.duration=this.duration,t.looping=this.looping,t.prewarm=this.prewarm,t.startDelayType=this.startDelayType,t.startDelay=this.startDelay,t.startDelayMin=this.startDelayMin,t.startDelayMax=this.startDelayMax,t._maxStartLifetime=this._maxStartLifetime,t.startLifetimeType=this.startLifetimeType,t.startLifetimeConstant=this.startLifetimeConstant,this.startLifeTimeGradient.cloneTo(t.startLifeTimeGradient),t.startLifetimeConstantMin=this.startLifetimeConstantMin,t.startLifetimeConstantMax=this.startLifetimeConstantMax,this.startLifeTimeGradientMin.cloneTo(t.startLifeTimeGradientMin),this.startLifeTimeGradientMax.cloneTo(t.startLifeTimeGradientMax),t.startSpeedType=this.startSpeedType,t.startSpeedConstant=this.startSpeedConstant,t.startSpeedConstantMin=this.startSpeedConstantMin,t.startSpeedConstantMax=this.startSpeedConstantMax,t.threeDStartSize=this.threeDStartSize,t.startSizeType=this.startSizeType,t.startSizeConstant=this.startSizeConstant,this.startSizeConstantSeparate.cloneTo(t.startSizeConstantSeparate),t.startSizeConstantMin=this.startSizeConstantMin,t.startSizeConstantMax=this.startSizeConstantMax,this.startSizeConstantMinSeparate.cloneTo(t.startSizeConstantMinSeparate),this.startSizeConstantMaxSeparate.cloneTo(t.startSizeConstantMaxSeparate),t.threeDStartRotation=this.threeDStartRotation,t.startRotationType=this.startRotationType,t.startRotationConstant=this.startRotationConstant,this.startRotationConstantSeparate.cloneTo(t.startRotationConstantSeparate),t.startRotationConstantMin=this.startRotationConstantMin,t.startRotationConstantMax=this.startRotationConstantMax,this.startRotationConstantMinSeparate.cloneTo(t.startRotationConstantMinSeparate),this.startRotationConstantMaxSeparate.cloneTo(t.startRotationConstantMaxSeparate),t.randomizeRotationDirection=this.randomizeRotationDirection,t.startColorType=this.startColorType,this.startColorConstant.cloneTo(t.startColorConstant),this.startColorConstantMin.cloneTo(t.startColorConstantMin),this.startColorConstantMax.cloneTo(t.startColorConstantMax),t.gravityModifier=this.gravityModifier,t.simulationSpace=this.simulationSpace,t.scaleMode=this.scaleMode,t.playOnAwake=this.playOnAwake,t.autoRandomSeed=this.autoRandomSeed,t.randomSeed[0]=this.randomSeed[0],t.maxParticles=this.maxParticles,this._emission&&(t._emission=this._emission.clone()),this.shape&&(t.shape=this.shape.clone()),this.velocityOverLifetime&&(t.velocityOverLifetime=this.velocityOverLifetime.clone()),this.colorOverLifetime&&(t.colorOverLifetime=this.colorOverLifetime.clone()),this.sizeOverLifetime&&(t.sizeOverLifetime=this.sizeOverLifetime.clone()),this.rotationOverLifetime&&(t.rotationOverLifetime=this.rotationOverLifetime.clone()),this.textureSheetAnimation&&(t.textureSheetAnimation=this.textureSheetAnimation.clone()),t.isPerformanceMode=this.isPerformanceMode,t._isEmitting=this._isEmitting,t._isPlaying=this._isPlaying,t._isPaused=this._isPaused,t._playStartDelay=this._playStartDelay,t._frameRateTime=this._frameRateTime,t._emissionTime=this._emissionTime,t._totalDelayTime=this._totalDelayTime,t._burstsIndex=this._burstsIndex}},{key:"clone",value:function(){var e=new ShurikenParticleSystem(null);return this.cloneTo(e),e}},{key:"maxParticles",get:function(){return this._bufferMaxParticles-1},set:function(e){var t=e+1;t!==this._bufferMaxParticles&&(this._bufferMaxParticles=t,this._initBufferDatas())}},{key:"emission",get:function(){return this._emission}},{key:"aliveParticleCount",get:function(){return this._firstNewElement>=this._firstRetiredElement?this._firstNewElement-this._firstRetiredElement:this._bufferMaxParticles-this._firstRetiredElement+this._firstNewElement}},{key:"emissionTime",get:function(){return this._emissionTime>this.duration?this.duration:this._emissionTime}},{key:"shape",get:function(){return this._shape},set:function(e){this._shape!==e&&(e&&e.enable?this._owner._render._shaderValues.addDefine(zr.SHADERDEFINE_SHAPE):this._owner._render._shaderValues.removeDefine(zr.SHADERDEFINE_SHAPE),this._shape=e)}},{key:"isAlive",get:function(){return!!(this._isPlaying||this.aliveParticleCount>0)}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"startLifetimeType",get:function(){return this._startLifetimeType},set:function(e){var t,r;switch(this.startLifetimeType){case 0:this._maxStartLifetime=this.startLifetimeConstant;break;case 1:this._maxStartLifetime=-Number.MAX_VALUE;var n=n;for(t=0,r=n.gradientCount;t<r;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,n.getValueByIndex(t));break;case 2:this._maxStartLifetime=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:this._maxStartLifetime=-Number.MAX_VALUE;var i=i;for(t=0,r=i.gradientCount;t<r;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,i.getValueByIndex(t));var a=a;for(t=0,r=a.gradientCount;t<r;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,a.getValueByIndex(t))}this._startLifetimeType=e}},{key:"startLifetimeConstant",get:function(){return this._startLifetimeConstant},set:function(e){0===this._startLifetimeType&&(this._maxStartLifetime=e),this._startLifetimeConstant=e}},{key:"startLifeTimeGradient",get:function(){return this._startLifeTimeGradient},set:function(e){if(1===this._startLifetimeType){this._maxStartLifetime=-Number.MAX_VALUE;for(var t=0,r=e.gradientCount;t<r;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t))}this._startLifeTimeGradient=e}},{key:"startLifetimeConstantMin",get:function(){return this._startLifetimeConstantMin},set:function(e){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(e,this._startLifetimeConstantMax)),this._startLifetimeConstantMin=e}},{key:"startLifetimeConstantMax",get:function(){return this._startLifetimeConstantMax},set:function(e){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(this._startLifetimeConstantMin,e)),this._startLifetimeConstantMax=e}},{key:"startLifeTimeGradientMin",get:function(){return this._startLifeTimeGradientMin},set:function(e){if(3===this._startLifetimeType){var t,r;for(this._maxStartLifetime=-Number.MAX_VALUE,t=0,r=e.gradientCount;t<r;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t));for(t=0,r=this._startLifeTimeGradientMax.gradientCount;t<r;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMax.getValueByIndex(t))}this._startLifeTimeGradientMin=e}},{key:"startLifeTimeGradientMax",get:function(){return this._startLifeTimeGradientMax},set:function(e){if(3===this._startLifetimeType){var t,r;for(this._maxStartLifetime=-Number.MAX_VALUE,t=0,r=this._startLifeTimeGradientMin.gradientCount;t<r;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMin.getValueByIndex(t));for(t=0,r=e.gradientCount;t<r;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t))}this._startLifeTimeGradientMax=e}},{key:"velocityOverLifetime",get:function(){return this._velocityOverLifetime},set:function(e){var t=this._owner._render._shaderValues;if(e){var r=e.velocity,n=r.type;if(e.enable)switch(n){case 0:t.addDefine(zr.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT);break;case 1:t.addDefine(zr.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE);break;case 2:t.addDefine(zr.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT);break;case 3:t.addDefine(zr.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE)}else t.removeDefine(zr.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),t.removeDefine(zr.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),t.removeDefine(zr.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),t.removeDefine(zr.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);switch(n){case 0:t.setVector3(zr.VOLVELOCITYCONST,r.constant);break;case 1:t.setBuffer(zr.VOLVELOCITYGRADIENTX,r.gradientX._elements),t.setBuffer(zr.VOLVELOCITYGRADIENTY,r.gradientY._elements),t.setBuffer(zr.VOLVELOCITYGRADIENTZ,r.gradientZ._elements);break;case 2:t.setVector3(zr.VOLVELOCITYCONST,r.constantMin),t.setVector3(zr.VOLVELOCITYCONSTMAX,r.constantMax);break;case 3:t.setBuffer(zr.VOLVELOCITYGRADIENTX,r.gradientXMin._elements),t.setBuffer(zr.VOLVELOCITYGRADIENTXMAX,r.gradientXMax._elements),t.setBuffer(zr.VOLVELOCITYGRADIENTY,r.gradientYMin._elements),t.setBuffer(zr.VOLVELOCITYGRADIENTYMAX,r.gradientYMax._elements),t.setBuffer(zr.VOLVELOCITYGRADIENTZ,r.gradientZMin._elements),t.setBuffer(zr.VOLVELOCITYGRADIENTZMAX,r.gradientZMax._elements)}t.setInt(zr.VOLSPACETYPE,e.space)}else t.removeDefine(zr.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),t.removeDefine(zr.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),t.removeDefine(zr.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),t.removeDefine(zr.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);this._velocityOverLifetime=e}},{key:"colorOverLifetime",get:function(){return this._colorOverLifetime},set:function(e){var t=this._owner._render._shaderValues;if(e){var r=e.color;if(e.enable)switch(r.type){case 1:t.addDefine(zr.SHADERDEFINE_COLOROVERLIFETIME);break;case 3:t.addDefine(zr.SHADERDEFINE_RANDOMCOLOROVERLIFETIME)}else t.removeDefine(zr.SHADERDEFINE_COLOROVERLIFETIME),t.removeDefine(zr.SHADERDEFINE_RANDOMCOLOROVERLIFETIME);switch(r.type){case 1:var n=r.gradient;t.setBuffer(zr.COLOROVERLIFEGRADIENTALPHAS,n._alphaElements),t.setBuffer(zr.COLOROVERLIFEGRADIENTCOLORS,n._rgbElements);break;case 3:var i=r.gradientMin,a=r.gradientMax;t.setBuffer(zr.COLOROVERLIFEGRADIENTALPHAS,i._alphaElements),t.setBuffer(zr.COLOROVERLIFEGRADIENTCOLORS,i._rgbElements),t.setBuffer(zr.MAXCOLOROVERLIFEGRADIENTALPHAS,a._alphaElements),t.setBuffer(zr.MAXCOLOROVERLIFEGRADIENTCOLORS,a._rgbElements)}}else t.removeDefine(zr.SHADERDEFINE_COLOROVERLIFETIME),t.removeDefine(zr.SHADERDEFINE_RANDOMCOLOROVERLIFETIME),t.setBuffer(zr.COLOROVERLIFEGRADIENTALPHAS,n._alphaElements),t.setBuffer(zr.COLOROVERLIFEGRADIENTCOLORS,n._rgbElements),t.setBuffer(zr.COLOROVERLIFEGRADIENTALPHAS,i._alphaElements),t.setBuffer(zr.COLOROVERLIFEGRADIENTCOLORS,i._rgbElements),t.setBuffer(zr.MAXCOLOROVERLIFEGRADIENTALPHAS,a._alphaElements),t.setBuffer(zr.MAXCOLOROVERLIFEGRADIENTCOLORS,a._rgbElements);this._colorOverLifetime=e}},{key:"sizeOverLifetime",get:function(){return this._sizeOverLifetime},set:function(e){var t=this._owner._render._shaderValues;if(e){var r=e.size,n=r.separateAxes,i=r.type;if(e.enable)switch(i){case 0:n?t.addDefine(zr.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE):t.addDefine(zr.SHADERDEFINE_SIZEOVERLIFETIMECURVE);break;case 2:n?t.addDefine(zr.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE):t.addDefine(zr.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES)}else t.removeDefine(zr.SHADERDEFINE_SIZEOVERLIFETIMECURVE),t.removeDefine(zr.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),t.removeDefine(zr.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),t.removeDefine(zr.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);switch(i){case 0:n?(t.setBuffer(zr.SOLSIZEGRADIENTX,r.gradientX._elements),t.setBuffer(zr.SOLSIZEGRADIENTY,r.gradientY._elements),t.setBuffer(zr.SOLSizeGradientZ,r.gradientZ._elements)):t.setBuffer(zr.SOLSIZEGRADIENT,r.gradient._elements);break;case 2:n?(t.setBuffer(zr.SOLSIZEGRADIENTX,r.gradientXMin._elements),t.setBuffer(zr.SOLSIZEGRADIENTXMAX,r.gradientXMax._elements),t.setBuffer(zr.SOLSIZEGRADIENTY,r.gradientYMin._elements),t.setBuffer(zr.SOLSIZEGRADIENTYMAX,r.gradientYMax._elements),t.setBuffer(zr.SOLSizeGradientZ,r.gradientZMin._elements),t.setBuffer(zr.SOLSizeGradientZMAX,r.gradientZMax._elements)):(t.setBuffer(zr.SOLSIZEGRADIENT,r.gradientMin._elements),t.setBuffer(zr.SOLSizeGradientMax,r.gradientMax._elements))}}else t.removeDefine(zr.SHADERDEFINE_SIZEOVERLIFETIMECURVE),t.removeDefine(zr.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),t.removeDefine(zr.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),t.removeDefine(zr.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);this._sizeOverLifetime=e}},{key:"rotationOverLifetime",get:function(){return this._rotationOverLifetime},set:function(e){var t=this._owner._render._shaderValues;if(e){var r=e.angularVelocity;if(!r)return;var n=r.separateAxes,i=r.type;if(e.enable)switch(n?t.addDefine(zr.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE):t.addDefine(zr.SHADERDEFINE_ROTATIONOVERLIFETIME),i){case 0:t.addDefine(zr.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT);break;case 1:t.addDefine(zr.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE);break;case 2:t.addDefine(zr.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS);break;case 3:t.addDefine(zr.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES)}else t.removeDefine(zr.SHADERDEFINE_ROTATIONOVERLIFETIME),t.removeDefine(zr.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),t.removeDefine(zr.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),t.removeDefine(zr.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),t.removeDefine(zr.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),t.removeDefine(zr.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);switch(i){case 0:n?t.setVector3(zr.ROLANGULARVELOCITYCONSTSEPRARATE,r.constantSeparate):t.setNumber(zr.ROLANGULARVELOCITYCONST,r.constant);break;case 1:n?(t.setBuffer(zr.ROLANGULARVELOCITYGRADIENTX,r.gradientX._elements),t.setBuffer(zr.ROLANGULARVELOCITYGRADIENTY,r.gradientY._elements),t.setBuffer(zr.ROLANGULARVELOCITYGRADIENTZ,r.gradientZ._elements)):t.setBuffer(zr.ROLANGULARVELOCITYGRADIENT,r.gradient._elements);break;case 2:n?(t.setVector3(zr.ROLANGULARVELOCITYCONSTSEPRARATE,r.constantMinSeparate),t.setVector3(zr.ROLANGULARVELOCITYCONSTMAXSEPRARATE,r.constantMaxSeparate)):(t.setNumber(zr.ROLANGULARVELOCITYCONST,r.constantMin),t.setNumber(zr.ROLANGULARVELOCITYCONSTMAX,r.constantMax));break;case 3:n?(t.setBuffer(zr.ROLANGULARVELOCITYGRADIENTX,r.gradientXMin._elements),t.setBuffer(zr.ROLANGULARVELOCITYGRADIENTXMAX,r.gradientXMax._elements),t.setBuffer(zr.ROLANGULARVELOCITYGRADIENTY,r.gradientYMin._elements),t.setBuffer(zr.ROLANGULARVELOCITYGRADIENTYMAX,r.gradientYMax._elements),t.setBuffer(zr.ROLANGULARVELOCITYGRADIENTZ,r.gradientZMin._elements),t.setBuffer(zr.ROLANGULARVELOCITYGRADIENTZMAX,r.gradientZMax._elements)):(t.setBuffer(zr.ROLANGULARVELOCITYGRADIENT,r.gradientMin._elements),t.setBuffer(zr.ROLANGULARVELOCITYGRADIENTMAX,r.gradientMax._elements))}}else t.removeDefine(zr.SHADERDEFINE_ROTATIONOVERLIFETIME),t.removeDefine(zr.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),t.removeDefine(zr.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),t.removeDefine(zr.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),t.removeDefine(zr.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),t.removeDefine(zr.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);this._rotationOverLifetime=e}},{key:"textureSheetAnimation",get:function(){return this._textureSheetAnimation},set:function(e){var t=this._owner._render._shaderValues;if(e){var r=e.frame,n=r.type;if(e.enable)switch(n){case 1:t.addDefine(zr.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE);break;case 3:t.addDefine(zr.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE)}else t.removeDefine(zr.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),t.removeDefine(zr.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);if(1===n||3===n){t.setNumber(zr.TEXTURESHEETANIMATIONCYCLES,e.cycles);var i=e.tiles,a=this._uvLength;a.x=1/i.x,a.y=1/i.y,t.setVector2(zr.TEXTURESHEETANIMATIONSUBUVLENGTH,this._uvLength)}switch(n){case 1:t.setBuffer(zr.TEXTURESHEETANIMATIONGRADIENTUVS,r.frameOverTimeData._elements);break;case 3:t.setBuffer(zr.TEXTURESHEETANIMATIONGRADIENTUVS,r.frameOverTimeDataMin._elements),t.setBuffer(zr.TEXTURESHEETANIMATIONGRADIENTMAXUVS,r.frameOverTimeDataMax._elements)}}else t.removeDefine(zr.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),t.removeDefine(zr.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);this._textureSheetAnimation=e}},{key:"customBounds",get:function(){return this._customBounds},set:function(e){this._useCustomBounds=!!e,this._customBounds=e}}]),ShurikenParticleSystem}(It);Kr._RANDOMOFFSET=new Uint32Array([592910910,3276756734,322376503,306581307,1793934638,3737431713,2527743459,2368504881,4085612399,3774601268,326370691,1494990940,1089181156,3159510623,2941263940,2786374529,271901988,4233252447]),Kr.halfKSqrtOf2=.71,Kr.g=9.8,Kr._maxElapsedTime=1/3,Kr._tempVector30=new o,Kr._tempVector31=new o,Kr._tempVector32=new o,Kr._tempVector33=new o,Kr._tempVector34=new o,Kr._tempVector35=new o,Kr._tempVector36=new o,Kr._tempVector37=new o,Kr._tempVector38=new o,Kr._tempVector39=new o,Kr._tempPosition=new o,Kr._tempDirection=new o,Kr._type=It._typeCounter++;var Jr=function(e){function ShuriKenParticle3D(){var e;_classCallCheck(this,ShuriKenParticle3D),(e=_possibleConstructorReturn(this,_getPrototypeOf(ShuriKenParticle3D).call(this,null)))._render=new Wr(_assertThisInitialized(e)),e._particleSystem=new Kr(_assertThisInitialized(e));var t=e._render._renderElements[0]=new kt;return t.setTransform(e._transform),t.render=e._render,t.setGeometry(e._particleSystem),t.material=Hr.defaultMaterial,e}return _inherits(ShuriKenParticle3D,e),_createClass(ShuriKenParticle3D,[{key:"_parseModule",value:function(e,r){for(var n in r)switch(n){case"bases":var i=r.bases;for(var a in i)e[a]=i[a];break;case"vector2s":var o=r.vector2s;for(var a in o){var s=e[a],l=o[a];s.setValue(l[0],l[1]),e[a]=s}break;case"vector3s":var u=r.vector3s;for(var a in u){var c=e[a],h=u[a];c.setValue(h[0],h[1],h[2]),e[a]=c}break;case"vector4s":var _=r.vector4s;for(var a in _){var d=e[a],f=_[a];d.setValue(f[0],f[1],f[2],f[3]),e[a]=d}break;case"gradientDataNumbers":var m=r.gradientDataNumbers;for(var a in m){for(var T=e[a],p=r[a],g=0,E=p.length;g<E;g++){var y=p[g];T.add(y.key,y.value)}e[a]=T}break;case"resources":var S=r.resources;for(var a in S)e[a]=t.Loader.getRes(S[a]);break;case"bursts":var v=r.bursts;for(g=0,E=v.length;g<E;g++){var R=v[g];e.addBurst(new Sr(R.time,R.min,R.max))}break;case"randomSeed":e.randomSeed[0]=r.randomSeed;break;case"shapeType":case"type":case"color":case"size":case"frame":case"startFrame":case"angularVelocity":case"velocity":break;default:throw"ShurikenParticle3D:unknown type."}}},{key:"_parse",value:function(e,t){if(_get(_getPrototypeOf(ShuriKenParticle3D.prototype),"_parse",this).call(this,e,t),e.main){var r=this.particleSystem,n=this.particleRenderer;this._parseModule(n,e.renderer),this._parseModule(r,e.main),this._parseModule(r.emission,e.emission);var a=e.shape;if(a){var s;switch(a.shapeType){case 0:s=new Br;break;case 1:s=new wr;break;case 2:s=new kr;break;case 3:s=new Nr;break;case 7:s=new br;break;default:throw"ShuriKenParticle3D:unknown shape type."}this._parseModule(s,a),r.shape=s}var l=e.velocityOverLifetime;if(l){var u,c=l.velocity;switch(c.type){case 0:var h=c.constant;u=Ir.createByConstant(h?new o(h[0],h[1],h[2]):new o(0,0,0));break;case 1:u=Ir.createByGradient(this._initParticleVelocity(c.gradientX),this._initParticleVelocity(c.gradientY),this._initParticleVelocity(c.gradientZ));break;case 2:var _=c.constantMin,d=c.constantMax;u=Ir.createByRandomTwoConstant(_?new o(_[0],_[1],_[2]):new o(0,0,0),d?new o(d[0],d[1],d[2]):new o(0,0,0));break;case 3:u=Ir.createByRandomTwoGradient(this._initParticleVelocity(c.gradientXMin),this._initParticleVelocity(c.gradientXMax),this._initParticleVelocity(c.gradientYMin),this._initParticleVelocity(c.gradientYMax),this._initParticleVelocity(c.gradientZMin),this._initParticleVelocity(c.gradientZMax))}var f=new Gr(u);this._parseModule(f,l),r.velocityOverLifetime=f}var m=e.colorOverLifetime;if(m){var T,p=m.color;switch(p.type){case 0:var g=p.constant;T=vr.createByConstant(g?new i(g[0],g[1],g[2],g[3]):new i(0,0,0,0));break;case 1:T=vr.createByGradient(this._initParticleColor(p.gradient));break;case 2:var E=p.constantMin,y=p.constantMax;T=vr.createByRandomTwoConstant(E?new i(E[0],E[1],E[2],E[3]):new i(0,0,0,0),E?new i(y[0],y[1],y[2],y[3]):new i(0,0,0,0));break;case 3:T=vr.createByRandomTwoGradient(this._initParticleColor(p.gradientMin),this._initParticleColor(p.gradientMax))}var S=new Rr(T);this._parseModule(S,m),r.colorOverLifetime=S}var v=e.sizeOverLifetime;if(v){var R,C=v.size;switch(C.type){case 0:R=C.separateAxes?Ar.createByGradientSeparate(this._initParticleSize(C.gradientX),this._initParticleSize(C.gradientY),this._initParticleSize(C.gradientZ)):Ar.createByGradient(this._initParticleSize(C.gradient));break;case 1:if(C.separateAxes){var M=C.constantMinSeparate,D=C.constantMaxSeparate;R=Ar.createByRandomTwoConstantSeparate(M?new o(M[0],M[1],M[2]):new o(0,0,0),D?new o(D[0],D[1],D[2]):new o(0,0,0))}else R=Ar.createByRandomTwoConstant(C.constantMin||0,C.constantMax||0);break;case 2:R=C.separateAxes?Ar.createByRandomTwoGradientSeparate(this._initParticleSize(C.gradientXMin),this._initParticleSize(C.gradientYMin),this._initParticleSize(C.gradientZMin),this._initParticleSize(C.gradientXMax),this._initParticleSize(C.gradientYMax),this._initParticleSize(C.gradientZMax)):Ar.createByRandomTwoGradient(this._initParticleSize(C.gradientMin),this._initParticleSize(C.gradientMax))}var x=new Vr(R);this._parseModule(x,v),r.sizeOverLifetime=x}var A=e.rotationOverLifetime;if(A){var I,L=A.angularVelocity;switch(L.type){case 0:if(L.separateAxes){var P=L.constantSeparate;I=Mr.createByConstantSeparate(P?new o(P[0],P[1],P[2]):new o(0,0,Math.PI/4))}else I=Mr.createByConstant(L.constant||Math.PI/4);break;case 1:I=L.separateAxes?Mr.createByGradientSeparate(this._initParticleRotation(L.gradientX),this._initParticleRotation(L.gradientY),this._initParticleRotation(L.gradientZ)):Mr.createByGradient(this._initParticleRotation(L.gradient));break;case 2:if(L.separateAxes){var O=L.constantMinSeparate,N=L.constantMaxSeparate;I=Mr.createByRandomTwoConstantSeparate(O?new o(O[0],O[1],O[2]):new o(0,0,0),N?new o(N[0],N[1],N[2]):new o(0,0,Math.PI/4))}else I=Mr.createByRandomTwoConstant(L.constantMin||0,L.constantMax||Math.PI/4);break;case 3:L.separateAxes||(I=Mr.createByRandomTwoGradient(this._initParticleRotation(L.gradientMin),this._initParticleRotation(L.gradientMax)))}var b=new Lr(I);this._parseModule(b,A),r.rotationOverLifetime=b}var k=e.textureSheetAnimation;if(k){var w,B=k.frame;switch(B.type){case 0:w=Cr.createByConstant(B.constant);break;case 1:w=Cr.createByOverTime(this._initParticleFrame(B.overTime));break;case 2:w=Cr.createByRandomTwoConstant(B.constantMin,B.constantMax);break;case 3:w=Cr.createByRandomTwoOverTime(this._initParticleFrame(B.overTimeMin),this._initParticleFrame(B.overTimeMax))}var V,F=k.startFrame;switch(F.type){case 0:V=Fr.createByConstant(F.constant);break;case 1:V=Fr.createByRandomTwoConstant(F.constantMin,F.constantMax)}var U=new Ur(w,V);this._parseModule(U,k),r.textureSheetAnimation=U}}else this._parseOld(e)}},{key:"_activeHierarchy",value:function(e){_get(_getPrototypeOf(ShuriKenParticle3D.prototype),"_activeHierarchy",this).call(this,e),this.particleSystem.playOnAwake&&this.particleSystem.play()}},{key:"_inActiveHierarchy",value:function(e){_get(_getPrototypeOf(ShuriKenParticle3D.prototype),"_inActiveHierarchy",this).call(this,e),this.particleSystem.isAlive&&this.particleSystem.simulate(0,!0)}},{key:"_cloneTo",value:function(e,t,r){var n=e,i=n._particleSystem;this._particleSystem.cloneTo(i);var a=n._render,o=this._render;a.sharedMaterials=o.sharedMaterials,a.enable=o.enable,a.renderMode=o.renderMode,a.mesh=o.mesh,a.stretchedBillboardCameraSpeedScale=o.stretchedBillboardCameraSpeedScale,a.stretchedBillboardSpeedScale=o.stretchedBillboardSpeedScale,a.stretchedBillboardLengthScale=o.stretchedBillboardLengthScale,a.sortingFudge=o.sortingFudge,_get(_getPrototypeOf(ShuriKenParticle3D.prototype),"_cloneTo",this).call(this,e,t,r)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(ShuriKenParticle3D.prototype),"destroy",this).call(this,e),this._particleSystem.destroy(),this._particleSystem=null)}},{key:"_create",value:function(){return new ShuriKenParticle3D}},{key:"_parseOld",value:function(e){var r,a,s,l=Math.PI/180,u=this.particleRenderer,c=e.material;c&&(s=t.Loader.getRes(c.path)),u.sharedMaterial=s;var h=e.meshPath;h&&(u.mesh=t.Loader.getRes(h)),u.renderMode=e.renderMode,u.stretchedBillboardCameraSpeedScale=e.stretchedBillboardCameraSpeedScale,u.stretchedBillboardSpeedScale=e.stretchedBillboardSpeedScale,u.stretchedBillboardLengthScale=e.stretchedBillboardLengthScale,u.sortingFudge=e.sortingFudge?e.sortingFudge:0;var _=this.particleSystem;_.isPerformanceMode=e.isPerformanceMode,_.duration=e.duration,_.looping=e.looping,_.prewarm=e.prewarm,_.startDelayType=e.startDelayType,_.startDelay=e.startDelay,_.startDelayMin=e.startDelayMin,_.startDelayMax=e.startDelayMax,_.startLifetimeType=e.startLifetimeType,_.startLifetimeConstant=e.startLifetimeConstant,_.startLifeTimeGradient=ShuriKenParticle3D._initStartLife(e.startLifetimeGradient),_.startLifetimeConstantMin=e.startLifetimeConstantMin,_.startLifetimeConstantMax=e.startLifetimeConstantMax,_.startLifeTimeGradientMin=ShuriKenParticle3D._initStartLife(e.startLifetimeGradientMin),_.startLifeTimeGradientMax=ShuriKenParticle3D._initStartLife(e.startLifetimeGradientMax),_.startSpeedType=e.startSpeedType,_.startSpeedConstant=e.startSpeedConstant,_.startSpeedConstantMin=e.startSpeedConstantMin,_.startSpeedConstantMax=e.startSpeedConstantMax,_.threeDStartSize=e.threeDStartSize,_.startSizeType=e.startSizeType,_.startSizeConstant=e.startSizeConstant;var d=e.startSizeConstantSeparate,f=_.startSizeConstantSeparate;f.x=d[0],f.y=d[1],f.z=d[2],_.startSizeConstantMin=e.startSizeConstantMin,_.startSizeConstantMax=e.startSizeConstantMax;var m=e.startSizeConstantMinSeparate,T=_.startSizeConstantMinSeparate;T.x=m[0],T.y=m[1],T.z=m[2];var p=e.startSizeConstantMaxSeparate,g=_.startSizeConstantMaxSeparate;g.x=p[0],g.y=p[1],g.z=p[2],_.threeDStartRotation=e.threeDStartRotation,_.startRotationType=e.startRotationType,_.startRotationConstant=e.startRotationConstant*l;var E=e.startRotationConstantSeparate,y=_.startRotationConstantSeparate;y.x=E[0]*l,y.y=E[1]*l,y.z=E[2]*l,_.startRotationConstantMin=e.startRotationConstantMin*l,_.startRotationConstantMax=e.startRotationConstantMax*l;var S=e.startRotationConstantMinSeparate,v=_.startRotationConstantMinSeparate;v.x=S[0]*l,v.y=S[1]*l,v.z=S[2]*l;var R=e.startRotationConstantMaxSeparate,C=_.startRotationConstantMaxSeparate;C.x=R[0]*l,C.y=R[1]*l,C.z=R[2]*l,_.randomizeRotationDirection=e.randomizeRotationDirection,_.startColorType=e.startColorType;var M=e.startColorConstant,D=_.startColorConstant;D.x=M[0],D.y=M[1],D.z=M[2],D.w=M[3];var x=e.startColorConstantMin,A=_.startColorConstantMin;A.x=x[0],A.y=x[1],A.z=x[2],A.w=x[3];var I=e.startColorConstantMax,L=_.startColorConstantMax;L.x=I[0],L.y=I[1],L.z=I[2],L.w=I[3],_.gravityModifier=e.gravityModifier,_.simulationSpace=e.simulationSpace,void 0!==e.simulationSpeed&&(_.simulationSpeed=e.simulationSpeed),_.scaleMode=e.scaleMode,_.playOnAwake=e.playOnAwake,_.maxParticles=e.maxParticles;var P=e.autoRandomSeed;null!=P&&(_.autoRandomSeed=P);var O=e.randomSeed;null!=O&&(_.randomSeed[0]=O);var N=e.emission,b=_.emission;if(N){b.emissionRate=N.emissionRate;var k=N.bursts;if(k)for(r=0,a=k.length;r<a;r++){var w=k[r];b.addBurst(new Sr(w.time,w.min,w.max))}b.enable=N.enable}else b.enable=!1;var B=e.shape;if(B){var V;switch(B.shapeType){case 0:var F;V=F=new Br,F.radius=B.sphereRadius,F.emitFromShell=B.sphereEmitFromShell,F.randomDirection=B.sphereRandomDirection;break;case 1:var U;V=U=new wr,U.radius=B.hemiSphereRadius,U.emitFromShell=B.hemiSphereEmitFromShell,U.randomDirection=B.hemiSphereRandomDirection;break;case 2:var G;V=G=new kr,G.angle=B.coneAngle*l,G.radius=B.coneRadius,G.length=B.coneLength,G.emitType=B.coneEmitType,G.randomDirection=B.coneRandomDirection;break;case 3:var z;V=z=new Nr,z.x=B.boxX,z.y=B.boxY,z.z=B.boxZ,z.randomDirection=B.boxRandomDirection;break;case 7:var H;V=H=new br,H.radius=B.circleRadius,H.arc=B.circleArc*l,H.emitFromEdge=B.circleEmitFromEdge,H.randomDirection=B.circleRandomDirection;break;default:var W;V=W=new br,W.radius=B.circleRadius,W.arc=B.circleArc*l,W.emitFromEdge=B.circleEmitFromEdge,W.randomDirection=B.circleRandomDirection}V.enable=B.enable,_.shape=V}var X=e.velocityOverLifetime;if(X){var Y,j=X.velocity;switch(j.type){case 0:var Z=j.constant;Y=Ir.createByConstant(new o(Z[0],Z[1],Z[2]));break;case 1:Y=Ir.createByGradient(this._initParticleVelocity(j.gradientX),this._initParticleVelocity(j.gradientY),this._initParticleVelocity(j.gradientZ));break;case 2:var Q=j.constantMin,q=j.constantMax;Y=Ir.createByRandomTwoConstant(new o(Q[0],Q[1],Q[2]),new o(q[0],q[1],q[2]));break;case 3:Y=Ir.createByRandomTwoGradient(this._initParticleVelocity(j.gradientXMin),this._initParticleVelocity(j.gradientXMax),this._initParticleVelocity(j.gradientYMin),this._initParticleVelocity(j.gradientYMax),this._initParticleVelocity(j.gradientZMin),this._initParticleVelocity(j.gradientZMax))}var K=new Gr(Y);K.space=X.space,K.enable=X.enable,_.velocityOverLifetime=K}var J=e.colorOverLifetime;if(J){var $,ee=J.color;switch(ee.type){case 0:var te=ee.constant;$=vr.createByConstant(new i(te[0],te[1],te[2],te[3]));break;case 1:$=vr.createByGradient(this._initParticleColor(ee.gradient));break;case 2:var re=ee.constantMin,ne=ee.constantMax;$=vr.createByRandomTwoConstant(new i(re[0],re[1],re[2],re[3]),new i(ne[0],ne[1],ne[2],ne[3]));break;case 3:$=vr.createByRandomTwoGradient(this._initParticleColor(ee.gradientMin),this._initParticleColor(ee.gradientMax))}var ie=new Rr($);ie.enable=J.enable,_.colorOverLifetime=ie}var ae=e.sizeOverLifetime;if(ae){var oe,se=ae.size;switch(se.type){case 0:oe=se.separateAxes?Ar.createByGradientSeparate(this._initParticleSize(se.gradientX),this._initParticleSize(se.gradientY),this._initParticleSize(se.gradientZ)):Ar.createByGradient(this._initParticleSize(se.gradient));break;case 1:if(se.separateAxes){var le=se.constantMinSeparate,ue=se.constantMaxSeparate;oe=Ar.createByRandomTwoConstantSeparate(new o(le[0],le[1],le[2]),new o(ue[0],ue[1],ue[2]))}else oe=Ar.createByRandomTwoConstant(se.constantMin,se.constantMax);break;case 2:oe=se.separateAxes?Ar.createByRandomTwoGradientSeparate(this._initParticleSize(se.gradientXMin),this._initParticleSize(se.gradientYMin),this._initParticleSize(se.gradientZMin),this._initParticleSize(se.gradientXMax),this._initParticleSize(se.gradientYMax),this._initParticleSize(se.gradientZMax)):Ar.createByRandomTwoGradient(this._initParticleSize(se.gradientMin),this._initParticleSize(se.gradientMax))}var ce=new Vr(oe);ce.enable=ae.enable,_.sizeOverLifetime=ce}var he=e.rotationOverLifetime;if(he){var _e,de=he.angularVelocity;switch(de.type){case 0:if(de.separateAxes){var fe=de.constantSeparate;_e=Mr.createByConstantSeparate(new o(fe[0]*l,fe[1]*l,fe[2]*l))}else _e=Mr.createByConstant(de.constant*l);break;case 1:_e=de.separateAxes?Mr.createByGradientSeparate(this._initParticleRotation(de.gradientX),this._initParticleRotation(de.gradientY),this._initParticleRotation(de.gradientZ)):Mr.createByGradient(this._initParticleRotation(de.gradient));break;case 2:if(de.separateAxes){var me=de.constantMinSeparate,Te=de.constantMaxSeparate;_e=Mr.createByRandomTwoConstantSeparate(new o(me[0]*l,me[1]*l,me[2]*l),new o(Te[0]*l,Te[1]*l,Te[2]*l))}else _e=Mr.createByRandomTwoConstant(de.constantMin*l,de.constantMax*l);break;case 3:de.separateAxes||(_e=Mr.createByRandomTwoGradient(this._initParticleRotation(de.gradientMin),this._initParticleRotation(de.gradientMax)))}var pe=new Lr(_e);pe.enable=he.enable,_.rotationOverLifetime=pe}var ge=e.textureSheetAnimation;if(ge){var Ee,ye=ge.frame;switch(ye.type){case 0:Ee=Cr.createByConstant(ye.constant);break;case 1:Ee=Cr.createByOverTime(this._initParticleFrame(ye.overTime));break;case 2:Ee=Cr.createByRandomTwoConstant(ye.constantMin,ye.constantMax);break;case 3:Ee=Cr.createByRandomTwoOverTime(this._initParticleFrame(ye.overTimeMin),this._initParticleFrame(ye.overTimeMax))}var Se,ve=ge.startFrame;switch(ve.type){case 0:Se=Fr.createByConstant(ve.constant);break;case 1:Se=Fr.createByRandomTwoConstant(ve.constantMin,ve.constantMax)}var Re=new Ur(Ee,Se);Re.enable=ge.enable;var Ce=ge.tiles;Re.tiles=new n(Ce[0],Ce[1]),Re.type=ge.type,Re.randomRow=ge.randomRow;var Me=ge.rowIndex;void 0!==Me&&(Re.rowIndex=Me),Re.cycles=ge.cycles,_.textureSheetAnimation=Re}}},{key:"_initParticleColor",value:function(e){var t=new yr(4,4);if(e){var r,n,i=e.alphas;if(i)for(r=0,n=i.length;r<n;r++){3==r&&n>4&&(r=n-1,console.warn("GradientDataColor warning:alpha data length is large than 4, will ignore the middle data."));var a=i[r];t.addColorAlpha(a.key,a.value)}else t.addColorAlpha(0,1),t.addColorAlpha(1,1);var o=e.rgbs;if(o)for(r=0,n=o.length;r<n;r++){3==r&&n>4&&(r=n-1,console.warn("GradientDataColor warning:rgb data length is large than 4, will ignore the middle data."));var s=o[r],l=s.value;t.addColorRGB(s.key,new De(l[0],l[1],l[2],1))}else t.addColorRGB(0,new De(1,1,1,1)),t.addColorRGB(1,new De(1,1,1,1))}else t.addColorAlpha(0,1),t.addColorAlpha(1,1),t.addColorRGB(0,new De(1,1,1,1)),t.addColorRGB(1,new De(1,1,1,1));return t}},{key:"_initParticleFrame",value:function(e){var t=new Dr;if(e)for(var r=e.frames,n=0,i=r.length;n<i;n++){var a=r[n];t.add(a.key,a.value)}else t.add(0,0),t.add(1,1);return t}},{key:"_initParticleVelocity",value:function(e){for(var t=new xr,r=e.velocitys,n=0,i=r.length;n<i;n++){var a=r[n];t.add(a.key,a.value)}return t}},{key:"_initParticleSize",value:function(e){var t=new xr;if(e)for(var r=e.sizes,n=0,i=r.length;n<i;n++){var a=r[n];t.add(a.key,a.value)}else t.add(0,0),t.add(1,1);return t}},{key:"_initParticleRotation",value:function(e){for(var t=new xr,r=e.angularVelocitys,n=0,i=r.length;n<i;n++){var a=r[n];t.add(a.key,a.value/180*Math.PI)}return t}},{key:"particleSystem",get:function(){return this._particleSystem}},{key:"particleRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){zr.SHADERDEFINE_RENDERMODE_BILLBOARD=ue.getDefineByName("SPHERHBILLBOARD"),zr.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=ue.getDefineByName("STRETCHEDBILLBOARD"),zr.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=ue.getDefineByName("HORIZONTALBILLBOARD"),zr.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=ue.getDefineByName("VERTICALBILLBOARD"),zr.SHADERDEFINE_COLOROVERLIFETIME=ue.getDefineByName("COLOROVERLIFETIME"),zr.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=ue.getDefineByName("RANDOMCOLOROVERLIFETIME"),zr.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=ue.getDefineByName("VELOCITYOVERLIFETIMECONSTANT"),zr.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=ue.getDefineByName("VELOCITYOVERLIFETIMECURVE"),zr.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=ue.getDefineByName("VELOCITYOVERLIFETIMERANDOMCONSTANT"),zr.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=ue.getDefineByName("VELOCITYOVERLIFETIMERANDOMCURVE"),zr.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=ue.getDefineByName("TEXTURESHEETANIMATIONCURVE"),zr.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=ue.getDefineByName("TEXTURESHEETANIMATIONRANDOMCURVE"),zr.SHADERDEFINE_ROTATIONOVERLIFETIME=ue.getDefineByName("ROTATIONOVERLIFETIME"),zr.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=ue.getDefineByName("ROTATIONOVERLIFETIMESEPERATE"),zr.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=ue.getDefineByName("ROTATIONOVERLIFETIMECONSTANT"),zr.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=ue.getDefineByName("ROTATIONOVERLIFETIMECURVE"),zr.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=ue.getDefineByName("ROTATIONOVERLIFETIMERANDOMCONSTANTS"),zr.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=ue.getDefineByName("ROTATIONOVERLIFETIMERANDOMCURVES"),zr.SHADERDEFINE_SIZEOVERLIFETIMECURVE=ue.getDefineByName("SIZEOVERLIFETIMECURVE"),zr.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=ue.getDefineByName("SIZEOVERLIFETIMECURVESEPERATE"),zr.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=ue.getDefineByName("SIZEOVERLIFETIMERANDOMCURVES"),zr.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=ue.getDefineByName("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),zr.SHADERDEFINE_RENDERMODE_MESH=ue.getDefineByName("RENDERMODE_MESH"),zr.SHADERDEFINE_SHAPE=ue.getDefineByName("SHAPE")}},{key:"_initStartLife",value:function(e){for(var t=new xr,r=e.startLifetimes,n=0,i=r.length;n<i;n++){var a=r[n];t.add(a.key,a.value)}return t}}]),ShuriKenParticle3D}(Ot),$r=function SkinnedMeshSprite3DShaderDeclaration(){_classCallCheck(this,SkinnedMeshSprite3DShaderDeclaration)},en=function(e){function SkinnedMeshRenderer(e){var t;return _classCallCheck(this,SkinnedMeshRenderer),(t=_possibleConstructorReturn(this,_getPrototypeOf(SkinnedMeshRenderer).call(this,e)))._bones=[],t._skinnedDataLoopMarks=[],t._localBounds=new At(o._ZERO,o._ZERO),t._cacheAnimationNode=[],t}return _inherits(SkinnedMeshRenderer,e),_createClass(SkinnedMeshRenderer,[{key:"_computeSkinnedData",value:function(){if(this._cacheMesh&&this._cacheAvatar||this._cacheMesh&&!this._cacheAvatar)for(var e=this._cacheMesh._inverseBindPoses,t=this._cacheMesh._skinnedMatrixCaches,r=0,n=this._cacheMesh.subMeshCount;r<n;r++)for(var i=this._cacheMesh.getSubMesh(r)._boneIndicesList,a=this._skinnedData[r],o=0,s=i.length;o<s;o++){var l=i[o];this._computeSubSkinnedData(e,l,a[o],t)}}},{key:"_computeSubSkinnedData",value:function(e,r,n,i){for(var a=0,o=r.length;a<o;a++){var s=r[a];if(this._skinnedDataLoopMarks[s]===t.Stat.loopCount)for(var l=i[s],u=this._skinnedData[l.subMeshIndex][l.batchIndex],c=16*l.batchBoneIndex,h=16*a,_=0;_<16;_++)n[h+_]=u[c+_];else this._cacheAvatar?P._mulMatrixArray(this._cacheAnimationNode[s].transform.getWorldMatrix(),e[s].elements,0,n,16*a):P._mulMatrixArray(this._bones[s].transform.worldMatrix.elements,e[s].elements,0,n,16*a),this._skinnedDataLoopMarks[s]=t.Stat.loopCount}}},{key:"_onWorldMatNeedChange",value:function(e){this._boundsChange=!0,this._octreeNode&&(this._cacheAvatar?-1===this._indexInOctreeMotionList&&this._octreeNode._octree.addMotionObject(this):(e&=f.TRANSFORM_WORLDPOSITION|f.TRANSFORM_WORLDQUATERNION|f.TRANSFORM_WORLDSCALE)&&-1===this._indexInOctreeMotionList&&this._octreeNode._octree.addMotionObject(this))}},{key:"_createRenderElement",value:function(){return new kt}},{key:"_onMeshChange",value:function(e){_get(_getPrototypeOf(SkinnedMeshRenderer.prototype),"_onMeshChange",this).call(this,e),this._cacheMesh=e;var t=e.subMeshCount;this._skinnedData=[],this._skinnedDataLoopMarks.length=e._inverseBindPoses.length;for(var r=0;r<t;r++)for(var n=e.getSubMesh(r)._boneIndicesList,i=n.length,a=this._skinnedData[r]=[],o=0;o<i;o++)a[o]=new Float32Array(16*n[o].length);this._cacheAvatar&&e&&this._getCacheAnimationNodes()}},{key:"_setCacheAnimator",value:function(e){this._cacheAnimator=e,this._shaderValues.addDefine($r.SHADERDEFINE_BONE),this._setRootNode()}},{key:"_calculateBoundingBox",value:function(){if(this._cacheAvatar)if(this._cacheAnimator&&this._rootBone){var e=SkinnedMeshRenderer._tempMatrix4x4;P.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,this._cacheRootAnimationNode.transform.getWorldMatrix(),e),this._localBounds._tranform(e,this._bounds)}else _get(_getPrototypeOf(SkinnedMeshRenderer.prototype),"_calculateBoundingBox",this).call(this);else this._cacheRootBone?this._localBounds._tranform(this._cacheRootBone.transform.worldMatrix,this._bounds):this._localBounds._tranform(this._owner.transform.worldMatrix,this._bounds);if(t.Render.supportWebGLPlusCulling){var r=this._bounds.getMin(),n=this._bounds.getMax(),i=Ie._cullingBuffer;i[this._cullingBufferIndex+1]=r.x,i[this._cullingBufferIndex+2]=r.y,i[this._cullingBufferIndex+3]=r.z,i[this._cullingBufferIndex+4]=n.x,i[this._cullingBufferIndex+5]=n.y,i[this._cullingBufferIndex+6]=n.z}}},{key:"_renderUpdate",value:function(e,t){if(this._cacheAnimator)if(this._computeSkinnedData(),this._cacheAvatar){var r=this._cacheAnimator.owner._transform;this._shaderValues.setMatrix4x4(et.WORLDMATRIX,r.worldMatrix)}else this._shaderValues.setMatrix4x4(et.WORLDMATRIX,c.DEFAULT);else this._shaderValues.setMatrix4x4(et.WORLDMATRIX,t.worldMatrix)}},{key:"_renderUpdateWithCamera",value:function(e,t){var r=e.projectionViewMatrix;if(this._cacheAnimator)if(this._cacheAvatar){var n=this._cacheAnimator.owner._transform;c.multiply(r,n.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(et.MVPMATRIX,this._projectionViewWorldMatrix)}else this._shaderValues.setMatrix4x4(et.MVPMATRIX,r);else c.multiply(r,t.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(et.MVPMATRIX,this._projectionViewWorldMatrix)}},{key:"_destroy",value:function(){_get(_getPrototypeOf(SkinnedMeshRenderer.prototype),"_destroy",this).call(this),this._cacheAvatar?this._cacheRootAnimationNode&&this._cacheRootAnimationNode.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._cacheRootBone?!this._cacheRootBone.destroyed&&this._cacheRootBone.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._owner&&!this._owner.destroyed&&this._owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange)}},{key:"_setRootBone",value:function(e){this._rootBone=e,this._setRootNode()}},{key:"_setRootNode",value:function(){var e;e=this._cacheAnimator&&this._rootBone&&this._cacheAvatar?this._cacheAnimator._avatarNodeMap[this._rootBone]:null,this._cacheRootAnimationNode!=e&&(this._onWorldMatNeedChange(f.TRANSFORM_WORLDPOSITION|f.TRANSFORM_WORLDQUATERNION|f.TRANSFORM_WORLDSCALE),this._owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._cacheRootAnimationNode&&this._cacheRootAnimationNode.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),e&&e.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._cacheRootAnimationNode=e)}},{key:"_getCacheAnimationNodes",value:function(){var e=this._cacheMesh._boneNames,r=this._cacheMesh._inverseBindPoses.length;if(t.Render.supportWebGLPlusAnimation){this._cacheAnimationNodeIndices=new Uint16Array(r);var n=this._cacheAnimator._avatarNodeMap;for(o=0;o<r;o++){var i=n[e[o]];this._cacheAnimationNodeIndices[o]=i?i._worldMatrixIndex:0}}else{this._cacheAnimationNode.length=r;for(var a=this._cacheAnimator._avatarNodeMap,o=0;o<r;o++){var s=a[e[o]];this._cacheAnimationNode[o]=s}}}},{key:"_setCacheAvatar",value:function(e){this._cacheAvatar!==e&&(this._cacheMesh?(this._cacheAvatar=e,e&&(this._shaderValues.addDefine($r.SHADERDEFINE_BONE),this._getCacheAnimationNodes())):this._cacheAvatar=e,this._setRootNode())}},{key:"_computeSubSkinnedDataNative",value:function(e,r,n,i,a){t.LayaGL.instance.computeSubSkinnedData(e,r,n,i,a)}},{key:"_computeSkinnedDataForNative",value:function(){if(this._cacheMesh&&this._cacheAvatar||this._cacheMesh&&!this._cacheAvatar)for(var e=this._cacheMesh._inverseBindPoses,r=this._cacheMesh._skinnedMatrixCaches,n=0,i=this._cacheMesh.subMeshCount;n<i;n++)for(var a=this._cacheMesh.getSubMesh(n)._boneIndicesList,o=this._skinnedData[n],s=0,l=a.length;s<l;s++){var u=a[s];this._cacheAvatar&&t.Render.supportWebGLPlusAnimation?this._computeSubSkinnedDataNative(this._cacheAnimator._animationNodeWorldMatrixs,this._cacheAnimationNodeIndices,this._cacheMesh._inverseBindPosesBuffer,u,o[s]):this._computeSubSkinnedData(e,u,o[s],r)}}},{key:"localBounds",get:function(){return this._localBounds},set:function(e){this._localBounds=e}},{key:"rootBone",get:function(){return this._cacheRootBone},set:function(e){this._cacheRootBone!=e&&(this._cacheRootBone?this._cacheRootBone.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),e?e.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._owner.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._cacheRootBone=e,this._onWorldMatNeedChange(f.TRANSFORM_WORLDPOSITION|f.TRANSFORM_WORLDQUATERNION|f.TRANSFORM_WORLDSCALE))}},{key:"bones",get:function(){return this._bones}},{key:"bounds",get:function(){return(this._boundsChange||this._cacheAvatar)&&(this._calculateBoundingBox(),this._boundsChange=!1),this._bounds}}]),SkinnedMeshRenderer}(dr);en._tempMatrix4x4=new c;var tn=function(e){function SkinnedMeshSprite3D(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return _classCallCheck(this,SkinnedMeshSprite3D),(e=_possibleConstructorReturn(this,_getPrototypeOf(SkinnedMeshSprite3D).call(this,r)))._meshFilter=new fr(_assertThisInitialized(e)),e._render=new en(_assertThisInitialized(e)),t&&(e._meshFilter.sharedMesh=t),e}return _inherits(SkinnedMeshSprite3D,e),_createClass(SkinnedMeshSprite3D,[{key:"_parse",value:function(e,r){_get(_getPrototypeOf(SkinnedMeshSprite3D.prototype),"_parse",this).call(this,e,r);var n=this.skinnedMeshRenderer,a=e.lightmapIndex;null!=a&&(n.lightmapIndex=a);var s,l=e.lightmapScaleOffset;if(l&&(n.lightmapScaleOffset=new i(l[0],l[1],l[2],l[3])),null!=e.enableRender&&(n.enable=e.enableRender),null!=e.receiveShadows&&(n.receiveShadow=e.receiveShadows),null!=e.castShadow&&(n.castShadow=e.castShadow),s=e.meshPath){var u=t.Loader.getRes(s);u&&(this.meshFilter.sharedMesh=u)}var c=e.materials;if(c){var h=n.sharedMaterials,_=c.length;h.length=_;for(var d=0;d<_;d++)h[d]=t.Loader.getRes(c[d].path);n.sharedMaterials=h}var f=e.boundBox,m=f.min,T=f.max;if(n.localBounds.setMin(new o(m[0],m[1],m[2])),n.localBounds.setMax(new o(T[0],T[1],T[2])),r){var p=e.rootBone;n.rootBone=r[p];var g,E=e.bones;for(d=0,g=E.length;d<g;d++)n.bones.push(r[E[d]])}else e.rootBone&&n._setRootBone(e.rootBone)}},{key:"_changeHierarchyAnimator",value:function(e){_get(_getPrototypeOf(SkinnedMeshSprite3D.prototype),"_changeHierarchyAnimator",this).call(this,e),this.skinnedMeshRenderer._setCacheAnimator(e)}},{key:"_changeAnimatorAvatar",value:function(e){this.skinnedMeshRenderer._setCacheAvatar(e)}},{key:"_cloneTo",value:function(e,t,r){var n=e;n.meshFilter.sharedMesh=this.meshFilter.sharedMesh;var i=this._render,a=n._render;a.enable=i.enable,a.sharedMaterials=i.sharedMaterials,a.castShadow=i.castShadow;var o=i.lightmapScaleOffset;o&&(a.lightmapScaleOffset=o.clone()),a.receiveShadow=i.receiveShadow,a.sortingFudge=i.sortingFudge,a._rootBone=i._rootBone;var s=i.bones,l=a.bones,u=s.length;l.length=u;var c=i.rootBone;if(c){var h=P._getHierarchyPath(t,c,SkinnedMeshSprite3D._tempArray0);a.rootBone=h?P._getNodeByHierarchyPath(r,h):c}for(var _=0;_<s.length;_++)h=P._getHierarchyPath(t,s[_],SkinnedMeshSprite3D._tempArray0),l[_]=h?P._getNodeByHierarchyPath(r,h):s[_];var d=i.localBounds;d&&d.cloneTo(a.localBounds),_get(_getPrototypeOf(SkinnedMeshSprite3D.prototype),"_cloneTo",this).call(this,e,t,r)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(SkinnedMeshSprite3D.prototype),"destroy",this).call(this,e),this._meshFilter.destroy())}},{key:"_create",value:function(){return new SkinnedMeshSprite3D}},{key:"meshFilter",get:function(){return this._meshFilter}},{key:"skinnedMeshRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){$r.SHADERDEFINE_BONE=ue.getDefineByName("BONE"),$r.SHADERDEFINE_SIMPLEBONE=ue.getDefineByName("SIMPLEBONE")}}]),SkinnedMeshSprite3D}(Ot);tn._tempArray0=[],tn.BONES=ue.propertyNameToID("u_Bones"),tn.SIMPLE_SIMPLEANIMATORTEXTURE=ue.propertyNameToID("u_SimpleAnimatorTexture"),tn.SIMPLE_SIMPLEANIMATORPARAMS=ue.propertyNameToID("u_SimpleAnimatorParams"),tn.SIMPLE_SIMPLEANIMATORTEXTURESIZE=ue.propertyNameToID("u_SimpleAnimatorTextureSize");var rn=function(e){function TrailMaterial(){var e;return _classCallCheck(this,TrailMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(TrailMaterial).call(this))).setShaderName("Trail"),e._color=new i(1,1,1,1),e._shaderValues.setVector(TrailMaterial.TINTCOLOR,new i(1,1,1,1)),e.renderMode=TrailMaterial.RENDERMODE_ALPHABLENDED,e}return _inherits(TrailMaterial,e),_createClass(TrailMaterial,[{key:"clone",value:function(){var e=new TrailMaterial;return this.cloneTo(e),e}},{key:"_TintColorR",get:function(){return this._color.x},set:function(e){this._color.x=e,this.color=this._color}},{key:"_TintColorG",get:function(){return this._color.y},set:function(e){this._color.y=e,this.color=this._color}},{key:"_TintColorB",get:function(){return this._color.z},set:function(e){this._color.z=e,this.color=this._color}},{key:"_TintColorA",get:function(){return this._color.w},set:function(e){this._color.w=e,this.color=this._color}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(TrailMaterial.TILINGOFFSET).x},set:function(e){var t=this._shaderValues.getVector(TrailMaterial.TILINGOFFSET);t.x=e,this.tilingOffset=t}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(TrailMaterial.TILINGOFFSET).y},set:function(e){var t=this._shaderValues.getVector(TrailMaterial.TILINGOFFSET);t.y=e,this.tilingOffset=t}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(TrailMaterial.TILINGOFFSET).z},set:function(e){var t=this._shaderValues.getVector(TrailMaterial.TILINGOFFSET);t.z=e,this.tilingOffset=t}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(TrailMaterial.TILINGOFFSET).w},set:function(e){var t=this._shaderValues.getVector(TrailMaterial.TILINGOFFSET);t.w=e,this.tilingOffset=t}},{key:"renderMode",set:function(e){switch(e){case TrailMaterial.RENDERMODE_ADDTIVE:this.renderQueue=me.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=pe.CULL_NONE,this.blend=pe.BLEND_ENABLE_ALL,this.blendSrc=pe.BLENDPARAM_SRC_ALPHA,this.blendDst=pe.BLENDPARAM_ONE,this.depthTest=pe.DEPTHTEST_LESS,this._shaderValues.addDefine(TrailMaterial.SHADERDEFINE_ADDTIVEFOG);break;case TrailMaterial.RENDERMODE_ALPHABLENDED:this.renderQueue=me.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=pe.CULL_NONE,this.blend=pe.BLEND_ENABLE_ALL,this.blendSrc=pe.BLENDPARAM_SRC_ALPHA,this.blendDst=pe.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=pe.DEPTHTEST_LESS,this._shaderValues.removeDefine(TrailMaterial.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("TrailMaterial : renderMode value error.")}}},{key:"colorR",get:function(){return this._TintColorR},set:function(e){this._TintColorR=e}},{key:"colorG",get:function(){return this._TintColorG},set:function(e){this._TintColorG=e}},{key:"colorB",get:function(){return this._TintColorB},set:function(e){this._TintColorB=e}},{key:"colorA",get:function(){return this._TintColorA},set:function(e){this._TintColorA=e}},{key:"color",get:function(){return this._shaderValues.getVector(TrailMaterial.TINTCOLOR)},set:function(e){this._shaderValues.setVector(TrailMaterial.TINTCOLOR,e)}},{key:"texture",get:function(){return this._shaderValues.getTexture(TrailMaterial.MAINTEXTURE)},set:function(e){e?this._shaderValues.addDefine(TrailMaterial.SHADERDEFINE_MAINTEXTURE):this._shaderValues.removeDefine(TrailMaterial.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(TrailMaterial.MAINTEXTURE,e)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(TrailMaterial.TILINGOFFSET)},set:function(e){e&&(1!=e.x||1!=e.y||0!=e.z||0!=e.w)?this._shaderValues.addDefine(TrailMaterial.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(TrailMaterial.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(TrailMaterial.TILINGOFFSET,e)}},{key:"depthWrite",set:function(e){this._shaderValues.setBool(TrailMaterial.DEPTH_WRITE,e)},get:function(){return this._shaderValues.getBool(TrailMaterial.DEPTH_WRITE)}},{key:"cull",set:function(e){this._shaderValues.setInt(TrailMaterial.CULL,e)},get:function(){return this._shaderValues.getInt(TrailMaterial.CULL)}},{key:"blend",set:function(e){this._shaderValues.setInt(TrailMaterial.BLEND,e)},get:function(){return this._shaderValues.getInt(TrailMaterial.BLEND)}},{key:"blendSrc",set:function(e){this._shaderValues.setInt(TrailMaterial.BLEND_SRC,e)},get:function(){return this._shaderValues.getInt(TrailMaterial.BLEND_SRC)}},{key:"blendDst",set:function(e){this._shaderValues.setInt(TrailMaterial.BLEND_DST,e)},get:function(){return this._shaderValues.getInt(TrailMaterial.BLEND_DST)}},{key:"depthTest",set:function(e){this._shaderValues.setInt(TrailMaterial.DEPTH_TEST,e)},get:function(){return this._shaderValues.getInt(TrailMaterial.DEPTH_TEST)}}],[{key:"__initDefine__",value:function(){TrailMaterial.SHADERDEFINE_MAINTEXTURE=ue.getDefineByName("MAINTEXTURE"),TrailMaterial.SHADERDEFINE_TILINGOFFSET=ue.getDefineByName("TILINGOFFSET"),TrailMaterial.SHADERDEFINE_ADDTIVEFOG=ue.getDefineByName("ADDTIVEFOG")}}]),TrailMaterial}(me);rn.RENDERMODE_ALPHABLENDED=0,rn.RENDERMODE_ADDTIVE=1,rn.MAINTEXTURE=ue.propertyNameToID("u_MainTexture"),rn.TINTCOLOR=ue.propertyNameToID("u_MainColor"),rn.TILINGOFFSET=ue.propertyNameToID("u_TilingOffset"),rn.CULL=ue.propertyNameToID("s_Cull"),rn.BLEND=ue.propertyNameToID("s_Blend"),rn.BLEND_SRC=ue.propertyNameToID("s_BlendSrc"),rn.BLEND_DST=ue.propertyNameToID("s_BlendDst"),rn.DEPTH_TEST=ue.propertyNameToID("s_DepthTest"),rn.DEPTH_WRITE=ue.propertyNameToID("s_DepthWrite");var nn,an=function TextureMode(){_classCallCheck(this,TextureMode)};an.Stretch=0,an.Tile=1,(nn=e.TrailAlignment||(e.TrailAlignment={}))[nn.View=0]="View",nn[nn.TransformZ=1]="TransformZ";var on=function(){function VertexTrail(){_classCallCheck(this,VertexTrail)}return _createClass(VertexTrail,[{key:"vertexDeclaration",get:function(){return VertexTrail._vertexDeclaration1}}],[{key:"__init__",value:function(){VertexTrail._vertexDeclaration1=new je(32,[new Ze(0,Ye.Vector3,VertexTrail.TRAIL_POSITION0),new Ze(12,Ye.Vector3,VertexTrail.TRAIL_OFFSETVECTOR),new Ze(24,Ye.Single,VertexTrail.TRAIL_TIME0),new Ze(28,Ye.Single,VertexTrail.TRAIL_TEXTURECOORDINATE0Y)]),VertexTrail._vertexDeclaration2=new je(20,[new Ze(0,Ye.Single,VertexTrail.TRAIL_TEXTURECOORDINATE0X),new Ze(4,Ye.Color,VertexTrail.TRAIL_COLOR)])}},{key:"vertexDeclaration1",get:function(){return VertexTrail._vertexDeclaration1}},{key:"vertexDeclaration2",get:function(){return VertexTrail._vertexDeclaration2}}]),VertexTrail}();on.TRAIL_POSITION0=0,on.TRAIL_OFFSETVECTOR=1,on.TRAIL_TIME0=2,on.TRAIL_TEXTURECOORDINATE0Y=3,on.TRAIL_TEXTURECOORDINATE0X=4,on.TRAIL_COLOR=5;var sn=function(n){function TrailGeometry(e){var r;_classCallCheck(this,TrailGeometry),(r=_possibleConstructorReturn(this,_getPrototypeOf(TrailGeometry).call(this)))._floatCountPerVertices1=8,r._floatCountPerVertices2=5,r._increaseSegementCount=16,r._activeIndex=0,r._endIndex=0,r._needAddFirstVertex=!1,r._isTempEndVertex=!1,r._vertices1=null,r._vertices2=null,r._lastFixedVertexPosition=new o,r._bufferState=new We,r.tmpColor=new De,r._disappearBoundsMode=!1,r._owner=e,r._segementCount=r._increaseSegementCount,r._resizeData(r._segementCount,r._bufferState);var n=r._owner._owner.trailRenderer.bounds,i=r._owner._owner.transform.position;return n.setMin(i),n.setMax(i),t.Render.supportWebGLPlusCulling&&r._calculateBoundingBoxForNative(),r}return _inherits(TrailGeometry,n),_createClass(TrailGeometry,[{key:"_resizeData",value:function(e,r){this._subBirthTime=new Float32Array(e),this._subDistance=new Float64Array(e);var n=t.LayaGL.instance,i=2*e,a=on.vertexDeclaration1,o=on.vertexDeclaration2,s=[],l=i*a.vertexStride,u=i*o.vertexStride,c=l+u;this._vertices1=new Float32Array(i*this._floatCountPerVertices1),this._vertices2=new Float32Array(i*this._floatCountPerVertices2),this._vertexBuffer1=new qe(l,n.STATIC_DRAW,!1),this._vertexBuffer1.vertexDeclaration=a,this._vertexBuffer2=new qe(u,n.DYNAMIC_DRAW,!1),this._vertexBuffer2.vertexDeclaration=o,s.push(this._vertexBuffer1),s.push(this._vertexBuffer2),r.bind(),r.applyVertexBuffers(s),r.unBind(),t.Resource._addMemory(c,c)}},{key:"_resetData",value:function(){var e=this._endIndex-this._activeIndex,r=new Float32Array(this._vertices1.buffer,2*this._floatCountPerVertices1*this._activeIndex*4,2*this._floatCountPerVertices1*e),n=new Float32Array(this._vertices2.buffer,2*this._floatCountPerVertices2*this._activeIndex*4,2*this._floatCountPerVertices2*e),i=new Float64Array(this._subDistance.buffer,8*this._activeIndex,e),a=new Float32Array(this._subBirthTime.buffer,4*this._activeIndex,e);if(e===this._segementCount){this._vertexBuffer1.destroy(),this._vertexBuffer2.destroy();var o=this._vertexBuffer1._byteLength+this._vertexBuffer2._byteLength;t.Resource._addMemory(-o,-o),this._segementCount+=this._increaseSegementCount,this._resizeData(this._segementCount,this._bufferState)}this._vertices1.set(r,0),this._vertices2.set(n,0),this._subDistance.set(i,0),this._subBirthTime.set(a,0),this._endIndex=e,this._activeIndex=0,this._vertexBuffer1.setData(this._vertices1.buffer,0,2*this._floatCountPerVertices1*this._activeIndex*4,2*this._floatCountPerVertices1*e*4),this._vertexBuffer2.setData(this._vertices2.buffer,0,2*this._floatCountPerVertices2*this._activeIndex*4,2*this._floatCountPerVertices2*e*4)}},{key:"_updateTrail",value:function(e,t,r){o.equals(t,r)||(this._endIndex-this._activeIndex==0?this._addTrailByFirstPosition(e,r):this._addTrailByNextPosition(e,r))}},{key:"_addTrailByFirstPosition",value:function(e,t){this._endIndex===this._segementCount&&this._resetData(),this._subDistance[this._endIndex]=0,this._subBirthTime[this._endIndex]=this._owner._curtime,this._endIndex++,t.cloneTo(this._lastFixedVertexPosition),this._needAddFirstVertex=!0}},{key:"_addTrailByNextPosition",value:function(t,n){var i=TrailGeometry._tempVector30,a=TrailGeometry._tempVector31;switch(this._owner.alignment){case e.TrailAlignment.View:var s=t.viewMatrix;o.transformCoordinate(n,s,TrailGeometry._tempVector33),o.transformCoordinate(this._lastFixedVertexPosition,s,TrailGeometry._tempVector34),o.subtract(TrailGeometry._tempVector33,TrailGeometry._tempVector34,i),o.cross(TrailGeometry._tempVector33,i,a);break;case e.TrailAlignment.TransformZ:o.subtract(n,this._lastFixedVertexPosition,i);var l=TrailGeometry._tempVector32;this._owner._owner.transform.getForward(l),o.cross(i,l,a)}o.normalize(a,a),o.scale(a,this._owner.widthMultiplier/2,a);var u,c,h=o.scalarLength(i);this._needAddFirstVertex&&(this._updateVerticesByPositionData(n,a,this._endIndex-1),this._needAddFirstVertex=!1),h-this._owner.minVertexDistance>=r.zeroTolerance?(this._isTempEndVertex?(u=this._endIndex-1,c=h-this._subDistance[u],this._updateVerticesByPosition(n,a,h,u),this._owner._totalLength+=c):(this._endIndex===this._segementCount&&this._resetData(),this._updateVerticesByPosition(n,a,h,this._endIndex),this._owner._totalLength+=h,this._endIndex++),n.cloneTo(this._lastFixedVertexPosition),this._isTempEndVertex=!1):(this._isTempEndVertex?(u=this._endIndex-1,c=h-this._subDistance[u],this._updateVerticesByPosition(n,a,h,u),this._owner._totalLength+=c):(this._endIndex===this._segementCount&&this._resetData(),this._updateVerticesByPosition(n,a,h,this._endIndex),this._owner._totalLength+=h,this._endIndex++),this._isTempEndVertex=!0)}},{key:"_updateVerticesByPositionData",value:function(e,r,n){var i=2*this._floatCountPerVertices1*n,a=this._owner._curtime;this._vertices1[i]=e.x,this._vertices1[i+1]=e.y,this._vertices1[i+2]=e.z,this._vertices1[i+3]=-r.x,this._vertices1[i+4]=-r.y,this._vertices1[i+5]=-r.z,this._vertices1[i+6]=a,this._vertices1[i+7]=1,this._vertices1[i+8]=e.x,this._vertices1[i+9]=e.y,this._vertices1[i+10]=e.z,this._vertices1[i+11]=r.x,this._vertices1[i+12]=r.y,this._vertices1[i+13]=r.z,this._vertices1[i+14]=a,this._vertices1[i+15]=0;var s=this._owner._owner.trailRenderer.bounds,l=s.getMin(),u=s.getMax(),c=TrailGeometry._tempVector35,h=TrailGeometry._tempVector36,_=TrailGeometry._tempVector32;o.add(e,r,c),o.subtract(e,r,h),o.min(h,c,_),o.min(l,_,l),s.setMin(l),o.max(c,h,_),o.max(u,_,u),s.setMax(u),t.Render.supportWebGLPlusCulling&&this._calculateBoundingBoxForNative();var d=2*this._floatCountPerVertices1;this._vertexBuffer1.setData(this._vertices1.buffer,4*i,4*i,4*d)}},{key:"_updateVerticesByPosition",value:function(e,t,r,n){this._updateVerticesByPositionData(e,t,n),this._subDistance[n]=r,this._subBirthTime[n]=this._owner._curtime}},{key:"_updateVertexBufferUV",value:function(){var e,r,n;if(this._disappearBoundsMode){e=this._owner._owner.trailRenderer.bounds;var i=this._owner._owner.transform.position;e.setMin(i),e.setMax(i),r=e.getMin(),n=e.getMax(),t.Render.supportWebGLPlusCulling&&this._calculateBoundingBoxForNative()}for(var a=this._endIndex,s=0,l=this._owner.colorGradient,u=l.colorAlphaKeysCount-1,c=l.colorRGBKeysCount-1,h=this._owner._totalLength,_=2*this._floatCountPerVertices2,d=this._activeIndex;d<a;d++){var f,m;d!==this._activeIndex&&(s+=this._subDistance[d]),this._owner.textureMode==an.Stretch?m=f=1-s/h:(m=1-s/h,f=1-(h-s)),c=l.evaluateColorRGB(m,this.tmpColor,c,!0),u=l.evaluateColorAlpha(m,this.tmpColor,u,!0);var T=d*_;if(this._vertices2[T+0]=f,this._vertices2[T+1]=this.tmpColor.r,this._vertices2[T+2]=this.tmpColor.g,this._vertices2[T+3]=this.tmpColor.b,this._vertices2[T+4]=this.tmpColor.a,this._vertices2[T+5]=f,this._vertices2[T+6]=this.tmpColor.r,this._vertices2[T+7]=this.tmpColor.g,this._vertices2[T+8]=this.tmpColor.b,this._vertices2[T+9]=this.tmpColor.a,this._disappearBoundsMode){var p=2*this._floatCountPerVertices1*d,g=TrailGeometry._tempVector32,E=TrailGeometry._tempVector33,y=TrailGeometry._tempVector34;g.setValue(this._vertices1[p+0],this._vertices1[p+1],this._vertices1[p+2]),E.setValue(this._vertices1[p+3],this._vertices1[p+4],this._vertices1[p+5]),o.add(g,E,y),o.min(y,r,r),o.max(y,n,n),o.subtract(g,E,y),o.min(y,r,r),o.max(y,n,n)}}this._disappearBoundsMode&&(e.setMin(r),e.setMax(n),this._disappearBoundsMode=!1,t.Render.supportWebGLPlusCulling&&this._calculateBoundingBoxForNative());var S=this._activeIndex*_;this._vertexBuffer2.setData(this._vertices2.buffer,4*S,4*S,4*(a*_-S))}},{key:"_updateDisappear",value:function(){for(var e=this._endIndex,t=this._activeIndex;t<e&&this._owner._curtime-this._subBirthTime[t]>=this._owner.time+r.zeroTolerance;t++){var n=t+1;if(n!==e&&(this._owner._totalLength-=this._subDistance[n]),this._isTempEndVertex&&n===e-1){this._floatCountPerVertices1;var i=this._lastFixedVertexPosition;i.x=this._vertices1[0],i.y=this._vertices1[1],i.z=this._vertices1[2],this._isTempEndVertex=!1}this._activeIndex++,this._disappearBoundsMode=!0}}},{key:"_getType",value:function(){return TrailGeometry._type}},{key:"_prepareRender",value:function(e){return this._endIndex-this._activeIndex>1}},{key:"_render",value:function(e){this._bufferState.bind();var r=t.LayaGL.instance,n=2*this._activeIndex,i=2*this._endIndex-n;r.drawArrays(r.TRIANGLE_STRIP,n,i),t.Stat.renderBatches++,t.Stat.trianglesFaces+=i-2}},{key:"destroy",value:function(){_get(_getPrototypeOf(TrailGeometry.prototype),"destroy",this).call(this);var e=this._vertexBuffer1._byteLength+this._vertexBuffer2._byteLength;t.Resource._addMemory(-e,-e),this._bufferState.destroy(),this._vertexBuffer1.destroy(),this._vertexBuffer2.destroy(),this._bufferState=null,this._vertices1=null,this._vertexBuffer1=null,this._vertices2=null,this._vertexBuffer2=null,this._subBirthTime=null,this._subDistance=null,this._lastFixedVertexPosition=null,this._disappearBoundsMode=!1}},{key:"_calculateBoundingBoxForNative",value:function(){var e=this._owner._owner.trailRenderer,t=e.bounds,r=t.getMin(),n=t.getMax(),i=Ie._cullingBuffer;i[e._cullingBufferIndex+1]=r.x,i[e._cullingBufferIndex+2]=r.y,i[e._cullingBufferIndex+3]=r.z,i[e._cullingBufferIndex+4]=n.x,i[e._cullingBufferIndex+5]=n.y,i[e._cullingBufferIndex+6]=n.z}},{key:"clear",value:function(){this._activeIndex=0,this._endIndex=0,this._disappearBoundsMode=!1,this._subBirthTime.fill(0),this._subDistance.fill(0),this._segementCount=0,this._isTempEndVertex=!1,this._needAddFirstVertex=!1,this._lastFixedVertexPosition.setValue(0,0,0)}}]),TrailGeometry}(It);sn.ALIGNMENT_VIEW=0,sn.ALIGNMENT_TRANSFORM_Z=1,sn._tempVector30=new o,sn._tempVector31=new o,sn._tempVector32=new o,sn._tempVector33=new o,sn._tempVector34=new o,sn._tempVector35=new o,sn._tempVector36=new o,sn._type=It._typeCounter++;var ln=function(){function TrailFilter(e){_classCallCheck(this,TrailFilter),this._totalLength=0,this._lastPosition=new o,this._curtime=0,this.alignment=TrailFilter.ALIGNMENT_VIEW,this._owner=e,this._initDefaultData(),this.addRenderElement()}return _createClass(TrailFilter,[{key:"addRenderElement",value:function(){var e=this._owner._render,t=e._renderElements,r=e.sharedMaterials[0];r||(r=rn.defaultMaterial);var n=new kt;n.setTransform(this._owner._transform),n.render=e,n.material=r,this._trialGeometry=new sn(this),n.setGeometry(this._trialGeometry),t.push(n)}},{key:"_update",value:function(e){var t=this._owner._render;this._curtime+=e.scene.timer._delta/1e3,t._shaderValues.setNumber(TrailFilter.CURTIME,this._curtime);var r=this._owner.transform.position,n=t._renderElements[0]._geometry;n._updateDisappear(),n._updateTrail(e.camera,this._lastPosition,r),n._updateVertexBufferUV(),r.cloneTo(this._lastPosition)}},{key:"_initDefaultData",value:function(){this.time=5,this.minVertexDistance=.1,this.widthMultiplier=1,this.textureMode=an.Stretch;var e=[],t=new U;t.time=0,t.inTangent=0,t.outTangent=0,t.value=1,e.push(t);var r=new U;r.time=1,r.inTangent=0,r.outTangent=0,r.value=1,e.push(r),this.widthCurve=e;var n=new yr(2,2);n.mode=gr.Blend,n.addColorRGB(0,De.WHITE),n.addColorRGB(1,De.WHITE),n.addColorAlpha(0,1),n.addColorAlpha(1,1),this.colorGradient=n}},{key:"destroy",value:function(){this._trialGeometry.destroy(),this._trialGeometry=null,this._widthCurve=null,this._colorGradient=null}},{key:"clear",value:function(){this._trialGeometry.clear(),this._lastPosition.setValue(0,0,0),this._curtime=0,this._totalLength=0}},{key:"time",get:function(){return this._time},set:function(e){this._time=e,this._owner._render._shaderValues.setNumber(TrailFilter.LIFETIME,e)}},{key:"minVertexDistance",get:function(){return this._minVertexDistance},set:function(e){this._minVertexDistance=e}},{key:"widthMultiplier",get:function(){return this._widthMultiplier},set:function(e){this._widthMultiplier=e}},{key:"widthCurve",get:function(){return this._widthCurve},set:function(e){this._widthCurve=e;var t,r,n=new Float32Array(4*e.length),i=0;for(t=0,r=e.length;t<r;t++)n[i++]=e[t].time,n[i++]=e[t].inTangent,n[i++]=e[t].outTangent,n[i++]=e[t].value;this._owner._render._shaderValues.setBuffer(TrailFilter.WIDTHCURVE,n),this._owner._render._shaderValues.setInt(TrailFilter.WIDTHCURVEKEYLENGTH,e.length)}},{key:"colorGradient",get:function(){return this._colorGradient},set:function(e){this._colorGradient=e}},{key:"textureMode",get:function(){return this._textureMode},set:function(e){this._textureMode=e}}]),TrailFilter}();ln.CURTIME=ue.propertyNameToID("u_CurTime"),ln.LIFETIME=ue.propertyNameToID("u_LifeTime"),ln.WIDTHCURVE=ue.propertyNameToID("u_WidthCurve"),ln.WIDTHCURVEKEYLENGTH=ue.propertyNameToID("u_WidthCurveKeyLength"),ln.ALIGNMENT_VIEW=0,ln.ALIGNMENT_TRANSFORM_Z=1;var un=function(e){function TrailRenderer(e){var t;return _classCallCheck(this,TrailRenderer),(t=_possibleConstructorReturn(this,_getPrototypeOf(TrailRenderer).call(this,e)))._projectionViewWorldMatrix=new c,t}return _inherits(TrailRenderer,e),_createClass(TrailRenderer,[{key:"_calculateBoundingBox",value:function(){}},{key:"_needRender",value:function(e,t){return this._owner.trailFilter._update(t),!e||e.intersects(this.bounds._getBoundBox())}},{key:"_updateForNative",value:function(e){this._owner.trailFilter._update(e)}},{key:"_renderUpdate",value:function(e,t){_get(_getPrototypeOf(TrailRenderer.prototype),"_renderUpdate",this).call(this,e,t)}},{key:"_renderUpdateWithCamera",value:function(e,t){var r=e.projectionViewMatrix;t?(c.multiply(r,t.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(et.MVPMATRIX,this._projectionViewWorldMatrix)):this._shaderValues.setMatrix4x4(et.MVPMATRIX,r)}}]),TrailRenderer}(Ut),cn=function(e){function TrailSprite3D(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return _classCallCheck(this,TrailSprite3D),(e=_possibleConstructorReturn(this,_getPrototypeOf(TrailSprite3D).call(this,t)))._render=new un(_assertThisInitialized(e)),e._geometryFilter=new ln(_assertThisInitialized(e)),e}return _inherits(TrailSprite3D,e),_createClass(TrailSprite3D,[{key:"_parse",value:function(e,r){_get(_getPrototypeOf(TrailSprite3D.prototype),"_parse",this).call(this,e,r);var n,i,a=this._render,o=this._geometryFilter,s=e.materials;if(s){var l=a.sharedMaterials,u=s.length;for(l.length=u,n=0;n<u;n++)l[n]=t.Loader.getRes(s[n].path);a.sharedMaterials=l}o.time=e.time,o.minVertexDistance=e.minVertexDistance,o.widthMultiplier=e.widthMultiplier,o.textureMode=e.textureMode,null!=e.alignment&&(o.alignment=e.alignment);var c=[],h=e.widthCurve;for(n=0,i=h.length;n<i;n++){var _=new U;_.time=h[n].time,_.inTangent=h[n].inTangent,_.outTangent=h[n].outTangent,_.value=h[n].value,c.push(_)}o.widthCurve=c;var d=e.colorGradient,f=d.colorKeys,m=d.alphaKeys,T=new yr(f.length,m.length);for(T.mode=d.mode,n=0,i=f.length;n<i;n++){var p=f[n];T.addColorRGB(p.time,new De(p.value[0],p.value[1],p.value[2],1))}for(n=0,i=m.length;n<i;n++){var g=m[n];T.addColorAlpha(g.time,g.value)}o.colorGradient=T}},{key:"_onActive",value:function(){_get(_getPrototypeOf(TrailSprite3D.prototype),"_onActive",this).call(this),this._transform.position.cloneTo(this._geometryFilter._lastPosition)}},{key:"_cloneTo",value:function(e,t,r){var n,i;_get(_getPrototypeOf(TrailSprite3D.prototype),"_cloneTo",this).call(this,e,t,r);var a=e,o=a.trailFilter;o.time=this.trailFilter.time,o.minVertexDistance=this.trailFilter.minVertexDistance,o.widthMultiplier=this.trailFilter.widthMultiplier,o.textureMode=this.trailFilter.textureMode,o.alignment=this.trailFilter.alignment;var s=this.trailFilter.widthCurve,l=[];for(n=0,i=s.length;n<i;n++){var u=new U;s[n].cloneTo(u),l.push(u)}o.widthCurve=l;var c=new yr(this.trailFilter.colorGradient.maxColorRGBKeysCount,this.trailFilter.colorGradient.maxColorAlphaKeysCount);this.trailFilter.colorGradient.cloneTo(c),o.colorGradient=c,a.trailRenderer.sharedMaterial=this.trailRenderer.sharedMaterial}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(TrailSprite3D.prototype),"destroy",this).call(this,e),this._geometryFilter.destroy(),this._geometryFilter=null)}},{key:"clear",value:function(){this._geometryFilter.clear()}},{key:"_create",value:function(){return new TrailSprite3D}},{key:"trailFilter",get:function(){return this._geometryFilter}},{key:"trailRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){}}]),TrailSprite3D}(Ot),hn=function(){function VertexPositionTerrain(e,t,r,n){_classCallCheck(this,VertexPositionTerrain),this._position=e,this._normal=t,this._textureCoord0=r,this._textureCoord1=n}return _createClass(VertexPositionTerrain,[{key:"position",get:function(){return this._position}},{key:"normal",get:function(){return this._normal}},{key:"textureCoord0",get:function(){return this._textureCoord0}},{key:"textureCoord1",get:function(){return this._textureCoord1}},{key:"vertexDeclaration",get:function(){return VertexPositionTerrain._vertexDeclaration}}],[{key:"__init__",value:function(){VertexPositionTerrain._vertexDeclaration=new je(40,[new Ze(0,Ye.Vector3,VertexPositionTerrain.TERRAIN_POSITION0),new Ze(12,Ye.Vector3,VertexPositionTerrain.TERRAIN_NORMAL0),new Ze(24,Ye.Vector2,VertexPositionTerrain.TERRAIN_TEXTURECOORDINATE0),new Ze(32,Ye.Vector2,VertexPositionTerrain.TERRAIN_TEXTURECOORDINATE1)])}},{key:"vertexDeclaration",get:function(){return VertexPositionTerrain._vertexDeclaration}}]),VertexPositionTerrain}();hn.TERRAIN_POSITION0=0,hn.TERRAIN_NORMAL0=1,hn.TERRAIN_TEXTURECOORDINATE0=2,hn.TERRAIN_TEXTURECOORDINATE1=3;var _n=function BulletInteractive(){_classCallCheck(this,BulletInteractive)};_n._interactive={getWorldTransform:function(e,t){},setWorldTransform:function(e,t){var r=v._physicObjectsMap[e];r._simulation._updatedRigidbodies++,r._updateTransformComponent(t)}};var dn=function(e){function PhysicsCollider(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:m.COLLISIONFILTERGROUP_DEFAULTFILTER,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:m.COLLISIONFILTERGROUP_ALLFILTER;return _classCallCheck(this,PhysicsCollider),(e=_possibleConstructorReturn(this,_getPrototypeOf(PhysicsCollider).call(this,t,r)))._enableProcessCollisions=!1,e}return _inherits(PhysicsCollider,e),_createClass(PhysicsCollider,[{key:"_addToSimulation",value:function(){this._simulation._addPhysicsCollider(this,this._collisionGroup,this._canCollideWith)}},{key:"_removeFromSimulation",value:function(){this._simulation._removePhysicsCollider(this)}},{key:"_parse",value:function(e){null!=e.friction&&(this.friction=e.friction),null!=e.rollingFriction&&(this.rollingFriction=e.rollingFriction),null!=e.restitution&&(this.restitution=e.restitution),null!=e.isTrigger&&(this.isTrigger=e.isTrigger),_get(_getPrototypeOf(PhysicsCollider.prototype),"_parse",this).call(this,e),this._parseShape(e.shapes)}},{key:"_onAdded",value:function(){var e=k._bullet,t=e.btCollisionObject_create();e.btCollisionObject_setUserIndex(t,this.id),e.btCollisionObject_forceActivationState(t,v.ACTIVATIONSTATE_DISABLE_SIMULATION);var r=e.btCollisionObject_getCollisionFlags(t);this.owner.isStatic?((r&v.COLLISIONFLAGS_KINEMATIC_OBJECT)>0&&(r^=v.COLLISIONFLAGS_KINEMATIC_OBJECT),r|=v.COLLISIONFLAGS_STATIC_OBJECT):((r&v.COLLISIONFLAGS_STATIC_OBJECT)>0&&(r^=v.COLLISIONFLAGS_STATIC_OBJECT),r|=v.COLLISIONFLAGS_KINEMATIC_OBJECT),e.btCollisionObject_setCollisionFlags(t,r),this._btColliderObject=t,_get(_getPrototypeOf(PhysicsCollider.prototype),"_onAdded",this).call(this)}}]),PhysicsCollider}(N),fn=function(r){function SubMesh(e){var t;return _classCallCheck(this,SubMesh),(t=_possibleConstructorReturn(this,_getPrototypeOf(SubMesh).call(this)))._id=++SubMesh._uniqueIDCounter,t._mesh=e,t._boneIndicesList=[],t._subIndexBufferStart=[],t._subIndexBufferCount=[],t}return _inherits(SubMesh,r),_createClass(SubMesh,[{key:"_setIndexRange",value:function(e,t){this._indexStart=e,this._indexCount=t,this._indices=new Uint16Array(this._indexBuffer.getData().buffer,2*e,t)}},{key:"_getType",value:function(){return SubMesh._type}},{key:"_prepareRender",value:function(e){return this._mesh._uploadVerticesData(),!0}},{key:"_render",value:function(r){var n=this._mesh;if(n.indexFormat!==e.IndexFormat.UInt32||t.LayaGL.layaGPUInstance.supportElementIndexUint32()){var i,a,o=t.LayaGL.instance,s=r.renderElement.render._skinnedData;switch(n.indexFormat){case e.IndexFormat.UInt32:i=o.UNSIGNED_INT,a=4;break;case e.IndexFormat.UInt16:i=o.UNSIGNED_SHORT,a=2;break;case e.IndexFormat.UInt8:i=o.UNSIGNED_BYTE,a=1}if(n._bufferState.bind(),s)for(var l=s[this._indexInMesh],u=0,c=this._boneIndicesList.length;u<c;u++)r.shader.uploadCustomUniform(tn.BONES,l[u]),o.drawElements(o.TRIANGLES,this._subIndexBufferCount[u],i,this._subIndexBufferStart[u]*a);else o.drawElements(o.TRIANGLES,this._indexCount,i,this._indexStart*a);t.Stat.trianglesFaces+=this._indexCount/3,t.Stat.renderBatches++}else console.warn("SubMesh:this device do not support IndexFormat.UInt32.")}},{key:"getIndices",value:function(){if(this._mesh._isReadable)return this._indices.slice();throw"SubMesh:can't get indices on subMesh,mesh's isReadable must be true."}},{key:"setIndices",value:function(e){this._indexBuffer.setData(e,this._indexStart,0,this._indexCount)}},{key:"destroy",value:function(){this._destroyed||(_get(_getPrototypeOf(SubMesh.prototype),"destroy",this).call(this),this._indexBuffer.destroy(),this._indexBuffer=null,this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null)}},{key:"indexCount",get:function(){return this._indexCount}}]),SubMesh}(It);fn._uniqueIDCounter=0,fn._type=It._typeCounter++;var mn=function skinnedMatrixCache(e,t,r){_classCallCheck(this,skinnedMatrixCache),this.subMeshIndex=e,this.batchIndex=t,this.batchBoneIndex=r},Tn=function(r){function Mesh(){var t,r=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return _classCallCheck(this,Mesh),(t=_possibleConstructorReturn(this,_getPrototypeOf(Mesh).call(this)))._tempVector30=new o,t._tempVector31=new o,t._tempVector32=new o,t._minVerticesUpdate=-1,t._maxVerticesUpdate=-1,t._needUpdateBounds=!0,t._bounds=new At(new o,new o),t._bufferState=new We,t._instanceBufferState=new We,t._instanceBufferStateType=0,t._vertexBuffer=null,t._indexBuffer=null,t._skinnedMatrixCaches=[],t._vertexCount=0,t._indexFormat=e.IndexFormat.UInt16,t._isReadable=r,t._subMeshes=[],t}return _inherits(Mesh,r),_createClass(Mesh,[{key:"_getPositionElement",value:function(e){for(var t=e.vertexDeclaration._vertexElements,r=0,n=t.length;r<n;r++){var i=t[r];if(i._elementFormat===Ye.Vector3&&i._elementUsage===Qe.MESH_POSITION0)return i}return null}},{key:"_getVerticeElementData",value:function(e,t){e.length=this._vertexCount;var r=this._vertexBuffer.vertexDeclaration,a=r.getVertexElementByUsage(t);if(a){var s=this._vertexBuffer.getUint8Data(),l=this._vertexBuffer.getFloat32Data(),u=r.vertexStride,c=u/4,h=a._offset,_=h/4;switch(t){case Qe.MESH_TEXTURECOORDINATE0:case Qe.MESH_TEXTURECOORDINATE1:for(var d=0;d<this._vertexCount;d++){var f=c*d+_;e[d]=new n(l[f],l[f+1])}break;case Qe.MESH_POSITION0:case Qe.MESH_NORMAL0:for(d=0;d<this._vertexCount;d++){f=c*d+_;e[d]=new o(l[f],l[f+1],l[f+2])}break;case Qe.MESH_TANGENT0:case Qe.MESH_BLENDWEIGHT0:for(d=0;d<this._vertexCount;d++){f=c*d+_;e[d]=new i(l[f],l[f+1],l[f+2],l[f+3])}break;case Qe.MESH_COLOR0:for(d=0;d<this._vertexCount;d++){f=c*d+_;e[d]=new De(l[f],l[f+1],l[f+2],l[f+3])}break;case Qe.MESH_BLENDINDICES0:for(d=0;d<this._vertexCount;d++){f=u*d+h;e[d]=new i(s[f],s[f+1],s[f+2],s[f+3])}break;default:throw"Mesh:Unknown elementUsage."}}}},{key:"_setVerticeElementData",value:function(e,t){var r=this._vertexBuffer.vertexDeclaration,n=r.getVertexElementByUsage(t);if(n){var i=this._vertexBuffer.getUint8Data(),a=this._vertexBuffer.getFloat32Data(),o=r.vertexStride,s=o/4,l=n._offset,u=l/4;switch(t){case Qe.MESH_TEXTURECOORDINATE0:case Qe.MESH_TEXTURECOORDINATE1:for(var c=0,h=e.length;c<h;c++){var _=s*c+u,d=e[c];a[_]=d.x,a[_+1]=d.y}break;case Qe.MESH_POSITION0:case Qe.MESH_NORMAL0:for(c=0,h=e.length;c<h;c++){_=s*c+u;var f=e[c];a[_]=f.x,a[_+1]=f.y,a[_+2]=f.z}break;case Qe.MESH_TANGENT0:case Qe.MESH_BLENDWEIGHT0:for(c=0,h=e.length;c<h;c++){_=s*c+u;var m=e[c];a[_]=m.x,a[_+1]=m.y,a[_+2]=m.z,a[_+3]=m.w}break;case Qe.MESH_COLOR0:for(c=0,h=e.length;c<h;c++){_=s*c+u;var T=e[c];a[_]=T.r,a[_+1]=T.g,a[_+2]=T.b,a[_+3]=T.a}break;case Qe.MESH_BLENDINDICES0:for(c=0,h=e.length;c<h;c++){_=o*c+l,m=e[c];i[_]=m.x,i[_+1]=m.y,i[_+2]=m.z,i[_+3]=m.w}break;default:throw"Mesh:Unknown elementUsage."}this._minVerticesUpdate=0,this._maxVerticesUpdate=Number.MAX_SAFE_INTEGER}else console.warn("Mesh: the mesh don't have  this VertexElement.")}},{key:"_disposeResource",value:function(){for(var e=0,t=this._subMeshes.length;e<t;e++)this._subMeshes[e].destroy();this._btTriangleMesh&&k._bullet.btStridingMeshInterface_destroy(this._btTriangleMesh),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._bufferState.destroy(),this._instanceBufferState.destroy(),this._setCPUMemory(0),this._setGPUMemory(0),this._bufferState=null,this._instanceBufferState=null,this._vertexBuffer=null,this._indexBuffer=null,this._subMeshes=null,this._btTriangleMesh=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null}},{key:"_setSubMeshes",value:function(e){this._subMeshes=e;for(var t=0,r=e.length;t<r;t++)e[t]._indexInMesh=t}},{key:"_setBuffer",value:function(e,t){var r=this._bufferState;r.bind(),r.applyVertexBuffer(e),r.applyIndexBuffer(t),r.unBind()}},{key:"_setInstanceBuffer",value:function(e){var t=this._instanceBufferState;switch(t.bind(),t.applyVertexBuffer(this._vertexBuffer),t.applyInstanceVertexBuffer(bt.instance.instanceWorldMatrixBuffer),t.applyInstanceVertexBuffer(bt.instance.instanceMVPMatrixBuffer),e){case Mesh.MESH_INSTANCEBUFFER_TYPE_SIMPLEANIMATOR:t.applyInstanceVertexBuffer(bt.instance.instanceSimpleAnimatorBuffer)}t.applyIndexBuffer(this._indexBuffer),t.unBind()}},{key:"_getPhysicMesh",value:function(){if(!this._btTriangleMesh){for(var e=k._bullet,t=e.btTriangleMesh_create(),r=Mesh._nativeTempVector30,n=Mesh._nativeTempVector31,i=Mesh._nativeTempVector32,a=this._tempVector30,o=this._tempVector31,s=this._tempVector32,l=this._vertexBuffer,u=this._getPositionElement(l),c=l.getFloat32Data(),h=l.vertexDeclaration.vertexStride/4,_=u._offset/4,d=this._indexBuffer.getData(),f=0,m=d.length;f<m;f+=3){var T=d[f]*h+_,p=d[f+1]*h+_,g=d[f+2]*h+_;a.setValue(c[T],c[T+1],c[T+2]),o.setValue(c[p],c[p+1],c[p+2]),s.setValue(c[g],c[g+1],c[g+2]),P._convertToBulletVec3(a,r,!0),P._convertToBulletVec3(o,n,!0),P._convertToBulletVec3(s,i,!0),e.btTriangleMesh_addTriangle(t,r,n,i,!0)}this._btTriangleMesh=t}return this._btTriangleMesh}},{key:"_uploadVerticesData",value:function(){var e=this._minVerticesUpdate,t=this._maxVerticesUpdate;if(-1!==e&&-1!==t){var r=e;this._vertexBuffer.setData(this._vertexBuffer.getUint8Data().buffer,r,r,t-e),this._minVerticesUpdate=-1,this._maxVerticesUpdate=-1}}},{key:"getSubMesh",value:function(e){return this._subMeshes[e]}},{key:"getPositions",value:function(e){if(!this._isReadable)throw"Mesh:can't get positions on mesh,isReadable must be true.";this._getVerticeElementData(e,Qe.MESH_POSITION0)}},{key:"setPositions",value:function(e){if(!this._isReadable)throw"Mesh:setPosition() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Qe.MESH_POSITION0),this._needUpdateBounds=!0}},{key:"getColors",value:function(e){if(!this._isReadable)throw"Mesh:can't get colors on mesh,isReadable must be true.";this._getVerticeElementData(e,Qe.MESH_COLOR0)}},{key:"setColors",value:function(e){if(!this._isReadable)throw"Mesh:setColors() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Qe.MESH_COLOR0)}},{key:"getUVs",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this._isReadable)throw"Mesh:can't get uvs on mesh,isReadable must be true.";switch(t){case 0:this._getVerticeElementData(e,Qe.MESH_TEXTURECOORDINATE0);break;case 1:this._getVerticeElementData(e,Qe.MESH_TEXTURECOORDINATE1);break;default:throw"Mesh:Invalid channel."}}},{key:"setUVs",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this._isReadable)throw"Mesh:setUVs() need isReadable must be true or use setVertices().";switch(t){case 0:this._setVerticeElementData(e,Qe.MESH_TEXTURECOORDINATE0);break;case 1:this._setVerticeElementData(e,Qe.MESH_TEXTURECOORDINATE1);break;default:throw"Mesh:Invalid channel."}}},{key:"getNormals",value:function(e){if(!this._isReadable)throw"Mesh:can't get colors on mesh,isReadable must be true.";this._getVerticeElementData(e,Qe.MESH_NORMAL0)}},{key:"setNormals",value:function(e){if(!this._isReadable)throw"Mesh:setNormals() need must be true or use setVertices().";this._setVerticeElementData(e,Qe.MESH_NORMAL0)}},{key:"getTangents",value:function(e){if(!this._isReadable)throw"Mesh:can't get colors on mesh,isReadable must be true.";this._getVerticeElementData(e,Qe.MESH_TANGENT0)}},{key:"setTangents",value:function(e){if(!this._isReadable)throw"Mesh:setTangents() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Qe.MESH_TANGENT0)}},{key:"getBoneWeights",value:function(e){if(!this._isReadable)throw"Mesh:can't get boneWeights on mesh,isReadable must be true.";this._getVerticeElementData(e,Qe.MESH_BLENDWEIGHT0)}},{key:"setBoneWeights",value:function(e){if(!this._isReadable)throw"Mesh:setBoneWeights() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Qe.MESH_BLENDWEIGHT0)}},{key:"getBoneIndices",value:function(e){if(!this._isReadable)throw"Mesh:can't get boneIndices on mesh,isReadable must be true.";this._getVerticeElementData(e,Qe.MESH_BLENDINDICES0)}},{key:"setBoneIndices",value:function(e){if(!this._isReadable)throw"Mesh:setBoneIndices() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Qe.MESH_BLENDINDICES0)}},{key:"markAsUnreadbale",value:function(){this._uploadVerticesData(),this._vertexBuffer.markAsUnreadbale(),this._isReadable=!1}},{key:"getVertexDeclaration",value:function(){return this._vertexBuffer._vertexDeclaration}},{key:"getVertices",value:function(){if(this._isReadable)return this._vertexBuffer.getUint8Data().buffer.slice(0);throw"Mesh:can't get vertices on mesh,isReadable must be true."}},{key:"setVertices",value:function(e){this._vertexBuffer.setData(e),this._needUpdateBounds=!0}},{key:"getIndices",value:function(){if(this._isReadable)return this._indexBuffer.getData().slice();throw"Mesh:can't get indices on subMesh,mesh's isReadable must be true."}},{key:"setIndices",value:function(r){var n;r instanceof Uint32Array?n=e.IndexFormat.UInt32:r instanceof Uint16Array?n=e.IndexFormat.UInt16:r instanceof Uint8Array&&(n=e.IndexFormat.UInt8);var i=this._indexBuffer;this._indexFormat===n&&i.indexCount===r.length||(i.destroy(),this._indexBuffer=i=new Xe(n,r.length,t.LayaGL.instance.STATIC_DRAW,this._isReadable)),i.setData(r),this._indexFormat=n}},{key:"calculateBounds",value:function(){if(!this._isReadable)throw"Mesh:can't calculate bounds on subMesh,mesh's isReadable must be true.";if(this._needUpdateBounds){var e=this._tempVector30,t=this._tempVector31;e.x=e.y=e.z=Number.MAX_VALUE,t.x=t.y=t.z=-Number.MAX_VALUE;for(var r=this._vertexBuffer,n=this._getPositionElement(r),i=r.getFloat32Data(),a=r.vertexDeclaration.vertexStride/4,o=n._offset/4,s=0,l=i.length;s<l;s+=a){var u=s+o,c=i[u],h=i[u+1],_=i[u+2];e.x=Math.min(e.x,c),e.y=Math.min(e.y,h),e.z=Math.min(e.z,_),t.x=Math.max(t.x,c),t.y=Math.max(t.y,h),t.z=Math.max(t.z,_)}this._bounds.setMin(e),this._bounds.setMax(t),this._needUpdateBounds=!1}}},{key:"cloneTo",value:function(t){var r=t,n=this._vertexBuffer,i=new qe(n._byteLength,n.bufferUsage,n.canRead);i.vertexDeclaration=n.vertexDeclaration,i.setData(n.getUint8Data().slice().buffer),r._vertexBuffer=i,r._vertexCount=this._vertexCount;var a,o=this._indexBuffer,s=new Xe(e.IndexFormat.UInt16,o.indexCount,o.bufferUsage,o.canRead);s.setData(o.getData().slice()),r._indexBuffer=s,r._setBuffer(r._vertexBuffer,s),r._setInstanceBuffer(this._instanceBufferStateType),r._setCPUMemory(this.cpuMemory),r._setGPUMemory(this.gpuMemory);var l=this._boneNames;if(l){var u=r._boneNames=[];for(a=0;a<l.length;a++)u[a]=l[a]}var c=this._inverseBindPoses;if(c){var h=r._inverseBindPoses=[];for(a=0;a<c.length;a++)h[a]=c[a]}var _=this._skinnedMatrixCaches.length;for(r._skinnedMatrixCaches.length=_,a=0;a<_;a++){var d=this._skinnedMatrixCaches[a];r._skinnedMatrixCaches[a]=new mn(d.subMeshIndex,d.batchIndex,d.batchBoneIndex)}for(a=0;a<this.subMeshCount;a++){var f=this._subMeshes[a],m=f._subIndexBufferStart,T=f._subIndexBufferCount,p=f._boneIndicesList,g=new fn(r);g._subIndexBufferStart.length=m.length,g._subIndexBufferCount.length=T.length,g._boneIndicesList.length=p.length;for(var E=0;E<m.length;E++)g._subIndexBufferStart[E]=m[E];for(E=0;E<T.length;E++)g._subIndexBufferCount[E]=T[E];for(E=0;E<p.length;E++)g._boneIndicesList[E]=new Uint16Array(p[E]);g._indexBuffer=s,g._indexStart=f._indexStart,g._indexCount=f._indexCount,g._indices=new Uint16Array(s.getData().buffer,2*f._indexStart,f._indexCount);var y=r._vertexBuffer;g._vertexBuffer=y,r._subMeshes.push(g)}r._setSubMeshes(r._subMeshes)}},{key:"clone",value:function(){var e=new Mesh;return this.cloneTo(e),e}},{key:"inverseAbsoluteBindPoses",get:function(){return this._inverseBindPoses}},{key:"vertexCount",get:function(){return this._vertexCount}},{key:"indexCount",get:function(){return this._indexBuffer.indexCount}},{key:"subMeshCount",get:function(){return this._subMeshes.length}},{key:"bounds",get:function(){return this._bounds},set:function(e){this._bounds!==e&&e.cloneTo(this._bounds)}},{key:"indexFormat",get:function(){return this._indexFormat}}],[{key:"__init__",value:function(){var e=k._bullet;e&&(Mesh._nativeTempVector30=e.btVector3_create(0,0,0),Mesh._nativeTempVector31=e.btVector3_create(0,0,0),Mesh._nativeTempVector32=e.btVector3_create(0,0,0))}},{key:"load",value:function(e,r){t.ILaya.loader.create(e,r,null,Mesh.MESH)}}]),Mesh}(t.Resource);Tn.MESH="MESH",Tn.MESH_INSTANCEBUFFER_TYPE_NORMAL=0,Tn.MESH_INSTANCEBUFFER_TYPE_SIMPLEANIMATOR=1;var pn=function(){function PrimitiveMesh(){_classCallCheck(this,PrimitiveMesh)}return _createClass(PrimitiveMesh,null,[{key:"__init__",value:function(){}},{key:"_createMesh",value:function(r,n,i){var a=t.LayaGL.instance,o=new Tn,s=new fn(o),l=new qe(4*n.length,a.STATIC_DRAW,!0);l.vertexDeclaration=r,l.setData(n.buffer),o._vertexBuffer=l,o._vertexCount=l._byteLength/r.vertexStride;var u=new Xe(e.IndexFormat.UInt16,i.length,a.STATIC_DRAW,!0);u.setData(i),o._indexBuffer=u,o._setBuffer(l,u),o._setInstanceBuffer(o._instanceBufferStateType),s._vertexBuffer=l,s._indexBuffer=u,s._setIndexRange(0,u.indexCount);var c=s._subIndexBufferStart,h=s._subIndexBufferCount,_=s._boneIndicesList;c.length=1,h.length=1,_.length=1,c[0]=0,h[0]=u.indexCount;var d=[];d.push(s),o._setSubMeshes(d),o.calculateBounds();var f=l._byteLength+u._byteLength;return o._setCPUMemory(f),o._setGPUMemory(f),o}},{key:"createBox",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=Qe.getVertexDeclaration("POSITION,NORMAL,UV"),i=e/2,a=t/2,o=r/2,s=new Float32Array([-i,a,-o,0,1,0,0,0,i,a,-o,0,1,0,1,0,i,a,o,0,1,0,1,1,-i,a,o,0,1,0,0,1,-i,-a,-o,0,-1,0,0,1,i,-a,-o,0,-1,0,1,1,i,-a,o,0,-1,0,1,0,-i,-a,o,0,-1,0,0,0,-i,a,-o,-1,0,0,0,0,-i,a,o,-1,0,0,1,0,-i,-a,o,-1,0,0,1,1,-i,-a,-o,-1,0,0,0,1,i,a,-o,1,0,0,1,0,i,a,o,1,0,0,0,0,i,-a,o,1,0,0,0,1,i,-a,-o,1,0,0,1,1,-i,a,o,0,0,1,0,0,i,a,o,0,0,1,1,0,i,-a,o,0,0,1,1,1,-i,-a,o,0,0,1,0,1,-i,a,-o,0,0,-1,1,0,i,a,-o,0,0,-1,0,0,i,-a,-o,0,0,-1,0,1,-i,-a,-o,0,0,-1,1,1]),l=new Uint16Array([0,1,2,2,3,0,4,7,6,6,5,4,8,9,10,10,11,8,12,15,14,14,13,12,16,17,18,18,19,16,20,23,22,22,21,20]);return PrimitiveMesh._createMesh(n,s,l)}},{key:"createCapsule",value:function(){var e,t,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:32,o=(i+1)*(a+1)*2+2*(a+1),s=3*i*(a+1)*2*2+2*a*3,l=Qe.getVertexDeclaration("POSITION,NORMAL,UV"),u=l.vertexStride/4,c=new Float32Array(o*u),h=new Uint16Array(s),_=Math.PI/2/i,d=2*Math.PI/a,f=n/2-r,m=0,T=0,p=0,g=0,E=0,y=0;for(e=0;e<=i;e++)for(t=0;t<=a;t++)m=r*Math.cos(e*_)*Math.cos(t*d+Math.PI),T=r*Math.sin(e*_),p=r*Math.cos(e*_)*Math.sin(t*d+Math.PI),c[g++]=m,c[g++]=T+f,c[g++]=p,c[g++]=m,c[g++]=T,c[g++]=p,c[g++]=1-t/a,c[g++]=(1-e/i)*(Math.PI*r/2/(n+Math.PI*r)),e<i&&(h[E++]=e*(a+1)+t+(a+1),h[E++]=e*(a+1)+t,h[E++]=e*(a+1)+t+1,h[E++]=e*(a+1)+t+a,h[E++]=e*(a+1)+t,h[E++]=e*(a+1)+t+(a+1));for(y+=(i+1)*(a+1),e=0;e<=i;e++)for(t=0;t<=a;t++)m=r*Math.cos(e*_)*Math.cos(t*d+Math.PI),T=r*Math.sin(-e*_),p=r*Math.cos(e*_)*Math.sin(t*d+Math.PI),c[g++]=m,c[g++]=T-f,c[g++]=p,c[g++]=m,c[g++]=T,c[g++]=p,c[g++]=1-t/a,c[g++]=(e/i*(Math.PI*r/2)+(n+Math.PI*r/2))/(n+Math.PI*r),e<i&&(h[E++]=y+e*(a+1)+t,h[E++]=y+e*(a+1)+t+(a+1),h[E++]=y+e*(a+1)+t+1,h[E++]=y+e*(a+1)+t,h[E++]=y+e*(a+1)+t+a,h[E++]=y+e*(a+1)+t+(a+1));for(y+=(i+1)*(a+1),t=0;t<=a;t++)m=r*Math.cos(t*d+Math.PI),T=f,p=r*Math.sin(t*d+Math.PI),c[g++]=m,c[g+8*(a+1)-1]=m,c[g++]=T,c[g+8*(a+1)-1]=-T,c[g++]=p,c[g+8*(a+1)-1]=p,c[g++]=m,c[g+8*(a+1)-1]=m,c[g++]=0,c[g+8*(a+1)-1]=0,c[g++]=p,c[g+8*(a+1)-1]=p,c[g++]=1-1*t/a,c[g+8*(a+1)-1]=1-1*t/a,c[g++]=Math.PI*r/2/(n+Math.PI*r),c[g+8*(a+1)-1]=(Math.PI*r/2+n)/(n+Math.PI*r);for(t=0;t<a;t++)h[E++]=t+y+(a+1),h[E++]=t+y+1,h[E++]=t+y,h[E++]=t+y+(a+1),h[E++]=t+y+(a+1)+1,h[E++]=t+y+1;return y+=2*(a+1),PrimitiveMesh._createMesh(l,c,h)}},{key:"createCone",value:function(){for(var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:32,i=n+1+1+2*(n+1),a=6*n+3*n,s=Qe.getVertexDeclaration("POSITION,NORMAL,UV"),l=s.vertexStride/4,c=new Float32Array(i*l),h=new Uint16Array(a),_=2*Math.PI/n,d=r/2,f=0,m=0,T=0,p=0,g=0,E=new o,y=new o(0,-1,0),S=new o(0,d,0),v=new o,R=new o,C=new u,M=new o,D=0,x=0,A=0;A<=n;A++)f=A*_,T=Math.cos(f+Math.PI)*t,p=d,g=Math.sin(f+Math.PI)*t,c[D++]=0,c[D+8*(n+1)-1]=T,c[D++]=p,c[D+8*(n+1)-1]=-p,c[D++]=0,c[D+8*(n+1)-1]=g,E.x=T,E.y=0,E.z=g,v.x=T,v.y=-p,v.z=g,o.subtract(v,S,R),o.normalize(R,R),e=Math.acos(o.dot(y,R)),o.cross(y,R,M),o.normalize(M,M),u.createFromAxisAngle(M,e,C),o.normalize(E,E),o.transformQuat(E,C,E),o.normalize(E,E),c[D++]=E.x,c[D+8*(n+1)-1]=E.x,c[D++]=E.y,c[D+8*(n+1)-1]=E.y,c[D++]=E.z,c[D+8*(n+1)-1]=E.z,c[D++]=1-1*A/n,c[D+8*(n+1)-1]=1-1*A/n,c[D++]=0,c[D+8*(n+1)-1]=1;D+=8*(n+1);for(var I=0;I<n;I++)h[x++]=I+m+(n+1),h[x++]=I+m+1,h[x++]=I+m,h[x++]=I+m+(n+1),h[x++]=I+m+(n+1)+1,h[x++]=I+m+1;m+=2*(n+1);for(var L=0;L<=n;L++)0===L&&(c[D++]=0,c[D++]=-d,c[D++]=0,c[D++]=0,c[D++]=-1,c[D++]=0,c[D++]=.5,c[D++]=.5),f=L*_,T=Math.cos(f+Math.PI)*t,p=-d,g=Math.sin(f+Math.PI)*t,c[D++]=T,c[D++]=p,c[D++]=g,c[D++]=0,c[D++]=-1,c[D++]=0,c[D++]=.5+.5*Math.cos(f),c[D++]=.5+.5*Math.sin(f);for(var P=0;P<n;P++)h[x++]=0+m,h[x++]=P+2+m,h[x++]=P+1+m;return m+=n+1+1,PrimitiveMesh._createMesh(s,c,h)}},{key:"createCylinder",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:32,n=r+1+1+2*(r+1)+(r+1+1),i=3*r+6*r+3*r,a=Qe.getVertexDeclaration("POSITION,NORMAL,UV"),o=a.vertexStride/4,s=new Float32Array(n*o),l=new Uint16Array(i),u=2*Math.PI/r,c=t/2,h=0,_=0,d=0,f=0,m=0,T=0,p=0,g=0;g<=r;g++)0===g&&(s[T++]=0,s[T++]=c,s[T++]=0,s[T++]=0,s[T++]=1,s[T++]=0,s[T++]=.5,s[T++]=.5),h=g*u,d=Math.cos(h)*e,f=c,m=Math.sin(h)*e,s[T++]=d,s[T++]=f,s[T++]=m,s[T++]=0,s[T++]=1,s[T++]=0,s[T++]=.5+.5*Math.cos(h),s[T++]=.5+.5*Math.sin(h);for(var E=0;E<r;E++)l[p++]=0,l[p++]=E+1,l[p++]=E+2;_+=r+1+1;for(var y=0;y<=r;y++)h=y*u,d=Math.cos(h+Math.PI)*e,f=c,m=Math.sin(h+Math.PI)*e,s[T++]=d,s[T+8*(r+1)-1]=d,s[T++]=f,s[T+8*(r+1)-1]=-f,s[T++]=m,s[T+8*(r+1)-1]=m,s[T++]=d,s[T+8*(r+1)-1]=d,s[T++]=0,s[T+8*(r+1)-1]=0,s[T++]=m,s[T+8*(r+1)-1]=m,s[T++]=1-1*y/r,s[T+8*(r+1)-1]=1-1*y/r,s[T++]=0,s[T+8*(r+1)-1]=1;T+=8*(r+1);for(var S=0;S<r;S++)l[p++]=S+_+(r+1),l[p++]=S+_+1,l[p++]=S+_,l[p++]=S+_+(r+1),l[p++]=S+_+(r+1)+1,l[p++]=S+_+1;_+=2*(r+1);for(var v=0;v<=r;v++)0===v&&(s[T++]=0,s[T++]=-c,s[T++]=0,s[T++]=0,s[T++]=-1,s[T++]=0,s[T++]=.5,s[T++]=.5),h=v*u,d=Math.cos(h+Math.PI)*e,f=-c,m=Math.sin(h+Math.PI)*e,s[T++]=d,s[T++]=f,s[T++]=m,s[T++]=0,s[T++]=-1,s[T++]=0,s[T++]=.5+.5*Math.cos(h),s[T++]=.5+.5*Math.sin(h);for(var R=0;R<r;R++)l[p++]=0+_,l[p++]=R+2+_,l[p++]=R+1+_;return _+=r+1+1,PrimitiveMesh._createMesh(a,s,l)}},{key:"createPlane",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10,i=(r+1)*(n+1),a=r*n*2*3,o=new Uint16Array(a),s=Qe.getVertexDeclaration("POSITION,NORMAL,UV"),l=s.vertexStride/4,u=new Float32Array(i*l),c=e/2,h=t/2,_=e/r,d=t/n,f=0,m=0;m<=n;m++)for(var T=0;T<=r;T++)u[f++]=T*_-c,u[f++]=0,u[f++]=m*d-h,u[f++]=0,u[f++]=1,u[f++]=0,u[f++]=1*T/r,u[f++]=1*m/n;var p=0;for(m=0;m<n;m++)for(T=0;T<r;T++)o[p++]=(m+1)*(r+1)+T,o[p++]=m*(r+1)+T,o[p++]=(m+1)*(r+1)+T+1,o[p++]=m*(r+1)+T,o[p++]=m*(r+1)+T+1,o[p++]=(m+1)*(r+1)+T+1;return PrimitiveMesh._createMesh(s,u,o)}},{key:"createQuad",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=Qe.getVertexDeclaration("POSITION,NORMAL,UV"),n=e/2,i=t/2,a=new Float32Array([-n,i,0,0,0,1,0,0,n,i,0,0,0,1,1,0,-n,-i,0,0,0,1,0,1,n,-i,0,0,0,1,1,1]),o=new Uint16Array([0,1,2,3,2,1]);return PrimitiveMesh._createMesh(r,a,o)}},{key:"createSphere",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:32,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:32,n=(t+1)*(r+1),i=3*t*(r+1)*2,a=new Uint16Array(i),o=Qe.getVertexDeclaration("POSITION,NORMAL,UV"),s=o.vertexStride/4,l=new Float32Array(n*s),u=Math.PI/t,c=2*Math.PI/r,h=0;n=0,i=0;for(var _=0;_<t+1;_++)for(var d=Math.sin(_*u),f=Math.cos(_*u),m=0;m<r+1;m++){var T=d*Math.sin(m*c+1*Math.PI/2),p=d*Math.cos(m*c+1*Math.PI/2);l[n+0]=T*e,l[n+1]=f*e,l[n+2]=p*e,l[n+3]=T,l[n+4]=f,l[n+5]=p,l[n+6]=m/r,l[n+7]=_/t,n+=s,_!=t-1&&(a[i++]=h+(r+1),a[i++]=h,a[i++]=h+1,a[i++]=h+r,a[i++]=h,a[i++]=h+(r+1),h++)}return PrimitiveMesh._createMesh(o,l,a)}}]),PrimitiveMesh}(),gn='#include "Lighting.glsl";\r\n\r\nattribute vec4 a_PositionTexcoord;\r\nvarying vec2 v_Texcoord0;\r\n\r\nvoid main() {\r\n\tgl_Position = vec4(a_PositionTexcoord.xy, 0.0, 1.0);\r\n\tv_Texcoord0 = a_PositionTexcoord.zw;\r\n\tgl_Position = remapGLPositionZ(gl_Position);\r\n}',En=function(){function ShaderInit3D(){_classCallCheck(this,ShaderInit3D)}return _createClass(ShaderInit3D,null,[{key:"__init__",value:function(){ue.SHADERDEFINE_LEGACYSINGALLIGHTING=ue.getDefineByName("LEGACYSINGLELIGHTING"),ue.SHADERDEFINE_GRAPHICS_API_GLES2=ue.getDefineByName("GRAPHICS_API_GLES2"),ue.SHADERDEFINE_GRAPHICS_API_GLES3=ue.getDefineByName("GRAPHICS_API_GLES3"),ue.addInclude("Lighting.glsl","#ifdef GRAPHICS_API_GLES3\r\n\t#define INVERSE_MAT(mat) inverse(mat)\r\n#else\r\n\t#define INVERSE_MAT(mat) inverseMat(mat)\r\n#endif\r\n\r\nstruct DirectionLight {\r\n\tvec3 color;\r\n\tvec3 direction;\r\n};\r\n\r\nstruct PointLight {\r\n\tvec3 color;\r\n\tvec3 position;\r\n\tfloat range;\r\n};\r\n\r\nstruct SpotLight {\r\n\tvec3 color;\r\n\tvec3 position;\r\n\tfloat range;\r\n\tvec3 direction;\r\n\tfloat spot;\r\n};\r\n\r\nstruct LayaGI{\r\n\tvec3 diffuse;\r\n\tvec3 specular;\r\n};\r\n\r\nstruct LayaLight{\r\n\tvec3 color;\r\n\tvec3 dir;\r\n};\r\n\r\nconst int c_ClusterBufferWidth = CLUSTER_X_COUNT*CLUSTER_Y_COUNT;\r\nconst int c_ClusterBufferHeight = CLUSTER_Z_COUNT*(1+int(ceil(float(MAX_LIGHT_COUNT_PER_CLUSTER)/4.0)));\r\nconst int c_ClusterBufferFloatWidth = c_ClusterBufferWidth*4;\r\n\r\n#ifndef GRAPHICS_API_GLES3\r\n\tmat3 inverseMat(mat3 m) {\r\n\t\tfloat a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];\r\n\t\tfloat a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];\r\n\t\tfloat a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];\r\n\r\n\t\tfloat b01 = a22 * a11 - a12 * a21;\r\n\t\tfloat b11 = -a22 * a10 + a12 * a20;\r\n\t\tfloat b21 = a21 * a10 - a11 * a20;\r\n\r\n\t\tfloat det = a00 * b01 + a01 * b11 + a02 * b21;\r\n\r\n\t\treturn mat3(b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),\r\n\t\t\t\t\tb11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),\r\n\t\t\t\t\tb21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)) / det;\r\n\t}\r\n#endif\r\n\r\nivec4 getClusterInfo(sampler2D clusterBuffer,mat4 viewMatrix,vec4 viewport,vec3 position,vec4 fragCoord,vec4 projectParams)\r\n{\r\n\tvec3 viewPos = vec3(viewMatrix*vec4(position, 1.0)); //position in viewspace\r\n\r\n\tint clusterXIndex = int(floor(fragCoord.x/ (float(viewport.z)/float(CLUSTER_X_COUNT))));\r\n    int clusterYIndex = int(floor((viewport.w * (projectParams.z <0.0? 0.0 : 1.0) - fragCoord.y * projectParams.z)/ (float(viewport.w)/float(CLUSTER_Y_COUNT))));//Maybe Flipped ProjectMatrix\r\n\tfloat zSliceParam =float(CLUSTER_Z_COUNT)/log2(projectParams.y / projectParams.x);\r\n \tint clusterZIndex = int(floor(log2(-viewPos.z) * zSliceParam- log2(projectParams.x) * zSliceParam));//projectParams x:cameraNear y:cameraFar\r\n\r\n\tvec2 uv= vec2((float(clusterXIndex + clusterYIndex * CLUSTER_X_COUNT)+0.5)/float(c_ClusterBufferWidth),\r\n\t\t\t\t(float(clusterZIndex)+0.5)/float(c_ClusterBufferHeight));\r\n\tvec4 clusterPixel=texture2D(clusterBuffer, uv);\r\n\treturn ivec4(clusterPixel);//X:Point Count Y:Spot Count Z、W:Light Offset\r\n}\r\n\r\n\r\nint getLightIndex(sampler2D clusterBuffer,int offset,int index) \r\n{\r\n\tint totalOffset=offset+index;\r\n\tint row=totalOffset/c_ClusterBufferFloatWidth;\r\n\tint lastRowFloat=totalOffset-row*c_ClusterBufferFloatWidth;\r\n\tint col=lastRowFloat/4;\r\n\tvec2 uv=vec2((float(col)+0.5)/float(c_ClusterBufferWidth),\r\n\t\t\t\t(float(row)+0.5)/float(c_ClusterBufferHeight));\r\n\tvec4 texel = texture2D(clusterBuffer, uv);\r\n    int pixelComponent = lastRowFloat-col*4;\r\n    if (pixelComponent == 0) \r\n      return int(texel.x);\r\n    else if (pixelComponent == 1) \r\n      return int(texel.y);\r\n    else if (pixelComponent == 2) \r\n      return int(texel.z);\r\n    else //pixelComponent==3\r\n      return int(texel.w);\r\n}\r\n\r\nDirectionLight getDirectionLight(sampler2D lightBuffer,int index) \r\n{\r\n    DirectionLight light;\r\n    float v = (float(index)+0.5)/ float(MAX_LIGHT_COUNT);\r\n    vec4 p1 = texture2D(lightBuffer, vec2(0.125,v));\r\n    vec4 p2 = texture2D(lightBuffer, vec2(0.375,v));\r\n\tlight.color=p1.rgb;\r\n    light.direction = p2.rgb;\r\n    return light;\r\n}\r\n\r\nPointLight getPointLight(sampler2D lightBuffer,sampler2D clusterBuffer,ivec4 clusterInfo,int index) \r\n{\r\n    PointLight light;\r\n\tint pointIndex=getLightIndex(clusterBuffer,clusterInfo.z*c_ClusterBufferFloatWidth+clusterInfo.w,index);\r\n    float v = (float(pointIndex)+0.5)/ float(MAX_LIGHT_COUNT);\r\n    vec4 p1 = texture2D(lightBuffer, vec2(0.125,v));\r\n    vec4 p2 = texture2D(lightBuffer, vec2(0.375,v));\r\n\tlight.color=p1.rgb;\r\n\tlight.range = p1.a;\r\n    light.position = p2.rgb;\r\n    return light;\r\n}\r\n\r\nSpotLight getSpotLight(sampler2D lightBuffer,sampler2D clusterBuffer,ivec4 clusterInfo,int index) \r\n{\r\n    SpotLight light;\r\n\tint spoIndex=getLightIndex(clusterBuffer,clusterInfo.z*c_ClusterBufferFloatWidth+clusterInfo.w,clusterInfo.x+index);\r\n    float v = (float(spoIndex)+0.5)/ float(MAX_LIGHT_COUNT);\r\n    vec4 p1 = texture2D(lightBuffer, vec2(0.125,v));\r\n    vec4 p2 = texture2D(lightBuffer, vec2(0.375,v));\r\n\tvec4 p3 = texture2D(lightBuffer, vec2(0.625,v));\r\n    light.color = p1.rgb;\r\n\tlight.range=p1.a;\r\n    light.position = p2.rgb;\r\n\tlight.spot = p2.a;\r\n\tlight.direction = p3.rgb;\r\n    return light;\r\n}\r\n\r\n// Laya中使用衰减纹理\r\nfloat LayaAttenuation(in vec3 L,in float invLightRadius) {\r\n\tfloat fRatio = clamp(length(L) * invLightRadius,0.0,1.0);\r\n\tfRatio *= fRatio;\r\n\treturn 1.0 / (1.0 + 25.0 * fRatio)* clamp(4.0*(1.0 - fRatio),0.0,1.0); //fade to black as if 4 pixel texture\r\n}\r\n\r\n// Same as Just Cause 2 and Crysis 2 (you can read GPU Pro 1 book for more information)\r\nfloat BasicAttenuation(in vec3 L,in float invLightRadius) {\r\n\tvec3 distance = L * invLightRadius;\r\n\tfloat attenuation = clamp(1.0 - dot(distance, distance),0.0,1.0); // Equals float attenuation = saturate(1.0f - dot(L, L) / (lightRadius *  lightRadius));\r\n\treturn attenuation * attenuation;\r\n}\r\n\r\n// Inspired on http://fools.slindev.com/viewtopic.php?f=11&t=21&view=unread#unread\r\nfloat NaturalAttenuation(in vec3 L,in float invLightRadius) {\r\n\tfloat attenuationFactor = 30.0;\r\n\tvec3 distance = L * invLightRadius;\r\n\tfloat attenuation = dot(distance, distance); // Equals float attenuation = dot(L, L) / (lightRadius *  lightRadius);\r\n\tattenuation = 1.0 / (attenuation * attenuationFactor + 1.0);\r\n\t// Second we move down the function therewith it reaches zero at abscissa 1:\r\n\tattenuationFactor = 1.0 / (attenuationFactor + 1.0); //attenuationFactor contains now the value we have to subtract\r\n\tattenuation = max(attenuation - attenuationFactor, 0.0); // The max fixes a bug.\r\n\t// Finally we expand the equation along the y-axis so that it starts with a function value of 1 again.\r\n\tattenuation /= 1.0 - attenuationFactor;\r\n\treturn attenuation;\r\n}\r\n\r\nvoid LayaAirBlinnPhongLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir,in vec3 lightColor, in vec3 lightVec,out vec3 diffuseColor,out vec3 specularColor) {\r\n\tmediump vec3 h = normalize(viewDir-lightVec);\r\n\tlowp float ln = max (0.0, dot (-lightVec,normal));\r\n\tfloat nh = max (0.0, dot (h,normal));\r\n\tdiffuseColor=lightColor * ln;\r\n\tspecularColor=lightColor *specColor*pow (nh, specColorIntensity*128.0) * gloss;\r\n}\r\n\r\nvoid LayaAirBlinnPhongDiectionLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in DirectionLight light,out vec3 diffuseColor,out vec3 specularColor) {\r\n\tvec3 lightVec=normalize(light.direction);\r\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,lightVec,diffuseColor,specularColor);\r\n}\r\n\r\nvoid LayaAirBlinnPhongPointLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in PointLight light,out vec3 diffuseColor,out vec3 specularColor) {\r\n\tvec3 lightVec =  pos-light.position;\r\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,lightVec/length(lightVec),diffuseColor,specularColor);\r\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.range);\r\n\tdiffuseColor *= attenuate;\r\n\tspecularColor*= attenuate;\r\n}\r\n\r\nvoid LayaAirBlinnPhongSpotLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in SpotLight light,out vec3 diffuseColor,out vec3 specularColor) {\r\n\tvec3 lightVec =  pos-light.position;\r\n\tvec3 normalLightVec=lightVec/length(lightVec);\r\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,normalLightVec,diffuseColor,specularColor);\r\n\tvec2 cosAngles=cos(vec2(light.spot,light.spot*0.5)*0.5);//ConeAttenuation\r\n\tfloat dl=dot(normalize(light.direction),normalLightVec);\r\n\tdl*=smoothstep(cosAngles[0],cosAngles[1],dl);\r\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.range)*dl;\r\n\tdiffuseColor *=attenuate;\r\n\tspecularColor *=attenuate;\r\n}\r\n\r\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent,vec3 binormal) {\r\n\tvec3 normalT =vec3(2.0*normalMapSample.x - 1.0,1.0-2.0*normalMapSample.y,2.0*normalMapSample.z - 1.0);\r\n\tmediump vec3 N = unitNormal;\r\n\tmediump vec3 T = tangent;\r\n\tmediump vec3 B = binormal;\r\n\tmat3 TBN = mat3(T, B, N);\r\n\r\n\t// Transform from tangent space to world space.\r\n\tvec3 bumpedNormal =normalize(TBN*normalT);\r\n\treturn bumpedNormal;\r\n}\r\n\r\nvec3 NormalSampleToWorldSpace1(vec4 normalMapSample, vec3 tangent, vec3 binormal, vec3 unitNormal) {\r\n\tvec3 normalT;\r\n\tnormalT.x = 2.0 * normalMapSample.x - 1.0;\r\n\tnormalT.y = 1.0 - 2.0 * normalMapSample.y;\r\n\tnormalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\r\n\r\n\tvec3 T = normalize(tangent);\r\n\tvec3 B = normalize(binormal);\r\n\tvec3 N = normalize(unitNormal);\r\n\tmat3 TBN = mat3(T, B, N);\r\n\r\n\t// Transform from tangent space to world space.\r\n\tvec3 bumpedNormal = TBN * normalize(normalT);\r\n\r\n\treturn bumpedNormal;\r\n}\r\n\r\nvec3 DecodeLightmap(vec4 color) {\r\n\treturn color.rgb*color.a*5.0;\r\n}\r\n\r\nvec3 decodeHDR(vec4 color,float range) {\r\n\treturn color.rgb*color.a*range;\r\n}\r\n\r\nvec2 TransformUV(vec2 texcoord,vec4 tilingOffset) {\r\n\tvec2 transTexcoord=vec2(texcoord.x,texcoord.y-1.0)*tilingOffset.xy+vec2(tilingOffset.z,-tilingOffset.w);\r\n\ttransTexcoord.y+=1.0;\r\n\treturn transTexcoord;\r\n}\r\n\r\nvec4 remapGLPositionZ(vec4 position) {\r\n\tposition.z=position.z * 2.0 - position.w;\r\n\treturn position;\r\n}\r\n\r\nmediump vec3 layaLinearToGammaSpace (mediump vec3 linRGB)\r\n{\r\n    linRGB = max(linRGB, vec3(0.0));\r\n    // An almost-perfect approximation from http://chilliant.blogspot.com.au/2012/08/srgb-approximations-for-hlsl.html?m=1\r\n    return max(1.055 * pow(linRGB,vec3(0.416666667)) - 0.055, 0.0);   \r\n}\r\n\r\nLayaLight layaDirectionLightToLight(in DirectionLight light,in float attenuate)\r\n{\r\n\tLayaLight relight;\r\n\trelight.color = light.color*attenuate;\r\n\trelight.dir = light.direction;\r\n\treturn relight;\r\n}\r\n\r\nLayaLight layaPointLightToLight(in vec3 pos,in vec3 normal, in PointLight light,in float attenuate)\r\n{\r\n\tLayaLight relight;\r\n\tvec3 lightVec =  pos-light.position;\r\n\tattenuate *= LayaAttenuation(lightVec, 1.0/light.range);\r\n\trelight.color = light.color*attenuate;\r\n\trelight.dir = normalize(lightVec);\r\n\treturn relight;\r\n}\r\n\r\nLayaLight layaSpotLightToLight(in vec3 pos,in vec3 normal, in SpotLight light,in float attenuate)\r\n{\r\n\tLayaLight relight;\r\n\tvec3 lightVec =  pos-light.position;\r\n\tvec3 normalLightVec=lightVec/length(lightVec);\r\n\tvec2 cosAngles=cos(vec2(light.spot,light.spot*0.5)*0.5);//ConeAttenuation\r\n\tfloat dl=dot(normalize(light.direction),normalLightVec);\r\n\tdl*=smoothstep(cosAngles[0],cosAngles[1],dl);\r\n\tattenuate *= LayaAttenuation(lightVec, 1.0/light.range)*dl;\r\n\trelight.dir = normalLightVec;\r\n\trelight.color = light.color*attenuate;\r\n\treturn relight;\r\n}\r\n\r\n\r\n\r\n\r\n"),ue.addInclude("ShadowSampleTent.glsl",'// ------------------------------------------------------------------\r\n//  PCF Filtering Tent Functions\r\n// ------------------------------------------------------------------\r\n\r\n// Assuming a isoceles right angled triangle of height "triangleHeight" (as drawn below).\r\n// This function return the area of the triangle above the first texel(in Y the first texel).\r\n//\r\n// |\\      <-- 45 degree slop isosceles right angled triangle\r\n// | \\\r\n// ----    <-- length of this side is "triangleHeight"\r\n// _ _ _ _ <-- texels\r\nfloat sampleShadowGetIRTriangleTexelArea(float triangleHeight)\r\n{\r\n    return triangleHeight - 0.5;\r\n}\r\n\r\n// Assuming a isoceles triangle of 1.5 texels height and 3 texels wide lying on 4 texels.\r\n// This function return the area of the triangle above each of those texels.\r\n//    |    <-- offset from -0.5 to 0.5, 0 meaning triangle is exactly in the center\r\n//   / \\   <-- 45 degree slop isosceles triangle (ie tent projected in 2D)\r\n//  /   \\\r\n// _ _ _ _ <-- texels\r\n// X Y Z W <-- result indices (in computedArea.xyzw and computedAreaUncut.xyzw)\r\n// Top point at (right,top) in a texel,left bottom point at (middle,middle) in a texel,right bottom point at (middle,middle) in a texel.\r\nvoid sampleShadowGetTexelAreasTent3x3(float offset, out vec4 computedArea, out vec4 computedAreaUncut)\r\n{\r\n    // Compute the exterior areas,a and h is same.\r\n    float a = offset + 0.5;\r\n    float offsetSquaredHalved = a * a * 0.5;\r\n    computedAreaUncut.x = computedArea.x = offsetSquaredHalved - offset;\r\n    computedAreaUncut.w = computedArea.w = offsetSquaredHalved;\r\n\r\n    // Compute the middle areas\r\n    // For Y : We find the area in Y of as if the left section of the isoceles triangle would\r\n    // intersect the axis between Y and Z (ie where offset = 0).\r\n    computedAreaUncut.y = sampleShadowGetIRTriangleTexelArea(1.5 - offset);\r\n    // This area is superior to the one we are looking for if (offset < 0) thus we need to\r\n    // subtract the area of the triangle defined by (0,1.5-offset), (0,1.5+offset), (-offset,1.5).\r\n    float clampedOffsetLeft = min(offset,0.0);\r\n    float areaOfSmallLeftTriangle = clampedOffsetLeft * clampedOffsetLeft;\r\n    computedArea.y = computedAreaUncut.y - areaOfSmallLeftTriangle;\r\n\r\n    // We do the same for the Z but with the right part of the isoceles triangle\r\n    computedAreaUncut.z = sampleShadowGetIRTriangleTexelArea(1.5 + offset);\r\n    float clampedOffsetRight = max(offset,0.0);\r\n    float areaOfSmallRightTriangle = clampedOffsetRight * clampedOffsetRight;\r\n    computedArea.z = computedAreaUncut.z - areaOfSmallRightTriangle;\r\n}\r\n\r\n// Assuming a isoceles triangle of 2.5 texel height and 5 texels wide lying on 6 texels.\r\n// This function return the weight of each texels area relative to the full triangle area.\r\n//  /       \\\r\n// _ _ _ _ _ _ <-- texels\r\n// 0 1 2 3 4 5 <-- computed area indices (in texelsWeights[])\r\n// Top point at (right,top) in a texel,left bottom point at (middle,middle) in a texel,right bottom point at (middle,middle) in a texel.\r\nvoid sampleShadowGetTexelWeightsTent5x5(float offset, out vec3 texelsWeightsA, out vec3 texelsWeightsB)\r\n{\r\n    vec4 areaFrom3texelTriangle;\r\n    vec4 areaUncutFrom3texelTriangle;\r\n    sampleShadowGetTexelAreasTent3x3(offset, areaFrom3texelTriangle, areaUncutFrom3texelTriangle);\r\n\r\n    // Triangle slope is 45 degree thus we can almost reuse the result of the 3 texel wide computation.\r\n    // the 5 texel wide triangle can be seen as the 3 texel wide one but shifted up by one unit/texel.\r\n    // 0.16 is 1/(the triangle area)\r\n    texelsWeightsA.x = 0.16 * (areaFrom3texelTriangle.x);\r\n    texelsWeightsA.y = 0.16 * (areaUncutFrom3texelTriangle.y);\r\n    texelsWeightsA.z = 0.16 * (areaFrom3texelTriangle.y + 1.0);\r\n    texelsWeightsB.x = 0.16 * (areaFrom3texelTriangle.z + 1.0);\r\n    texelsWeightsB.y = 0.16 * (areaUncutFrom3texelTriangle.z);\r\n    texelsWeightsB.z = 0.16 * (areaFrom3texelTriangle.w);\r\n}\r\n\r\n// 5x5 Tent filter (45 degree sloped triangles in U and V)\r\nvoid sampleShadowComputeSamplesTent5x5(vec4 shadowMapTextureTexelSize, vec2 coord, out float fetchesWeights[9], out vec2 fetchesUV[9])\r\n{\r\n    // tent base is 5x5 base thus covering from 25 to 36 texels, thus we need 9 bilinear PCF fetches\r\n    vec2 tentCenterInTexelSpace = coord.xy * shadowMapTextureTexelSize.zw;\r\n    vec2 centerOfFetchesInTexelSpace = floor(tentCenterInTexelSpace + 0.5);\r\n    vec2 offsetFromTentCenterToCenterOfFetches = tentCenterInTexelSpace - centerOfFetchesInTexelSpace;\r\n\r\n    // find the weight of each texel based on the area of a 45 degree slop tent above each of them.\r\n    vec3 texelsWeightsUA, texelsWeightsUB;\r\n    vec3 texelsWeightsVA, texelsWeightsVB;\r\n    sampleShadowGetTexelWeightsTent5x5(offsetFromTentCenterToCenterOfFetches.x, texelsWeightsUA, texelsWeightsUB);\r\n    sampleShadowGetTexelWeightsTent5x5(offsetFromTentCenterToCenterOfFetches.y, texelsWeightsVA, texelsWeightsVB);\r\n\r\n    // each fetch will cover a group of 2x2 texels, the weight of each group is the sum of the weights of the texels\r\n    vec3 fetchesWeightsU = vec3(texelsWeightsUA.xz, texelsWeightsUB.y) + vec3(texelsWeightsUA.y, texelsWeightsUB.xz);\r\n    vec3 fetchesWeightsV = vec3(texelsWeightsVA.xz, texelsWeightsVB.y) + vec3(texelsWeightsVA.y, texelsWeightsVB.xz);\r\n\r\n    // move the PCF bilinear fetches to respect texels weights\r\n    vec3 fetchesOffsetsU = vec3(texelsWeightsUA.y, texelsWeightsUB.xz) / fetchesWeightsU.xyz + vec3(-2.5,-0.5,1.5);\r\n    vec3 fetchesOffsetsV = vec3(texelsWeightsVA.y, texelsWeightsVB.xz) / fetchesWeightsV.xyz + vec3(-2.5,-0.5,1.5);\r\n    fetchesOffsetsU *= shadowMapTextureTexelSize.xxx;\r\n    fetchesOffsetsV *= shadowMapTextureTexelSize.yyy;\r\n\r\n    vec2 bilinearFetchOrigin = centerOfFetchesInTexelSpace * shadowMapTextureTexelSize.xy;\r\n    fetchesUV[0] = bilinearFetchOrigin + vec2(fetchesOffsetsU.x, fetchesOffsetsV.x);\r\n    fetchesUV[1] = bilinearFetchOrigin + vec2(fetchesOffsetsU.y, fetchesOffsetsV.x);\r\n    fetchesUV[2] = bilinearFetchOrigin + vec2(fetchesOffsetsU.z, fetchesOffsetsV.x);\r\n    fetchesUV[3] = bilinearFetchOrigin + vec2(fetchesOffsetsU.x, fetchesOffsetsV.y);\r\n    fetchesUV[4] = bilinearFetchOrigin + vec2(fetchesOffsetsU.y, fetchesOffsetsV.y);\r\n    fetchesUV[5] = bilinearFetchOrigin + vec2(fetchesOffsetsU.z, fetchesOffsetsV.y);\r\n    fetchesUV[6] = bilinearFetchOrigin + vec2(fetchesOffsetsU.x, fetchesOffsetsV.z);\r\n    fetchesUV[7] = bilinearFetchOrigin + vec2(fetchesOffsetsU.y, fetchesOffsetsV.z);\r\n    fetchesUV[8] = bilinearFetchOrigin + vec2(fetchesOffsetsU.z, fetchesOffsetsV.z);\r\n\r\n    fetchesWeights[0] = fetchesWeightsU.x * fetchesWeightsV.x;\r\n    fetchesWeights[1] = fetchesWeightsU.y * fetchesWeightsV.x;\r\n    fetchesWeights[2] = fetchesWeightsU.z * fetchesWeightsV.x;\r\n    fetchesWeights[3] = fetchesWeightsU.x * fetchesWeightsV.y;\r\n    fetchesWeights[4] = fetchesWeightsU.y * fetchesWeightsV.y;\r\n    fetchesWeights[5] = fetchesWeightsU.z * fetchesWeightsV.y;\r\n    fetchesWeights[6] = fetchesWeightsU.x * fetchesWeightsV.z;\r\n    fetchesWeights[7] = fetchesWeightsU.y * fetchesWeightsV.z;\r\n    fetchesWeights[8] = fetchesWeightsU.z * fetchesWeightsV.z;\r\n}'),ue.addInclude("GlobalIllumination.glsl",'struct LayaGIInput\r\n{\r\n\tvec2 lightmapUV;\r\n};\r\n\r\n#define LAYA_SPECCUBE_LOD_STEPS 6.0\r\n\r\nuniform vec3 u_AmbientColor;\r\n\r\n#if defined(GI_AMBIENT_SH)\r\n\tuniform vec4 u_AmbientSHAr;\r\n\tuniform vec4 u_AmbientSHAg;\r\n\tuniform vec4 u_AmbientSHAb;\r\n\tuniform vec4 u_AmbientSHBr;\r\n\tuniform vec4 u_AmbientSHBg;\r\n\tuniform vec4 u_AmbientSHBb;\r\n\tuniform vec4 u_AmbientSHC;\r\n#endif\r\n\r\nuniform samplerCube u_ReflectTexture;\r\nuniform vec4 u_ReflectCubeHDRParams;\r\n\r\n\r\n#ifdef GI_AMBIENT_SH\r\n\tmediump vec3 shEvalLinearL0L1(mediump vec4 normal)\r\n\t{\r\n\t\tmediump vec3 x;\r\n\t\t// Linear (L1) + constant (L0) polynomial terms\r\n\t\tx.r = dot(u_AmbientSHAr, normal);\r\n\t\tx.g = dot(u_AmbientSHAg, normal);\r\n\t\tx.b = dot(u_AmbientSHAb, normal);\r\n\t\treturn x;\r\n\t}\r\n\r\n\tmediump vec3 shEvalLinearL2(mediump vec4 normal)\r\n\t{\r\n\t\tmediump vec3 x1,x2;\r\n\t\t// 4 of the quadratic (L2) polynomials\r\n\t\tmediump vec4 vB = normal.xyzz * normal.yzzx;\r\n\t\tx1.r = dot(u_AmbientSHBr, vB);\r\n\t\tx1.g = dot(u_AmbientSHBg, vB);\r\n\t\tx1.b = dot(u_AmbientSHBb, vB);\r\n\r\n\t\t// Final (5th) quadratic (L2) polynomial\r\n\t\tmediump float vC = normal.x*normal.x - normal.y*normal.y;\r\n\t\tx2 = u_AmbientSHC.rgb * vC;\r\n\r\n\t\treturn x1 + x2;\r\n\t}\r\n\t\r\n\tmediump vec3 shadeSHPerPixel(mediump vec3 normal)\r\n\t{\r\n\t\tmediump vec3 ambientContrib;\r\n\t\tmediump vec4 normalV4=vec4(-normal.x,normal.yz, 1.0);//Note:SH Data is left-hand,so x need inverse\r\n\t\tambientContrib = shEvalLinearL0L1(normalV4);\r\n\t\tambientContrib += shEvalLinearL2(normalV4);\r\n\t\tmediump vec3 ambient = max(vec3(0.0), ambientContrib);\r\n\t\tambient = layaLinearToGammaSpace(ambient);\r\n\t\treturn ambient;\r\n\t}\r\n#endif\r\n\r\nmediump vec3 layaDecodeDirectionalLightmap (mediump vec3 color, lowp vec4 dirTex, mediump vec3 normalWorld)\r\n{\r\n    // In directional (non-specular) mode Enlighten bakes dominant light direction\r\n    // in a way, that using it for half Lambert and then dividing by a "rebalancing coefficient"\r\n    // gives a result close to plain diffuse response lightmaps, but normalmapped.\r\n\r\n    // Note that dir is not unit length on purpose. Its length is "directionality", like\r\n    // for the directional specular lightmaps.\r\n\tlowp vec3 directional=dirTex.xyz - 0.5;\r\n\tdirectional.x=-directional.x;//NOTE:because coord System\r\n    mediump float halfLambert = dot(normalWorld,directional) + 0.5;\r\n\r\n    return color * halfLambert / max(1e-4, dirTex.w);\r\n}\r\n\r\nvec3 layaGIBase(LayaGIInput giInput,mediump float occlusion, mediump vec3 normalWorld)\r\n{\r\n\tvec3 indirectDiffuse;\r\n\t#ifdef LIGHTMAP\t\r\n\t\tmediump vec3 bakedColor =decodeHDR(texture2D(u_LightMap, giInput.lightmapUV),5.0);\r\n\t\t#ifdef LIGHTMAP_DIRECTIONAL\r\n\t\t\tlowp vec4 bakedDirTex = texture2D (u_LightMapDirection, giInput.lightmapUV);\r\n            indirectDiffuse = layaDecodeDirectionalLightmap (bakedColor, bakedDirTex, normalWorld);\r\n\t\t#else //unDirectional lightmap\r\n\t\t\tindirectDiffuse = bakedColor;\r\n\t\t#endif\r\n\t#else\r\n\t\t#ifdef GI_AMBIENT_SH\r\n\t\t\tindirectDiffuse = shadeSHPerPixel(normalWorld);\r\n\t\t#else\r\n\t\t\tindirectDiffuse = u_AmbientColor; //already in gamma space\r\n\t\t#endif\r\n\t#endif\r\n\r\n\tindirectDiffuse*=occlusion;\r\n\treturn indirectDiffuse;\r\n}\r\n\r\nmediump vec3 layaGlossyEnvironment(mediump vec4 glossIn)\r\n{\r\n\tmediump float perceptualRoughness = glossIn.a;\r\n\r\n\t// use approximation to solve,below is more reasonable,but maybe slow. \r\n\t// float m = perceptualRoughnessToRoughness(perceptualRoughness); // m is the real roughness parameter\r\n    // const float fEps = 1.192092896e-07F;        // smallest such that 1.0+FLT_EPSILON != 1.0  (+1e-4h is NOT good here. is visibly very wrong)\r\n    // float n =  (2.0/max(fEps, m*m))-2.0;        // remap to spec power. See eq. 21 in --\x3e https://dl.dropboxusercontent.com/u/55891920/papers/mm_brdf.pdf\r\n    // n /= 4;                                     // remap from n_dot_h formulatino to n_dot_r. See section "Pre-convolved Cube Maps vs Path Tracers" --\x3e https://s3.amazonaws.com/docs.knaldtech.com/knald/1.0.0/lys_power_drops.html\r\n    // perceptualRoughness = pow( 2/(n+2), 0.25);  // remap back to square root of real roughness (0.25 include both the sqrt root of the conversion and sqrt for going from roughness to perceptualRoughness)\r\n\tperceptualRoughness = perceptualRoughness * (1.7 - 0.7*perceptualRoughness);//just a approximation,but fast.\r\n \r\n\tmediump float mip = perceptualRoughness * LAYA_SPECCUBE_LOD_STEPS;\r\n\tmediump vec3 uvw = glossIn.rgb;\r\n\tuvw.x=-uvw.x;//Note:reflectCube is left-hand,so x need inverse\r\n\tmediump vec4 rgbm=textureCubeLodEXT(u_ReflectTexture,uvw,mip);\r\n\treturn decodeHDR(rgbm,u_ReflectCubeHDRParams.x);\r\n}\r\n\r\nmediump vec3 layaGIIndirectSpecular(LayaGIInput giInput,mediump float occlusion, vec4 glossIn)\r\n{\r\n\tmediump vec3 specular = layaGlossyEnvironment(glossIn);\r\n\treturn specular * occlusion;\r\n}\r\n\r\n\r\nLayaGI layaGlobalIllumination(LayaGIInput giInput,mediump float occlusion, mediump vec3 normalWorld,mediump vec4 uvwRoughness)\r\n{\r\n\tLayaGI gi;\r\n\tgi.diffuse = layaGIBase(giInput,occlusion, normalWorld);\r\n\tgi.specular = layaGIIndirectSpecular(giInput,occlusion, uvwRoughness);\r\n\treturn gi;\r\n}\r\n\r\n\r\n'),ue.addInclude("Shadow.glsl",'#ifndef GRAPHICS_API_GLES3\r\n\t#define NO_NATIVE_SHADOWMAP\r\n#endif\r\n\r\n#ifdef NO_NATIVE_SHADOWMAP\r\n\t#define TEXTURE2D_SHADOW(textureName) uniform mediump sampler2D textureName\r\n\t#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) (texture2D(textureName,coord3.xy).r<coord3.z?0.0:1.0)\r\n\t#define TEXTURE2D_SHADOW_PARAM(shadowMap) mediump sampler2D shadowMap\r\n#else\r\n\t#define TEXTURE2D_SHADOW(textureName) uniform mediump sampler2DShadow textureName\r\n\t#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) textureLod(textureName,coord3,0.0)\r\n\t#define TEXTURE2D_SHADOW_PARAM(shadowMap) mediump sampler2DShadow shadowMap\r\n#endif\r\n\r\n#if defined(RECEIVESHADOW)&&defined(SHADOW)\r\n    #define CALCULATE_SHADOWS\r\n#endif\r\n\r\n#if defined(RECEIVESHADOW)&&defined(SHADOW_SPOT)\r\n\t#define CALCULATE_SPOTSHADOWS\r\n#endif\r\n\r\nuniform vec4 u_ShadowBias; // x: depth bias, y: normal bias\r\n\r\n#if defined(CALCULATE_SHADOWS)||defined(CALCULATE_SPOTSHADOWS)\r\n\t#include "ShadowSampleTent.glsl"\r\n\tuniform vec4 u_ShadowMapSize;\r\n\tuniform vec4 u_ShadowParams; // x: shadowStrength y: ShadowSpotLightStrength\r\n\r\n\t\r\n\tfloat sampleShdowMapFiltered4(TEXTURE2D_SHADOW_PARAM(shadowMap),vec3 shadowCoord,vec4 shadowMapSize)\r\n\t{\r\n\t\tfloat attenuation;\r\n\t\tvec4 attenuation4;\r\n\t\tvec2 offset=shadowMapSize.xy/2.0;\r\n\t\tvec3 shadowCoord0=shadowCoord + vec3(-offset,0.0);\r\n\t\tvec3 shadowCoord1=shadowCoord + vec3(offset.x,-offset.y,0.0);\r\n\t\tvec3 shadowCoord2=shadowCoord + vec3(-offset.x,offset.y,0.0);\r\n\t\tvec3 shadowCoord3=shadowCoord + vec3(offset,0.0);\r\n\t\tattenuation4.x = SAMPLE_TEXTURE2D_SHADOW(shadowMap, shadowCoord0);\r\n\t\tattenuation4.y = SAMPLE_TEXTURE2D_SHADOW(shadowMap, shadowCoord1);\r\n\t\tattenuation4.z = SAMPLE_TEXTURE2D_SHADOW(shadowMap, shadowCoord2);\r\n\t\tattenuation4.w = SAMPLE_TEXTURE2D_SHADOW(shadowMap, shadowCoord3);\r\n\t\tattenuation = dot(attenuation4, vec4(0.25));\r\n\t\treturn attenuation;\r\n\t}\r\n\r\n\tfloat sampleShdowMapFiltered9(TEXTURE2D_SHADOW_PARAM(shadowMap),vec3 shadowCoord,vec4 shadowmapSize)\r\n\t{\r\n\t\tfloat attenuation;\r\n\t\tfloat fetchesWeights[9];\r\n\t\tvec2 fetchesUV[9];\r\n\t\tsampleShadowComputeSamplesTent5x5(shadowmapSize, shadowCoord.xy, fetchesWeights, fetchesUV);\r\n\t\tattenuation = fetchesWeights[0] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[0].xy, shadowCoord.z));\r\n\t\tattenuation += fetchesWeights[1] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[1].xy, shadowCoord.z));\r\n\t\tattenuation += fetchesWeights[2] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[2].xy, shadowCoord.z));\r\n\t\tattenuation += fetchesWeights[3] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[3].xy, shadowCoord.z));\r\n\t\tattenuation += fetchesWeights[4] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[4].xy, shadowCoord.z));\r\n\t\tattenuation += fetchesWeights[5] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[5].xy, shadowCoord.z));\r\n\t\tattenuation += fetchesWeights[6] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[6].xy, shadowCoord.z));\r\n\t\tattenuation += fetchesWeights[7] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[7].xy, shadowCoord.z));\r\n\t\tattenuation += fetchesWeights[8] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[8].xy, shadowCoord.z));\r\n\t\treturn attenuation;\r\n\t}\r\n\r\n#endif\r\n\r\n\r\n\r\n\r\n#ifdef CALCULATE_SHADOWS\r\n\r\n\tTEXTURE2D_SHADOW(u_ShadowMap);\r\n\r\n\tuniform mat4 u_ShadowMatrices[4];\r\n\tuniform vec4 u_ShadowSplitSpheres[4];// max cascade is 4\r\n\r\n\tmediump int computeCascadeIndex(vec3 positionWS)\r\n\t{\r\n\t\tvec3 fromCenter0 = positionWS - u_ShadowSplitSpheres[0].xyz;\r\n\t\tvec3 fromCenter1 = positionWS - u_ShadowSplitSpheres[1].xyz;\r\n\t\tvec3 fromCenter2 = positionWS - u_ShadowSplitSpheres[2].xyz;\r\n\t\tvec3 fromCenter3 = positionWS - u_ShadowSplitSpheres[3].xyz;\r\n\r\n\t\tmediump vec4 comparison = vec4(\r\n\t\t\tdot(fromCenter0, fromCenter0)<u_ShadowSplitSpheres[0].w,\r\n\t\t\tdot(fromCenter1, fromCenter1)<u_ShadowSplitSpheres[1].w,\r\n\t\t\tdot(fromCenter2, fromCenter2)<u_ShadowSplitSpheres[2].w,\r\n\t\t\tdot(fromCenter3, fromCenter3)<u_ShadowSplitSpheres[3].w);\r\n\t\tcomparison.yzw = clamp(comparison.yzw - comparison.xyz,0.0,1.0);//keep the nearest\r\n\t\tmediump vec4 indexCoefficient = vec4(4.0,3.0,2.0,1.0);\r\n\t\tmediump int index = 4 - int(dot(comparison, indexCoefficient));\r\n\t\treturn index;\r\n\t}\r\n\r\n\tvec4 getShadowCoord(vec4 positionWS)\r\n\t{\r\n\t\t#ifdef SHADOW_CASCADE\r\n\t\t\tmediump int cascadeIndex = computeCascadeIndex(positionWS.xyz);\r\n\t\t\tif(cascadeIndex > 3)// out of shadow range cascadeIndex is 4.\r\n\t\t\t\treturn vec4(0.0);\r\n\t\t\t\r\n\t\t\t#ifdef GRAPHICS_API_GLES3\r\n\t\t\t\treturn u_ShadowMatrices[cascadeIndex] * positionWS;\r\n\t\t\t#else\r\n\t\t\t\tmat4 shadowMat;\r\n\t\t\t\tif(cascadeIndex == 0)\r\n\t\t\t\t\tshadowMat = u_ShadowMatrices[0];\r\n\t\t\t\telse if(cascadeIndex == 1)\r\n\t\t\t\t\tshadowMat = u_ShadowMatrices[1];\r\n\t\t\t\telse if(cascadeIndex == 2)\r\n\t\t\t\t\tshadowMat = u_ShadowMatrices[2];\r\n\t\t\t\telse\r\n\t\t\t\t\tshadowMat = u_ShadowMatrices[3];\r\n\t\t\t\treturn shadowMat * positionWS;\r\n\t\t\t#endif\r\n\t\t#else\r\n\t\t\treturn u_ShadowMatrices[0] * positionWS;\r\n\t\t#endif\r\n\t}\r\n\r\n\tfloat sampleShadowmap(vec4 shadowCoord)\r\n\t{\r\n\t\tshadowCoord.xyz /= shadowCoord.w;\r\n\t\tfloat attenuation = 1.0;\r\n\t\tif(shadowCoord.z > 0.0 && shadowCoord.z < 1.0)\r\n\t\t{\r\n\t\t\t#if defined(SHADOW_SOFT_SHADOW_HIGH)\r\n\t\t\t\tattenuation = sampleShdowMapFiltered9(u_ShadowMap,shadowCoord.xyz,u_ShadowMapSize);\r\n\t\t\t#elif defined(SHADOW_SOFT_SHADOW_LOW)\r\n\t\t\t\tattenuation = sampleShdowMapFiltered4(u_ShadowMap,shadowCoord.xyz,u_ShadowMapSize);\r\n\t\t\t#else\r\n\t\t\t\tattenuation = SAMPLE_TEXTURE2D_SHADOW(u_ShadowMap,shadowCoord.xyz);\r\n\t\t\t#endif\r\n\t\t\tattenuation = mix(1.0,attenuation,u_ShadowParams.x);//shadowParams.x:shadow strength\r\n\t\t}\r\n\t\treturn attenuation;\r\n\t}\r\n#endif\r\n\r\n#ifdef CALCULATE_SPOTSHADOWS\r\n\tTEXTURE2D_SHADOW(u_SpotShadowMap);\r\n\tuniform mat4 u_SpotViewProjectMatrix;\r\n\tfloat sampleSpotShadowmap(vec4 shadowCoord)\r\n\t{\r\n\t\tshadowCoord.xyz /= shadowCoord.w;\r\n\t\tfloat attenuation = 1.0;\r\n\t\tshadowCoord.xy +=1.0;\r\n\t\tshadowCoord.xy/=2.0; \r\n\t\tif(shadowCoord.z > 0.0 && shadowCoord.z < 1.0)\r\n\t\t{\r\n\t\t\t#if defined(SHADOW_SPOT_SOFT_SHADOW_HIGH)\r\n\t\t\t\tattenuation = sampleShdowMapFiltered9(u_SpotShadowMap,shadowCoord.xyz,u_ShadowMapSize);\r\n\t\t\t#elif defined(SHADOW_SPOT_SOFT_SHADOW_LOW)\r\n\t\t\t\tattenuation = sampleShdowMapFiltered4(u_SpotShadowMap,shadowCoord.xyz,u_ShadowMapSize);\r\n\t\t\t#else\r\n\t\t\t\tattenuation = SAMPLE_TEXTURE2D_SHADOW(u_SpotShadowMap,shadowCoord.xyz);\r\n\t\t\t#endif\r\n\t\t\tattenuation = mix(1.0,attenuation,u_ShadowParams.y);//shadowParams.y:shadow strength\r\n\t\t}\r\n\t\treturn attenuation;\r\n\t}\r\n#endif\r\n\r\nvec3 applyShadowBias(vec3 positionWS, vec3 normalWS, vec3 lightDirection)\r\n{\r\n    float invNdotL = 1.0 - clamp(dot(-lightDirection, normalWS),0.0,1.0);\r\n    float scale = invNdotL * u_ShadowBias.y;\r\n\r\n    // normal bias is negative since we want to apply an inset normal offset\r\n    positionWS += -lightDirection * u_ShadowBias.xxx;\r\n    positionWS += normalWS * vec3(scale);\r\n    return positionWS;\r\n}\r\n'),ue.addInclude("ShadowCasterVS.glsl",'#include "Lighting.glsl";\r\n#include "Shadow.glsl"\r\n\r\nattribute vec4 a_Position;\r\nattribute vec3 a_Normal;\r\n\r\n#ifdef BONE\r\n\tconst int c_MaxBoneCount = 24;\r\n\tattribute vec4 a_BoneIndices;\r\n\tattribute vec4 a_BoneWeights;\r\n\tuniform mat4 u_Bones[c_MaxBoneCount];\r\n#endif\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_WorldMat;\r\n#else\r\n\tuniform mat4 u_WorldMat;\r\n#endif\r\n\r\nuniform mat4 u_ViewProjection;\r\n\r\n#ifdef SHADOW\r\n\tuniform vec3 u_ShadowLightDirection;\r\n#endif\r\n\r\n\r\n\r\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\r\n\tattribute vec2 a_Texcoord0;\r\n\tvarying vec2 v_Texcoord0;\r\n#endif\r\n\r\nvec4 shadowCasterVertex()\r\n{\r\n\tmat4 worldMat;\r\n\t#ifdef GPU_INSTANCE\r\n\t\tworldMat = a_WorldMat;\r\n\t#else\r\n\t\tworldMat = u_WorldMat;\r\n\t#endif\r\n\t\r\n\t#ifdef BONE\r\n\t\tmat4 skinTransform;\r\n\t \t#ifdef SIMPLEBONE\r\n\t\t\tfloat currentPixelPos;\r\n\t\t\t#ifdef GPU_INSTANCE\r\n\t\t\t\tcurrentPixelPos = a_SimpleTextureParams.x+a_SimpleTextureParams.y;\r\n\t\t\t#else\r\n\t\t\t\tcurrentPixelPos = u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\r\n\t\t\t#endif\r\n\t\t\tfloat offset = 1.0/u_SimpleAnimatorTextureSize;\r\n\t\t\tskinTransform =  loadMatFromTexture(currentPixelPos,int(a_BoneIndices.x),offset) * a_BoneWeights.x;\r\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.y),offset) * a_BoneWeights.y;\r\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.z),offset) * a_BoneWeights.z;\r\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.w),offset) * a_BoneWeights.w;\r\n\t\t#else\r\n\t\t\tskinTransform =  u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\r\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\r\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\r\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\r\n\t\t#endif\r\n\t\tworldMat = worldMat * skinTransform;\r\n\t#endif\r\n\r\n\tvec4 positionWS = worldMat * a_Position;\r\n\tvec3 normalWS = normalize(a_Normal*INVERSE_MAT(mat3(worldMat)));//if no normalize will cause precision problem\r\n\r\n\t#ifdef SHADOW\r\n\t\tpositionWS.xyz = applyShadowBias(positionWS.xyz,normalWS,u_ShadowLightDirection);\r\n\t#endif\r\n\r\n\tvec4 positionCS = u_ViewProjection * positionWS;\r\n\t#ifdef SHADOW_SPOT\r\n\t\tpositionCS.z = positionCS.z-u_ShadowBias.x/positionCS.w;\r\n\t#endif\r\n\tpositionCS.z = max(positionCS.z, 0.0);//min ndc z is 0.0\r\n\t\r\n\t// //TODO没考虑UV动画呢\r\n\t// #if defined(DIFFUSEMAP)&&defined(ALPHATEST)\r\n\t// \tv_Texcoord0=a_Texcoord0;\r\n\t// #endif\r\n    return positionCS;\r\n}\r\n'),ue.addInclude("ShadowCasterFS.glsl","// #ifdef ALPHATEST\r\n// \tuniform float u_AlphaTestValue;\r\n// #endif\r\n\r\n// #ifdef DIFFUSEMAP\r\n// \tuniform sampler2D u_DiffuseTexture;\r\n// #endif\r\n\r\n// #if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\r\n// \tvarying vec2 v_Texcoord0;\r\n// #endif\r\n\r\nvec4 shadowCasterFragment()\r\n{\r\n    return vec4(0.0);\r\n    // #if defined(DIFFUSEMAP)&&defined(ALPHATEST)\r\n\t// \tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\r\n\t// \tif( alpha < u_AlphaTestValue )\r\n\t// \t{\r\n\t// \t\tdiscard;\r\n\t// \t}\r\n\t// #endif\r\n}\r\n"),ue.addInclude("Colors.glsl",'#include "StdLib.glsl";\r\n\r\n#define EPSILON 1.0e-4\r\n\r\n// Quadratic color thresholding\r\n// curve = (threshold - knee, knee * 2, 0.25 / knee)\r\nmediump vec4 quadraticThreshold(mediump vec4 color, mediump float threshold, mediump vec3 curve) {\r\n\t// Pixel brightness\r\n\tmediump float br = max3(color.r, color.g, color.b);\r\n\r\n\t// Under-threshold part: quadratic curve\r\n\tmediump float rq = clamp(br - curve.x, 0.0, curve.y);\r\n\trq = curve.z * rq * rq;\r\n\r\n\t// Combine and apply the brightness response curve.\r\n\tcolor *= max(rq, br - threshold) / max(br, EPSILON);\r\n\r\n\treturn color;\r\n}\r\n\r\n\r\n\r\n//\r\n// sRGB transfer functions\r\n// Fast path ref: http://chilliant.blogspot.com.au/2012/08/srgb-approximations-for-hlsl.html?m=1\r\n//\r\nmediump vec3 sRGBToLinear(mediump vec3 c) {\r\n\t#ifdef USE_VERY_FAST_SRGB\r\n\t\treturn c * c;\r\n\t#elif defined(USE_FAST_SRGB)\r\n\t\treturn c * (c * (c * 0.305306011 + 0.682171111) + 0.012522878);\r\n\t#else\r\n\t\tmediump vec3 linearRGBLo = c / 12.92;\r\n\t\tmediump vec3 power=vec3(2.4, 2.4, 2.4);\r\n\t\tmediump vec3 linearRGBHi = positivePow((c + 0.055) / 1.055, power);\r\n\t\tmediump vec3 linearRGB =vec3((c.r<=0.04045) ? linearRGBLo.r : linearRGBHi.r,(c.g<=0.04045) ? linearRGBLo.g : linearRGBHi.g,(c.b<=0.04045) ? linearRGBLo.b : linearRGBHi.b);\r\n\t\treturn linearRGB;\r\n\t#endif\r\n}\r\n\r\nmediump vec4 sRGBToLinear(mediump vec4 c){\r\n    return vec4(sRGBToLinear(c.rgb), c.a);\r\n}\r\n\r\n\r\n\r\nmediump vec3 linearToSRGB(mediump vec3 c) {\r\n\t#ifdef USE_VERY_FAST_SRGB\r\n\t\treturn sqrt(c);\r\n\t#elif defined(USE_FAST_SRGB)\r\n\t\treturn max(1.055 * PositivePow(c, 0.416666667) - 0.055, 0.0);\r\n\t#else\r\n\t\tmediump vec3 sRGBLo = c * 12.92;\r\n\t\tmediump vec3 power=vec3(1.0 / 2.4, 1.0 / 2.4, 1.0 / 2.4);\r\n\t\tmediump vec3 sRGBHi = (positivePow(c, power) * 1.055) - 0.055;\r\n\t\tmediump vec3 sRGB =vec3((c.r<=0.0031308) ? sRGBLo.r : sRGBHi.r,(c.g<=0.0031308) ? sRGBLo.g : sRGBHi.g,(c.b<=0.0031308) ? sRGBLo.b : sRGBHi.b);\r\n\t\treturn sRGB;\r\n\t#endif\r\n}\r\n\r\nmediump vec4 linearToSRGB(mediump vec4 c){\r\n    return vec4(linearToSRGB(c.rgb), c.a);\r\n}'),ue.addInclude("Sampling.glsl","// Better, temporally stable box filtering\r\n// [Jimenez14] http://goo.gl/eomGso\r\n// . . . . . . .\r\n// . A . B . C .\r\n// . . D . E . .\r\n// . F . G . H .\r\n// . . I . J . .\r\n// . K . L . M .\r\n// . . . . . . .\r\nmediump vec4 downsampleBox13Tap(sampler2D tex, vec2 uv, vec2 texelSize)\r\n{\r\n    mediump vec4 A = texture2D(tex, uv + texelSize * vec2(-1.0, -1.0));\r\n    mediump vec4 B = texture2D(tex, uv + texelSize * vec2( 0.0, -1.0));\r\n    mediump vec4 C = texture2D(tex, uv + texelSize * vec2( 1.0, -1.0));\r\n    mediump vec4 D = texture2D(tex, uv + texelSize * vec2(-0.5, -0.5));\r\n    mediump vec4 E = texture2D(tex, uv + texelSize * vec2( 0.5, -0.5));\r\n    mediump vec4 F = texture2D(tex, uv + texelSize * vec2(-1.0,  0.0));\r\n    mediump vec4 G = texture2D(tex, uv);\r\n    mediump vec4 H = texture2D(tex, uv + texelSize * vec2( 1.0,  0.0));\r\n    mediump vec4 I = texture2D(tex, uv + texelSize * vec2(-0.5,  0.5));\r\n    mediump vec4 J = texture2D(tex, uv + texelSize * vec2( 0.5,  0.5));\r\n    mediump vec4 K = texture2D(tex, uv + texelSize * vec2(-1.0,  1.0));\r\n    mediump vec4 L = texture2D(tex, uv + texelSize * vec2( 0.0,  1.0));\r\n    mediump vec4 M = texture2D(tex, uv + texelSize * vec2( 1.0,  1.0));\r\n\r\n\tmediump vec2 scale= vec2(0.5, 0.125);\r\n    mediump vec2 div = (1.0 / 4.0) * scale;\r\n\r\n    mediump vec4 o = (D + E + I + J) * div.x;\r\n    o += (A + B + G + F) * div.y;\r\n    o += (B + C + H + G) * div.y;\r\n    o += (F + G + L + K) * div.y;\r\n    o += (G + H + M + L) * div.y;\r\n\r\n    return o;\r\n}\r\n\r\n// Standard box filtering\r\nmediump vec4 downsampleBox4Tap(sampler2D tex, vec2 uv, vec2 texelSize)\r\n{\r\n    vec4 d = texelSize.xyxy * vec4(-1.0, -1.0, 1.0, 1.0);\r\n\r\n    mediump vec4 s =  texture2D(tex, uv + d.xy);\r\n    s += texture2D(tex, uv + d.zy);\r\n    s += texture2D(tex, uv + d.xw);\r\n    s += texture2D(tex, uv + d.zw);\r\n\r\n    return s * (1.0 / 4.0);\r\n}\r\n\r\n// 9-tap bilinear upsampler (tent filter)\r\n// . . . . . . .\r\n// . 1 . 2 . 1 .\r\n// . . . . . . .\r\n// . 2 . 4 . 2 .\r\n// . . . . . . .\r\n// . 1 . 2 . 1 .\r\n// . . . . . . .\r\nmediump vec4 upsampleTent(sampler2D tex, vec2 uv, vec2 texelSize, vec4 sampleScale)\r\n{\r\n    vec4 d = texelSize.xyxy * vec4(1.0, 1.0, -1.0, 0.0) * sampleScale;\r\n\r\n    mediump vec4 s =  texture2D(tex, uv - d.xy);\r\n    s += texture2D(tex, uv - d.wy) * 2.0;\r\n    s += texture2D(tex, uv - d.zy);\r\n\r\n    s += texture2D(tex, uv + d.zw) * 2.0;\r\n    s += texture2D(tex, uv) * 4.0;\r\n    s += texture2D(tex,\tuv + d.xw) * 2.0;\r\n\r\n    s += texture2D(tex, uv + d.zy);\r\n    s += texture2D(tex, uv + d.wy) * 2.0;\r\n    s += texture2D(tex, uv + d.xy);\r\n\r\n    return s * (1.0 / 16.0);\r\n}\r\n\r\n// Standard box filtering\r\nmediump vec4 upsampleBox(sampler2D tex, vec2 uv, vec2 texelSize, vec4 sampleScale)\r\n{\r\n    vec4 d = texelSize.xyxy * vec4(-1.0, -1.0, 1.0, 1.0) * 0.5 * sampleScale;\r\n\r\n    mediump vec4 s =  texture2D(tex, uv + d.xy);\r\n    s += texture2D(tex, uv + d.zy);\r\n    s += texture2D(tex, uv + d.xw);\r\n    s += texture2D(tex, uv + d.zw);\r\n\r\n    return s * (1.0 / 4.0);\r\n}"),ue.addInclude("StdLib.glsl","#define HALF_MAX       65504.0 // (2 - 2^-10) * 2^15\r\n\r\n#define FLT_EPSILON    1.192092896e-07 // Smallest positive number, such that 1.0 + FLT_EPSILON != 1.0\r\n\r\nmediump vec4 safeHDR(mediump vec4 c)\r\n{\r\n    return min(c, HALF_MAX);\r\n}\r\n\r\nfloat max3(float a, float b, float c)\r\n{\r\n    return max(max(a, b), c);\r\n}\r\n\r\nvec3 positivePow(vec3 base, vec3 power)\r\n{\r\n    return pow(max(abs(base), vec3(FLT_EPSILON, FLT_EPSILON, FLT_EPSILON)), power);\r\n}"),ue.addInclude("PBRVSInput.glsl","attribute vec4 a_Position;\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_MvpMatrix;\r\n\tattribute mat4 a_WorldMat;\r\n#else\r\n\tuniform mat4 u_MvpMatrix;\r\n\tuniform mat4 u_WorldMat;\r\n#endif\r\n\r\n#ifdef BONE\r\n\tconst int c_MaxBoneCount = 24;\r\n\tattribute vec4 a_BoneIndices;\r\n\tattribute vec4 a_BoneWeights;\r\n\tuniform mat4 u_Bones[c_MaxBoneCount];\r\n#endif\r\n\r\nattribute vec3 a_Normal;\r\nvarying vec3 v_Normal; \r\n\r\n#if defined(NORMALTEXTURE)||defined(PARALLAXTEXTURE)\r\n\tattribute vec4 a_Tangent0;\r\n\tvarying vec3 v_Tangent;\r\n\tvarying vec3 v_Binormal;\r\n    #ifdef PARALLAXTEXTURE\r\n\t    varying vec3 v_ViewDirForParallax;\r\n    #endif\r\n#endif\r\n\r\n#if defined(ALBEDOTEXTURE)||defined(METALLICGLOSSTEXTURE)||defined(NORMALTEXTURE)||defined(EMISSIONTEXTURE)||defined(OCCLUSIONTEXTURE)||defined(PARALLAXTEXTURE)||(defined(LIGHTMAP)&&defined(UV))\r\n\tattribute vec2 a_Texcoord0;\r\n\tvarying vec2 v_Texcoord0;\r\n#endif\r\n\r\n#if defined(LIGHTMAP)&&defined(UV1)\r\n\tattribute vec2 a_Texcoord1;\r\n#endif\r\n\r\n#ifdef LIGHTMAP\r\n\tuniform vec4 u_LightmapScaleOffset;\r\n\tvarying vec2 v_LightMapUV;\r\n#endif\r\n\r\nuniform vec3 u_CameraPos;\r\nvarying vec3 v_EyeVec;\r\nvarying vec3 v_PositionWorld;\r\nvarying float v_posViewZ;\r\n\r\n#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\r\n\tvarying vec4 v_ShadowCoord;\r\n#endif\r\n\r\n#ifdef CALCULATE_SPOTSHADOWS\r\n\tvarying vec4 v_SpotShadowCoord;\r\n#endif\r\n\r\n#ifdef TILINGOFFSET\r\n\tuniform vec4 u_TilingOffset;\r\n#endif\r\n\r\n\r\n#ifdef SIMPLEBONE\r\n\t#ifdef GPU_INSTANCE\r\n\t\tattribute vec4 a_SimpleTextureParams;\r\n\t#else\r\n\t\tuniform vec4 u_SimpleAnimatorParams;\r\n\t#endif\r\n\tuniform sampler2D u_SimpleAnimatorTexture;\r\n\r\n\tuniform float u_SimpleAnimatorTextureSize; \r\n#endif\r\n\r\n\r\n#ifdef SIMPLEBONE\r\nmat4 loadMatFromTexture(float FramePos,int boneIndices,float offset)\r\n{\r\n\tvec2 uv;\r\n\tfloat PixelPos = FramePos+float(boneIndices)*4.0;\r\n\tfloat halfOffset = offset * 0.5;\r\n\tfloat uvoffset = PixelPos/u_SimpleAnimatorTextureSize;\r\n\tuv.y = floor(uvoffset)*offset+halfOffset;\r\n\tuv.x = mod(float(PixelPos),u_SimpleAnimatorTextureSize)*offset+halfOffset;\r\n\tvec4 mat0row = texture2D(u_SimpleAnimatorTexture,uv);\r\n\tuv.x+=offset;\r\n\tvec4 mat1row = texture2D(u_SimpleAnimatorTexture,uv);\r\n\tuv.x+=offset;\r\n\tvec4 mat2row = texture2D(u_SimpleAnimatorTexture,uv);\r\n\tuv.x+=offset;\r\n\tvec4 mat3row = texture2D(u_SimpleAnimatorTexture,uv);\r\n\tmat4 m =mat4(mat0row.x,mat0row.y,mat0row.z,mat0row.w,\r\n\t\t\t  mat1row.x,mat1row.y,mat1row.z,mat1row.w,\r\n\t\t\t  mat2row.x,mat2row.y,mat2row.z,mat2row.w,\r\n\t\t\t  mat3row.x,mat3row.y,mat3row.z,mat3row.w);\r\n\treturn m;\r\n}\r\n#endif"),ue.addInclude("PBRFSInput.glsl","#ifdef ALPHATEST\r\n\tuniform float u_AlphaTestValue;\r\n#endif\r\n\r\nuniform vec4 u_AlbedoColor;\r\n\r\n#ifdef NORMALTEXTURE\r\n\tuniform sampler2D u_NormalTexture;\r\n\tuniform float u_NormalScale;\r\n#endif\r\n\r\n#ifdef ALBEDOTEXTURE\r\n\tuniform sampler2D u_AlbedoTexture;\r\n#endif\r\n\r\n#ifdef METALLICGLOSSTEXTURE\r\n\tuniform sampler2D u_MetallicGlossTexture;\r\n#endif\r\nuniform float u_Metallic;\r\n\r\n#ifdef SPECULARGLOSSTEXTURE\r\n\tuniform sampler2D u_SpecGlossTexture;\r\n#endif\r\nuniform vec3 u_SpecularColor;\r\n\r\nuniform float u_Smoothness;\r\nuniform float u_SmoothnessScale;\r\n\r\n#ifdef PARALLAXTEXTURE\r\n\tuniform sampler2D u_ParallaxTexture;\r\n\tuniform float u_ParallaxScale;\r\n\tvarying vec3 v_ViewDirForParallax;\r\n#endif\r\n\r\n#ifdef OCCLUSIONTEXTURE\r\n\tuniform sampler2D u_OcclusionTexture;\r\n\tuniform float u_occlusionStrength;\r\n#endif\r\n\r\n#ifdef EMISSION \r\n\t#ifdef EMISSIONTEXTURE\r\n\t\tuniform sampler2D u_EmissionTexture;\r\n\t#endif\r\n\tuniform vec4 u_EmissionColor;\r\n#endif\r\n\r\n#if defined(ALBEDOTEXTURE)||defined(METALLICGLOSSTEXTURE)||defined(NORMALTEXTURE)||defined(EMISSIONTEXTURE)||defined(OCCLUSIONTEXTURE)||defined(PARALLAXTEXTURE)\r\n\tvarying vec2 v_Texcoord0;\r\n#endif\r\n\r\n#ifdef LIGHTMAP\r\n\tvarying vec2 v_LightMapUV;\r\n\tuniform sampler2D u_LightMap;\r\n\t#ifdef LIGHTMAP_DIRECTIONAL\r\n\t\tuniform sampler2D u_LightMapDirection;\r\n\t#endif\r\n#endif\r\n\r\nvarying vec3 v_Normal; \r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t#ifdef LEGACYSINGLELIGHTING\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tuniform DirectionLight u_DirectionLight;\r\n\t\t#endif\r\n\t\t#ifdef POINTLIGHT\r\n\t\t\tuniform PointLight u_PointLight;\r\n\t\t#endif\r\n\t\t#ifdef SPOTLIGHT\r\n\t\t\tuniform SpotLight u_SpotLight;\r\n\t\t#endif\r\n\t#else\r\n\t\tuniform mat4 u_View;\r\n\t\tuniform vec4 u_ProjectionParams;\r\n\t\tuniform vec4 u_Viewport;\r\n\t\tuniform int u_DirationLightCount;\r\n\t\tuniform sampler2D u_LightBuffer;\r\n\t\tuniform sampler2D u_LightClusterBuffer;\r\n\t#endif\r\n#endif\r\n\r\nvarying vec3 v_EyeVec;\r\n\r\n#ifdef NORMALTEXTURE\r\n\tvarying vec3 v_Tangent;\r\n\tvarying vec3 v_Binormal;\r\n#endif\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\tuniform vec3 u_FogColor;\r\n#endif\r\n\r\n\r\n//后面考虑宏TODO\r\nvarying vec3 v_PositionWorld;\r\n\r\n#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\r\n\tvarying vec4 v_ShadowCoord;\r\n#endif\r\n\r\n#ifdef CALCULATE_SPOTSHADOWS\r\n\tvarying vec4 v_SpotShadowCoord;\r\n#endif\r\n\r\nmediump float lerpOneTo(mediump float b, mediump float t)\r\n{\r\n    mediump float oneMinusT = 1.0 - t;\r\n    return oneMinusT + b * t;\r\n}\r\n\r\n#ifdef EMISSION \r\n\tvec3 emission(vec2 uv)\r\n\t{\r\n\t\t#ifdef EMISSIONTEXTURE\r\n\t\t\treturn texture2D(u_EmissionTexture, uv).rgb * u_EmissionColor.rgb;\r\n\t\t#else\r\n\t\t\treturn u_EmissionColor.rgb;\r\n\t\t#endif\r\n\t}\r\n#endif\r\n\r\nmediump float getAlpha(vec2 uv)\r\n{\r\n\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\r\n\t\treturn u_AlbedoColor.a;\r\n\t#else\r\n\t\t#ifdef ALBEDOTEXTURE\r\n\t\t\treturn texture2D(u_AlbedoTexture, uv).a * u_AlbedoColor.a;\r\n\t\t#else\r\n\t\t\treturn u_AlbedoColor.a;\r\n\t\t#endif\r\n\t#endif\r\n}\r\n\r\nmediump float getOcclusion(vec2 uv)\r\n{\r\n\t#ifdef OCCLUSIONTEXTURE\r\n\t\tmediump float occ = texture2D(u_OcclusionTexture, uv).g;\r\n\t\treturn lerpOneTo(occ, u_occlusionStrength);\r\n\t#else\r\n\t\treturn 1.0;\r\n\t#endif\r\n}\r\n\r\nmediump vec3 albedo(vec2 uv)\r\n{\r\n\t#ifdef ALBEDOTEXTURE\r\n\t\treturn u_AlbedoColor.rgb * texture2D(u_AlbedoTexture, uv).rgb;\r\n\t#else\r\n\t\treturn u_AlbedoColor.rgb;\r\n\t#endif\r\n\t//TODO:Detail Texture\r\n}\r\n\r\nmediump vec2 getMetallicGloss(vec2 uv)\r\n{\r\n\tmediump vec2 ms;//x is metallic,y is smoothness\r\n\t#ifdef METALLICGLOSSTEXTURE\r\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\r\n\t\t\tms.x = texture2D(u_MetallicGlossTexture, uv).r;\r\n\t\t\t#ifdef ALBEDOTEXTURE\r\n\t\t\t\tms.y = texture2D(u_AlbedoTexture, uv).a*u_SmoothnessScale;\r\n\t\t\t#else\r\n\t\t\t\tms.y = u_SmoothnessScale;\r\n\t\t\t#endif\r\n\t\t#else\r\n\t\t\tms = texture2D(u_MetallicGlossTexture, uv).ra;\r\n\t\t\tms.y *= u_SmoothnessScale;\r\n\t\t#endif\r\n\t#else\r\n\t\tms.x = u_Metallic;\r\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\r\n\t\t\t#ifdef ALBEDOTEXTURE\r\n\t\t\t\tms.y = texture2D(u_AlbedoTexture, uv).a * u_SmoothnessScale;\r\n\t\t\t#else\r\n\t\t\t\tms.y = u_SmoothnessScale;\r\n\t\t\t#endif\r\n\t\t#else\r\n\t\t\tms.y = u_Smoothness;\r\n\t\t#endif\r\n\t#endif\r\n\treturn ms;\r\n}\r\n\r\nmediump vec4 specularGloss(vec2 uv)\r\n{\r\n\tmediump vec4 sg;\r\n\t#ifdef SPECULARGLOSSTEXTURE\r\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\r\n\t\t\tsg.rgb = texture2D(u_SpecGlossTexture, uv).rgb;\r\n\t\t\t#ifdef ALBEDOTEXTURE\r\n\t\t\t\tsg.a = texture2D(u_AlbedoTexture, uv).a*u_SmoothnessScale;\r\n\t\t\t#else\r\n\t\t\t\tsg.a = u_SmoothnessScale;\r\n\t\t\t#endif\r\n\t\t#else\r\n\t\t\tsg = texture2D(u_SpecGlossTexture, uv);\r\n\t\t\tsg.a *= u_SmoothnessScale;\r\n\t\t#endif\r\n\t#else\r\n\t\tsg.rgb = u_SpecularColor.rgb;\r\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\r\n\t\t\t#ifdef ALBEDOTEXTURE\r\n\t\t\t\tsg.a = texture2D(u_AlbedoTexture, uv).a * u_SmoothnessScale;\r\n\t\t\t#else\r\n\t\t\t\tsg.a = u_SmoothnessScale;\r\n\t\t\t#endif\r\n\t\t#else\r\n\t\t\tsg.a = u_Smoothness;\r\n\t\t#endif\r\n\t#endif\r\n\t\treturn sg;\r\n}\r\n\r\n\r\n#ifdef NORMALTEXTURE\r\n\tmediump vec3 unpackScaleNormal(mediump vec3 packednormal, mediump float bumpScale)\r\n\t{\r\n\t\tmediump vec3 normal = packednormal.xyz * 2.0 - 1.0;\r\n\t\tnormal.y=-normal.y;//NOTE:because unity to LayaAir coordSystem.\r\n\t\tnormal.xy *= bumpScale;\r\n\t\treturn normal;\r\n\t}\r\n\t\r\n\tmediump vec3 normalInTangentSpace(vec2 texcoords)\r\n\t{\r\n\t\tmediump vec3 normalTangent = unpackScaleNormal(texture2D(u_NormalTexture, texcoords).rgb,u_NormalScale);\r\n\t\treturn normalTangent;\r\n\t}\r\n#endif\r\n\r\n#ifdef PARALLAXTEXTURE\r\n\tmediump vec2 parallaxOffset1Step(mediump float h, mediump float height, mediump vec3 viewDir)\r\n\t{\r\n\t\th = h * height - height / 2.0;\r\n\t\tviewDir.z += 0.42;\r\n\t\treturn h * (viewDir.xy / viewDir.z);\r\n\t}\r\n\r\n\tvec2 parallax(vec2 texcoords, mediump vec3 viewDir)\r\n\t{\r\n\t\tmediump float h = texture2D(u_ParallaxTexture, texcoords.xy).g;\r\n\t\tvec2 offset = parallaxOffset1Step(h, u_ParallaxScale, viewDir);\r\n\t\treturn texcoords+offset;\r\n\t}\r\n#endif\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"),ue.addInclude("LayaPBRBRDF.glsl",'// allow to explicitly override LAYA_BRDF_GI and LAYA_BRDF_LIGHT in custom shader,default is layaBRDFHighGI and layaBRDFHighLight\r\n#if !defined (LAYA_BRDF_GI) \r\n\t#if defined(LAYA_PBR_BRDF_LOW)\r\n\t\t#define LAYA_BRDF_GI layaBRDFLowGI\r\n\t#elif defined(LAYA_PBR_BRDF_HIGH)\r\n\t\t#define LAYA_BRDF_GI layaBRDFHighGI\r\n\t#endif\r\n#endif\r\n#if !defined (LAYA_BRDF_LIGHT)\r\n\t#if defined(LAYA_PBR_BRDF_LOW)\r\n\t\t#define LAYA_BRDF_LIGHT layaBRDFLowLight\r\n\t#elif defined(LAYA_PBR_BRDF_HIGH)\r\n\t\t#define LAYA_BRDF_LIGHT layaBRDFHighLight\r\n\t#endif\r\n#endif\r\n\r\n#define PI 3.14159265359\r\n#define INV_PI 0.31830988618\r\n\r\nmediump float pow4(mediump float x)\r\n{\r\n\treturn x * x * x * x;\r\n}\r\n\r\nmediump float pow5(mediump float x)\r\n{\r\n\treturn x * x * x * x * x;\r\n}\r\n\r\nmediump vec3 fresnelLerp(mediump vec3 F0,mediump vec3 F90,mediump float cosA)\r\n{\r\n\tfloat t = pow5(1.0 - cosA);   // ala Schlick interpoliation\r\n\treturn mix(F0, F90, t);\r\n}\r\n\r\nmediump vec3 fresnelTerm(mediump vec3 F0,mediump float cosA)\r\n{\r\n\tfloat t = pow5(1.0 - cosA);   // ala Schlick interpoliation\r\n\treturn F0 + (vec3(1.0) - F0) * t;\r\n}\r\n\r\n// approximage Schlick with ^4 instead of ^5\r\nmediump vec3 fresnelLerpFast (mediump vec3 F0, mediump vec3 F90,mediump float cosA)\r\n{\r\n    mediump float t = pow4 (1.0 - cosA);\r\n    return mix (F0, F90, t);\r\n}\r\n\r\nfloat smoothnessToPerceptualRoughness(float smoothness)\r\n{\r\n    return 1.0 - smoothness;\r\n}\r\n\r\nfloat perceptualRoughnessToRoughness(float perceptualRoughness)\r\n{\r\n    return perceptualRoughness * perceptualRoughness;\r\n}\r\n\r\nvec3 safeNormalize(vec3 inVec)\r\n{\r\n\tfloat dp3 = max(0.001,dot(inVec,inVec));\r\n\treturn inVec * inversesqrt(dp3);\r\n}\r\n\r\n// Note: Disney diffuse must be multiply by diffuseAlbedo / PI. This is done outside of this function.\r\nmediump float disneyDiffuse(mediump float NdotV,mediump float NdotL,mediump float LdotH,mediump float perceptualRoughness)\r\n{\r\n\t//https://www.cnblogs.com/herenzhiming/articles/5790389.html\r\n\tmediump float fd90 = 0.5 + 2.0 * LdotH * LdotH * perceptualRoughness;\r\n\t// Two schlick fresnel term\r\n\tmediump float lightScatter = (1.0 + (fd90 - 1.0) * pow5(1.0 - NdotL));\r\n\tmediump float viewScatter = (1.0 + (fd90 - 1.0) * pow5(1.0 - NdotV));\r\n\r\n\treturn lightScatter * viewScatter;\r\n}\r\n\r\n// Ref: http://jcgt.org/published/0003/02/03/paper.pdf\r\nfloat smithJointGGXVisibilityTerm(float NdotL, float NdotV, float roughness)\r\n{\r\n\t// Original formulation:\r\n    // lambda_v    = (-1 + sqrt(a2 * (1 - NdotL2) / NdotL2 + 1)) * 0.5f;\r\n    // lambda_l    = (-1 + sqrt(a2 * (1 - NdotV2) / NdotV2 + 1)) * 0.5f;\r\n    // G           = 1 / (1 + lambda_v + lambda_l);\r\n\r\n\t// scientific code implement:\r\n\t// Reorder code to be more optimal\r\n    // half a          = roughness;\r\n    // half a2         = a * a;\r\n\r\n    // half lambdaV    = NdotL * sqrt((-NdotV * a2 + NdotV) * NdotV + a2);\r\n    // half lambdaL    = NdotV * sqrt((-NdotL * a2 + NdotL) * NdotL + a2);\r\n\r\n    // Simplify visibility term: (2.0f * NdotL * NdotV) /  ((4.0f * NdotL * NdotV) * (lambda_v + lambda_l + 1e-5f));\r\n    // return 0.5f / (lambdaV + lambdaL + 1e-5f);  \r\n\t// This function is not intended to be running on Mobile,therefore epsilon is smaller than can be represented by half\r\n\r\n\t// Approximation of the above formulation (simplify the sqrt, not mathematically correct but close enough)\r\n\tfloat a = roughness;\r\n\tfloat lambdaV = NdotL * (NdotV * (1.0 - a) + a);\r\n\tfloat lambdaL = NdotV * (NdotL * (1.0 - a) + a);\r\n\treturn 0.5 / (lambdaV + lambdaL + 1e-5);\r\n}\r\n\r\nfloat ggxTerm(float NdotH, float roughness)\r\n{\r\n\tfloat a2 = roughness * roughness;\r\n\tfloat d = (NdotH * a2 - NdotH) * NdotH + 1.0; // 2 mad\r\n\treturn INV_PI * a2 / (d * d + 1e-7); // This function is not intended to be running on Mobile,therefore epsilon is smaller than what can be represented by half//返回值小用half来返回\r\n}\r\n\r\n// BRDF1-------------------------------------------------------------------------------------\r\n\r\n// Note: BRDF entry points use smoothness and oneMinusReflectivity for optimization purposes,\r\n// mostly for DX9 SM2.0 level. Most of the math is being done on these (1-x) values, and that saves a few precious ALU slots.\r\n\r\n// Main Physically Based BRDF\r\n// Derived from Disney work and based on Torrance-Sparrow micro-facet model\r\n//\r\n// BRDF = kD / pi + kS * (D * V * F) / 4\r\n// I = BRDF * NdotL\r\n//\r\n// *NDF GGX:\r\n// *Smith for Visiblity term\r\n// *Schlick approximation for Fresnel\r\nmediump vec4 layaBRDFHighLight(mediump vec3 diffColor, mediump vec3 specColor, mediump float oneMinusReflectivity, float perceptualRoughness,float roughness,mediump float nv,vec3 normal, vec3 viewDir,LayaLight light)\r\n{\r\n\tvec3 halfDir = safeNormalize(viewDir-light.dir);\r\n\r\n\tfloat nl = clamp(dot(normal, -light.dir),0.0,1.0);\r\n\tfloat nh = clamp(dot(normal, halfDir),0.0,1.0);\r\n\tmediump float lv = clamp(dot(light.dir, viewDir),0.0,1.0);\r\n\tmediump float lh = clamp(dot(light.dir, -halfDir),0.0,1.0);\r\n\r\n\t// Diffuse term\r\n\tmediump float diffuseTerm = disneyDiffuse(nv, nl, lh, perceptualRoughness) * nl;\r\n\r\n\t// Specular term\r\n    // HACK: theoretically we should divide diffuseTerm by Pi and not multiply specularTerm!\r\n    // BUT that will make shader look significantly darker than Legacy ones\r\n\r\n\t// GGX with roughtness to 0 would mean no specular at all, using max(roughness, 0.002) here to match HDrenderloop roughtness remapping.\r\n\troughness = max(roughness, 0.002);\r\n\tfloat V = smithJointGGXVisibilityTerm(nl, nv, roughness);\r\n\tfloat D = ggxTerm(nh, roughness);\r\n\r\n\tfloat specularTerm = V * D * PI; // Torrance-Sparrow model, Fresnel is applied later\r\n\r\n\t//#ifdef LAYA_COLORSPACE_GAMMA\r\n\tspecularTerm = sqrt(max(1e-4, specularTerm));\r\n\t//#endif\r\n\tspecularTerm = max(0.0, specularTerm * nl);\r\n\t\t\r\n\tmediump vec3 color = diffColor * light.color * diffuseTerm + specularTerm * light.color * fresnelTerm(specColor, lh);\r\n\treturn vec4(color, 1.0);\r\n}\r\n\r\nvec4 layaBRDFHighGI(mediump vec3 diffColor,mediump vec3 specColor,mediump float oneMinusReflectivity,float smoothness ,float perceptualRoughness,float roughness,mediump float nv,vec3 normal, vec3 viewDir,LayaGI gi)\r\n{\r\n\t// surfaceReduction = Int D(NdotH) * NdotH * Id(NdotL>0) dH = 1/(roughness^2+1)\r\n\tfloat surfaceReduction;\r\n\tsurfaceReduction = 1.0 - 0.28*roughness*perceptualRoughness;// 1-0.28*x^3 as approximation for (1/(x^4+1))^(1/2.2) on the domain [0;1]\r\n\tfloat grazingTerm = clamp(smoothness + (1.0 - oneMinusReflectivity),0.0,1.0);\r\n\tmediump vec3 color =diffColor * gi.diffuse + surfaceReduction * gi.specular * fresnelLerp(specColor,vec3(grazingTerm), nv);\r\n\treturn vec4(color,1.0);\r\n}\r\n// BRDF1-------------------------------------------------------------------------------------\r\n\r\n\r\n// BRDF2-------------------------------------------------------------------------------------\r\n// Based on Minimalist CookTorrance BRDF\r\n// Implementation is slightly different from original derivation: http://www.thetenthplanet.de/archives/255\r\n//\r\n// *NDF [Modified] GGX:\r\n// *Modified Kelemen and Szirmay-​Kalos for Visibility term\r\n// *Fresnel approximated with 1/LdotH\r\nmediump vec4 layaBRDFLowLight (mediump vec3 diffColor, mediump vec3 specColor,mediump float oneMinusReflectivity,float perceptualRoughness,float roughness,mediump float nv,vec3 normal,vec3 viewDir,LayaLight light)\r\n{\r\n    vec3 halfDir = safeNormalize (viewDir-light.dir);\r\n    mediump float nl = clamp(dot(normal, -light.dir),0.0,1.0);\r\n    float nh = clamp(dot(normal, halfDir),0.0,1.0);\r\n    float lh = clamp(dot(-light.dir, halfDir),0.0,1.0);\r\n\r\n    // GGX Distribution multiplied by combined approximation of Visibility and Fresnel\r\n    // See "Optimizing PBR for Mobile" from Siggraph 2015 moving mobile graphics course\r\n    // https://community.arm.com/events/1155\r\n    mediump float a = roughness;\r\n    float a2 = a*a;\r\n\r\n    float d = nh * nh * (a2 - 1.0) + 1.00001;\r\n\t// #ifdef LAYA_COLORSPACE_GAMMA\r\n\t\t// Tighter approximation for Gamma only rendering mode!\r\n\t\t// DVF = sqrt(DVF);\r\n\t\t// DVF = (a * sqrt(.25)) / (max(sqrt(0.1), lh)*sqrt(roughness + .5) * d);\r\n\t\tfloat specularTerm = a / (max(0.32, lh) * (1.5 + roughness) * d);\r\n\t// #else\r\n\t// \tfloat specularTerm = a2 / (max(0.1f, lh*lh) * (roughness + 0.5f) * (d * d) * 4);\r\n\t// #endif\r\n\r\n    // on mobiles (where half actually means something) denominator have risk of overflow\r\n    // clamp below was added specifically to "fix" that, but dx compiler (we convert bytecode to metal/gles)\r\n    // sees that specularTerm have only non-negative terms, so it skips max(0,..) in clamp (leaving only min(100,...))\r\n\r\n\t//#if defined (SHADER_API_MOBILE)\r\n    specularTerm = specularTerm - 1e-4;\r\n\t//#endif\r\n\r\n\t// #else\r\n\t\t// // Legacy\r\n\t\t// half specularPower = PerceptualRoughnessToSpecPower(perceptualRoughness);\r\n\t\t// // Modified with approximate Visibility function that takes roughness into account\r\n\t\t// // Original ((n+1)*N.H^n) / (8*Pi * L.H^3) didn\'t take into account roughness\r\n\t\t// // and produced extremely bright specular at grazing angles\r\n\r\n\t\t// half invV = lh * lh * smoothness + perceptualRoughness * perceptualRoughness; // approx ModifiedKelemenVisibilityTerm(lh, perceptualRoughness);\r\n\t\t// half invF = lh;\r\n\r\n\t\t// half specularTerm = ((specularPower + 1) * pow (nh, specularPower)) / (8 * invV * invF + 1e-4h);\r\n\r\n\t\t// #ifdef LAYA_COLORSPACE_GAMMA\r\n\t\t// \tspecularTerm = sqrt(max(1e-4f, specularTerm));\r\n\t\t// #endif\r\n\t// #endif\r\n\r\n\t// #if defined (SHADER_API_MOBILE)\r\n\t\tspecularTerm = clamp(specularTerm, 0.0, 100.0); // Prevent FP16 overflow on mobiles\r\n\t// #endif\r\n    \r\n    mediump vec3 color = (diffColor + specularTerm * specColor) * light.color * nl;\r\n\r\n    return vec4(color, 1.0);\r\n}\r\n\r\nmediump vec4 layaBRDFLowGI (mediump vec3 diffColor, mediump vec3 specColor,mediump float oneMinusReflectivity,mediump float smoothness,float perceptualRoughness,float roughness,mediump float nv,vec3 normal,vec3 viewDir,LayaGI gi)\r\n{\r\n\t// surfaceReduction = Int D(NdotH) * NdotH * Id(NdotL>0) dH = 1/(realRoughness^2+1)\r\n\r\n    // 1-0.28*x^3 as approximation for (1/(x^4+1))^(1/2.2) on the domain [0;1]\r\n    // 1-x^3*(0.6-0.08*x)   approximation for 1/(x^4+1)\r\n\t// #ifdef LAYA_COLORSPACE_GAMMA\r\n\t\tmediump float surfaceReduction = 0.28;\r\n\t// #else\r\n\t\t// mediump float surfaceReduction = (0.6-0.08*perceptualRoughness);\r\n\t// #endif\r\n\r\n    surfaceReduction = 1.0 - roughness*perceptualRoughness*surfaceReduction;\r\n\r\n\tmediump float grazingTerm = clamp(smoothness + (1.0-oneMinusReflectivity),0.0,1.0);\r\n\tmediump vec3 color =gi.diffuse * diffColor+ surfaceReduction * gi.specular * fresnelLerpFast (specColor, vec3(grazingTerm), nv);\r\n\r\n    return vec4(color, 1.0);\r\n}\r\n// BRDF2-------------------------------------------------------------------------------------'),ue.addInclude("PBRCore.glsl","struct FragmentCommonData{\r\n\tvec3 diffColor;\r\n\tvec3 specColor;\r\n\tfloat oneMinusReflectivity;\r\n\tfloat smoothness;\r\n\t//vec3 eyeVec;TODO:maybe can remove\r\n\t//float alpha;\r\n\t//vec3 reflUVW;\r\n};\r\n\r\n#ifndef SETUP_BRDF_INPUT\r\n    #define SETUP_BRDF_INPUT metallicSetup//default is metallicSetup,also can be other. \r\n#endif\r\n\r\nconst mediump vec4 dielectricSpecularColor = vec4(0.220916301, 0.220916301, 0.220916301, 1.0 - 0.220916301);\r\n\r\nmediump vec3 diffuseAndSpecularFromMetallic(mediump vec3 albedo,mediump float metallic, out mediump vec3 specColor, out mediump float oneMinusReflectivity)\r\n{\r\n\tspecColor = mix(dielectricSpecularColor.rgb, albedo, metallic);\r\n\toneMinusReflectivity= dielectricSpecularColor.a*(1.0-metallic);//diffuse proportion\r\n\treturn albedo * oneMinusReflectivity;\r\n}\r\n\r\nmediump float specularStrength(mediump vec3 specular)\r\n{\r\n    return max (max (specular.r, specular.g), specular.b);\r\n}\r\n\r\n// Diffuse/Spec Energy conservation\r\nmediump vec3 energyConservationBetweenDiffuseAndSpecular (mediump vec3 albedo, mediump vec3 specColor, out mediump float oneMinusReflectivity)\r\n{\r\n\toneMinusReflectivity = 1.0 - specularStrength(specColor);\r\n    return albedo * (vec3(1.0) - specColor);\r\n}\r\n\r\n#ifdef TRANSPARENTBLEND\r\n\tmediump vec3 preMultiplyAlpha (mediump vec3 diffColor, mediump float alpha, mediump float oneMinusReflectivity,out mediump float modifiedAlpha)\r\n\t{\r\n\t\t// Transparency 'removes' from Diffuse component\r\n\t\tdiffColor *= alpha;\r\n\t\t// Reflectivity 'removes' from the rest of components, including Transparency\r\n\t\t// modifiedAlpha = 1.0-(1.0-alpha)*(1.0-reflectivity) = 1.0-(oneMinusReflectivity - alpha*oneMinusReflectivity) = 1.0-oneMinusReflectivity + alpha*oneMinusReflectivity\r\n\t\tmodifiedAlpha = 1.0 - oneMinusReflectivity + alpha*oneMinusReflectivity;\r\n\t\treturn diffColor;\r\n\t}\r\n#endif\r\n\r\nFragmentCommonData metallicSetup(vec2 uv)\r\n{\r\n\tmediump vec2 metallicGloss = getMetallicGloss(uv);\r\n\tmediump float metallic = metallicGloss.x;\r\n\tmediump float smoothness = metallicGloss.y; // this is 1 minus the square root of real roughness m.\r\n\tmediump float oneMinusReflectivity;\r\n\tmediump vec3 specColor;\r\n\tmediump vec3 diffColor = diffuseAndSpecularFromMetallic(albedo(uv), metallic,/*out*/specColor,/*out*/oneMinusReflectivity);\r\n\r\n\tFragmentCommonData o;\r\n\to.diffColor = diffColor;\r\n\to.specColor = specColor;\r\n\to.oneMinusReflectivity = oneMinusReflectivity;\r\n\to.smoothness = smoothness;\r\n\treturn o;\r\n}\r\n\r\nFragmentCommonData specularSetup(vec2 uv)\r\n{\r\n    mediump vec4 specGloss = specularGloss(uv);\r\n    mediump vec3 specColor = specGloss.rgb;\r\n    mediump float smoothness = specGloss.a;\r\n\r\n    mediump float oneMinusReflectivity;\r\n    mediump vec3 diffColor = energyConservationBetweenDiffuseAndSpecular (albedo(uv), specColor, /*out*/ oneMinusReflectivity);\r\n\r\n    FragmentCommonData o;\r\n    o.diffColor = diffColor;\r\n    o.specColor = specColor;\r\n    o.oneMinusReflectivity = oneMinusReflectivity;\r\n    o.smoothness = smoothness;\r\n    return o;\r\n}\r\n\r\nLayaGI fragmentGI(float smoothness,vec3 eyeVec,mediump float occlusion,mediump vec2 lightmapUV,vec3 worldnormal)\r\n{\r\n\tLayaGIInput giInput;\r\n\t#ifdef LIGHTMAP\r\n\t\tgiInput.lightmapUV=lightmapUV;\r\n\t#endif\r\n\r\n\tvec3 worldViewDir = -eyeVec;\r\n\tmediump vec4 uvwRoughness;\r\n\tuvwRoughness.rgb = reflect(worldViewDir, worldnormal);//reflectUVW\r\n\tuvwRoughness.a= smoothnessToPerceptualRoughness(smoothness);//perceptualRoughness\r\n\r\n\treturn layaGlobalIllumination(giInput,occlusion, worldnormal, uvwRoughness);\r\n}\r\n\r\n\r\nvec3 perPixelWorldNormal(vec2 uv,vec3 normal,vec3 binormal,vec3 tangent)\r\n{\r\n\t#ifdef NORMALTEXTURE\r\n\t\tmediump vec3 normalTangent=normalInTangentSpace(uv);\r\n\t\tvec3 normalWorld = normalize(tangent * normalTangent.x + binormal * normalTangent.y + normal * normalTangent.z);\r\n\t#else\r\n\t\tvec3 normalWorld = normalize(normal);\r\n\t#endif\r\n\t\treturn normalWorld;\r\n}\r\n\r\nvoid fragmentForward()\r\n{\r\n\tvec2 uv;\r\n\t#if defined(ALBEDOTEXTURE)||defined(METALLICGLOSSTEXTURE)||defined(NORMALTEXTURE)||defined(EMISSIONTEXTURE)||defined(OCCLUSIONTEXTURE)||defined(PARALLAXTEXTURE)\r\n\t\t#ifdef PARALLAXTEXTURE\r\n\t\t\tuv = parallax(v_Texcoord0,normalize(v_ViewDirForParallax));\r\n\t\t#else\r\n\t\t\tuv = v_Texcoord0;\r\n\t\t#endif\r\n\t#endif\r\n\r\n\tmediump float alpha = getAlpha(uv);\r\n\t#ifdef ALPHATEST\r\n\t\tif(alpha<u_AlphaTestValue)\r\n\t\t\tdiscard;\r\n\t#endif\r\n\r\n\tFragmentCommonData o = SETUP_BRDF_INPUT(uv);\r\n\t\r\n\tvec3 binormal;\r\n\tvec3 tangent;\r\n\t#ifdef NORMALTEXTURE\r\n\t\ttangent = v_Tangent;\r\n\t\tbinormal = v_Binormal;\r\n\t#endif\r\n\r\n\tvec3 normal = v_Normal;\r\n\tvec3 normalWorld = perPixelWorldNormal(uv,normal,binormal,tangent);//In FS if the normal use mediump before normalize will cause precision prolem in mobile device.\r\n\tvec3 eyeVec = normalize(v_EyeVec);\r\n\tvec3 posworld = v_PositionWorld;\r\n\r\n\t#ifdef TRANSPARENTBLEND\r\n\t\to.diffColor=preMultiplyAlpha(o.diffColor,alpha,o.oneMinusReflectivity,/*out*/alpha);// shader relies on pre-multiply alpha-blend (srcBlend = One, dstBlend = OneMinusSrcAlpha)\r\n\t#endif\r\n\r\n\tmediump float occlusion = getOcclusion(uv);\r\n\tmediump vec2 lightMapUV;\r\n\t#ifdef LIGHTMAP\r\n\t\tlightMapUV=v_LightMapUV;\r\n\t#endif\r\n\tfloat perceptualRoughness = smoothnessToPerceptualRoughness(o.smoothness);\r\n\tfloat roughness = perceptualRoughnessToRoughness(perceptualRoughness);\r\n\tfloat nv = abs(dot(normalWorld, eyeVec));\r\n\tLayaGI gi =fragmentGI(o.smoothness,eyeVec,occlusion,lightMapUV,normalWorld);\r\n\tvec4 color = LAYA_BRDF_GI(o.diffColor,o.specColor,o.oneMinusReflectivity,o.smoothness,perceptualRoughness,roughness,nv,normalWorld,eyeVec,gi);\r\n\t\r\n\tfloat shadowAttenuation = 1.0;\r\n\t#ifdef LEGACYSINGLELIGHTING\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\t#ifdef CALCULATE_SHADOWS\r\n\t\t\t\t#ifdef SHADOW_CASCADE\r\n\t\t\t\t\tvec4 shadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\r\n\t\t\t\t#else\r\n\t\t\t\t\tvec4 shadowCoord = v_ShadowCoord;\r\n\t\t\t\t#endif\r\n\t\t\t\tshadowAttenuation=sampleShadowmap(shadowCoord);\r\n\t\t\t#endif\r\n\t\t\tLayaLight dirLight = layaDirectionLightToLight(u_DirectionLight,shadowAttenuation);\r\n\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,dirLight);\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef POINTLIGHT\r\n\t\t\tshadowAttenuation = 1.0;\r\n\t\t\tLayaLight poiLight = layaPointLightToLight(posworld,normalWorld,u_PointLight,shadowAttenuation);\r\n\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,poiLight);\r\n\t\t#endif\r\n\t\t\r\n\t\t#ifdef SPOTLIGHT\r\n\t\t\tshadowAttenuation = 1.0;\r\n\t\t\t#ifdef CALCULATE_SPOTSHADOWS\r\n\t\t\t\tvec4 spotShadowcoord = v_SpotShadowCoord;\r\n\t\t\t\tshadowAttenuation = sampleSpotShadowmap(spotShadowcoord);\r\n\t\t\t#endif\r\n\t\t    LayaLight spoLight = layaSpotLightToLight(posworld,normalWorld,u_SpotLight,shadowAttenuation);\r\n\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,spoLight);\r\n\t\t#endif\r\n\t#else\r\n\t \t#ifdef DIRECTIONLIGHT\r\n\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t{\r\n\t\t\t\tshadowAttenuation = 1.0;\r\n\t\t\t\tif(i >= u_DirationLightCount)\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t#ifdef CALCULATE_SHADOWS\r\n\t\t\t\t\tif(i == 0)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t#ifdef SHADOW_CASCADE\r\n\t\t\t\t\t\t\tvec4 shadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\r\n\t\t\t\t\t\t#else\r\n\t\t\t\t\t\t\tvec4 shadowCoord = v_ShadowCoord;\r\n\t\t\t\t\t\t#endif\r\n\t\t\t\t\t\tshadowAttenuation *= sampleShadowmap(shadowCoord);\r\n\t\t\t\t\t}\r\n\t\t\t\t#endif\r\n\t\t\t\tDirectionLight directionLight = getDirectionLight(u_LightBuffer,i);\r\n\t\t\t\tLayaLight dirLight = layaDirectionLightToLight(directionLight,shadowAttenuation);\r\n\t\t\t \tcolor+=LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,dirLight);\r\n\t\t\t}\r\n\t \t#endif\r\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\t\tivec4 clusterInfo =getClusterInfo(u_LightClusterBuffer,u_View,u_Viewport, v_PositionWorld,gl_FragCoord,u_ProjectionParams);\r\n\t\t\t#ifdef POINTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tshadowAttenuation = 1.0;\r\n\t\t\t\t\tif(i >= clusterInfo.x)//PointLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tPointLight pointLight = getPointLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\tLayaLight poiLight = layaPointLightToLight(posworld,normalWorld,pointLight,shadowAttenuation);\r\n\t\t\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,poiLight);\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t\t#ifdef SPOTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tshadowAttenuation = 1.0;\r\n\t\t\t\t\tif(i >= clusterInfo.y)//SpotLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t#ifdef CALCULATE_SPOTSHADOWS\r\n\t\t\t\t\t\tif(i == 0)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tvec4 spotShadowcoord = v_SpotShadowCoord;\r\n\t\t\t\t\t\t\tshadowAttenuation= sampleSpotShadowmap(spotShadowcoord);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t#endif\r\n\t\t\t\t\tSpotLight spotLight = getSpotLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\tLayaLight spoLight = layaSpotLightToLight(posworld,normalWorld,spotLight,shadowAttenuation);\r\n\t\t\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,spoLight);\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t#endif\r\n\t #endif\r\n\r\n\t#ifdef EMISSION\r\n\t\tcolor.rgb += emission(uv);\r\n\t#endif\r\n\r\n\t#ifdef FOG\r\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\r\n\t\tcolor.rgb=mix(color.rgb,u_FogColor,lerpFact);\r\n\t#endif\r\n\t\r\n\tgl_FragColor=vec4(color.rgb,alpha);\r\n}\r\n\r\n\r\n"),ue.addInclude("PBRVertex.glsl","vec2 transformLightMapUV(in vec2 texcoord,in vec4 lightmapScaleOffset)\r\n{\r\n\tvec2 lightMapUV=vec2(texcoord.x,1.0-texcoord.y)*lightmapScaleOffset.xy+lightmapScaleOffset.zw;\r\n\tlightMapUV.y=1.0-lightMapUV.y;\r\n\treturn lightMapUV; \r\n}\r\n\r\nvoid vertexForward()\r\n{\r\n\tvec4 position;\r\n\t#ifdef BONE\r\n\t\tmat4 skinTransform;\r\n\t \t#ifdef SIMPLEBONE\r\n\t\t\tfloat currentPixelPos;\r\n\t\t\t#ifdef GPU_INSTANCE\r\n\t\t\t\tcurrentPixelPos = a_SimpleTextureParams.x+a_SimpleTextureParams.y;\r\n\t\t\t#else\r\n\t\t\t\tcurrentPixelPos = u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\r\n\t\t\t#endif\r\n\t\t\tfloat offset = 1.0/u_SimpleAnimatorTextureSize;\r\n\t\t\tskinTransform =  loadMatFromTexture(currentPixelPos,int(a_BoneIndices.x),offset) * a_BoneWeights.x;\r\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.y),offset) * a_BoneWeights.y;\r\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.z),offset) * a_BoneWeights.z;\r\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.w),offset) * a_BoneWeights.w;\r\n\t\t#else\r\n\t\t\tskinTransform =  u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\r\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\r\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\r\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\r\n\t\t#endif\r\n\t\tposition=skinTransform*a_Position;\r\n\t #else\r\n\t\tposition=a_Position;\r\n\t#endif\r\n\r\n\t#ifdef GPU_INSTANCE\r\n\t\tgl_Position = a_MvpMatrix * position;\r\n\t#else\r\n\t\tgl_Position = u_MvpMatrix * position;\r\n\t#endif\r\n\r\n\tmat4 worldMat;\r\n\t#ifdef GPU_INSTANCE\r\n\t\tworldMat = a_WorldMat;\r\n\t#else\r\n\t\tworldMat = u_WorldMat;\r\n\t#endif\r\n\r\n\tv_PositionWorld=(worldMat*position).xyz;\r\n\r\n\t#if defined(ALBEDOTEXTURE)||defined(METALLICGLOSSTEXTURE)||defined(NORMALTEXTURE)||defined(EMISSIONTEXTURE)||defined(OCCLUSIONTEXTURE)||defined(PARALLAXTEXTURE)\r\n\t\t#ifdef TILINGOFFSET\r\n\t\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\r\n\t\t#else\r\n\t\t\tv_Texcoord0=a_Texcoord0;\r\n\t\t#endif\r\n\t#endif\r\n\r\n\tv_EyeVec =u_CameraPos-v_PositionWorld;//will normalize per-pixel\r\n\r\n\t#ifdef LIGHTMAP\r\n\t\tvec2 texcoord;\r\n\t\t#ifdef UV1\r\n\t\t\ttexcoord=a_Texcoord1;\r\n\t\t#else\r\n\t\t\ttexcoord=a_Texcoord0;\r\n\t\t#endif\r\n\t\tv_LightMapUV=transformLightMapUV(texcoord,u_LightmapScaleOffset);\r\n\t#endif\r\n\r\n\tmat3 worldInvMat;\r\n\t#ifdef BONE\r\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat*skinTransform));\r\n\t#else\r\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat));\r\n\t#endif\r\n\r\n\tv_Normal=normalize(a_Normal*worldInvMat);//if no normalize will cause precision problem.\r\n\r\n\t#ifdef NORMALTEXTURE\r\n\t\tv_Tangent=normalize(a_Tangent0.xyz*worldInvMat);\r\n\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\r\n\t#endif\r\n\r\n\t#ifdef PARALLAXTEXTURE\r\n\t\tvec3 binormal = cross(a_Normal, a_Tangent0.xyz)*a_Tangent0.w;\r\n\t\tmat3 objectTBN = mat3(a_Tangent0.xyz, binormal, a_Normal);\r\n\t\tv_ViewDirForParallax=(worldInvMat*u_CameraPos-position.xyz)*objectTBN;\r\n\t#endif\r\n\r\n\t#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\r\n\t\tv_ShadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\r\n\t#endif\r\n\r\n\t#ifdef CALCULATE_SPOTSHADOWS\r\n\t\tv_SpotShadowCoord = u_SpotViewProjectMatrix*vec4(v_PositionWorld,1.0);\r\n\t#endif\r\n}");var e={a_Position:Qe.MESH_POSITION0,a_Color:Qe.MESH_COLOR0,a_Normal:Qe.MESH_NORMAL0,a_Texcoord0:Qe.MESH_TEXTURECOORDINATE0,a_Texcoord1:Qe.MESH_TEXTURECOORDINATE1,a_BoneWeights:Qe.MESH_BLENDWEIGHT0,a_BoneIndices:Qe.MESH_BLENDINDICES0,a_Tangent0:Qe.MESH_TANGENT0,a_MvpMatrix:Qe.MESH_MVPMATRIX_ROW0,a_WorldMat:Qe.MESH_WORLDMATRIX_ROW0},t={u_Bones:ue.PERIOD_CUSTOM,u_DiffuseTexture:ue.PERIOD_MATERIAL,u_SpecularTexture:ue.PERIOD_MATERIAL,u_NormalTexture:ue.PERIOD_MATERIAL,u_AlphaTestValue:ue.PERIOD_MATERIAL,u_DiffuseColor:ue.PERIOD_MATERIAL,u_MaterialSpecular:ue.PERIOD_MATERIAL,u_Shininess:ue.PERIOD_MATERIAL,u_TilingOffset:ue.PERIOD_MATERIAL,u_WorldMat:ue.PERIOD_SPRITE,u_MvpMatrix:ue.PERIOD_SPRITE,u_LightmapScaleOffset:ue.PERIOD_SPRITE,u_LightMap:ue.PERIOD_SPRITE,u_LightMapDirection:ue.PERIOD_SPRITE,u_SimpleAnimatorTexture:ue.PERIOD_SPRITE,u_SimpleAnimatorParams:ue.PERIOD_SPRITE,u_SimpleAnimatorTextureSize:ue.PERIOD_SPRITE,u_CameraPos:ue.PERIOD_CAMERA,u_Viewport:ue.PERIOD_CAMERA,u_ProjectionParams:ue.PERIOD_CAMERA,u_View:ue.PERIOD_CAMERA,u_ViewProjection:ue.PERIOD_CAMERA,u_ReflectTexture:ue.PERIOD_SCENE,u_ReflectIntensity:ue.PERIOD_SCENE,u_FogStart:ue.PERIOD_SCENE,u_FogRange:ue.PERIOD_SCENE,u_FogColor:ue.PERIOD_SCENE,u_DirationLightCount:ue.PERIOD_SCENE,u_LightBuffer:ue.PERIOD_SCENE,u_LightClusterBuffer:ue.PERIOD_SCENE,u_AmbientColor:ue.PERIOD_SCENE,u_ShadowBias:ue.PERIOD_SCENE,u_ShadowLightDirection:ue.PERIOD_SCENE,u_ShadowMap:ue.PERIOD_SCENE,u_ShadowParams:ue.PERIOD_SCENE,u_ShadowSplitSpheres:ue.PERIOD_SCENE,u_ShadowMatrices:ue.PERIOD_SCENE,u_ShadowMapSize:ue.PERIOD_SCENE,u_SpotShadowMap:ue.PERIOD_SCENE,u_SpotViewProjectMatrix:ue.PERIOD_SCENE,u_ShadowLightPosition:ue.PERIOD_SCENE,u_AmbientSHAr:ue.PERIOD_SCENE,u_AmbientSHAg:ue.PERIOD_SCENE,u_AmbientSHAb:ue.PERIOD_SCENE,u_AmbientSHBr:ue.PERIOD_SCENE,u_AmbientSHBg:ue.PERIOD_SCENE,u_AmbientSHBb:ue.PERIOD_SCENE,u_AmbientSHC:ue.PERIOD_SCENE,"u_DirectionLight.color":ue.PERIOD_SCENE,"u_DirectionLight.direction":ue.PERIOD_SCENE,"u_PointLight.position":ue.PERIOD_SCENE,"u_PointLight.range":ue.PERIOD_SCENE,"u_PointLight.color":ue.PERIOD_SCENE,"u_SpotLight.position":ue.PERIOD_SCENE,"u_SpotLight.direction":ue.PERIOD_SCENE,"u_SpotLight.range":ue.PERIOD_SCENE,"u_SpotLight.spot":ue.PERIOD_SCENE,"u_SpotLight.color":ue.PERIOD_SCENE},r={s_Cull:ue.RENDER_STATE_CULL,s_Blend:ue.RENDER_STATE_BLEND,s_BlendSrc:ue.RENDER_STATE_BLEND_SRC,s_BlendDst:ue.RENDER_STATE_BLEND_DST,s_DepthTest:ue.RENDER_STATE_DEPTH_TEST,s_DepthWrite:ue.RENDER_STATE_DEPTH_WRITE},n=ue.add("BLINNPHONG",null,null,!0),i=new ir(e,t);n.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n#include "Shadow.glsl";\r\n\r\nattribute vec4 a_Position;\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_MvpMatrix;\r\n#else\r\n\tuniform mat4 u_MvpMatrix;\r\n#endif\r\n\r\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\r\n\tattribute vec2 a_Texcoord0;\r\n\tvarying vec2 v_Texcoord0;\r\n#endif\r\n\r\n#if defined(LIGHTMAP)&&defined(UV1)\r\n\tattribute vec2 a_Texcoord1;\r\n#endif\r\n\r\n#ifdef LIGHTMAP\r\n\tuniform vec4 u_LightmapScaleOffset;\r\n\tvarying vec2 v_LightMapUV;\r\n#endif\r\n\r\n#ifdef COLOR\r\n\tattribute vec4 a_Color;\r\n\tvarying vec4 v_Color;\r\n#endif\r\n\r\n#ifdef BONE\r\n\tconst int c_MaxBoneCount = 24;\r\n\tattribute vec4 a_BoneIndices;\r\n\tattribute vec4 a_BoneWeights;\r\n\tuniform mat4 u_Bones[c_MaxBoneCount];\r\n#endif\r\n\r\nattribute vec3 a_Normal;\r\nvarying vec3 v_Normal; \r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\tuniform vec3 u_CameraPos;\r\n\tvarying vec3 v_ViewDir; \r\n#endif\r\n\r\n#if defined(NORMALMAP)\r\n\tattribute vec4 a_Tangent0;\r\n\tvarying vec3 v_Tangent;\r\n\tvarying vec3 v_Binormal;\r\n#endif\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_WorldMat;\r\n#else\r\n\tuniform mat4 u_WorldMat;\r\n#endif\r\n\r\n#if defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(CALCULATE_SHADOWS)&&defined(SHADOW_CASCADE))||defined(CALCULATE_SPOTSHADOWS)\r\n\tvarying vec3 v_PositionWorld;\r\n#endif\r\n\r\n#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\r\n\tvarying vec4 v_ShadowCoord;\r\n#endif\r\n\r\n#ifdef CALCULATE_SPOTSHADOWS\r\n\tvarying vec4 v_SpotShadowCoord;\r\n#endif\r\n\r\n#ifdef TILINGOFFSET\r\n\tuniform vec4 u_TilingOffset;\r\n#endif\r\n\r\n#ifdef SIMPLEBONE\r\n\t#ifdef GPU_INSTANCE\r\n\t\tattribute vec4 a_SimpleTextureParams;\r\n\t#else\r\n\t\tuniform vec4 u_SimpleAnimatorParams;\r\n\t#endif\r\n\tuniform sampler2D u_SimpleAnimatorTexture;\r\n\r\n\tuniform float u_SimpleAnimatorTextureSize; \r\n#endif\r\n\r\n\r\n#ifdef SIMPLEBONE\r\nmat4 loadMatFromTexture(float FramePos,int boneIndices,float offset)\r\n{\r\n\tvec2 uv;\r\n\tfloat PixelPos = FramePos+float(boneIndices)*4.0;\r\n\tfloat halfOffset = offset * 0.5;\r\n\tfloat uvoffset = PixelPos/u_SimpleAnimatorTextureSize;\r\n\tuv.y = floor(uvoffset)*offset+halfOffset;\r\n\tuv.x = mod(float(PixelPos),u_SimpleAnimatorTextureSize)*offset+halfOffset;\r\n\tvec4 mat0row = texture2D(u_SimpleAnimatorTexture,uv);\r\n\tuv.x+=offset;\r\n\tvec4 mat1row = texture2D(u_SimpleAnimatorTexture,uv);\r\n\tuv.x+=offset;\r\n\tvec4 mat2row = texture2D(u_SimpleAnimatorTexture,uv);\r\n\tuv.x+=offset;\r\n\tvec4 mat3row = texture2D(u_SimpleAnimatorTexture,uv);\r\n\tmat4 m =mat4(mat0row.x,mat0row.y,mat0row.z,mat0row.w,\r\n\t\t\t  mat1row.x,mat1row.y,mat1row.z,mat1row.w,\r\n\t\t\t  mat2row.x,mat2row.y,mat2row.z,mat2row.w,\r\n\t\t\t  mat3row.x,mat3row.y,mat3row.z,mat3row.w);\r\n\treturn m;\r\n}\r\n#endif\r\n\r\nvoid main()\r\n{\r\n\tvec4 position;\r\n\t#ifdef BONE\r\n\t\tmat4 skinTransform;\r\n\t \t#ifdef SIMPLEBONE\r\n\t\t\tfloat currentPixelPos;\r\n\t\t\t#ifdef GPU_INSTANCE\r\n\t\t\t\tcurrentPixelPos = a_SimpleTextureParams.x+a_SimpleTextureParams.y;\r\n\t\t\t#else\r\n\t\t\t\tcurrentPixelPos = u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\r\n\t\t\t#endif\r\n\t\t\tfloat offset = 1.0/u_SimpleAnimatorTextureSize;\r\n\t\t\tskinTransform =  loadMatFromTexture(currentPixelPos,int(a_BoneIndices.x),offset) * a_BoneWeights.x;\r\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.y),offset) * a_BoneWeights.y;\r\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.z),offset) * a_BoneWeights.z;\r\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.w),offset) * a_BoneWeights.w;\r\n\t\t#else\r\n\t\t\tskinTransform =  u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\r\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\r\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\r\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\r\n\t\t#endif\r\n\t\tposition=skinTransform*a_Position;\r\n\t #else\r\n\t\tposition=a_Position;\r\n\t#endif\r\n\r\n\t#ifdef GPU_INSTANCE\r\n\t\tgl_Position = a_MvpMatrix * position;\r\n\t#else\r\n\t\tgl_Position = u_MvpMatrix * position;\r\n\t#endif\r\n\t\r\n\tmat4 worldMat;\r\n\t#ifdef GPU_INSTANCE\r\n\t\tworldMat = a_WorldMat;\r\n\t#else\r\n\t\tworldMat = u_WorldMat;\r\n\t#endif\r\n\r\n\tmat3 worldInvMat;\r\n\t#ifdef BONE\r\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat*skinTransform));\r\n\t#else\r\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat));\r\n\t#endif  \r\n\tv_Normal=normalize(a_Normal*worldInvMat);\r\n\t#if defined(NORMALMAP)\r\n\t\tv_Tangent=normalize(a_Tangent0.xyz*worldInvMat);\r\n\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\r\n\t#endif\r\n\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(CALCULATE_SHADOWS)&&defined(SHADOW_CASCADE))||defined(CALCULATE_SPOTSHADOWS)\r\n\t\tvec3 positionWS=(worldMat*position).xyz;\r\n\t\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\t\tv_ViewDir = u_CameraPos-positionWS;\r\n\t\t#endif\r\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(CALCULATE_SHADOWS)&&defined(SHADOW_CASCADE))||defined(CALCULATE_SPOTSHADOWS)\r\n\t\t\tv_PositionWorld = positionWS;\r\n\t\t#endif\r\n\t#endif\r\n\r\n\t#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\r\n\t\t#ifdef TILINGOFFSET\r\n\t\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\r\n\t\t#else\r\n\t\t\tv_Texcoord0=a_Texcoord0;\r\n\t\t#endif\r\n\t#endif\r\n\r\n\t#ifdef LIGHTMAP\r\n\t\t#ifdef UV1\r\n\t\t\tv_LightMapUV=vec2(a_Texcoord1.x,1.0-a_Texcoord1.y)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\r\n\t\t#else\r\n\t\t\tv_LightMapUV=vec2(a_Texcoord0.x,1.0-a_Texcoord0.y)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\r\n\t\t#endif \r\n\t\tv_LightMapUV.y=1.0-v_LightMapUV.y;\r\n\t#endif\r\n\r\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\r\n\t\tv_Color=a_Color;\r\n\t#endif\r\n\r\n\t#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\r\n\t\tv_ShadowCoord =getShadowCoord(vec4(positionWS,1.0));\r\n\t#endif\r\n\r\n\t#ifdef CALCULATE_SPOTSHADOWS\r\n\t\tv_SpotShadowCoord = u_SpotViewProjectMatrix*vec4(positionWS,1.0);\r\n\t#endif\r\n\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n\tprecision highp int;\r\n#else\r\n\tprecision mediump float;\r\n\tprecision mediump int;\r\n#endif\r\n\r\n#include "Lighting.glsl";\r\n#include "Shadow.glsl"\r\n\r\nuniform vec4 u_DiffuseColor;\r\n\r\n#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\r\n\tvarying vec4 v_Color;\r\n#endif\r\n\r\n#ifdef ALPHATEST\r\n\tuniform float u_AlphaTestValue;\r\n#endif\r\n\r\n#ifdef DIFFUSEMAP\r\n\tuniform sampler2D u_DiffuseTexture;\r\n#endif\r\n\r\n\r\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\r\n\tvarying vec2 v_Texcoord0;\r\n#endif\r\n\r\n#ifdef LIGHTMAP\r\n\tvarying vec2 v_LightMapUV;\r\n\tuniform sampler2D u_LightMap;\r\n#endif\r\n\r\nvarying vec3 v_Normal;\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\tvarying vec3 v_ViewDir; \r\n\r\n\tuniform vec3 u_MaterialSpecular;\r\n\tuniform float u_Shininess;\r\n\r\n\t#ifdef LEGACYSINGLELIGHTING\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tuniform DirectionLight u_DirectionLight;\r\n\t\t#endif\r\n\t\t#ifdef POINTLIGHT\r\n\t\t\tuniform PointLight u_PointLight;\r\n\t\t#endif\r\n\t\t#ifdef SPOTLIGHT\r\n\t\t\tuniform SpotLight u_SpotLight;\r\n\t\t#endif\r\n\t#else\r\n\t\tuniform mat4 u_View;\r\n\t\tuniform vec4 u_ProjectionParams;\r\n\t\tuniform vec4 u_Viewport;\r\n\t\tuniform int u_DirationLightCount;\r\n\t\tuniform sampler2D u_LightBuffer;\r\n\t\tuniform sampler2D u_LightClusterBuffer;\r\n\t#endif\r\n\r\n\t#ifdef SPECULARMAP \r\n\t\tuniform sampler2D u_SpecularTexture;\r\n\t#endif\r\n#endif\r\n\r\n#ifdef NORMALMAP \r\n\tuniform sampler2D u_NormalTexture;\r\n\tvarying vec3 v_Tangent;\r\n\tvarying vec3 v_Binormal;\r\n#endif\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\tuniform vec3 u_FogColor;\r\n#endif\r\n\r\n#if defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(CALCULATE_SHADOWS)&&defined(SHADOW_CASCADE))||defined(CALCULATE_SPOTSHADOWS)\r\n\tvarying vec3 v_PositionWorld;\r\n#endif\r\n\r\n\r\n#include "GlobalIllumination.glsl";//"GlobalIllumination.glsl use uniform should at front of this\r\n\r\n#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\r\n\tvarying vec4 v_ShadowCoord;\r\n#endif\r\n\r\n#ifdef CALCULATE_SPOTSHADOWS\r\n\tvarying vec4 v_SpotShadowCoord;\r\n#endif\r\n\r\n\r\nvoid main()\r\n{\r\n\tvec3 normal;//light and SH maybe use normal\r\n\t#if defined(NORMALMAP)\r\n\t\tvec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\r\n\t\tnormal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent,v_Binormal));\r\n\t#else\r\n\t\tnormal = normalize(v_Normal);\r\n\t#endif\r\n\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\tvec3 viewDir= normalize(v_ViewDir);\r\n\t#endif\r\n\r\n\tLayaGIInput giInput;\r\n\t#ifdef LIGHTMAP\t\r\n\t\tgiInput.lightmapUV=v_LightMapUV;\r\n\t#endif\r\n\tvec3 globalDiffuse=layaGIBase(giInput,1.0,normal);\r\n\t\r\n\tvec4 mainColor=u_DiffuseColor;\r\n\t#ifdef DIFFUSEMAP\r\n\t\tvec4 difTexColor=texture2D(u_DiffuseTexture, v_Texcoord0);\r\n\t\tmainColor=mainColor*difTexColor;\r\n\t#endif \r\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\r\n\t\tmainColor=mainColor*v_Color;\r\n\t#endif \r\n    \r\n\t#ifdef ALPHATEST\r\n\t\tif(mainColor.a<u_AlphaTestValue)\r\n\t\t\tdiscard;\r\n\t#endif\r\n  \r\n\t\r\n\tvec3 diffuse = vec3(0.0);\r\n\tvec3 specular= vec3(0.0);\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\tvec3 dif,spe;\r\n\t\t#ifdef SPECULARMAP\r\n\t\t\tvec3 gloss=texture2D(u_SpecularTexture, v_Texcoord0).rgb;\r\n\t\t#else\r\n\t\t\t#ifdef DIFFUSEMAP\r\n\t\t\t\tvec3 gloss=vec3(difTexColor.a);\r\n\t\t\t#else\r\n\t\t\t\tvec3 gloss=vec3(1.0);\r\n\t\t\t#endif\r\n\t\t#endif\r\n\t#endif\r\n\r\n\t\r\n\t\r\n\t#ifdef LEGACYSINGLELIGHTING\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tLayaAirBlinnPhongDiectionLight(u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_DirectionLight,dif,spe);\r\n\t\t\t#ifdef CALCULATE_SHADOWS\r\n\t\t\t\t#ifdef SHADOW_CASCADE\r\n\t\t\t\t\tvec4 shadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\r\n\t\t\t\t#else\r\n\t\t\t\t\tvec4 shadowCoord = v_ShadowCoord;\r\n\t\t\t\t#endif\r\n\t\t\t\tfloat shadowAttenuation=sampleShadowmap(shadowCoord);\r\n\t\t\t\tdif *= shadowAttenuation;\r\n\t\t\t\tspe *= shadowAttenuation;\r\n\t\t\t#endif\r\n\t\t\tdiffuse+=dif;\r\n\t\t\tspecular+=spe;\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef POINTLIGHT\r\n\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_PointLight,dif,spe);\r\n\t\t\tdiffuse+=dif;\r\n\t\t\tspecular+=spe;\r\n\t\t#endif\r\n\r\n\t\t#ifdef SPOTLIGHT\r\n\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_SpotLight,dif,spe);\r\n\t\t\t#ifdef CALCULATE_SPOTSHADOWS\r\n\t\t\t\tvec4 spotShadowcoord = v_SpotShadowCoord;\r\n\t\t\t\tfloat spotShadowAttenuation = sampleSpotShadowmap(spotShadowcoord);\r\n\t\t\t\tdif *= spotShadowAttenuation;\r\n\t\t\t\tspe *= spotShadowAttenuation;\r\n\t\t\t#endif\r\n\t\t\tdiffuse+=dif;\r\n\t\t\tspecular+=spe;\r\n\t\t#endif\r\n\t#else\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t{\r\n\t\t\t\tif(i >= u_DirationLightCount)\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tDirectionLight directionLight = getDirectionLight(u_LightBuffer,i);\r\n\t\t\t\t#ifdef CALCULATE_SHADOWS\r\n\t\t\t\t\tif(i == 0)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t#ifdef SHADOW_CASCADE\r\n\t\t\t\t\t\t\tvec4 shadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\r\n\t\t\t\t\t\t#else\r\n\t\t\t\t\t\t\tvec4 shadowCoord = v_ShadowCoord;\r\n\t\t\t\t\t\t#endif\r\n\t\t\t\t\t\tdirectionLight.color *= sampleShadowmap(shadowCoord);\r\n\t\t\t\t\t}\r\n\t\t\t\t#endif\r\n\t\t\t\tLayaAirBlinnPhongDiectionLight(u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,directionLight,dif,spe);\r\n\t\t\t\tdiffuse+=dif;\r\n\t\t\t\tspecular+=spe;\r\n\t\t\t}\r\n\t\t#endif\r\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\t\tivec4 clusterInfo =getClusterInfo(u_LightClusterBuffer,u_View,u_Viewport, v_PositionWorld,gl_FragCoord,u_ProjectionParams);\r\n\t\t\t#ifdef POINTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tif(i >= clusterInfo.x)//PointLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tPointLight pointLight = getPointLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,pointLight,dif,spe);\r\n\t\t\t\t\tdiffuse+=dif;\r\n\t\t\t\t\tspecular+=spe;\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t\t#ifdef SPOTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tif(i >= clusterInfo.y)//SpotLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tSpotLight spotLight = getSpotLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\t#ifdef CALCULATE_SPOTSHADOWS\r\n\t\t\t\t\t\tif(i == 0)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tvec4 spotShadowcoord = v_SpotShadowCoord;\r\n\t\t\t\t\t\t\tspotLight.color *= sampleSpotShadowmap(spotShadowcoord);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t#endif\r\n\t\t\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,spotLight,dif,spe);\r\n\t\t\t\t\tdiffuse+=dif;\r\n\t\t\t\t\tspecular+=spe;\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t#endif\r\n\t#endif\r\n\r\n\tgl_FragColor =vec4(mainColor.rgb*(globalDiffuse + diffuse),mainColor.a);\r\n\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\tgl_FragColor.rgb+=specular;\r\n\t#endif\r\n\t  \r\n\t#ifdef FOG\r\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\r\n\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\r\n\t#endif\r\n}\r\n\r\n',r,"Forward");i.addShaderPass('#include "ShadowCasterVS.glsl"\r\n\r\nvoid main()\r\n{\r\n\tvec4 positionCS =  shadowCasterVertex();\r\n\tgl_Position=remapGLPositionZ(positionCS);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n\tprecision highp int;\r\n#else\r\n\tprecision mediump float;\r\n\tprecision mediump int;\r\n#endif\r\n\r\n#include "ShadowCasterFS.glsl"\r\n\r\nvoid main()\r\n{\r\n\tgl_FragColor=shadowCasterFragment();\r\n}',r,"ShadowCaster");e={a_Position:Qe.MESH_POSITION0,a_Color:Qe.MESH_COLOR0},t={u_MvpMatrix:ue.PERIOD_SPRITE,u_Color:ue.PERIOD_MATERIAL},r={s_Cull:ue.RENDER_STATE_CULL,s_Blend:ue.RENDER_STATE_BLEND,s_BlendSrc:ue.RENDER_STATE_BLEND_SRC,s_BlendDst:ue.RENDER_STATE_BLEND_DST,s_DepthTest:ue.RENDER_STATE_DEPTH_TEST,s_DepthWrite:ue.RENDER_STATE_DEPTH_WRITE},n=ue.add("LineShader"),i=new ir(e,t),n.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\nuniform mat4 u_MvpMatrix;\r\nuniform vec4 u_Color;\r\nattribute vec4 a_Color;\r\nvarying vec4 v_Color;\r\n\r\n\r\nvoid main()\r\n{\r\n\tgl_Position = u_MvpMatrix * a_Position;\r\n\tv_Color=a_Color*u_Color;\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\nprecision highp float;\r\n#else\r\nprecision mediump float;\r\n#endif\r\n\r\nvarying vec4 v_Color;\r\nuniform vec4 u_Color;\r\n\r\nvoid main()\r\n{\r\n  gl_FragColor = v_Color * u_Color; \r\n}\r\n\r\n",r),e={a_Position:Qe.MESH_POSITION0,a_Color:Qe.MESH_COLOR0,a_Texcoord0:Qe.MESH_TEXTURECOORDINATE0,a_BoneWeights:Qe.MESH_BLENDWEIGHT0,a_BoneIndices:Qe.MESH_BLENDINDICES0,a_MvpMatrix:Qe.MESH_MVPMATRIX_ROW0},t={u_Bones:ue.PERIOD_CUSTOM,u_AlbedoTexture:ue.PERIOD_MATERIAL,u_AlbedoColor:ue.PERIOD_MATERIAL,u_TilingOffset:ue.PERIOD_MATERIAL,u_AlphaTestValue:ue.PERIOD_MATERIAL,u_MvpMatrix:ue.PERIOD_SPRITE,u_SimpleAnimatorTexture:ue.PERIOD_SPRITE,u_SimpleAnimatorParams:ue.PERIOD_SPRITE,u_SimpleAnimatorTextureSize:ue.PERIOD_SPRITE,u_FogStart:ue.PERIOD_SCENE,u_FogRange:ue.PERIOD_SCENE,u_FogColor:ue.PERIOD_SCENE},r={s_Cull:ue.RENDER_STATE_CULL,s_Blend:ue.RENDER_STATE_BLEND,s_BlendSrc:ue.RENDER_STATE_BLEND_SRC,s_BlendDst:ue.RENDER_STATE_BLEND_DST,s_DepthTest:ue.RENDER_STATE_DEPTH_TEST,s_DepthWrite:ue.RENDER_STATE_DEPTH_WRITE},n=ue.add("Unlit",null,null,!0),i=new ir(e,t),n.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\n\r\nattribute vec2 a_Texcoord0;\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_MvpMatrix;\r\n#else\r\n\tuniform mat4 u_MvpMatrix;\r\n#endif\r\n\r\nattribute vec4 a_Color;\r\nvarying vec4 v_Color;\r\nvarying vec2 v_Texcoord0;\r\n\r\n#ifdef TILINGOFFSET\r\n\tuniform vec4 u_TilingOffset;\r\n#endif\r\n\r\n#ifdef BONE\r\n\tconst int c_MaxBoneCount = 24;\r\n\tattribute vec4 a_BoneIndices;\r\n\tattribute vec4 a_BoneWeights;\r\n\tuniform mat4 u_Bones[c_MaxBoneCount];\r\n#endif\r\n\r\n#ifdef SIMPLEBONE\r\n\t#ifdef GPU_INSTANCE\r\n\t\tattribute vec4 a_SimpleTextureParams;\r\n\t#else\r\n\t\tuniform vec4 u_SimpleAnimatorParams;\r\n\t#endif\r\n\tuniform sampler2D u_SimpleAnimatorTexture;\r\n\r\n\tuniform float u_SimpleAnimatorTextureSize; \r\n#endif\r\n\r\n\r\n#ifdef SIMPLEBONE\r\nmat4 loadMatFromTexture(float FramePos,int boneIndices,float offset)\r\n{\r\n\tvec2 uv;\r\n\tfloat PixelPos = FramePos+float(boneIndices)*4.0;\r\n\tfloat halfOffset = offset * 0.5;\r\n\tfloat uvoffset = PixelPos/u_SimpleAnimatorTextureSize;\r\n\tuv.y = floor(uvoffset)*offset+halfOffset;\r\n\tuv.x = mod(float(PixelPos),u_SimpleAnimatorTextureSize)*offset+halfOffset;\r\n\tvec4 mat0row = texture2D(u_SimpleAnimatorTexture,uv);\r\n\tuv.x+=offset;\r\n\tvec4 mat1row = texture2D(u_SimpleAnimatorTexture,uv);\r\n\tuv.x+=offset;\r\n\tvec4 mat2row = texture2D(u_SimpleAnimatorTexture,uv);\r\n\tuv.x+=offset;\r\n\tvec4 mat3row = texture2D(u_SimpleAnimatorTexture,uv);\r\n\tmat4 m =mat4(mat0row.x,mat0row.y,mat0row.z,mat0row.w,\r\n\t\t\t  mat1row.x,mat1row.y,mat1row.z,mat1row.w,\r\n\t\t\t  mat2row.x,mat2row.y,mat2row.z,mat2row.w,\r\n\t\t\t  mat3row.x,mat3row.y,mat3row.z,mat3row.w);\r\n\treturn m;\r\n}\r\n#endif\r\nvoid main() {\r\n\tvec4 position;\r\n\t#ifdef BONE\r\n\t\tmat4 skinTransform;\r\n\t \t#ifdef SIMPLEBONE\r\n\t\t\tfloat currentPixelPos;\r\n\t\t\t#ifdef GPU_INSTANCE\r\n\t\t\t\tcurrentPixelPos = a_SimpleTextureParams.x+a_SimpleTextureParams.y;\r\n\t\t\t#else\r\n\t\t\t\tcurrentPixelPos = u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\r\n\t\t\t#endif\r\n\t\t\tfloat offset = 1.0/u_SimpleAnimatorTextureSize;\r\n\t\t\tskinTransform =  loadMatFromTexture(currentPixelPos,int(a_BoneIndices.x),offset) * a_BoneWeights.x;\r\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.y),offset) * a_BoneWeights.y;\r\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.z),offset) * a_BoneWeights.z;\r\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.w),offset) * a_BoneWeights.w;\r\n\t\t#else\r\n\t\t\tskinTransform =  u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\r\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\r\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\r\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\r\n\t\t#endif\r\n\t\tposition=skinTransform*a_Position;\r\n\t #else\r\n\t\tposition=a_Position;\r\n\t#endif\r\n\t#ifdef GPU_INSTANCE\r\n\t\tgl_Position = a_MvpMatrix * position;\r\n\t#else\r\n\t\tgl_Position = u_MvpMatrix * position;\r\n\t#endif\r\n\r\n\t#ifdef TILINGOFFSET\r\n\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\r\n\t#else\r\n\t\tv_Texcoord0=a_Texcoord0;\r\n\t#endif\r\n\r\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\r\n\t\tv_Color = a_Color;\r\n\t#endif\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\r\n\tvarying vec4 v_Color;\r\n#endif\r\n\r\n#ifdef ALBEDOTEXTURE\r\n\tuniform sampler2D u_AlbedoTexture;\r\n\tvarying vec2 v_Texcoord0;\r\n#endif\r\n\r\nuniform vec4 u_AlbedoColor;\r\n\r\n#ifdef ALPHATEST\r\n\tuniform float u_AlphaTestValue;\r\n#endif\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\t#ifdef ADDTIVEFOG\r\n\t#else\r\n\t\tuniform vec3 u_FogColor;\r\n\t#endif\r\n#endif\r\n\r\nvoid main()\r\n{\r\n\tvec4 color =  u_AlbedoColor;\r\n\t#ifdef ALBEDOTEXTURE\r\n\t\tcolor *= texture2D(u_AlbedoTexture, v_Texcoord0);\r\n\t#endif\r\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\r\n\t\tcolor *= v_Color;\r\n\t#endif\r\n\t\r\n\t#ifdef ALPHATEST\r\n\t\tif(color.a < u_AlphaTestValue)\r\n\t\t\tdiscard;\r\n\t#endif\r\n\t\r\n\tgl_FragColor = color;\r\n\t\r\n\t#ifdef FOG\r\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\r\n\t\t#ifdef ADDTIVEFOG\r\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, vec3(0.0), lerpFact);\r\n\t\t#else\r\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\r\n\t\t#endif\r\n\t#endif\r\n\t\r\n}\r\n\r\n",r),e={a_Position:Qe.MESH_POSITION0,a_Texcoord0:Qe.MESH_TEXTURECOORDINATE0,a_BoneWeights:Qe.MESH_BLENDWEIGHT0,a_BoneIndices:Qe.MESH_BLENDINDICES0,a_MvpMatrix:Qe.MESH_MVPMATRIX_ROW0},t={u_Bones:ue.PERIOD_CUSTOM,u_AlbedoTexture:ue.PERIOD_MATERIAL,u_AlbedoColor:ue.PERIOD_MATERIAL,u_TilingOffset:ue.PERIOD_MATERIAL,u_AlphaTestValue:ue.PERIOD_MATERIAL,u_MvpMatrix:ue.PERIOD_SPRITE,u_SimpleAnimatorTexture:ue.PERIOD_SPRITE,u_SimpleAnimatorParams:ue.PERIOD_SPRITE,u_SimpleAnimatorTextureSize:ue.PERIOD_SPRITE,u_FogStart:ue.PERIOD_SCENE,u_FogRange:ue.PERIOD_SCENE,u_FogColor:ue.PERIOD_SCENE},r={s_Cull:ue.RENDER_STATE_CULL,s_Blend:ue.RENDER_STATE_BLEND,s_BlendSrc:ue.RENDER_STATE_BLEND_SRC,s_BlendDst:ue.RENDER_STATE_BLEND_DST,s_DepthTest:ue.RENDER_STATE_DEPTH_TEST,s_DepthWrite:ue.RENDER_STATE_DEPTH_WRITE},n=ue.add("Effect",null,null,!0),i=new ir(e,t),n.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\nattribute vec4 a_Color;\r\nattribute vec2 a_Texcoord0;\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_MvpMatrix;\r\n#else\r\n\tuniform mat4 u_MvpMatrix;\r\n#endif\r\n\r\n#ifdef COLOR\r\n\tvarying vec4 v_Color;\r\n#endif\r\nvarying vec2 v_Texcoord0;\r\n\r\n#ifdef TILINGOFFSET\r\n\tuniform vec4 u_TilingOffset;\r\n#endif\r\n\r\n#ifdef BONE\r\n\tconst int c_MaxBoneCount = 24;\r\n\tattribute vec4 a_BoneIndices;\r\n\tattribute vec4 a_BoneWeights;\r\n\tuniform mat4 u_Bones[c_MaxBoneCount];\r\n#endif\r\n\r\nvoid main()\r\n{\r\n\tvec4 position;\r\n\t#ifdef BONE\r\n\t\tmat4 skinTransform;\r\n\t \t#ifdef SIMPLEBONE\r\n\t\t\tfloat currentPixelPos;\r\n\t\t\t#ifdef GPU_INSTANCE\r\n\t\t\t\tcurrentPixelPos = a_SimpleTextureParams.x+a_SimpleTextureParams.y;\r\n\t\t\t#else\r\n\t\t\t\tcurrentPixelPos = u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\r\n\t\t\t#endif\r\n\t\t\tfloat offset = 1.0/u_SimpleAnimatorTextureSize;\r\n\t\t\tskinTransform =  loadMatFromTexture(currentPixelPos,int(a_BoneIndices.x),offset) * a_BoneWeights.x;\r\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.y),offset) * a_BoneWeights.y;\r\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.z),offset) * a_BoneWeights.z;\r\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.w),offset) * a_BoneWeights.w;\r\n\t\t#else\r\n\t\t\tskinTransform =  u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\r\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\r\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\r\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\r\n\t\t#endif\r\n\t\tposition=skinTransform*a_Position;\r\n\t#else\r\n\t\tposition=a_Position;\r\n\t#endif\r\n\t#ifdef GPU_INSTANCE\r\n\t\tgl_Position = a_MvpMatrix * position;\r\n\t#else\r\n\t\tgl_Position = u_MvpMatrix * position;\r\n\t#endif\r\n\t\r\n\t#ifdef TILINGOFFSET\r\n\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\r\n\t#else\r\n\t\tv_Texcoord0=a_Texcoord0;\r\n\t#endif\r\n\t\t\r\n\t#ifdef COLOR\r\n\t\tv_Color = a_Color;\r\n\t#endif\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#ifdef COLOR\r\n\tvarying vec4 v_Color;\r\n#endif\r\nvarying vec2 v_Texcoord0;\r\n\r\n#ifdef MAINTEXTURE\r\n\tuniform sampler2D u_AlbedoTexture;\r\n#endif\r\n\r\nuniform vec4 u_AlbedoColor;\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\t#ifdef ADDTIVEFOG\r\n\t#else\r\n\t\tuniform vec3 u_FogColor;\r\n\t#endif\r\n#endif\r\n\r\nvoid main()\r\n{\r\n\tvec4 color =  2.0 * u_AlbedoColor;\r\n\t#ifdef COLOR\r\n\t\tcolor *= v_Color;\r\n\t#endif\r\n\t#ifdef MAINTEXTURE\r\n\t\tcolor *= texture2D(u_AlbedoTexture, v_Texcoord0);\r\n\t#endif\r\n\t\r\n\tgl_FragColor = color;\r\n\t\r\n\t#ifdef FOG\r\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\r\n\t\t#ifdef ADDTIVEFOG\r\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, vec3(0.0), lerpFact);\r\n\t\t#else\r\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\r\n\t\t#endif\r\n\t#endif\r\n}\r\n\r\n",r),e={a_CornerTextureCoordinate:Xr.PARTICLE_CORNERTEXTURECOORDINATE0,a_MeshPosition:Xr.PARTICLE_POSITION0,a_MeshColor:Xr.PARTICLE_COLOR0,a_MeshTextureCoordinate:Xr.PARTICLE_TEXTURECOORDINATE0,a_ShapePositionStartLifeTime:Xr.PARTICLE_SHAPEPOSITIONSTARTLIFETIME,a_DirectionTime:Xr.PARTICLE_DIRECTIONTIME,a_StartColor:Xr.PARTICLE_STARTCOLOR0,a_EndColor:Xr.PARTICLE_ENDCOLOR0,a_StartSize:Xr.PARTICLE_STARTSIZE,a_StartRotation0:Xr.PARTICLE_STARTROTATION,a_StartSpeed:Xr.PARTICLE_STARTSPEED,a_Random0:Xr.PARTICLE_RANDOM0,a_Random1:Xr.PARTICLE_RANDOM1,a_SimulationWorldPostion:Xr.PARTICLE_SIMULATIONWORLDPOSTION,a_SimulationWorldRotation:Xr.PARTICLE_SIMULATIONWORLDROTATION},t={u_Tintcolor:ue.PERIOD_MATERIAL,u_TilingOffset:ue.PERIOD_MATERIAL,u_texture:ue.PERIOD_MATERIAL,u_WorldPosition:ue.PERIOD_SPRITE,u_WorldRotation:ue.PERIOD_SPRITE,u_PositionScale:ue.PERIOD_SPRITE,u_SizeScale:ue.PERIOD_SPRITE,u_ScalingMode:ue.PERIOD_SPRITE,u_Gravity:ue.PERIOD_SPRITE,u_ThreeDStartRotation:ue.PERIOD_SPRITE,u_StretchedBillboardLengthScale:ue.PERIOD_SPRITE,u_StretchedBillboardSpeedScale:ue.PERIOD_SPRITE,u_SimulationSpace:ue.PERIOD_SPRITE,u_CurrentTime:ue.PERIOD_SPRITE,u_ColorOverLifeGradientAlphas:ue.PERIOD_SPRITE,u_ColorOverLifeGradientColors:ue.PERIOD_SPRITE,u_MaxColorOverLifeGradientAlphas:ue.PERIOD_SPRITE,u_MaxColorOverLifeGradientColors:ue.PERIOD_SPRITE,u_VOLVelocityConst:ue.PERIOD_SPRITE,u_VOLVelocityGradientX:ue.PERIOD_SPRITE,u_VOLVelocityGradientY:ue.PERIOD_SPRITE,u_VOLVelocityGradientZ:ue.PERIOD_SPRITE,u_VOLVelocityConstMax:ue.PERIOD_SPRITE,u_VOLVelocityGradientMaxX:ue.PERIOD_SPRITE,u_VOLVelocityGradientMaxY:ue.PERIOD_SPRITE,u_VOLVelocityGradientMaxZ:ue.PERIOD_SPRITE,u_VOLSpaceType:ue.PERIOD_SPRITE,u_SOLSizeGradient:ue.PERIOD_SPRITE,u_SOLSizeGradientX:ue.PERIOD_SPRITE,u_SOLSizeGradientY:ue.PERIOD_SPRITE,u_SOLSizeGradientZ:ue.PERIOD_SPRITE,u_SOLSizeGradientMax:ue.PERIOD_SPRITE,u_SOLSizeGradientMaxX:ue.PERIOD_SPRITE,u_SOLSizeGradientMaxY:ue.PERIOD_SPRITE,u_SOLSizeGradientMaxZ:ue.PERIOD_SPRITE,u_ROLAngularVelocityConst:ue.PERIOD_SPRITE,u_ROLAngularVelocityConstSeprarate:ue.PERIOD_SPRITE,u_ROLAngularVelocityGradient:ue.PERIOD_SPRITE,u_ROLAngularVelocityGradientX:ue.PERIOD_SPRITE,u_ROLAngularVelocityGradientY:ue.PERIOD_SPRITE,u_ROLAngularVelocityGradientZ:ue.PERIOD_SPRITE,u_ROLAngularVelocityConstMax:ue.PERIOD_SPRITE,u_ROLAngularVelocityConstMaxSeprarate:ue.PERIOD_SPRITE,u_ROLAngularVelocityGradientMax:ue.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxX:ue.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxY:ue.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxZ:ue.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxW:ue.PERIOD_SPRITE,u_TSACycles:ue.PERIOD_SPRITE,u_TSASubUVLength:ue.PERIOD_SPRITE,u_TSAGradientUVs:ue.PERIOD_SPRITE,u_TSAMaxGradientUVs:ue.PERIOD_SPRITE,u_CameraPos:ue.PERIOD_CAMERA,u_CameraDirection:ue.PERIOD_CAMERA,u_CameraUp:ue.PERIOD_CAMERA,u_View:ue.PERIOD_CAMERA,u_Projection:ue.PERIOD_CAMERA,u_FogStart:ue.PERIOD_SCENE,u_FogRange:ue.PERIOD_SCENE,u_FogColor:ue.PERIOD_SCENE},r={s_Cull:ue.RENDER_STATE_CULL,s_Blend:ue.RENDER_STATE_BLEND,s_BlendSrc:ue.RENDER_STATE_BLEND_SRC,s_BlendDst:ue.RENDER_STATE_BLEND_DST,s_DepthTest:ue.RENDER_STATE_DEPTH_TEST,s_DepthWrite:ue.RENDER_STATE_DEPTH_WRITE},n=ue.add("PARTICLESHURIKEN"),i=new ir(e,t),n.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\n#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n  precision highp float;\r\n#else\r\n  precision mediump float;\r\n#endif\r\n\r\n#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\r\n\tattribute vec4 a_CornerTextureCoordinate;\r\n#endif\r\n#ifdef RENDERMODE_MESH\r\n\tattribute vec3 a_MeshPosition;\r\n\tattribute vec4 a_MeshColor;\r\n\tattribute vec2 a_MeshTextureCoordinate;\r\n\tvarying vec4 v_MeshColor;\r\n#endif\r\n\r\nattribute vec4 a_ShapePositionStartLifeTime;\r\nattribute vec4 a_DirectionTime;\r\nattribute vec4 a_StartColor;\r\nattribute vec3 a_StartSize;\r\nattribute vec3 a_StartRotation0;\r\nattribute float a_StartSpeed;\r\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\r\n  attribute vec4 a_Random0;\r\n#endif\r\n#if defined(TEXTURESHEETANIMATIONRANDOMCURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\n  attribute vec4 a_Random1;\r\n#endif\r\nattribute vec3 a_SimulationWorldPostion;\r\nattribute vec4 a_SimulationWorldRotation;\r\n\r\nvarying vec4 v_Color;\r\n#ifdef DIFFUSEMAP\r\n\tvarying vec2 v_TextureCoordinate;\r\n#endif\r\n\r\nuniform float u_CurrentTime;\r\nuniform vec3 u_Gravity;\r\n\r\nuniform vec3 u_WorldPosition;\r\nuniform vec4 u_WorldRotation;\r\nuniform bool u_ThreeDStartRotation;\r\nuniform int u_ScalingMode;\r\nuniform vec3 u_PositionScale;\r\nuniform vec3 u_SizeScale;\r\nuniform mat4 u_View;\r\nuniform mat4 u_Projection;\r\n\r\n#ifdef STRETCHEDBILLBOARD\r\n\tuniform vec3 u_CameraPos;\r\n#endif\r\nuniform vec3 u_CameraDirection;//TODO:只有几种广告牌模式需要用\r\nuniform vec3 u_CameraUp;\r\n\r\nuniform  float u_StretchedBillboardLengthScale;\r\nuniform  float u_StretchedBillboardSpeedScale;\r\nuniform int u_SimulationSpace;\r\n\r\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\n  uniform  int  u_VOLSpaceType;\r\n#endif\r\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)\r\n  uniform  vec3 u_VOLVelocityConst;\r\n#endif\r\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\n  uniform  vec2 u_VOLVelocityGradientX[4];//x为key,y为速度\r\n  uniform  vec2 u_VOLVelocityGradientY[4];//x为key,y为速度\r\n  uniform  vec2 u_VOLVelocityGradientZ[4];//x为key,y为速度\r\n#endif\r\n#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\r\n  uniform  vec3 u_VOLVelocityConstMax;\r\n#endif\r\n#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\r\n  uniform  vec2 u_VOLVelocityGradientMaxX[4];//x为key,y为速度\r\n  uniform  vec2 u_VOLVelocityGradientMaxY[4];//x为key,y为速度\r\n  uniform  vec2 u_VOLVelocityGradientMaxZ[4];//x为key,y为速度\r\n#endif\r\n\r\n#ifdef COLOROVERLIFETIME\r\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\r\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\r\n#endif\r\n#ifdef RANDOMCOLOROVERLIFETIME\r\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\r\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\r\n  uniform  vec4 u_MaxColorOverLifeGradientColors[4];//x为key,yzw为Color\r\n  uniform  vec2 u_MaxColorOverLifeGradientAlphas[4];//x为key,y为Alpha\r\n#endif\r\n\r\n\r\n#if defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMERANDOMCURVES)\r\n  uniform  vec2 u_SOLSizeGradient[4];//x为key,y为尺寸\r\n#endif\r\n#ifdef SIZEOVERLIFETIMERANDOMCURVES\r\n  uniform  vec2 u_SOLSizeGradientMax[4];//x为key,y为尺寸\r\n#endif\r\n#if defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\r\n  uniform  vec2 u_SOLSizeGradientX[4];//x为key,y为尺寸\r\n  uniform  vec2 u_SOLSizeGradientY[4];//x为key,y为尺寸\r\n  uniform  vec2 u_SOLSizeGradientZ[4];//x为key,y为尺寸\r\n#endif\r\n#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\r\n  uniform  vec2 u_SOLSizeGradientMaxX[4];//x为key,y为尺寸\r\n  uniform  vec2 u_SOLSizeGradientMaxY[4];//x为key,y为尺寸\r\n  uniform  vec2 u_SOLSizeGradientMaxZ[4];//x为key,y为尺寸\r\n#endif\r\n\r\n\r\n#ifdef ROTATIONOVERLIFETIME\r\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\r\n    uniform  float u_ROLAngularVelocityConst;\r\n  #endif\r\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\r\n    uniform  float u_ROLAngularVelocityConstMax;\r\n  #endif\r\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\r\n    uniform  vec2 u_ROLAngularVelocityGradient[4];//x为key,y为旋转\r\n  #endif\r\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\r\n    uniform  vec2 u_ROLAngularVelocityGradientMax[4];//x为key,y为旋转\r\n  #endif\r\n#endif\r\n#ifdef ROTATIONOVERLIFETIMESEPERATE\r\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\r\n    uniform  vec3 u_ROLAngularVelocityConstSeprarate;\r\n  #endif\r\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\r\n    uniform  vec3 u_ROLAngularVelocityConstMaxSeprarate;\r\n  #endif\r\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\r\n    uniform  vec2 u_ROLAngularVelocityGradientX[4];\r\n    uniform  vec2 u_ROLAngularVelocityGradientY[4];\r\n    uniform  vec2 u_ROLAngularVelocityGradientZ[4];\r\n  #endif\r\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\r\n    uniform  vec2 u_ROLAngularVelocityGradientMaxX[4];\r\n    uniform  vec2 u_ROLAngularVelocityGradientMaxY[4];\r\n    uniform  vec2 u_ROLAngularVelocityGradientMaxZ[4];\r\n\tuniform  vec2 u_ROLAngularVelocityGradientMaxW[4];\r\n  #endif\r\n#endif\r\n\r\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\r\n  uniform  float u_TSACycles;\r\n  uniform  vec2 u_TSASubUVLength;\r\n  uniform  vec2 u_TSAGradientUVs[4];//x为key,y为frame\r\n#endif\r\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\r\n  uniform  vec2 u_TSAMaxGradientUVs[4];//x为key,y为frame\r\n#endif\r\n\r\n#ifdef TILINGOFFSET\r\n\tuniform vec4 u_TilingOffset;\r\n#endif\r\n\r\nvec3 rotationByEuler(in vec3 vector,in vec3 rot)\r\n{\r\n\tfloat halfRoll = rot.z * 0.5;\r\n    float halfPitch = rot.x * 0.5;\r\n\tfloat halfYaw = rot.y * 0.5;\r\n\r\n\tfloat sinRoll = sin(halfRoll);\r\n\tfloat cosRoll = cos(halfRoll);\r\n\tfloat sinPitch = sin(halfPitch);\r\n\tfloat cosPitch = cos(halfPitch);\r\n\tfloat sinYaw = sin(halfYaw);\r\n\tfloat cosYaw = cos(halfYaw);\r\n\r\n\tfloat quaX = (cosYaw * sinPitch * cosRoll) + (sinYaw * cosPitch * sinRoll);\r\n\tfloat quaY = (sinYaw * cosPitch * cosRoll) - (cosYaw * sinPitch * sinRoll);\r\n\tfloat quaZ = (cosYaw * cosPitch * sinRoll) - (sinYaw * sinPitch * cosRoll);\r\n\tfloat quaW = (cosYaw * cosPitch * cosRoll) + (sinYaw * sinPitch * sinRoll);\r\n\t\r\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\r\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\r\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\r\n\t\r\n\tfloat x = quaX + quaX;\r\n    float y = quaY + quaY;\r\n    float z = quaZ + quaZ;\r\n    float wx = quaW * x;\r\n    float wy = quaW * y;\r\n    float wz = quaW * z;\r\n\tfloat xx = quaX * x;\r\n    float xy = quaX * y;\r\n\tfloat xz = quaX * z;\r\n    float yy = quaY * y;\r\n    float yz = quaY * z;\r\n    float zz = quaZ * z;\r\n\r\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\r\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\r\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\r\n\t\r\n}\r\n\r\n//假定axis已经归一化\r\nvec3 rotationByAxis(in vec3 vector,in vec3 axis, in float angle)\r\n{\r\n\tfloat halfAngle = angle * 0.5;\r\n\tfloat sin = sin(halfAngle);\r\n\t\r\n\tfloat quaX = axis.x * sin;\r\n\tfloat quaY = axis.y * sin;\r\n\tfloat quaZ = axis.z * sin;\r\n\tfloat quaW = cos(halfAngle);\r\n\t\r\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\r\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\r\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\r\n\t\r\n\tfloat x = quaX + quaX;\r\n    float y = quaY + quaY;\r\n    float z = quaZ + quaZ;\r\n    float wx = quaW * x;\r\n    float wy = quaW * y;\r\n    float wz = quaW * z;\r\n\tfloat xx = quaX * x;\r\n    float xy = quaX * y;\r\n\tfloat xz = quaX * z;\r\n    float yy = quaY * y;\r\n    float yz = quaY * z;\r\n    float zz = quaZ * z;\r\n\r\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\r\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\r\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\r\n\t\r\n}\r\n\r\nvec3 rotationByQuaternions(in vec3 v,in vec4 q) \r\n{\r\n\treturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\r\n}\r\n\r\n \r\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\r\nfloat getCurValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\r\n{\r\n\tfloat curValue;\r\n\tfor(int i=1;i<4;i++)\r\n\t{\r\n\t\tvec2 gradientNumber=gradientNumbers[i];\r\n\t\tfloat key=gradientNumber.x;\r\n\t\tif(key>=normalizedAge)\r\n\t\t{\r\n\t\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\r\n\t\t\tfloat lastKey=lastGradientNumber.x;\r\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\r\n\t\t\tcurValue=mix(lastGradientNumber.y,gradientNumber.y,age);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\treturn curValue;\r\n}\r\n#endif\r\n\r\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\r\nfloat getTotalValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\r\n{\r\n\tfloat totalValue=0.0;\r\n\tfor(int i=1;i<4;i++)\r\n\t{\r\n\t\tvec2 gradientNumber=gradientNumbers[i];\r\n\t\tfloat key=gradientNumber.x;\r\n\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\r\n\t\tfloat lastValue=lastGradientNumber.y;\r\n\t\t\r\n\t\tif(key>=normalizedAge){\r\n\t\t\tfloat lastKey=lastGradientNumber.x;\r\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\r\n\t\t\ttotalValue+=(lastValue+mix(lastValue,gradientNumber.y,age))/2.0*a_ShapePositionStartLifeTime.w*(normalizedAge-lastKey);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\telse{\r\n\t\t\ttotalValue+=(lastValue+gradientNumber.y)/2.0*a_ShapePositionStartLifeTime.w*(key-lastGradientNumber.x);\r\n\t\t}\r\n\t}\r\n\treturn totalValue;\r\n}\r\n#endif\r\n\r\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)\r\nvec4 getColorFromGradient(in vec2 gradientAlphas[4],in vec4 gradientColors[4],in float normalizedAge)\r\n{\r\n\tvec4 overTimeColor;\r\n\tfor(int i=1;i<4;i++)\r\n\t{\r\n\t\tvec2 gradientAlpha=gradientAlphas[i];\r\n\t\tfloat alphaKey=gradientAlpha.x;\r\n\t\tif(alphaKey>=normalizedAge)\r\n\t\t{\r\n\t\t\tvec2 lastGradientAlpha=gradientAlphas[i-1];\r\n\t\t\tfloat lastAlphaKey=lastGradientAlpha.x;\r\n\t\t\tfloat age=(normalizedAge-lastAlphaKey)/(alphaKey-lastAlphaKey);\r\n\t\t\toverTimeColor.a=mix(lastGradientAlpha.y,gradientAlpha.y,age);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\t\r\n\tfor(int i=1;i<4;i++)\r\n\t{\r\n\t\tvec4 gradientColor=gradientColors[i];\r\n\t\tfloat colorKey=gradientColor.x;\r\n\t\tif(colorKey>=normalizedAge)\r\n\t\t{\r\n\t\t\tvec4 lastGradientColor=gradientColors[i-1];\r\n\t\t\tfloat lastColorKey=lastGradientColor.x;\r\n\t\t\tfloat age=(normalizedAge-lastColorKey)/(colorKey-lastColorKey);\r\n\t\t\toverTimeColor.rgb=mix(gradientColors[i-1].yzw,gradientColor.yzw,age);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\treturn overTimeColor;\r\n}\r\n#endif\r\n\r\n\r\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\r\nfloat getFrameFromGradient(in vec2 gradientFrames[4],in float normalizedAge)\r\n{\r\n\tfloat overTimeFrame;\r\n\tfor(int i=1;i<4;i++)\r\n\t{\r\n\t\tvec2 gradientFrame=gradientFrames[i];\r\n\t\tfloat key=gradientFrame.x;\r\n\t\tif(key>=normalizedAge)\r\n\t\t{\r\n\t\t\tvec2 lastGradientFrame=gradientFrames[i-1];\r\n\t\t\tfloat lastKey=lastGradientFrame.x;\r\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\r\n\t\t\toverTimeFrame=mix(lastGradientFrame.y,gradientFrame.y,age);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\treturn floor(overTimeFrame);\r\n}\r\n#endif\r\n\r\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\nvec3 computeParticleLifeVelocity(in float normalizedAge)\r\n{\r\n  vec3 outLifeVelocity;\r\n  #ifdef VELOCITYOVERLIFETIMECONSTANT\r\n\t outLifeVelocity=u_VOLVelocityConst; \r\n  #endif\r\n  #ifdef VELOCITYOVERLIFETIMECURVE\r\n     outLifeVelocity= vec3(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\r\n  #endif\r\n  #ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\r\n\t outLifeVelocity=mix(u_VOLVelocityConst,u_VOLVelocityConstMax,vec3(a_Random1.y,a_Random1.z,a_Random1.w)); \r\n  #endif\r\n  #ifdef VELOCITYOVERLIFETIMERANDOMCURVE\r\n     outLifeVelocity=vec3(mix(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y),\r\n\t                 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z),\r\n\t\t\t\t\t mix(getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\r\n  #endif\r\n\t\t\t\t\t\r\n  return outLifeVelocity;\r\n} \r\n#endif\r\n\r\nvec3 computeParticlePosition(in vec3 startVelocity, in vec3 lifeVelocity,in float age,in float normalizedAge,vec3 gravityVelocity,vec4 worldRotation)\r\n{\r\n   vec3 startPosition;\r\n   vec3 lifePosition;\r\n   #if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\n\t#ifdef VELOCITYOVERLIFETIMECONSTANT\r\n\t\t  startPosition=startVelocity*age;\r\n\t\t  lifePosition=lifeVelocity*age;\r\n\t#endif\r\n\t#ifdef VELOCITYOVERLIFETIMECURVE\r\n\t\t  startPosition=startVelocity*age;\r\n\t\t  lifePosition=vec3(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\r\n\t#endif\r\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\r\n\t\t  startPosition=startVelocity*age;\r\n\t\t  lifePosition=lifeVelocity*age;\r\n\t#endif\r\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\r\n\t\t  startPosition=startVelocity*age;\r\n\t\t  lifePosition=vec3(mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y)\r\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z)\r\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\r\n\t#endif\r\n\t\r\n\tvec3 finalPosition;\r\n\tif(u_VOLSpaceType==0){\r\n\t  if(u_ScalingMode!=2)\r\n\t   finalPosition =rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition),worldRotation);\r\n\t  else\r\n\t   finalPosition =rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition,worldRotation);\r\n\t}\r\n\telse{\r\n\t  if(u_ScalingMode!=2)\r\n\t    finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation)+lifePosition;\r\n\t  else\r\n\t    finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation)+lifePosition;\r\n\t}\r\n  #else\r\n\t startPosition=startVelocity*age;\r\n\t vec3 finalPosition;\r\n\t if(u_ScalingMode!=2)\r\n\t\t\tfinalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation);\r\n\t else\r\n\t   \tfinalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation);\r\n  #endif\r\n  \r\n  if(u_SimulationSpace==0)\r\n    finalPosition=finalPosition+a_SimulationWorldPostion;\r\n  else if(u_SimulationSpace==1) \r\n    finalPosition=finalPosition+u_WorldPosition;\r\n  \r\n  finalPosition+=0.5*gravityVelocity*age;\r\n \r\n  return  finalPosition;\r\n}\r\n\r\n\r\nvec4 computeParticleColor(in vec4 color,in float normalizedAge)\r\n{\r\n\t#ifdef COLOROVERLIFETIME\r\n\t  color*=getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge);\r\n\t#endif\r\n\t\r\n\t#ifdef RANDOMCOLOROVERLIFETIME\r\n\t  color*=mix(getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge),getColorFromGradient(u_MaxColorOverLifeGradientAlphas,u_MaxColorOverLifeGradientColors,normalizedAge),a_Random0.y);\r\n\t#endif\r\n\r\n    return color;\r\n}\r\n\r\nvec2 computeParticleSizeBillbard(in vec2 size,in float normalizedAge)\r\n{\r\n\t#ifdef SIZEOVERLIFETIMECURVE\r\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\r\n\t#endif\r\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\r\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \r\n\t#endif\r\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\r\n\t\tsize*=vec2(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge));\r\n\t#endif\r\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\r\n\t    size*=vec2(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\r\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z));\r\n\t#endif\r\n\treturn size;\r\n}\r\n\r\n#ifdef RENDERMODE_MESH\r\nvec3 computeParticleSizeMesh(in vec3 size,in float normalizedAge)\r\n{\r\n\t#ifdef SIZEOVERLIFETIMECURVE\r\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\r\n\t#endif\r\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\r\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \r\n\t#endif\r\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\r\n\t\tsize*=vec3(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge));\r\n\t#endif\r\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\r\n\t    size*=vec3(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\r\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z)\r\n\t\t,mix(getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxZ,normalizedAge),a_Random0.z));\r\n\t#endif\r\n\treturn size;\r\n}\r\n#endif\r\n\r\nfloat computeParticleRotationFloat(in float rotation,in float age,in float normalizedAge)\r\n{ \r\n\t#ifdef ROTATIONOVERLIFETIME\r\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\r\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\r\n\t        rotation+=ageRot;\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\r\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\r\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\r\n\t        rotation+=ageRot;\r\n\t    #endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\r\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\r\n\t\t#endif\r\n\t#endif\r\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\r\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\r\n\t\t\tfloat ageRot=u_ROLAngularVelocityConstSeprarate.z*age;\r\n\t        rotation+=ageRot;\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\r\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge);\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\r\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConstSeprarate.z,u_ROLAngularVelocityConstMaxSeprarate.z,a_Random0.w)*age;\r\n\t        rotation+=ageRot;\r\n\t    #endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\r\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\r\n\t\t#endif\r\n\t#endif\r\n\treturn rotation;\r\n}\r\n\r\n#if defined(RENDERMODE_MESH)&&(defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE))\r\nvec3 computeParticleRotationVec3(in vec3 rotation,in float age,in float normalizedAge)\r\n{ \r\n\t#ifdef ROTATIONOVERLIFETIME\r\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\r\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\r\n\t        rotation+=ageRot;\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\r\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\r\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\r\n\t        rotation+=ageRot;\r\n\t    #endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\r\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\r\n\t\t#endif\r\n\t#endif\r\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\r\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\r\n\t\t\tvec3 ageRot=u_ROLAngularVelocityConstSeprarate*age;\r\n\t        rotation+=ageRot;\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\r\n\t\t\trotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\r\n\t\t\tvec3 ageRot=mix(u_ROLAngularVelocityConstSeprarate,u_ROLAngularVelocityConstMaxSeprarate,a_Random0.w)*age;\r\n\t        rotation+=ageRot;\r\n\t    #endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\r\n\t\t\trotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxX,normalizedAge),a_Random0.w)\r\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxY,normalizedAge),a_Random0.w)\r\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\r\n\t\t#endif\r\n\t#endif\r\n\treturn rotation;\r\n}\r\n#endif\r\n\r\nvec2 computeParticleUV(in vec2 uv,in float normalizedAge)\r\n{ \r\n\t#ifdef TEXTURESHEETANIMATIONCURVE\r\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\r\n\t\tfloat frame=getFrameFromGradient(u_TSAGradientUVs,cycleNormalizedAge-floor(cycleNormalizedAge));\r\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\r\n\t\tfloat floorTotalULength=floor(totalULength);\r\n\t    uv.x+=totalULength-floorTotalULength;\r\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\r\n    #endif\r\n\t#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\r\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\r\n\t\tfloat uvNormalizedAge=cycleNormalizedAge-floor(cycleNormalizedAge);\r\n\t    float frame=floor(mix(getFrameFromGradient(u_TSAGradientUVs,uvNormalizedAge),getFrameFromGradient(u_TSAMaxGradientUVs,uvNormalizedAge),a_Random1.x));\r\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\r\n\t\tfloat floorTotalULength=floor(totalULength);\r\n\t    uv.x+=totalULength-floorTotalULength;\r\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\r\n    #endif\r\n\treturn uv;\r\n}\r\n\r\nvoid main()\r\n{\r\n\tfloat age = u_CurrentTime - a_DirectionTime.w;\r\n\tfloat normalizedAge = age/a_ShapePositionStartLifeTime.w;\r\n\tvec3 lifeVelocity;\r\n\tif(normalizedAge<1.0)\r\n\t{ \r\n\t\tvec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;\r\n\t\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\n\t\t\tlifeVelocity= computeParticleLifeVelocity(normalizedAge);//计算粒子生命周期速度\r\n\t\t#endif \r\n\t\tvec3 gravityVelocity=u_Gravity*age;\r\n\t\t\r\n\t\tvec4 worldRotation;\r\n\t\tif(u_SimulationSpace==0)\r\n\t\t\tworldRotation=a_SimulationWorldRotation;\r\n\t\telse\r\n\t\t\tworldRotation=u_WorldRotation;\r\n\t\t\r\n\t\tvec3 center=computeParticlePosition(startVelocity, lifeVelocity, age, normalizedAge,gravityVelocity,worldRotation);//计算粒子位置\r\n\t\r\n\t\r\n\t\t#ifdef SPHERHBILLBOARD\r\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\r\n\t\t\tvec3 cameraUpVector =normalize(u_CameraUp);//TODO:是否外面归一化\r\n\t\t\tvec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\r\n\t\t\tvec3 upVector = normalize(cross(sideVector,u_CameraDirection));\r\n\t\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\r\n\t\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\r\n\t\t\t\tif(u_ThreeDStartRotation){\r\n\t\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));\r\n\t\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,rotation);\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\r\n\t\t\t\t\tfloat c = cos(rot);\r\n\t\t\t\t\tfloat s = sin(rot);\r\n\t\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\r\n\t\t\t\t\tcorner=rotation*corner;\r\n\t\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\r\n\t\t\t\t}\r\n\t\t\t#else\r\n\t\t\t\tif(u_ThreeDStartRotation){\r\n\t\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,a_StartRotation0);\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\tfloat c = cos(a_StartRotation0.x);\r\n\t\t\t\t\tfloat s = sin(a_StartRotation0.x);\r\n\t\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\r\n\t\t\t\t\tcorner=rotation*corner;\r\n\t\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef STRETCHEDBILLBOARD\r\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\r\n\t\t\tvec3 velocity;\r\n\t\t\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\n\t\t\t\tif(u_VOLSpaceType==0)\r\n\t\t\t\tvelocity=rotationByQuaternions(u_SizeScale*(startVelocity+lifeVelocity),worldRotation)+gravityVelocity;\r\n\t\t\t\telse\r\n\t\t\t\tvelocity=rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+lifeVelocity+gravityVelocity;\r\n\t\t\t#else\r\n\t\t\t\tvelocity= rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+gravityVelocity;\r\n\t\t\t#endif\t\r\n\t\t\tvec3 cameraUpVector = normalize(velocity);\r\n\t\t\tvec3 direction = normalize(center-u_CameraPos);\r\n\t\t\tvec3 sideVector = normalize(cross(direction,normalize(velocity)));\r\n\t\t\t\r\n\t\t\tsideVector=u_SizeScale.xzy*sideVector;\r\n\t\t\tcameraUpVector=length(vec3(u_SizeScale.x,0.0,0.0))*cameraUpVector;\r\n\t\t\t\r\n\t\t\tvec2 size=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\r\n\t\t\t\r\n\t\t\tconst mat2 rotaionZHalfPI=mat2(0.0, -1.0, 1.0, 0.0);\r\n\t\t\tcorner=rotaionZHalfPI*corner;\r\n\t\t\tcorner.y=corner.y-abs(corner.y);\r\n\t\t\t\r\n\t\t\tfloat speed=length(velocity);//TODO:\r\n\t\t\tcenter +=sign(u_SizeScale.x)*(sign(u_StretchedBillboardLengthScale)*size.x*corner.x*sideVector+(speed*u_StretchedBillboardSpeedScale+size.y*u_StretchedBillboardLengthScale)*corner.y*cameraUpVector);\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef HORIZONTALBILLBOARD\r\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\r\n\t\t\tconst vec3 cameraUpVector=vec3(0.0,0.0,1.0);\r\n\t\t\tconst vec3 sideVector = vec3(-1.0,0.0,0.0);\r\n\t\t\t\r\n\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\r\n\t\t\tfloat c = cos(rot);\r\n\t\t\tfloat s = sin(rot);\r\n\t\t\tmat2 rotation= mat2(c, -s, s, c);\r\n\t\t\tcorner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\r\n\t\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\r\n\t\t\tcenter +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef VERTICALBILLBOARD\r\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\r\n\t\t\tconst vec3 cameraUpVector =vec3(0.0,1.0,0.0);\r\n\t\t\tvec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\r\n\t\t\t\r\n\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\r\n\t\t\tfloat c = cos(rot);\r\n\t\t\tfloat s = sin(rot);\r\n\t\t\tmat2 rotation= mat2(c, -s, s, c);\r\n\t\t\tcorner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\r\n\t\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\r\n\t\t\tcenter +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef RENDERMODE_MESH\r\n\t\t\tvec3 size=computeParticleSizeMesh(a_StartSize,normalizedAge);\r\n\t\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\r\n\t\t\t\tif(u_ThreeDStartRotation){\r\n\t\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z, age,normalizedAge));\r\n\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,rotation),worldRotation);\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\t#ifdef ROTATIONOVERLIFETIME\r\n\t\t\t\t\t\tfloat angle=computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\r\n\t\t\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\r\n\t\t\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),angle),worldRotation));//已验证\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse{\r\n\t\t\t\t\t\t\t#ifdef SHAPE\r\n\t\t\t\t\t\t\t\tcenter+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),angle),worldRotation));\r\n\t\t\t\t\t\t\t#else\r\n\t\t\t\t\t\t\t\tif(u_SimulationSpace==0)\r\n\t\t\t\t\t\t\t\t\tcenter+=rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle);//已验证\r\n\t\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\r\n\t\t\t\t\t\t\t\t\tcenter+=rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle),worldRotation);//已验证\r\n\t\t\t\t\t\t\t#endif\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t#endif\r\n\t\t\t\t\t#ifdef ROTATIONOVERLIFETIMESEPERATE\r\n\t\t\t\t\t\t//TODO:是否应合并if(u_ThreeDStartRotation)分支代码,待测试\r\n\t\t\t\t\t\tvec3 angle=computeParticleRotationVec3(vec3(0.0,0.0,-a_StartRotation0.x), age,normalizedAge);\r\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByEuler(u_SizeScale*a_MeshPosition*size,vec3(angle.x,angle.y,angle.z)),worldRotation));//已验证\r\n\t\t\t\t\t#endif\t\t\r\n\t\t\t\t}\r\n\t\t\t#else\r\n\t\t\t\tif(u_ThreeDStartRotation){\r\n\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,a_StartRotation0),worldRotation);//已验证\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\r\n\t\t\t\t\t\tif(u_SimulationSpace==0)\r\n\t\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x);\r\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\r\n\t\t\t\t\t\t\tcenter+= (rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x),worldRotation));//已验证\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse{\r\n\t\t\t\t\t\t#ifdef SHAPE\r\n\t\t\t\t\t\t\tif(u_SimulationSpace==0)\r\n\t\t\t\t\t\t\t\tcenter+= u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x);\r\n\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\r\n\t\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x),worldRotation);\t\r\n\t\t\t\t\t\t#else\r\n\t\t\t\t\t\t\tif(u_SimulationSpace==0)\r\n\t\t\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x);\r\n\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\r\n\t\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x),worldRotation);//已验证\r\n\t\t\t\t\t\t#endif\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t\tv_MeshColor=a_MeshColor;\r\n\t\t#endif\r\n\t\r\n\t\tgl_Position=u_Projection*u_View*vec4(center,1.0);\r\n\t\tv_Color = computeParticleColor(a_StartColor, normalizedAge);\r\n\t\t#ifdef DIFFUSEMAP\r\n\t\t\t#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\r\n\t\t\t\tv_TextureCoordinate =computeParticleUV(a_CornerTextureCoordinate.zw, normalizedAge);\r\n\t\t\t#endif\r\n\t\t\t#ifdef RENDERMODE_MESH\r\n\t\t\t\tv_TextureCoordinate =computeParticleUV(a_MeshTextureCoordinate, normalizedAge);\r\n\t\t\t#endif\r\n\t\t\t\r\n\t\t\t#ifdef TILINGOFFSET\r\n\t\t\t\tv_TextureCoordinate=TransformUV(v_TextureCoordinate,u_TilingOffset);\r\n\t\t\t#endif\r\n\t\t#endif\r\n   \t}\r\n   \telse\r\n\t{\r\n\t\tgl_Position=vec4(2.0,2.0,2.0,1.0);//Discard use out of X(-1,1),Y(-1,1),Z(0,1)\r\n\t}\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}\r\n\r\n',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n  precision highp float;\r\n#else\r\n  precision mediump float;\r\n#endif\r\n\r\nvarying vec4 v_Color;\r\nvarying vec2 v_TextureCoordinate;\r\nuniform sampler2D u_texture;\r\nuniform vec4 u_Tintcolor;\r\n\r\n#ifdef RENDERMODE_MESH\r\n\tvarying vec4 v_MeshColor;\r\n#endif\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\t#ifdef ADDTIVEFOG\r\n\t#else\r\n\t\tuniform vec3 u_FogColor;\r\n\t#endif\r\n#endif\r\n\r\n\r\nvoid main()\r\n{\t\r\n\t#ifdef RENDERMODE_MESH\r\n\t\tgl_FragColor=v_MeshColor;\r\n\t#else\r\n\t\tgl_FragColor=vec4(1.0);\t\r\n\t#endif\r\n\t\t\r\n\t#ifdef DIFFUSEMAP\r\n\t\t#ifdef TINTCOLOR\r\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*u_Tintcolor*2.0*v_Color;\r\n\t\t#else\r\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*v_Color;\r\n\t\t#endif\r\n\t#else\r\n\t\t#ifdef TINTCOLOR\r\n\t\t\tgl_FragColor*=u_Tintcolor*2.0*v_Color;\r\n\t\t#else\r\n\t\t\tgl_FragColor*=v_Color;\r\n\t\t#endif\r\n\t#endif\r\n\t\r\n\t#ifdef FOG\r\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\r\n\t\t#ifdef ADDTIVEFOG\r\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\r\n\t\t#else\r\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\r\n\t\t#endif\r\n\t#endif\r\n}",r),e={a_Position:Qe.MESH_POSITION0},t={u_TintColor:ue.PERIOD_MATERIAL,u_Exposure:ue.PERIOD_MATERIAL,u_Rotation:ue.PERIOD_MATERIAL,u_CubeTexture:ue.PERIOD_MATERIAL,u_ViewProjection:ue.PERIOD_CAMERA},n=ue.add("SkyBox"),i=new ir(e,t),n.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\nuniform mat4 u_ViewProjection;\r\nuniform float u_Rotation;\r\nvarying vec3 v_Texcoord;\r\n\r\n\r\nvec4 rotateAroundYInDegrees (vec4 vertex, float degrees)\r\n{\r\n\tfloat angle = degrees * 3.141593 / 180.0;\r\n\tfloat sina=sin(angle);\r\n\tfloat cosa=cos(angle);\r\n\tmat2 m = mat2(cosa, -sina, sina, cosa);\r\n\treturn vec4(m*vertex.xz, vertex.yw).xzyw;\r\n}\r\n\t\t\r\nvoid main()\r\n{\r\n\tvec4 position=rotateAroundYInDegrees(a_Position,u_Rotation);\r\n\tgl_Position = u_ViewProjection*position;\r\n\tv_Texcoord=vec3(-a_Position.x,a_Position.yz);//转换坐标系\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}\r\n',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\nprecision highp float;\r\n#else\r\nprecision mediump float;\r\n#endif\r\n\r\nvarying vec3 v_Texcoord;\r\n\r\nuniform samplerCube u_CubeTexture;\r\nuniform float u_Exposure;\r\nuniform vec4 u_TintColor;\r\n\r\n\r\nvoid main()\r\n{\t\r\n\tvec3 color=textureCube(u_CubeTexture, v_Texcoord).rgb*u_TintColor.rgb*u_Exposure*2.0;\r\n\tgl_FragColor=vec4(color,1.0);\r\n}\r\n\r\n"),e={a_Position:Qe.MESH_POSITION0},t={u_SunSize:ue.PERIOD_MATERIAL,u_SunSizeConvergence:ue.PERIOD_MATERIAL,u_AtmosphereThickness:ue.PERIOD_MATERIAL,u_SkyTint:ue.PERIOD_MATERIAL,u_GroundTint:ue.PERIOD_MATERIAL,u_Exposure:ue.PERIOD_MATERIAL,u_ViewProjection:ue.PERIOD_CAMERA,"u_SunLight.direction":ue.PERIOD_SCENE,"u_SunLight.color":ue.PERIOD_SCENE},n=ue.add("SkyBoxProcedural"),i=new ir(e,t),n.addSubShader(i),i.addShaderPass("#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include \"Lighting.glsl\";\r\n\r\n#define OUTER_RADIUS 1.025\r\n#define RAYLEIGH (mix(0.0, 0.0025, pow(u_AtmosphereThickness,2.5)))// Rayleigh constant Rayleigh为夜空光和极光亮度单位\r\n#define MIE 0.0010             // Mie constant 米氏散射\r\n#define SUN_BRIGHTNESS 20.0    // Sun brightness\r\n#define MAX_SCATTER 50.0 // Maximum scattering value, to prevent math overflows on Adrenos\r\n\r\nconst float SKY_GROUND_THRESHOLD = 0.02;\r\nconst float outerRadius = OUTER_RADIUS;\r\nconst float outerRadius2 = OUTER_RADIUS*OUTER_RADIUS;\r\nconst float innerRadius = 1.0;\r\nconst float innerRadius2 = 1.0;\r\nconst float cameraHeight = 0.0001;\r\n\r\nconst float HDSundiskIntensityFactor = 15.0;\r\nconst float simpleSundiskIntensityFactor = 27.0;\r\n\r\nconst float sunScale = 400.0 * SUN_BRIGHTNESS;\r\nconst float kmESun = MIE * SUN_BRIGHTNESS;\r\nconst float km4PI = MIE * 4.0 * 3.14159265;\r\nconst float scale = 1.0 / (OUTER_RADIUS - 1.0);\r\nconst float scaleDepth = 0.25;\r\nconst float scaleOverScaleDepth = (1.0 / (OUTER_RADIUS - 1.0)) / 0.25;\r\nconst float samples = 2.0; // THIS IS UNROLLED MANUALLY, DON'T TOUCH\r\n\r\n// RGB wavelengths        .35 (.62=158), .43 (.68=174), .525 (.75=190)\r\nconst vec3 c_DefaultScatteringWavelength = vec3(0.65, 0.57, 0.475);//默认散射波长\r\nconst vec3 c_VariableRangeForScatteringWavelength = vec3(0.15, 0.15, 0.15);//散射播放的可变范围\r\n\r\nattribute vec4 a_Position;\r\n\r\nuniform mat4 u_ViewProjection;\r\nuniform vec3 u_SkyTint;\r\nuniform vec3 u_GroundTint;\r\nuniform float u_Exposure;\r\nuniform float u_AtmosphereThickness;\r\nuniform DirectionLight u_SunLight;\r\n\r\nvarying vec3 v_GroundColor;\r\nvarying vec3 v_SkyColor;\r\n\r\n#ifdef SUN_HIGH_QUALITY\r\n\tvarying vec3 v_Vertex;\r\n#elif defined(SUN_SIMPLE)\r\n\tvarying vec3 v_RayDir;\r\n#else\r\n\tvarying float v_SkyGroundFactor;\r\n#endif\r\n\r\n#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\r\n\tvarying vec3 v_SunColor;\r\n#endif\r\n\r\n// Calculates the Rayleigh phase function\r\nfloat getRayleighPhase(vec3 light, vec3 ray) \r\n{\r\n\tfloat eyeCos = dot(light, ray);\r\n\treturn 0.75 + 0.75*eyeCos*eyeCos;\r\n}\r\n\r\nfloat scaleAngle(float inCos)\r\n{\r\n\tfloat x = 1.0 - inCos;\r\n\treturn 0.25 * exp(-0.00287 + x*(0.459 + x*(3.83 + x*(-6.80 + x*5.25))));\r\n}\r\n\r\n\r\nvoid main () {\r\n\tgl_Position = u_ViewProjection*a_Position;\r\n\r\n\tvec3 skyTintInGammaSpace = u_SkyTint;//支持非GAMMA空间后要调整\r\n\tvec3 scatteringWavelength = mix(c_DefaultScatteringWavelength-c_VariableRangeForScatteringWavelength,c_DefaultScatteringWavelength+c_VariableRangeForScatteringWavelength,vec3(1.0) - skyTintInGammaSpace); // using Tint in sRGB+ gamma allows for more visually linear interpolation and to keep (0.5) at (128, gray in sRGB) point\r\n\tvec3 invWavelength = 1.0 / pow(scatteringWavelength, vec3(4.0));\r\n\r\n\tfloat krESun = RAYLEIGH * SUN_BRIGHTNESS;\r\n\tfloat kr4PI = RAYLEIGH * 4.0 * 3.14159265;\r\n\r\n\tvec3 cameraPos = vec3(0.0,innerRadius + cameraHeight,0.0); // The camera's current position\r\n\r\n\t// Get the ray from the camera to the vertex and its length (which is the far point of the ray passing through the atmosphere)\r\n\tvec3 eyeRay = normalize(a_Position.xyz);\r\n\r\n\tfloat far = 0.0;\r\n\tvec3 cIn, cOut;\r\n\tif (eyeRay.y >= 0.0) {// Sky\r\n\t\t// Calculate the length of the \"atmosphere\"\r\n\t\tfar = sqrt(outerRadius2 + innerRadius2 * eyeRay.y * eyeRay.y - innerRadius2) - innerRadius * eyeRay.y;\r\n\r\n\t\t// Calculate the ray's starting position, then calculate its scattering offset\r\n\t\tfloat height = innerRadius + cameraHeight;\r\n\t\tfloat depth = exp(scaleOverScaleDepth * -cameraHeight);\r\n\t\tfloat startAngle = dot(eyeRay, cameraPos) / height;\r\n\t\tfloat startOffset = depth*scaleAngle(startAngle);\r\n\r\n\t\t// Initialize the scattering loop variables\r\n\t\tfloat sampleLength = far / samples;\r\n\t\tfloat scaledLength = sampleLength * scale;\r\n\t\tvec3 sampleRay = eyeRay * sampleLength;\r\n\t\tvec3 samplePoint = cameraPos + sampleRay * 0.5;\r\n\r\n\t\tvec3 frontColor = vec3(0.0);\r\n\t\t//unrolling this manually to avoid some platform for loop slow\r\n\t\t{\r\n\t\t\tfloat height = length(samplePoint);\r\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\r\n\t\t\tfloat lightAngle = dot(-u_SunLight.direction, samplePoint) / height;\r\n\t\t\tfloat cameraAngle = dot(eyeRay, samplePoint) / height;\r\n\t\t\tfloat scatter = (startOffset + depth*(scaleAngle(lightAngle) - scaleAngle(cameraAngle)));\r\n\t\t\tvec3 attenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\r\n\r\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\r\n\t\t\tsamplePoint += sampleRay;\r\n\t\t}\r\n\t\t{\r\n\t\t\tfloat height = length(samplePoint);\r\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\r\n\t\t\tfloat lightAngle = dot(-u_SunLight.direction, samplePoint) / height;\r\n\t\t\tfloat cameraAngle = dot(eyeRay, samplePoint) / height;\r\n\t\t\tfloat scatter = (startOffset + depth*(scaleAngle(lightAngle) - scaleAngle(cameraAngle)));\r\n\t\t\tvec3 attenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\r\n\r\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\r\n\t\t\tsamplePoint += sampleRay;\r\n\t\t}\r\n\r\n\t\t// Finally, scale the Mie and Rayleigh colors and set up the varying variables for the pixel shader\r\n\t\tcIn = frontColor * (invWavelength * krESun);\r\n\t\tcOut = frontColor * kmESun;\r\n\t} else {// Ground\r\n\t\tfar = (-cameraHeight) / (min(-0.001, eyeRay.y));\r\n\t\tvec3 pos = cameraPos + far * eyeRay;\r\n\r\n\t\t// Calculate the ray's starting position, then calculate its scattering offset\r\n\t\tfloat depth = exp((-cameraHeight) * (1.0/scaleDepth));\r\n\t\tfloat cameraAngle = dot(-eyeRay, pos);\r\n\t\tfloat lightAngle = dot(-u_SunLight.direction, pos);\r\n\t\tfloat cameraScale = scaleAngle(cameraAngle);\r\n\t\tfloat lightScale = scaleAngle(lightAngle);\r\n\t\tfloat cameraOffset = depth*cameraScale;\r\n\t\tfloat temp = lightScale + cameraScale;\r\n\r\n\t\t// Initialize the scattering loop variables\r\n\t\tfloat sampleLength = far / samples;\r\n\t\tfloat scaledLength = sampleLength * scale;\r\n\t\tvec3 sampleRay = eyeRay * sampleLength;\r\n\t\tvec3 samplePoint = cameraPos + sampleRay * 0.5;\r\n\r\n\t\t// Now loop through the sample rays\r\n\t\tvec3 frontColor = vec3(0.0, 0.0, 0.0);\r\n\t\tvec3 attenuate;\r\n\r\n\t\t// Loop removed because we kept hitting SM2.0 temp variable limits. Doesn't affect the image too much.\r\n\t\t{\r\n\t\t\tfloat height = length(samplePoint);\r\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\r\n\t\t\tfloat scatter = depth*temp - cameraOffset;\r\n\t\t\tattenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\r\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\r\n\t\t\tsamplePoint += sampleRay;\r\n\t\t}\r\n\r\n\t\tcIn = frontColor * (invWavelength * krESun + kmESun);\r\n\t\tcOut = clamp(attenuate, 0.0, 1.0);\r\n\t}\r\n\r\n\t#ifdef SUN_HIGH_QUALITY\r\n\t\tv_Vertex = -a_Position.xyz;\r\n\t#elif defined(SUN_SIMPLE) \r\n\t\tv_RayDir = -eyeRay;\r\n\t#else\r\n\t\tv_SkyGroundFactor = -eyeRay.y / SKY_GROUND_THRESHOLD;\r\n\t#endif\r\n\r\n\t// if we want to calculate color in vprog:\r\n\t// in case of linear: multiply by _Exposure in here (even in case of lerp it will be common multiplier, so we can skip mul in fshader)\r\n\tv_GroundColor = u_Exposure * (cIn + u_GroundTint*u_GroundTint * cOut);//u_GroundColor*u_GroundColor is gamma space convert to linear space\r\n\tv_SkyColor    = u_Exposure * (cIn * getRayleighPhase(-u_SunLight.direction, -eyeRay));\r\n\r\n\t\r\n\t// The sun should have a stable intensity in its course in the sky. Moreover it should match the highlight of a purely specular material.\r\n\t// This matching was done using the Unity3D standard shader BRDF1 on the 5/31/2017\r\n\t// Finally we want the sun to be always bright even in LDR thus the normalization of the lightColor for low intensity.\r\n\tfloat lightColorIntensity = clamp(length(u_SunLight.color), 0.25, 1.0);\r\n\r\n\t#ifdef SUN_HIGH_QUALITY \r\n\t\tv_SunColor = HDSundiskIntensityFactor * clamp(cOut,0.0,1.0) * u_SunLight.color / lightColorIntensity;\r\n\t#elif defined(SUN_SIMPLE) \r\n\t\tv_SunColor = simpleSundiskIntensityFactor * clamp(cOut * sunScale,0.0,1.0) * u_SunLight.color / lightColorIntensity;\r\n\t#endif\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}\r\n",'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Lighting.glsl";\r\n\r\nconst float MIE_G = -0.990;\r\nconst float MIE_G2 = 0.9801;\r\nconst float SKY_GROUND_THRESHOLD = 0.02;\r\n\r\nuniform float u_SunSize;\r\nuniform float u_SunSizeConvergence;\r\nuniform DirectionLight u_SunLight;\r\n\r\n\r\nvarying vec3 v_GroundColor;\r\nvarying vec3 v_SkyColor;\r\n\r\n\r\n#ifdef SUN_HIGH_QUALITY\r\n\tvarying vec3 v_Vertex;\r\n#elif defined(SUN_SIMPLE)\r\n\tvarying vec3 v_RayDir;\r\n#else\r\n\tvarying float v_SkyGroundFactor;\r\n#endif\r\n\r\n#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\r\n\tvarying vec3 v_SunColor;\r\n#endif\r\n\r\n// Calculates the Mie phase function\r\nfloat getMiePhase(float eyeCos, float eyeCos2) {\r\n\tfloat temp = 1.0 + MIE_G2 - 2.0 * MIE_G * eyeCos;\r\n\ttemp = pow(temp, pow(u_SunSize,0.65) * 10.0);\r\n\ttemp = max(temp,1.0e-4); // prevent division by zero, esp. in half precision\r\n\ttemp = 1.5 * ((1.0 - MIE_G2) / (2.0 + MIE_G2)) * (1.0 + eyeCos2) / temp;\r\n\treturn temp;\r\n}\r\n\r\n// Calculates the sun shape\r\nfloat calcSunAttenuation(vec3 lightPos, vec3 ray) {\r\n\t#ifdef SUN_HIGH_QUALITY\r\n\t\tfloat focusedEyeCos = pow(clamp(dot(lightPos, ray),0.0,1.0), u_SunSizeConvergence);\r\n\t\treturn getMiePhase(-focusedEyeCos, focusedEyeCos * focusedEyeCos);\r\n\t#else //SUN_SIMPLE\r\n\t\tvec3 delta = lightPos - ray;\r\n\t\tfloat dist = length(delta);\r\n\t\tfloat spot = 1.0 - smoothstep(0.0, u_SunSize, dist);\r\n\t\treturn spot * spot;\r\n\t#endif\r\n}\r\n\r\nvoid main() {\r\n\t// if y > 1 [eyeRay.y < -SKY_GROUND_THRESHOLD] - ground\r\n\t// if y >= 0 and < 1 [eyeRay.y <= 0 and > -SKY_GROUND_THRESHOLD] - horizon\r\n\t// if y < 0 [eyeRay.y > 0] - sky\r\n\tvec3 col = vec3(0.0, 0.0, 0.0);\r\n\r\n\t#ifdef SUN_HIGH_QUALITY\r\n\t\tvec3 ray = normalize(v_Vertex);\r\n\t\tfloat y = ray.y / SKY_GROUND_THRESHOLD;\r\n\t#elif defined(SUN_SIMPLE) \r\n\t\tvec3 ray = v_RayDir;\r\n\t\tfloat y = ray.y / SKY_GROUND_THRESHOLD;\t\r\n\t#else\r\n\t\tfloat y = v_SkyGroundFactor;\r\n\t#endif\r\n\r\n\t// if we did precalculate color in vprog: just do lerp between them\r\n\tcol = mix(v_SkyColor, v_GroundColor, clamp(y,0.0,1.0));\r\n\r\n\t#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\r\n\t\tif (y < 0.0)\r\n\t\t\tcol += v_SunColor * calcSunAttenuation(-u_SunLight.direction, -ray);\r\n\t#endif\r\n\r\n\tcol = sqrt(col);//linear space convert to gamma space\r\n\tgl_FragColor=vec4(col,1.0);\r\n}\r\n\r\n'),e={a_Position:Qe.MESH_POSITION0,a_Normal:Qe.MESH_NORMAL0,a_Texcoord0:Qe.MESH_TEXTURECOORDINATE0},t={u_MvpMatrix:ue.PERIOD_SPRITE,u_WorldMat:ue.PERIOD_SPRITE,u_CameraPos:ue.PERIOD_CAMERA,u_Viewport:ue.PERIOD_CAMERA,u_ProjectionParams:ue.PERIOD_CAMERA,u_View:ue.PERIOD_CAMERA,u_LightmapScaleOffset:ue.PERIOD_SPRITE,u_LightMap:ue.PERIOD_SPRITE,u_SplatAlphaTexture:ue.PERIOD_MATERIAL,u_DiffuseTexture1:ue.PERIOD_MATERIAL,u_DiffuseTexture2:ue.PERIOD_MATERIAL,u_DiffuseTexture3:ue.PERIOD_MATERIAL,u_DiffuseTexture4:ue.PERIOD_MATERIAL,u_DiffuseTexture5:ue.PERIOD_MATERIAL,u_DiffuseScaleOffset1:ue.PERIOD_MATERIAL,u_DiffuseScaleOffset2:ue.PERIOD_MATERIAL,u_DiffuseScaleOffset3:ue.PERIOD_MATERIAL,u_DiffuseScaleOffset4:ue.PERIOD_MATERIAL,u_DiffuseScaleOffset5:ue.PERIOD_MATERIAL,u_FogStart:ue.PERIOD_SCENE,u_FogRange:ue.PERIOD_SCENE,u_FogColor:ue.PERIOD_SCENE,u_DirationLightCount:ue.PERIOD_SCENE,u_LightBuffer:ue.PERIOD_SCENE,u_LightClusterBuffer:ue.PERIOD_SCENE,u_AmbientColor:ue.PERIOD_SCENE,u_ShadowMap:ue.PERIOD_SCENE,u_shadowMap2:ue.PERIOD_SCENE,u_shadowMap3:ue.PERIOD_SCENE,u_ShadowSplitSpheres:ue.PERIOD_SCENE,u_ShadowMatrices:ue.PERIOD_SCENE,u_ShadowMapSize:ue.PERIOD_SCENE,"u_DirectionLight.color":ue.PERIOD_SCENE,"u_DirectionLight.direction":ue.PERIOD_SCENE,"u_PointLight.position":ue.PERIOD_SCENE,"u_PointLight.range":ue.PERIOD_SCENE,"u_PointLight.color":ue.PERIOD_SCENE,"u_SpotLight.position":ue.PERIOD_SCENE,"u_SpotLight.direction":ue.PERIOD_SCENE,"u_SpotLight.range":ue.PERIOD_SCENE,"u_SpotLight.spot":ue.PERIOD_SCENE,"u_SpotLight.color":ue.PERIOD_SCENE},r={s_Cull:ue.RENDER_STATE_CULL,s_Blend:ue.RENDER_STATE_BLEND,s_BlendSrc:ue.RENDER_STATE_BLEND_SRC,s_BlendDst:ue.RENDER_STATE_BLEND_DST,s_DepthTest:ue.RENDER_STATE_DEPTH_TEST,s_DepthWrite:ue.RENDER_STATE_DEPTH_WRITE},n=ue.add("ExtendTerrain"),i=new ir(e,t),n.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\nattribute vec2 a_Texcoord0;\r\n\r\nuniform mat4 u_MvpMatrix;\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\r\n\tattribute vec3 a_Normal;\r\n\tvarying vec3 v_Normal;\r\n#endif\r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(CALCULATE_SHADOWS)&&defined(SHADOWMAP_PSSM1))\r\n\tuniform mat4 u_WorldMat;\r\n\tvarying vec3 v_PositionWorld;\r\n#endif\r\n\r\n#ifdef LIGHTMAP\r\n\tvarying vec2 v_LightMapUV;\r\n\tuniform vec4 u_LightmapScaleOffset;\r\n#endif\r\n\r\n#ifdef CALCULATE_SHADOWS\r\n\tvarying vec4 v_ShadowCoord;\r\n#endif\r\n\r\nvoid main()\r\n{\r\n\tgl_Position = u_MvpMatrix * a_Position;\r\n  \r\n\tv_Texcoord0 = a_Texcoord0;\r\n  \r\n\t#ifdef LIGHTMAP\r\n\t\tv_LightMapUV = vec2(a_Texcoord0.x, 1.0 - a_Texcoord0.y) * u_LightmapScaleOffset.xy + u_LightmapScaleOffset.zw;\r\n\t\tv_LightMapUV.y = 1.0 - v_LightMapUV.y;\r\n\t#endif\r\n  \r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\tv_Normal = a_Normal;\r\n\t#endif\r\n\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(CALCULATE_SHADOWS)&&defined(SHADOWMAP_PSSM1))\r\n\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\r\n\t#endif\r\n\r\n\t#ifdef CALCULATE_SHADOWS\r\n\t\tv_ShadowCoord = getShadowCoord(vec4(v_PositionWorld));\r\n\t#endif\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Lighting.glsl";\r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\r\n\tuniform vec3 u_CameraPos;\r\n\tvarying vec3 v_Normal;\r\n\tvarying vec3 v_PositionWorld;\r\n#endif\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\tuniform vec3 u_FogColor;\r\n#endif\r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t#ifdef LEGACYSINGLELIGHTING\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tuniform DirectionLight u_DirectionLight;\r\n\t\t#endif\r\n\t\t#ifdef POINTLIGHT\r\n\t\t\tuniform PointLight u_PointLight;\r\n\t\t#endif\r\n\t\t#ifdef SPOTLIGHT\r\n\t\t\tuniform SpotLight u_SpotLight;\r\n\t\t#endif\r\n\t#else\r\n\t\tuniform mat4 u_View;\r\n\t\tuniform vec4 u_ProjectionParams;\r\n\t\tuniform vec4 u_Viewport;\r\n\t\tuniform int u_DirationLightCount;\r\n\t\tuniform sampler2D u_LightBuffer;\r\n\t\tuniform sampler2D u_LightClusterBuffer;\r\n\t#endif\r\n#endif\r\n\r\n#include "Shadow.glsl"\r\n#ifdef CALCULATE_SHADOWS\r\n\tvarying vec4 v_ShadowCoord;\r\n#endif\r\nvarying float v_posViewZ;\r\n\r\nuniform vec3 u_AmbientColor;\r\n\r\nuniform sampler2D u_SplatAlphaTexture;\r\n\r\nuniform sampler2D u_DiffuseTexture1;\r\nuniform sampler2D u_DiffuseTexture2;\r\nuniform sampler2D u_DiffuseTexture3;\r\nuniform sampler2D u_DiffuseTexture4;\r\nuniform sampler2D u_DiffuseTexture5;\r\n\r\nuniform vec4 u_DiffuseScaleOffset1;\r\nuniform vec4 u_DiffuseScaleOffset2;\r\nuniform vec4 u_DiffuseScaleOffset3;\r\nuniform vec4 u_DiffuseScaleOffset4;\r\nuniform vec4 u_DiffuseScaleOffset5;\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\n#ifdef LIGHTMAP\r\n\tuniform sampler2D u_LightMap;\r\n\tvarying vec2 v_LightMapUV;\r\n#endif\r\n\r\nvoid main()\r\n{\r\n\tvec4 splatAlpha = vec4(1.0);\r\n\t#ifdef ExtendTerrain_DETAIL_NUM1\r\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\r\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\r\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r;\r\n\t#endif\r\n\t#ifdef ExtendTerrain_DETAIL_NUM2\r\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\r\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\r\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\r\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r + color2.xyz * (1.0 - splatAlpha.r);\r\n\t#endif\r\n\t#ifdef ExtendTerrain_DETAIL_NUM3\r\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\r\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\r\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\r\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\r\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * (1.0 - splatAlpha.r - splatAlpha.g);\r\n\t#endif\r\n\t#ifdef ExtendTerrain_DETAIL_NUM4\r\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\r\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\r\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\r\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\r\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\r\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b);\r\n\t#endif\r\n\t#ifdef ExtendTerrain_DETAIL_NUM5\r\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\r\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\r\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\r\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\r\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\r\n\t\tvec4 color5 = texture2D(u_DiffuseTexture5, v_Texcoord0 * u_DiffuseScaleOffset5.xy);\r\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * splatAlpha.a + color5.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b - splatAlpha.a);\r\n\t#endif\r\n\t\tgl_FragColor.w = splatAlpha.a;\r\n\t\t\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\tvec3 normal = v_Normal;\r\n\t\tvec3 dif, spe;\r\n\t#endif\r\n\r\n\tvec3 diffuse = vec3(0.0);\r\n\tvec3 specular= vec3(0.0);\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\r\n\t\tvec3 toEye;\r\n\t\t#ifdef FOG\r\n\t\t\ttoEye=u_CameraPos-v_PositionWorld;\r\n\t\t\tfloat toEyeLength=length(toEye);\r\n\t\t\ttoEye/=toEyeLength;\r\n\t\t#else\r\n\t\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\r\n\t\t#endif\r\n\t#endif\r\n\r\n\t#ifdef LEGACYSINGLELIGHTING\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tLayaAirBlinnPhongDiectionLight(vec3(0.0),1.0,normal,vec3(1.0),toEye,u_DirectionLight,dif,spe);\r\n\t\t\tdiffuse+=dif;\r\n\t\t\tspecular+=spe;\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef POINTLIGHT\r\n\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye,u_PointLight,dif,spe);\r\n\t\t\tdiffuse+=dif;\r\n\t\t\tspecular+=spe;\r\n\t\t#endif\r\n\r\n\t\t#ifdef SPOTLIGHT\r\n\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye,u_SpotLight,dif,spe);\r\n\t\t\tdiffuse+=dif;\r\n\t\t\tspecular+=spe;\r\n\t\t#endif\r\n\t#else\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t{\r\n\t\t\t\tif(i >= u_DirationLightCount)\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tDirectionLight directionLight = getDirectionLight(u_LightBuffer,i);\r\n\t\t\t\tLayaAirBlinnPhongDiectionLight(vec3(0.0),1.0,normal,vec3(1.0),toEye,directionLight,dif,spe);\r\n\t\t\t\tdiffuse+=dif;\r\n\t\t\t\tspecular+=spe;\r\n\t\t\t}\r\n\t\t#endif\r\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\t\tivec4 clusterInfo =getClusterInfo(u_LightClusterBuffer,u_View,u_Viewport, v_PositionWorld,gl_FragCoord,u_ProjectionParams);\r\n\t\t\t#ifdef POINTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tif(i >= clusterInfo.x)//PointLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tPointLight pointLight = getPointLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye,pointLight,dif,spe);\r\n\t\t\t\t\tdiffuse+=dif;\r\n\t\t\t\t\tspecular+=spe;\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t\t#ifdef SPOTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tif(i >= clusterInfo.y)//SpotLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tSpotLight spotLight = getSpotLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye\t,spotLight,dif,spe);\r\n\t\t\t\t\tdiffuse+=dif;\r\n\t\t\t\t\tspecular+=spe;\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t#endif\r\n\t#endif\r\n\r\nvec3 globalDiffuse = u_AmbientColor;\r\n#ifdef LIGHTMAP\r\n\tglobalDiffuse += decodeHDR(texture2D(u_LightMap, v_LightMapUV),5.0);\r\n#endif\r\n\r\n#ifdef CALCULATE_SHADOWS\r\n\tfloat shadowValue = shadowValue = sampleShadowmap(v_ShadowCoord);\r\n\tgl_FragColor = vec4(gl_FragColor.rgb * (globalDiffuse + diffuse) * shadowValue, gl_FragColor.a);\r\n#else\r\n\tgl_FragColor = vec4(gl_FragColor.rgb * (globalDiffuse + diffuse), gl_FragColor.a);\r\n#endif\r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t#ifdef CALCULATE_SHADOWS\r\n\t\tgl_FragColor.rgb += specular * shadowValue;\r\n\t#else\r\n\t\tgl_FragColor.rgb += specular;\r\n\t#endif\r\n#endif\r\n\r\n#ifdef FOG\r\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\r\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\r\n#endif\r\n}\r\n\r\n\r\n\r\n\r\n\r\n',r),e={a_Position:on.TRAIL_POSITION0,a_OffsetVector:on.TRAIL_OFFSETVECTOR,a_Texcoord0X:on.TRAIL_TEXTURECOORDINATE0X,a_Texcoord0Y:on.TRAIL_TEXTURECOORDINATE0Y,a_BirthTime:on.TRAIL_TIME0,a_Color:on.TRAIL_COLOR},t={u_MvpMatrix:ue.PERIOD_SPRITE,u_View:ue.PERIOD_CAMERA,u_Projection:ue.PERIOD_CAMERA,u_TilingOffset:ue.PERIOD_MATERIAL,u_MainTexture:ue.PERIOD_MATERIAL,u_MainColor:ue.PERIOD_MATERIAL,u_CurTime:ue.PERIOD_SPRITE,u_LifeTime:ue.PERIOD_SPRITE,u_WidthCurve:ue.PERIOD_SPRITE,u_WidthCurveKeyLength:ue.PERIOD_SPRITE,u_GradientColorkey:ue.PERIOD_SPRITE,u_GradientAlphakey:ue.PERIOD_SPRITE},r={s_Cull:ue.RENDER_STATE_CULL,s_Blend:ue.RENDER_STATE_BLEND,s_BlendSrc:ue.RENDER_STATE_BLEND_SRC,s_BlendDst:ue.RENDER_STATE_BLEND_DST,s_DepthTest:ue.RENDER_STATE_DEPTH_TEST,s_DepthWrite:ue.RENDER_STATE_DEPTH_WRITE},n=ue.add("Trail"),i=new ir(e,t),n.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec3 a_Position;\r\nattribute vec3 a_OffsetVector;\r\nattribute vec4 a_Color;\r\nattribute float a_Texcoord0X;\r\nattribute float a_Texcoord0Y;\r\nattribute float a_BirthTime;\r\n\r\nuniform mat4 u_View;\r\nuniform mat4 u_Projection;\r\n\r\nuniform vec4 u_TilingOffset;\r\n\r\nuniform float u_CurTime;\r\nuniform float u_LifeTime;\r\nuniform vec4 u_WidthCurve[10];\r\nuniform int u_WidthCurveKeyLength;\r\n\r\nvarying vec2 v_Texcoord0;\r\nvarying vec4 v_Color;\r\n\r\nfloat hermiteInterpolate(float t, float outTangent, float inTangent, float duration, float value1, float value2)\r\n{\r\n\tfloat t2 = t * t;\r\n\tfloat t3 = t2 * t;\r\n\tfloat a = 2.0 * t3 - 3.0 * t2 + 1.0;\r\n\tfloat b = t3 - 2.0 * t2 + t;\r\n\tfloat c = t3 - t2;\r\n\tfloat d = -2.0 * t3 + 3.0 * t2;\r\n\treturn a * value1 + b * outTangent * duration + c * inTangent * duration + d * value2;\r\n}\r\n\r\nfloat getCurWidth(in float normalizeTime)\r\n{\r\n\tfloat width;\r\n\tif(normalizeTime == 0.0){\r\n\t\twidth=u_WidthCurve[0].w;\r\n\t}\r\n\telse if(normalizeTime >= 1.0){\r\n\t\twidth=u_WidthCurve[u_WidthCurveKeyLength - 1].w;\r\n\t}\r\n\telse{\r\n\t\tfor(int i = 0; i < 10; i ++ )\r\n\t\t{\r\n\t\t\tif(normalizeTime == u_WidthCurve[i].x){\r\n\t\t\t\twidth=u_WidthCurve[i].w;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tvec4 lastFrame = u_WidthCurve[i];\r\n\t\t\tvec4 nextFrame = u_WidthCurve[i + 1];\r\n\t\t\tif(normalizeTime > lastFrame.x && normalizeTime < nextFrame.x)\r\n\t\t\t{\r\n\t\t\t\tfloat duration = nextFrame.x - lastFrame.x;\r\n\t\t\t\tfloat t = (normalizeTime - lastFrame.x) / duration;\r\n\t\t\t\tfloat outTangent = lastFrame.z;\r\n\t\t\t\tfloat inTangent = nextFrame.y;\r\n\t\t\t\tfloat value1 = lastFrame.w;\r\n\t\t\t\tfloat value2 = nextFrame.w;\r\n\t\t\t\twidth=hermiteInterpolate(t, outTangent, inTangent, duration, value1, value2);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn width;\r\n}\t\r\n\r\nvoid main()\r\n{\r\n\tfloat normalizeTime = (u_CurTime - a_BirthTime) / u_LifeTime;\r\n\t\r\n\t#ifdef TILINGOFFSET\r\n\t\tv_Texcoord0 = vec2(a_Texcoord0X, 1.0 - a_Texcoord0Y) * u_TilingOffset.xy + u_TilingOffset.zw;\r\n\t#else\r\n\t\tv_Texcoord0 = vec2(a_Texcoord0X, a_Texcoord0Y);\r\n\t#endif\r\n\t\r\n\tv_Color = a_Color;\r\n\t\r\n\tgl_Position = u_Projection * u_View * vec4(a_Position + a_OffsetVector * getCurWidth(normalizeTime),1.0);\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}\r\n',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\nuniform sampler2D u_MainTexture;\r\nuniform vec4 u_MainColor;\r\n\r\nvarying vec2 v_Texcoord0;\r\nvarying vec4 v_Color;\r\n\r\nvoid main()\r\n{\r\n\tvec4 color = 2.0 * u_MainColor * v_Color;\r\n\t#ifdef MAINTEXTURE\r\n\t\tvec4 mainTextureColor = texture2D(u_MainTexture, v_Texcoord0);\r\n\t\tcolor *= mainTextureColor;\r\n\t#endif\r\n\tgl_FragColor = color;\r\n}\r\n\r\n     ",r),e={a_Position:Qe.MESH_POSITION0,a_Normal:Qe.MESH_NORMAL0,a_Tangent0:Qe.MESH_TANGENT0},t={u_MvpMatrix:ue.PERIOD_SPRITE,u_WorldMat:ue.PERIOD_SPRITE,u_CameraPos:ue.PERIOD_CAMERA,u_Time:ue.PERIOD_SCENE,u_MainTexture:ue.PERIOD_MATERIAL,u_NormalTexture:ue.PERIOD_MATERIAL,u_HorizonColor:ue.PERIOD_MATERIAL,u_WaveScale:ue.PERIOD_MATERIAL,u_WaveSpeed:ue.PERIOD_MATERIAL},n=ue.add("WaterPrimary"),i=new ir(e,t),n.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\nattribute vec3 a_Normal;\r\nattribute vec4 a_Tangent0;\r\n\r\nuniform mat4 u_MvpMatrix;\r\nuniform mat4 u_WorldMat;\r\nuniform vec3 u_CameraPos;\r\nuniform float u_WaveScale;\r\nuniform vec4 u_WaveSpeed;\r\nuniform float u_Time;\r\n\r\nvarying vec3 v_Normal;\r\nvarying vec3 v_Tangent;\r\nvarying vec3 v_Binormal;\r\nvarying vec3 v_ViewDir;\r\nvarying vec2 v_Texcoord0;\r\nvarying vec2 v_Texcoord1;\r\n\r\nvoid main()\r\n{\r\n\tvec4 positionWorld = u_WorldMat * a_Position;\r\n\tvec4 position = u_MvpMatrix * a_Position;\r\n\t\r\n\tvec4 temp = vec4(positionWorld.x, positionWorld.z, positionWorld.x, positionWorld.z) * u_WaveScale + u_WaveSpeed * u_WaveScale * u_Time;\r\n\t\r\n\tv_Texcoord0 = temp.xy * vec2(0.4, 0.45);\r\n\tv_Texcoord1 = temp.wz;\r\n\t\r\n\tmat3 worldMat = mat3(u_WorldMat);\r\n\tv_Normal = worldMat * a_Normal;\r\n\tv_Tangent = worldMat * a_Tangent0.xyz;\r\n\tv_Binormal = cross(v_Normal, v_Tangent) * a_Tangent0.w;\r\n\t\r\n\tv_ViewDir = u_CameraPos - positionWorld.xyz;\r\n\tgl_Position = position;\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#ifdef MAINTEXTURE\r\n\tuniform sampler2D u_MainTexture;\r\n#endif\r\n\r\n#ifdef NORMALTEXTURE\r\n\tuniform sampler2D u_NormalTexture;\r\n#endif\r\n\r\nuniform vec4 u_HorizonColor;\r\n\r\nvarying vec3 v_Normal;\r\nvarying vec3 v_Tangent;\r\nvarying vec3 v_Binormal;\r\nvarying vec3 v_ViewDir;\r\nvarying vec2 v_Texcoord0;\r\nvarying vec2 v_Texcoord1;\r\n\r\n\r\n#include "Lighting.glsl"\r\n\r\n\r\n\r\nvec3 NormalSampleToWorldSpace(vec4 normalMapSample) {\r\n\tvec3 normalT;\r\n\tnormalT.x = 2.0 * normalMapSample.x - 1.0;\r\n\tnormalT.y = 1.0 - 2.0 * normalMapSample.y;\r\n\tnormalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\r\n\r\n\tvec3 bumpedNormal = normalize(normalT);\r\n\r\n\treturn bumpedNormal;\r\n}\r\n\r\n\r\nvoid main()\r\n{\r\n\tvec4 bumpColor1 = texture2D(u_NormalTexture, v_Texcoord0);\r\n\tvec4 bumpColor2 = texture2D(u_NormalTexture, v_Texcoord1);\r\n\r\n\tvec3 normal1 = NormalSampleToWorldSpace(bumpColor1);\r\n\tvec3 normal2 = NormalSampleToWorldSpace(bumpColor2);\r\n\t\r\n\tvec3 normal = normalize((normal1 + normal2) * 0.5);\r\n\tvec3 viewDir = normalize(v_ViewDir);\r\n\tfloat fresnel = dot(viewDir, normal);\r\n\t\r\n\tvec4 waterColor = texture2D(u_MainTexture, vec2(fresnel, fresnel));\r\n\t\r\n\tvec4 color;\r\n\tcolor.rgb = mix(waterColor.rgb, u_HorizonColor.rgb, vec3(waterColor.a));\r\n\tcolor.a = u_HorizonColor.a;\r\n\t\r\n\tgl_FragColor = color;\r\n}\r\n\r\n\r\n'),e={a_PositionTexcoord:Qe.MESH_POSITION0},t={u_MainTex:ue.PERIOD_MATERIAL,u_OffsetScale:ue.PERIOD_MATERIAL},n=ue.add("BlitScreen"),i=new ir(e,t),n.addSubShader(i);var a=i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_PositionTexcoord;\r\nuniform vec4 u_OffsetScale;\r\nvarying vec2 v_Texcoord0;\r\n\r\nvoid main() {\t\r\n\tgl_Position = vec4(u_OffsetScale.x*2.0-1.0+(a_PositionTexcoord.x+1.0)*u_OffsetScale.z,(1.0-((u_OffsetScale.y*2.0-1.0+(-a_PositionTexcoord.y+1.0)*u_OffsetScale.w)+1.0)/2.0)*2.0-1.0, 0.0, 1.0);\t\r\n\tv_Texcoord0 = a_PositionTexcoord.zw;\r\n\tgl_Position = remapGLPositionZ(gl_Position);\r\n}',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\nuniform sampler2D u_MainTex;\r\nvarying vec2 v_Texcoord0;\r\n\r\nvoid main() {\r\n\tgl_FragColor = texture2D(u_MainTex, v_Texcoord0);\r\n}\r\n\r\n").renderState;a.depthTest=pe.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=pe.CULL_NONE,a.blend=pe.BLEND_DISABLE,e={a_PositionTexcoord:Qe.MESH_POSITION0},t={u_MainTex:ue.PERIOD_MATERIAL,u_BloomTex:ue.PERIOD_MATERIAL,u_AutoExposureTex:ue.PERIOD_MATERIAL,u_MainTex_TexelSize:ue.PERIOD_MATERIAL,u_SampleScale:ue.PERIOD_MATERIAL,u_Threshold:ue.PERIOD_MATERIAL,u_Params:ue.PERIOD_MATERIAL},n=ue.add("PostProcessBloom"),i=new ir(e,t),n.addSubShader(i),(a=i.addShaderPass(gn,'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform sampler2D u_AutoExposureTex;\r\nuniform vec4 u_MainTex_TexelSize;\r\nuniform vec4 u_Threshold; // x: threshold value (linear), y: threshold - knee, z: knee * 2, w: 0.25 / knee\r\nuniform vec4 u_Params; // x: clamp, yzw: unused\r\n\r\nmediump vec4 prefilter(mediump vec4 color, vec2 uv) {\r\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, uv).r;\r\n\tcolor *= autoExposure;\r\n\tcolor = min(vec4(u_Params.x), color); // clamp to max\r\n\tcolor = quadraticThreshold(color, u_Threshold.x, u_Threshold.yzw);\r\n\treturn color;\r\n}\r\n\r\nvoid fragPrefilter13() {\r\n\tmediump vec4 color = downsampleBox13Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\r\n\tgl_FragColor = prefilter(safeHDR(color), v_Texcoord0);\r\n}\r\n\r\nvoid main() {\r\n\tfragPrefilter13();\r\n}').renderState).depthTest=pe.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=pe.CULL_NONE,a.blend=pe.BLEND_DISABLE,i=new ir(e,t),n.addSubShader(i),(a=i.addShaderPass(gn,'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform sampler2D u_AutoExposureTex;\r\nuniform vec4 u_MainTex_TexelSize;\r\nuniform vec4 u_Threshold; // x: threshold value (linear), y: threshold - knee, z: knee * 2, w: 0.25 / knee\r\nuniform vec4 u_Params; // x: clamp, yzw: unused\r\n\r\nmediump vec4 prefilter(mediump vec4 color, vec2 uv) {\r\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, uv).r;\r\n\tcolor *= autoExposure;\r\n\tcolor = min(vec4(u_Params.x), color); // clamp to max\r\n\tcolor = quadraticThreshold(color, u_Threshold.x, u_Threshold.yzw);\r\n\treturn color;\r\n}\r\n\r\nvoid fragPrefilter4() {\r\n\tmediump vec4 color = downsampleBox4Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\r\n\tgl_FragColor = prefilter(safeHDR(color), v_Texcoord0);\r\n}\r\n\r\nvoid main() {\r\n\tfragPrefilter4();\r\n}').renderState).depthTest=pe.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=pe.CULL_NONE,a.blend=pe.BLEND_DISABLE,i=new ir(e,t),n.addSubShader(i),(a=i.addShaderPass(gn,'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform vec4 u_MainTex_TexelSize;\r\n\r\nvoid fragDownsample13() {\r\n\tmediump vec4 color = downsampleBox13Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\r\n\tgl_FragColor = color;\r\n}\r\n\r\nvoid main() {\r\n\tfragDownsample13();\r\n}').renderState).depthTest=pe.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=pe.CULL_NONE,a.blend=pe.BLEND_DISABLE,i=new ir(e,t),n.addSubShader(i),(a=i.addShaderPass(gn,'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform vec4 u_MainTex_TexelSize;\r\n\r\nvoid fragDownsample4() {\r\n\tmediump vec4 color = downsampleBox4Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\r\n\tgl_FragColor = color;\r\n}\r\n\r\nvoid main() {\r\n\tfragDownsample4();\r\n}').renderState).depthTest=pe.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=pe.CULL_NONE,a.blend=pe.BLEND_DISABLE,i=new ir(e,t),n.addSubShader(i),(a=i.addShaderPass(gn,'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform sampler2D u_BloomTex;\r\n\r\nuniform vec4 u_MainTex_TexelSize;\r\nuniform float u_SampleScale;\r\n\r\nmediump vec4 combine(mediump vec4 bloom, vec2 uv) {\r\n\tmediump vec4 color = texture2D(u_BloomTex, uv);\r\n\treturn bloom + color;\r\n}\r\n\r\nvoid fragUpsampleTent() {\r\n\tmediump vec4 bloom = upsampleTent(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy, vec4(u_SampleScale));\r\n\tgl_FragColor = combine(bloom, v_Texcoord0);\r\n}\r\n\r\nvoid main() {\r\n\tfragUpsampleTent();\r\n}').renderState).depthTest=pe.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=pe.CULL_NONE,a.blend=pe.BLEND_DISABLE,i=new ir(e,t),n.addSubShader(i),(a=i.addShaderPass(gn,'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform sampler2D u_BloomTex;\r\n\r\nuniform vec4 u_MainTex_TexelSize;\r\nuniform float u_SampleScale;\r\n\r\nmediump vec4 combine(mediump vec4 bloom, vec2 uv) {\r\n\tmediump vec4 color = texture2D(u_BloomTex, uv);\r\n\treturn bloom + color;\r\n}\r\n\r\nvoid fragUpsampleBox() {\r\n\tmediump vec4 bloom = upsampleBox(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy, vec4(u_SampleScale));\r\n\tgl_FragColor = combine(bloom, v_Texcoord0);\r\n}\r\n\r\nvoid main() {\r\n\tfragUpsampleBox();\r\n}').renderState).depthTest=pe.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=pe.CULL_NONE,a.blend=pe.BLEND_DISABLE,e={a_PositionTexcoord:Qe.MESH_POSITION0},t={u_MainTex:ue.PERIOD_MATERIAL,u_BloomTex:ue.PERIOD_MATERIAL,u_AutoExposureTex:ue.PERIOD_MATERIAL,u_Bloom_DirtTileOffset:ue.PERIOD_MATERIAL,u_Bloom_DirtTex:ue.PERIOD_MATERIAL,u_BloomTex_TexelSize:ue.PERIOD_MATERIAL,u_Bloom_Settings:ue.PERIOD_MATERIAL,u_Bloom_Color:ue.PERIOD_MATERIAL},n=ue.add("PostProcessComposite"),i=new ir(e,t),n.addSubShader(i),(a=i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_PositionTexcoord;\r\nvarying vec2 v_Texcoord0;\r\n\r\nvoid main() {\r\n\tgl_Position = vec4(a_PositionTexcoord.xy, 0.0, 1.0);\r\n\tv_Texcoord0 = a_PositionTexcoord.zw;\r\n\tgl_Position = remapGLPositionZ(gl_Position);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform sampler2D u_BloomTex;\r\n\r\nuniform sampler2D u_AutoExposureTex;\r\nuniform sampler2D u_Bloom_DirtTex;\r\nuniform vec4 u_BloomTex_TexelSize;\r\nuniform vec4 u_Bloom_DirtTileOffset; // xy: tiling, zw: offset\r\nuniform mediump vec3 u_Bloom_Settings;// x: sampleScale, y: intensity, z: dirt intensity\r\nuniform mediump vec3 u_Bloom_Color;\r\n\r\nvoid main() {\r\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, v_Texcoord0).r;\r\n\tmediump vec4 color=vec4(0.0);\r\n\tcolor = texture2D(u_MainTex, v_Texcoord0);\r\n\t\r\n\tcolor = sRGBToLinear(color);\r\n\tcolor.rgb *= autoExposure;\r\n\t\r\n\t#if defined(BLOOM)||defined(BLOOM_LOW)\r\n\t\t#ifdef BLOOM\r\n\t\t\tmediump vec4 bloom = upsampleTent(u_BloomTex, v_Texcoord0, u_BloomTex_TexelSize.xy, vec4(u_Bloom_Settings.x));\r\n\t\t#else\r\n\t\t\tmediump vec4 bloom = upsampleBox(u_BloomTex, v_Texcoord0, u_BloomTex_TexelSize.xy, vec4(u_Bloom_Settings.x));\r\n\t\t#endif\r\n\r\n\t\t// UVs should be Distort(uv * u_Bloom_DirtTileOffset.xy + u_Bloom_DirtTileOffset.zw)\r\n\t\t// but considering we use a cover-style scale on the dirt texture the difference\r\n\t\t// isn\'t massive so we chose to save a few ALUs here instead in case lens distortion\r\n\t\t// is active\r\n\t\tmediump vec4 dirt =vec4(texture2D(u_Bloom_DirtTex, v_Texcoord0 * u_Bloom_DirtTileOffset.xy + u_Bloom_DirtTileOffset.zw).rgb, 0.0);\r\n\r\n\t\t// Additive bloom (artist friendly)\r\n\t\tbloom *= u_Bloom_Settings.y;\r\n\t\tdirt *= u_Bloom_Settings.z;\r\n\t\tmediump vec4 bloomColor=vec4(u_Bloom_Color, 1.0);\r\n\t\tcolor += bloom * bloomColor;\r\n\t\tcolor += dirt * bloom;\r\n\t#endif\r\n\t\r\n\tmediump vec4 finalColor = color;\r\n\tfinalColor = linearToSRGB(finalColor);\r\n\t//finalColor.rgb = Dither(finalColor.rgb, v_Texcoord0);//TODO:抖动\r\n\tgl_FragColor = finalColor;\r\n}').renderState).depthTest=pe.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=pe.CULL_NONE,a.blend=pe.BLEND_DISABLE}}]),ShaderInit3D}(),yn=function(t){function DirectionLight(){var t;return _classCallCheck(this,DirectionLight),(t=_possibleConstructorReturn(this,_getPrototypeOf(DirectionLight).call(this)))._direction=new o,t._shadowCascadesMode=e.ShadowCascadesMode.NoCascades,t._shadowTwoCascadeSplits=1/3,t._shadowFourCascadeSplits=new o(1/15,.2,7/15),t._lightType=e.LightType.Directional,t}return _inherits(DirectionLight,t),_createClass(DirectionLight,[{key:"_addToLightQueue",value:function(){this._scene._directionLights.add(this)}},{key:"_removeFromLightQueue",value:function(){this._scene._directionLights.remove(this)}},{key:"shadowCascadesMode",get:function(){return this._shadowCascadesMode},set:function(e){this._shadowCascadesMode=e}},{key:"shadowTwoCascadeSplits",get:function(){return this._shadowTwoCascadeSplits},set:function(e){this._shadowTwoCascadeSplits=e}},{key:"shadowFourCascadeSplits",get:function(){return this._shadowFourCascadeSplits},set:function(e){if(e.x>e.y||e.y>e.z||e.z>1)throw"DiretionLight:Invalid value.";e.cloneTo(this._shadowFourCascadeSplits)}}]),DirectionLight}(ft),Sn=function(t){function PointLight(){var t;return _classCallCheck(this,PointLight),(t=_possibleConstructorReturn(this,_getPrototypeOf(PointLight).call(this)))._range=6,t._lightType=e.LightType.Point,t}return _inherits(PointLight,t),_createClass(PointLight,[{key:"_addToLightQueue",value:function(){this._scene._pointLights.add(this)}},{key:"_removeFromLightQueue",value:function(){this._scene._pointLights.remove(this)}},{key:"_parse",value:function(e,t){_get(_getPrototypeOf(PointLight.prototype),"_parse",this).call(this,e,t),this.range=e.range}},{key:"range",get:function(){return this._range},set:function(e){this._range=e}}]),PointLight}(ft),vn=function(t){function SpotLight(){var t;return _classCallCheck(this,SpotLight),(t=_possibleConstructorReturn(this,_getPrototypeOf(SpotLight).call(this)))._spotAngle=30,t._range=10,t._direction=new o,t._lightType=e.LightType.Spot,t}return _inherits(SpotLight,t),_createClass(SpotLight,[{key:"_addToLightQueue",value:function(){this._scene._spotLights.add(this)}},{key:"_removeFromLightQueue",value:function(){this._scene._spotLights.remove(this)}},{key:"_parse",value:function(e,t){_get(_getPrototypeOf(SpotLight.prototype),"_parse",this).call(this,e,t),this.range=e.range,this.spotAngle=e.spotAngle}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=Math.max(Math.min(e,179),0)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e}}]),SpotLight}(ft),Rn=function(e){function SimpleSkinnedMeshRenderer(e){var t;return _classCallCheck(this,SimpleSkinnedMeshRenderer),(t=_possibleConstructorReturn(this,_getPrototypeOf(SimpleSkinnedMeshRenderer).call(this,e)))._simpleAnimatorParams=new i,t._simpleAnimatorOffset=new n,t._shaderValues.addDefine($r.SHADERDEFINE_SIMPLEBONE),t._shaderValues.addDefine($r.SHADERDEFINE_BONE),t}return _inherits(SimpleSkinnedMeshRenderer,e),_createClass(SimpleSkinnedMeshRenderer,[{key:"_computeAnimatorParamsData",value:function(){this._cacheMesh&&(this._bonesNums=this.bones.length,this._simpleAnimatorParams.x=this._simpleAnimatorOffset.x,this._simpleAnimatorParams.y=Math.round(this._simpleAnimatorOffset.y)*this._bonesNums*4)}},{key:"_createRenderElement",value:function(){return new wt}},{key:"_setCacheAnimator",value:function(e){this._cacheAnimator=e,this._shaderValues.addDefine($r.SHADERDEFINE_SIMPLEBONE)}},{key:"_onMeshChange",value:function(e){_get(_getPrototypeOf(SimpleSkinnedMeshRenderer.prototype),"_onMeshChange",this).call(this,e),this._cacheMesh=e}},{key:"_renderUpdate",value:function(e,t){var r=e.renderElement;switch(r.renderType){case kt.RENDERTYPE_NORMAL:if(this._cacheAnimator){var n=this._cacheAnimator.owner.transform.worldMatrix;this._shaderValues.setMatrix4x4(et.WORLDMATRIX,n)}else this._shaderValues.setMatrix4x4(et.WORLDMATRIX,t.worldMatrix);this._computeAnimatorParamsData(),this._shaderValues.setVector(SimpleSkinnedMeshRenderer.SIMPLE_SIMPLEANIMATORPARAMS,this._simpleAnimatorParams);break;case kt.RENDERTYPE_INSTANCEBATCH:var i=bt.instance.instanceWorldMatrixData,a=r.instanceBatchElementList,o=a.elements,s=a.length;if(this._cacheAnimator)for(var l=0;l<s;l++){var u=o[l].render._cacheAnimator.owner._transform.worldMatrix;i.set(u.elements,16*l)}else for(l=0;l<s;l++)i.set(o[l]._transform.worldMatrix.elements,16*l);var c=bt.instance.instanceWorldMatrixBuffer;c.orphanStorage(),c.setData(i.buffer,0,0,16*s*4),this._shaderValues.addDefine(_r.SHADERDEFINE_GPU_INSTANCE);var h=bt.instance.instanceSimpleAnimatorData;if(this._cacheAnimator)for(l=0;l<s;l++){var _=o[l].render;_._computeAnimatorParamsData();var d=_._simpleAnimatorParams,f=4*l;h[f]=d.x,h[f+1]=d.y}else for(l=0;l<s;l++)h[f]=0,h[f+1]=0;var m=bt.instance.instanceSimpleAnimatorBuffer;m.orphanStorage(),m.setData(h.buffer,0,0,4*s*4)}}},{key:"_renderUpdateWithCamera",value:function(e,t){var r=e.projectionViewMatrix;if(r){var n=e.renderElement;switch(n.renderType){case kt.RENDERTYPE_NORMAL:if(this._cacheAnimator){var i=this._cacheAnimator.owner._transform.worldMatrix;c.multiply(r,i,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(et.MVPMATRIX,this._projectionViewWorldMatrix)}else c.multiply(r,t.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(et.MVPMATRIX,this._projectionViewWorldMatrix);break;case kt.RENDERTYPE_INSTANCEBATCH:var a=bt.instance.instanceMVPMatrixData,o=n.instanceBatchElementList,s=o.elements,l=o.length;if(this._cacheAnimator)for(var u=0;u<l;u++){var h=s[u].render._cacheAnimator.owner._transform.worldMatrix;P.mulMatrixByArray(r.elements,0,h.elements,0,a,16*u)}else for(u=0;u<l;u++){h=s[u]._transform.worldMatrix;P.mulMatrixByArray(r.elements,0,h.elements,0,a,16*u)}var _=bt.instance.instanceMVPMatrixBuffer;_.orphanStorage(),_.setData(a.buffer,0,0,16*l*4)}}}},{key:"_destroy",value:function(){this._cacheRootBone&&!this._cacheRootBone.destroyed&&this._cacheRootBone.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._simpleAnimatorTexture&&this._simpleAnimatorTexture._removeReference(),this._simpleAnimatorTexture=null}},{key:"simpleAnimatorTexture",get:function(){return this._simpleAnimatorTexture},set:function(e){this._simpleAnimatorTexture=e,this._simpleAnimatorTextureSize=e.width,this._shaderValues.setTexture(SimpleSkinnedMeshRenderer.SIMPLE_SIMPLEANIMATORTEXTURE,e),e._addReference(),this._shaderValues.setNumber(SimpleSkinnedMeshRenderer.SIMPLE_SIMPLEANIMATORTEXTURESIZE,this._simpleAnimatorTextureSize)}},{key:"simpleAnimatorOffset",get:function(){return this._simpleAnimatorOffset},set:function(e){e.cloneTo(this._simpleAnimatorOffset)}}]),SimpleSkinnedMeshRenderer}(en),Cn=function(e){function SimpleSkinnedMeshSprite3D(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return _classCallCheck(this,SimpleSkinnedMeshSprite3D),(e=_possibleConstructorReturn(this,_getPrototypeOf(SimpleSkinnedMeshSprite3D).call(this,r)))._meshFilter=new fr(_assertThisInitialized(e)),e._render=new Rn(_assertThisInitialized(e)),t&&(e._meshFilter.sharedMesh=t),e}return _inherits(SimpleSkinnedMeshSprite3D,e),_createClass(SimpleSkinnedMeshSprite3D,[{key:"_parse",value:function(e,r){_get(_getPrototypeOf(SimpleSkinnedMeshSprite3D.prototype),"_parse",this).call(this,e,r);var n=this.simpleSkinnedMeshRenderer,a=e.lightmapIndex;null!=a&&(n.lightmapIndex=a);var s,l=e.lightmapScaleOffset;if(l&&(n.lightmapScaleOffset=new i(l[0],l[1],l[2],l[3])),null!=e.enableRender&&(n.enable=e.enableRender),null!=e.receiveShadows&&(n.receiveShadow=e.receiveShadows),null!=e.castShadow&&(n.castShadow=e.castShadow),s=e.meshPath){var u=t.Loader.getRes(s);u&&(this.meshFilter.sharedMesh=u)}var c=e.materials;if(c){var h=n.sharedMaterials,_=c.length;h.length=_;for(var d=0;d<_;d++)h[d]=t.Loader.getRes(c[d].path);n.sharedMaterials=h}var f=e.boundBox,m=f.min,T=f.max;if(n.localBounds.setMin(new o(m[0],m[1],m[2])),n.localBounds.setMax(new o(T[0],T[1],T[2])),r){var p=e.rootBone;n.rootBone=r[p];var g,E=e.bones;for(d=0,g=E.length;d<g;d++)n.bones.push(r[E[d]])}else e.rootBone&&n._setRootBone(e.rootBone);var y=e.animatorTexture;if(y){var S=t.Loader.getRes(y);n.simpleAnimatorTexture=S}}},{key:"_changeHierarchyAnimator",value:function(e){_get(_getPrototypeOf(SimpleSkinnedMeshSprite3D.prototype),"_changeHierarchyAnimator",this).call(this,e),this.simpleSkinnedMeshRenderer._setCacheAnimator(e)}},{key:"_cloneTo",value:function(e,t,r){var n=e;n.meshFilter.sharedMesh=this.meshFilter.sharedMesh;var i=this._render,a=n._render;a.enable=i.enable,a.sharedMaterials=i.sharedMaterials,a.castShadow=i.castShadow;var o=i.lightmapScaleOffset;o&&(a.lightmapScaleOffset=o.clone()),a.receiveShadow=i.receiveShadow,a.sortingFudge=i.sortingFudge,a._rootBone=i._rootBone;var s=i.bones,l=a.bones,u=s.length;l.length=u;var c=i.rootBone;if(c){var h=P._getHierarchyPath(t,c,SimpleSkinnedMeshSprite3D._tempArray0);a.rootBone=h?P._getNodeByHierarchyPath(r,h):c}for(var _=0;_<s.length;_++)h=P._getHierarchyPath(t,s[_],SimpleSkinnedMeshSprite3D._tempArray0),l[_]=h?P._getNodeByHierarchyPath(r,h):s[_];var d=i.localBounds;d&&d.cloneTo(a.localBounds),a.simpleAnimatorTexture=i.simpleAnimatorTexture,_get(_getPrototypeOf(SimpleSkinnedMeshSprite3D.prototype),"_cloneTo",this).call(this,e,t,r)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(SimpleSkinnedMeshSprite3D.prototype),"destroy",this).call(this,e),this._meshFilter.destroy())}},{key:"_create",value:function(){return new SimpleSkinnedMeshSprite3D}},{key:"meshFilter",get:function(){return this._meshFilter}},{key:"simpleSkinnedMeshRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){Rn.SIMPLE_SIMPLEANIMATORPARAMS=SimpleSkinnedMeshSprite3D.SIMPLE_SIMPLEANIMATORPARAMS,Rn.SIMPLE_SIMPLEANIMATORTEXTURE=SimpleSkinnedMeshSprite3D.SIMPLE_SIMPLEANIMATORTEXTURE,Rn.SIMPLE_SIMPLEANIMATORTEXTURESIZE=SimpleSkinnedMeshSprite3D.SIMPLE_SIMPLEANIMATORTEXTURESIZE}}]),SimpleSkinnedMeshSprite3D}(Ot);Cn._tempArray0=[],Cn.SIMPLE_SIMPLEANIMATORTEXTURE=ue.propertyNameToID("u_SimpleAnimatorTexture"),Cn.SIMPLE_SIMPLEANIMATORPARAMS=ue.propertyNameToID("u_SimpleAnimatorParams"),Cn.SIMPLE_SIMPLEANIMATORTEXTURESIZE=ue.propertyNameToID("u_SimpleAnimatorTextureSize");var Mn=function(){function Scene3DUtils(){_classCallCheck(this,Scene3DUtils)}return _createClass(Scene3DUtils,null,[{key:"_createSprite3DInstance",value:function(e,t,r){var n;switch(e.type){case"Scene3D":n=new tr;break;case"Sprite3D":n=new et;break;case"MeshSprite3D":n=new pr,r&&e.props.isStatic&&r.push(n);break;case"SkinnedMeshSprite3D":n=new tn;break;case"SimpleSkinnedMeshSprite3D":n=new Cn;break;case"ShuriKenParticle3D":n=new Jr;break;case"Camera":n=new pt;break;case"DirectionLight":n=new yn;break;case"PointLight":n=new Sn;break;case"SpotLight":n=new vn;break;case"TrailSprite3D":n=new cn;break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.")}var i=e.child;if(i)for(var a=0,o=i.length;a<o;a++){var s=Scene3DUtils._createSprite3DInstance(i[a],t,r);n.addChild(s)}return t[e.instanceID]=n,n}},{key:"_createComponentInstance",value:function(e,r,n){var i=r[e.instanceID];i._parse(e.props,r);var a=e.child;if(a)for(var o=0,s=a.length;o<s;o++)Scene3DUtils._createComponentInstance(a[o],r,n);var l=e.components;if(l)for(var u=0,c=l.length;u<c;u++){var h=l[u],_=t.ClassUtils.getRegClass(h.type);if(_)i.addComponent(_)._parse(h,n);else console.warn("Unkown component type.")}}},{key:"_createNodeByJson02",value:function(e,t){var r={},n={component:[],data:[]},i=Scene3DUtils._createSprite3DInstance(e,r,t);return Scene3DUtils._createComponentInstance(e,r,n),Scene3DUtils._createInteractInstance(n,r),i}},{key:"_createInteractInstance",value:function(e,t){for(var r=e.component,n=e.data,i=0,a=r.length;i<a;i++)r[i]._parseInteractive(n[i],t)}},{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var t,r=e.data,n=[];switch(e.version){case"LAYAHIERARCHY:02":t=Scene3DUtils._createNodeByJson02(r,n);break;default:t=Scene3DUtils._createNodeByJson(r,n)}return Bt.combine(t,n),t}},{key:"_parseScene",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var t,r=e.data,n=[];switch(e.version){case"LAYASCENE3D:02":t=Scene3DUtils._createNodeByJson02(r,n);break;default:t=Scene3DUtils._createNodeByJson(r,n)}return Bt.combine(null,n),t}},{key:"_createNodeByJson",value:function(e,r){var n;switch(e.type){case"Scene3D":n=new tr;break;case"Sprite3D":n=new et;break;case"MeshSprite3D":n=new pr,r&&e.props.isStatic&&r.push(n);break;case"SkinnedMeshSprite3D":n=new tn;break;case"ShuriKenParticle3D":n=new Jr;break;case"Camera":n=new pt;break;case"DirectionLight":n=new yn;break;case"PointLight":n=new Sn;break;case"SpotLight":n=new vn;break;case"TrailSprite3D":n=new cn;break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.")}var i=e.child;if(i)for(var a=0,o=i.length;a<o;a++){var s=Scene3DUtils._createNodeByJson(i[a],r);n.addChild(s)}var l=e.components;if(l)for(var u=0,c=l.length;u<c;u++){var h=l[u],_=t.ClassUtils.getRegClass(h.type);if(_)n.addComponent(_)._parse(h);else console.warn("Unkown component type.")}return n._parse(e.props,null),n}}]),Scene3DUtils}(),Dn=function(){function LoadModelV04(){_classCallCheck(this,LoadModelV04)}return _createClass(LoadModelV04,null,[{key:"parse",value:function(e,t,r,n){LoadModelV04._mesh=r,LoadModelV04._subMeshes=n,LoadModelV04._version=t,LoadModelV04._readData=e,LoadModelV04.READ_DATA(),LoadModelV04.READ_BLOCK(),LoadModelV04.READ_STRINGS();for(var i=0,a=LoadModelV04._BLOCK.count;i<a;i++){LoadModelV04._readData.pos=LoadModelV04._BLOCK.blockStarts[i];var o=LoadModelV04._readData.getUint16(),s=LoadModelV04._strings[o],l=LoadModelV04["READ_"+s];if(null==l)throw new Error("model file err,no this function:"+o+" "+s);l.call(null)}LoadModelV04._strings.length=0,LoadModelV04._readData=null,LoadModelV04._version=null,LoadModelV04._mesh=null,LoadModelV04._subMeshes=null}},{key:"_readString",value:function(){return LoadModelV04._strings[LoadModelV04._readData.getUint16()]}},{key:"READ_DATA",value:function(){LoadModelV04._DATA.offset=LoadModelV04._readData.getUint32(),LoadModelV04._DATA.size=LoadModelV04._readData.getUint32()}},{key:"READ_BLOCK",value:function(){for(var e=LoadModelV04._BLOCK.count=LoadModelV04._readData.getUint16(),t=LoadModelV04._BLOCK.blockStarts=[],r=LoadModelV04._BLOCK.blockLengths=[],n=0;n<e;n++)t.push(LoadModelV04._readData.getUint32()),r.push(LoadModelV04._readData.getUint32())}},{key:"READ_STRINGS",value:function(){var e=LoadModelV04._readData.getUint32(),t=LoadModelV04._readData.getUint16(),r=LoadModelV04._readData.pos;LoadModelV04._readData.pos=e+LoadModelV04._DATA.offset;for(var n=0;n<t;n++)LoadModelV04._strings[n]=LoadModelV04._readData.readUTFString();LoadModelV04._readData.pos=r}},{key:"READ_MESH",value:function(){var r,n=t.LayaGL.instance,i=(LoadModelV04._readString(),LoadModelV04._readData.__getBuffer()),a=0,o=LoadModelV04._readData.getInt16(),s=LoadModelV04._DATA.offset;for(r=0;r<o;r++){var l,u=s+LoadModelV04._readData.getUint32(),h=LoadModelV04._readData.getUint32(),_=i.slice(u,u+h),d=new Float32Array(_),f=LoadModelV04._readString();switch(LoadModelV04._version){case"LAYAMODEL:0301":case"LAYAMODEL:0400":l=Qe.getVertexDeclaration(f);break;case"LAYAMODEL:0401":l=Qe.getVertexDeclaration(f,!1);break;default:throw new Error("LoadModelV03: unknown version.")}if(!l)throw new Error("LoadModelV03: unknown vertexDeclaration.");var m=new qe(4*d.length,n.STATIC_DRAW,!0);m.vertexDeclaration=l,m.setData(d.buffer),LoadModelV04._mesh._vertexBuffer=m,LoadModelV04._mesh._vertexCount+=m._byteLength/l.vertexStride,a+=4*d.length}var T=s+LoadModelV04._readData.getUint32(),p=LoadModelV04._readData.getUint32(),g=new Uint16Array(i.slice(T,T+p)),E=new Xe(e.IndexFormat.UInt16,p/2,n.STATIC_DRAW,!0);E.setData(g),LoadModelV04._mesh._indexBuffer=E,a+=2*E.indexCount,LoadModelV04._mesh._setBuffer(LoadModelV04._mesh._vertexBuffer,E),LoadModelV04._mesh._setCPUMemory(a),LoadModelV04._mesh._setGPUMemory(a);var y=LoadModelV04._mesh._boneNames=[],S=LoadModelV04._readData.getUint16();for(y.length=S,r=0;r<S;r++)y[r]=LoadModelV04._strings[LoadModelV04._readData.getUint16()];LoadModelV04._readData.pos+=8;var v=LoadModelV04._readData.getUint32(),R=LoadModelV04._readData.getUint32(),C=new Float32Array(i.slice(s+v,s+v+R)),M=C.length,D=LoadModelV04._mesh._inverseBindPosesBuffer=new ArrayBuffer(4*M);for(LoadModelV04._mesh._inverseBindPoses=[],LoadModelV04._mesh._instanceBufferStateType=0!=M?Tn.MESH_INSTANCEBUFFER_TYPE_SIMPLEANIMATOR:Tn.MESH_INSTANCEBUFFER_TYPE_NORMAL,LoadModelV04._mesh._setInstanceBuffer(LoadModelV04._mesh._instanceBufferStateType),r=0;r<M;r+=16){var x=new c(C[r+0],C[r+1],C[r+2],C[r+3],C[r+4],C[r+5],C[r+6],C[r+7],C[r+8],C[r+9],C[r+10],C[r+11],C[r+12],C[r+13],C[r+14],C[r+15],new Float32Array(D,4*r,16));LoadModelV04._mesh._inverseBindPoses[r/16]=x}return!0}},{key:"READ_SUBMESH",value:function(){var e=LoadModelV04._readData.__getBuffer(),t=new fn(LoadModelV04._mesh);LoadModelV04._readData.getInt16(),LoadModelV04._readData.getUint32(),LoadModelV04._readData.getUint32();var r=LoadModelV04._readData.getUint32(),n=LoadModelV04._readData.getUint32(),i=LoadModelV04._mesh._indexBuffer;t._indexBuffer=i,t._setIndexRange(r,n);var a=LoadModelV04._mesh._vertexBuffer;t._vertexBuffer=a;var o=LoadModelV04._DATA.offset,s=t._subIndexBufferStart,l=t._subIndexBufferCount,u=t._boneIndicesList,c=LoadModelV04._readData.getUint16();s.length=c,l.length=c,u.length=c;var h=LoadModelV04._mesh._skinnedMatrixCaches,_=LoadModelV04._subMeshes.length;h.length=LoadModelV04._mesh._inverseBindPoses.length;for(var d=0;d<c;d++){s[d]=LoadModelV04._readData.getUint32(),l[d]=LoadModelV04._readData.getUint32();for(var f=LoadModelV04._readData.getUint32(),m=LoadModelV04._readData.getUint32(),T=u[d]=new Uint16Array(e.slice(o+f,o+f+m)),p=T.length,g=0;g<p;g++){var E=T[g];h[E]||(h[E]=new mn(_,d,g))}}return LoadModelV04._subMeshes.push(t),!0}}]),LoadModelV04}();Dn._BLOCK={count:0},Dn._DATA={offset:0,size:0},Dn._strings=[];var xn=function(){function LoadModelV05(){_classCallCheck(this,LoadModelV05)}return _createClass(LoadModelV05,null,[{key:"parse",value:function(e,t,r,n){LoadModelV05._mesh=r,LoadModelV05._subMeshes=n,LoadModelV05._version=t,LoadModelV05._readData=e,LoadModelV05.READ_DATA(),LoadModelV05.READ_BLOCK(),LoadModelV05.READ_STRINGS();for(var i=0,a=LoadModelV05._BLOCK.count;i<a;i++){LoadModelV05._readData.pos=LoadModelV05._BLOCK.blockStarts[i];var o=LoadModelV05._readData.getUint16(),s=LoadModelV05._strings[o],l=LoadModelV05["READ_"+s];if(null==l)throw new Error("model file err,no this function:"+o+" "+s);l.call(null)}LoadModelV05._strings.length=0,LoadModelV05._readData=null,LoadModelV05._version=null,LoadModelV05._mesh=null,LoadModelV05._subMeshes=null}},{key:"_readString",value:function(){return LoadModelV05._strings[LoadModelV05._readData.getUint16()]}},{key:"READ_DATA",value:function(){LoadModelV05._DATA.offset=LoadModelV05._readData.getUint32(),LoadModelV05._DATA.size=LoadModelV05._readData.getUint32()}},{key:"READ_BLOCK",value:function(){for(var e=LoadModelV05._BLOCK.count=LoadModelV05._readData.getUint16(),t=LoadModelV05._BLOCK.blockStarts=[],r=LoadModelV05._BLOCK.blockLengths=[],n=0;n<e;n++)t.push(LoadModelV05._readData.getUint32()),r.push(LoadModelV05._readData.getUint32())}},{key:"READ_STRINGS",value:function(){var e=LoadModelV05._readData.getUint32(),t=LoadModelV05._readData.getUint16(),r=LoadModelV05._readData.pos;LoadModelV05._readData.pos=e+LoadModelV05._DATA.offset;for(var n=0;n<t;n++)LoadModelV05._strings[n]=LoadModelV05._readData.readUTFString();LoadModelV05._readData.pos=r}},{key:"READ_MESH",value:function(){var r,n=t.LayaGL.instance,i=0,a=(LoadModelV05._readString(),LoadModelV05._readData),o=a.__getBuffer(),s=a.getInt16(),l=LoadModelV05._DATA.offset;for(r=0;r<s;r++){var u,h,_,d=l+a.getUint32(),f=a.getUint32(),m=LoadModelV05._readString(),T=Qe.getVertexDeclaration(m,!1),p=T.vertexStride,g=m.split(","),E=g.length,y=LoadModelV05._mesh;switch(LoadModelV05._version){case"LAYAMODEL:05":case"LAYAMODEL:0501":u=o.slice(d,d+f*p),h=new Float32Array(u),_=new Uint8Array(u);break;case"LAYAMODEL:COMPRESSION_05":case"LAYAMODEL:COMPRESSION_0501":u=new ArrayBuffer(p*f),h=new Float32Array(u),_=new Uint8Array(u);var S=a.pos;a.pos=d;for(var v=0;v<f;v++)for(var R,C=v*p,M=0;M<E;M++)switch(g[M]){case"POSITION":h[R=C/4]=W.convertToNumber(a.getUint16()),h[R+1]=W.convertToNumber(a.getUint16()),h[R+2]=W.convertToNumber(a.getUint16()),C+=12;break;case"NORMAL":h[R=C/4]=a.getUint8()/127.5-1,h[R+1]=a.getUint8()/127.5-1,h[R+2]=a.getUint8()/127.5-1,C+=12;break;case"COLOR":h[R=C/4]=a.getUint8()/255,h[R+1]=a.getUint8()/255,h[R+2]=a.getUint8()/255,h[R+3]=a.getUint8()/255,C+=16;break;case"UV":case"UV1":h[R=C/4]=W.convertToNumber(a.getUint16()),h[R+1]=W.convertToNumber(a.getUint16()),C+=8;break;case"BLENDWEIGHT":h[R=C/4]=a.getUint8()/255,h[R+1]=a.getUint8()/255,h[R+2]=a.getUint8()/255,h[R+3]=a.getUint8()/255,C+=16;break;case"BLENDINDICES":_[C]=a.getUint8(),_[C+1]=a.getUint8(),_[C+2]=a.getUint8(),_[C+3]=a.getUint8(),C+=4;break;case"TANGENT":h[R=C/4]=a.getUint8()/127.5-1,h[R+1]=a.getUint8()/127.5-1,h[R+2]=a.getUint8()/127.5-1,h[R+3]=a.getUint8()/127.5-1,C+=16}a.pos=S}var D=new qe(u.byteLength,n.STATIC_DRAW,!0);D.vertexDeclaration=T,D.setData(u);f=D._byteLength/T.vertexStride;y._indexFormat=f>65535?e.IndexFormat.UInt32:e.IndexFormat.UInt16,y._vertexBuffer=D,y._vertexCount+=f,i+=4*h.length}var x,A=l+a.getUint32(),I=a.getUint32();x=y.indexFormat==e.IndexFormat.UInt32?new Uint32Array(o.slice(A,A+I)):new Uint16Array(o.slice(A,A+I));var L=new Xe(y.indexFormat,x.length,n.STATIC_DRAW,!0);if(L.setData(x),y._indexBuffer=L,y._setBuffer(y._vertexBuffer,L),i+=2*L.indexCount,y._setCPUMemory(i),y._setGPUMemory(i),"LAYAMODEL:0501"==LoadModelV05._version||"LAYAMODEL:COMPRESSION_0501"==LoadModelV05._version){var P=y.bounds,O=P.getMin(),N=P.getMax();O.setValue(a.getFloat32(),a.getFloat32(),a.getFloat32()),N.setValue(a.getFloat32(),a.getFloat32(),a.getFloat32()),P.setMin(O),P.setMax(N),y.bounds=P}var b=y._boneNames=[],k=a.getUint16();for(b.length=k,r=0;r<k;r++)b[r]=LoadModelV05._strings[a.getUint16()];var w=a.getUint32(),B=a.getUint32(),V=new Float32Array(o.slice(l+w,l+w+B)),F=V.length,U=y._inverseBindPosesBuffer=new ArrayBuffer(4*F);for(y._inverseBindPoses=[],y._instanceBufferStateType=0!=F?Tn.MESH_INSTANCEBUFFER_TYPE_SIMPLEANIMATOR:Tn.MESH_INSTANCEBUFFER_TYPE_NORMAL,y._setInstanceBuffer(y._instanceBufferStateType),r=0;r<F;r+=16){var G=new c(V[r+0],V[r+1],V[r+2],V[r+3],V[r+4],V[r+5],V[r+6],V[r+7],V[r+8],V[r+9],V[r+10],V[r+11],V[r+12],V[r+13],V[r+14],V[r+15],new Float32Array(U,4*r,16));y._inverseBindPoses[r/16]=G}return!0}},{key:"READ_SUBMESH",value:function(){var e=LoadModelV05._readData,t=e.__getBuffer(),r=new fn(LoadModelV05._mesh);e.getInt16();var n=e.getUint32(),i=e.getUint32(),a=LoadModelV05._mesh._indexBuffer;r._indexBuffer=a,r._setIndexRange(n,i);var o=LoadModelV05._mesh._vertexBuffer;r._vertexBuffer=o;var s=LoadModelV05._DATA.offset,l=r._subIndexBufferStart,u=r._subIndexBufferCount,c=r._boneIndicesList,h=e.getUint16();l.length=h,u.length=h,c.length=h;var _=LoadModelV05._mesh._skinnedMatrixCaches,d=LoadModelV05._subMeshes.length;_.length=LoadModelV05._mesh._inverseBindPoses.length;for(var f=0;f<h;f++){l[f]=e.getUint32(),u[f]=e.getUint32();for(var m=e.getUint32(),T=e.getUint32(),p=c[f]=new Uint16Array(t.slice(s+m,s+m+T)),g=0,E=p.length;g<E;g++){var y=p[g];_[y]||(_[y]=new mn(d,f,g))}}return LoadModelV05._subMeshes.push(r),!0}}]),LoadModelV05}();xn._BLOCK={count:0},xn._DATA={offset:0,size:0},xn._strings=[];var An=function(){function MeshReader(){_classCallCheck(this,MeshReader)}return _createClass(MeshReader,null,[{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var t=new Tn;return MeshReader.read(e,t,t._subMeshes),t}},{key:"read",value:function(e,r,n){var i=new t.Byte(e);i.pos=0;var a=i.readUTFString();switch(a){case"LAYAMODEL:0301":case"LAYAMODEL:0400":case"LAYAMODEL:0401":Dn.parse(i,a,r,n);break;case"LAYAMODEL:05":case"LAYAMODEL:COMPRESSION_05":case"LAYAMODEL:0501":case"LAYAMODEL:COMPRESSION_0501":xn.parse(i,a,r,n);break;default:throw new Error("MeshReader: unknown mesh version.")}r._setSubMeshes(n),"LAYAMODEL:0501"!=a&&"LAYAMODEL:COMPRESSION_0501"!=a&&r.calculateBounds()}}]),MeshReader}(),In=function(e){function SkyPanoramicMaterial(){var e;_classCallCheck(this,SkyPanoramicMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(SkyPanoramicMaterial).call(this)))._exposure=1,e._textureDecodeFormat=t.TextureDecodeFormat.Normal,e._textureHDRParams=new i(1,0,0,1),e.setShaderName("SkyPanoramic");var r=e._shaderValues;return r.setVector(SkyPanoramicMaterial.TINTCOLOR,new i(.5,.5,.5,.5)),r.setNumber(SkyPanoramicMaterial.ROTATION,0),r.setVector(SkyPanoramicMaterial.TEXTURE_HDR_PARAMS,e._textureHDRParams),e}return _inherits(SkyPanoramicMaterial,e),_createClass(SkyPanoramicMaterial,[{key:"tintColor",get:function(){return this._shaderValues.getVector(SkyPanoramicMaterial.TINTCOLOR)},set:function(e){this._shaderValues.setVector(SkyPanoramicMaterial.TINTCOLOR,e)}},{key:"exposure",get:function(){return this._exposure},set:function(e){this._exposure!==e&&(this._exposure=e,this._textureDecodeFormat==t.TextureDecodeFormat.RGBM?this._textureHDRParams.x=e*t.BaseTexture._rgbmRange:this._textureHDRParams.x=e)}},{key:"rotation",get:function(){return this._shaderValues.getNumber(SkyPanoramicMaterial.ROTATION)},set:function(e){this._shaderValues.setNumber(SkyPanoramicMaterial.ROTATION,e)}},{key:"panoramicTexture",get:function(){return this._shaderValues.getTexture(SkyPanoramicMaterial.TEXTURE)},set:function(e){this._shaderValues.setTexture(SkyPanoramicMaterial.TEXTURE,e)}},{key:"panoramicTextureDecodeFormat",get:function(){return this._textureDecodeFormat},set:function(e){this._textureDecodeFormat!==e&&(this._textureDecodeFormat=e,e==t.TextureDecodeFormat.RGBM?this._textureHDRParams.x=this._exposure*t.BaseTexture._rgbmRange:this._textureHDRParams.x=this._exposure)}}],[{key:"__init__",value:function(){var e={a_Position:Qe.MESH_POSITION0},t={u_TintColor:ue.PERIOD_MATERIAL,u_TextureHDRParams:ue.PERIOD_MATERIAL,u_Rotation:ue.PERIOD_MATERIAL,u_Texture:ue.PERIOD_MATERIAL,u_ViewProjection:ue.PERIOD_CAMERA},r=ue.add("SkyPanoramic"),n=new ir(e,t);r.addSubShader(n),n.addShaderPass('#include "Lighting.glsl";\r\n\r\n#define PI 3.14159265359\r\n\r\nattribute vec4 a_Position;\r\n\r\nuniform mat4 u_ViewProjection;\r\nuniform float u_Rotation;\r\n\r\nvarying vec3 v_Texcoord;\r\nvarying vec2 v_Image180ScaleAndCutoff;\r\nvarying vec4 v_Layout3DScaleAndOffset;\r\n\r\nvec4 rotateAroundYInDegrees (vec4 vertex, float degrees)\r\n{\r\n\tfloat angle = degrees * PI / 180.0;\r\n\tfloat sina=sin(angle);\r\n\tfloat cosa=cos(angle);\r\n\tmat2 m = mat2(cosa, -sina, sina, cosa);\r\n\treturn vec4(m*vertex.xz, vertex.yw).xzyw;\r\n}\r\n\r\n\t\t\r\nvoid main()\r\n{\r\n\tvec4 position = rotateAroundYInDegrees(a_Position, u_Rotation);\r\n\tgl_Position = u_ViewProjection*position;\r\n\r\n\tv_Texcoord=vec3(-a_Position.x,-a_Position.y,a_Position.z);// NOTE: -a_Position.x convert coords system\r\n\r\n\t// Calculate constant horizontal scale and cutoff for 180 (vs 360) image type\r\n\tv_Image180ScaleAndCutoff = vec2(1.0, 1.0);// 360 degree mode\r\n\r\n\t// Calculate constant scale and offset for 3D layouts\r\n\tv_Layout3DScaleAndOffset = vec4(0,0,1,1);\r\n}\r\n','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#define PI 3.14159265359\r\n#include "Lighting.glsl";\r\n\r\nuniform sampler2D u_Texture;\r\nuniform vec4 u_TextureHDRParams;\r\nuniform vec4 u_TintColor;\r\n\r\nvarying vec3 v_Texcoord;\r\nvarying vec2 v_Image180ScaleAndCutoff;\r\nvarying vec4 v_Layout3DScaleAndOffset;\r\n\r\nvec2 ToRadialCoords(vec3 coords)\r\n{\r\n\tvec3 normalizedCoords = normalize(coords);\r\n\tfloat latitude = acos(normalizedCoords.y);\r\n\tfloat longitude = atan(normalizedCoords.z,normalizedCoords.x);\r\n\tvec2 sphereCoords = vec2(longitude, latitude) * vec2(0.5/PI, 1.0/PI);\r\n\treturn vec2(0.5,1.0) - sphereCoords;\r\n}\r\n\r\n\r\nvoid main()\r\n{\t\r\n\tvec2 tc = ToRadialCoords(v_Texcoord);\r\n\tif (tc.x > v_Image180ScaleAndCutoff.y)\r\n\t\tgl_FragColor=vec4(0,0,0,1);\r\n\ttc.x = mod(tc.x*v_Image180ScaleAndCutoff.x, 1.0);\r\n\ttc = (tc + v_Layout3DScaleAndOffset.xy) * v_Layout3DScaleAndOffset.zw;\r\n\r\n\tmediump vec4 tex = texture2D (u_Texture, tc);\r\n\tmediump vec3 c = decodeHDR (tex, u_TextureHDRParams.x);\r\n\tc = c * u_TintColor.rgb * 2.0;//Gamma Space is 2.0,linear space is 4.59479380\r\n\tgl_FragColor=vec4(c, 1.0);\r\n}\r\n\r\n')}}]),SkyPanoramicMaterial}(me);In.TINTCOLOR=ue.propertyNameToID("u_TintColor"),In.EXPOSURE=ue.propertyNameToID("u_Exposure"),In.ROTATION=ue.propertyNameToID("u_Rotation"),In.TEXTURE=ue.propertyNameToID("u_Texture"),In.TEXTURE_HDR_PARAMS=ue.propertyNameToID("u_TextureHDRParams");var Ln=function(e){function ConstraintComponent(e){var t;_classCallCheck(this,ConstraintComponent),(t=_possibleConstructorReturn(this,_getPrototypeOf(ConstraintComponent).call(this)))._anchor=new o,t._connectAnchor=new o,t._feedbackEnabled=!1,t._getJointFeedBack=!1,t._currentForce=new o,t._currentTorque=new o,t._constraintType=e;var r=k._bullet;return t._btframATrans=r.btTransform_create(),t._btframBTrans=r.btTransform_create(),r.btTransform_setIdentity(t._btframATrans),r.btTransform_setIdentity(t._btframBTrans),t._btframAPos=r.btVector3_create(0,0,0),t._btframBPos=r.btVector3_create(0,0,0),r.btTransform_setOrigin(t._btframATrans,t._btframAPos),r.btTransform_setOrigin(t._btframBTrans,t._btframBPos),t._breakForce=-1,t._breakTorque=-1,t}return _inherits(ConstraintComponent,e),_createClass(ConstraintComponent,[{key:"setOverrideNumSolverIterations",value:function(e){k._bullet.btTypedConstraint_setOverrideNumSolverIterations(this._btConstraint,e)}},{key:"setConstraintEnabled",value:function(e){k._bullet.btTypedConstraint_setEnabled(this._btConstraint,e)}},{key:"_onEnable",value:function(){_get(_getPrototypeOf(ConstraintComponent.prototype),"_onEnable",this).call(this),this.enabled=!0}},{key:"_onDisable",value:function(){_get(_getPrototypeOf(ConstraintComponent.prototype),"_onDisable",this).call(this),this.enabled=!1}},{key:"setFrames",value:function(){var e=k._bullet;e.btVector3_setValue(this._btframAPos,-this._anchor.x,this.anchor.y,this.anchor.z),e.btVector3_setValue(this._btframBPos,-this._connectAnchor.x,this._connectAnchor.y,this._connectAnchor.z),e.btTransform_setOrigin(this._btframATrans,this._btframAPos),e.btTransform_setOrigin(this._btframBTrans,this._btframBPos)}},{key:"_addToSimulation",value:function(){}},{key:"_removeFromSimulation",value:function(){}},{key:"_createConstraint",value:function(){}},{key:"setConnectRigidBody",value:function(e,t){var r=e&&!!(e._simulation&&e._enabled&&e.colliderShape),n=t&&!!(t._simulation&&t._enabled&&t.colliderShape);if(!r||!n)throw"ownerRigid or connectRigidBody is not in Simulation";e==this._ownBody&&t==this._connectedBody||(!(!this.enabled||!this._simulation)&&this._removeFromSimulation(),this._ownBody=e,this._connectedBody=t,this._ownBody.constaintRigidbodyA=this,this._connectedBody.constaintRigidbodyB=this,this._createConstraint())}},{key:"getcurrentForce",value:function(e){if(!this._btJointFeedBackObj)throw"this Constraint is not simulation";var t=k._bullet,r=t.btJointFeedback_getAppliedForceBodyA(this._btJointFeedBackObj);e.setValue(t.btVector3_x(r),t.btVector3_y(r),t.btVector3_z(r))}},{key:"getcurrentTorque",value:function(e){if(!this._btJointFeedBackObj)throw"this Constraint is not simulation";var t=k._bullet,r=t.btJointFeedback_getAppliedTorqueBodyA(this._btJointFeedBackObj);e.setValue(t.btVector3_x(r),t.btVector3_y(r),t.btVector3_z(r))}},{key:"_onDestroy",value:function(){var e=k._bullet;this._removeFromSimulation(),this._btConstraint&&this._btJointFeedBackObj&&this._simulation&&(e.btTypedConstraint_destroy(this._btConstraint),e.btJointFeedback_destroy(this._btJointFeedBackObj),this._btJointFeedBackObj=null,this._btConstraint=null),_get(_getPrototypeOf(ConstraintComponent.prototype),"_onDisable",this).call(this)}},{key:"_isBreakConstrained",value:function(){if(this._getJointFeedBack=!1,-1==this.breakForce&&-1==this.breakTorque)return!1;this._getFeedBackInfo();var e=-1!=this._breakForce&&o.scalarLength(this._currentForce)>this._breakForce,t=-1!=this._breakTorque&&o.scalarLength(this._currentTorque)>this._breakTorque;return!(!e&&!t)&&(this._breakConstrained(),!0)}},{key:"_parse",value:function(e){this._anchor.fromArray(e.anchor),this._connectAnchor.fromArray(e.connectAnchor),this.setFrames()}},{key:"_getFeedBackInfo",value:function(){var e=k._bullet,t=e.btJointFeedback_getAppliedForceBodyA(this._btJointFeedBackObj),r=e.btJointFeedback_getAppliedTorqueBodyA(this._btJointFeedBackObj);this._currentTorque.setValue(e.btVector3_x(r),e.btVector3_y(r),e.btVector3_z(r)),this._currentForce.setValue(e.btVector3_x(t),e.btVector3_y(t),e.btVector3_z(t)),this._getJointFeedBack=!0}},{key:"_breakConstrained",value:function(){this.ownBody.constaintRigidbodyA=null,this.connectedBody.constaintRigidbodyB=null,this.destroy()}},{key:"enabled",get:function(){return _get(_getPrototypeOf(ConstraintComponent.prototype),"enabled",this)},set:function(e){_set(_getPrototypeOf(ConstraintComponent.prototype),"enabled",e,this,!0)}},{key:"appliedImpulse",get:function(){return this._feedbackEnabled||(this._btConstraint.EnableFeedback(!0),this._feedbackEnabled=!0),this._btConstraint.AppliedImpulse}},{key:"connectedBody",set:function(e){this._connectedBody=e,e.constaintRigidbodyB=this},get:function(){return this._connectedBody}},{key:"ownBody",get:function(){return this._ownBody},set:function(e){this._ownBody=e,e.constaintRigidbodyA=this}},{key:"currentForce",get:function(){return this._getJointFeedBack||this._getFeedBackInfo(),this._currentForce}},{key:"currentTorque",get:function(){return this._getJointFeedBack||this._getFeedBackInfo(),this._currentTorque}},{key:"breakForce",get:function(){return this._breakForce},set:function(e){this._breakForce=e}},{key:"breakTorque",get:function(){return this._breakTorque},set:function(e){this._breakTorque=e}},{key:"anchor",set:function(e){e.cloneTo(this._anchor),this.setFrames()},get:function(){return this._anchor}},{key:"connectAnchor",set:function(e){e.cloneTo(this._connectAnchor),this.setFrames()},get:function(){return this._connectAnchor}}]),ConstraintComponent}(t.Component);Ln.CONSTRAINT_POINT2POINT_CONSTRAINT_TYPE=3,Ln.CONSTRAINT_HINGE_CONSTRAINT_TYPE=4,Ln.CONSTRAINT_CONETWIST_CONSTRAINT_TYPE=5,Ln.CONSTRAINT_D6_CONSTRAINT_TYPE=6,Ln.CONSTRAINT_SLIDER_CONSTRAINT_TYPE=7,Ln.CONSTRAINT_CONTACT_CONSTRAINT_TYPE=8,Ln.CONSTRAINT_D6_SPRING_CONSTRAINT_TYPE=9,Ln.CONSTRAINT_GEAR_CONSTRAINT_TYPE=10,Ln.CONSTRAINT_FIXED_CONSTRAINT_TYPE=11,Ln.CONSTRAINT_MAX_CONSTRAINT_TYPE=12,Ln.CONSTRAINT_CONSTRAINT_ERP=1,Ln.CONSTRAINT_CONSTRAINT_STOP_ERP=2,Ln.CONSTRAINT_CONSTRAINT_CFM=3,Ln.CONSTRAINT_CONSTRAINT_STOP_CFM=4,Ln.tempForceV3=new o;var Pn=function(e){function FixedConstraint(){var e;return _classCallCheck(this,FixedConstraint),(e=_possibleConstructorReturn(this,_getPrototypeOf(FixedConstraint).call(this,Ln.CONSTRAINT_FIXED_CONSTRAINT_TYPE))).breakForce=-1,e.breakTorque=-1,e}return _inherits(FixedConstraint,e),_createClass(FixedConstraint,[{key:"_addToSimulation",value:function(){this._simulation&&this._simulation.addConstraint(this,this.enabled)}},{key:"_removeFromSimulation",value:function(){this._simulation.removeConstraint(this),this._simulation=null}},{key:"_createConstraint",value:function(){if(this.ownBody&&this.ownBody._simulation&&this.connectedBody&&this.connectedBody._simulation){var e=k._bullet;this._btConstraint=e.btFixedConstraint_create(this.ownBody.btColliderObject,this._btframATrans,this.connectedBody.btColliderObject,this._btframBTrans),this._btJointFeedBackObj=e.btJointFeedback_create(this._btConstraint),e.btTypedConstraint_setJointFeedback(this._btConstraint,this._btJointFeedBackObj),this._simulation=this.owner._scene.physicsSimulation,this._addToSimulation(),k._bullet.btTypedConstraint_setEnabled(this._btConstraint,!0)}}},{key:"_onAdded",value:function(){_get(_getPrototypeOf(FixedConstraint.prototype),"_onAdded",this).call(this)}},{key:"_onEnable",value:function(){this._btConstraint&&(_get(_getPrototypeOf(FixedConstraint.prototype),"_onEnable",this).call(this),this._btConstraint&&k._bullet.btTypedConstraint_setEnabled(this._btConstraint,!0))}},{key:"_onDisable",value:function(){_get(_getPrototypeOf(FixedConstraint.prototype),"_onDisable",this).call(this),this.connectedBody||this._removeFromSimulation(),this._btConstraint&&k._bullet.btTypedConstraint_setEnabled(this._btConstraint,!1)}},{key:"_onDestroy",value:function(){_get(_getPrototypeOf(FixedConstraint.prototype),"_onDestroy",this).call(this)}},{key:"_parse",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;_get(_getPrototypeOf(FixedConstraint.prototype),"_parse",this).call(this,e),-1!=e.rigidbodyID&&-1!=e.connectRigidbodyID&&(t.component.push(this),t.data.push(e)),null!=e.breakForce&&(this.breakForce=e.breakForce),null!=e.breakTorque&&(this.breakTorque=e.breakTorque)}},{key:"_parseInteractive",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=t[e.rigidbodyID],n=r.getComponent(b),i=t[e.connectRigidbodyID],a=i.getComponent(b);this.ownBody=n,this.connectedBody=a}},{key:"_cloneTo",value:function(e){}}]),FixedConstraint}(Ln),On=function(e){function ConfigurableConstraint(){var e;_classCallCheck(this,ConfigurableConstraint),(e=_possibleConstructorReturn(this,_getPrototypeOf(ConfigurableConstraint).call(this,Ln.CONSTRAINT_D6_SPRING_CONSTRAINT_TYPE)))._axis=new o,e._secondaryAxis=new o,e._minLinearLimit=new o,e._maxLinearLimit=new o,e._minAngularLimit=new o,e._maxAngularLimit=new o,e._linearLimitSpring=new o,e._angularLimitSpring=new o,e._linearBounce=new o,e._angularBounce=new o,e._linearDamp=new o,e._angularDamp=new o,e._xMotion=0,e._yMotion=0,e._zMotion=0,e._angularXMotion=0,e._angularYMotion=0,e._angularZMotion=0;var t=k._bullet;return e._btAxis=t.btVector3_create(-1,0,0),e._btSecondaryAxis=t.btVector3_create(0,1,0),e}return _inherits(ConfigurableConstraint,e),_createClass(ConfigurableConstraint,[{key:"setAxis",value:function(e,t){if(this._btConstraint){var r=k._bullet;this._axis.setValue(e.x,e.y,e.y),this._secondaryAxis.setValue(t.x,t.y,t.z),this._btAxis=r.btVector3_setValue(-e.x,e.y,e.z),this._btSecondaryAxis=r.btVector3_setValue(-t.x,t.y,t.z),r.btGeneric6DofSpring2Constraint_setAxis(this._btConstraint,this._btAxis,this._btSecondaryAxis)}}},{key:"setLimit",value:function(e,t,r,n){if(this._btConstraint){var i=k._bullet;switch(t){case ConfigurableConstraint.CONFIG_MOTION_TYPE_LOCKED:i.btGeneric6DofSpring2Constraint_setLimit(this._btConstraint,e,0,0);break;case ConfigurableConstraint.CONFIG_MOTION_TYPE_LIMITED:r<n&&i.btGeneric6DofSpring2Constraint_setLimit(this._btConstraint,e,r,n);break;case ConfigurableConstraint.CONFIG_MOTION_TYPE_FREE:i.btGeneric6DofSpring2Constraint_setLimit(this._btConstraint,e,1,0);break;default:throw"No Type of Axis Motion"}}}},{key:"setSpring",value:function(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this._btConstraint){var n=k._bullet,i=t>0;n.btGeneric6DofSpring2Constraint_enableSpring(this._btConstraint,e,i),i&&n.btGeneric6DofSpring2Constraint_setStiffness(this._btConstraint,e,t,r)}}},{key:"setBounce",value:function(e,t){this._btConstraint&&(t=t<=0?0:t,k._bullet.btGeneric6DofSpring2Constraint_setBounce(this._btConstraint,e,t))}},{key:"setDamping",value:function(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this._btConstraint){var n=k._bullet;t=t<=0?0:t,n.btGeneric6DofSpring2Constraint_setDamping(this._btConstraint,e,t,r)}}},{key:"setEquilibriumPoint",value:function(e,t){k._bullet.btGeneric6DofSpring2Constraint_setEquilibriumPoint(this._btConstraint,e,t)}},{key:"enableMotor",value:function(e,t){k._bullet.btGeneric6DofSpring2Constraint_enableMotor(this._btConstraint,e,t)}},{key:"setServo",value:function(e,t){k._bullet.btGeneric6DofSpring2Constraint_setServo(this._btConstraint,e,t)}},{key:"setTargetVelocity",value:function(e,t){k._bullet.btGeneric6DofSpring2Constraint_setTargetVelocity(this._btConstraint,e,t)}},{key:"setTargetPosition",value:function(e,t){k._bullet.btGeneric6DofSpring2Constraint_setServoTarget(this._btConstraint,e,t)}},{key:"setMaxMotorForce",value:function(e,t){k._bullet.btGeneric6DofSpring2Constraint_setMaxMotorForce(this._btConstraint,e,t)}},{key:"setParam",value:function(e,t,r){k._bullet.btTypedConstraint_setParam(this._btConstraint,e,t,r)}},{key:"setFrames",value:function(){_get(_getPrototypeOf(ConfigurableConstraint.prototype),"setFrames",this).call(this);var e=k._bullet;this._btConstraint&&e.btGeneric6DofSpring2Constraint_setFrames(this._btConstraint,this._btframATrans,this._btframBTrans)}},{key:"_addToSimulation",value:function(){this._simulation&&this._simulation.addConstraint(this,this.enabled)}},{key:"_removeFromSimulation",value:function(){this._simulation.removeConstraint(this),this._simulation=null}},{key:"_createConstraint",value:function(){var e=k._bullet;this._btConstraint=e.btGeneric6DofSpring2Constraint_create(this.ownBody.btColliderObject,this._btframAPos,this.connectedBody.btColliderObject,this._btframBPos,ConfigurableConstraint.RO_XYZ),this._btJointFeedBackObj=e.btJointFeedback_create(this._btConstraint),e.btTypedConstraint_setJointFeedback(this._btConstraint,this._btJointFeedBackObj),this._simulation=this.owner._scene.physicsSimulation,this._initAllConstraintInfo(),this._addToSimulation(),k._bullet.btTypedConstraint_setEnabled(this._btConstraint,!0)}},{key:"_initAllConstraintInfo",value:function(){this.setLimit(ConfigurableConstraint.MOTION_LINEAR_INDEX_X,this._xMotion,-this._maxLinearLimit.x,-this._minLinearLimit.x),this.setLimit(ConfigurableConstraint.MOTION_LINEAR_INDEX_Y,this._yMotion,this._minLinearLimit.y,this._maxLinearLimit.y),this.setLimit(ConfigurableConstraint.MOTION_LINEAR_INDEX_Z,this._zMotion,this._minLinearLimit.z,this._maxLinearLimit.z),this.setLimit(ConfigurableConstraint.MOTION_ANGULAR_INDEX_X,this._angularXMotion,-this._maxAngularLimit.x,-this._minAngularLimit.x),this.setLimit(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Y,this._angularYMotion,this._minAngularLimit.y,this._maxAngularLimit.y),this.setLimit(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Z,this._angularZMotion,this._minAngularLimit.z,this._maxAngularLimit.z),this.setSpring(ConfigurableConstraint.MOTION_LINEAR_INDEX_X,this._linearLimitSpring.x),this.setSpring(ConfigurableConstraint.MOTION_LINEAR_INDEX_Y,this._linearLimitSpring.y),this.setSpring(ConfigurableConstraint.MOTION_LINEAR_INDEX_Z,this._linearLimitSpring.z),this.setSpring(ConfigurableConstraint.MOTION_ANGULAR_INDEX_X,this._angularLimitSpring.x),this.setSpring(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Y,this._angularLimitSpring.y),this.setSpring(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Z,this._angularLimitSpring.z),this.setBounce(ConfigurableConstraint.MOTION_LINEAR_INDEX_X,this._linearBounce.x),this.setBounce(ConfigurableConstraint.MOTION_LINEAR_INDEX_Y,this._linearBounce.y),this.setBounce(ConfigurableConstraint.MOTION_LINEAR_INDEX_Z,this._linearBounce.z),this.setBounce(ConfigurableConstraint.MOTION_ANGULAR_INDEX_X,this._angularBounce.x),this.setBounce(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Y,this._angularBounce.y),this.setBounce(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Z,this._angularBounce.z),this.setDamping(ConfigurableConstraint.MOTION_LINEAR_INDEX_X,this._linearDamp.x),this.setDamping(ConfigurableConstraint.MOTION_LINEAR_INDEX_Y,this._linearDamp.y),this.setDamping(ConfigurableConstraint.MOTION_LINEAR_INDEX_Z,this._linearDamp.z),this.setDamping(ConfigurableConstraint.MOTION_ANGULAR_INDEX_X,this._angularDamp.x),this.setDamping(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Y,this._angularDamp.y),this.setDamping(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Z,this._angularDamp.z),this.setFrames(),this.setEquilibriumPoint(0,0)}},{key:"_onAdded",value:function(){_get(_getPrototypeOf(ConfigurableConstraint.prototype),"_onAdded",this).call(this)}},{key:"_onEnable",value:function(){this._btConstraint&&(_get(_getPrototypeOf(ConfigurableConstraint.prototype),"_onEnable",this).call(this),this._btConstraint&&k._bullet.btTypedConstraint_setEnabled(this._btConstraint,!0))}},{key:"_onDisable",value:function(){_get(_getPrototypeOf(ConfigurableConstraint.prototype),"_onDisable",this).call(this),this.connectedBody||this._removeFromSimulation(),this._btConstraint&&k._bullet.btTypedConstraint_setEnabled(this._btConstraint,!1)}},{key:"_parse",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;_get(_getPrototypeOf(ConfigurableConstraint.prototype),"_parse",this).call(this,e),this._axis.fromArray(e.axis),this._secondaryAxis.fromArray(e.secondaryAxis);var r=e.linearLimit;this._minLinearLimit.setValue(-r,-r,-r),this._maxLinearLimit.setValue(r,r,r);var n=e.linearLimitSpring;this._linearLimitSpring.setValue(n,n,n);var i=e.linearLimitDamper;this._linearDamp.setValue(i,i,i);var a=e.linearLimitBounciness;this._linearBounce.setValue(a,a,a);var o=e.lowAngularXLimit,s=e.highAngularXLimit,l=e.angularYLimit,u=e.angularZLimit;this._minAngularLimit.setValue(o,-l,-u),this._maxAngularLimit.setValue(s,l,u);var c=e.highAngularXLimitBounciness,h=e.angularYLimitBounciness,_=e.angularZLimitBounciness;this._angularBounce.setValue(c,h,_);var d=e.angularXLimitSpring,f=e.angularYZLimitSpring;this._angularLimitSpring.setValue(d,f,f);var m=e.angularXLimitDamper,T=e.angularYZLimitDamper;this._angularDamp.setValue(m,T,T),this.XMotion=e.xMotion,this.YMotion=e.yMotion,this.ZMotion=e.zMotion,this.angularXMotion=e.angularXMotion,this.angularYMotion=e.angularYMotion,this.angularZMotion=e.angularZMotion,-1!=e.rigidbodyID&&-1!=e.connectRigidbodyID&&(t.component.push(this),t.data.push(e)),null!=e.breakForce&&(this.breakForce=e.breakForce),null!=e.breakTorque&&(this.breakTorque=e.breakTorque)}},{key:"_parseInteractive",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=t[e.rigidbodyID],n=r.getComponent(b),i=t[e.connectRigidbodyID],a=i.getComponent(b);this.ownBody=n,this.connectedBody=a}},{key:"_onDestroy",value:function(){_get(_getPrototypeOf(ConfigurableConstraint.prototype),"_onDestroy",this).call(this)}},{key:"_cloneTo",value:function(e){}},{key:"axis",get:function(){return this._axis}},{key:"secondaryAxis",get:function(){return this._secondaryAxis}},{key:"maxAngularLimit",set:function(e){e.cloneTo(this._maxAngularLimit)},get:function(){return this._maxAngularLimit}},{key:"minAngularLimit",set:function(e){e.cloneTo(this._minAngularLimit)},get:function(){return this._minAngularLimit}},{key:"maxLinearLimit",set:function(e){e.cloneTo(this._maxLinearLimit)},get:function(){return this._maxLinearLimit}},{key:"minLinearLimit",set:function(e){e.cloneTo(this._minLinearLimit)},get:function(){return this._minLinearLimit}},{key:"XMotion",set:function(e){this._xMotion!=e&&(this._xMotion=e,this.setLimit(ConfigurableConstraint.MOTION_LINEAR_INDEX_X,e,-this._maxLinearLimit.x,-this._minLinearLimit.x))},get:function(){return this._xMotion}},{key:"YMotion",set:function(e){this._yMotion!=e&&(this._yMotion=e,this.setLimit(ConfigurableConstraint.MOTION_LINEAR_INDEX_Y,e,this._minLinearLimit.y,this._maxLinearLimit.y))},get:function(){return this._yMotion}},{key:"ZMotion",set:function(e){this._zMotion!=e&&(this._zMotion=e,this.setLimit(ConfigurableConstraint.MOTION_LINEAR_INDEX_Z,e,this._minLinearLimit.z,this._maxLinearLimit.z))},get:function(){return this._zMotion}},{key:"angularXMotion",set:function(e){this._angularXMotion!=e&&(this._angularXMotion=e,this.setLimit(ConfigurableConstraint.MOTION_ANGULAR_INDEX_X,e,-this._maxAngularLimit.x,-this._minAngularLimit.x))},get:function(){return this._angularXMotion}},{key:"angularYMotion",set:function(e){this._angularYMotion!=e&&(this._angularYMotion=e,this.setLimit(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Y,e,this._minAngularLimit.y,this._maxAngularLimit.y))},get:function(){return this._angularYMotion}},{key:"angularZMotion",set:function(e){this._angularZMotion!=e&&(this._angularZMotion=e,this.setLimit(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Z,e,this._minAngularLimit.z,this._maxAngularLimit.z))},get:function(){return this._angularZMotion}},{key:"linearLimitSpring",set:function(e){o.equals(this._linearLimitSpring,e)||(e.cloneTo(this._linearLimitSpring),this.setSpring(ConfigurableConstraint.MOTION_LINEAR_INDEX_X,e.x),this.setSpring(ConfigurableConstraint.MOTION_LINEAR_INDEX_Y,e.y),this.setSpring(ConfigurableConstraint.MOTION_LINEAR_INDEX_Z,e.z))},get:function(){return this._linearLimitSpring}},{key:"angularLimitSpring",set:function(e){o.equals(this._angularLimitSpring,e)||(e.cloneTo(this._angularLimitSpring),this.setSpring(ConfigurableConstraint.MOTION_ANGULAR_INDEX_X,e.x),this.setSpring(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Y,e.y),this.setSpring(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Z,e.z))},get:function(){return this._angularLimitSpring}},{key:"linearBounce",set:function(e){o.equals(this._linearBounce,e)||(e.cloneTo(this._linearBounce),this.setBounce(ConfigurableConstraint.MOTION_LINEAR_INDEX_X,e.x),this.setBounce(ConfigurableConstraint.MOTION_LINEAR_INDEX_Y,e.y),this.setBounce(ConfigurableConstraint.MOTION_LINEAR_INDEX_Z,e.z))},get:function(){return this._linearBounce}},{key:"angularBounce",set:function(e){o.equals(this._angularBounce,e)||(e.cloneTo(this._angularBounce),this.setBounce(ConfigurableConstraint.MOTION_ANGULAR_INDEX_X,e.x),this.setBounce(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Y,e.y),this.setBounce(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Z,e.z))},get:function(){return this._angularBounce}},{key:"linearDamp",set:function(e){o.equals(this._linearDamp,e)||(e.cloneTo(this._linearDamp),this.setDamping(ConfigurableConstraint.MOTION_LINEAR_INDEX_X,e.x),this.setDamping(ConfigurableConstraint.MOTION_LINEAR_INDEX_Y,e.y),this.setDamping(ConfigurableConstraint.MOTION_LINEAR_INDEX_Z,e.z))},get:function(){return this._linearDamp}},{key:"angularDamp",set:function(e){o.equals(this._angularDamp,e)||(e.cloneTo(this._angularDamp),this.setDamping(ConfigurableConstraint.MOTION_ANGULAR_INDEX_X,e.x),this.setDamping(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Y,e.y),this.setDamping(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Z,e.z))},get:function(){return this._angularDamp}},{key:"anchor",set:function(e){e.cloneTo(this._anchor),this.setFrames()},get:function(){return this._anchor}},{key:"connectAnchor",set:function(e){e.cloneTo(this._connectAnchor),this.setFrames()},get:function(){return this._connectAnchor}}]),ConfigurableConstraint}(Ln);On.CONFIG_MOTION_TYPE_LOCKED=0,On.CONFIG_MOTION_TYPE_LIMITED=1,On.CONFIG_MOTION_TYPE_FREE=2,On.MOTION_LINEAR_INDEX_X=0,On.MOTION_LINEAR_INDEX_Y=1,On.MOTION_LINEAR_INDEX_Z=2,On.MOTION_ANGULAR_INDEX_X=3,On.MOTION_ANGULAR_INDEX_Y=4,On.MOTION_ANGULAR_INDEX_Z=5,On.RO_XYZ=0,On.RO_XZY=1,On.RO_YXZ=2,On.RO_YZX=3,On.RO_ZXY=4,On.RO_ZYX=5;var Nn=function(){function Laya3D(){_classCallCheck(this,Laya3D)}return _createClass(Laya3D,null,[{key:"_cancelLoadByUrl",value:function(e){t.Laya.loader.cancelLoadByUrl(e),Laya3D._innerFirstLevelLoaderManager.cancelLoadByUrl(e),Laya3D._innerSecondLevelLoaderManager.cancelLoadByUrl(e),Laya3D._innerThirdLevelLoaderManager.cancelLoadByUrl(e),Laya3D._innerFourthLevelLoaderManager.cancelLoadByUrl(e)}},{key:"_changeWebGLSize",value:function(e,r){t.WebGL.onStageResize(e,r),ne.clientWidth=e,ne.clientHeight=r}},{key:"__init__",value:function(r,n,i){if(t.Config.isAntialias=i.isAntialias,t.Config.isAlpha=i.isAlpha,t.Config.premultipliedAlpha=i.premultipliedAlpha,t.Config.isStencil=i.isStencil,t.WebGL.enable()){t.RunDriver.changeWebGLSize=Laya3D._changeWebGLSize,t.Render.is3DMode=!0,t.Laya.init(r,n),t.Render.supportWebGLPlusRendering||(t.LayaGL.instance=t.WebGLContext.mainContext,t.LayaGL.instance.createCommandEncoder=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:128,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:64,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return new t.CommandEncoder(this,e,r,n)}),i._multiLighting=i.enableMultiLight&&t.SystemUtils.supportTextureFormat(t.TextureFormat.R32G32B32A32),l.Shader3D=ue,l.Scene3D=tr,l.MeshRenderStaticBatchManager=Ft,l.MeshRenderDynamicBatchManager=Tr,l.SubMeshDynamicBatch=mr,l.Laya3D=Laya3D,l.Matrix4x4=c,l.Physics3D=k,l.ShadowLightType=e.ShadowLightType,Laya3D.enableNative3D(),i.isUseCannonPhysicsEngine&&k.__cannoninit__(),k.__bulletinit__(),Ye.__init__(),Qe.__init__(),Yr.__init__(),jr.__init__(),St.__init__(),on.__init__(),hn.__init__(),Lt.__init__(),bt.__init__(),mr.__init__(),En.__init__(),Tt.init(),ve.__init__(),sr.__init__(),ar.__init__(),In.__init__(),Tn.__init__(),pn.__init__(),et.__init__(),Ot.__init__(),pr.__init__(),tn.__init__(),Cn.__init__(),Jr.__init__(),cn.__init__(),he.__init__(),tr.__init__(),Ft.__init__(),me.__initDefine__(),Te.__initDefine__(),ge.__initDefine__(),ur.__initDefine__(),cr.__initDefine__(),rn.__initDefine__(),Ee.__initDefine__(),hr.__initDefine__(),Hr.__initDefine__(),Se.__initDefine__(),Dt.__initDefine__(),lr.__initDefine__(),at.__init__(),t.ClassUtils.regClass("Laya.SkyPanoramicMaterial",In),t.ClassUtils.regClass("Laya.EffectMaterial",Ee),t.ClassUtils.regClass("Laya.UnlitMaterial",cr),t.ClassUtils.regClass("Laya.BlinnPhongMaterial",ge),t.ClassUtils.regClass("Laya.SkyProceduralMaterial",ur),t.ClassUtils.regClass("Laya.PBRStandardMaterial",sr),t.ClassUtils.regClass("Laya.PBRSpecularMaterial",ar),t.ClassUtils.regClass("Laya.SkyBoxMaterial",lr),t.ClassUtils.regClass("Laya.WaterPrimaryMaterial",hr),t.ClassUtils.regClass("Laya.ExtendTerrainMaterial",Se),t.ClassUtils.regClass("Laya.ShurikenParticleMaterial",Hr),t.ClassUtils.regClass("Laya.TrailMaterial",rn),t.ClassUtils.regClass("Laya.PhysicsCollider",dn),t.ClassUtils.regClass("Laya.Rigidbody3D",b),t.ClassUtils.regClass("Laya.CharacterController",O),t.ClassUtils.regClass("Laya.Animator",te),t.ClassUtils.regClass("PhysicsCollider",dn),t.ClassUtils.regClass("CharacterController",O),t.ClassUtils.regClass("Animator",te),t.ClassUtils.regClass("Rigidbody3D",b),t.ClassUtils.regClass("FixedConstraint",Pn),t.ClassUtils.regClass("ConfigurableConstraint",On),Dt.defaultMaterial=new Dt,ge.defaultMaterial=new ge,Ee.defaultMaterial=new Ee,cr.defaultMaterial=new cr,Hr.defaultMaterial=new Hr,rn.defaultMaterial=new rn,ur.defaultMaterial=new ur,lr.defaultMaterial=new lr,hr.defaultMaterial=new hr,Dt.defaultMaterial.lock=!0,ge.defaultMaterial.lock=!0,Ee.defaultMaterial.lock=!0,cr.defaultMaterial.lock=!0,Hr.defaultMaterial.lock=!0,rn.defaultMaterial.lock=!0,ur.defaultMaterial.lock=!0,lr.defaultMaterial.lock=!0,hr.defaultMaterial.lock=!0,t.Texture2D.__init__(),Rt.__init__(),Je.__init__(),vt.__init__(),nt.__init__(),it.__init__(),Ie.__init__(),W.__init__();var a=t.LoaderManager.createMap;a.lh=[Laya3D.HIERARCHY,Mn._parse],a.ls=[Laya3D.HIERARCHY,Mn._parseScene],a.lm=[Laya3D.MESH,An._parse],a.lmat=[Laya3D.MATERIAL,me._parse],a.jpg=[Laya3D.TEXTURE2D,t.Texture2D._parse],a.jpeg=[Laya3D.TEXTURE2D,t.Texture2D._parse],a.bmp=[Laya3D.TEXTURE2D,t.Texture2D._parse],a.gif=[Laya3D.TEXTURE2D,t.Texture2D._parse],a.png=[Laya3D.TEXTURE2D,t.Texture2D._parse],a.dds=[Laya3D.TEXTURE2D,t.Texture2D._parse],a.ktx=[Laya3D.TEXTURE2D,t.Texture2D._parse],a.pvr=[Laya3D.TEXTURE2D,t.Texture2D._parse],a.lani=[Laya3D.ANIMATIONCLIP,j._parse],a.lav=[Laya3D.AVATAR,fe._parse],a.ltc=[Laya3D.TEXTURECUBE,Rt._parse],a.ltcb=[Laya3D.TEXTURECUBEBIN,Rt._parseBin],a["ltcb.ls"]=[Laya3D.TEXTURECUBEBIN,Rt._parseBin],a["lanit.ls"]=[Laya3D.TEXTURE2D,t.Texture2D._SimpleAnimatorTextureParse];var o=t.Loader.parserMap;o[Laya3D.HIERARCHY]=Laya3D._loadHierarchy,o[Laya3D.MESH]=Laya3D._loadMesh,o[Laya3D.MATERIAL]=Laya3D._loadMaterial,o[Laya3D.TEXTURECUBE]=Laya3D._loadTextureCube,o[Laya3D.TEXTURECUBEBIN]=Laya3D._loadTextureCubeBin,o[Laya3D.TEXTURE2D]=Laya3D._loadTexture2D,o[Laya3D.ANIMATIONCLIP]=Laya3D._loadAnimationClip,o[Laya3D.AVATAR]=Laya3D._loadAvatar,o[Laya3D.SIMPLEANIMATORBIN]=Laya3D._loadSimpleAnimator,Laya3D._innerFirstLevelLoaderManager.on(t.Event.ERROR,null,Laya3D._eventLoadManagerError),Laya3D._innerSecondLevelLoaderManager.on(t.Event.ERROR,null,Laya3D._eventLoadManagerError),Laya3D._innerThirdLevelLoaderManager.on(t.Event.ERROR,null,Laya3D._eventLoadManagerError),Laya3D._innerFourthLevelLoaderManager.on(t.Event.ERROR,null,Laya3D._eventLoadManagerError)}else alert("Laya3D init error,must support webGL!")}},{key:"enableNative3D",value:function(){var e=ce,r=Ce,n=en,i=fe,a=Ie;if(t.Render.supportWebGLPlusRendering&&(e.prototype._initData=e.prototype._initDataForNative,e.prototype.setBool=e.prototype.setBoolForNative,e.prototype.getBool=e.prototype.getBoolForNative,e.prototype.setInt=e.prototype.setIntForNative,e.prototype.getInt=e.prototype.getIntForNative,e.prototype.setNumber=e.prototype.setNumberForNative,e.prototype.getNumber=e.prototype.getNumberForNative,e.prototype.setVector=e.prototype.setVectorForNative,e.prototype.getVector=e.prototype.getVectorForNative,e.prototype.setVector2=e.prototype.setVector2ForNative,e.prototype.getVector2=e.prototype.getVector2ForNative,e.prototype.setVector3=e.prototype.setVector3ForNative,e.prototype.getVector3=e.prototype.getVector3ForNative,e.prototype.setQuaternion=e.prototype.setQuaternionForNative,e.prototype.getQuaternion=e.prototype.getQuaternionForNative,e.prototype.setMatrix4x4=e.prototype.setMatrix4x4ForNative,e.prototype.getMatrix4x4=e.prototype.getMatrix4x4ForNative,e.prototype.setBuffer=e.prototype.setBufferForNative,e.prototype.getBuffer=e.prototype.getBufferForNative,e.prototype.setTexture=e.prototype.setTextureForNative,e.prototype.getTexture=e.prototype.getTextureForNative,e.prototype.setAttribute=e.prototype.setAttributeForNative,e.prototype.getAttribute=e.prototype.getAttributeForNative,e.prototype.cloneTo=e.prototype.cloneToForNative,e.prototype.getData=e.prototype.getDataForNative,r.prototype._uniformMatrix2fv=r.prototype._uniformMatrix2fvForNative,r.prototype._uniformMatrix3fv=r.prototype._uniformMatrix3fvForNative,r.prototype._uniformMatrix4fv=r.prototype._uniformMatrix4fvForNative,t.LayaGLRunner.uploadShaderUniforms=t.LayaGLRunner.uploadShaderUniformsForNative),t.Render.supportWebGLPlusCulling&&(a.renderObjectCulling=Ie.renderObjectCullingNative),t.Render.supportWebGLPlusAnimation){i.prototype._cloneDatasToAnimator=i.prototype._cloneDatasToAnimatorNative;var o=j;o.prototype._evaluateClipDatasRealTime=o.prototype._evaluateClipDatasRealTimeForNative,n.prototype._computeSkinnedData=n.prototype._computeSkinnedDataForNative}}},{key:"formatRelativePath",value:function(e,t){var r;if(r=e+t,"."===t.charAt(0)){for(var n=r.split("/"),i=0,a=n.length;i<a;i++)if(".."==n[i]){var o=i-1;o>0&&".."!==n[o]&&(n.splice(o,2),i-=2)}r=n.join("/")}return r}},{key:"_endLoad",value:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(n)for(var i=0,a=n.length;i<a;i++){var o=t.Loader.getRes(n[i]);o&&o._removeReference()}e.endLoad(r)}},{key:"_eventLoadManagerError",value:function(e){t.Laya.loader.event(t.Event.ERROR,e)}},{key:"_addHierarchyInnerUrls",value:function(e,t,r,n,i,a){var o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,l=Laya3D.formatRelativePath(n,i);return r&&(l+=r),e.push({url:l,type:a,constructParams:o,propertyParams:s}),t.push(l),l}},{key:"_getSprite3DHierarchyInnerUrls",value:function(e,t,r,n,i,a,o,s){var l,u,c=e.props;switch(e.type){case"Scene3D":var h=c.lightmaps;for(l=0,u=h.length;l<u;l++){var _=h[l];if(_.path)_.path=Laya3D._addHierarchyInnerUrls(i,a,o,s,_.path,Laya3D.TEXTURE2D,_.constructParams,_.propertyParams);else{var d=_.color;d.path=Laya3D._addHierarchyInnerUrls(i,a,o,s,d.path,Laya3D.TEXTURE2D,d.constructParams,d.propertyParams);var f=_.direction;f&&(f.path=Laya3D._addHierarchyInnerUrls(i,a,o,s,f.path,Laya3D.TEXTURE2D,f.constructParams,f.propertyParams))}}var m=c.reflectionTexture;m&&(c.reflection=Laya3D._addHierarchyInnerUrls(n,a,o,s,m,Laya3D.TEXTURECUBE));var T=c.reflection;if(T&&(c.reflection=Laya3D._addHierarchyInnerUrls(i,a,o,s,T,Laya3D.TEXTURECUBEBIN)),c.sky){var p=c.sky.material;p&&(p.path=Laya3D._addHierarchyInnerUrls(r,a,o,s,p.path,Laya3D.MATERIAL))}break;case"Camera":var g=c.skyboxMaterial;g&&(g.path=Laya3D._addHierarchyInnerUrls(r,a,o,s,g.path,Laya3D.MATERIAL));break;case"TrailSprite3D":case"MeshSprite3D":case"SkinnedMeshSprite3D":case"SimpleSkinnedMeshSprite3D":var E=c.meshPath;E&&(c.meshPath=Laya3D._addHierarchyInnerUrls(t,a,o,s,E,Laya3D.MESH));var y=c.materials;if(y)for(l=0,u=y.length;l<u;l++)y[l].path=Laya3D._addHierarchyInnerUrls(r,a,o,s,y[l].path,Laya3D.MATERIAL);"SimpleSkinnedMeshSprite3D"==e.type&&c.animatorTexture&&(c.animatorTexture=Laya3D._addHierarchyInnerUrls(i,a,o,s,c.animatorTexture,Laya3D.SIMPLEANIMATORBIN));break;case"ShuriKenParticle3D":if(c.main){var S=c.renderer.resources,v=S.mesh,R=S.material;v&&(S.mesh=Laya3D._addHierarchyInnerUrls(t,a,o,s,v,Laya3D.MESH)),R&&(S.material=Laya3D._addHierarchyInnerUrls(r,a,o,s,R,Laya3D.MATERIAL))}else{var C=c.meshPath;C&&(c.meshPath=Laya3D._addHierarchyInnerUrls(t,a,o,s,C,Laya3D.MESH)),c.material.path=Laya3D._addHierarchyInnerUrls(r,a,o,s,c.material.path,Laya3D.MATERIAL)}break;case"Terrain":Laya3D._addHierarchyInnerUrls(i,a,o,s,c.dataPath,Laya3D.TERRAINRES)}var M=e.components;if(M)for(var D=0,x=M.length;D<x;D++){var A=M[D];switch(A.type){case"Animator":A.avatarPath;var I=A.avatar;I&&(I.path=Laya3D._addHierarchyInnerUrls(i,a,o,s,I.path,Laya3D.AVATAR));var L=A.clipPaths;if(L)for(l=0,u=L.length;l<u;l++)L[l]=Laya3D._addHierarchyInnerUrls(i,a,o,s,L[l],Laya3D.ANIMATIONCLIP);else{var P=A.layers;for(l=0;l<P.length;l++)for(var O=P[l].states,N=0,b=O.length;N<b;N++){var k=O[N].clipPath;k&&(O[N].clipPath=Laya3D._addHierarchyInnerUrls(i,a,o,s,k,Laya3D.ANIMATIONCLIP))}}break;case"PhysicsCollider":case"Rigidbody3D":case"CharacterController":var w=A.shapes;for(l=0;l<w.length;l++){var B=w[l];if("MeshColliderShape"===B.type)(v=B.mesh)&&(B.mesh=Laya3D._addHierarchyInnerUrls(t,a,o,s,v,Laya3D.MESH))}}}var V=e.child;for(l=0,u=V.length;l<u;l++)Laya3D._getSprite3DHierarchyInnerUrls(V[l],t,r,n,i,a,o,s)}},{key:"_loadHierarchy",value:function(e){e._originType=e.type,e.on(t.Event.LOADED,null,Laya3D._onHierarchylhLoaded,[e]),e.load(e.url,t.Loader.JSON,!1,null,!0)}},{key:"_onHierarchylhLoaded",value:function(e,r){var n=e.url,i=P.getURLVerion(n),a=t.URL.getPath(n),o=[],s=[],l=[],u=[],c=[];Laya3D._getSprite3DHierarchyInnerUrls(r.data,o,s,l,u,c,i,a);var h=o.length+s.length+u.length,_=h+1,d=1/_;if(Laya3D._onProcessChange(e,0,d,1),u.length>0){var f=h/_,m=t.Handler.create(null,Laya3D._onProcessChange,[e,d,f],!1);Laya3D._innerFourthLevelLoaderManager._create(u,!1,t.Handler.create(null,Laya3D._onHierarchyInnerForthLevResouLoaded,[e,m,r,c,o,s,l,d+f*u.length,f]),m,null,null,null,1,!0)}else Laya3D._onHierarchyInnerForthLevResouLoaded(e,null,r,c,o,s,l,d,f)}},{key:"_onHierarchyInnerForthLevResouLoaded",value:function(e,r,n,i,a,o,s,l,u){if(r&&r.recover(),s.length>0){var c=t.Handler.create(null,Laya3D._onProcessChange,[e,l,u],!1);Laya3D._innerThirdLevelLoaderManager._create(s,!1,t.Handler.create(null,Laya3D._onHierarchyInnerThirdLevResouLoaded,[e,c,n,i,a,o,l+u*o.length,u]),r,null,null,null,1,!0)}else Laya3D._onHierarchyInnerThirdLevResouLoaded(e,null,n,i,a,o,l,u)}},{key:"_onHierarchyInnerThirdLevResouLoaded",value:function(e,r,n,i,a,o,s,l){if(r&&r.recover(),o.length>0){var u=t.Handler.create(null,Laya3D._onProcessChange,[e,s,l],!1);Laya3D._innerSecondLevelLoaderManager._create(o,!1,t.Handler.create(null,Laya3D._onHierarchyInnerSecondLevResouLoaded,[e,u,n,i,a,s+l*o.length,l]),r,null,null,null,1,!0)}else Laya3D._onHierarchyInnerSecondLevResouLoaded(e,null,n,i,a,s,l)}},{key:"_onHierarchyInnerSecondLevResouLoaded",value:function(e,r,n,i,a,o,s){if(r&&r.recover(),a.length>0){var l=t.Handler.create(null,Laya3D._onProcessChange,[e,o,s],!1);Laya3D._innerFirstLevelLoaderManager._create(a,!1,t.Handler.create(null,Laya3D._onHierarchyInnerFirstLevResouLoaded,[e,l,n,i]),r,null,null,null,1,!0)}else Laya3D._onHierarchyInnerFirstLevResouLoaded(e,null,n,i)}},{key:"_onHierarchyInnerFirstLevResouLoaded",value:function(e,t,r,n){t&&t.recover(),e._cache=e._createCache;var i="Scene3D"===r.data.type?Mn._parseScene(r,e._propertyParams,e._constructParams):Mn._parse(r,e._propertyParams,e._constructParams);Laya3D._endLoad(e,i,n)}},{key:"_loadMesh",value:function(e){e.on(t.Event.LOADED,null,Laya3D._onMeshLmLoaded,[e]),e.load(e.url,t.Loader.BUFFER,!1,null,!0)}},{key:"_onMeshLmLoaded",value:function(e,t){e._cache=e._createCache;var r=An._parse(t,e._propertyParams,e._constructParams);Laya3D._endLoad(e,r)}},{key:"_loadMaterial",value:function(e){e.on(t.Event.LOADED,null,Laya3D._onMaterilLmatLoaded,[e]),e.load(e.url,t.Loader.JSON,!1,null,!0)}},{key:"_onMaterilLmatLoaded",value:function(e,r){var n,i=e.url,a=P.getURLVerion(i),o=t.URL.getPath(i),s=[],l=[];r.customProps;switch(r.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":var u,c,h=r.props.textures;if(h)for(u=0,c=h.length;u<c;u++){var _=h[u],d=_.path;d&&(n=Laya3D.formatRelativePath(o,d),a&&(n+=a),s.push({url:n,constructParams:_.constructParams,propertyParams:_.propertyParams}),l.push(n),_.path=n)}break;default:throw new Error("Laya3D:unkonwn version.")}var f=s.length,m=f+1,T=1/m;if(Laya3D._onProcessChange(e,0,T,1),f>0){var p=t.Handler.create(null,Laya3D._onProcessChange,[e,T,f/m],!1);Laya3D._innerFourthLevelLoaderManager._create(s,!1,t.Handler.create(null,Laya3D._onMateialTexturesLoaded,[e,p,r,l]),p,null,null,null,1,!0)}else Laya3D._onMateialTexturesLoaded(e,null,r,null)}},{key:"_onMateialTexturesLoaded",value:function(e,t,r,n){e._cache=e._createCache;var i=me._parse(r,e._propertyParams,e._constructParams);Laya3D._endLoad(e,i,n),t&&t.recover()}},{key:"_loadAvatar",value:function(e){e.on(t.Event.LOADED,null,(function(t){e._cache=e._createCache;var r=fe._parse(t,e._propertyParams,e._constructParams);Laya3D._endLoad(e,r)})),e.load(e.url,t.Loader.JSON,!1,null,!0)}},{key:"_loadSimpleAnimator",value:function(e){e.on(t.Event.LOADED,null,(function(r){e._cache=e._createCache;var n=t.Texture2D._SimpleAnimatorTextureParse(r,e._propertyParams,e._constructParams);Laya3D._endLoad(e,n)})),e.load(e.url,t.Loader.BUFFER,!1,null,!0)}},{key:"_loadAnimationClip",value:function(e){e.on(t.Event.LOADED,null,(function(t){e._cache=e._createCache;var r=j._parse(t,e._propertyParams,e._constructParams);Laya3D._endLoad(e,r)})),e.load(e.url,t.Loader.BUFFER,!1,null,!0)}},{key:"_loadTexture2D",value:function(e){var r,n=e.url,i=n.lastIndexOf(".")+1,a=n.indexOf("?"),o=-1==a?n.length:a;switch(n.substr(i,o-i)){case"jpg":case"jpeg":case"bmp":case"gif":case"png":r="nativeimage";break;case"dds":case"ktx":case"pvr":r=t.Loader.BUFFER}e.on(t.Event.LOADED,null,(function(r){e._cache=e._createCache;var n=t.Texture2D._parse(r,e._propertyParams,e._constructParams);Laya3D._endLoad(e,n)})),e.load(e.url,r,!1,null,!0)}},{key:"_loadTextureCube",value:function(e){e.on(t.Event.LOADED,null,Laya3D._onTextureCubeLtcLoaded,[e]),e.load(e.url,t.Loader.JSON,!1,null,!0)}},{key:"_loadTextureCubeBin",value:function(e){e.on(t.Event.LOADED,null,(function(r){e._cache=e._createCache;var n=new t.Byte(r);if("LAYATEXTURECUBE:0000"!==n.readUTFString())throw"Laya3D:unknow version.";var i=n.readUint8(),a=n.getUint8(),o=n.readUint16(),s=n.getUint8(),l=n.getUint8(),u=n.getUint8(),c=n.getUint8(),h=new Rt(o,i,a>1);h.filterMode=s,h.wrapModeU=l,h.wrapModeV=u,h.anisoLevel=c;for(var _=n.pos,d=o,f=0;f<a;f++){for(var m=new Array(6),T=d*d*h._getFormatByteCount(),p=0;p<6;p++)m[p]=new Uint8Array(r,_,T),_+=T;h.setSixSidePixels(m,f),d/=2}Laya3D._endLoad(e,h)})),e.load(e.url,t.Loader.BUFFER,!1,null,!0)}},{key:"_onTextureCubeLtcLoaded",value:function(e,r){var n=t.URL.getPath(e.url),i=[Laya3D.formatRelativePath(n,r.front),Laya3D.formatRelativePath(n,r.back),Laya3D.formatRelativePath(n,r.left),Laya3D.formatRelativePath(n,r.right),Laya3D.formatRelativePath(n,r.up),Laya3D.formatRelativePath(n,r.down)];Laya3D._onProcessChange(e,0,1/7,1);var a=t.Handler.create(null,Laya3D._onProcessChange,[e,1/7,6/7],!1);Laya3D._innerFourthLevelLoaderManager.load(i,t.Handler.create(null,Laya3D._onTextureCubeImagesLoaded,[e,i,a]),a,"nativeimage")}},{key:"_onTextureCubeImagesLoaded",value:function(e,r,n){for(var i=new Array(6),a=0;a<6;a++)i[a]=t.Loader.getRes(r[a]);e._cache=e._createCache;var o=Rt._parse(i,e._propertyParams,e._constructParams);for(n.recover(),a=0;a<6;a++)t.Loader.clearRes(r[a]);Laya3D._endLoad(e,o)}},{key:"_onProcessChange",value:function(e,r,n,i){(i=r+i*n)<1&&e.event(t.Event.PROGRESS,2*i/3+1/3)}},{key:"init",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(Laya3D._isInit)n&&n.run();else{Laya3D._isInit=!0,r&&r.cloneTo(w._config),r=w._config,Ie.debugFrustumCulling=r.debugFrustumCulling,Laya3D._editerEnvironment=r._editerEnvironment,tr.octreeCulling=r.octreeCulling,tr.octreeInitialSize=r.octreeInitialSize,tr.octreeInitialCenter=r.octreeInitialCenter,tr.octreeMinNodeSize=r.octreeMinNodeSize,tr.octreeLooseness=r.octreeLooseness;var i=window.Physics3D;null==i||r.isUseCannonPhysicsEngine?(k._enablePhysics=!1,Laya3D.__init__(e,t,r),n&&n.run()):(k._enablePhysics=!0,i(16*r.defaultPhysicsMemory,_n._interactive).then((function(){Laya3D.__init__(e,t,r),n&&n.run()})))}}},{key:"enablePhysics",get:function(){return k._enablePhysics}}]),Laya3D}();Nn.HIERARCHY="HIERARCHY",Nn.MESH="MESH",Nn.MATERIAL="MATERIAL",Nn.TEXTURE2D="TEXTURE2D",Nn.TEXTURECUBE="TEXTURECUBE",Nn.TEXTURECUBEBIN="TEXTURECUBEBIN",Nn.ANIMATIONCLIP="ANIMATIONCLIP",Nn.AVATAR="AVATAR",Nn.TERRAINHEIGHTDATA="TERRAINHEIGHTDATA",Nn.TERRAINRES="TERRAIN",Nn.SIMPLEANIMATORBIN="SIMPLEANIMATOR",Nn._innerFirstLevelLoaderManager=new t.LoaderManager,Nn._innerSecondLevelLoaderManager=new t.LoaderManager,Nn._innerThirdLevelLoaderManager=new t.LoaderManager,Nn._innerFourthLevelLoaderManager=new t.LoaderManager,Nn._isInit=!1,Nn._editerEnvironment=!1,Nn.physicsSettings=new yt,window.Laya3D=Nn;var bn=function(e){function CastShadowList(){return _classCallCheck(this,CastShadowList),_possibleConstructorReturn(this,_getPrototypeOf(CastShadowList).call(this))}return _inherits(CastShadowList,e),_createClass(CastShadowList,[{key:"add",value:function(e){if(-1!==e._indexInCastShadowList)throw"CastShadowList:element has  in  CastShadowList.";this._add(e),e._indexInCastShadowList=this.length++}},{key:"remove",value:function(e){var t=e._indexInCastShadowList;if(this.length--,t!==this.length){var r=this.elements[this.length];this.elements[t]=r,r._indexInCastShadowList=t}e._indexInCastShadowList=-1}}]),CastShadowList}(R),kn=function(){function AnimatorStateScript(){_classCallCheck(this,AnimatorStateScript)}return _createClass(AnimatorStateScript,[{key:"onStateEnter",value:function(){}},{key:"onStateUpdate",value:function(){}},{key:"onStateExit",value:function(){}}]),AnimatorStateScript}(),wn=function(e){function Script3D(){var e;return _classCallCheck(this,Script3D),(e=_possibleConstructorReturn(this,_getPrototypeOf(Script3D).apply(this,arguments)))._indexInPool=-1,e}return _inherits(Script3D,e),_createClass(Script3D,[{key:"_checkProcessTriggers",value:function(){var e=Script3D.prototype;return this.onTriggerEnter!==e.onTriggerEnter||(this.onTriggerStay!==e.onTriggerStay||this.onTriggerExit!==e.onTriggerExit)}},{key:"_checkProcessCollisions",value:function(){var e=Script3D.prototype;return this.onCollisionEnter!==e.onCollisionEnter||(this.onCollisionStay!==e.onCollisionStay||this.onCollisionExit!==e.onCollisionExit)}},{key:"_onAwake",value:function(){this.onAwake(),this.onStart!==Script3D.prototype.onStart&&t.Laya.startTimer.callLater(this,this.onStart)}},{key:"_onEnable",value:function(){this.owner._scene._addScript(this),this.onEnable()}},{key:"_onDisable",value:function(){this.owner._scene._removeScript(this),this.owner.offAllCaller(this),this.onDisable()}},{key:"_onDestroy",value:function(){var e=this.owner._scripts;e.splice(e.indexOf(this),1);var t=this.owner;t._needProcessTriggers=!1;for(var r=0,n=e.length;r<n;r++)if(e[r]._checkProcessTriggers()){t._needProcessTriggers=!0;break}for(t._needProcessCollisions=!1,r=0,n=e.length;r<n;r++)if(e[r]._checkProcessCollisions()){t._needProcessCollisions=!0;break}this.onDestroy()}},{key:"_isScript",value:function(){return!0}},{key:"_onAdded",value:function(){var e=this.owner,t=e._scripts;t||(e._scripts=t=[]),t.push(this),e._needProcessCollisions||(e._needProcessCollisions=this._checkProcessCollisions()),e._needProcessTriggers||(e._needProcessTriggers=this._checkProcessTriggers())}},{key:"onAwake",value:function(){}},{key:"onEnable",value:function(){}},{key:"onStart",value:function(){}},{key:"onTriggerEnter",value:function(e){}},{key:"onTriggerStay",value:function(e){}},{key:"onTriggerExit",value:function(e){}},{key:"onCollisionEnter",value:function(e){}},{key:"onCollisionStay",value:function(e){}},{key:"onCollisionExit",value:function(e){}},{key:"onJointBreak",value:function(){}},{key:"onMouseDown",value:function(){}},{key:"onMouseDrag",value:function(){}},{key:"onMouseClick",value:function(){}},{key:"onMouseUp",value:function(){}},{key:"onMouseEnter",value:function(){}},{key:"onMouseOver",value:function(){}},{key:"onMouseOut",value:function(){}},{key:"onUpdate",value:function(){}},{key:"onLateUpdate",value:function(){}},{key:"onPreRender",value:function(){}},{key:"onPostRender",value:function(){}},{key:"onDisable",value:function(){}},{key:"onDestroy",value:function(){}},{key:"isSingleton",get:function(){return!1}}]),Script3D}(t.Component),Bn=function(){function HeightMap(e,t,r,n){_classCallCheck(this,HeightMap),this._datas=[],this._w=e,this._h=t,this._minHeight=r,this._maxHeight=n}return _createClass(HeightMap,[{key:"_inBounds",value:function(e,t){return e>=0&&e<this._h&&t>=0&&t<this._w}},{key:"getHeight",value:function(e,t){return this._inBounds(e,t)?this._datas[e][t]:NaN}},{key:"width",get:function(){return this._w}},{key:"height",get:function(){return this._h}},{key:"maxHeight",get:function(){return this._maxHeight}},{key:"minHeight",get:function(){return this._minHeight}}],[{key:"creatFromMesh",value:function(e,t,r,n){for(var i=[],a=[],s=e.subMeshCount,l=0;l<s;l++){for(var u=e.getSubMesh(l),c=u._vertexBuffer,h=c.getFloat32Data(),_=[],d=0;d<h.length;d+=c.vertexDeclaration.vertexStride/4){var f=new o(h[d+0],h[d+1],h[d+2]);_.push(f)}i.push(_);var m=u._indexBuffer;a.push(m.getData())}var T=e.bounds,p=T.getMin().x,g=T.getMin().z,E=T.getMax().x,y=T.getMax().z,S=T.getMin().y,v=T.getMax().y,R=E-p,C=y-g,M=n.x=R/(t-1),D=n.y=C/(r-1),x=new HeightMap(t,r,S,v),A=HeightMap._tempRay,I=A.direction;I.x=0,I.y=-1,I.z=0;var L=v+.1;A.origin.y=L;for(var P=0;P<r;P++){var O=g+P*D;x._datas[P]=[];for(var N=0;N<t;N++){var b=p+N*M,k=A.origin;k.x=b,k.z=O;var w=HeightMap._getPosition(A,i,a);x._datas[P][N]=w===Number.MAX_VALUE?NaN:L-w}}return x}},{key:"createFromImage",value:function(e,t,r){for(var n=e.width,i=e.height,a=new HeightMap(n,i,t,r),o=(r-t)/254,s=e.getPixels(),l=0,u=0;u<i;u++)for(var c=a._datas[u]=[],h=0;h<n;h++){var _=s[l++],d=s[l++],f=s[l++],m=s[l++];c[h]=255==_&&255==d&&255==f&&255==m?NaN:(_+d+f)/3*o+t}return a}},{key:"_getPosition",value:function(e,t,r){for(var n=Number.MAX_VALUE,i=0;i<t.length;i++)for(var a=t[i],o=r[i],s=0;s<o.length;s+=3){var l=a[o[s+0]],u=a[o[s+1]],c=a[o[s+2]],h=ze.rayIntersectsTriangle(e,l,u,c);!isNaN(h)&&h<n&&(n=h)}return n}}]),HeightMap}();Bn._tempRay=new we(new o,new o);var Vn=function(e){function MeshTerrainSprite3D(e,t){var r,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return _classCallCheck(this,MeshTerrainSprite3D),(r=_possibleConstructorReturn(this,_getPrototypeOf(MeshTerrainSprite3D).call(this,e,i)))._heightMap=t,r._cellSize=new n,r}return _inherits(MeshTerrainSprite3D,e),_createClass(MeshTerrainSprite3D,[{key:"_disableRotation",value:function(){var e=this.transform.rotation;e.x=0,e.y=0,e.z=0,e.w=1,this.transform.rotation=e}},{key:"_getScaleX",value:function(){var e=this.transform.worldMatrix.elements,t=e[0],r=e[1],n=e[2];return Math.sqrt(t*t+r*r+n*n)}},{key:"_getScaleZ",value:function(){var e=this.transform.worldMatrix.elements,t=e[8],r=e[9],n=e[10];return Math.sqrt(t*t+r*r+n*n)}},{key:"_initCreateFromMesh",value:function(e,t){this._heightMap=Bn.creatFromMesh(this.meshFilter.sharedMesh,e,t,this._cellSize);var r=this.meshFilter.sharedMesh.bounds,n=r.getMin();r.getMax();this._minX=n.x,this._minZ=n.z}},{key:"_initCreateFromMeshHeightMap",value:function(e,t,r){var n=this.meshFilter.sharedMesh.bounds;this._heightMap=Bn.createFromImage(e,t,r),this._computeCellSize(n);var i=n.getMin();n.getMax();this._minX=i.x,this._minZ=i.z}},{key:"_computeCellSize",value:function(e){var t=e.getMin(),r=e.getMax(),n=t.x,i=t.z,a=r.x-n,o=r.z-i;this._cellSize.x=a/(this._heightMap.width-1),this._cellSize.y=o/(this._heightMap.height-1)}},{key:"_update",value:function(e){this._disableRotation()}},{key:"getHeight",value:function(e,t){MeshTerrainSprite3D._tempVector3.x=e,MeshTerrainSprite3D._tempVector3.y=0,MeshTerrainSprite3D._tempVector3.z=t,this._disableRotation();var r=this.transform.worldMatrix;r.invert(MeshTerrainSprite3D._tempMatrix4x4),o.transformCoordinate(MeshTerrainSprite3D._tempVector3,MeshTerrainSprite3D._tempMatrix4x4,MeshTerrainSprite3D._tempVector3),e=MeshTerrainSprite3D._tempVector3.x,t=MeshTerrainSprite3D._tempVector3.z;var n=(e-this._minX)/this._cellSize.x,i=(t-this._minZ)/this._cellSize.y,a=Math.floor(i),s=Math.floor(n),l=n-s,u=i-a,c=r.elements,h=c[4],_=c[5],d=c[6],f=Math.sqrt(h*h+_*_+d*d),m=c[13],T=this._heightMap.getHeight(a,s+1),p=this._heightMap.getHeight(a+1,s);if(isNaN(T)||isNaN(p))return NaN;if(l+u<=1){var g=this._heightMap.getHeight(a,s);return isNaN(g)?NaN:(g+l*(T-g)+u*(p-g))*f+m}var E=this._heightMap.getHeight(a+1,s+1);return isNaN(E)?NaN:(E+(1-l)*(p-E)+(1-u)*(T-E))*f+m}},{key:"minX",get:function(){var e=this.transform.worldMatrix.elements;return this._minX*this._getScaleX()+e[12]}},{key:"minZ",get:function(){var e=this.transform.worldMatrix.elements;return this._minZ*this._getScaleZ()+e[14]}},{key:"width",get:function(){return(this._heightMap.width-1)*this._cellSize.x*this._getScaleX()}},{key:"depth",get:function(){return(this._heightMap.height-1)*this._cellSize.y*this._getScaleZ()}}],[{key:"createFromMesh",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=new MeshTerrainSprite3D(e,null,n);return i._initCreateFromMesh(t,r),i}},{key:"createFromMeshAndHeightMap",value:function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=new MeshTerrainSprite3D(e,null,i);return a._initCreateFromMeshHeightMap(t,r,n),a}}]),MeshTerrainSprite3D}(pr);Vn._tempVector3=new o,Vn._tempMatrix4x4=new c;var Fn=function(){function GradientDataVector2(){_classCallCheck(this,GradientDataVector2),this._currentLength=0,this._elements=new Float32Array(12)}return _createClass(GradientDataVector2,[{key:"add",value:function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("GradientDataVector2 warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t.x,this._elements[this._currentLength++]=t.y):console.log("GradientDataVector2 warning:data count must lessEqual than 4")}},{key:"cloneTo",value:function(e){var t=e;t._currentLength=this._currentLength;for(var r=t._elements,n=0,i=this._elements.length;n<i;n++)r[n]=this._elements[n]}},{key:"clone",value:function(){var e=new GradientDataVector2;return this.cloneTo(e),e}},{key:"gradientCount",get:function(){return this._currentLength/3}}]),GradientDataVector2}(),Un=function(){function PixelLineData(){_classCallCheck(this,PixelLineData),this.startPosition=new o,this.endPosition=new o,this.startColor=new De,this.endColor=new De}return _createClass(PixelLineData,[{key:"cloneTo",value:function(e){this.startPosition.cloneTo(e.startPosition),this.endPosition.cloneTo(e.endPosition),this.startColor.cloneTo(e.startColor),this.endColor.cloneTo(e.endColor)}}]),PixelLineData}(),Gn=function(){function PostProcessEffect(){_classCallCheck(this,PostProcessEffect)}return _createClass(PostProcessEffect,[{key:"render",value:function(e){}}]),PostProcessEffect}(),zn=function(e){function BloomEffect(){var e;return _classCallCheck(this,BloomEffect),(e=_possibleConstructorReturn(this,_getPrototypeOf(BloomEffect).call(this)))._shader=null,e._shaderData=new ce,e._linearColor=new De,e._bloomTextureTexelSize=new i,e._shaderThreshold=new i,e._shaderParams=new i,e._pyramid=null,e._intensity=0,e._threshold=1,e._softKnee=.5,e._diffusion=7,e._anamorphicRatio=0,e._dirtIntensity=0,e._shaderSetting=new i,e._dirtTileOffset=new i,e.clamp=65472,e.color=new De(1,1,1,1),e.fastMode=!1,e.dirtTexture=null,e._shader=ue.find("PostProcessBloom"),e._pyramid=new Array(2*BloomEffect.MAXPYRAMIDSIZE),e}return _inherits(BloomEffect,e),_createClass(BloomEffect,[{key:"render",value:function(e){var r=e.command,n=e.camera.viewport;this._shaderData.setTexture(BloomEffect.SHADERVALUE_AUTOEXPOSURETEX,t.Texture2D.whiteTexture);var a,o=this._anamorphicRatio,s=o<0?-o:0,l=o>0?o:0,u=Math.floor(n.width/(2-s)),c=Math.floor(n.height/(2-l)),h=Math.max(u,c);a=Math.log2(h)+this._diffusion-10;var _=Math.floor(a),d=Math.min(Math.max(_,1),BloomEffect.MAXPYRAMIDSIZE),f=.5+a-_;this._shaderData.setNumber(BloomEffect.SHADERVALUE_SAMPLESCALE,f);var m=De.gammaToLinearSpace(this.threshold),T=m*this._softKnee+1e-5;this._shaderThreshold.setValue(m,m-T,2*T,.25/T),this._shaderData.setVector(BloomEffect.SHADERVALUE_THRESHOLD,this._shaderThreshold);var p=De.gammaToLinearSpace(this.clamp);this._shaderParams.setValue(p,0,0,0),this._shaderData.setVector(BloomEffect.SHADERVALUE_PARAMS,this._shaderParams);for(var g=this.fastMode?1:0,E=e.source,y=0;y<d;y++){var S=2*y,v=S+1,R=0==y?BloomEffect.SUBSHADER_PREFILTER13+g:BloomEffect.SUBSHADER_DOWNSAMPLE13+g,C=ie.createFromPool(u,c,t.RenderTextureFormat.R8G8B8,t.RenderTextureDepthFormat.DEPTHSTENCIL_NONE);if(C.filterMode=t.FilterMode.Bilinear,this._pyramid[S]=C,y!==d-1){var M=ie.createFromPool(u,c,t.RenderTextureFormat.R8G8B8,t.RenderTextureDepthFormat.DEPTHSTENCIL_NONE);M.filterMode=t.FilterMode.Bilinear,this._pyramid[v]=M}r.blitScreenTriangle(E,C,null,this._shader,this._shaderData,R),E=C,u=Math.max(Math.floor(u/2),1),c=Math.max(Math.floor(c/2),1)}var D=this._pyramid[2*(d-1)];for(y=d-2;y>=0;y--)v=(S=2*y)+1,C=this._pyramid[S],M=this._pyramid[v],r.setShaderDataTexture(this._shaderData,BloomEffect.SHADERVALUE_BLOOMTEX,C),r.blitScreenTriangle(D,M,null,this._shader,this._shaderData,BloomEffect.SUBSHADER_UPSAMPLETENT+g),D=M;var x=this._linearColor;this.color.toLinear(x);var A=Math.pow(2,this._intensity/10)-1,I=this._shaderSetting;this._shaderSetting.setValue(f,A,this._dirtIntensity,d);var L=this.dirtTexture?this.dirtTexture:t.Texture2D.blackTexture,P=L.width/L.height,O=n.width/n.height,N=this._dirtTileOffset;P>O?N.setValue(O/P,1,.5*(1-N.x),0):P<O&&N.setValue(1,P/O,0,.5*(1-N.y));var b=e.compositeShaderData;for(this.fastMode?b.addDefine(he.SHADERDEFINE_BLOOM_LOW):b.addDefine(he.SHADERDEFINE_BLOOM),this._bloomTextureTexelSize.setValue(1/D.width,1/D.height,D.width,D.height),b.setVector(he.SHADERVALUE_BLOOM_DIRTTILEOFFSET,N),b.setVector(he.SHADERVALUE_BLOOM_SETTINGS,I),b.setVector(he.SHADERVALUE_BLOOM_COLOR,new i(x.r,x.g,x.b,x.a)),b.setTexture(he.SHADERVALUE_BLOOM_DIRTTEX,L),b.setTexture(he.SHADERVALUE_BLOOMTEX,D),b.setVector(he.SHADERVALUE_BLOOMTEX_TEXELSIZE,this._bloomTextureTexelSize),y=0;y<d;y++)v=(S=2*y)+1,ie.recoverToPool(this._pyramid[S]),0!==y&&y!==d-1&&ie.recoverToPool(this._pyramid[v]);e.deferredReleaseTextures.push(D)}},{key:"intensity",get:function(){return this._intensity},set:function(e){this._intensity=Math.max(e,0)}},{key:"threshold",get:function(){return this._threshold},set:function(e){this._threshold=Math.max(e,0)}},{key:"softKnee",get:function(){return this._softKnee},set:function(e){this._softKnee=Math.min(Math.max(e,0),1)}},{key:"diffusion",get:function(){return this._diffusion},set:function(e){this._diffusion=Math.min(Math.max(e,1),10)}},{key:"anamorphicRatio",get:function(){return this._anamorphicRatio},set:function(e){this._anamorphicRatio=Math.min(Math.max(e,-1),1)}},{key:"dirtIntensity",get:function(){return this._dirtIntensity},set:function(e){this._dirtIntensity=Math.max(e,0)}}]),BloomEffect}(Gn);zn.SHADERVALUE_MAINTEX=ue.propertyNameToID("u_MainTex"),zn.SHADERVALUE_AUTOEXPOSURETEX=ue.propertyNameToID("u_AutoExposureTex"),zn.SHADERVALUE_SAMPLESCALE=ue.propertyNameToID("u_SampleScale"),zn.SHADERVALUE_THRESHOLD=ue.propertyNameToID("u_Threshold"),zn.SHADERVALUE_PARAMS=ue.propertyNameToID("u_Params"),zn.SHADERVALUE_BLOOMTEX=ue.propertyNameToID("u_BloomTex"),zn.SUBSHADER_PREFILTER13=0,zn.SUBSHADER_PREFILTER4=1,zn.SUBSHADER_DOWNSAMPLE13=2,zn.SUBSHADER_DOWNSAMPLE4=3,zn.SUBSHADER_UPSAMPLETENT=4,zn.SUBSHADER_UPSAMPLEBOX=5,zn.MAXPYRAMIDSIZE=16;var Hn=function(){function RandX(e){if(_classCallCheck(this,RandX),!(e instanceof Array)||4!==e.length)throw new Error("Rand:Seed must be an array with 4 numbers");this._state0U=0|e[0],this._state0L=0|e[1],this._state1U=0|e[2],this._state1L=0|e[3]}return _createClass(RandX,[{key:"randomint",value:function(){var e=this._state0U,t=this._state0L,r=this._state1U,n=this._state1L,i=(n>>>0)+(t>>>0),a=r+e+(i/2>>>31)>>>0,o=i>>>0;this._state0U=r,this._state0L=n;var s=0,l=0;s=(e^=s=e<<23|(-512&t)>>>9)^r,l=(t^=l=t<<23)^n;s^=e>>>18,l^=t>>>18|(262143&e)<<14;return s^=r>>>5,l^=n>>>5|(31&r)<<27,this._state1U=s,this._state1L=l,[a,o]}},{key:"random",value:function(){var e=this.randomint(),t=e[0],r=1023<<20|t>>>12,n=0|(e[1]>>>12|(4095&t)<<20);return RandX._CONVERTION_BUFFER.setUint32(0,r,!1),RandX._CONVERTION_BUFFER.setUint32(4,n,!1),RandX._CONVERTION_BUFFER.getFloat64(0,!1)-1}}]),RandX}();Hn._CONVERTION_BUFFER=new DataView(new ArrayBuffer(8)),Hn.defaultRand=new Hn([0,Date.now()/65536,0,Date.now()%65536]);var Wn=function(){function Point2PointConstraint(){_classCallCheck(this,Point2PointConstraint),this._pivotInA=new o,this._pivotInB=new o}return _createClass(Point2PointConstraint,[{key:"pivotInA",get:function(){return this._pivotInA},set:function(e){this._pivotInA=e}},{key:"pivotInB",get:function(){return this._pivotInB},set:function(e){this._pivotInB=e}},{key:"damping",get:function(){return this._damping},set:function(e){this._damping=e}},{key:"impulseClamp",get:function(){return this._impulseClamp},set:function(e){this._impulseClamp=e}},{key:"tau",get:function(){return this._tau},set:function(e){this._tau=e}}]),Point2PointConstraint}(),Xn=function(){function TextMesh(){_classCallCheck(this,TextMesh)}return _createClass(TextMesh,[{key:"_createVertexBuffer",value:function(e){}},{key:"_resizeVertexBuffer",value:function(e){}},{key:"_addChar",value:function(){}},{key:"text",get:function(){return this._text},set:function(e){this._text=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize=e}},{key:"color",get:function(){return this._color},set:function(e){this._color=e}}]),TextMesh}(),Yn=function(){function Size(e,t){_classCallCheck(this,Size),this._width=0,this._height=0,this._width=e,this._height=t}return _createClass(Size,[{key:"width",get:function(){return-1===this._width?ne.clientWidth:this._width}},{key:"height",get:function(){return-1===this._height?ne.clientHeight:this._height}}],[{key:"fullScreen",get:function(){return new Size(-1,-1)}}]),Size}();e.AlternateLightQueue=Mt,e.AnimationClip=j,e.AnimationClipParser03=H,e.AnimationClipParser04=X,e.AnimationEvent=V,e.AnimationNode=de,e.AnimationTransform3D=_e,e.Animator=te,e.AnimatorControllerLayer=Q,e.AnimatorPlayState=Z,e.AnimatorState=$,e.AnimatorStateScript=kn,e.Avatar=fe,e.BaseCamera=rt,e.BaseMaterial=Te,e.BaseRender=Ut,e.BaseShape=Pr,e.BatchMark=Nt,e.BlinnPhongMaterial=ge,e.BlitScreenQuadCMD=ot,e.BloomEffect=zn,e.BoundBox=xt,e.BoundFrustum=Ue,e.BoundSphere=Zt,e.Bounds=At,e.BoundsOctree=Yt,e.BoundsOctreeNode=Wt,e.BoxColliderShape=T,e.BoxShape=Nr,e.BufferState=We,e.BulletInteractive=_n,e.Burst=Sr,e.Camera=pt,e.CameraCullInfo=xe,e.CapsuleColliderShape=p,e.CastShadowList=bn,e.CharacterController=O,e.CircleShape=br,e.Cluster=Pe,e.ColliderShape=h,e.Collision=x,e.CollisionTool=A,e.CollisionUtils=Fe,e.Color=De,e.ColorOverLifetime=Rr,e.Command=at,e.CommandBuffer=ct,e.CompoundColliderShape=d,e.ConchQuaternion=J,e.ConchVector3=K,e.ConchVector4=q,e.ConeColliderShape=g,e.ConeShape=kr,e.Config3D=w,e.ConfigurableConstraint=On,e.Constraint3D=function Constraint3D(){_classCallCheck(this,Constraint3D)},e.ConstraintComponent=Ln,e.ContactPoint=M,e.ContainmentType=Be,e.CylinderColliderShape=E,e.DefineDatas=ae,e.DirectionLight=yn,e.DynamicBatchManager=er,e.EffectMaterial=Ee,e.Emission=Qr,e.ExtendTerrainMaterial=Se,e.FixedConstraint=Pn,e.FloatKeyframe=U,e.FrameOverTime=Cr,e.FrustumCulling=Ie,e.GeometryElement=It,e.Gradient=yr,e.GradientAngularVelocity=Mr,e.GradientColor=vr,e.GradientDataInt=Dr,e.GradientDataNumber=xr,e.GradientDataVector2=Fn,e.GradientMode=gr,e.GradientSize=Ar,e.GradientVelocity=Ir,e.HalfFloatUtils=W,e.HeightMap=Bn,e.HeightfieldColliderShape=function HeightfieldColliderShape(){_classCallCheck(this,HeightfieldColliderShape)},e.HemisphereShape=wr,e.HitResult=D,e.ILaya3D=l,e.IndexBuffer3D=Xe,e.Input3D=gt,e.Keyframe=F,e.KeyframeNode=B,e.KeyframeNodeList=Y,e.KeyframeNodeOwner=ee,e.Laya3D=Nn,e.LightQueue=Ct,e.LightSprite=ft,e.Lightmap=jt,e.LoadModelV04=Dn,e.LoadModelV05=xn,e.Material=me,e.MathUtils3D=r,e.Matrix3x3=s,e.Matrix4x4=c,e.Mesh=Tn,e.MeshColliderShape=y,e.MeshFilter=fr,e.MeshReader=An,e.MeshRenderDynamicBatchManager=Tr,e.MeshRenderStaticBatchManager=Ft,e.MeshRenderer=dr,e.MeshSprite3D=pr,e.MeshSprite3DShaderDeclaration=_r,e.MeshTerrainSprite3D=Vn,e.MouseTouch=Ne,e.OctreeMotionList=Xt,e.PBRMaterial=ve,e.PBRSpecularMaterial=ar,e.PBRStandardMaterial=sr,e.Physics3D=k,e.Physics3DUtils=m,e.PhysicsCollider=dn,e.PhysicsComponent=v,e.PhysicsSettings=yt,e.PhysicsSimulation=I,e.PhysicsTriggerComponent=N,e.PhysicsUpdateList=C,e.Picker=ze,e.PixelLineData=Un,e.PixelLineFilter=Pt,e.PixelLineMaterial=Dt,e.PixelLineRenderer=Gt,e.PixelLineSprite3D=zt,e.PixelLineVertex=Lt,e.Plane=ke,e.Point2PointConstraint=Wn,e.PointLight=Sn,e.PostProcess=he,e.PostProcessEffect=Gn,e.PostProcessRenderContext=re,e.PrimitiveMesh=pn,e.Quaternion=u,e.QuaternionKeyframe=G,e.Rand=Zr,e.RandX=Hn,e.Ray=we,e.RenderContext3D=ne,e.RenderElement=kt,e.RenderQueue=Ht,e.RenderState=pe,e.RenderTexture=ie,e.RenderableSprite3D=Ot,e.Rigidbody3D=b,e.RotationOverLifetime=Lr,e.Scene3D=tr,e.Scene3DShaderDeclaration=ht,e.Scene3DUtils=Mn,e.SceneManager=function SceneManager(){_classCallCheck(this,SceneManager)},e.ScreenQuad=nt,e.ScreenTriangle=it,e.Script3D=wn,e.SetRenderTargetCMD=st,e.SetShaderDataTextureCMD=lt,e.Shader3D=ue,e.ShaderData=ce,e.ShaderDefine=oe,e.ShaderInit3D=En,e.ShaderInstance=Ce,e.ShaderPass=rr,e.ShaderVariable=Re,e.ShaderVariant=se,e.ShaderVariantCollection=le,e.ShadowCasterPass=Jt,e.ShadowCullInfo=Ae,e.ShadowSliceData=qt,e.ShadowSpotData=Kt,e.ShadowUtils=Tt,e.ShapeUtils=Or,e.ShuriKenParticle3D=Jr,e.ShuriKenParticle3DShaderDeclaration=zr,e.ShurikenParticleData=qr,e.ShurikenParticleMaterial=Hr,e.ShurikenParticleRenderer=Wr,e.ShurikenParticleSystem=Kr,e.SimpleSingletonList=Me,e.SimpleSkinnedMeshRenderer=Rn,e.SimpleSkinnedMeshSprite3D=Cn,e.SingletonList=R,e.Size=Yn,e.SizeOverLifetime=Vr,e.SkinnedMeshRenderer=en,e.SkinnedMeshSprite3D=tn,e.SkinnedMeshSprite3DShaderDeclaration=$r,e.SkyBox=Je,e.SkyBoxMaterial=lr,e.SkyDome=vt,e.SkyMesh=Ke,e.SkyPanoramicMaterial=In,e.SkyProceduralMaterial=ur,e.SkyRenderer=$e,e.SphereColliderShape=S,e.SphereShape=Br,e.SphericalHarmonicsL2=Oe,e.SpotLight=vn,e.Sprite3D=et,e.StartFrame=Fr,e.StaticBatchManager=Bt,e.StaticPlaneColliderShape=_,e.SubMesh=fn,e.SubMeshDynamicBatch=mr,e.SubMeshInstanceBatch=bt,e.SubMeshRenderElement=wt,e.SubMeshStaticBatch=Vt,e.SubShader=ir,e.TextMesh=Xn,e.TextureCube=Rt,e.TextureGenerator=L,e.TextureMode=an,e.TextureSheetAnimation=Ur,e.Touch=be,e.TrailFilter=ln,e.TrailGeometry=sn,e.TrailMaterial=rn,e.TrailRenderer=un,e.TrailSprite3D=cn,e.Transform3D=f,e.UnlitMaterial=cr,e.Utils3D=P,e.Vector2=n,e.Vector3=o,e.Vector3Keyframe=z,e.Vector4=i,e.VelocityOverLifetime=Gr,e.VertexBuffer3D=qe,e.VertexDeclaration=je,e.VertexElement=Ze,e.VertexElementFormat=Ye,e.VertexMesh=Qe,e.VertexPositionTerrain=hn,e.VertexPositionTexture0=St,e.VertexShuriKenParticle=Xr,e.VertexShurikenParticleBillboard=Yr,e.VertexShurikenParticleMesh=jr,e.VertexTrail=on,e.Viewport=Ge,e.WaterPrimaryMaterial=hr,e.skinnedMatrixCache=mn}(window.Laya=window.Laya||{},Laya); 
 			}); 
		define("__plugin__/wx70d8aa25ec591f7a/laya.html.js", function(require, module, exports){ 			
!function(){"use strict";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}function e(t,i,n,s){return(e="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(t,e,i,n){var s,r=l(t,e);if(r){if((s=Object.getOwnPropertyDescriptor(r,e)).set)return s.set.call(n,i),!0;if(!s.writable)return!1}if(s=Object.getOwnPropertyDescriptor(n,e)){if(!s.writable)return!1;s.value=i,Object.defineProperty(n,e,s)}else!function(t,e,i){e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i}(n,e,i);return!0})(t,i,n,s)}function i(t,i,n,s,r){if(!e(t,i,n,s||t)&&r)throw new Error("failed to set property");return n}function n(e,i){return!i||"object"!==t(i)&&"function"!=typeof i?s(e):i}function s(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function r(t,e,i){return(r="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){var n=l(t,e);if(n){var s=Object.getOwnPropertyDescriptor(n,e);return s.get?s.get.call(i):s.value}})(t,e,i||t)}function l(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=a(t)););return t}function a(t){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function h(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&function(t,e){(Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}(t,e)}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function u(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function c(t,e,i){return e&&u(t.prototype,e),i&&u(t,i),t}!function(t,e){var l=function(){function t(){o(this,t),this.reset()}return c(t,[{key:"reset",value:function(){return this.stroke=0,this.strokeColor="#000000",this.leading=0,this.lineHeight=0,this.letterSpacing=0,this.href=null,this}},{key:"recover",value:function(){this!=t.EMPTY&&e.Pool.recover("HTMLExtendStyle",this.reset())}}],[{key:"create",value:function(){return e.Pool.getItemByClass("HTMLExtendStyle",t)}}]),t}();l.EMPTY=new l,e.ClassUtils.regClass("laya.html.utils.HTMLExtendStyle",l),e.ClassUtils.regClass("Laya.HTMLExtendStyle",l);var u=function(){function t(){o(this,t),this.padding=t._PADDING,this.reset()}return c(t,[{key:"_getExtendStyle",value:function(){return this._extendStyle===l.EMPTY&&(this._extendStyle=l.create()),this._extendStyle}},{key:"reset",value:function(){return this.ower=null,this._type=0,this.wordWrap=!0,this.fontSize=e.ILaya.Text.defaultFontSize,this.family=e.ILaya.Text.defaultFont,this.color="#000000",this.valign=t.VALIGN_TOP,this.padding=t._PADDING,this.bold=!1,this.italic=!1,this.align=t.ALIGN_LEFT,this.textDecoration=null,this.bgColor=null,this.borderColor=null,this._extendStyle&&this._extendStyle.recover(),this._extendStyle=l.EMPTY,this}},{key:"recover",value:function(){e.Pool.recover("HTMLStyle",this.reset())}},{key:"inherit",value:function(e){var i,n,s,r;for(n=(s=t._inheritProps).length,i=0;i<n;i++)this[r=s[i]]=e[r]}},{key:"_widthAuto",value:function(){return 0!=(this._type&t._WIDTHAUTO)}},{key:"widthed",value:function(e){return 0!=(this._type&t._WIDTH_SET)}},{key:"_calculation",value:function(t,e){return!1}},{key:"heighted",value:function(e){return 0!=(this._type&t._HEIGHT_SET)}},{key:"size",value:function(e,i){var n=this.ower,s=!1;-1!==e&&e!=n.width&&(this._type|=t._WIDTH_SET,n.width=e,s=!0),-1!==i&&i!=n.height&&(this._type|=t._HEIGHT_SET,n.height=i,s=!0),s&&n._layoutLater()}},{key:"getLineElement",value:function(){return 0!=(this._type&t._LINE_ELEMENT)}},{key:"setLineElement",value:function(e){e?this._type|=t._LINE_ELEMENT:this._type&=~t._LINE_ELEMENT}},{key:"_enableLayout",value:function(){return 0==(this._type&t._DISPLAY_NONE)&&0==(this._type&t._ABSOLUTE)}},{key:"cssText",value:function(e){this.attrs(t.parseOneCSS(e,";"))}},{key:"attrs",value:function(t){if(t)for(var e=0,i=t.length;e<i;e++){var n=t[e];this[n[0]]=n[1]}}},{key:"href",get:function(){return this._extendStyle.href},set:function(t){t!==this._extendStyle.href&&(this._getExtendStyle().href=t)}},{key:"stroke",get:function(){return this._extendStyle.stroke},set:function(t){this._extendStyle.stroke!==t&&(this._getExtendStyle().stroke=t)}},{key:"strokeColor",get:function(){return this._extendStyle.strokeColor},set:function(t){this._extendStyle.strokeColor!==t&&(this._getExtendStyle().strokeColor=t)}},{key:"leading",get:function(){return this._extendStyle.leading},set:function(t){this._extendStyle.leading!==t&&(this._getExtendStyle().leading=t)}},{key:"lineHeight",get:function(){return this._extendStyle.lineHeight},set:function(t){this._extendStyle.lineHeight!==t&&(this._getExtendStyle().lineHeight=t)}},{key:"align",set:function(e){e in t.alignVDic&&(this._type&=~t._ALIGN,this._type|=t.alignVDic[e])},get:function(){var e=this._type&t._ALIGN;return t.align_Value[e]}},{key:"valign",set:function(e){e in t.alignVDic&&(this._type&=~t._VALIGN,this._type|=t.alignVDic[e])},get:function(){var e=this._type&t._VALIGN;return t.vAlign_Value[e]}},{key:"font",set:function(t){for(var e=t.split(" "),i=0,n=e.length;i<n;i++){var s=e[i];switch(s){case"italic":this.italic=!0;continue;case"bold":this.bold=!0;continue}s.indexOf("px")>0&&(this.fontSize=parseInt(s),this.family=e[i+1],i++)}},get:function(){return(this.italic?"italic ":"")+(this.bold?"bold ":"")+this.fontSize+"px "+(e.ILaya.Browser.onIPhone&&e.ILaya.Text.fontFamilyMap[this.family]||this.family)}},{key:"block",set:function(e){e?this._type|=t._CSS_BLOCK:this._type&=~t._CSS_BLOCK},get:function(){return 0!=(this._type&t._CSS_BLOCK)}},{key:"wordWrap",get:function(){return 0==(this._type&t._NOWARP)},set:function(e){e?this._type&=~t._NOWARP:this._type|=t._NOWARP}},{key:"bold",get:function(){return 0!=(this._type&t._BOLD)},set:function(e){e?this._type|=t._BOLD:this._type&=~t._BOLD}},{key:"fontWeight",get:function(){return this._type&t._BOLD?"bold":"none"},set:function(e){"bold"==e?this._type|=t._BOLD:this._type&=~t._BOLD}},{key:"italic",get:function(){return 0!=(this._type&t._ITALIC)},set:function(e){e?this._type|=t._ITALIC:this._type&=~t._ITALIC}},{key:"whiteSpace",set:function(e){"nowrap"===e&&(this._type|=t._NOWARP),"none"===e&&(this._type&=~t._NOWARP)},get:function(){return this._type&t._NOWARP?"nowrap":""}},{key:"width",set:function(e){if(this._type|=t._WIDTH_SET,"string"==typeof e){var i=e.indexOf("auto");if(i>=0&&(this._type|=t._WIDTHAUTO,e=e.substr(0,i)),this._calculation("width",e))return;e=parseInt(e)}this.size(e,-1)}},{key:"height",set:function(e){if(this._type|=t._HEIGHT_SET,"string"==typeof e){if(this._calculation("height",e))return;e=parseInt(e)}this.size(-1,e)}},{key:"letterSpacing",get:function(){return this._extendStyle.letterSpacing},set:function(t){"string"==typeof t&&(t=parseInt(t+"")),t!=this._extendStyle.letterSpacing&&(this._getExtendStyle().letterSpacing=t)}},{key:"position",set:function(e){"absolute"===e?this._type|=t._ABSOLUTE:this._type&=~t._ABSOLUTE},get:function(){return this._type&t._ABSOLUTE?"absolute":""}},{key:"absolute",get:function(){return 0!=(this._type&t._ABSOLUTE)}},{key:"paddingLeft",get:function(){return this.padding[3]}},{key:"paddingTop",get:function(){return this.padding[0]}}],[{key:"create",value:function(){return e.Pool.getItemByClass("HTMLStyle",t)}},{key:"parseOneCSS",value:function(e,i){for(var n,s=[],r=e.split(i),l=0,a=r.length;l<a;l++){var h=r[l],o=h.indexOf(":"),u=h.substr(0,o).replace(/^\s+|\s+$/g,"");if(0!==u.length){var c=h.substr(o+1).replace(/^\s+|\s+$/g,""),y=[u,c];switch(u){case"italic":case"bold":y[1]="true"==c;break;case"font-weight":"bold"==c&&(y[1]=!0,y[0]="bold");break;case"line-height":y[0]="lineHeight",y[1]=parseInt(c);break;case"font-size":y[0]="fontSize",y[1]=parseInt(c);break;case"stroke":y[0]="stroke",y[1]=parseInt(c);break;case"padding":(n=c.split(" ")).length>1||(n[1]=n[2]=n[3]=n[0]),y[1]=[parseInt(n[0]),parseInt(n[1]),parseInt(n[2]),parseInt(n[3])];break;default:(y[0]=t._CSSTOVALUE[u])||(y[0]=u)}s.push(y)}}return s}},{key:"parseCSS",value:function(e,i){for(var n;null!=(n=t._parseCSSRegExp.exec(e));)t.styleSheets[n[1]]=t.parseOneCSS(n[2],";")}}]),t}();u._CSSTOVALUE={"letter-spacing":"letterSpacing","white-space":"whiteSpace","line-height":"lineHeight","font-family":"family","vertical-align":"valign","text-decoration":"textDecoration","background-color":"bgColor","border-color":"borderColor"},u._parseCSSRegExp=new RegExp("([.#]\\w+)\\s*{([\\s\\S]*?)}","g"),u._inheritProps=["italic","align","valign","leading","letterSpacing","stroke","strokeColor","bold","fontWeight","fontSize","lineHeight","wordWrap","color"],u.ALIGN_LEFT="left",u.ALIGN_CENTER="center",u.ALIGN_RIGHT="right",u.VALIGN_TOP="top",u.VALIGN_MIDDLE="middle",u.VALIGN_BOTTOM="bottom",u.styleSheets={},u.ADDLAYOUTED=512,u._PADDING=[0,0,0,0],u._HEIGHT_SET=8192,u._LINE_ELEMENT=65536,u._NOWARP=131072,u._WIDTHAUTO=262144,u._BOLD=1024,u._ITALIC=2048,u._CSS_BLOCK=1,u._DISPLAY_NONE=2,u._ABSOLUTE=4,u._WIDTH_SET=8,u.alignVDic={left:0,center:16,right:32,top:0,middle:64,bottom:128},u.align_Value={0:"left",16:"center",32:"right"},u.vAlign_Value={0:"top",64:"middle",128:"bottom"},u._ALIGN=48,u._VALIGN=192,e.ClassUtils.regClass("laya.html.utils.HTMLStyle",u),e.ClassUtils.regClass("Laya.HTMLStyle",u);var y=function(){function t(){o(this,t),this.all=[],this.styleSheets=u.styleSheets}return c(t,[{key:"getElementById",value:function(t){return this.all[t]}},{key:"setElementById",value:function(t,e){this.all[t]=e}}]),t}();y.document=new y,e.ClassUtils.regClass("laya.html.dom.HTMLDocument",y),e.ClassUtils.regClass("Laya.HTMLDocument",y);var f=function(){function t(){o(this,t),this.rec=new e.Rectangle,this.reset()}return c(t,[{key:"reset",value:function(){return this.rec.reset(),this.href=null,this}},{key:"recover",value:function(){e.Pool.recover("HTMLHitRect",this.reset())}}],[{key:"create",value:function(){return e.Pool.getItemByClass("HTMLHitRect",t)}}]),t}();e.ClassUtils.regClass("laya.html.dom.HTMLHitRect",f),e.ClassUtils.regClass("Laya.HTMLHitRect",f);var _=function t(){o(this,t)};_.HTMLDivElement=null,_.HTMLImageElement=null,_.HTMLBrElement=null,_.HTMLDivParser=null,_.HTMLParse=null,_.HTMLElementType=null;var d=function(){function t(){o(this,t),this.elements=[],this.x=0,this.y=0,this.w=0,this.h=0,this.wordStartIndex=0,this.minTextHeight=99999,this.mWidth=0}return c(t,[{key:"updatePos",value:function(t,e,i,n,s,r,l){var a,h=0;this.elements.length>0&&(h=(a=this.elements[this.elements.length-1]).x+a.width-this.elements[0].x),l=l||this.h;var o,c=0;s===u.ALIGN_CENTER&&(c=(e-h)/2),s===u.ALIGN_RIGHT&&(c=e-h);for(var y=0,f=this.elements.length;y<f;y++){var d=(a=this.elements[y])._getCSSStyle();switch(0!==c&&(a.x+=c),d.valign){case"top":a.y=n;break;case"middle":var g=0;99999!=this.minTextHeight&&(g=this.minTextHeight);var p=(g+l)/2;p=Math.max(p,this.h),a.eletype,_.HTMLElementType.IMAGE,o=n+p-a.height,a.y=o;break;case"bottom":a.y=n+(l-a.height)}}}}]),t}();e.ClassUtils.regClass("laya.html.utils.LayoutLine",d),e.ClassUtils.regClass("Laya.LayoutLine",d);var g,p=function(){function t(){o(this,t)}return c(t,null,[{key:"later",value:function(i){null==t._will&&(t._will=[],e.ILaya.stage.frameLoop(1,null,function(){if(!(t._will.length<1)){for(var e=0;e<t._will.length;e++)t.layout(t._will[e]);t._will.length=0}})),t._will.push(i)}},{key:"layout",value:function(e){return e&&e._style?0==(e._style._type&u.ADDLAYOUTED)?null:(e.style._type&=~u.ADDLAYOUTED,t._multiLineLayout(e)):null}},{key:"_multiLineLayout",value:function(e){var i=[];e._addChildsToLayout(i);var n,s,r,l,a,h,o,c=i.length,y=e._getCSSStyle(),f=y.letterSpacing,g=y.leading,p=y.lineHeight,L=y._widthAuto()||!y.wordWrap,v=L?999999:e.width,T=(e.height,0),m=y.italic?y.fontSize/3:0,k=y.align,C=y.valign,S=C!==u.VALIGN_TOP||k!==u.ALIGN_LEFT||0!=p,E=0,x=0,w=0,I=0,H=[],M=H[0]=new d,b=!1;M.h=0,y.italic&&(v-=y.fontSize/3);var U=0,D=!0;function O(){M.y=x,x+=M.h+g,M.mWidth=U,U=0,M=new d,H.push(M),M.h=0,E=0,D=!0,a=!1}for(n=0;n<c;n++)if(null!=(s=i[n]))if(D=!1,s instanceof _.HTMLBrElement)O(),M.y=x,M.h=p;else{if(s._isChar()){if((h=s).isWord)a=b||"\n"===h.char,M.wordStartIndex=M.elements.length;else{if(H.length>0&&E+w>v&&M.wordStartIndex>0){var A;A=M.elements.length-M.wordStartIndex+1,M.elements.length=M.wordStartIndex,n-=A,O();continue}a=!1,U+=h.width}w=h.width+h.style.letterSpacing,I=h.height,b=!1,(a=a||E+w>v)&&O(),M.minTextHeight=Math.min(M.minTextHeight,s.height)}else r=s._getCSSStyle(),o=s,l=r.padding,a=b||r.getLineElement(),w=o.width+l[1]+l[3]+r.letterSpacing,I=o.height+l[0]+l[2],b=r.getLineElement(),(a=a||E+w>v&&r.wordWrap)&&O();M.elements.push(s),M.h=Math.max(M.h,I),s.x=E,s.y=x,E+=w,M.w=E-f,M.y=x,T=Math.max(E+m,T)}else D||(E+=t.DIV_ELEMENT_PADDING),M.wordStartIndex=M.elements.length;if(x=M.y+M.h,S){var R=0,P=v;for(L&&e.width>0&&(P=e.width),n=0,c=H.length;n<c;n++)H[n].updatePos(0,P,n,R,k,C,p),R+=Math.max(p,H[n].h+g);x=R}return L&&(e.width=T),x>e.height&&(e.height=x),[T,x]}}]),t}();p.DIV_ELEMENT_PADDING=0,e.ClassUtils.regClass("laya.html.utils.Layout",p),e.ClassUtils.regClass("Laya.Layout",p),(g=t.HTMLElementType||(t.HTMLElementType={}))[g.BASE=0]="BASE",g[g.IMAGE=1]="IMAGE";var L=function(){function i(){o(this,i),this.eletype=t.HTMLElementType.BASE,this._creates(),this.reset()}return c(i,[{key:"_creates",value:function(){this._style=u.create()}},{key:"reset",value:function(){if(this.URI=null,this.parent=null,this._style.reset(),this._style.ower=this,this._style.valign="middle",this._text&&this._text.words){var t,e,n,s=this._text.words;for(e=s.length,t=0;t<e;t++)(n=s[t])&&n.recover()}return this._text=i._EMPTYTEXT,this._children&&(this._children.length=0),this._x=this._y=this._width=this._height=0,this}},{key:"_getCSSStyle",value:function(){return this._style}},{key:"_addChildsToLayout",value:function(t){var e=this._getWords();if(null==e&&(!this._children||0==this._children.length))return!1;if(e)for(var i=0,n=e.length;i<n;i++)t.push(e[i]);return this._children&&this._children.forEach(function(e,i,n){var s=e._style;s._enableLayout&&s._enableLayout()&&e._addToLayout(t)}),!0}},{key:"_addToLayout",value:function(t){if(this._style){var e=this._style;e.absolute||(e.block?t.push(this):this._addChildsToLayout(t)&&(this.x=this.y=0))}}},{key:"repaint",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.parentRepaint(t)}},{key:"parentRepaint",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.parent&&this.parent.repaint(t)}},{key:"_setParent",value:function(t){if(t instanceof i){var e=t;this.URI||(this.URI=e.URI),this.style&&this.style.inherit(e.style)}}},{key:"appendChild",value:function(t){return this.addChild(t)}},{key:"addChild",value:function(t){return t.parent&&t.parent.removeChild(t),this._children||(this._children=[]),this._children.push(t),t.parent=this,t._setParent(this),this.repaint(),t}},{key:"removeChild",value:function(t){if(!this._children)return null;var e,i;for(i=this._children.length,e=0;e<i;e++)if(this._children[e]==t)return this._children.splice(e,1),t;return null}},{key:"destroy",value:function(){this._children&&(this.destroyChildren(),this._children.length=0),e.Pool.recover(i.getClassName(this),this.reset())}},{key:"destroyChildren",value:function(){if(this._children){for(var t=this._children.length-1;t>-1;t--)this._children[t].destroy();this._children.length=0}}},{key:"_getWords",value:function(){if(!this._text)return null;var t=this._text.text;if(!t||0===t.length)return null;var i,n=this._text.words;if(n&&n.length===t.length)return n;null===n&&(this._text.words=n=[]),n.length=t.length;for(var s=this.style,r=s.font,l=0,a=t.length;l<a;l++)i=e.ILaya.Browser.measureText(t.charAt(l),r),n[l]=e.HTMLChar.create().setData(t.charAt(l),i.width,i.height||s.fontSize,s);return n}},{key:"_isChar",value:function(){return!1}},{key:"_layoutLater",value:function(){var t=this.style;t._type&u.ADDLAYOUTED||(t.widthed(this)&&(this._children&&this._children.length>0||null!=this._getWords())&&t.block?(p.later(this),t._type|=u.ADDLAYOUTED):this.parent&&this.parent._layoutLater())}},{key:"_setAttributes",value:function(t,e){switch(t){case"style":this.style.cssText(e);break;case"class":this.className=e;break;case"x":this.x=parseFloat(e);break;case"y":this.y=parseFloat(e);break;case"width":this.width=parseFloat(e);break;case"height":this.height=parseFloat(e);break;default:this[t]=e}}},{key:"formatURL",value:function(t){return this.URI?i.formatURL1(t,this.URI?this.URI.path:null):t}},{key:"drawToGraphic",value:function(t,e,i,n){e+=this.x,i+=this.y;var s,r,l,a=this.style;if(a.paddingLeft&&(e+=a.paddingLeft),a.paddingTop&&(i+=a.paddingTop),(null!=a.bgColor||a.borderColor)&&t.drawRect(e,i,this.width,this.height,a.bgColor,a.borderColor,1),this.renderSelfToGraphic(t,e,i,n),this._children&&this._children.length>0)for(r=this._children.length,s=0;s<r;s++)null!=(l=this._children[s]).drawToGraphic&&l.drawToGraphic(t,e,i,n)}},{key:"renderSelfToGraphic",value:function(t,e,i,n){var s=this.style,r=this._getWords();if(r&&(r.length,s)){var l=s.font,a=s.color;if(s.stroke){var h=s.stroke;h=parseInt(h);var o=s.strokeColor;t.fillBorderWords(r,e,i,l,a,o,h)}else t.fillWords(r,e,i,l,a);if(this.href){var u=r[r.length-1],c=u.y+u.height;if(u.y==r[0].y){"none"!=s.textDecoration&&t.drawLine(r[0].x,c,u.x+u.width,c,a,1);var y=f.create();y.rec.setTo(r[0].x,u.y,u.x+u.width-r[0].x,u.height),y.href=this.href,n.push(y)}else this.workLines(r,t,n)}}}},{key:"workLines",value:function(t,e,i){var n;n="none"!=this.style.textDecoration;var s,r,l,a=0;if(s=t.length,l=r=t[a],r){var h;for(a=1;a<s;a++)(h=t[a]).y!=r.y?(this.createOneLine(r,l,n,e,i),r=h,l=h):l=h;this.createOneLine(r,l,n,e,i)}}},{key:"createOneLine",value:function(t,e,i,n,s){var r=e.y+e.height;i&&n.drawLine(t.x,r,e.x+e.width,r,this.style.color,1);var l=f.create();l.rec.setTo(t.x,e.y,e.x+e.width-t.x,e.height),l.href=this.href,s.push(l)}},{key:"id",set:function(t){y.document.setElementById(t,this)}},{key:"innerTEXT",set:function(t){this._text===i._EMPTYTEXT?this._text={text:t,words:null}:(this._text.text=t,this._text.words&&(this._text.words.length=0)),this.repaint()},get:function(){return this._text.text}},{key:"style",get:function(){return this._style}},{key:"x",set:function(t){this._x!=t&&(this._x=t,this.parentRepaint())},get:function(){return this._x}},{key:"y",set:function(t){this._y!=t&&(this._y=t,this.parentRepaint())},get:function(){return this._y}},{key:"width",get:function(){return this._width},set:function(t){this._width!==t&&(this._width=t,this.repaint())}},{key:"height",get:function(){return this._height},set:function(t){this._height!==t&&(this._height=t,this.repaint())}},{key:"href",set:function(t){this._style&&t!=this._style.href&&(this._style.href=t,this.repaint())},get:function(){return this._style?this._style.href:null}},{key:"color",set:function(t){this.style.color=t}},{key:"className",set:function(t){this.style.attrs(y.document.styleSheets["."+t])}}],[{key:"formatURL1",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!t)return"null path";if(i||(i=e.URL.basePath),t.indexOf(":")>0)return t;if(null!=e.URL.customFormat&&(t=e.URL.customFormat(t)),t.indexOf(":")>0)return t;var n=t.charAt(0);if("."===n)return e.URL._formatRelativePath(i+t);if("~"===n)return e.URL.rootPath+t.substring(1);if("d"===n){if(0===t.indexOf("data:image"))return t}else if("/"===n)return t;return i+t}},{key:"getClassName",value:function(t){return t instanceof Function?t.name:t.constructor.name}}]),i}();L._EMPTYTEXT={text:null,words:null},e.ILaya.regClass(L),_.HTMLElementType=t.HTMLElementType,e.ClassUtils.regClass("laya.html.dom.HTMLElement",L),e.ClassUtils.regClass("Laya.HTMLElement",L);var v=function(){function t(){o(this,t)}return c(t,[{key:"_addToLayout",value:function(t){t.push(this)}},{key:"reset",value:function(){return this}},{key:"destroy",value:function(){e.Pool.recover(L.getClassName(this),this.reset())}},{key:"_setParent",value:function(t){}},{key:"_getCSSStyle",value:function(){return t.brStyle||(t.brStyle=new u,t.brStyle.setLineElement(!0),t.brStyle.block=!0),t.brStyle}},{key:"renderSelfToGraphic",value:function(t,e,i,n){}},{key:"parent",set:function(t){}},{key:"URI",set:function(t){}},{key:"href",set:function(t){}}]),t}();_.HTMLBrElement=v,e.ILaya.regClass(v),e.ClassUtils.regClass("laya.html.dom.HTMLBrElement",v),e.ClassUtils.regClass("Laya.HTMLBrElement",v);var T=function(t){function e(){return o(this,e),n(this,a(e).apply(this,arguments))}return h(e,L),c(e,[{key:"_creates",value:function(){}},{key:"drawToGraphic",value:function(t,e,i,n){}},{key:"reset",value:function(){return this}},{key:"innerTEXT",set:function(t){u.parseCSS(t,null)},get:function(){return r(a(e.prototype),"innerTEXT",this)}}]),e}();e.ILaya.regClass(T),e.ClassUtils.regClass("laya.html.dom.HTMLStyleElement",T),e.ClassUtils.regClass("Laya.HTMLStyleElement",T);var m=function(t){function i(){return o(this,i),n(this,a(i).apply(this,arguments))}return h(i,L),c(i,[{key:"_creates",value:function(){}},{key:"drawToGraphic",value:function(t,e,i,n){}},{key:"reset",value:function(){return this._loader&&this._loader.off(e.Event.COMPLETE,this,this._onload),this._loader=null,this}},{key:"_onload",value:function(t){switch(this._loader&&(this._loader=null),this.type){case"text/css":u.parseCSS(t,this.URI)}this.repaint(!0)}},{key:"href",set:function(t){t&&(t=this.formatURL(t),this.URI=new e.URL(t),this._loader&&this._loader.off(e.Event.COMPLETE,this,this._onload),e.Loader.getRes(t)?"text/css"==this.type&&u.parseCSS(e.Loader.getRes(t),this.URI):(this._loader=new e.Loader,this._loader.once(e.Event.COMPLETE,this,this._onload),this._loader.load(t,e.Loader.TEXT)))},get:function(){return r(a(i.prototype),"href",this)}}]),i}();m._cuttingStyle=new RegExp("((@keyframes[\\s\\t]+|)(.+))[\\t\\n\\r\\s]*{","g"),e.ILaya.regClass(m),e.ClassUtils.regClass("laya.html.dom.HTMLLinkElement",m),e.ClassUtils.regClass("Laya.HTMLLinkElement",m);var k=function(t){function s(){var t;return o(this,s),(t=n(this,a(s).apply(this,arguments))).repaintHandler=null,t}return h(s,L),c(s,[{key:"reset",value:function(){return r(a(s.prototype),"reset",this).call(this),this._style.block=!0,this._style.setLineElement(!0),this._style.width=200,this._style.height=200,this.repaintHandler=null,this.contextHeight=0,this.contextWidth=0,this}},{key:"appendHTML",value:function(t){_.HTMLParse.parse(this,t,this.URI),this.layout()}},{key:"_addChildsToLayout",value:function(t){var e=this._getWords();if(null==e&&(!this._children||0==this._children.length))return!1;e&&e.forEach(function(e){t.push(e)});for(var i=!0,n=0,s=this._children.length;n<s;n++){var r=this._children[n];i?i=!1:t.push(null),r._addToLayout(t)}return!0}},{key:"_addToLayout",value:function(t){this.layout(),!this.style.absolute&&t.push(this)}},{key:"getBounds",value:function(){return this._htmlBounds?(this._boundsRec||(this._boundsRec=e.Rectangle.create()),this._boundsRec.copyFrom(this._htmlBounds)):null}},{key:"parentRepaint",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];r(a(s.prototype),"parentRepaint",this).call(this),this.repaintHandler&&this.repaintHandler.runWith(t)}},{key:"layout",value:function(){this.style._type|=u.ADDLAYOUTED;var t=p.layout(this);if(t){this._htmlBounds||(this._htmlBounds=e.Rectangle.create());var i=this._htmlBounds;i.x=i.y=0,i.width=this.contextWidth=t[0],i.height=this.contextHeight=t[1]}}},{key:"innerHTML",set:function(t){this.destroyChildren(),this.appendHTML(t)}},{key:"width",set:function(t){var e;e=0===t?t!=this._width:t!=this.width,i(a(s.prototype),"width",t,this,!0),e&&this.layout()},get:function(){return this._width?this._width:this.contextWidth}},{key:"height",get:function(){return this._height?this._height:this.contextHeight},set:function(t){i(a(s.prototype),"height",t,this,!0)}}]),s}();_.HTMLDivParser=k,e.ILaya.regClass(k),e.ClassUtils.regClass("laya.html.dom.HTMLDivParser",k),e.ClassUtils.regClass("Laya.HTMLDivParser",k);var C=function(i){function s(){var e;return o(this,s),(e=n(this,a(s).call(this))).eletype=t.HTMLElementType.IMAGE,e}return h(s,L),c(s,[{key:"reset",value:function(){return r(a(s.prototype),"reset",this).call(this),this._tex&&this._tex.off(e.Event.LOADED,this,this.onloaded),this._tex=null,this._url=null,this}},{key:"onloaded",value:function(){if(this._style){var t=this._style;t.widthed(this)||this._tex.width,t.heighted(this)||this._tex.height,t.widthed(this)||this._width==this._tex.width||(this.width=this._tex.width,this.parent&&this.parent._layoutLater()),t.heighted(this)||this._height==this._tex.height||(this.height=this._tex.height,this.parent&&this.parent._layoutLater()),this.repaint()}}},{key:"_addToLayout",value:function(t){!this._style.absolute&&t.push(this)}},{key:"renderSelfToGraphic",value:function(t,e,i,n){this._tex&&t.drawImage(this._tex,e,i,this.width||this._tex.width,this.height||this._tex.height)}},{key:"src",set:function(t){if(t=this.formatURL(t),this._url!==t){this._url=t;var i=this._tex=e.Loader.getRes(t);i||(this._tex=i=new e.Texture,i.load(t),e.Loader.cacheTexture(t,i)),i.getIsReady()?this.onloaded():i.once(e.Event.READY,this,this.onloaded)}}}]),s}();_.HTMLImageElement=C,e.ILaya.regClass(C),e.ClassUtils.regClass("laya.html.dom.HTMLImageElement",C),e.ClassUtils.regClass("Laya.HTMLImageElement",C);var S=function(){function t(){o(this,t)}return c(t,null,[{key:"getInstance",value:function(i){var n=e.Pool.getItem(t._htmlClassMapShort[i]);return n||(n=e.ClassUtils.getInstance(i)),n}},{key:"parse",value:function(i,n,s){n=(n="<root>"+(n=n.replace(/<br>/g,"<br/>"))+"</root>").replace(t.spacePattern,t.char255);var r=e.Utils.parseXMLFromString(n);t._parseXML(i,r.childNodes[0].childNodes,s)}},{key:"_parseXML",value:function(e,i,n){var s,r,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(i.join||i.item)for(s=0,r=i.length;s<r;++s)t._parseXML(e,i[s],n,l);else{var a,h;if(3==i.nodeType){var o;if(e instanceof _.HTMLDivParser)null==i.nodeName&&(i.nodeName="#text"),h=i.nodeName.toLowerCase(),(o=i.textContent.replace(/^\s+|\s+$/g,"")).length>0&&(a=t.getInstance(h))&&(e.addChild(a),a.innerTEXT=o.replace(t.char255AndOneSpacePattern," "));else if((o=i.textContent.replace(/^\s+|\s+$/g,"")).length>0){var u=e;if(e instanceof L&&e.innerTEXT&&e.innerTEXT.length>0){var c=t.getInstance("p");c&&(e.addChild(c),u=c)}u.innerTEXT=o.replace(t.char255AndOneSpacePattern," ")}return}if("#comment"==(h=i.nodeName.toLowerCase()))return;if(a=t.getInstance(h)){"p"==h?(e.addChild(t.getInstance("br")),a=e.addChild(a),e.addChild(t.getInstance("br"))):a=e.addChild(a),a.URI=n,a.href=l;var y=i.attributes;if(y&&y.length>0)for(s=0,r=y.length;s<r;++s){var f=y[s],d=f.nodeName,g=f.value;a._setAttributes(d,g)}t._parseXML(a,i.childNodes,n,a.href)}else t._parseXML(e,i.childNodes,n,l)}}}]),t}();S.char255=String.fromCharCode(255),S.spacePattern=/&nbsp;|&#160;/g,S.char255AndOneSpacePattern=new RegExp(String.fromCharCode(255)+"|(\\s+)","g"),S._htmlClassMapShort={div:k,p:L,img:C,span:L,br:v,style:T,font:L,a:L,"#text":L,link:m},_.HTMLParse=S,e.ClassUtils.regClass("div",k),e.ClassUtils.regClass("p",L),e.ClassUtils.regClass("img",C),e.ClassUtils.regClass("span",L),e.ClassUtils.regClass("br",v),e.ClassUtils.regClass("style",T),e.ClassUtils.regClass("font",L),e.ClassUtils.regClass("a",L),e.ClassUtils.regClass("#text",L),e.ClassUtils.regClass("link",m),e.ClassUtils.regClass("laya.html.utils.HTMLParse",S),e.ClassUtils.regClass("Laya.HTMLParse",S);var E=function(t){function i(){var t;return o(this,i),(t=n(this,a(i).call(this)))._recList=[],t._repaintState=0,t._element=new k,t._element.repaintHandler=new e.Handler(s(t),t._htmlDivRepaint),t.mouseEnabled=!0,t.on(e.Event.CLICK,s(t),t._onMouseClick),t}return h(i,e.Sprite),c(i,[{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._element&&this._element.reset(),this._element=null,this._doClears(),r(a(i.prototype),"destroy",this).call(this,t)}},{key:"_htmlDivRepaint",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]?this._repaintState<2&&(this._repaintState=2):this._repaintState<1&&(this._repaintState=1),this._repaintState>0&&this._setGraphicDirty()}},{key:"_updateGraphicWork",value:function(){switch(this._repaintState){case 1:this._updateGraphic();break;case 2:this._refresh()}}},{key:"_setGraphicDirty",value:function(){this.callLater(this._updateGraphicWork)}},{key:"_doClears",value:function(){if(this._recList){var t,e=this._recList.length;for(t=0;t<e;t++)this._recList[t].recover();this._recList.length=0}}},{key:"_updateGraphic",value:function(){this._doClears(),this.graphics.clear(!0),this._repaintState=0,this._element.drawToGraphic(this.graphics,-this._element.x,-this._element.y,this._recList);var t=this._element.getBounds();t&&this.setSelfBounds(t),this.size(t.width,t.height)}},{key:"_refresh",value:function(){this._repaintState=1,this._innerHTML&&(this._element.innerHTML=this._innerHTML),this._setGraphicDirty()}},{key:"_onMouseClick",value:function(){var t,e,i,n=this.mouseX,s=this.mouseY;for(e=this._recList.length,t=0;t<e;t++)(i=this._recList[t]).rec.contains(n,s)&&this._eventLink(i.href)}},{key:"_eventLink",value:function(t){this.event(e.Event.LINK,[t])}},{key:"style",get:function(){return this._element.style}},{key:"innerHTML",set:function(t){this._innerHTML!=t&&(this._repaintState=1,this._innerHTML=t,this._element.innerHTML=t,this._setGraphicDirty())}},{key:"width",set:function(t){this._element.width=t},get:function(){return this._element.width}},{key:"height",set:function(t){this._element.height=t},get:function(){return this._element.height}},{key:"contextWidth",get:function(){return this._element.contextWidth}},{key:"contextHeight",get:function(){return this._element.contextHeight}}]),i}();_.HTMLDivElement=E,_.HTMLParse=S,e.ClassUtils.regClass("laya.html.dom.HTMLDivElement",E),e.ClassUtils.regClass("Laya.HTMLDivElement",E);var x=function(t){function i(){var t;return o(this,i),(t=n(this,a(i).call(this)))._element._getCSSStyle().valign="middle",t}return h(i,E),c(i,[{key:"href",set:function(t){var i=this;t=this._element.formatURL(t);var n=new e.Loader;n.once(e.Event.COMPLETE,null,function(n){var s=i._element.URI;i._element.URI=new e.URL(t),i.innerHTML=n,!s||(i._element.URI=s)}),n.load(t,e.Loader.TEXT)}}]),i}();e.ClassUtils.regClass("laya.html.dom.HTMLIframeElement",x),e.ClassUtils.regClass("Laya.HTMLIframeElement",x),t.HTMLBrElement=v,t.HTMLDivElement=E,t.HTMLDivParser=k,t.HTMLDocument=y,t.HTMLElement=L,t.HTMLExtendStyle=l,t.HTMLHitRect=f,t.HTMLIframeElement=x,t.HTMLImageElement=C,t.HTMLLinkElement=m,t.HTMLParse=S,t.HTMLStyle=u,t.HTMLStyleElement=T,t.IHtml=_,t.Layout=p,t.LayoutLine=d}(window.Laya=window.Laya||{},Laya)}(); 
 			}); 
		define("__plugin__/wx70d8aa25ec591f7a/laya.particle.js", function(require, module, exports){ 			
!function(){"use strict";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}function e(t,i,r){return(e="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){var r=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=n(t)););return t}(t,e);if(r){var a=Object.getOwnPropertyDescriptor(r,e);return a.get?a.get.call(i):a.value}})(t,i,r||t)}function i(e,i){return!i||"object"!==t(i)&&"function"!=typeof i?r(e):i}function r(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function n(t){return(n=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&function(t,e){(Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}(t,e)}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function l(t,e,i){return e&&s(t.prototype,e),i&&s(t,i),t}!function(t,s){var h=function(){function t(){o(this,t),this.textureName=null,this.textureCount=1,this.maxPartices=100,this.duration=1,this.ageAddScale=0,this.emitterVelocitySensitivity=1,this.minStartSize=100,this.maxStartSize=100,this.minEndSize=100,this.maxEndSize=100,this.minHorizontalVelocity=0,this.maxHorizontalVelocity=0,this.minVerticalVelocity=0,this.maxVerticalVelocity=0,this.endVelocity=1,this.gravity=new Float32Array([0,0,0]),this.minRotateSpeed=0,this.maxRotateSpeed=0,this.minStartRadius=0,this.maxStartRadius=0,this.minEndRadius=0,this.maxEndRadius=0,this.minHorizontalStartRadian=0,this.maxHorizontalStartRadian=0,this.minVerticalStartRadian=0,this.maxVerticalStartRadian=0,this.useEndRadian=!0,this.minHorizontalEndRadian=0,this.maxHorizontalEndRadian=0,this.minVerticalEndRadian=0,this.maxVerticalEndRadian=0,this.minStartColor=new Float32Array([1,1,1,1]),this.maxStartColor=new Float32Array([1,1,1,1]),this.minEndColor=new Float32Array([1,1,1,1]),this.maxEndColor=new Float32Array([1,1,1,1]),this.colorComponentInter=!1,this.disableColor=!1,this.blendState=0,this.emitterType="null",this.emissionRate=0,this.pointEmitterPosition=new Float32Array([0,0,0]),this.pointEmitterPositionVariance=new Float32Array([0,0,0]),this.pointEmitterVelocity=new Float32Array([0,0,0]),this.pointEmitterVelocityAddVariance=new Float32Array([0,0,0]),this.boxEmitterCenterPosition=new Float32Array([0,0,0]),this.boxEmitterSize=new Float32Array([0,0,0]),this.boxEmitterVelocity=new Float32Array([0,0,0]),this.boxEmitterVelocityAddVariance=new Float32Array([0,0,0]),this.sphereEmitterCenterPosition=new Float32Array([0,0,0]),this.sphereEmitterRadius=1,this.sphereEmitterVelocity=0,this.sphereEmitterVelocityAddVariance=0,this.ringEmitterCenterPosition=new Float32Array([0,0,0]),this.ringEmitterRadius=30,this.ringEmitterVelocity=0,this.ringEmitterVelocityAddVariance=0,this.ringEmitterUp=2,this.positionVariance=new Float32Array([0,0,0])}return l(t,null,[{key:"checkSetting",value:function(e){var i;for(i in t._defaultSetting)i in e||(e[i]=t._defaultSetting[i]);e.endVelocity=+e.endVelocity,e.gravity[0]=+e.gravity[0],e.gravity[1]=+e.gravity[1],e.gravity[2]=+e.gravity[2]}}]),t}();h._defaultSetting=new h;var c=function(){function t(){o(this,t)}return l(t,[{key:"addParticleArray",value:function(t,e){}}]),t}(),m=function(){function t(){o(this,t)}return l(t,null,[{key:"Create",value:function(e,i,r,n){var a=new t;a.position=i,s.MathUtil.scaleVector3(r,e.emitterVelocitySensitivity,t._tempVelocity);var o,l=s.MathUtil.lerp(e.minHorizontalVelocity,e.maxHorizontalVelocity,Math.random()),h=Math.random()*Math.PI*2;if(t._tempVelocity[0]+=l*Math.cos(h),t._tempVelocity[2]+=l*Math.sin(h),t._tempVelocity[1]+=s.MathUtil.lerp(e.minVerticalVelocity,e.maxVerticalVelocity,Math.random()),a.velocity=t._tempVelocity,a.startColor=t._tempStartColor,a.endColor=t._tempEndColor,e.disableColor){for(o=0;o<3;o++)a.startColor[o]=1,a.endColor[o]=1;a.startColor[o]=s.MathUtil.lerp(e.minStartColor[o],e.maxStartColor[o],Math.random()),a.endColor[o]=s.MathUtil.lerp(e.minEndColor[o],e.maxEndColor[o],Math.random())}else if(e.colorComponentInter)for(o=0;o<4;o++)a.startColor[o]=s.MathUtil.lerp(e.minStartColor[o],e.maxStartColor[o],Math.random()),a.endColor[o]=s.MathUtil.lerp(e.minEndColor[o],e.maxEndColor[o],Math.random());else s.MathUtil.lerpVector4(e.minStartColor,e.maxStartColor,Math.random(),a.startColor),s.MathUtil.lerpVector4(e.minEndColor,e.maxEndColor,Math.random(),a.endColor);a.sizeRotation=t._tempSizeRotation;var c=Math.random();a.sizeRotation[0]=s.MathUtil.lerp(e.minStartSize,e.maxStartSize,c),a.sizeRotation[1]=s.MathUtil.lerp(e.minEndSize,e.maxEndSize,c),a.sizeRotation[2]=s.MathUtil.lerp(e.minRotateSpeed,e.maxRotateSpeed,Math.random()),a.radius=t._tempRadius;var m=Math.random();a.radius[0]=s.MathUtil.lerp(e.minStartRadius,e.maxStartRadius,m),a.radius[1]=s.MathUtil.lerp(e.minEndRadius,e.maxEndRadius,m),a.radian=t._tempRadian,a.radian[0]=s.MathUtil.lerp(e.minHorizontalStartRadian,e.maxHorizontalStartRadian,Math.random()),a.radian[1]=s.MathUtil.lerp(e.minVerticalStartRadian,e.maxVerticalStartRadian,Math.random());var u=e.useEndRadian;return a.radian[2]=u?s.MathUtil.lerp(e.minHorizontalEndRadian,e.maxHorizontalEndRadian,Math.random()):a.radian[0],a.radian[3]=u?s.MathUtil.lerp(e.minVerticalEndRadian,e.maxVerticalEndRadian,Math.random()):a.radian[1],a.durationAddScale=e.ageAddScale*Math.random(),a.time=n,a}}]),t}();m._tempVelocity=new Float32Array(3),m._tempStartColor=new Float32Array(4),m._tempEndColor=new Float32Array(4),m._tempSizeRotation=new Float32Array(3),m._tempRadius=new Float32Array(2),m._tempRadian=new Float32Array(4);var u=function(t){function e(t){var r;return o(this,e),(r=i(this,n(e).call(this)))._floatCountPerVertex=29,r._firstActiveElement=0,r._firstNewElement=0,r._firstFreeElement=0,r._firstRetiredElement=0,r._currentTime=0,r.settings=t,r}return a(e,c),l(e,[{key:"reUse",value:function(t,e){return 0}},{key:"initialize",value:function(){var t;this._vertices=this._mesh._vb.getFloat32Array(),t=this._mesh._stride/4;for(var e=0,i=0,r=0;r<this.settings.maxPartices;r++){var n,a=Math.random(),o=this.settings.textureCount?1/this.settings.textureCount:1;for(n=0;n<this.settings.textureCount&&!(a<n+o);n+=o);this._vertices[e++]=-1,this._vertices[e++]=-1,this._vertices[e++]=0,this._vertices[e++]=n,e=i+=t,this._vertices[e++]=1,this._vertices[e++]=-1,this._vertices[e++]=1,this._vertices[e++]=n,e=i+=t,this._vertices[e++]=1,this._vertices[e++]=1,this._vertices[e++]=1,this._vertices[e++]=n+o,e=i+=t,this._vertices[e++]=-1,this._vertices[e++]=1,this._vertices[e++]=0,this._vertices[e++]=n+o,e=i+=t}}},{key:"update",value:function(t){this._currentTime+=t/1e3,this.retireActiveParticles(),this.freeRetiredParticles(),this._firstActiveElement==this._firstFreeElement&&(this._currentTime=0),this._firstRetiredElement==this._firstActiveElement&&(this._drawCounter=0)}},{key:"retireActiveParticles",value:function(){for(var t=this.settings.duration;this._firstActiveElement!=this._firstNewElement;){var e=this._firstActiveElement*this._floatCountPerVertex*4,i=e+28,r=this._currentTime-this._vertices[i];if(1e-4+(r*=1+this._vertices[e+27])<t)break;this._vertices[i]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this.settings.maxPartices&&(this._firstActiveElement=0)}}},{key:"freeRetiredParticles",value:function(){for(;this._firstRetiredElement!=this._firstActiveElement&&!(this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*4+28]<3);)this._firstRetiredElement++,this._firstRetiredElement>=this.settings.maxPartices&&(this._firstRetiredElement=0)}},{key:"addNewParticlesToVertexBuffer",value:function(){}},{key:"addParticleArray",value:function(t,e){var i=this._firstFreeElement+1;if(i>=this.settings.maxPartices&&(i=0),i!==this._firstRetiredElement){for(var r=m.Create(this.settings,t,e,this._currentTime),n=this._firstFreeElement*this._floatCountPerVertex*4,a=0;a<4;a++){var o,s;for(o=0,s=4;o<3;o++)this._vertices[n+a*this._floatCountPerVertex+s+o]=r.position[o];for(o=0,s=7;o<3;o++)this._vertices[n+a*this._floatCountPerVertex+s+o]=r.velocity[o];for(o=0,s=10;o<4;o++)this._vertices[n+a*this._floatCountPerVertex+s+o]=r.startColor[o];for(o=0,s=14;o<4;o++)this._vertices[n+a*this._floatCountPerVertex+s+o]=r.endColor[o];for(o=0,s=18;o<3;o++)this._vertices[n+a*this._floatCountPerVertex+s+o]=r.sizeRotation[o];for(o=0,s=21;o<2;o++)this._vertices[n+a*this._floatCountPerVertex+s+o]=r.radius[o];for(o=0,s=23;o<4;o++)this._vertices[n+a*this._floatCountPerVertex+s+o]=r.radian[o];this._vertices[n+a*this._floatCountPerVertex+27]=r.durationAddScale,this._vertices[n+a*this._floatCountPerVertex+28]=r.time}this._firstFreeElement=i}}}]),e}(),d="attribute vec4 a_CornerTextureCoordinate;\r\nattribute vec3 a_Position;\r\nattribute vec3 a_Velocity;\r\nattribute vec4 a_StartColor;\r\nattribute vec4 a_EndColor;\r\nattribute vec3 a_SizeRotation;\r\nattribute vec2 a_Radius;\r\nattribute vec4 a_Radian;\r\nattribute float a_AgeAddScale;\r\nattribute float a_Time;\r\n\r\nvarying vec4 v_Color;\r\nvarying vec2 v_TextureCoordinate;\r\n\r\nuniform float u_CurrentTime;\r\nuniform float u_Duration;\r\nuniform float u_EndVelocity;\r\nuniform vec3 u_Gravity;\r\n\r\nuniform vec2 size;\r\nuniform mat4 u_mmat;\r\n\r\nvec4 ComputeParticlePosition(in vec3 position, in vec3 velocity,in float age,in float normalizedAge)\r\n{\r\n\r\n   float startVelocity = length(velocity);//起始标量速度\r\n   float endVelocity = startVelocity * u_EndVelocity;//结束标量速度\r\n\r\n   float velocityIntegral = startVelocity * normalizedAge +(endVelocity - startVelocity) * normalizedAge *normalizedAge/2.0;//计算当前速度的标量（单位空间），vt=v0*t+(1/2)*a*(t^2)\r\n   \r\n   vec3 addPosition = normalize(velocity) * velocityIntegral * u_Duration;//计算受自身速度影响的位置，转换标量到矢量    \r\n   addPosition += u_Gravity * age * normalizedAge;//计算受重力影响的位置\r\n   \r\n   float radius=mix(a_Radius.x, a_Radius.y, normalizedAge); //计算粒子受半径和角度影响（无需计算角度和半径时，可用宏定义优化屏蔽此计算）\r\n   float radianHorizontal =mix(a_Radian.x,a_Radian.z,normalizedAge);\r\n   float radianVertical =mix(a_Radian.y,a_Radian.w,normalizedAge);\r\n   \r\n   float r =cos(radianVertical)* radius;\r\n   addPosition.y += sin(radianVertical) * radius;\r\n\t\r\n   addPosition.x += cos(radianHorizontal) *r;\r\n   addPosition.z += sin(radianHorizontal) *r;\r\n  \r\n   addPosition.y=-addPosition.y;//2D粒子位置更新需要取负，2D粒子坐标系Y轴正向朝上\r\n   position+=addPosition;\r\n   return  vec4(position,1.0);\r\n}\r\n\r\nfloat ComputeParticleSize(in float startSize,in float endSize, in float normalizedAge)\r\n{    \r\n    float size = mix(startSize, endSize, normalizedAge);\r\n    return size;\r\n}\r\n\r\nmat2 ComputeParticleRotation(in float rot,in float age)\r\n{    \r\n    float rotation =rot * age;\r\n    //计算2x2旋转矩阵.\r\n    float c = cos(rotation);\r\n    float s = sin(rotation);\r\n    return mat2(c, -s, s, c);\r\n}\r\n\r\nvec4 ComputeParticleColor(in vec4 startColor,in vec4 endColor,in float normalizedAge)\r\n{\r\n\tvec4 color=mix(startColor,endColor,normalizedAge);\r\n    //硬编码设置，使粒子淡入很快，淡出很慢,6.7的缩放因子把置归一在0到1之间，可以谷歌x*(1-x)*(1-x)*6.7的制图表\r\n    color.a *= normalizedAge * (1.0-normalizedAge) * (1.0-normalizedAge) * 6.7;\r\n   \r\n    return color;\r\n}\r\n\r\nvoid main()\r\n{\r\n   float age = u_CurrentTime - a_Time;\r\n   age *= 1.0 + a_AgeAddScale;\r\n   float normalizedAge = clamp(age / u_Duration,0.0,1.0);\r\n   gl_Position = ComputeParticlePosition(a_Position, a_Velocity, age, normalizedAge);//计算粒子位置\r\n   float pSize = ComputeParticleSize(a_SizeRotation.x,a_SizeRotation.y, normalizedAge);\r\n   mat2 rotation = ComputeParticleRotation(a_SizeRotation.z, age);\r\n\t\r\n    mat4 mat=u_mmat;\r\n    gl_Position=vec4((mat*gl_Position).xy,0.0,1.0);\r\n    gl_Position.xy += (rotation*a_CornerTextureCoordinate.xy) * pSize*vec2(mat[0][0],mat[1][1]);\r\n    gl_Position=vec4((gl_Position.x/size.x-0.5)*2.0,(0.5-gl_Position.y/size.y)*2.0,0.0,1.0);\r\n   \r\n   v_Color = ComputeParticleColor(a_StartColor,a_EndColor, normalizedAge);\r\n   v_TextureCoordinate =a_CornerTextureCoordinate.zw;\r\n}\r\n\r\n",_="#ifdef GL_FRAGMENT_PRECISION_HIGH\r\nprecision highp float;\r\n#else\r\nprecision mediump float;\r\n#endif\r\n\r\nvarying vec4 v_Color;\r\nvarying vec2 v_TextureCoordinate;\r\nuniform sampler2D u_texture;\r\n\r\nvoid main()\r\n{\t\r\n\tgl_FragColor=texture2D(u_texture,v_TextureCoordinate)*v_Color;\r\n\tgl_FragColor.xyz *= v_Color.w;\r\n}",f=function(t){function e(){return o(this,e),i(this,n(e).call(this,d,_,"ParticleShader",null,["a_CornerTextureCoordinate",0,"a_Position",1,"a_Velocity",2,"a_StartColor",3,"a_EndColor",4,"a_SizeRotation",5,"a_Radius",6,"a_Radian",7,"a_AgeAddScale",8,"a_Time",9]))}return a(e,s.Shader),e}();f.vs=d,f.ps=_;var v=function(t){function e(){var t;return o(this,e),t=i(this,n(e).call(this,0,0)),e.pShader||(e.pShader=new f),t}return a(e,s.Value2D),l(e,[{key:"upload",value:function(){var t=this.size;t[0]=s.RenderState2D.width,t[1]=s.RenderState2D.height,this.alpha=this.ALPHA*s.RenderState2D.worldAlpha,e.pShader.upload(this)}}]),e}();v.pShader=null;var y=function(t){function h(t){var e;o(this,h),(e=i(this,n(h).call(this,t))).x=0,e.y=0,e.sv=new v,e._key={};var a=r(e);return s.ILaya.loader.load(e.settings.textureName,s.Handler.create(null,function(t){a.texture=t}),null,s.Loader.IMAGE),e.sv.u_Duration=e.settings.duration,e.sv.u_Gravity=e.settings.gravity,e.sv.u_EndVelocity=e.settings.endVelocity,e._blendFn=s.BlendMode.fns[t.blendState],e._mesh=s.MeshParticle2D.getAMesh(e.settings.maxPartices),e.initialize(),e}return a(h,u),l(h,[{key:"getRenderType",value:function(){return-111}},{key:"releaseRender",value:function(){}},{key:"addParticleArray",value:function(t,i){t[0]+=this.x,t[1]+=this.y,e(n(h.prototype),"addParticleArray",this).call(this,t,i)}},{key:"addNewParticlesToVertexBuffer",value:function(){var t,e=this._mesh._vb;e.clear(),e.append(this._vertices),this._firstNewElement<this._firstFreeElement?(t=4*this._firstNewElement*this._floatCountPerVertex*4,e.subUpload(t,t,t+4*(this._firstFreeElement-this._firstNewElement)*this._floatCountPerVertex*4)):(t=4*this._firstNewElement*this._floatCountPerVertex*4,e.subUpload(t,t,t+4*(this.settings.maxPartices-this._firstNewElement)*this._floatCountPerVertex*4),this._firstFreeElement>0&&(e.setNeedUpload(),e.subUpload(0,0,4*this._firstFreeElement*this._floatCountPerVertex*4))),this._firstNewElement=this._firstFreeElement}},{key:"renderSubmit",value:function(){if(this.texture&&this.texture.getIsReady()){if(this.update(s.ILaya.timer._delta),this.sv.u_CurrentTime=this._currentTime,this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this.blend(),this._firstActiveElement!=this._firstFreeElement){var t=s.WebGLContext.mainContext;this._mesh.useMesh(t),this.sv.u_texture=this.texture._getSource(),this.sv.upload(),this._firstActiveElement<this._firstFreeElement?t.drawElements(t.TRIANGLES,6*(this._firstFreeElement-this._firstActiveElement),t.UNSIGNED_SHORT,6*this._firstActiveElement*2):(s.WebGLContext.mainContext.drawElements(t.TRIANGLES,6*(this.settings.maxPartices-this._firstActiveElement),t.UNSIGNED_SHORT,6*this._firstActiveElement*2),this._firstFreeElement>0&&t.drawElements(t.TRIANGLES,6*this._firstFreeElement,t.UNSIGNED_SHORT,0)),s.Stat.renderBatches++}this._drawCounter++}return 1}},{key:"updateParticleForNative",value:function(){this.texture&&this.texture.getIsReady()&&(this.update(s.ILaya.timer._delta),this.sv.u_CurrentTime=this._currentTime,this._firstNewElement!=this._firstFreeElement&&(this._firstNewElement=this._firstFreeElement))}},{key:"getMesh",value:function(){return this._mesh}},{key:"getConchMesh",value:function(){return this._conchMesh}},{key:"getFirstNewElement",value:function(){return this._firstNewElement}},{key:"getFirstFreeElement",value:function(){return this._firstFreeElement}},{key:"getFirstActiveElement",value:function(){return this._firstActiveElement}},{key:"getFirstRetiredElement",value:function(){return this._firstRetiredElement}},{key:"setFirstFreeElement",value:function(t){this._firstFreeElement=t}},{key:"setFirstNewElement",value:function(t){this._firstNewElement=t}},{key:"addDrawCounter",value:function(){this._drawCounter++}},{key:"blend",value:function(){if(s.BlendMode.activeBlendFunction!==this._blendFn){var t=s.WebGLContext.mainContext;t.enable(t.BLEND),this._blendFn(t),s.BlendMode.activeBlendFunction=this._blendFn}}},{key:"dispose",value:function(){this._mesh.releaseMesh()}}]),h}();y.activeBlendType=-1;var p=function(){function t(){o(this,t),this._frameTime=0,this._emissionRate=60,this._emissionTime=0,this.minEmissionTime=1/60}return l(t,[{key:"start",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Number.MAX_VALUE;0!=this._emissionRate&&(this._emissionTime=t)}},{key:"stop",value:function(){this._emissionTime=0}},{key:"clear",value:function(){this._emissionTime=0}},{key:"emit",value:function(){}},{key:"advanceTime",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;if(this._emissionTime-=t,!(this._emissionTime<0||(this._frameTime+=t,this._frameTime<this.minEmissionTime)))for(;this._frameTime>this.minEmissionTime;)this._frameTime-=this.minEmissionTime,this.emit()}},{key:"particleTemplate",set:function(t){this._particleTemplate=t}},{key:"emissionRate",set:function(t){t<=0||(this._emissionRate=t,t>0&&(this.minEmissionTime=1/t))},get:function(){return this._emissionRate}}]),t}(),E=function(t){function r(t){var e;return o(this,r),(e=i(this,n(r).call(this))).template=t,e}return a(r,p),l(r,[{key:"emit",value:function(){e(n(r.prototype),"emit",this).call(this),null!=this._emitFun&&this._emitFun()}},{key:"getRandom",value:function(t){return(2*Math.random()-1)*t}},{key:"webGLEmit",value:function(){var t=new Float32Array(3);t[0]=this.getRandom(this._posRange[0]),t[1]=this.getRandom(this._posRange[1]),t[2]=this.getRandom(this._posRange[2]);var e=new Float32Array(3);e[0]=0,e[1]=0,e[2]=0,this._particleTemplate.addParticleArray(t,e)}},{key:"canvasEmit",value:function(){var t=new Float32Array(3);t[0]=this.getRandom(this._posRange[0]),t[1]=this.getRandom(this._posRange[1]),t[2]=this.getRandom(this._posRange[2]);var e=new Float32Array(3);e[0]=0,e[1]=0,e[2]=0,this._particleTemplate.addParticleArray(t,e)}},{key:"template",set:function(t){this._particleTemplate=t,t||(this._emitFun=null,this.setting=null,this._posRange=null),this.setting=t.settings,this._posRange=this.setting.positionVariance,this._particleTemplate instanceof y&&(this._emitFun=this.webGLEmit)},get:function(){return this._particleTemplate}}]),r}(),g=function(t){function r(t){var e;return o(this,r),(e=i(this,n(r).call(this)))._matrix4=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),e.autoPlay=!0,e.customRenderEnable=!0,t&&e.setParticleSetting(t),e}return a(r,s.Sprite),l(r,[{key:"load",value:function(t){s.ILaya.loader.load(t,s.Handler.create(this,this.setParticleSetting),null,s.ILaya.Loader.JSON)}},{key:"setParticleSetting",value:function(t){if(!t)return this.stop();h.checkSetting(t),this.customRenderEnable=!0,this._particleTemplate=new y(t),this.graphics._saveToCmd(null,s.DrawParticleCmd.create(this._particleTemplate)),this._emitter?this._emitter.template=this._particleTemplate:this._emitter=new E(this._particleTemplate),this.autoPlay&&(this.emitter.start(),this.play())}},{key:"play",value:function(){s.ILaya.timer.frameLoop(1,this,this._loop)}},{key:"stop",value:function(){s.ILaya.timer.clear(this,this._loop)}},{key:"_loop",value:function(){this.advanceTime(1/60)}},{key:"advanceTime",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._canvasTemplate&&this._canvasTemplate.advanceTime(t),this._emitter&&this._emitter.advanceTime(t)}},{key:"customRender",value:function(t,e,i){this._matrix4[0]=t._curMat.a,this._matrix4[1]=t._curMat.b,this._matrix4[4]=t._curMat.c,this._matrix4[5]=t._curMat.d,this._matrix4[12]=t._curMat.tx,this._matrix4[13]=t._curMat.ty,this._particleTemplate.sv.u_mmat=this._matrix4,this._canvasTemplate&&this._canvasTemplate.render(t,e,i)}},{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._particleTemplate instanceof y&&this._particleTemplate.dispose(),e(n(r.prototype),"destroy",this).call(this,t)}},{key:"url",set:function(t){this.load(t)}},{key:"emitter",get:function(){return this._emitter}}]),r}();s.ILaya.regClass(g);var x=function(){function t(e,i,r){o(this,t),this._timeLeftOver=0,this._tempVelocity=new Float32Array([0,0,0]),this._tempPosition=new Float32Array([0,0,0]),this._templet=e,this._timeBetweenParticles=1/i,this._previousPosition=r}return l(t,[{key:"update",value:function(t,e){if((t/=1e3)>0){s.MathUtil.subtractVector3(e,this._previousPosition,this._tempVelocity),s.MathUtil.scaleVector3(this._tempVelocity,1/t,this._tempVelocity);for(var i=this._timeLeftOver+t,r=-this._timeLeftOver;i>this._timeBetweenParticles;)r+=this._timeBetweenParticles,i-=this._timeBetweenParticles,s.MathUtil.lerpVector3(this._previousPosition,e,r/t,this._tempPosition),this._templet.addParticleArray(this._tempPosition,this._tempVelocity);this._timeLeftOver=i}this._previousPosition[0]=e[0],this._previousPosition[1]=e[1],this._previousPosition[2]=e[2]}}]),t}();t.Emitter2D=E,t.EmitterBase=p,t.Particle2D=g,t.ParticleData=m,t.ParticleEmitter=x,t.ParticleSetting=h,t.ParticleShader=f,t.ParticleShaderValue=v,t.ParticleTemplate2D=y,t.ParticleTemplateBase=c,t.ParticleTemplateWebGL=u}(window.Laya=window.Laya||{},Laya)}(); 
 			}); 
		define("__plugin__/wx70d8aa25ec591f7a/laya.physics_o.js", function(require, module, exports){ 			
!function(){"use strict";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}function e(i){return(e="function"==typeof Symbol&&"symbol"==t(Symbol.iterator)?function(e){return t(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":t(e)})(i)}function i(t,e,o){return(i="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){var o=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=r(t)););return t}(t,e);if(o){var n=Object.getOwnPropertyDescriptor(o,e);return n.get?n.get.call(i):n.value}})(t,e,o||t)}function o(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function n(t,e,i){return e&&o(t.prototype,e),i&&o(t,i),t}function s(t,i){return!i||"object"!==e(i)&&"function"!=typeof i?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):i}function r(t){return(r=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&function(t,e){(Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}(t,e)}function h(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}!function(t,e){var o=function t(){h(this,t)};o.RigidBody=null,o.Physics=null;var l=function(t){function i(){var t;return h(this,i),(t=s(this,r(i).apply(this,arguments)))._isSensor=!1,t._density=10,t._friction=.2,t._restitution=0,t}return a(i,e.Component),n(i,[{key:"getDef",value:function(){if(!this._def){var t=new window.box2d.b2FixtureDef;t.density=this.density,t.friction=this.friction,t.isSensor=this.isSensor,t.restitution=this.restitution,t.shape=this._shape,this._def=t}return this._def}},{key:"_onEnable",value:function(){this.rigidBody?this.refresh():e.Laya.systemTimer.callLater(this,this._checkRigidBody)}},{key:"_checkRigidBody",value:function(){if(!this.rigidBody){var t=this.owner.getComponent(o.RigidBody);t&&(this.rigidBody=t,this.refresh())}}},{key:"_onDestroy",value:function(){this.rigidBody&&(this.fixture&&(this.fixture.GetBody()==this.rigidBody.body&&this.rigidBody.body.DestroyFixture(this.fixture),this.fixture=null),this.rigidBody=null,this._shape=null,this._def=null)}},{key:"refresh",value:function(){if(this.enabled&&this.rigidBody){var t=this.rigidBody.body;this.fixture&&(this.fixture.GetBody()==this.rigidBody.body&&this.rigidBody.body.DestroyFixture(this.fixture),this.fixture.Destroy(),this.fixture=null);var e=this.getDef();e.filter.groupIndex=this.rigidBody.group,e.filter.categoryBits=this.rigidBody.category,e.filter.maskBits=this.rigidBody.mask,this.fixture=t.CreateFixture(e),this.fixture.collider=this}}},{key:"resetShape",value:function(){!(arguments.length>0&&void 0!==arguments[0])||arguments[0]}},{key:"isSensor",get:function(){return this._isSensor},set:function(t){this._isSensor=t,this._def&&(this._def.isSensor=t,this.refresh())}},{key:"density",get:function(){return this._density},set:function(t){this._density=t,this._def&&(this._def.density=t,this.refresh())}},{key:"friction",get:function(){return this._friction},set:function(t){this._friction=t,this._def&&(this._def.friction=t,this.refresh())}},{key:"restitution",get:function(){return this._restitution},set:function(t){this._restitution=t,this._def&&(this._def.restitution=t,this.refresh())}},{key:"isSingleton",get:function(){return!1}}]),i}();e.ClassUtils.regClass("laya.physics.ColliderBase",l),e.ClassUtils.regClass("Laya.ColliderBase",l);var c=function(t){function i(){var t;return h(this,i),(t=s(this,r(i).apply(this,arguments)))._type="dynamic",t._allowSleep=!0,t._angularVelocity=0,t._angularDamping=0,t._linearVelocity={x:0,y:0},t._linearDamping=0,t._bullet=!1,t._allowRotation=!0,t._gravityScale=1,t.group=0,t.category=1,t.mask=-1,t.label="RigidBody",t}return a(i,e.Component),n(i,[{key:"_createBody",value:function(){if(!this._body&&this.owner){var t=this.owner,i=window.box2d,n=new i.b2BodyDef,s=t.localToGlobal(e.Point.TEMP.setTo(0,0),!1,o.Physics.I.worldRoot);n.position.Set(s.x/o.Physics.PIXEL_RATIO,s.y/o.Physics.PIXEL_RATIO),n.angle=e.Utils.toRadian(t.rotation),n.allowSleep=this._allowSleep,n.angularDamping=this._angularDamping,n.angularVelocity=this._angularVelocity,n.bullet=this._bullet,n.fixedRotation=!this._allowRotation,n.gravityScale=this._gravityScale,n.linearDamping=this._linearDamping;var r=this._linearVelocity;(r&&0!=r.x||0!=r.y)&&(n.linearVelocity=new i.b2Vec2(r.x,r.y)),n.type=i.b2BodyType["b2_"+this._type+"Body"],this._body=o.Physics.I._createBody(n),this.resetCollider(!1)}}},{key:"_onAwake",value:function(){this._createBody()}},{key:"_onEnable",value:function(){var t=this;this._createBody(),e.Laya.physicsTimer.frameLoop(1,this,this._sysPhysicToNode);var i=this.owner;this.accessGetSetFunc(i,"x","set")&&!i._changeByRigidBody&&(i._changeByRigidBody=!0,this._overSet(i,"x",function(e){t.accessGetSetFunc(i,"x","set")(e),t._sysPosToPhysic()}),this._overSet(i,"y",function(e){t.accessGetSetFunc(i,"y","set")(e),t._sysPosToPhysic()}),this._overSet(i,"rotation",function(e){t.accessGetSetFunc(i,"rotation","set")(e),t._sysNodeToPhysic()}),this._overSet(i,"scaleX",function(e){t.accessGetSetFunc(i,"scaleX","set")(e),t.resetCollider(!0)}),this._overSet(i,"scaleY",function(e){t.accessGetSetFunc(i,"scaleY","set")(e),t.resetCollider(!0)}))}},{key:"accessGetSetFunc",value:function(t,e,i){if(-1!==["get","set"].indexOf(i)){var o="_$".concat(i,"_").concat(e);if(t[o])return t[o];for(var n,s=t.constructor;s;){if((n=Object.getOwnPropertyDescriptor(s.prototype,e))&&n[i]){t[o]=n[i].bind(t);break}s=Object.getPrototypeOf(s)}return t[o]}}},{key:"resetCollider",value:function(t){var e=this.owner.getComponents(l);if(e)for(var i=0,o=e.length;i<o;i++){var n=e[i];n.rigidBody=this,t?n.resetShape():n.refresh()}}},{key:"_sysPhysicToNode",value:function(){if("static"!=this.type&&this._body.IsAwake()){var t=this._body.GetPosition(),i=this._body.GetAngle(),n=this.owner;if(this.accessGetSetFunc(n,"rotation","set")(e.Utils.toAngle(i)-n.parent.globalRotation),0==i){var s=n.parent.globalToLocal(e.Point.TEMP.setTo(t.x*o.Physics.PIXEL_RATIO+n.pivotX,t.y*o.Physics.PIXEL_RATIO+n.pivotY),!1,o.Physics.I.worldRoot);this.accessGetSetFunc(n,"x","set")(s.x),this.accessGetSetFunc(n,"y","set")(s.y)}else(s=n.globalToLocal(e.Point.TEMP.setTo(t.x*o.Physics.PIXEL_RATIO,t.y*o.Physics.PIXEL_RATIO),!1,o.Physics.I.worldRoot)).x+=n.pivotX,s.y+=n.pivotY,s=n.toParentPoint(s),this.accessGetSetFunc(n,"x","set")(s.x),this.accessGetSetFunc(n,"y","set")(s.y)}}},{key:"_sysNodeToPhysic",value:function(){var t=this.owner;this._body.SetAngle(e.Utils.toRadian(t.rotation));var i=t.localToGlobal(e.Point.TEMP.setTo(0,0),!1,o.Physics.I.worldRoot);this._body.SetPositionXY(i.x/o.Physics.PIXEL_RATIO,i.y/o.Physics.PIXEL_RATIO)}},{key:"_sysPosToPhysic",value:function(){var t=this.owner.localToGlobal(e.Point.TEMP.setTo(0,0),!1,o.Physics.I.worldRoot);this._body.SetPositionXY(t.x/o.Physics.PIXEL_RATIO,t.y/o.Physics.PIXEL_RATIO)}},{key:"_overSet",value:function(t,e,i){Object.defineProperty(t,e,{get:this.accessGetSetFunc(t,e,"get"),set:i,enumerable:!1,configurable:!0})}},{key:"_onDisable",value:function(){e.Laya.physicsTimer.clear(this,this._sysPhysicToNode),o.Physics.I._removeBody(this._body),this._body=null;var t=this.owner;t._changeByRigidBody&&(this._overSet(t,"x",this.accessGetSetFunc(t,"x","set")),this._overSet(t,"y",this.accessGetSetFunc(t,"y","set")),this._overSet(t,"rotation",this.accessGetSetFunc(t,"rotation","set")),this._overSet(t,"scaleX",this.accessGetSetFunc(t,"scaleX","set")),this._overSet(t,"scaleY",this.accessGetSetFunc(t,"scaleY","set")),t._changeByRigidBody=!1)}},{key:"getBody",value:function(){return this._body||this._onAwake(),this._body}},{key:"applyForce",value:function(t,e){this._body||this._onAwake(),this._body.ApplyForce(e,t)}},{key:"applyForceToCenter",value:function(t){this._body||this._onAwake(),this._body.ApplyForceToCenter(t)}},{key:"applyLinearImpulse",value:function(t,e){this._body||this._onAwake(),this._body.ApplyLinearImpulse(e,t)}},{key:"applyLinearImpulseToCenter",value:function(t){this._body||this._onAwake(),this._body.ApplyLinearImpulseToCenter(t)}},{key:"applyTorque",value:function(t){this._body||this._onAwake(),this._body.ApplyTorque(t)}},{key:"setVelocity",value:function(t){this._body||this._onAwake(),this._body.SetLinearVelocity(t)}},{key:"setAngle",value:function(t){this._body||this._onAwake(),this._body.SetAngle(t),this._body.SetAwake(!0)}},{key:"getMass",value:function(){return this._body?this._body.GetMass():0}},{key:"getCenter",value:function(){this._body||this._onAwake();var t=this._body.GetLocalCenter();return t.x=t.x*o.Physics.PIXEL_RATIO,t.y=t.y*o.Physics.PIXEL_RATIO,t}},{key:"getWorldCenter",value:function(){this._body||this._onAwake();var t=this._body.GetWorldCenter();return t.x=t.x*o.Physics.PIXEL_RATIO,t.y=t.y*o.Physics.PIXEL_RATIO,t}},{key:"body",get:function(){return this._body||this._onAwake(),this._body}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._body&&this._body.SetType(window.box2d.b2BodyType["b2_"+this._type+"Body"])}},{key:"gravityScale",get:function(){return this._gravityScale},set:function(t){this._gravityScale=t,this._body&&this._body.SetGravityScale(t)}},{key:"allowRotation",get:function(){return this._allowRotation},set:function(t){this._allowRotation=t,this._body&&this._body.SetFixedRotation(!t)}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(t){this._allowSleep=t,this._body&&this._body.SetSleepingAllowed(t)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(t){this._angularDamping=t,this._body&&this._body.SetAngularDamping(t)}},{key:"angularVelocity",get:function(){return this._body?this._body.GetAngularVelocity():this._angularVelocity},set:function(t){this._angularVelocity=t,this._body&&this._body.SetAngularVelocity(t)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(t){this._linearDamping=t,this._body&&this._body.SetLinearDamping(t)}},{key:"linearVelocity",get:function(){if(this._body){var t=this._body.GetLinearVelocity();return{x:t.x,y:t.y}}return this._linearVelocity},set:function(t){t&&(t instanceof Array&&(t={x:t[0],y:t[1]}),this._linearVelocity=t,this._body&&this._body.SetLinearVelocity(new window.box2d.b2Vec2(t.x,t.y)))}},{key:"bullet",get:function(){return this._bullet},set:function(t){this._bullet=t,this._body&&this._body.SetBullet(t)}}]),i}();e.ClassUtils.regClass("laya.physics.RigidBody",c),e.ClassUtils.regClass("Laya.RigidBody",c);var y=function(t){function i(){var t;return h(this,i),(t=s(this,r(i).call(this))).box2d=window.box2d,t.velocityIterations=8,t.positionIterations=3,t._eventList=[],t}return a(i,e.EventDispatcher),n(i,[{key:"start",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!this._enabled){this._enabled=!0,t||(t={});var o=window.box2d;if(null==o)return void console.error("Can not find box2d libs, you should reuqest box2d.js first.");var n=new o.b2Vec2(0,t.gravity||500/i.PIXEL_RATIO);this.world=new o.b2World(n),this.world.SetContactListener(new u),this.allowSleeping=null==t.allowSleeping||t.allowSleeping,t.customUpdate||e.Laya.physicsTimer.frameLoop(1,this,this._update),this._emptyBody=this._createBody(new window.box2d.b2BodyDef)}}},{key:"_update",value:function(){this.world.Step(1/60,this.velocityIterations,this.positionIterations,3);var t=this._eventList.length;if(t>0){for(var e=0;e<t;e+=2)this._sendEvent(this._eventList[e],this._eventList[e+1]);this._eventList.length=0}}},{key:"_sendEvent",value:function(t,o){var n=o.GetFixtureA().collider,s=o.GetFixtureB().collider,r=n.owner,a=s.owner;if(o.getHitInfo=function(){var t=new this.box2d.b2WorldManifold;this.GetWorldManifold(t);var e=t.points[0];return e.x*=i.PIXEL_RATIO,e.y*=i.PIXEL_RATIO,t},r){var h=[s,n,o];0===t?(r.event(e.Event.TRIGGER_ENTER,h),r._triggered?r.event(e.Event.TRIGGER_STAY,h):r._triggered=!0):(r._triggered=!1,r.event(e.Event.TRIGGER_EXIT,h))}a&&(h=[n,s,o],0===t?(a.event(e.Event.TRIGGER_ENTER,h),a._triggered?a.event(e.Event.TRIGGER_STAY,h):a._triggered=!0):(a._triggered=!1,a.event(e.Event.TRIGGER_EXIT,h)))}},{key:"_createBody",value:function(t){return this.world?this.world.CreateBody(t):(console.error('The physical engine should be initialized first.use "Physics.enable()"'),null)}},{key:"_removeBody",value:function(t){this.world?this.world.DestroyBody(t):console.error('The physical engine should be initialized first.use "Physics.enable()"')}},{key:"_createJoint",value:function(t){return this.world?this.world.CreateJoint(t):(console.error('The physical engine should be initialized first.use "Physics.enable()"'),null)}},{key:"_removeJoint",value:function(t){this.world?this.world.DestroyJoint(t):console.error('The physical engine should be initialized first.use "Physics.enable()"')}},{key:"stop",value:function(){e.Laya.physicsTimer.clear(this,this._update)}},{key:"getBodyCount",value:function(){return this.world.GetBodyCount()}},{key:"getContactCount",value:function(){return this.world.GetContactCount()}},{key:"getJointCount",value:function(){return this.world.GetJointCount()}},{key:"allowSleeping",get:function(){return this.world.GetAllowSleeping()},set:function(t){this.world.SetAllowSleeping(t)}},{key:"gravity",get:function(){return this.world.GetGravity()},set:function(t){this.world.SetGravity(t)}},{key:"worldRoot",get:function(){return this._worldRoot||e.Laya.stage},set:function(t){if(this._worldRoot=t,t){var o=t.localToGlobal(e.Point.TEMP.setTo(0,0));this.world.ShiftOrigin({x:o.x/i.PIXEL_RATIO,y:o.y/i.PIXEL_RATIO})}}}],[{key:"enable",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;i.I.start(t),o.RigidBody=c,o.Physics=this}},{key:"I",get:function(){return i._I||(i._I=new i)}}]),i}();y.PIXEL_RATIO=50,e.ClassUtils.regClass("laya.physics.Physics",y),e.ClassUtils.regClass("Laya.Physics",y);var u=function(){function t(){h(this,t)}return n(t,[{key:"BeginContact",value:function(t){y.I._eventList.push(0,t)}},{key:"EndContact",value:function(t){y.I._eventList.push(1,t)}},{key:"PreSolve",value:function(t,e){}},{key:"PostSolve",value:function(t,e){}}]),t}(),_=function(t){function e(){var t;return h(this,e),(t=s(this,r(e).apply(this,arguments)))._x=0,t._y=0,t._width=100,t._height=100,t}return a(e,l),n(e,[{key:"getDef",value:function(){return this._shape||(this._shape=new window.box2d.b2PolygonShape,this._setShape(!1)),this.label=this.label||"BoxCollider",i(r(e.prototype),"getDef",this).call(this)}},{key:"_setShape",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=this.owner.scaleX||1,i=this.owner.scaleY||1;this._shape.SetAsBox(this._width/2/y.PIXEL_RATIO*e,this._height/2/y.PIXEL_RATIO*i,new window.box2d.b2Vec2((this._width/2+this._x)/y.PIXEL_RATIO*e,(this._height/2+this._y)/y.PIXEL_RATIO*i)),t&&this.refresh()}},{key:"resetShape",value:function(){!(arguments.length>0&&void 0!==arguments[0])||arguments[0],this._setShape()}},{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._shape&&this._setShape()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._shape&&this._setShape()}},{key:"width",get:function(){return this._width},set:function(t){if(t<=0)throw"BoxCollider size cannot be less than 0";this._width=t,this._shape&&this._setShape()}},{key:"height",get:function(){return this._height},set:function(t){if(t<=0)throw"BoxCollider size cannot be less than 0";this._height=t,this._shape&&this._setShape()}}]),e}();e.ClassUtils.regClass("laya.physics.BoxCollider",_),e.ClassUtils.regClass("Laya.BoxCollider",_);var d=function(t){function e(){var t;return h(this,e),(t=s(this,r(e).apply(this,arguments)))._x=0,t._y=0,t._points="0,0,100,0",t._loop=!1,t}return a(e,l),n(e,[{key:"getDef",value:function(){return this._shape||(this._shape=new window.box2d.b2ChainShape,this._setShape(!1)),this.label=this.label||"ChainCollider",i(r(e.prototype),"getDef",this).call(this)}},{key:"_setShape",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=this._points.split(","),i=e.length;if(i%2==1)throw"ChainCollider points lenth must a multiplier of 2";for(var o=[],n=0,s=i;n<s;n+=2)o.push(new window.box2d.b2Vec2((this._x+parseInt(e[n]))/y.PIXEL_RATIO,(this._y+parseInt(e[n+1]))/y.PIXEL_RATIO));this._loop?this._shape.CreateLoop(o,i/2):this._shape.CreateChain(o,i/2),t&&this.refresh()}},{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._shape&&this._setShape()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._shape&&this._setShape()}},{key:"points",get:function(){return this._points},set:function(t){if(!t)throw"ChainCollider points cannot be empty";this._points=t,this._shape&&this._setShape()}},{key:"loop",get:function(){return this._loop},set:function(t){this._loop=t,this._shape&&this._setShape()}}]),e}();e.ClassUtils.regClass("laya.physics.ChainCollider",d),e.ClassUtils.regClass("Laya.ChainCollider",d);var f=function(t){function e(){var t;return h(this,e),(t=s(this,r(e).apply(this,arguments)))._x=0,t._y=0,t._radius=50,t}return a(e,l),n(e,[{key:"getDef",value:function(){return this._shape||(this._shape=new window.box2d.b2CircleShape,this._setShape(!1)),this.label=this.label||"CircleCollider",i(r(e.prototype),"getDef",this).call(this)}},{key:"_setShape",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=this.owner.scaleX||1;this._shape.m_radius=this._radius/y.PIXEL_RATIO*e,this._shape.m_p.Set((this._radius+this._x)/y.PIXEL_RATIO*e,(this._radius+this._y)/y.PIXEL_RATIO*e),t&&this.refresh()}},{key:"resetShape",value:function(){!(arguments.length>0&&void 0!==arguments[0])||arguments[0],this._setShape()}},{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._shape&&this._setShape()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._shape&&this._setShape()}},{key:"radius",get:function(){return this._radius},set:function(t){if(t<=0)throw"CircleCollider radius cannot be less than 0";this._radius=t,this._shape&&this._setShape()}}]),e}();e.ClassUtils.regClass("laya.physics.CircleCollider",f),e.ClassUtils.regClass("Laya.CircleCollider",f);var p=function(t){function o(){var t;return h(this,o),(t=s(this,r(o).call(this))).m_drawFlags=99,o._inited||(o._inited=!0,o.init()),t._camera={},t._camera.m_center=new o.box2d.b2Vec2(0,0),t._camera.m_extent=25,t._camera.m_zoom=1,t._camera.m_width=1280,t._camera.m_height=800,t._mG=new e.Graphics,t.graphics=t._mG,t._textSp=new e.Sprite,t._textG=t._textSp.graphics,t.addChild(t._textSp),t}return a(o,e.Sprite),n(o,[{key:"render",value:function(t,e,n){this._renderToGraphic(),i(r(o.prototype),"render",this).call(this,t,e,n)}},{key:"_renderToGraphic",value:function(){this.world&&(this._textG.clear(),this._mG.clear(),this._mG.save(),this._mG.scale(y.PIXEL_RATIO,y.PIXEL_RATIO),this.lineWidth=1/y.PIXEL_RATIO,this.world.DrawDebugData(),this._mG.restore())}},{key:"SetFlags",value:function(t){this.m_drawFlags=t}},{key:"GetFlags",value:function(){return this.m_drawFlags}},{key:"AppendFlags",value:function(t){this.m_drawFlags|=t}},{key:"ClearFlags",value:function(t){this.m_drawFlags&=~t}},{key:"PushTransform",value:function(t){this._mG.save(),this._mG.translate(t.p.x,t.p.y),this._mG.rotate(t.q.GetAngle())}},{key:"PopTransform",value:function(t){this._mG.restore()}},{key:"DrawPolygon",value:function(t,e,i){var o,n;for(t.length,n=[],o=0;o<e;o++)n.push(t[o].x,t[o].y);this._mG.drawPoly(0,0,n,null,i.MakeStyleString(1),this.lineWidth)}},{key:"DrawSolidPolygon",value:function(t,e,i){var o,n;for(t.length,n=[],o=0;o<e;o++)n.push(t[o].x,t[o].y);this._mG.drawPoly(0,0,n,i.MakeStyleString(.5),i.MakeStyleString(1),this.lineWidth)}},{key:"DrawCircle",value:function(t,e,i){this._mG.drawCircle(t.x,t.y,e,null,i.MakeStyleString(1),this.lineWidth)}},{key:"DrawSolidCircle",value:function(t,e,i,o){var n=t.x,s=t.y;this._mG.drawCircle(n,s,e,o.MakeStyleString(.5),o.MakeStyleString(1),this.lineWidth),this._mG.drawLine(n,s,n+i.x*e,s+i.y*e,o.MakeStyleString(1),this.lineWidth)}},{key:"DrawParticles",value:function(t,e,i,o){if(null!==i)for(var n=0;n<o;++n){var s=t[n],r=i[n];this._mG.drawCircle(s.x,s.y,e,r.MakeStyleString(),null,this.lineWidth)}else for(n=0;n<o;++n)s=t[n],this._mG.drawCircle(s.x,s.y,e,"#ffff00",null,this.lineWidth)}},{key:"DrawSegment",value:function(t,e,i){this._mG.drawLine(t.x,t.y,e.x,e.y,i.MakeStyleString(1),this.lineWidth)}},{key:"DrawTransform",value:function(t){this.PushTransform(t),this._mG.drawLine(0,0,1,0,o.box2d.b2Color.RED.MakeStyleString(1),this.lineWidth),this._mG.drawLine(0,0,0,1,o.box2d.b2Color.GREEN.MakeStyleString(1),this.lineWidth),this.PopTransform(t)}},{key:"DrawPoint",value:function(t,e,i){e*=this._camera.m_zoom;var o=(e/=this._camera.m_extent)/2;this._mG.drawRect(t.x-o,t.y-o,e,e,i.MakeStyleString(),null)}},{key:"DrawString",value:function(t,e,i){this._textG.fillText(i,t,e,"15px DroidSans",o.DrawString_s_color.MakeStyleString(),"left")}},{key:"DrawStringWorld",value:function(t,e,i){this.DrawString(t,e,i)}},{key:"DrawAABB",value:function(t,e){var i=t.lowerBound.x,o=t.lowerBound.y,n=t.upperBound.x-t.lowerBound.x,s=t.upperBound.y-t.lowerBound.y;this._mG.drawRect(i,o,n,s,null,e.MakeStyleString(),this.lineWidth)}}],[{key:"init",value:function(){o.box2d=e.Browser.window.box2d,o.DrawString_s_color=new o.box2d.b2Color(.9,.6,.6),o.DrawStringWorld_s_p=new o.box2d.b2Vec2,o.DrawStringWorld_s_cc=new o.box2d.b2Vec2,o.DrawStringWorld_s_color=new o.box2d.b2Color(.5,.9,.5)}},{key:"enable",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:99;if(!o.I){var i=new o;i.world=y.I.world,i.world.SetDebugDraw(i),i.zOrder=1e3,i.m_drawFlags=t,e.Laya.stage.addChild(i),o.I=i}return i}}]),o}();p._inited=!1,e.ClassUtils.regClass("laya.physics.PhysicsDebugDraw",p),e.ClassUtils.regClass("Laya.PhysicsDebugDraw",p);var g=function(t){function e(){var t;return h(this,e),(t=s(this,r(e).apply(this,arguments)))._x=0,t._y=0,t._points="50,0,100,100,0,100",t}return a(e,l),n(e,[{key:"getDef",value:function(){return this._shape||(this._shape=new window.box2d.b2PolygonShape,this._setShape(!1)),this.label=this.label||"PolygonCollider",i(r(e.prototype),"getDef",this).call(this)}},{key:"_setShape",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=this._points.split(","),i=e.length;if(i<6)throw"PolygonCollider points must be greater than 3";if(i%2==1)throw"PolygonCollider points lenth must a multiplier of 2";for(var o=[],n=0,s=i;n<s;n+=2)o.push(new window.box2d.b2Vec2((this._x+parseInt(e[n]))/y.PIXEL_RATIO,(this._y+parseInt(e[n+1]))/y.PIXEL_RATIO));this._shape.Set(o,i/2),t&&this.refresh()}},{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._shape&&this._setShape()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._shape&&this._setShape()}},{key:"points",get:function(){return this._points},set:function(t){if(!t)throw"PolygonCollider points cannot be empty";this._points=t,this._shape&&this._setShape()}}]),e}();e.ClassUtils.regClass("laya.physics.PolygonCollider",g),e.ClassUtils.regClass("Laya.PolygonCollider",g);var w=function(t){function i(){return h(this,i),s(this,r(i).apply(this,arguments))}return a(i,e.Component),n(i,[{key:"_onEnable",value:function(){this._createJoint()}},{key:"_onAwake",value:function(){this._createJoint()}},{key:"_createJoint",value:function(){}},{key:"_onDisable",value:function(){this._joint&&(y.I._removeJoint(this._joint),this._joint=null)}},{key:"joint",get:function(){return this._joint||this._createJoint(),this._joint}}]),i}();e.ClassUtils.regClass("laya.physics.joint.JointBase",w),e.ClassUtils.regClass("Laya.JointBase",w);var b=function(t){function e(){var t;return h(this,e),(t=s(this,r(e).apply(this,arguments))).selfAnchor=[0,0],t.otherAnchor=[0,0],t.collideConnected=!1,t._length=0,t._frequency=0,t._damping=0,t}return a(e,w),n(e,[{key:"_createJoint",value:function(){if(!this._joint){if(this.selfBody=this.selfBody||this.owner.getComponent(c),!this.selfBody)throw"selfBody can not be empty";var t=window.box2d,i=e._temp||(e._temp=new t.b2DistanceJointDef);i.bodyA=this.otherBody?this.otherBody.getBody():y.I._emptyBody,i.bodyB=this.selfBody.getBody(),i.localAnchorA.Set(this.otherAnchor[0]/y.PIXEL_RATIO,this.otherAnchor[1]/y.PIXEL_RATIO),i.localAnchorB.Set(this.selfAnchor[0]/y.PIXEL_RATIO,this.selfAnchor[1]/y.PIXEL_RATIO),i.frequencyHz=this._frequency,i.dampingRatio=this._damping,i.collideConnected=this.collideConnected;var o=i.bodyA.GetWorldPoint(i.localAnchorA,new t.b2Vec2),n=i.bodyB.GetWorldPoint(i.localAnchorB,new t.b2Vec2);i.length=this._length/y.PIXEL_RATIO||t.b2Vec2.SubVV(n,o,new t.b2Vec2).Length(),this._joint=y.I._createJoint(i)}}},{key:"length",get:function(){return this._length},set:function(t){this._length=t,this._joint&&this._joint.SetLength(t/y.PIXEL_RATIO)}},{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.SetFrequency(t)}},{key:"damping",get:function(){return this._damping},set:function(t){this._damping=t,this._joint&&this._joint.SetDampingRatio(t)}}]),e}();e.ClassUtils.regClass("laya.physics.joint.DistanceJoint",b),e.ClassUtils.regClass("Laya.DistanceJoint",b);var m=function(t){function e(){var t;return h(this,e),(t=s(this,r(e).apply(this,arguments))).collideConnected=!1,t._ratio=1,t}return a(e,w),n(e,[{key:"_createJoint",value:function(){if(!this._joint){if(!this.joint1)throw"Joint1 can not be empty";if(!this.joint2)throw"Joint2 can not be empty";var t=window.box2d,i=e._temp||(e._temp=new t.b2GearJointDef);i.bodyA=this.joint1.owner.getComponent(c).getBody(),i.bodyB=this.joint2.owner.getComponent(c).getBody(),i.joint1=this.joint1.joint,i.joint2=this.joint2.joint,i.ratio=this._ratio,i.collideConnected=this.collideConnected,this._joint=y.I._createJoint(i)}}},{key:"ratio",get:function(){return this._ratio},set:function(t){this._ratio=t,this._joint&&this._joint.SetRatio(t)}}]),e}();e.ClassUtils.regClass("laya.physics.joint.GearJoint",m),e.ClassUtils.regClass("Laya.GearJoint",m);var v=function(t){function e(){var t;return h(this,e),(t=s(this,r(e).apply(this,arguments))).collideConnected=!1,t._linearOffset=[0,0],t._angularOffset=0,t._maxForce=1e3,t._maxTorque=1e3,t._correctionFactor=.3,t}return a(e,w),n(e,[{key:"_createJoint",value:function(){if(!this._joint){if(!this.otherBody)throw"otherBody can not be empty";if(this.selfBody=this.selfBody||this.owner.getComponent(c),!this.selfBody)throw"selfBody can not be empty";var t=window.box2d,i=e._temp||(e._temp=new t.b2MotorJointDef);i.Initialize(this.otherBody.getBody(),this.selfBody.getBody()),i.linearOffset=new t.b2Vec2(this._linearOffset[0]/y.PIXEL_RATIO,this._linearOffset[1]/y.PIXEL_RATIO),i.angularOffset=this._angularOffset,i.maxForce=this._maxForce,i.maxTorque=this._maxTorque,i.correctionFactor=this._correctionFactor,i.collideConnected=this.collideConnected,this._joint=y.I._createJoint(i)}}},{key:"linearOffset",get:function(){return this._linearOffset},set:function(t){this._linearOffset=t,this._joint&&this._joint.SetLinearOffset(new window.box2d.b2Vec2(t[0]/y.PIXEL_RATIO,t[1]/y.PIXEL_RATIO))}},{key:"angularOffset",get:function(){return this._angularOffset},set:function(t){this._angularOffset=t,this._joint&&this._joint.SetAngularOffset(t)}},{key:"maxForce",get:function(){return this._maxForce},set:function(t){this._maxForce=t,this._joint&&this._joint.SetMaxForce(t)}},{key:"maxTorque",get:function(){return this._maxTorque},set:function(t){this._maxTorque=t,this._joint&&this._joint.SetMaxTorque(t)}},{key:"correctionFactor",get:function(){return this._correctionFactor},set:function(t){this._correctionFactor=t,this._joint&&this._joint.SetCorrectionFactor(t)}}]),e}();e.ClassUtils.regClass("laya.physics.joint.MotorJoint",v),e.ClassUtils.regClass("Laya.MotorJoint",v);var S=function(t){function o(){var t;return h(this,o),(t=s(this,r(o).apply(this,arguments)))._maxForce=1e4,t._frequency=5,t._damping=.7,t}return a(o,w),n(o,[{key:"_onEnable",value:function(){this.owner.on(e.Event.MOUSE_DOWN,this,this.onMouseDown)}},{key:"_onAwake",value:function(){}},{key:"onMouseDown",value:function(){this._createJoint(),e.Laya.stage.on(e.Event.MOUSE_MOVE,this,this.onMouseMove),e.Laya.stage.once(e.Event.MOUSE_UP,this,this.onStageMouseUp)}},{key:"_createJoint",value:function(){if(!this._joint){if(this.selfBody=this.selfBody||this.owner.getComponent(c),!this.selfBody)throw"selfBody can not be empty";var t=window.box2d,i=o._temp||(o._temp=new t.b2MouseJointDef);if(this.anchor)var n=this.selfBody.owner.localToGlobal(e.Point.TEMP.setTo(this.anchor[0],this.anchor[1]),!1,y.I.worldRoot);else n=y.I.worldRoot.globalToLocal(e.Point.TEMP.setTo(e.Laya.stage.mouseX,e.Laya.stage.mouseY));var s=new t.b2Vec2(n.x/y.PIXEL_RATIO,n.y/y.PIXEL_RATIO);i.bodyA=y.I._emptyBody,i.bodyB=this.selfBody.getBody(),i.target=s,i.frequencyHz=this._frequency,i.damping=this._damping,i.maxForce=this._maxForce,this._joint=y.I._createJoint(i)}}},{key:"onStageMouseUp",value:function(){e.Laya.stage.off(e.Event.MOUSE_MOVE,this,this.onMouseMove),i(r(o.prototype),"_onDisable",this).call(this)}},{key:"onMouseMove",value:function(){this._joint.SetTarget(new window.box2d.b2Vec2(y.I.worldRoot.mouseX/y.PIXEL_RATIO,y.I.worldRoot.mouseY/y.PIXEL_RATIO))}},{key:"_onDisable",value:function(){this.owner.off(e.Event.MOUSE_DOWN,this,this.onMouseDown),i(r(o.prototype),"_onDisable",this).call(this)}},{key:"maxForce",get:function(){return this._maxForce},set:function(t){this._maxForce=t,this._joint&&this._joint.SetMaxForce(t)}},{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.SetFrequency(t)}},{key:"damping",get:function(){return this._damping},set:function(t){this._damping=t,this._joint&&this._joint.SetDampingRatio(t)}}]),o}();e.ClassUtils.regClass("laya.physics.joint.MouseJoint",S),e.ClassUtils.regClass("Laya.MouseJoint",S);var I=function(t){function i(){var t;return h(this,i),(t=s(this,r(i).apply(this,arguments))).anchor=[0,0],t.axis=[1,0],t.collideConnected=!1,t._enableMotor=!1,t._motorSpeed=0,t._maxMotorForce=1e4,t._enableLimit=!1,t._lowerTranslation=0,t._upperTranslation=0,t}return a(i,w),n(i,[{key:"_createJoint",value:function(){if(!this._joint){if(this.selfBody=this.selfBody||this.owner.getComponent(c),!this.selfBody)throw"selfBody can not be empty";var t=window.box2d,o=i._temp||(i._temp=new t.b2PrismaticJointDef),n=this.selfBody.owner.localToGlobal(e.Point.TEMP.setTo(this.anchor[0],this.anchor[1]),!1,y.I.worldRoot),s=new t.b2Vec2(n.x/y.PIXEL_RATIO,n.y/y.PIXEL_RATIO);o.Initialize(this.otherBody?this.otherBody.getBody():y.I._emptyBody,this.selfBody.getBody(),s,new t.b2Vec2(this.axis[0],this.axis[1])),o.enableMotor=this._enableMotor,o.motorSpeed=this._motorSpeed,o.maxMotorForce=this._maxMotorForce,o.enableLimit=this._enableLimit,o.lowerTranslation=this._lowerTranslation/y.PIXEL_RATIO,o.upperTranslation=this._upperTranslation/y.PIXEL_RATIO,o.collideConnected=this.collideConnected,this._joint=y.I._createJoint(o)}}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(t){this._enableMotor=t,this._joint&&this._joint.EnableMotor(t)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(t){this._motorSpeed=t,this._joint&&this._joint.SetMotorSpeed(t)}},{key:"maxMotorForce",get:function(){return this._maxMotorForce},set:function(t){this._maxMotorForce=t,this._joint&&this._joint.SetMaxMotorForce(t)}},{key:"enableLimit",get:function(){return this._enableLimit},set:function(t){this._enableLimit=t,this._joint&&this._joint.EnableLimit(t)}},{key:"lowerTranslation",get:function(){return this._lowerTranslation},set:function(t){this._lowerTranslation=t,this._joint&&this._joint.SetLimits(t,this._upperTranslation)}},{key:"upperTranslation",get:function(){return this._upperTranslation},set:function(t){this._upperTranslation=t,this._joint&&this._joint.SetLimits(this._lowerTranslation,t)}}]),i}();e.ClassUtils.regClass("laya.physics.joint.PrismaticJoint",I),e.ClassUtils.regClass("Laya.PrismaticJoint",I);var x=function(t){function i(){var t;return h(this,i),(t=s(this,r(i).apply(this,arguments))).selfAnchor=[0,0],t.otherAnchor=[0,0],t.selfGroundPoint=[0,0],t.otherGroundPoint=[0,0],t.ratio=1.5,t.collideConnected=!1,t}return a(i,w),n(i,[{key:"_createJoint",value:function(){if(!this._joint){if(!this.otherBody)throw"otherBody can not be empty";if(this.selfBody=this.selfBody||this.owner.getComponent(c),!this.selfBody)throw"selfBody can not be empty";var t=window.box2d,o=i._temp||(i._temp=new t.b2PulleyJointDef),n=this.otherBody.owner.localToGlobal(e.Point.TEMP.setTo(this.otherAnchor[0],this.otherAnchor[1]),!1,y.I.worldRoot),s=new t.b2Vec2(n.x/y.PIXEL_RATIO,n.y/y.PIXEL_RATIO),r=this.selfBody.owner.localToGlobal(e.Point.TEMP.setTo(this.selfAnchor[0],this.selfAnchor[1]),!1,y.I.worldRoot),a=new t.b2Vec2(r.x/y.PIXEL_RATIO,r.y/y.PIXEL_RATIO),h=this.otherBody.owner.localToGlobal(e.Point.TEMP.setTo(this.otherGroundPoint[0],this.otherGroundPoint[1]),!1,y.I.worldRoot),l=new t.b2Vec2(h.x/y.PIXEL_RATIO,h.y/y.PIXEL_RATIO),u=this.selfBody.owner.localToGlobal(e.Point.TEMP.setTo(this.selfGroundPoint[0],this.selfGroundPoint[1]),!1,y.I.worldRoot),_=new t.b2Vec2(u.x/y.PIXEL_RATIO,u.y/y.PIXEL_RATIO);o.Initialize(this.otherBody.getBody(),this.selfBody.getBody(),l,_,s,a,this.ratio),o.collideConnected=this.collideConnected,this._joint=y.I._createJoint(o)}}}]),i}();e.ClassUtils.regClass("laya.physics.joint.PulleyJoint",x),e.ClassUtils.regClass("Laya.PulleyJoint",x);var C=function(t){function i(){var t;return h(this,i),(t=s(this,r(i).apply(this,arguments))).anchor=[0,0],t.collideConnected=!1,t._enableMotor=!1,t._motorSpeed=0,t._maxMotorTorque=1e4,t._enableLimit=!1,t._lowerAngle=0,t._upperAngle=0,t}return a(i,w),n(i,[{key:"_createJoint",value:function(){if(!this._joint){if(this.selfBody=this.selfBody||this.owner.getComponent(c),!this.selfBody)throw"selfBody can not be empty";var t=window.box2d,o=i._temp||(i._temp=new t.b2RevoluteJointDef),n=this.selfBody.owner.localToGlobal(e.Point.TEMP.setTo(this.anchor[0],this.anchor[1]),!1,y.I.worldRoot),s=new t.b2Vec2(n.x/y.PIXEL_RATIO,n.y/y.PIXEL_RATIO);o.Initialize(this.otherBody?this.otherBody.getBody():y.I._emptyBody,this.selfBody.getBody(),s),o.enableMotor=this._enableMotor,o.motorSpeed=this._motorSpeed,o.maxMotorTorque=this._maxMotorTorque,o.enableLimit=this._enableLimit,o.lowerAngle=this._lowerAngle,o.upperAngle=this._upperAngle,o.collideConnected=this.collideConnected,this._joint=y.I._createJoint(o)}}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(t){this._enableMotor=t,this._joint&&this._joint.EnableMotor(t)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(t){this._motorSpeed=t,this._joint&&this._joint.SetMotorSpeed(t)}},{key:"maxMotorTorque",get:function(){return this._maxMotorTorque},set:function(t){this._maxMotorTorque=t,this._joint&&this._joint.SetMaxMotorTorque(t)}},{key:"enableLimit",get:function(){return this._enableLimit},set:function(t){this._enableLimit=t,this._joint&&this._joint.EnableLimit(t)}},{key:"lowerAngle",get:function(){return this._lowerAngle},set:function(t){this._lowerAngle=t,this._joint&&this._joint.SetLimits(t,this._upperAngle)}},{key:"upperAngle",get:function(){return this._upperAngle},set:function(t){this._upperAngle=t,this._joint&&this._joint.SetLimits(this._lowerAngle,t)}}]),i}();e.ClassUtils.regClass("laya.physics.joint.RevoluteJoint",C),e.ClassUtils.regClass("Laya.RevoluteJoint",C);var T=function(t){function e(){var t;return h(this,e),(t=s(this,r(e).apply(this,arguments))).selfAnchor=[0,0],t.otherAnchor=[0,0],t.collideConnected=!1,t._maxLength=1,t}return a(e,w),n(e,[{key:"_createJoint",value:function(){if(!this._joint){if(this.selfBody=this.selfBody||this.owner.getComponent(c),!this.selfBody)throw"selfBody can not be empty";var t=window.box2d,i=e._temp||(e._temp=new t.b2RopeJointDef);i.bodyA=this.otherBody?this.otherBody.getBody():y.I._emptyBody,i.bodyB=this.selfBody.getBody(),i.localAnchorA.Set(this.otherAnchor[0]/y.PIXEL_RATIO,this.otherAnchor[1]/y.PIXEL_RATIO),i.localAnchorB.Set(this.selfAnchor[0]/y.PIXEL_RATIO,this.selfAnchor[1]/y.PIXEL_RATIO),i.maxLength=this._maxLength/y.PIXEL_RATIO,i.collideConnected=this.collideConnected,this._joint=y.I._createJoint(i)}}},{key:"maxLength",get:function(){return this._maxLength},set:function(t){this._maxLength=t,this._joint&&this._joint.SetMaxLength(t/y.PIXEL_RATIO)}}]),e}();e.ClassUtils.regClass("laya.physics.joint.RopeJoint",T),e.ClassUtils.regClass("Laya.RopeJoint",T);var P=function(t){function i(){var t;return h(this,i),(t=s(this,r(i).apply(this,arguments))).anchor=[0,0],t.collideConnected=!1,t._frequency=5,t._damping=.7,t}return a(i,w),n(i,[{key:"_createJoint",value:function(){if(!this._joint){if(!this.otherBody)throw"otherBody can not be empty";if(this.selfBody=this.selfBody||this.owner.getComponent(c),!this.selfBody)throw"selfBody can not be empty";var t=window.box2d,o=i._temp||(i._temp=new t.b2WeldJointDef),n=this.selfBody.owner.localToGlobal(e.Point.TEMP.setTo(this.anchor[0],this.anchor[1]),!1,y.I.worldRoot),s=new t.b2Vec2(n.x/y.PIXEL_RATIO,n.y/y.PIXEL_RATIO);o.Initialize(this.otherBody.getBody(),this.selfBody.getBody(),s),o.frequencyHz=this._frequency,o.dampingRatio=this._damping,o.collideConnected=this.collideConnected,this._joint=y.I._createJoint(o)}}},{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.SetFrequency(t)}},{key:"damping",get:function(){return this._damping},set:function(t){this._damping=t,this._joint&&this._joint.SetDampingRatio(t)}}]),i}();e.ClassUtils.regClass("laya.physics.joint.WeldJoint",P),e.ClassUtils.regClass("Laya.WeldJoint",P);var k=function(t){function i(){var t;return h(this,i),(t=s(this,r(i).apply(this,arguments))).anchor=[0,0],t.collideConnected=!1,t.axis=[1,0],t._frequency=5,t._damping=.7,t._enableMotor=!1,t._motorSpeed=0,t._maxMotorTorque=1e4,t}return a(i,w),n(i,[{key:"_createJoint",value:function(){if(!this._joint){if(!this.otherBody)throw"otherBody can not be empty";if(this.selfBody=this.selfBody||this.owner.getComponent(c),!this.selfBody)throw"selfBody can not be empty";var t=window.box2d,o=i._temp||(i._temp=new t.b2WheelJointDef),n=this.selfBody.owner.localToGlobal(e.Point.TEMP.setTo(this.anchor[0],this.anchor[1]),!1,y.I.worldRoot),s=new t.b2Vec2(n.x/y.PIXEL_RATIO,n.y/y.PIXEL_RATIO);o.Initialize(this.otherBody.getBody(),this.selfBody.getBody(),s,new t.b2Vec2(this.axis[0],this.axis[1])),o.enableMotor=this._enableMotor,o.motorSpeed=this._motorSpeed,o.maxMotorTorque=this._maxMotorTorque,o.frequencyHz=this._frequency,o.dampingRatio=this._damping,o.collideConnected=this.collideConnected,this._joint=y.I._createJoint(o)}}},{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.SetSpringFrequencyHz(t)}},{key:"damping",get:function(){return this._damping},set:function(t){this._damping=t,this._joint&&this._joint.SetSpringDampingRatio(t)}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(t){this._enableMotor=t,this._joint&&this._joint.EnableMotor(t)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(t){this._motorSpeed=t,this._joint&&this._joint.SetMotorSpeed(t)}},{key:"maxMotorTorque",get:function(){return this._maxMotorTorque},set:function(t){this._maxMotorTorque=t,this._joint&&this._joint.SetMaxMotorTorque(t)}}]),i}();e.ClassUtils.regClass("laya.physics.joint.WheelJoint",k),e.ClassUtils.regClass("Laya.WheelJoint",k),t.BoxCollider=_,t.ChainCollider=d,t.CircleCollider=f,t.ColliderBase=l,t.DistanceJoint=b,t.GearJoint=m,t.IPhysics=o,t.JointBase=w,t.MotorJoint=v,t.MouseJoint=S,t.Physics=y,t.PhysicsDebugDraw=p,t.PolygonCollider=g,t.PrismaticJoint=I,t.PulleyJoint=x,t.RevoluteJoint=C,t.RigidBody=c,t.RopeJoint=T,t.WeldJoint=P,t.WheelJoint=k}(window.Laya=window.Laya||{},Laya)}(); 
 			}); 
		define("__plugin__/wx70d8aa25ec591f7a/laya.tiledmap.js", function(require, module, exports){ 			
!function(){"use strict";function t(i){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(i)}function i(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}function e(t,i){for(var e=0;e<i.length;e++){var r=i[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function r(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}function a(i,e){return!e||"object"!==t(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(i):e}function h(t){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function s(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(i&&i.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),i&&function(t,i){(Object.setPrototypeOf||function(t,i){return t.__proto__=i,t})(t,i)}(t,i)}!function(t,e){var l=function(t){function l(){var t;return i(this,l),(t=a(this,h(l).apply(this,arguments))).relativeX=0,t.relativeY=0,t.isAloneObject=!1,t.isHaveAnimation=!1,t.drawImageNum=0,t._map=null,t}return s(l,e.Sprite),r(l,[{key:"initData",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._map=t,this.isAloneObject=i}},{key:"addAniSprite",value:function(t){null==this.aniSpriteArray&&(this.aniSpriteArray=[]),this.aniSpriteArray.push(t)}},{key:"show",value:function(){if(!this.visible){if(this.visible=!0,null==this.aniSpriteArray)return;for(var t=0;t<this.aniSpriteArray.length;t++)this.aniSpriteArray[t].show()}}},{key:"hide",value:function(){if(this.visible){if(this.visible=!1,null==this.aniSpriteArray)return;for(var t=0;t<this.aniSpriteArray.length;t++)this.aniSpriteArray[t].hide()}}},{key:"updatePos",value:function(){this.isAloneObject?(this._map&&(this.x=this.relativeX-this._map._viewPortX,this.y=this.relativeY-this._map._viewPortY),this.x<0||this.x>this._map.viewPortWidth||this.y<0||this.y>this._map.viewPortHeight?this.hide():this.show()):this._map&&(this.x=this.relativeX-this._map._viewPortX,this.y=this.relativeY-this._map._viewPortY)}},{key:"clearAll",value:function(){if(this._map&&(this._map=null),this.visible=!1,null!=this.aniSpriteArray)for(var t=0;t<this.aniSpriteArray.length;t++)this.aniSpriteArray[t].clearAll();this.destroy(),this.relativeX=0,this.relativeY=0,this.isHaveAnimation=!1,this.aniSpriteArray=null,this.drawImageNum=0}}]),l}(),n=function t(){i(this,t)};n.TiledMap=null;var o=function(t){function l(){var t;return i(this,l),(t=a(this,h(l).apply(this,arguments)))._tileTextureSet=null,t._aniName=null,t}return s(l,e.Sprite),r(l,[{key:"setTileTextureSet",value:function(t,i){this._aniName=t,this._tileTextureSet=i,i.addAniSprite(this._aniName,this)}},{key:"show",value:function(){this._tileTextureSet.addAniSprite(this._aniName,this)}},{key:"hide",value:function(){this._tileTextureSet.removeAniSprite(this._aniName)}},{key:"clearAll",value:function(){this._tileTextureSet.removeAniSprite(this._aniName),this.destroy(),this._tileTextureSet=null,this._aniName=null}}]),l}(),_=function(t){function _(){var t;return i(this,_),(t=a(this,h(_).apply(this,arguments)))._mapData=null,t._tileWidthHalf=0,t._tileHeightHalf=0,t._mapWidthHalf=0,t._mapHeightHalf=0,t._gridSpriteArray=[],t._objDic=null,t._dataDic=null,t._tempMapPos=new e.Point,t.layerName=null,t}return s(_,e.Sprite),r(_,[{key:"init",value:function(t,i){this._map=i,this._mapData=t.data,t.height,t.width;var r=i.tileWidth,a=i.tileHeight;switch(this.layerName=t.name,this._properties=t.properties,this.alpha=t.opacity,this._tileWidthHalf=r/2,this._tileHeightHalf=a/2,this._mapWidthHalf=this._map.width/2-this._tileWidthHalf,this._mapHeightHalf=this._map.height/2,t.type){case"tilelayer":break;case"objectgroup":var h,s,l,o=t.objects;o.length>0&&(this._objDic={},this._dataDic={});for(var _=0;_<o.length;_++)if(h=o[_],this._dataDic[h.name]=h,1==h.visible){s=h.width,l=h.height;var p=i.getSprite(h.gid,s,l);if(null!=p){switch(this._map.orientation){case n.TiledMap.ORIENTATION_ISOMETRIC:this.getScreenPositionByTilePos(h.x/a,h.y/a,e.Point.TEMP),p.pivot(s/2,l/2),p.rotation=h.rotation,p.x=p.relativeX=e.Point.TEMP.x+this._map.viewPortX,p.y=p.relativeY=e.Point.TEMP.y+this._map.viewPortY-l/2;break;case n.TiledMap.ORIENTATION_STAGGERED:case n.TiledMap.ORIENTATION_ORTHOGONAL:p.pivot(s/2,l/2),p.rotation=h.rotation,p.x=p.relativeX=h.x+s/2,p.y=p.relativeY=h.y-l/2;break;case n.TiledMap.ORIENTATION_HEXAGONAL:p.x=p.relativeX=h.x,p.y=p.relativeY=h.y}this.addChild(p),this._gridSpriteArray.push(p),this._objDic[h.name]=p}}}}},{key:"getObjectByName",value:function(t){return this._objDic?this._objDic[t]:null}},{key:"getObjectDataByName",value:function(t){return this._dataDic?this._dataDic[t]:null}},{key:"getLayerProperties",value:function(t){return this._properties?this._properties[t]:null}},{key:"getTileData",value:function(t,i){if(i>=0&&i<this._map.numRowsTile&&t>=0&&t<this._map.numColumnsTile){var e=i*this._map.numColumnsTile+t,r=this._mapData;if(null!=r&&e<r.length)return r[e]}return 0}},{key:"getScreenPositionByTilePos",value:function(t,i){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(e){switch(this._map.orientation){case n.TiledMap.ORIENTATION_ISOMETRIC:e.x=this._map.width/2-(i-t)*this._tileWidthHalf,e.y=(i+t)*this._tileHeightHalf;break;case n.TiledMap.ORIENTATION_STAGGERED:t=Math.floor(t),i=Math.floor(i),e.x=t*this._map.tileWidth+(1&i)*this._tileWidthHalf,e.y=i*this._tileHeightHalf;break;case n.TiledMap.ORIENTATION_ORTHOGONAL:e.x=t*this._map.tileWidth,e.y=i*this._map.tileHeight;break;case n.TiledMap.ORIENTATION_HEXAGONAL:t=Math.floor(t),i=Math.floor(i);var r=2*this._map.tileHeight/3;e.x=(t*this._map.tileWidth+i%2*this._tileWidthHalf)%this._map.gridWidth,e.y=i*r%this._map.gridHeight}e.x=(e.x+this._map.viewPortX)*this._map.scale,e.y=(e.y+this._map.viewPortY)*this._map.scale}}},{key:"getTileDataByScreenPos",value:function(t,i){var e=0;return this.getTilePositionByScreenPos(t,i,this._tempMapPos)&&(e=this.getTileData(Math.floor(this._tempMapPos.x),Math.floor(this._tempMapPos.y))),e}},{key:"getTilePositionByScreenPos",value:function(t,i){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;t=t/this._map.scale-this._map.viewPortX,i=i/this._map.scale-this._map.viewPortY;var r=this._map.tileWidth,a=this._map.tileHeight,h=0,s=0;switch(this._map.orientation){case n.TiledMap.ORIENTATION_ISOMETRIC:var l=t-this._map.width/2;return h=-(l/r-i/a),s=l/r+i/a,e&&(e.x=s,e.y=h),!0;case n.TiledMap.ORIENTATION_STAGGERED:var o,_;return e&&(o=(t-(Math.floor(t/r)*r+r/2))*a/2,_=(i-(Math.floor(i/a)*a+a/2))*r/2,Math.abs(o)+Math.abs(_)<=r*a/4?(s=Math.floor(t/r),h=2*Math.floor(i/a)):(t-=r/2,s=Math.floor(t/r)+1,i-=a/2,h=2*Math.floor(i/a)+1),e.x=s-(1&h),e.y=h),!0;case n.TiledMap.ORIENTATION_ORTHOGONAL:return s=t/r,h=i/a,e&&(e.x=s,e.y=h),!0;case n.TiledMap.ORIENTATION_HEXAGONAL:s=(t-(h=i/(2*a/3))%2*this._tileWidthHalf)/r,e&&(e.x=s,e.y=h)}return!1}},{key:"getDrawSprite",value:function(t,i){var e=new l;return e.relativeX=t*this._map.gridWidth,e.relativeY=i*this._map.gridHeight,e.initData(this._map),this._gridSpriteArray.push(e),e}},{key:"updateGridPos",value:function(){for(var t,i=0;i<this._gridSpriteArray.length;i++)((t=this._gridSpriteArray[i]).visible||t.isAloneObject)&&t.drawImageNum>0&&t.updatePos()}},{key:"drawTileTexture",value:function(t,i,e){if(e>=0&&e<this._map.numRowsTile&&i>=0&&i<this._map.numColumnsTile){var r=e*this._map.numColumnsTile+i,a=this._mapData;if(null!=a&&r<a.length&&0!=a[r]){var h=this._map.getTexture(a[r]);if(h){var s=0,l=0;switch(h.texture,this._map.orientation){case n.TiledMap.ORIENTATION_STAGGERED:s=i*this._map.tileWidth%this._map.gridWidth+(1&e)*this._tileWidthHalf,l=e*this._tileHeightHalf%this._map.gridHeight;break;case n.TiledMap.ORIENTATION_ORTHOGONAL:s=i*this._map.tileWidth%this._map.gridWidth,l=e*this._map.tileHeight%this._map.gridHeight;break;case n.TiledMap.ORIENTATION_ISOMETRIC:s=(this._mapWidthHalf+(i-e)*this._tileWidthHalf)%this._map.gridWidth,l=(i+e)*this._tileHeightHalf%this._map.gridHeight;break;case n.TiledMap.ORIENTATION_HEXAGONAL:var _=2*this._map.tileHeight/3;s=(i*this._map.tileWidth+e%2*this._tileWidthHalf)%this._map.gridWidth,l=e*_%this._map.gridHeight}if(h.isAnimation){var p=new o;p.x=s,p.y=l,p.setTileTextureSet(r.toString(),h),t.addAniSprite(p),t.addChild(p),t.isHaveAnimation=!0}else t.graphics.drawImage(h.texture,s+h.offX,l+h.offY);return!0}}}return!1}},{key:"clearAll",value:function(){this._map=null,this._mapData=null,this._tileWidthHalf=0,this._tileHeightHalf=0,this._mapWidthHalf=0,this._mapHeightHalf=0,this.layerName=null;var t=0;if(this._objDic){for(var i in this._objDic)delete this._objDic[i];this._objDic=null}if(this._dataDic){for(i in this._dataDic)delete this._dataDic[i];this._dataDic=null}for(t=0;t<this._gridSpriteArray.length;t++)this._gridSpriteArray[t].clearAll();this._properties=null,this._tempMapPos=null,this.tarLayer=null}}]),_}(),p=function(){function t(){i(this,t),this.gid=-1,this.offX=0,this.offY=0,this.textureArray=null,this.durationTimeArray=null,this.animationTotalTime=0,this.isAnimation=!1,this._spriteNum=0,this._aniDic=null,this._frameIndex=0,this._time=0,this._interval=0,this._preFrameTime=0}return r(t,[{key:"addAniSprite",value:function(t,i){if(0!=this.animationTotalTime&&(null==this._aniDic&&(this._aniDic={}),0==this._spriteNum&&(e.ILaya.timer.frameLoop(3,this,this.animate),this._preFrameTime=e.ILaya.Browser.now(),this._frameIndex=0,this._time=0,this._interval=0),this._spriteNum++,this._aniDic[t]=i,this.textureArray&&this._frameIndex<this.textureArray.length)){var r=this.textureArray[this._frameIndex];this.drawTexture(i,r)}}},{key:"animate",value:function(){if(this.textureArray&&this.textureArray.length>0&&this.durationTimeArray&&this.durationTimeArray.length>0){var t=e.ILaya.Browser.now();this._interval=t-this._preFrameTime,this._preFrameTime=t,this._interval>this.animationTotalTime&&(this._interval=this._interval%this.animationTotalTime),this._time+=this._interval;for(var i=this.durationTimeArray[this._frameIndex];this._time>i;){this._time-=i,this._frameIndex++,(this._frameIndex>=this.durationTimeArray.length||this._frameIndex>=this.textureArray.length)&&(this._frameIndex=0);var r,a=this.textureArray[this._frameIndex];for(var h in this._aniDic)r=this._aniDic[h],this.drawTexture(r,a);i=this.durationTimeArray[this._frameIndex]}}}},{key:"drawTexture",value:function(t,i){t.graphics.clear(!0),t.graphics.drawImage(i.texture,i.offX,i.offY)}},{key:"removeAniSprite",value:function(t){this._aniDic&&this._aniDic[t]&&(delete this._aniDic[t],this._spriteNum--,0==this._spriteNum&&e.ILaya.timer.clear(this,this.animate))}},{key:"showDebugInfo",value:function(){var t=null;return this._spriteNum>0&&(t="TileTextureSet::gid:"+this.gid.toString()+" 动画数:"+this._spriteNum.toString()),t}},{key:"clearAll",value:function(){this.gid=-1,this.texture&&(this.texture.destroy(),this.texture=null),this.offX=0,this.offY=0,this.textureArray=null,this.durationTimeArray=null,this.isAnimation=!1,this._spriteNum=0,this._aniDic=null,this._frameIndex=0,this._preFrameTime=0,this._time=0,this._interval=0}}]),t}(),u=function(){function t(){i(this,t),this._tileTexSetArr=[],this._texArray=[],this._x=0,this._y=0,this._width=0,this._height=0,this._mapW=0,this._mapH=0,this._mapTileW=0,this._mapTileH=0,this._rect=new e.Rectangle,this._paddingRect=new e.Rectangle,this._mapSprite=null,this._layerArray=[],this._renderLayerArray=[],this._gridArray=[],this._showGridKey=!1,this._totalGridNum=0,this._gridW=0,this._gridH=0,this._gridWidth=450,this._gridHeight=450,this._jsonLoader=null,this._loader=null,this._tileSetArray=[],this._currTileSet=null,this._completeHandler=null,this._mapRect=new m,this._mapLastRect=new m,this._index=0,this._animationDic={},this._tileProperties={},this._tileProperties2={},this._orientation="orthogonal",this._renderOrder="right-down",this._colorArray=["FF","00","33","66"],this._scale=1,this._pivotScaleX=.5,this._pivotScaleY=.5,this._centerX=0,this._centerY=0,this._viewPortX=0,this._viewPortY=0,this._viewPortWidth=0,this._viewPortHeight=0,this._enableLinear=!0,this._limitRange=!1,this.autoCache=!0,this.autoCacheType="normal",this.enableMergeLayer=!1,this.removeCoveredTile=!1,this.showGridTextureCount=!1,this.antiCrack=!0,this.cacheAllAfterInit=!1,this._texutreStartDic={}}return r(t,[{key:"createMap",value:function(t,i,r){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,h=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],l=arguments.length>6&&void 0!==arguments[6]&&arguments[6];this._enableLinear=s,this._limitRange=l,this._rect.x=i.x,this._rect.y=i.y,this._rect.width=i.width,this._rect.height=i.height,this._viewPortWidth=i.width/this._scale,this._viewPortHeight=i.height/this._scale,this._completeHandler=r,a?this._paddingRect.copyFrom(a):this._paddingRect.setTo(0,0,0,0),h&&(this._gridWidth=h.x,this._gridHeight=h.y);var n=t.lastIndexOf("/");n>-1?(this._resPath=t.substr(0,n),this._pathArray=this._resPath.split("/")):(this._resPath="",this._pathArray=[]),this._jsonLoader=new e.Loader,this._jsonLoader.once("complete",this,this.onJsonComplete),this._jsonLoader.load(t,e.Loader.JSON,!1)}},{key:"onJsonComplete",value:function(i){this._mapSprite=new e.Sprite,e.ILaya.stage.addChild(this._mapSprite);var r=this._jsonData=i;this._properties=r.properties,this._orientation=r.orientation,this._renderOrder=r.renderorder,this._mapW=r.width,this._mapH=r.height,this._mapTileW=r.tilewidth,this._mapTileH=r.tileheight,this._width=this._mapTileW*this._mapW,this._height=this._mapTileH*this._mapH,this._orientation==t.ORIENTATION_STAGGERED&&(this._height=(.5+.5*this._mapH)*this._mapTileH),this._mapLastRect.top=this._mapLastRect.bottom=this._mapLastRect.left=this._mapLastRect.right=-1;var a,h,s=r.tilesets,l=0;for(l=0;l<s.length;l++)if(a=s[l],(h=new d).init(a),!h.properties||!h.properties.ignore){this._tileProperties[l]=h.tileproperties,this.addTileProperties(h.tileproperties),this._tileSetArray.push(h);var n=a.tiles;if(n)for(var o in n){var _=n[o].animation;if(_){var p=new c;this._animationDic[o]=p,p.image=a.image;for(var u=0;u<_.length;u++){var m=_[u];p.mAniIdArray.push(m.tileid),p.mDurationTimeArray.push(m.duration)}}}}if(this._tileTexSetArr.push(null),this._tileSetArray.length>0){h=this._currTileSet=this._tileSetArray.shift(),this._loader=new e.Loader,this._loader.once("complete",this,this.onTextureComplete);var f=this.mergePath(this._resPath,h.image);this._loader.load(f,e.Loader.IMAGE,!1)}}},{key:"mergePath",value:function(t,i){var e="",r=i.split("/"),a=0,h=0;for(h=r.length-1;h>=0;h--)".."==r[h]&&a++;if(0==a)return this._pathArray.length>0?t+"/"+i:i;var s=this._pathArray.length-a;for(s<0&&console.log("[error]path does not exist",this._pathArray,r,t,i),h=0;h<s;h++)0==h?e+=this._pathArray[h]:e=e+"/"+this._pathArray[h];for(h=a;h<r.length;h++)e=e+"/"+r[h];return e}},{key:"onTextureComplete",value:function(t){this._jsonData;var i=t;this._enableLinear||(i.bitmap.minFifter=9728,i.bitmap.magFifter=9728),this._texArray.push(i);var r=this._currTileSet,a=r.tilewidth,h=r.tileheight,s=r.imagewidth,l=r.imageheight,n=(r.firstgid,Math.floor((s-r.margin-a)/(a+r.spacing))+1),o=Math.floor((l-r.margin-h)/(h+r.spacing))+1,_=null;this._texutreStartDic[r.image]=this._tileTexSetArr.length;for(var u=0;u<o;u++)for(var m=0;m<n;m++)(_=new p).offX=r.titleoffsetX,_.offY=r.titleoffsetY-(h-this._mapTileH),_.texture=e.Texture.createFromTexture(i,r.margin+(a+r.spacing)*m,r.margin+(h+r.spacing)*u,a,h),this.antiCrack&&this.adptTexture(_.texture),this._tileTexSetArr.push(_),_.gid=this._tileTexSetArr.length;if(this._tileSetArray.length>0){r=this._currTileSet=this._tileSetArray.shift(),this._loader.once("complete",this,this.onTextureComplete);var c=this.mergePath(this._resPath,r.image);this._loader.load(c,e.Loader.IMAGE,!1)}else this._currTileSet=null,this.initMap()}},{key:"adptTexture",value:function(t){if(t){var i=t.uv[0],e=t.uv[2],r=t.uv[1],a=t.uv[7],h=1/t.bitmap.width,s=1/t.bitmap.height,l=t;l.uv[0]=l.uv[6]=i+h,l.uv[2]=l.uv[4]=e-h,l.uv[1]=l.uv[3]=r+s,l.uv[5]=l.uv[7]=a-s}}},{key:"initMap",value:function(){var t,i;for(var e in this._animationDic){var r,a=this._animationDic[e];r=this._texutreStartDic[a.image];var h=this.getTexture(parseInt(e)+r);if(a.mAniIdArray.length>0){for(h.textureArray=[],h.durationTimeArray=a.mDurationTimeArray,h.isAnimation=!0,h.animationTotalTime=0,t=0,i=h.durationTimeArray.length;t<i;t++)h.animationTotalTime+=h.durationTimeArray[t];for(t=0,i=a.mAniIdArray.length;t<i;t++){var s=this.getTexture(a.mAniIdArray[t]+r);h.textureArray.push(s)}}}for(this._gridWidth=Math.floor(this._gridWidth/this._mapTileW)*this._mapTileW,this._gridHeight=Math.floor(this._gridHeight/this._mapTileH)*this._mapTileH,this._gridWidth<this._mapTileW&&(this._gridWidth=this._mapTileW),this._gridHeight<this._mapTileH&&(this._gridHeight=this._mapTileH),this._gridW=Math.ceil(this._width/this._gridWidth),this._gridH=Math.ceil(this._height/this._gridHeight),this._totalGridNum=this._gridW*this._gridH,t=0;t<this._gridH;t++){var l=[];this._gridArray.push(l);for(var n=0;n<this._gridW;n++)l.push(null)}for(var o,p,u,m=this._jsonData.layers,c=!0,d=0;d<m.length;d++){var f=m[d];if(1==f.visible){var g=new _;g.init(f,this),this.enableMergeLayer?(o=g.getLayerProperties("layer"),(c=c||!u||o!=p)?(c=!1,g.tarLayer=g,u=g,this._mapSprite.addChild(g),this._renderLayerArray.push(g)):g.tarLayer=u,p=o):(this._mapSprite.addChild(g),this._renderLayerArray.push(g)),this._layerArray.push(g)}}this.removeCoveredTile&&this.adptTiledMapData(),this.cacheAllAfterInit&&this.cacheAllGrid(),this.moveViewPort(this._rect.x,this._rect.y),null!=this._completeHandler&&this._completeHandler.run()}},{key:"addTileProperties",value:function(t){var i;for(i in t)this._tileProperties2[i]=t[i]}},{key:"getTileUserData",value:function(t,i){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return this._tileProperties2&&this._tileProperties2[t]&&i in this._tileProperties2[t]?this._tileProperties2[t][i]:e}},{key:"adptTiledMapData",value:function(){var t,i,e={};for(t=this._layerArray.length-1;t>=0;t--)(i=this._layerArray[t]._mapData)&&(this.removeCoverd(i,e),this.collectCovers(i,e,t))}},{key:"removeCoverd",value:function(t,i){var e,r;for(r=t.length,e=0;e<r;e++)i[e]&&(t[e]=0)}},{key:"collectCovers",value:function(t,i,e){var r,a,h;for(a=t.length,r=0;r<a;r++)(h=t[r])>0&&this.getTileUserData(h-1,"type",0)>0&&(i[r]=h)}},{key:"getTexture",value:function(t){return t<this._tileTexSetArr.length?this._tileTexSetArr[t]:null}},{key:"getMapProperties",value:function(t){return this._properties?this._properties[t]:null}},{key:"getTileProperties",value:function(t,i,e){return this._tileProperties[t]&&this._tileProperties[t][i]?this._tileProperties[t][i][e]:null}},{key:"getSprite",value:function(t,i,e){if(0<this._tileTexSetArr.length){var r=new l;r.initData(this,!0),r.size(i,e);var a=this._tileTexSetArr[t];if(null!=a&&null!=a.texture){if(a.isAnimation){var h=new o;this._index++,h.setTileTextureSet(this._index.toString(),a),r.addAniSprite(h),r.addChild(h)}else r.graphics.drawImage(a.texture,0,0,i,e);r.drawImageNum++}return r}return null}},{key:"setViewPortPivotByScale",value:function(t,i){this._pivotScaleX=t,this._pivotScaleY=i}},{key:"moveViewPort",value:function(t,i){this._x=-t,this._y=-i,this._rect.x=t,this._rect.y=i,this.updateViewPort()}},{key:"changeViewPort",value:function(t,i,e,r){t==this._rect.x&&i==this._rect.y&&e==this._rect.width&&r==this._rect.height||(this._x=-t,this._y=-i,this._rect.x=t,this._rect.y=i,this._rect.width=e,this._rect.height=r,this._viewPortWidth=e/this._scale,this._viewPortHeight=r/this._scale,this.updateViewPort())}},{key:"changeViewPortBySize",value:function(t,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return null==r&&(r=new e.Rectangle),this._centerX=this._rect.x+this._rect.width*this._pivotScaleX,this._centerY=this._rect.y+this._rect.height*this._pivotScaleY,r.x=this._centerX-t*this._pivotScaleX,r.y=this._centerY-i*this._pivotScaleY,r.width=t,r.height=i,this.changeViewPort(r.x,r.y,r.width,r.height),r}},{key:"updateViewPort",value:function(){this._centerX=this._rect.x+this._rect.width*this._pivotScaleX,this._centerY=this._rect.y+this._rect.height*this._pivotScaleY;var t=!1,i=this._viewPortX;this._viewPortX=this._centerX-this._rect.width*this._pivotScaleX/this._scale,i!=this._viewPortX?t=!0:i=this._viewPortY,this._viewPortY=this._centerY-this._rect.height*this._pivotScaleY/this._scale,t||i==this._viewPortY||(t=!0),this._limitRange&&(this._viewPortX+this._viewPortWidth>this._width&&(this._viewPortX=this._width-this._viewPortWidth),this._viewPortY+this._viewPortHeight>this._height&&(this._viewPortY=this._height-this._viewPortHeight),this._viewPortX<0&&(this._viewPortX=0),this._viewPortY<0&&(this._viewPortY=0));var e=this._paddingRect;if(this._mapRect.top=Math.floor((this._viewPortY-e.y)/this._gridHeight),this._mapRect.bottom=Math.floor((this._viewPortY+this._viewPortHeight+e.height+e.y)/this._gridHeight),this._mapRect.left=Math.floor((this._viewPortX-e.x)/this._gridWidth),this._mapRect.right=Math.floor((this._viewPortX+this._viewPortWidth+e.width+e.x)/this._gridWidth),this._mapRect.top==this._mapLastRect.top&&this._mapRect.bottom==this._mapLastRect.bottom&&this._mapRect.left==this._mapLastRect.left&&this._mapRect.right==this._mapLastRect.right||(this.clipViewPort(),this._mapLastRect.top=this._mapRect.top,this._mapLastRect.bottom=this._mapRect.bottom,this._mapLastRect.left=this._mapRect.left,this._mapLastRect.right=this._mapRect.right,t=!0),t)for(var r,a=this._renderLayerArray.length,h=0;h<a;h++)(r=this._renderLayerArray[h])._gridSpriteArray.length>0&&r.updateGridPos()}},{key:"clipViewPort",value:function(){var t,i,e=0,r=0;if(this._mapRect.left>this._mapLastRect.left){if((e=this._mapRect.left-this._mapLastRect.left)>0)for(i=this._mapLastRect.left;i<this._mapLastRect.left+e;i++)for(t=this._mapLastRect.top;t<=this._mapLastRect.bottom;t++)this.hideGrid(i,t)}else if((r=Math.min(this._mapLastRect.left,this._mapRect.right+1)-this._mapRect.left)>0)for(i=this._mapRect.left;i<this._mapRect.left+r;i++)for(t=this._mapRect.top;t<=this._mapRect.bottom;t++)this.showGrid(i,t);if(this._mapRect.right>this._mapLastRect.right){if((r=this._mapRect.right-this._mapLastRect.right)>0)for(i=Math.max(this._mapLastRect.right+1,this._mapRect.left);i<=this._mapLastRect.right+r;i++)for(t=this._mapRect.top;t<=this._mapRect.bottom;t++)this.showGrid(i,t)}else if((e=this._mapLastRect.right-this._mapRect.right)>0)for(i=this._mapRect.right+1;i<=this._mapRect.right+e;i++)for(t=this._mapLastRect.top;t<=this._mapLastRect.bottom;t++)this.hideGrid(i,t);if(this._mapRect.top>this._mapLastRect.top){if((e=this._mapRect.top-this._mapLastRect.top)>0)for(t=this._mapLastRect.top;t<this._mapLastRect.top+e;t++)for(i=this._mapLastRect.left;i<=this._mapLastRect.right;i++)this.hideGrid(i,t)}else if((r=Math.min(this._mapLastRect.top,this._mapRect.bottom+1)-this._mapRect.top)>0)for(t=this._mapRect.top;t<this._mapRect.top+r;t++)for(i=this._mapRect.left;i<=this._mapRect.right;i++)this.showGrid(i,t);if(this._mapRect.bottom>this._mapLastRect.bottom){if((r=this._mapRect.bottom-this._mapLastRect.bottom)>0)for(t=Math.max(this._mapLastRect.bottom+1,this._mapRect.top);t<=this._mapLastRect.bottom+r;t++)for(i=this._mapRect.left;i<=this._mapRect.right;i++)this.showGrid(i,t)}else if((e=this._mapLastRect.bottom-this._mapRect.bottom)>0)for(t=this._mapRect.bottom+1;t<=this._mapRect.bottom+e;t++)for(i=this._mapLastRect.left;i<=this._mapLastRect.right;i++)this.hideGrid(i,t)}},{key:"showGrid",value:function(t,i){if(!(t<0||t>=this._gridW||i<0||i>=this._gridH)){var e,r,a=this._gridArray[i][t];if(null==a)a=this.getGridArray(t,i);else for(e=0;e<a.length&&e<this._layerArray.length;e++)this._layerArray[e]&&a[e]&&0==(r=a[e]).visible&&r.drawImageNum>0&&r.show()}}},{key:"cacheAllGrid",value:function(){var t,i,e;for(t=0;t<this._gridW;t++)for(i=0;i<this._gridH;i++)e=this.getGridArray(t,i),this.cacheGridsArray(e)}},{key:"cacheGridsArray",value:function(i){var r,a,h,s;if(!t._tempCanvas){t._tempCanvas=new e.HTMLCanvas;var l=t._tempCanvas.context;l||(l=t._tempCanvas.getContext("2d"))}for((r=t._tempCanvas).context.asBitmap=!1,h=i.length,a=0;a<h;a++)s=i[a],r.clear(),r.size(1,1),s.render(r.context,0,0),s.hide();r.clear(),r.size(1,1)}},{key:"getGridArray",value:function(i,e){var r,a,h,s=this._gridArray[e][i];if(null==s){s=this._gridArray[e][i]=[];var l=0,n=0,o=0,_=0,p=this._gridWidth,u=this._gridHeight;switch(this.orientation){case t.ORIENTATION_ISOMETRIC:var m,c,d,f;l=Math.floor(i*p),n=Math.floor(i*p+p),o=Math.floor(e*u),_=Math.floor(e*u+u);break;case t.ORIENTATION_STAGGERED:l=Math.floor(i*p/this._mapTileW),n=Math.floor((i*p+p)/this._mapTileW),o=Math.floor(e*u/(this._mapTileH/2)),_=Math.floor((e*u+u)/(this._mapTileH/2));break;case t.ORIENTATION_ORTHOGONAL:l=Math.floor(i*p/this._mapTileW),n=Math.floor((i*p+p)/this._mapTileW),o=Math.floor(e*u/this._mapTileH),_=Math.floor((e*u+u)/this._mapTileH);break;case t.ORIENTATION_HEXAGONAL:var g=2*this._mapTileH/3;l=Math.floor(i*p/this._mapTileW),n=Math.ceil((i*p+p)/this._mapTileW),o=Math.floor(e*u/g),_=Math.ceil((e*u+u)/g)}for(var y,v,T=null,A=0;A<this._layerArray.length;A++){var w;switch(T=this._layerArray[A],this.enableMergeLayer?(T.tarLayer!=v&&(y=null,v=T.tarLayer),y||(y=v.getDrawSprite(i,e),s.push(y)),h=y):(h=T.getDrawSprite(i,e),s.push(h)),this._showGridKey&&(w="#",w+=this._colorArray[Math.floor(Math.random()*this._colorArray.length)],w+=this._colorArray[Math.floor(Math.random()*this._colorArray.length)],w+=this._colorArray[Math.floor(Math.random()*this._colorArray.length)]),this.orientation){case t.ORIENTATION_ISOMETRIC:var R=this.tileHeight/2,x=this.tileWidth/2,O=this._width/2;d=Math.floor(o/R),f=Math.floor(_/R),m=this._mapW+Math.floor((l-O)/x),c=this._mapW+Math.floor((n-O)/x),this._mapW;var S=2*this._mapH;for(d<0&&(d=0),d>=S&&(d=S-1),f<0&&(_=0),f>=S&&(f=S-1),h.zOrder=this._totalGridNum*A+e*this._gridW+i,r=d;r<f;r++)for(a=0;a<=r;a++){var H=r-a,N=a,P=H-N+this._mapW;P>m&&P<=c&&T.drawTileTexture(h,H,N)&&h.drawImageNum++}break;case t.ORIENTATION_STAGGERED:for(h.zOrder=A*this._totalGridNum+e*this._gridW+i,r=o;r<_;r++)for(a=l;a<n;a++)T.drawTileTexture(h,a,r)&&h.drawImageNum++;break;case t.ORIENTATION_ORTHOGONAL:case t.ORIENTATION_HEXAGONAL:switch(this._renderOrder){case t.RENDERORDER_RIGHTDOWN:for(h.zOrder=A*this._totalGridNum+e*this._gridW+i,r=o;r<_;r++)for(a=l;a<n;a++)T.drawTileTexture(h,a,r)&&h.drawImageNum++;break;case t.RENDERORDER_RIGHTUP:for(h.zOrder=A*this._totalGridNum+(this._gridH-1-e)*this._gridW+i,r=_-1;r>=o;r--)for(a=l;a<n;a++)T.drawTileTexture(h,a,r)&&h.drawImageNum++;break;case t.RENDERORDER_LEFTDOWN:for(h.zOrder=A*this._totalGridNum+e*this._gridW+(this._gridW-1-i),r=o;r<_;r++)for(a=n-1;a>=l;a--)T.drawTileTexture(h,a,r)&&h.drawImageNum++;break;case t.RENDERORDER_LEFTUP:for(h.zOrder=A*this._totalGridNum+(this._gridH-1-e)*this._gridW+(this._gridW-1-i),r=_-1;r>=o;r--)for(a=n-1;a>=l;a--)T.drawTileTexture(h,a,r)&&h.drawImageNum++}}h.isHaveAnimation||(h.autoSize=!0,this.autoCache&&(h.cacheAs=this.autoCacheType),h.autoSize=!1),this.enableMergeLayer?y&&y.drawImageNum>0&&v&&v.addChild(y):(h.drawImageNum>0&&T.addChild(h),this._showGridKey&&h.graphics.drawRect(0,0,p,u,null,w))}this.enableMergeLayer&&this.showGridTextureCount&&y&&y.graphics.fillText(y.drawImageNum+"",20,20,null,"#ff0000","left")}return s}},{key:"hideGrid",value:function(t,i){if(!(t<0||t>=this._gridW||i<0||i>=this._gridH)){var e=this._gridArray[i][t];if(e)for(var r,a=0;a<e.length;a++)(r=e[a]).drawImageNum>0&&null!=r&&r.hide()}}},{key:"getLayerObject",value:function(t,i){for(var e=null,r=0;r<this._layerArray.length&&(e=this._layerArray[r]).layerName!=t;r++);return e?e.getObjectByName(i):null}},{key:"destroy",value:function(){this._orientation=t.ORIENTATION_ORTHOGONAL,this._jsonData=null;var i,e=0;for(this._gridArray=[],e=0;e<this._tileTexSetArr.length;e++)(i=this._tileTexSetArr[e])&&i.clearAll();for(this._tileTexSetArr=[],e=0;e<this._texArray.length;e++)this._texArray[e].destroy();for(this._texArray=[],this._width=0,this._height=0,this._mapW=0,this._mapH=0,this._mapTileW=0,this._mapTileH=0,this._rect.setTo(0,0,0,0),e=0;e<this._layerArray.length;e++)this._layerArray[e].clearAll();this._layerArray=[],this._renderLayerArray=[],this._mapSprite&&(this._mapSprite.destroy(),this._mapSprite=null),this._jsonLoader=null,this._loader=null;var r=this._animationDic;for(var a in r)delete r[a];for(a in this._properties=null,r=this._tileProperties)delete r[a];this._currTileSet=null,this._completeHandler=null,this._mapRect.clearAll(),this._mapLastRect.clearAll(),this._tileSetArray=[],this._gridWidth=450,this._gridHeight=450,this._gridW=0,this._gridH=0,this._x=0,this._y=0,this._index=0,this._enableLinear=!0,this._resPath=null,this._pathArray=null}},{key:"mapSprite",value:function(){return this._mapSprite}},{key:"getLayerByName",value:function(t){for(var i,e=0;e<this._layerArray.length;e++)if(t==(i=this._layerArray[e]).layerName)return i;return null}},{key:"getLayerByIndex",value:function(t){return t<this._layerArray.length?this._layerArray[t]:null}},{key:"scale",set:function(t){t<=0||(this._scale=t,this._viewPortWidth=this._rect.width/t,this._viewPortHeight=this._rect.height/t,this._mapSprite.scale(this._scale,this._scale),this.updateViewPort())},get:function(){return this._scale}},{key:"tileWidth",get:function(){return this._mapTileW}},{key:"tileHeight",get:function(){return this._mapTileH}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"numColumnsTile",get:function(){return this._mapW}},{key:"numRowsTile",get:function(){return this._mapH}},{key:"viewPortX",get:function(){return-this._viewPortX}},{key:"viewPortY",get:function(){return-this._viewPortY}},{key:"viewPortWidth",get:function(){return this._viewPortWidth}},{key:"viewPortHeight",get:function(){return this._viewPortHeight}},{key:"x",get:function(){return this._x}},{key:"y",get:function(){return this._y}},{key:"gridWidth",get:function(){return this._gridWidth}},{key:"gridHeight",get:function(){return this._gridHeight}},{key:"numColumnsGrid",get:function(){return this._gridW}},{key:"numRowsGrid",get:function(){return this._gridH}},{key:"orientation",get:function(){return this._orientation}},{key:"renderOrder",get:function(){return this._renderOrder}}]),t}();u.ORIENTATION_ORTHOGONAL="orthogonal",u.ORIENTATION_ISOMETRIC="isometric",u.ORIENTATION_STAGGERED="staggered",u.ORIENTATION_HEXAGONAL="hexagonal",u.RENDERORDER_RIGHTDOWN="right-down",u.RENDERORDER_RIGHTUP="right-up",u.RENDERORDER_LEFTDOWN="left-down",u.RENDERORDER_LEFTUP="left-up";var m=function(){function t(){i(this,t)}return r(t,[{key:"clearAll",value:function(){this.left=this.top=this.right=this.bottom=0}}]),t}(),c=function t(){i(this,t),this.mAniIdArray=[],this.mDurationTimeArray=[],this.mTileTexSetArr=[]},d=function(){function t(){i(this,t),this.firstgid=0,this.image="",this.imageheight=0,this.imagewidth=0,this.margin=0,this.name=0,this.spacing=0,this.tileheight=0,this.tilewidth=0,this.titleoffsetX=0,this.titleoffsetY=0}return r(t,[{key:"init",value:function(t){this.firstgid=t.firstgid,this.image=t.image,this.imageheight=t.imageheight,this.imagewidth=t.imagewidth,this.margin=t.margin,this.name=t.name,this.properties=t.properties,this.spacing=t.spacing,this.tileheight=t.tileheight,this.tilewidth=t.tilewidth,this.tileproperties=t.tileproperties;var i=t.tileoffset;i&&(this.titleoffsetX=i.x,this.titleoffsetY=i.y)}}]),t}();n.TiledMap=u,t.GridSprite=l,t.IMap=n,t.MapLayer=_,t.TileAniSprite=o,t.TileTexSet=p,t.TiledMap=u}(window.Laya=window.Laya||{},Laya)}(); 
 			}); 
		define("__plugin__/wx70d8aa25ec591f7a/laya.ui.js", function(require, module, exports){ 			
!function(){"use strict";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}function e(t,i,s,n){return(e="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(t,e,i,s){var n,h=l(t,e);if(h){if((n=Object.getOwnPropertyDescriptor(h,e)).set)return n.set.call(s,i),!0;if(!n.writable)return!1}if(n=Object.getOwnPropertyDescriptor(s,e)){if(!n.writable)return!1;n.value=i,Object.defineProperty(s,e,n)}else!function(t,e,i){e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i}(s,e,i);return!0})(t,i,s,n)}function i(t,i,s,n,h){if(!e(t,i,s,n||t)&&h)throw new Error("failed to set property");return s}function s(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function n(t,e,i){return e&&s(t.prototype,e),i&&s(t,i),t}function h(e,i){return!i||"object"!==t(i)&&"function"!=typeof i?a(e):i}function a(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function r(t,e,i){return(r="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){var s=l(t,e);if(s){var n=Object.getOwnPropertyDescriptor(s,e);return n.get?n.get.call(i):n.value}})(t,e,i||t)}function l(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=o(t)););return t}function o(t){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function u(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&function(t,e){(Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}(t,e)}function c(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}!function(t,e){var s=function t(){c(this,t)};s.touchScrollEnable=!0,s.mouseWheelEnable=!0,s.showButtons=!0,s.popupBgColor="#000000",s.popupBgAlpha=.5,s.closeDialogOnSide=!0,window.UIConfig=s;var l=function t(){c(this,t)};l.defaultSizeGrid=[4,4,4,4,0],l.labelColor="#000000",l.labelPadding=[2,2,2,2],l.inputLabelPadding=[1,1,1,3],l.buttonStateNum=3,l.buttonLabelColors=["#32556b","#32cc6b","#ff0000","#C0C0C0"],l.comboBoxItemColors=["#5e95b6","#ffffff","#000000","#8fa4b1","#ffffff"],l.scrollBarMinNum=15,l.scrollBarDelayTime=500;var _=function(t){function i(){var t;return c(this,i),(t=h(this,o(i).apply(this,arguments))).autoCacheCmd=!0,t._width=0,t._height=0,t.uv=null,t}return u(i,e.Graphics),n(i,[{key:"destroy",value:function(){r(o(i.prototype),"destroy",this).call(this),this._source=null,this._sizeGrid=null,this._offset=null}},{key:"_setChanged",value:function(){this._isChanged||(this._isChanged=!0,e.ILaya.timer.callLater(this,this.changeSource))}},{key:"changeSource",value:function(){this._isChanged=!1;var t=this._source;if(t&&t.bitmap){var e=this.width,i=this.height,s=this._sizeGrid,n=t.sourceWidth,h=t.sourceHeight;if(s&&(n!==e||h!==i))return this.clear(),this.draw9Grid(t,0,0,e,i,s),void this._repaint();this.clear(),this.drawTexture(t,this._offset?this._offset[0]:0,this._offset?this._offset[1]:0,e,i,null,1,null,null,this.uv),this._repaint()}}},{key:"drawBitmap",value:function(t,e,i,s){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,h=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;n<.1||h<.1||(!t||e.width==n&&e.height==h?this.drawImage(e,i,s,n,h):this.fillTexture(e,i,s,n,h))}},{key:"sizeGrid",get:function(){return this._sizeGrid},set:function(t){this._sizeGrid=t.map(function(t){return+t}),this._setChanged()}},{key:"width",get:function(){return this._width?this._width:this._source?this._source.sourceWidth:0},set:function(t){this._width!=t&&(this._width=t,this._setChanged())}},{key:"height",get:function(){return this._height?this._height:this._source?this._source.sourceHeight:0},set:function(t){this._height!=t&&(this._height=t,this._setChanged())}},{key:"source",get:function(){return this._source},set:function(t){t?(this._source=t,this._setChanged()):(this._source=null,this.clear())}}],[{key:"getTexture",value:function(t,i,s,n,h){var a;return n<=0&&(n=1),h<=0&&(h=1),t.$_GID||(t.$_GID=e.Utils.getGID()),a&&a._getSource()||(a=e.Texture.createFromTexture(t,i,s,n,h)),a}}]),i}();e.ClassUtils.regClass("laya.ui.AutoBitmap",_),e.ClassUtils.regClass("Laya.AutoBitmap",_);var d=function(t){function i(){var t;return c(this,i),(t=h(this,o(i).apply(this,arguments)))._top=NaN,t._bottom=NaN,t._left=NaN,t._right=NaN,t._centerX=NaN,t._centerY=NaN,t}return u(i,e.Component),n(i,[{key:"onReset",value:function(){this._top=this._bottom=this._left=this._right=this._centerX=this._centerY=NaN}},{key:"_onEnable",value:function(){this.owner.parent?this._onAdded():this.owner.once(e.Event.ADDED,this,this._onAdded)}},{key:"_onDisable",value:function(){this.owner.off(e.Event.ADDED,this,this._onAdded),this.owner.parent&&this.owner.parent.off(e.Event.RESIZE,this,this._onParentResize)}},{key:"_onAdded",value:function(){this.owner.parent&&this.owner.parent.on(e.Event.RESIZE,this,this._onParentResize),this.resetLayoutX(),this.resetLayoutY()}},{key:"_onParentResize",value:function(){var t=this.resetLayoutX(),i=this.resetLayoutY();(t||i)&&this.owner.event(e.Event.RESIZE)}},{key:"resetLayoutX",value:function(){var t=this.owner;if(!t)return!1;var e=t.parent;if(e)if(isNaN(this.centerX)){if(isNaN(this.left))isNaN(this.right)||(t.x=Math.round(e.width-t.displayWidth-this.right+t.pivotX*t.scaleX));else if(t.x=Math.round(this.left+t.pivotX*t.scaleX),!isNaN(this.right)){var i=(e._width-this.left-this.right)/(t.scaleX||.01);if(i!=t.width)return t.width=i,!0}}else t.x=Math.round(.5*(e.width-t.displayWidth)+this.centerX+t.pivotX*t.scaleX);return!1}},{key:"resetLayoutY",value:function(){var t=this.owner;if(!t)return!1;var e=t.parent;if(e)if(isNaN(this.centerY)){if(isNaN(this.top))isNaN(this.bottom)||(t.y=Math.round(e.height-t.displayHeight-this.bottom+t.pivotY*t.scaleY));else if(t.y=Math.round(this.top+t.pivotY*t.scaleY),!isNaN(this.bottom)){var i=(e._height-this.top-this.bottom)/(t.scaleY||.01);if(i!=t.height)return t.height=i,!0}}else t.y=Math.round(.5*(e.height-t.displayHeight)+this.centerY+t.pivotY*t.scaleY);return!1}},{key:"resetLayout",value:function(){this.owner&&(this.resetLayoutX(),this.resetLayoutY())}},{key:"top",get:function(){return this._top},set:function(t){this._top!=t&&(this._top=t,this.resetLayoutY())}},{key:"bottom",get:function(){return this._bottom},set:function(t){this._bottom!=t&&(this._bottom=t,this.resetLayoutY())}},{key:"left",get:function(){return this._left},set:function(t){this._left!=t&&(this._left=t,this.resetLayoutX())}},{key:"right",get:function(){return this._right},set:function(t){this._right!=t&&(this._right=t,this.resetLayoutX())}},{key:"centerX",get:function(){return this._centerX},set:function(t){this._centerX!=t&&(this._centerX=t,this.resetLayoutX())}},{key:"centerY",get:function(){return this._centerY},set:function(t){this._centerY!=t&&(this._centerY=t,this.resetLayoutY())}}]),i}();d.EMPTY=null,e.ILaya.regClass(d),d.EMPTY=new d,e.ClassUtils.regClass("laya.ui.Widget",d),e.ClassUtils.regClass("Laya.Widget",d);var g=function(t){function i(){return c(this,i),h(this,o(i).apply(this,arguments))}return u(i,e.Event),i}();g.SHOW_TIP="showtip",g.HIDE_TIP="hidetip",e.ILaya.regClass(g),e.ClassUtils.regClass("laya.ui.UIEvent",g),e.ClassUtils.regClass("Laya.UIEvent",g);var f=function(){function t(){c(this,t)}return n(t,null,[{key:"fillArray",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=t.concat();if(e)for(var n=e.split(","),h=0,a=Math.min(s.length,n.length);h<a;h++){var r=n[h];s[h]="true"==r||"false"!=r&&r,null!=i&&(s[h]=i(r))}return s}},{key:"toColor",value:function(t){return e.Utils.toHexColor(t)}},{key:"gray",value:function(i){!(arguments.length>1&&void 0!==arguments[1])||arguments[1]?t.addFilter(i,t.grayFilter):t.clearFilter(i,e.ColorFilter)}},{key:"addFilter",value:function(t,e){var i=t.filters||[];i.push(e),t.filters=i}},{key:"clearFilter",value:function(t,e){var i=t.filters;if(null!=i&&i.length>0){for(var s=i.length-1;s>-1;s--)i[s]instanceof e&&i.splice(s,1);t.filters=i}}},{key:"_getReplaceStr",value:function(e){return t.escapeSequence[e]}},{key:"adptString",value:function(e){return e.replace(/\\(\w)/g,t._getReplaceStr)}},{key:"getBindFun",value:function(i){t._funMap||(t._funMap=new e.WeakObject);var s=t._funMap.get(i);if(null==s){var n='"'+i+'"',h="(function(data){if(data==null)return;with(data){try{\nreturn "+(n=n.replace(/^"\${|}"$/g,"").replace(/\${/g,'"+').replace(/}/g,'+"'))+"\n}catch(e){}}})";s=window.Laya._runScript(h),t._funMap.set(i,s)}return s}}]),t}();f.grayFilter=new e.ColorFilter([.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,0,0,0,1,0]),f.escapeSequence={"\\n":"\n","\\t":"\t"},f._funMap=null,e.ClassUtils.regClass("laya.ui.UIUtils",f),e.ClassUtils.regClass("Laya.UIUtils",f);var y=function(t){function i(){var t,e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return c(this,i),(t=h(this,o(i).call(this)))._anchorX=NaN,t._anchorY=NaN,t._widget=d.EMPTY,e&&(t.preinitialize(),t.createChildren(),t.initialize()),t}return u(i,e.Sprite),n(i,[{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];r(o(i.prototype),"destroy",this).call(this,t),this._dataSource=null,this._tag=null,this._toolTip=null}},{key:"preinitialize",value:function(){}},{key:"createChildren",value:function(){}},{key:"initialize",value:function(){}},{key:"get_width",value:function(){return this._width?this._width:this.measureWidth()}},{key:"measureWidth",value:function(){var t=0;this.commitMeasure();for(var e=this.numChildren-1;e>-1;e--){var i=this.getChildAt(e);i._visible&&(t=Math.max(i._x+i.width*i.scaleX,t))}return t}},{key:"commitMeasure",value:function(){}},{key:"get_height",value:function(){return this._height?this._height:this.measureHeight()}},{key:"measureHeight",value:function(){var t=0;this.commitMeasure();for(var e=this.numChildren-1;e>-1;e--){var i=this.getChildAt(e);i._visible&&(t=Math.max(i._y+i.height*i.scaleY,t))}return t}},{key:"get_dataSource",value:function(){return this._dataSource}},{key:"set_dataSource",value:function(t){for(var e in this._dataSource=t,this._dataSource)e in this&&"function"!=typeof this[e]&&(this[e]=this._dataSource[e])}},{key:"get_top",value:function(){return this._widget.top}},{key:"set_top",value:function(t){t!=this._widget.top&&(this._getWidget().top=t)}},{key:"get_bottom",value:function(){return this._widget.bottom}},{key:"set_bottom",value:function(t){t!=this._widget.bottom&&(this._getWidget().bottom=t)}},{key:"_sizeChanged",value:function(){isNaN(this._anchorX)||(this.pivotX=this.anchorX*this.width),isNaN(this._anchorY)||(this.pivotY=this.anchorY*this.height),this.event(e.Event.RESIZE),this._widget!==d.EMPTY&&this._widget.resetLayout()}},{key:"onMouseOver",value:function(t){e.ILaya.stage.event(g.SHOW_TIP,this._toolTip)}},{key:"onMouseOut",value:function(t){e.ILaya.stage.event(g.HIDE_TIP,this._toolTip)}},{key:"_getWidget",value:function(){return this._widget===d.EMPTY&&(this._widget=this.addComponent(d)),this._widget}},{key:"set_scaleX",value:function(t){r(o(i.prototype),"get_scaleX",this).call(this)!=t&&(r(o(i.prototype),"set_scaleX",this).call(this,t),this.event(e.Event.RESIZE))}},{key:"set_scaleY",value:function(t){r(o(i.prototype),"get_scaleY",this).call(this)!=t&&(r(o(i.prototype),"set_scaleY",this).call(this,t),this.event(e.Event.RESIZE))}},{key:"onCompResize",value:function(){this._sizeChanged()}},{key:"set_width",value:function(t){r(o(i.prototype),"get_width",this).call(this)!=t&&(r(o(i.prototype),"set_width",this).call(this,t),this.callLater(this._sizeChanged))}},{key:"set_height",value:function(t){r(o(i.prototype),"get_height",this).call(this)!=t&&(r(o(i.prototype),"set_height",this).call(this,t),this.callLater(this._sizeChanged))}},{key:"get_anchorX",value:function(){return this._anchorX}},{key:"set_anchorX",value:function(t){this._anchorX!=t&&(this._anchorX=t,this.callLater(this._sizeChanged))}},{key:"get_anchorY",value:function(){return this._anchorY}},{key:"set_anchorY",value:function(t){this._anchorY!=t&&(this._anchorY=t,this.callLater(this._sizeChanged))}},{key:"_childChanged",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.callLater(this._sizeChanged),r(o(i.prototype),"_childChanged",this).call(this,t)}},{key:"width",get:function(){return this.get_width()},set:function(t){this.set_width(t)}},{key:"height",get:function(){return this.get_height()},set:function(t){this.set_height(t)}},{key:"dataSource",get:function(){return this.get_dataSource()},set:function(t){this.set_dataSource(t)}},{key:"top",get:function(){return this.get_top()},set:function(t){this.set_top(t)}},{key:"bottom",get:function(){return this.get_bottom()},set:function(t){this.set_bottom(t)}},{key:"left",get:function(){return this._widget.left},set:function(t){t!=this._widget.left&&(this._getWidget().left=t)}},{key:"right",get:function(){return this._widget.right},set:function(t){t!=this._widget.right&&(this._getWidget().right=t)}},{key:"centerX",get:function(){return this._widget.centerX},set:function(t){t!=this._widget.centerX&&(this._getWidget().centerX=t)}},{key:"centerY",get:function(){return this._widget.centerY},set:function(t){t!=this._widget.centerY&&(this._getWidget().centerY=t)}},{key:"tag",get:function(){return this._tag},set:function(t){this._tag=t}},{key:"toolTip",get:function(){return this._toolTip},set:function(t){this._toolTip!=t&&(this._toolTip=t,null!=t?(this.on(e.Event.MOUSE_OVER,this,this.onMouseOver),this.on(e.Event.MOUSE_OUT,this,this.onMouseOut)):(this.off(e.Event.MOUSE_OVER,this,this.onMouseOver),this.off(e.Event.MOUSE_OUT,this,this.onMouseOut)))}},{key:"gray",get:function(){return this._gray},set:function(t){t!==this._gray&&(this._gray=t,f.gray(this,t))}},{key:"disabled",get:function(){return this._disabled},set:function(t){t!==this._disabled&&(this.gray=this._disabled=t,this.mouseEnabled=!t)}},{key:"scaleX",set:function(t){this.set_scaleX(t)},get:function(){return r(o(i.prototype),"scaleX",this)}},{key:"scaleY",set:function(t){this.set_scaleY(t)},get:function(){return r(o(i.prototype),"scaleY",this)}},{key:"anchorX",get:function(){return this.get_anchorX()},set:function(t){this.set_anchorX(t)}},{key:"anchorY",get:function(){return this.get_anchorY()},set:function(t){this.set_anchorY(t)}}]),i}();e.ILaya.regClass(y),e.ClassUtils.regClass("laya.ui.UIComponent",y),e.ClassUtils.regClass("Laya.UIComponent",y);var v=function(t){function s(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return c(this,s),(t=h(this,o(s).call(this))).skin=e,t}return u(s,y),n(s,[{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];r(o(s.prototype),"destroy",this).call(this,t),this._bitmap&&this._bitmap.destroy(),this._bitmap=null}},{key:"dispose",value:function(){this.destroy(!0),e.ILaya.loader.clearRes(this._skin)}},{key:"createChildren",value:function(){this.graphics=this._bitmap=new _,this._bitmap.autoCacheCmd=!1}},{key:"setSource",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t===this._skin&&e&&(this.source=e,this.onCompResize())}},{key:"measureWidth",value:function(){return this._bitmap.width}},{key:"measureHeight",value:function(){return this._bitmap.height}},{key:"skin",get:function(){return this._skin},set:function(t){if(this._skin!=t)if(this._skin=t,t){var i=e.Loader.getRes(t);i?(this.source=i,this.onCompResize()):e.ILaya.loader.load(this._skin,e.Handler.create(this,this.setSource,[this._skin]),null,e.Loader.IMAGE,1,!0,this._group)}else this.source=null}},{key:"source",get:function(){return this._bitmap.source},set:function(t){this._bitmap&&(this._bitmap.source=t,this.event(e.Event.LOADED),this.repaint())}},{key:"group",get:function(){return this._group},set:function(t){t&&this._skin&&e.Loader.setGroup(this._skin,t),this._group=t}},{key:"width",set:function(t){i(o(s.prototype),"width",t,this,!0),this._bitmap.width=0==t?1e-7:t},get:function(){return r(o(s.prototype),"width",this)}},{key:"height",set:function(t){i(o(s.prototype),"height",t,this,!0),this._bitmap.height=0==t?1e-7:t},get:function(){return r(o(s.prototype),"height",this)}},{key:"sizeGrid",get:function(){return this._bitmap.sizeGrid?this._bitmap.sizeGrid.join(","):null},set:function(t){this._bitmap.sizeGrid=f.fillArray(l.defaultSizeGrid,t,Number)}},{key:"dataSource",set:function(t){this._dataSource=t,"string"==typeof t?this.skin=t:i(o(s.prototype),"dataSource",t,this,!0)},get:function(){return r(o(s.prototype),"dataSource",this)}}]),s}();e.ILaya.regClass(v),e.ClassUtils.regClass("laya.ui.Image",v),e.ClassUtils.regClass("Laya.Image",v);var p=function(t){function i(){var t,s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return c(this,i),(t=h(this,o(i).call(this))).advsListArr=[],t.resUrl="https://unioncdn.layabox.com/config/iconlist.json",t._http=new e.Browser.window.XMLHttpRequest,t._data=[],t._resquestTime=36e4,t._playIndex=0,t._lunboTime=5e3,t.skin=s,t.setLoadUrl(),t.init(),t.size(120,120),t}return u(i,v),n(i,[{key:"setLoadUrl",value:function(){}},{key:"init",value:function(){this.isSupportJump()?((e.Browser.onMiniGame||e.Browser.onBDMiniGame)&&e.ILaya.timer.loop(this._resquestTime,this,this.onGetAdvsListData),this.onGetAdvsListData(),this.initEvent()):this.visible=!1}},{key:"initEvent",value:function(){this.on(e.Event.CLICK,this,this.onAdvsImgClick)}},{key:"onAdvsImgClick",value:function(){this.getCurrentAppidObj()&&this.jumptoGame()}},{key:"revertAdvsData",value:function(){this.advsListArr[this._playIndex]&&(this.visible=!0,this.skin=this.advsListArr[this._playIndex])}},{key:"isSupportJump",value:function(){return e.Browser.onMiniGame?window.wx.navigateToMiniProgram instanceof Function:!!e.Browser.onBDMiniGame}},{key:"jumptoGame",value:function(){var t=this.advsListArr[this._playIndex];parseInt(t.gameid),t.extendInfo,t.path,e.Browser.onMiniGame?this.isSupportJump()&&window.wx.navigateToMiniProgram({appId:this._appid,path:"",extraData:"",envVersion:"release",success:function(){console.log("-------------跳转成功--------------")},fail:function(){console.log("-------------跳转失败--------------")},complete:function(){console.log("-------------跳转接口调用成功--------------"),this.updateAdvsInfo()}.bind(this)}):e.Browser.onBDMiniGame||(this.visible=!1)}},{key:"updateAdvsInfo",value:function(){this.visible=!1,this.onLunbo(),e.ILaya.timer.loop(this._lunboTime,this,this.onLunbo)}},{key:"onLunbo",value:function(){this._playIndex>=this.advsListArr.length-1?this._playIndex=0:this._playIndex+=1,this.visible=!0,this.revertAdvsData()}},{key:"getCurrentAppidObj",value:function(){return this.advsListArr[this._playIndex]}},{key:"onGetAdvsListData",value:function(){var t=this,e=i.randRange(1e4,1e6),s=this.resUrl+"?"+e;this._http.open("get",s,!0),this._http.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),this._http.responseType="text",this._http.onerror=function(e){t._onError(e)},this._http.onload=function(e){t._onLoad(e)},this._http.send(null)}},{key:"_onError",value:function(t){this.error("Request failed Status:"+this._http.status+" text:"+this._http.statusText)}},{key:"_onLoad",value:function(t){var e=this._http,i=void 0!==e.status?e.status:200;200===i||204===i||0===i?this.complete():this.error("["+e.status+"]"+e.statusText+":"+e.responseURL)}},{key:"error",value:function(t){this.event(e.Event.ERROR,t)}},{key:"complete",value:function(){try{this._data=this._http.response||this._http.responseText,this._data=JSON.parse(this._data),this.advsListArr=this._data.list,this._appid=this._data.appid,this.updateAdvsInfo(),this.revertAdvsData()}catch(t){this.error(t.message)}}},{key:"getAdvsQArr",value:function(t){var i=[],s=e.LocalStorage.getJSON("gameObj");for(var n in t){var h=t[n];s&&s[h.gameid]&&!h.isQiangZhi||i.push(h)}return i}},{key:"clear",value:function(){var t=this._http;t.onerror=t.onabort=t.onprogress=t.onload=null}},{key:"destroy",value:function(){!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e.ILaya.timer.clear(this,this.onLunbo),r(o(i.prototype),"destroy",this).call(this,!0),this.clear(),e.ILaya.timer.clear(this,this.onGetAdvsListData)}}],[{key:"randRange",value:function(t,e){return Math.floor(Math.random()*(e-t+1))+t}}]),i}();e.ClassUtils.regClass("laya.ui.AdvImage",p),e.ClassUtils.regClass("Laya.AdvImage",p);var k=function(t){function i(){return c(this,i),h(this,o(i).apply(this,arguments))}return u(i,y),n(i,[{key:"_onResize",value:function(t){this.graphics.clear(),this.graphics.drawRect(0,0,this.width,this.height,this._bgColor)}},{key:"dataSource",set:function(t){for(var e in this._dataSource=t,t){var i=this.getChildByName(e);i?i.dataSource=t[e]:e in this&&!(this[e]instanceof Function)&&(this[e]=t[e])}},get:function(){return r(o(i.prototype),"dataSource",this)}},{key:"bgColor",get:function(){return this._bgColor},set:function(t){this._bgColor=t,t?(this._onResize(null),this.on(e.Event.RESIZE,this,this._onResize)):(this.graphics.clear(),this.off(e.Event.RESIZE,this,this._onResize))}}]),i}();e.ILaya.regClass(k),e.ClassUtils.regClass("laya.ui.Box",k),e.ClassUtils.regClass("Laya.Box",k);var C=function(t){function i(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return c(this,i),(t=h(this,o(i).call(this)))._labelColors=l.buttonLabelColors,t._state=0,t._autoSize=!0,t._stateNum=l.buttonStateNum,t._stateChanged=!1,t.skin=e,t.label=s,t}return u(i,y),n(i,[{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];r(o(i.prototype),"destroy",this).call(this,t),this._bitmap&&this._bitmap.destroy(),this._text&&this._text.destroy(t),this._bitmap=null,this._text=null,this._clickHandler=null,this._labelColors=this._sources=this._strokeColors=null}},{key:"createChildren",value:function(){this.graphics=this._bitmap=new _}},{key:"createText",value:function(){this._text||(this._text=new e.Text,this._text.overflow=e.Text.HIDDEN,this._text.align="center",this._text.valign="middle",this._text.width=this._width,this._text.height=this._height)}},{key:"initialize",value:function(){1!==this._mouseState&&(this.mouseEnabled=!0,this._setBit(e.Const.HAS_MOUSE,!0)),this._createListener(e.Event.MOUSE_OVER,this,this.onMouse,null,!1,!1),this._createListener(e.Event.MOUSE_OUT,this,this.onMouse,null,!1,!1),this._createListener(e.Event.MOUSE_DOWN,this,this.onMouse,null,!1,!1),this._createListener(e.Event.MOUSE_UP,this,this.onMouse,null,!1,!1),this._createListener(e.Event.CLICK,this,this.onMouse,null,!1,!1)}},{key:"onMouse",value:function(t){if(!1!==this.toggle||!this._selected)return t.type===e.Event.CLICK?(this.toggle&&(this.selected=!this._selected),void(this._clickHandler&&this._clickHandler.run())):void(!this._selected&&(this.state=i.stateMap[t.type]))}},{key:"_skinLoaded",value:function(){this.callLater(this.changeClips),this._setStateChanged(),this._sizeChanged(),this.event(e.Event.LOADED)}},{key:"changeClips",value:function(){var t=e.Loader.getRes(this._skin);if(t){var i=t.sourceWidth,s=t.sourceHeight/this._stateNum;t.$_GID||(t.$_GID=e.Utils.getGID());var n=t.$_GID+"-"+this._stateNum,h=e.WeakObject.I.get(n);if(e.Utils.isOkTextureList(h)||(h=null),h)this._sources=h;else{if(this._sources=[],1===this._stateNum)this._sources.push(t);else for(var a=0;a<this._stateNum;a++)this._sources.push(e.Texture.createFromTexture(t,0,s*a,i,s));e.WeakObject.I.set(n,this._sources)}this._autoSize?(this._bitmap.width=this._width||i,this._bitmap.height=this._height||s,this._text&&(this._text.width=this._bitmap.width,this._text.height=this._bitmap.height)):this._text&&(this._text.x=i)}else console.log("lose skin",this._skin)}},{key:"measureWidth",value:function(){return this.runCallLater(this.changeClips),this._autoSize?this._bitmap.width:(this.runCallLater(this.changeState),this._bitmap.width+(this._text?this._text.width:0))}},{key:"measureHeight",value:function(){return this.runCallLater(this.changeClips),this._text?Math.max(this._bitmap.height,this._text.height):this._bitmap.height}},{key:"changeState",value:function(){this._stateChanged=!1,this.runCallLater(this.changeClips);var t=this._state<this._stateNum?this._state:this._stateNum-1;this._sources&&(this._bitmap.source=this._sources[t]),this.label&&(this._text.color=this._labelColors[t],this._strokeColors&&(this._text.strokeColor=this._strokeColors[t]))}},{key:"_setStateChanged",value:function(){this._stateChanged||(this._stateChanged=!0,this.callLater(this.changeState))}},{key:"skin",get:function(){return this._skin},set:function(t){this._skin!=t&&(this._skin=t,t?e.Loader.getRes(t)?this._skinLoaded():e.ILaya.loader.load(this._skin,e.Handler.create(this,this._skinLoaded),null,e.Loader.IMAGE,1):this._skinLoaded())}},{key:"stateNum",get:function(){return this._stateNum},set:function(t){"string"==typeof t&&(t=parseInt(t)),this._stateNum!=t&&(this._stateNum=t<1?1:t>3?3:t,this.callLater(this.changeClips))}},{key:"label",get:function(){return this._text?this._text.text:null},set:function(t){(this._text||t)&&(this.createText(),this._text.text!=t&&(t&&!this._text.parent&&this.addChild(this._text),this._text.text=(t+"").replace(/\\n/g,"\n"),this._setStateChanged()))}},{key:"selected",get:function(){return this._selected},set:function(t){this._selected!=t&&(this._selected=t,this.state=this._selected?2:0,this.event(e.Event.CHANGE))}},{key:"state",get:function(){return this._state},set:function(t){this._state!=t&&(this._state=t,this._setStateChanged())}},{key:"labelColors",get:function(){return this._labelColors.join(",")},set:function(t){this._labelColors=f.fillArray(l.buttonLabelColors,t,String),this._setStateChanged()}},{key:"strokeColors",get:function(){return this._strokeColors?this._strokeColors.join(","):""},set:function(t){this._strokeColors=f.fillArray(l.buttonLabelColors,t,String),this._setStateChanged()}},{key:"labelPadding",get:function(){return this.createText(),this._text.padding.join(",")},set:function(t){this.createText(),this._text.padding=f.fillArray(l.labelPadding,t,Number)}},{key:"labelSize",get:function(){return this.createText(),this._text.fontSize},set:function(t){this.createText(),this._text.fontSize=t}},{key:"labelStroke",get:function(){return this.createText(),this._text.stroke},set:function(t){this.createText(),this._text.stroke=t}},{key:"labelStrokeColor",get:function(){return this.createText(),this._text.strokeColor},set:function(t){this.createText(),this._text.strokeColor=t}},{key:"labelBold",get:function(){return this.createText(),this._text.bold},set:function(t){this.createText(),this._text.bold=t}},{key:"labelFont",get:function(){return this.createText(),this._text.font},set:function(t){this.createText(),this._text.font=t}},{key:"labelAlign",get:function(){return this.createText(),this._text.align},set:function(t){this.createText(),this._text.align=t}},{key:"clickHandler",get:function(){return this._clickHandler},set:function(t){this._clickHandler=t}},{key:"text",get:function(){return this.createText(),this._text}},{key:"sizeGrid",get:function(){return this._bitmap.sizeGrid?this._bitmap.sizeGrid.join(","):null},set:function(t){this._bitmap.sizeGrid=f.fillArray(l.defaultSizeGrid,t,Number)}},{key:"width",set:function(t){r(o(i.prototype),"set_width",this).call(this,t),this._autoSize&&(this._bitmap.width=t,this._text&&(this._text.width=t))},get:function(){return r(o(i.prototype),"get_width",this).call(this)}},{key:"height",set:function(t){r(o(i.prototype),"set_height",this).call(this,t),this._autoSize&&(this._bitmap.height=t,this._text&&(this._text.height=t))},get:function(){return r(o(i.prototype),"get_height",this).call(this)}},{key:"dataSource",set:function(t){this._dataSource=t,"number"==typeof t||"string"==typeof t?this.label=t+"":r(o(i.prototype),"set_dataSource",this).call(this,t)},get:function(){return r(o(i.prototype),"get_dataSource",this).call(this)}},{key:"iconOffset",get:function(){return this._bitmap._offset?this._bitmap._offset.join(","):null},set:function(t){this._bitmap._offset=t?f.fillArray([1,1],t,Number):[]}}]),i}();C.stateMap={mouseup:0,mouseover:1,mousedown:2,mouseout:0},e.ILaya.regClass(C),e.ClassUtils.regClass("laya.ui.Button",C),e.ClassUtils.regClass("Laya.Button",C);var m=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return c(this,e),(t=h(this,o(e).call(this,i,s))).toggle=!0,t._autoSize=!1,t}return u(e,C),n(e,[{key:"preinitialize",value:function(){r(o(e.prototype),"preinitialize",this).call(this),this.toggle=!0,this._autoSize=!1}},{key:"initialize",value:function(){r(o(e.prototype),"initialize",this).call(this),this.createText(),this._text.align="left",this._text.valign="top",this._text.width=0}},{key:"dataSource",set:function(t){this._dataSource=t,t instanceof Boolean?this.selected=t:"string"==typeof t?this.selected="true"===t:i(o(e.prototype),"dataSource",t,this,!0)},get:function(){return r(o(e.prototype),"dataSource",this)}}]),e}();e.ILaya.regClass(m),e.ClassUtils.regClass("laya.ui.CheckBox",m),e.ClassUtils.regClass("Laya.CheckBox",m);var S=function(t){function s(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return c(this,s),(t=h(this,o(s).call(this)))._clipX=1,t._clipY=1,t._clipWidth=0,t._clipHeight=0,t._interval=50,t._index=0,t._toIndex=-1,t._clipX=i,t._clipY=n,t.skin=e,t}return u(s,y),n(s,[{key:"destroy",value:function(){!(arguments.length>0&&void 0!==arguments[0])||arguments[0],r(o(s.prototype),"destroy",this).call(this,!0),this._bitmap&&this._bitmap.destroy(),this._bitmap=null,this._sources=null}},{key:"dispose",value:function(){this.destroy(!0),e.ILaya.loader.clearRes(this._skin)}},{key:"createChildren",value:function(){this.graphics=this._bitmap=new _}},{key:"_onDisplay",value:function(t){this._isPlaying?this._getBit(e.Const.DISPLAYED_INSTAGE)?this.play():this.stop():this._autoPlay&&this.play()}},{key:"_skinLoaded",value:function(){this._setClipChanged(),this._sizeChanged(),this.event(e.Event.LOADED)}},{key:"changeClip",value:function(){if(this._clipChanged=!1,this._skin){var t=e.Loader.getRes(this._skin);t?this.loadComplete(this._skin,t):e.ILaya.loader.load(this._skin,e.Handler.create(this,this.loadComplete,[this._skin]))}}},{key:"loadComplete",value:function(t,i){if(t===this._skin&&i){var s=this._clipWidth||Math.ceil(i.sourceWidth/this._clipX),n=this._clipHeight||Math.ceil(i.sourceHeight/this._clipY),h=this._skin+s+n,a=e.WeakObject.I.get(h);if(e.Utils.isOkTextureList(a)||(a=null),a)this._sources=a;else{this._sources=[];for(var r=0;r<this._clipY;r++)for(var l=0;l<this._clipX;l++)this._sources.push(e.Texture.createFromTexture(i,s*l,n*r,s,n));e.WeakObject.I.set(h,this._sources)}this.index=this._index,this.event(e.Event.LOADED),this.onCompResize()}}},{key:"measureWidth",value:function(){return this.runCallLater(this.changeClip),this._bitmap.width}},{key:"measureHeight",value:function(){return this.runCallLater(this.changeClip),this._bitmap.height}},{key:"play",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;this._isPlaying=!0,this.index=t,this._toIndex=i,this._index++,e.ILaya.timer.loop(this.interval,this,this._loop),this.on(e.Event.DISPLAY,this,this._onDisplay),this.on(e.Event.UNDISPLAY,this,this._onDisplay)}},{key:"_loop",value:function(){this._visible&&this._sources&&(this._index++,this._toIndex>-1&&this._index>=this._toIndex?this.stop():this._index>=this._sources.length&&(this._index=0),this.index=this._index)}},{key:"stop",value:function(){this._isPlaying=!1,e.ILaya.timer.clear(this,this._loop),this.event(e.Event.COMPLETE)}},{key:"_setClipChanged",value:function(){this._clipChanged||(this._clipChanged=!0,this.callLater(this.changeClip))}},{key:"skin",get:function(){return this._skin},set:function(t){this._skin!=t&&(this._skin=t,t?e.Loader.getRes(t)?this._skinLoaded():e.ILaya.loader.load(this._skin,e.Handler.create(this,this._skinLoaded),null,e.Loader.IMAGE,1):this._bitmap.source=null)}},{key:"clipX",get:function(){return this._clipX},set:function(t){this._clipX=t||1,this._setClipChanged()}},{key:"clipY",get:function(){return this._clipY},set:function(t){this._clipY=t||1,this._setClipChanged()}},{key:"clipWidth",get:function(){return this._clipWidth},set:function(t){this._clipWidth=t,this._setClipChanged()}},{key:"clipHeight",get:function(){return this._clipHeight},set:function(t){this._clipHeight=t,this._setClipChanged()}},{key:"sources",get:function(){return this._sources},set:function(t){this._sources=t,this.index=this._index,this.event(e.Event.LOADED)}},{key:"group",get:function(){return this._group},set:function(t){t&&this._skin&&e.Loader.setGroup(this._skin,t),this._group=t}},{key:"width",set:function(t){i(o(s.prototype),"width",t,this,!0),this._bitmap.width=t},get:function(){return r(o(s.prototype),"width",this)}},{key:"height",set:function(t){i(o(s.prototype),"height",t,this,!0),this._bitmap.height=t},get:function(){return r(o(s.prototype),"height",this)}},{key:"sizeGrid",get:function(){return this._bitmap.sizeGrid?this._bitmap.sizeGrid.join(","):null},set:function(t){this._bitmap.sizeGrid=f.fillArray(l.defaultSizeGrid,t,Number)}},{key:"index",get:function(){return this._index},set:function(t){this._index=t,this._bitmap&&this._sources&&(this._bitmap.source=this._sources[t]),this.event(e.Event.CHANGE)}},{key:"total",get:function(){return this.runCallLater(this.changeClip),this._sources?this._sources.length:0}},{key:"autoPlay",get:function(){return this._autoPlay},set:function(t){this._autoPlay!=t&&(this._autoPlay=t,t?this.play():this.stop())}},{key:"interval",get:function(){return this._interval},set:function(t){this._interval!=t&&(this._interval=t,this._isPlaying&&this.play())}},{key:"isPlaying",get:function(){return this._isPlaying},set:function(t){this._isPlaying=t}},{key:"dataSource",set:function(t){this._dataSource=t,"number"==typeof t||"string"==typeof t?this.index=parseInt(t):i(o(s.prototype),"dataSource",t,this,!0)},get:function(){return r(o(s.prototype),"dataSource",this)}},{key:"bitmap",get:function(){return this._bitmap}}]),s}();e.ILaya.regClass(S),e.ClassUtils.regClass("laya.ui.Clip",S),e.ClassUtils.regClass("Laya.Clip",S);var b=function(t){function i(){var t,e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return c(this,i),(t=h(this,o(i).call(this,!1)))._gridSize=11,t._bgColor="#ffffff",t._borderColor="#000000",t._inputColor="#000000",t._inputBgColor="#efefef",t._colors=[],t._selectedColor="#000000",e&&(t.preinitialize(),t.createChildren(),t.initialize()),t}return u(i,y),n(i,[{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];e.ILaya.stage.off(e.Event.MOUSE_DOWN,this,this.removeColorBox),r(o(i.prototype),"destroy",this).call(this,t),this._colorPanel&&this._colorPanel.destroy(t),this._colorButton&&this._colorButton.destroy(t),this._colorPanel=null,this._colorTiles=null,this._colorBlock=null,this._colorInput=null,this._colorButton=null,this._colors=null,this.changeHandler=null}},{key:"createChildren",value:function(){this.addChild(this._colorButton=new C),this._colorPanel=new k,this._colorPanel.size(230,166),this._colorPanel.addChild(this._colorTiles=new e.Sprite),this._colorPanel.addChild(this._colorBlock=new e.Sprite),this._colorPanel.addChild(this._colorInput=new e.Input)}},{key:"initialize",value:function(){this._colorButton.on(e.Event.CLICK,this,this.onColorButtonClick),this._colorBlock.pos(5,5),this._colorInput.pos(60,5),this._colorInput.size(60,20),this._colorInput.on(e.Event.CHANGE,this,this.onColorInputChange),this._colorInput.on(e.Event.KEY_DOWN,this,this.onColorFieldKeyDown),this._colorTiles.pos(5,30),this._colorTiles.on(e.Event.MOUSE_MOVE,this,this.onColorTilesMouseMove),this._colorTiles.on(e.Event.CLICK,this,this.onColorTilesClick),this._colorTiles.size(20*this._gridSize,12*this._gridSize),this._colorPanel.on(e.Event.MOUSE_DOWN,this,this.onPanelMouseDown),this.bgColor=this._bgColor}},{key:"onPanelMouseDown",value:function(t){t.stopPropagation()}},{key:"changePanel",value:function(){this._panelChanged=!1;var t=this._colorPanel.graphics;t.clear(!0),t.drawRect(0,0,230,166,this._bgColor,this._borderColor),this.drawBlock(this._selectedColor),this._colorInput.borderColor=this._borderColor,this._colorInput.bgColor=this._inputBgColor,this._colorInput.color=this._inputColor,(t=this._colorTiles.graphics).clear(!0);for(var e=[0,3355443,6710886,10066329,13421772,16777215,16711680,65280,255,16776960,65535,16711935],i=0;i<12;i++)for(var s=0;s<20;s++){var n;n=0===s?e[i]:1===s?0:51*(((3*i+s/6)%3<<0)+3*(i/6<<0))<<16|s%6*51<<8|(i<<0)%6*51;var h=f.toColor(n);this._colors.push(h);var a=s*this._gridSize,r=i*this._gridSize;t.drawRect(a,r,this._gridSize,this._gridSize,h,"#000000")}}},{key:"onColorButtonClick",value:function(t){this._colorPanel.parent?this.close():this.open()}},{key:"open",value:function(){var t=e.ILaya.stage,i=this.localToGlobal(new e.Point),s=i.x+this._colorPanel.width<=t.width?i.x:t.width-this._colorPanel.width,n=i.y+this._colorButton.height;n=n+this._colorPanel.height<=t.height?n:i.y-this._colorPanel.height,this._colorPanel.pos(s,n),this._colorPanel.zOrder=1001,t.addChild(this._colorPanel),t.on(e.Event.MOUSE_DOWN,this,this.removeColorBox)}},{key:"close",value:function(){e.ILaya.stage.off(e.Event.MOUSE_DOWN,this,this.removeColorBox),this._colorPanel.removeSelf()}},{key:"removeColorBox",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0],this.close()}},{key:"onColorFieldKeyDown",value:function(t){13==t.keyCode&&(this._colorInput.text?this.selectedColor=this._colorInput.text:this.selectedColor=null,this.close(),t.stopPropagation())}},{key:"onColorInputChange",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0],this._colorInput.text?this.drawBlock(this._colorInput.text):this.drawBlock("#FFFFFF")}},{key:"onColorTilesClick",value:function(t){this.selectedColor=this.getColorByMouse(),this.close()}},{key:"onColorTilesMouseMove",value:function(t){this._colorInput.focus=!1;var e=this.getColorByMouse();this._colorInput.text=e,this.drawBlock(e)}},{key:"getColorByMouse",value:function(){var t=this._colorTiles.getMousePoint(),e=Math.floor(t.x/this._gridSize),i=Math.floor(t.y/this._gridSize);return this._colors[20*i+e]}},{key:"drawBlock",value:function(t){var e=this._colorBlock.graphics;e.clear(!0);var i=t||"#ffffff";e.drawRect(0,0,50,20,i,this._borderColor),t||e.drawLine(0,0,50,20,"#ff0000")}},{key:"changeColor",value:function(){var t=this.graphics;t.clear(!0);var e=this._selectedColor||"#000000";t.drawRect(0,0,this._colorButton.width,this._colorButton.height,e)}},{key:"_setPanelChanged",value:function(){this._panelChanged||(this._panelChanged=!0,this.callLater(this.changePanel))}},{key:"selectedColor",get:function(){return this._selectedColor},set:function(t){this._selectedColor!=t&&(this._selectedColor=this._colorInput.text=t,this.drawBlock(t),this.changeColor(),this.changeHandler&&this.changeHandler.runWith(this._selectedColor),this.event(e.Event.CHANGE,e.Event.EMPTY.setTo(e.Event.CHANGE,this,this)))}},{key:"skin",get:function(){return this._colorButton.skin},set:function(t){this._colorButton.once(e.Event.LOADED,this,this.changeColor),this._colorButton.skin=t}},{key:"bgColor",get:function(){return this._bgColor},set:function(t){this._bgColor=t,this._setPanelChanged()}},{key:"borderColor",get:function(){return this._borderColor},set:function(t){this._borderColor=t,this._setPanelChanged()}},{key:"inputColor",get:function(){return this._inputColor},set:function(t){this._inputColor=t,this._setPanelChanged()}},{key:"inputBgColor",get:function(){return this._inputBgColor},set:function(t){this._inputBgColor=t,this._setPanelChanged()}}]),i}();e.ILaya.regClass(b),e.ClassUtils.regClass("laya.ui.ColorPicker",b),e.ClassUtils.regClass("Laya.ColorPicker",b);var w=function(t){function s(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return c(this,s),(t=h(this,o(s).call(this))).text=e,t}return u(s,y),n(s,[{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];r(o(s.prototype),"destroy",this).call(this,t),this._tf=null}},{key:"createChildren",value:function(){this.addChild(this._tf=new e.Text)}},{key:"changeText",value:function(t){this._tf.changeText(t)}},{key:"measureWidth",value:function(){return this._tf.width}},{key:"measureHeight",value:function(){return this._tf.height}},{key:"text",get:function(){return this._tf.text},set:function(t){this._tf.text!=t&&(t&&(t=f.adptString(t+"")),this._tf.text=t,this.event(e.Event.CHANGE),this._width&&this._height||this.onCompResize())}},{key:"wordWrap",get:function(){return this._tf.wordWrap},set:function(t){this._tf.wordWrap=t}},{key:"color",get:function(){return this._tf.color},set:function(t){this._tf.color=t}},{key:"font",get:function(){return this._tf.font},set:function(t){this._tf.font=t}},{key:"align",get:function(){return this._tf.align},set:function(t){this._tf.align=t}},{key:"valign",get:function(){return this._tf.valign},set:function(t){this._tf.valign=t}},{key:"bold",get:function(){return this._tf.bold},set:function(t){this._tf.bold=t}},{key:"italic",get:function(){return this._tf.italic},set:function(t){this._tf.italic=t}},{key:"leading",get:function(){return this._tf.leading},set:function(t){this._tf.leading=t}},{key:"fontSize",get:function(){return this._tf.fontSize},set:function(t){this._tf.fontSize=t}},{key:"padding",get:function(){return this._tf.padding.join(",")},set:function(t){this._tf.padding=f.fillArray(l.labelPadding,t,Number)}},{key:"bgColor",get:function(){return this._tf.bgColor},set:function(t){this._tf.bgColor=t}},{key:"borderColor",get:function(){return this._tf.borderColor},set:function(t){this._tf.borderColor=t}},{key:"stroke",get:function(){return this._tf.stroke},set:function(t){this._tf.stroke=t}},{key:"strokeColor",get:function(){return this._tf.strokeColor},set:function(t){this._tf.strokeColor=t}},{key:"textField",get:function(){return this._tf}},{key:"width",get:function(){return this._width||this._tf.text?r(o(s.prototype),"width",this):0},set:function(t){i(o(s.prototype),"width",t,this,!0),this._tf.width=t}},{key:"height",get:function(){return this._height||this._tf.text?r(o(s.prototype),"height",this):0},set:function(t){i(o(s.prototype),"height",t,this,!0),this._tf.height=t}},{key:"dataSource",set:function(t){this._dataSource=t,"number"==typeof t||"string"==typeof t?this.text=t+"":i(o(s.prototype),"dataSource",t,this,!0)},get:function(){return r(o(s.prototype),"dataSource",this)}},{key:"overflow",get:function(){return this._tf.overflow},set:function(t){this._tf.overflow=t}},{key:"underline",get:function(){return this._tf.underline},set:function(t){this._tf.underline=t}},{key:"underlineColor",get:function(){return this._tf.underlineColor},set:function(t){this._tf.underlineColor=t}}]),s}();e.ILaya.regClass(w),e.ClassUtils.regClass("laya.ui.Label",w),e.ClassUtils.regClass("Laya.Label",w);var L=function(t){function s(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return c(this,s),(t=h(this,o(s).call(this))).isVertical=!0,t.showLabel=!0,t._max=100,t._min=0,t._tick=1,t._value=0,s.label||(s.label=new w),t.skin=e,t}return u(s,y),n(s,[{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];r(o(s.prototype),"destroy",this).call(this,t),this._bg&&this._bg.destroy(t),this._bar&&this._bar.destroy(t),this._progress&&this._progress.destroy(t),this._bg=null,this._bar=null,this._progress=null,this.changeHandler=null}},{key:"createChildren",value:function(){this.addChild(this._bg=new v),this.addChild(this._bar=new C)}},{key:"initialize",value:function(){this._bar.on(e.Event.MOUSE_DOWN,this,this.onBarMouseDown),this._bg.sizeGrid=this._bar.sizeGrid="4,4,4,4,0",this._progress&&(this._progress.sizeGrid=this._bar.sizeGrid),this.allowClickBack=!0}},{key:"onBarMouseDown",value:function(t){var i=e.ILaya;this._globalSacle||(this._globalSacle=new e.Point),this._globalSacle.setTo(this.globalScaleX||.01,this.globalScaleY||.01),this._maxMove=this.isVertical?this.height-this._bar.height:this.width-this._bar.width,this._tx=i.stage.mouseX,this._ty=i.stage.mouseY,i.stage.on(e.Event.MOUSE_MOVE,this,this.mouseMove),i.stage.once(e.Event.MOUSE_UP,this,this.mouseUp),i.stage.once(e.Event.MOUSE_OUT,this,this.mouseUp),this.showValueText()}},{key:"showValueText",value:function(){if(this.showLabel){var t=s.label;this.addChild(t),t.textField.changeText(this._value+""),this.isVertical?(t.x=this._bar._x+20,t.y=.5*(this._bar.height-t.height)+this._bar._y):(t.y=this._bar._y-20,t.x=.5*(this._bar.width-t.width)+this._bar._x)}}},{key:"hideValueText",value:function(){s.label&&s.label.removeSelf()}},{key:"mouseUp",value:function(t){var i=e.ILaya.stage;i.off(e.Event.MOUSE_MOVE,this,this.mouseMove),i.off(e.Event.MOUSE_UP,this,this.mouseUp),i.off(e.Event.MOUSE_OUT,this,this.mouseUp),this.sendChangeEvent(e.Event.CHANGED),this.hideValueText()}},{key:"mouseMove",value:function(t){var i=e.ILaya.stage,s=this._value;if(this.isVertical?(this._bar.y+=(i.mouseY-this._ty)/this._globalSacle.y,this._bar._y>this._maxMove?this._bar.y=this._maxMove:this._bar._y<0&&(this._bar.y=0),this._value=this._bar._y/this._maxMove*(this._max-this._min)+this._min,this._progress&&(this._progress.height=this._bar._y+.5*this._bar.height)):(this._bar.x+=(i.mouseX-this._tx)/this._globalSacle.x,this._bar._x>this._maxMove?this._bar.x=this._maxMove:this._bar._x<0&&(this._bar.x=0),this._value=this._bar._x/this._maxMove*(this._max-this._min)+this._min,this._progress&&(this._progress.width=this._bar._x+.5*this._bar.width)),this._tx=i.mouseX,this._ty=i.mouseY,0!=this._tick){var n=Math.pow(10,(this._tick+"").length-1);this._value=Math.round(Math.round(this._value/this._tick)*this._tick*n)/n}this._value!=s&&this.sendChangeEvent(),this.showValueText()}},{key:"sendChangeEvent",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.Event.CHANGE;this.event(t),this.changeHandler&&this.changeHandler.runWith(this._value)}},{key:"_skinLoaded",value:function(){this._bg.skin=this._skin,this._bar.skin=this._skin.replace(".png","$bar.png");var t=this._skin.replace(".png","$progress.png");e.Loader.getRes(t)&&(this._progress||(this.addChild(this._progress=new v),this._progress.sizeGrid=this._bar.sizeGrid,this.setChildIndex(this._progress,1)),this._progress.skin=t),this.setBarPoint(),this.callLater(this.changeValue),this._sizeChanged(),this.event(e.Event.LOADED)}},{key:"setBarPoint",value:function(){this.isVertical?this._bar.x=Math.round(.5*(this._bg.width-this._bar.width)):this._bar.y=Math.round(.5*(this._bg.height-this._bar.height))}},{key:"measureWidth",value:function(){return Math.max(this._bg.width,this._bar.width)}},{key:"measureHeight",value:function(){return Math.max(this._bg.height,this._bar.height)}},{key:"_sizeChanged",value:function(){r(o(s.prototype),"_sizeChanged",this).call(this),this.isVertical?this._bg.height=this.height:this._bg.width=this.width,this.setBarPoint(),this.changeValue()}},{key:"setSlider",value:function(t,e,i){this._value=-1,this._min=t,this._max=e>t?e:t,this.value=i<t?t:i>e?e:i}},{key:"changeValue",value:function(){if(0!=this.tick){var t=Math.pow(10,(this._tick+"").length-1);this._value=Math.round(Math.round(this._value/this._tick)*this._tick*t)/t}this._value=this._value>this._max?this._max:this._value<this._min?this._min:this._value;var e=this._max-this._min;0===e&&(e=1),this.isVertical?(this._bar.y=(this._value-this._min)/e*(this.height-this._bar.height),this._progress&&(this._progress.height=this._bar._y+.5*this._bar.height)):(this._bar.x=(this._value-this._min)/e*(this.width-this._bar.width),this._progress&&(this._progress.width=this._bar._x+.5*this._bar.width))}},{key:"onBgMouseDown",value:function(t){var e=this._bg.getMousePoint();this.isVertical?this.value=e.y/(this.height-this._bar.height)*(this._max-this._min)+this._min:this.value=e.x/(this.width-this._bar.width)*(this._max-this._min)+this._min}},{key:"skin",get:function(){return this._skin},set:function(t){this._skin!=t&&(this._skin=t,this._skin&&!e.Loader.getRes(this._skin)?e.ILaya.loader.load([this._skin,this._skin.replace(".png","$bar.png")],e.Handler.create(this,this._skinLoaded)):this._skinLoaded())}},{key:"sizeGrid",get:function(){return this._bg.sizeGrid},set:function(t){this._bg.sizeGrid=t,this._bar.sizeGrid=t,this._progress&&(this._progress.sizeGrid=this._bar.sizeGrid)}},{key:"tick",get:function(){return this._tick},set:function(t){this._tick!=t&&(this._tick=t,this.callLater(this.changeValue))}},{key:"max",get:function(){return this._max},set:function(t){this._max!=t&&(this._max=t,this.callLater(this.changeValue))}},{key:"min",get:function(){return this._min},set:function(t){this._min!=t&&(this._min=t,this.callLater(this.changeValue))}},{key:"value",get:function(){return this._value},set:function(t){if(this._value!=t){var e=this._value;this._value=t,this.changeValue(),this._value!=e&&this.sendChangeEvent()}}},{key:"allowClickBack",get:function(){return this._allowClickBack},set:function(t){this._allowClickBack!=t&&(this._allowClickBack=t,t?this._bg.on(e.Event.MOUSE_DOWN,this,this.onBgMouseDown):this._bg.off(e.Event.MOUSE_DOWN,this,this.onBgMouseDown))}},{key:"dataSource",set:function(t){this._dataSource=t,"number"==typeof t||"string"==typeof t?this.value=Number(t):i(o(s.prototype),"dataSource",t,this,!0)},get:function(){return r(o(s.prototype),"dataSource",this)}},{key:"bar",get:function(){return this._bar}}]),s}();L.label=null,e.ILaya.regClass(L),e.ClassUtils.regClass("laya.ui.Slider",L),e.ClassUtils.regClass("Laya.Slider",L);var x=function(t){function a(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return c(this,a),(t=h(this,o(a).call(this))).rollRatio=.97,t.scaleBar=!0,t.autoHide=!1,t.elasticDistance=0,t.elasticBackTime=500,t._showButtons=s.showButtons,t._scrollSize=1,t._thumbPercent=1,t._lastOffset=0,t._checkElastic=!1,t._isElastic=!1,t._hide=!1,t._clickOnly=!0,t._touchScrollEnable=s.touchScrollEnable,t._mouseWheelEnable=s.mouseWheelEnable,t.skin=e,t.max=1,t}return u(a,y),n(a,[{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.stopScroll(),this.target=null,r(o(a.prototype),"destroy",this).call(this,t),this.upButton&&this.upButton.destroy(t),this.downButton&&this.downButton.destroy(t),this.slider&&this.slider.destroy(t),this.upButton=this.downButton=null,this.slider=null,this.changeHandler=null,this._offsets=null}},{key:"createChildren",value:function(){this.addChild(this.slider=new L),this.addChild(this.upButton=new C),this.addChild(this.downButton=new C)}},{key:"initialize",value:function(){this.slider.showLabel=!1,this.slider.tick=0,this.slider.on(e.Event.CHANGE,this,this.onSliderChange),this.slider.setSlider(0,0,0),this.upButton.on(e.Event.MOUSE_DOWN,this,this.onButtonMouseDown),this.downButton.on(e.Event.MOUSE_DOWN,this,this.onButtonMouseDown)}},{key:"onSliderChange",value:function(){this._value!=this.slider.value&&(this.value=this.slider.value)}},{key:"onButtonMouseDown",value:function(t){var i=t.currentTarget===this.upButton;this.slide(i),e.ILaya.timer.once(l.scrollBarDelayTime,this,this.startLoop,[i]),e.ILaya.stage.once(e.Event.MOUSE_UP,this,this.onStageMouseUp)}},{key:"startLoop",value:function(t){e.ILaya.timer.frameLoop(1,this,this.slide,[t])}},{key:"slide",value:function(t){t?this.value-=this._scrollSize:this.value+=this._scrollSize}},{key:"onStageMouseUp",value:function(t){e.ILaya.timer.clear(this,this.startLoop),e.ILaya.timer.clear(this,this.slide)}},{key:"_skinLoaded",value:function(){this.slider.skin=this._skin,this.callLater(this.changeScrollBar),this._sizeChanged(),this.event(e.Event.LOADED)}},{key:"changeScrollBar",value:function(){this.upButton.visible=this._showButtons,this.downButton.visible=this._showButtons,this._showButtons&&(this.upButton.skin=this._skin.replace(".png","$up.png"),this.downButton.skin=this._skin.replace(".png","$down.png")),this.slider.isVertical?this.slider.y=this._showButtons?this.upButton.height:0:this.slider.x=this._showButtons?this.upButton.width:0,this.resetPositions(),this.repaint()}},{key:"_sizeChanged",value:function(){r(o(a.prototype),"_sizeChanged",this).call(this),this.repaint(),this.resetPositions(),this.event(e.Event.CHANGE),this.changeHandler&&this.changeHandler.runWith(this.value)}},{key:"resetPositions",value:function(){this.slider.isVertical?this.slider.height=this.height-(this._showButtons?this.upButton.height+this.downButton.height:0):this.slider.width=this.width-(this._showButtons?this.upButton.width+this.downButton.width:0),this.resetButtonPosition()}},{key:"resetButtonPosition",value:function(){this.slider.isVertical?this.downButton.y=this.slider._y+this.slider.height:this.downButton.x=this.slider._x+this.slider.width}},{key:"measureWidth",value:function(){return this.slider.isVertical?this.slider.width:100}},{key:"measureHeight",value:function(){return this.slider.isVertical?100:this.slider.height}},{key:"setScroll",value:function(t,e,i){this.runCallLater(this._sizeChanged),this.slider.setSlider(t,e,i),this.slider.bar.visible=e>0,!this._hide&&this.autoHide&&(this.visible=!1)}},{key:"onTargetMouseWheel",value:function(t){this.value-=t.delta*this._scrollSize,this.target=this._target}},{key:"onTargetMouseDown",value:function(t){this.isLockedFun&&!this.isLockedFun(t)||(this.event(e.Event.END),this._clickOnly=!0,this._lastOffset=0,this._checkElastic=!1,this._lastPoint||(this._lastPoint=new e.Point),this._lastPoint.setTo(e.ILaya.stage.mouseX,e.ILaya.stage.mouseY),e.ILaya.timer.clear(this,this.tweenMove),e.Tween.clearTween(this),e.ILaya.stage.once(e.Event.MOUSE_UP,this,this.onStageMouseUp2),e.ILaya.stage.once(e.Event.MOUSE_OUT,this,this.onStageMouseUp2),e.ILaya.timer.frameLoop(1,this,this.loop))}},{key:"startDragForce",value:function(){this._clickOnly=!0,this._lastOffset=0,this._checkElastic=!1,this._lastPoint||(this._lastPoint=new e.Point),this._lastPoint.setTo(e.ILaya.stage.mouseX,e.ILaya.stage.mouseY),e.ILaya.timer.clear(this,this.tweenMove),e.Tween.clearTween(this),e.ILaya.stage.once(e.Event.MOUSE_UP,this,this.onStageMouseUp2),e.ILaya.stage.once(e.Event.MOUSE_OUT,this,this.onStageMouseUp2),e.ILaya.timer.frameLoop(1,this,this.loop)}},{key:"cancelDragOp",value:function(){e.ILaya.stage.off(e.Event.MOUSE_UP,this,this.onStageMouseUp2),e.ILaya.stage.off(e.Event.MOUSE_OUT,this,this.onStageMouseUp2),e.ILaya.timer.clear(this,this.tweenMove),e.ILaya.timer.clear(this,this.loop),this._target.mouseEnabled=!0}},{key:"checkTriggers",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this.value>=0&&this.value-this._lastOffset<=0&&this.triggerDownDragLimit&&this.triggerDownDragLimit(t)?(this.cancelDragOp(),this.value=0,!0):!!(this.value<=this.max&&this.value-this._lastOffset>=this.max&&this.triggerUpDragLimit&&this.triggerUpDragLimit(t))&&(this.cancelDragOp(),this.value=this.max,!0)}},{key:"startTweenMoveForce",value:function(t){this._lastOffset=t,e.ILaya.timer.frameLoop(1,this,this.tweenMove,[200])}},{key:"loop",value:function(){var t=e.ILaya.stage.mouseY,i=e.ILaya.stage.mouseX;if(this._lastOffset=this.isVertical?t-this._lastPoint.y:i-this._lastPoint.x,this._clickOnly){if(!(Math.abs(this._lastOffset*(this.isVertical?e.ILaya.stage._canvasTransform.getScaleY():e.ILaya.stage._canvasTransform.getScaleX()))>1))return;if(this._clickOnly=!1,this.checkTriggers())return;this._offsets||(this._offsets=[]),this._offsets.length=0,this._target.mouseEnabled=!1,!this.hide&&this.autoHide&&(this.alpha=1,this.visible=!0),this.event(e.Event.START)}else if(this.checkTriggers())return;this._offsets.push(this._lastOffset),this._lastPoint.x=i,this._lastPoint.y=t,0!==this._lastOffset&&(this._checkElastic||(this.elasticDistance>0?this._checkElastic||0==this._lastOffset||(this._lastOffset>0&&this._value<=this.min||this._lastOffset<0&&this._value>=this.max?(this._isElastic=!0,this._checkElastic=!0):this._isElastic=!1):this._checkElastic=!0),this._isElastic?this._value<=this.min?this._lastOffset>0?this.value-=this._lastOffset*Math.max(0,1-(this.min-this._value)/this.elasticDistance):(this.value-=.5*this._lastOffset,this._value>=this.min&&(this._checkElastic=!1)):this._value>=this.max&&(this._lastOffset<0?this.value-=this._lastOffset*Math.max(0,1-(this._value-this.max)/this.elasticDistance):(this.value-=.5*this._lastOffset,this._value<=this.max&&(this._checkElastic=!1))):this.value-=this._lastOffset)}},{key:"onStageMouseUp2",value:function(t){if(e.ILaya.stage.off(e.Event.MOUSE_UP,this,this.onStageMouseUp2),e.ILaya.stage.off(e.Event.MOUSE_OUT,this,this.onStageMouseUp2),e.ILaya.timer.clear(this,this.loop),!(this._clickOnly&&this._value>=this.min&&this._value<=this.max))if(this._target.mouseEnabled=!0,this._isElastic)this._value<this.min?e.Tween.to(this,{value:this.min},this.elasticBackTime,e.Ease.sineOut,e.Handler.create(this,this.elasticOver)):this._value>this.max&&e.Tween.to(this,{value:this.max},this.elasticBackTime,e.Ease.sineOut,e.Handler.create(this,this.elasticOver));else{if(!this._offsets)return;this._offsets.length<1&&(this._offsets[0]=this.isVertical?e.ILaya.stage.mouseY-this._lastPoint.y:e.ILaya.stage.mouseX-this._lastPoint.x);for(var i=0,s=Math.min(this._offsets.length,3),n=0;n<s;n++)i+=this._offsets[this._offsets.length-1-n];if(this._lastOffset=i/s,(i=Math.abs(this._lastOffset))<2)return void this.event(e.Event.END);i>250&&(this._lastOffset=this._lastOffset>0?250:-250);var h=Math.round(Math.abs(this.elasticDistance*(this._lastOffset/150)));e.ILaya.timer.frameLoop(1,this,this.tweenMove,[h])}}},{key:"elasticOver",value:function(){this._isElastic=!1,!this.hide&&this.autoHide&&e.Tween.to(this,{alpha:0},500),this.event(e.Event.END)}},{key:"tweenMove",value:function(t){var i;if(this._lastOffset*=this.rollRatio,!this.checkTriggers(!0)&&(t>0&&(this._lastOffset>0&&this.value<=this.min?(this._isElastic=!0,i=.5*-(this.min-t-this.value),this._lastOffset>i&&(this._lastOffset=i)):this._lastOffset<0&&this.value>=this.max&&(this._isElastic=!0,i=.5*-(this.max+t-this.value),this._lastOffset<i&&(this._lastOffset=i))),this.value-=this._lastOffset,Math.abs(this._lastOffset)<.1)){if(e.ILaya.timer.clear(this,this.tweenMove),this._isElastic)return void(this._value<this.min?e.Tween.to(this,{value:this.min},this.elasticBackTime,e.Ease.sineOut,e.Handler.create(this,this.elasticOver)):this._value>this.max?e.Tween.to(this,{value:this.max},this.elasticBackTime,e.Ease.sineOut,e.Handler.create(this,this.elasticOver)):this.elasticOver());this.event(e.Event.END),!this.hide&&this.autoHide&&e.Tween.to(this,{alpha:0},500)}}},{key:"stopScroll",value:function(){this.onStageMouseUp2(null),e.ILaya.timer.clear(this,this.tweenMove),e.Tween.clearTween(this)}},{key:"skin",get:function(){return this._skin},set:function(t){" "!=t&&this._skin!=t&&(this._skin=t,this._skin&&!e.Loader.getRes(this._skin)?e.ILaya.loader.load([this._skin,this._skin.replace(".png","$up.png"),this._skin.replace(".png","$down.png"),this._skin.replace(".png","$bar.png")],e.Handler.create(this,this._skinLoaded)):this._skinLoaded())}},{key:"max",get:function(){return this.slider.max},set:function(t){this.slider.max=t}},{key:"min",get:function(){return this.slider.min},set:function(t){this.slider.min=t}},{key:"value",get:function(){return this._value},set:function(t){t!==this._value&&(this._value=t,this._isElastic||(this.slider._value!=t&&(this.slider._value=t,this.slider.changeValue()),this._value=this.slider._value),this.event(e.Event.CHANGE),this.changeHandler&&this.changeHandler.runWith(this._value))}},{key:"isVertical",get:function(){return this.slider.isVertical},set:function(t){this.slider.isVertical=t}},{key:"sizeGrid",get:function(){return this.slider.sizeGrid},set:function(t){this.slider.sizeGrid=t}},{key:"scrollSize",get:function(){return this._scrollSize},set:function(t){this._scrollSize=t}},{key:"dataSource",set:function(t){this._dataSource=t,"number"==typeof t||"string"==typeof t?this.value=Number(t):i(o(a.prototype),"dataSource",t,this,!0)},get:function(){return r(o(a.prototype),"dataSource",this)}},{key:"thumbPercent",get:function(){return this._thumbPercent},set:function(t){this.runCallLater(this.changeScrollBar),this.runCallLater(this._sizeChanged),t=t>=1?.99:t,this._thumbPercent=t,this.scaleBar&&(this.slider.isVertical?this.slider.bar.height=Math.max(this.slider.height*t,l.scrollBarMinNum):this.slider.bar.width=Math.max(this.slider.width*t,l.scrollBarMinNum))}},{key:"target",get:function(){return this._target},set:function(t){this._target&&(this._target.off(e.Event.MOUSE_WHEEL,this,this.onTargetMouseWheel),this._target.off(e.Event.MOUSE_DOWN,this,this.onTargetMouseDown)),this._target=t,t&&(this._mouseWheelEnable&&this._target.on(e.Event.MOUSE_WHEEL,this,this.onTargetMouseWheel),this._touchScrollEnable&&this._target.on(e.Event.MOUSE_DOWN,this,this.onTargetMouseDown))}},{key:"hide",get:function(){return this._hide},set:function(t){this._hide=t,this.visible=!t}},{key:"showButtons",get:function(){return this._showButtons},set:function(t){this._showButtons=t,this.callLater(this.changeScrollBar)}},{key:"touchScrollEnable",get:function(){return this._touchScrollEnable},set:function(t){this._touchScrollEnable=t,this.target=this._target}},{key:"mouseWheelEnable",get:function(){return this._mouseWheelEnable},set:function(t){this._mouseWheelEnable=t,this.target=this._target}},{key:"lastOffset",get:function(){return this._lastOffset}},{key:"tick",get:function(){return this.slider.tick},set:function(t){this.slider.tick=t}}]),a}();e.ILaya.regClass(x),e.ClassUtils.regClass("laya.ui.ScrollBar",x),e.ClassUtils.regClass("Laya.ScrollBar",x);var E=function(t){function e(){return c(this,e),h(this,o(e).apply(this,arguments))}return u(e,x),e}();e.ILaya.regClass(E),e.ClassUtils.regClass("laya.ui.VScrollBar",E),e.ClassUtils.regClass("Laya.VScrollBar",E);var I=function(t){function e(){return c(this,e),h(this,o(e).apply(this,arguments))}return u(e,x),n(e,[{key:"initialize",value:function(){r(o(e.prototype),"initialize",this).call(this),this.slider.isVertical=!1}}]),e}();e.ILaya.regClass(I),e.ClassUtils.regClass("laya.ui.HScrollBar",I),e.ClassUtils.regClass("Laya.HScrollBar",I);var B=function(t){function s(){var t;return c(this,s),(t=h(this,o(s).apply(this,arguments))).selectEnable=!1,t.totalPage=0,t._$componentType="List",t._repeatX=0,t._repeatY=0,t._repeatX2=0,t._repeatY2=0,t._spaceX=0,t._spaceY=0,t._cells=[],t._startIndex=0,t._selectedIndex=-1,t._page=0,t._isVertical=!0,t._cellSize=20,t._cellOffset=0,t._createdLine=0,t._offset=new e.Point,t._usedCache=null,t._elasticEnabled=!1,t._preLen=0,t}return u(s,k),n(s,[{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._content&&this._content.destroy(t),this._scrollBar&&this._scrollBar.destroy(t),r(o(s.prototype),"destroy",this).call(this,t),this._content=null,this._scrollBar=null,this._itemRender=null,this._cells=null,this._array=null,this.selectHandler=this.renderHandler=this.mouseHandler=null}},{key:"createChildren",value:function(){this.addChild(this._content=new k)}},{key:"onScrollStart",value:function(){this._usedCache||(this._usedCache=r(o(s.prototype),"cacheAs",this)),i(o(s.prototype),"cacheAs","none",this,!0),this._scrollBar.once(e.Event.END,this,this.onScrollEnd)}},{key:"onScrollEnd",value:function(){i(o(s.prototype),"cacheAs",this._usedCache,this,!0)}},{key:"_removePreScrollBar",value:function(){var t=this.removeChildByName("scrollBar");t&&t.destroy(!0)}},{key:"changeCells",value:function(){if(this._cellChanged=!1,this._itemRender){this.scrollBar=this.getChildByName("scrollBar");var t=this._getOneCell(),e=t.width+this._spaceX||1,i=t.height+this._spaceY||1;this._width>0&&(this._repeatX2=this._isVertical?Math.round(this._width/e):Math.ceil(this._width/e)),this._height>0&&(this._repeatY2=this._isVertical?Math.ceil(this._height/i):Math.round(this._height/i));var s=this._width?this._width:e*this.repeatX-this._spaceX,n=this._height?this._height:i*this.repeatY-this._spaceY;this._cellSize=this._isVertical?i:e,this._cellOffset=this._isVertical?i*Math.max(this._repeatY2,this._repeatY)-n-this._spaceY:e*Math.max(this._repeatX2,this._repeatX)-s-this._spaceX,this._isVertical&&this.vScrollBarSkin?this._scrollBar.height=n:!this._isVertical&&this.hScrollBarSkin&&(this._scrollBar.width=s),this.setContentSize(s,n);var h=this._isVertical?this.repeatX:this.repeatY,a=(this._isVertical?this.repeatY:this.repeatX)+(this._scrollBar?1:0);this._createItems(0,h,a),this._createdLine=a,this._array&&(this.array=this._array,this.runCallLater(this.renderItems))}}},{key:"_getOneCell",value:function(){if(0===this._cells.length){var t=this.createItem();if(this._offset.setTo(t._x,t._y),this.cacheContent)return t;this._cells.push(t)}return this._cells[0]}},{key:"_createItems",value:function(t,e,i){var s=this._content,n=this._getOneCell(),h=n.width+this._spaceX,a=n.height+this._spaceY;if(this.cacheContent){var r=new k;r.cacheAs="normal",r.pos((this._isVertical?0:t)*h,(this._isVertical?t:0)*a),this._content.addChild(r),s=r}else{for(var l=[],o=this._cells.length-1;o>-1;o--){var u=this._cells[o];u.removeSelf(),l.push(u)}this._cells.length=0}for(var c=t;c<i;c++)for(var _=0;_<e;_++)(n=l&&l.length?l.pop():this.createItem()).x=(this._isVertical?_:c)*h-s._x,n.y=(this._isVertical?c:_)*a-s._y,n.name="item"+(c*e+_),s.addChild(n),this.addCell(n)}},{key:"createItem",value:function(){var t=[];if("function"==typeof this._itemRender)var i=new this._itemRender;else i=e.SceneUtils.createComp(this._itemRender,null,null,t);if(0==t.length&&i._watchMap){var s=i._watchMap;for(var n in s)for(var h=s[n],a=0;a<h.length;a++){var r=h[a];t.push(r.comp,r.prop,r.value)}}return t.length&&(i._$bindData=t),i}},{key:"addCell",value:function(t){t.on(e.Event.CLICK,this,this.onCellMouse),t.on(e.Event.RIGHT_CLICK,this,this.onCellMouse),t.on(e.Event.MOUSE_OVER,this,this.onCellMouse),t.on(e.Event.MOUSE_OUT,this,this.onCellMouse),t.on(e.Event.MOUSE_DOWN,this,this.onCellMouse),t.on(e.Event.MOUSE_UP,this,this.onCellMouse),this._cells.push(t)}},{key:"_afterInited",value:function(){this.initItems()}},{key:"initItems",value:function(){if(!this._itemRender&&null!=this.getChildByName("item0")){var t;this.repeatX=1,t=0;for(var e=0;e<1e4;e++){var i=this.getChildByName("item"+e);if(!i)break;this.addCell(i),t++}this.repeatY=t}}},{key:"setContentSize",value:function(t,i){this._content.width=t,this._content.height=i,(this._scrollBar||0!=this._offset.x||0!=this._offset.y)&&(this._content._style.scrollRect||(this._content.scrollRect=e.Rectangle.create()),this._content._style.scrollRect.setTo(-this._offset.x,-this._offset.y,t,i),this._content.scrollRect=this._content.scrollRect),this.event(e.Event.RESIZE)}},{key:"onCellMouse",value:function(t){t.type===e.Event.MOUSE_DOWN&&(this._isMoved=!1);var i=t.currentTarget,s=this._startIndex+this._cells.indexOf(i);s<0||(t.type===e.Event.CLICK||t.type===e.Event.RIGHT_CLICK?this.selectEnable&&!this._isMoved?this.selectedIndex=s:this.changeCellState(i,!0,0):t.type!==e.Event.MOUSE_OVER&&t.type!==e.Event.MOUSE_OUT||this._selectedIndex===s||this.changeCellState(i,t.type===e.Event.MOUSE_OVER,0),this.mouseHandler&&this.mouseHandler.runWith([t,s]))}},{key:"changeCellState",value:function(t,e,i){var s=t.getChildByName("selectBox");s&&(this.selectEnable=!0,s.visible=e,s.index=i)}},{key:"_sizeChanged",value:function(){r(o(s.prototype),"_sizeChanged",this).call(this),this.setContentSize(this.width,this.height),this._scrollBar&&this.callLater(this.onScrollBarChange)}},{key:"onScrollBarChange",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0],this.runCallLater(this.changeCells);var t=this._scrollBar.value,e=this._isVertical?this.repeatX:this.repeatY,i=this._isVertical?this.repeatY:this.repeatX,s=Math.floor(t/this._cellSize);if(this.cacheContent)h=i+1,this._createdLine-s<h&&(this._createItems(this._createdLine,e,this._createdLine+h),this.renderItems(this._createdLine*e,0),this._createdLine+=h);else{var n=s*e,h=0;if(n>this._startIndex){h=n-this._startIndex;var a=!0,r=this._startIndex+e*(i+1);this._isMoved=!0}else n<this._startIndex&&(h=this._startIndex-n,a=!1,r=this._startIndex-1,this._isMoved=!0);for(var l=0;l<h;l++){if(a){var o=this._cells.shift();this._cells[this._cells.length]=o;var u=r+l}else o=this._cells.pop(),this._cells.unshift(o),u=r-l;var c=Math.floor(u/e)*this._cellSize;this._isVertical?o.y=c:o.x=c,this.renderItem(o,u)}this._startIndex=n,this.changeSelectStatus()}var _=this._content._style.scrollRect;this._isVertical?(_.y=t-this._offset.y,_.x=-this._offset.x):(_.y=-this._offset.y,_.x=t-this._offset.x),this._content.scrollRect=_}},{key:"posCell",value:function(t,e){if(this._scrollBar){var i=this._isVertical?this.repeatX:this.repeatY,s=(this._isVertical?this.repeatY:this.repeatX,Math.floor(e/i)*this._cellSize);this._isVertical?t._y=s:t.x=s}}},{key:"changeSelectStatus",value:function(){for(var t=0,e=this._cells.length;t<e;t++)this.changeCellState(this._cells[t],this._selectedIndex===this._startIndex+t,1)}},{key:"renderItems",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:0)||this._cells.length;t<e;t++)this.renderItem(this._cells[t],this._startIndex+t);this.changeSelectStatus()}},{key:"renderItem",value:function(t,i){this._array&&i>=0&&i<this._array.length?(t.visible=!0,t._$bindData?(t._dataSource=this._array[i],this._bindData(t,this._array[i])):t.dataSource=this._array[i],this.cacheContent||this.posCell(t,i),this.hasListener(e.Event.RENDER)&&this.event(e.Event.RENDER,[t,i]),this.renderHandler&&this.renderHandler.runWith([t,i])):(t.visible=!1,t.dataSource=null)}},{key:"_bindData",value:function(t,e){for(var i=t._$bindData,s=0,n=i.length;s<n;s++){var h=i[s++],a=i[s++],r=i[s],l=f.getBindFun(r);h[a]=l.call(this,e)}}},{key:"updateArray",value:function(t){var e;if(this._array=t,this._array&&((e=this._preLen-this._startIndex)>=0&&this.renderItems(e),this._preLen=this._array.length),this._scrollBar){var i=t.length,s=this._isVertical?this.repeatX:this.repeatY,n=this._isVertical?this.repeatY:this.repeatX,h=Math.ceil(i/s);h>=n&&(this._scrollBar.thumbPercent=n/h,this._scrollBar.slider._max=(h-n)*this._cellSize+this._cellOffset)}}},{key:"refresh",value:function(){this.array=this._array}},{key:"getItem",value:function(t){return t>-1&&t<this._array.length?this._array[t]:null}},{key:"changeItem",value:function(t,e){t>-1&&t<this._array.length&&(this._array[t]=e,t>=this._startIndex&&t<this._startIndex+this._cells.length&&this.renderItem(this.getCell(t),t))}},{key:"setItem",value:function(t,e){this.changeItem(t,e)}},{key:"addItem",value:function(t){this._array.push(t),this.array=this._array}},{key:"addItemAt",value:function(t,e){this._array.splice(e,0,t),this.array=this._array}},{key:"deleteItem",value:function(t){this._array.splice(t,1),this.array=this._array}},{key:"getCell",value:function(t){return this.runCallLater(this.changeCells),t>-1&&this._cells?this._cells[(t-this._startIndex)%this._cells.length]:null}},{key:"scrollTo",value:function(t){if(this._scrollBar){var e=this._isVertical?this.repeatX:this.repeatY;this._scrollBar.value=Math.floor(t/e)*this._cellSize}else this.startIndex=t}},{key:"tweenTo",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:200,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(this._scrollBar){this._scrollBar.stopScroll();var n=this._isVertical?this.repeatX:this.repeatY;e.Tween.to(this._scrollBar,{value:Math.floor(t/n)*this._cellSize},i,null,s,0,!0)}else this.startIndex=t,s&&s.run()}},{key:"_setCellChanged",value:function(){this._cellChanged||(this._cellChanged=!0,this.callLater(this.changeCells))}},{key:"commitMeasure",value:function(){this.runCallLater(this.changeCells)}},{key:"cacheAs",set:function(t){i(o(s.prototype),"cacheAs",t,this,!0),this._scrollBar&&(this._usedCache=null,"none"!==t?this._scrollBar.on(e.Event.START,this,this.onScrollStart):this._scrollBar.off(e.Event.START,this,this.onScrollStart))},get:function(){return r(o(s.prototype),"cacheAs",this)}},{key:"content",get:function(){return this._content}},{key:"vScrollBarSkin",get:function(){return this._scrollBar?this._scrollBar.skin:null},set:function(t){this._removePreScrollBar();var e=new E;e.name="scrollBar",e.right=0,e.skin=t,e.elasticDistance=this._elasticEnabled?200:0,this.scrollBar=e,this.addChild(e),this._setCellChanged()}},{key:"hScrollBarSkin",get:function(){return this._scrollBar?this._scrollBar.skin:null},set:function(t){this._removePreScrollBar();var e=new I;e.name="scrollBar",e.bottom=0,e.skin=t,e.elasticDistance=this._elasticEnabled?200:0,this.scrollBar=e,this.addChild(e),this._setCellChanged()}},{key:"scrollBar",get:function(){return this._scrollBar},set:function(t){this._scrollBar!=t&&(this._scrollBar=t,t&&(this._isVertical=this._scrollBar.isVertical,this.addChild(this._scrollBar),this._scrollBar.on(e.Event.CHANGE,this,this.onScrollBarChange)))}},{key:"itemRender",get:function(){return this._itemRender},set:function(t){if(this._itemRender!=t){this._itemRender=t;for(var e=this._cells.length-1;e>-1;e--)this._cells[e].destroy();this._cells.length=0,this._setCellChanged()}}},{key:"width",set:function(t){t!=this._width&&(i(o(s.prototype),"width",t,this,!0),this._setCellChanged())},get:function(){return r(o(s.prototype),"width",this)}},{key:"height",set:function(t){t!=this._height&&(i(o(s.prototype),"height",t,this,!0),this._setCellChanged())},get:function(){return r(o(s.prototype),"height",this)}},{key:"repeatX",get:function(){return this._repeatX>0?this._repeatX:this._repeatX2>0?this._repeatX2:1},set:function(t){this._repeatX=t,this._setCellChanged()}},{key:"repeatY",get:function(){return this._repeatY>0?this._repeatY:this._repeatY2>0?this._repeatY2:1},set:function(t){this._repeatY=t,this._setCellChanged()}},{key:"spaceX",get:function(){return this._spaceX},set:function(t){this._spaceX=t,this._setCellChanged()}},{key:"spaceY",get:function(){return this._spaceY},set:function(t){this._spaceY=t,this._setCellChanged()}},{key:"selectedIndex",get:function(){return this._selectedIndex},set:function(t){this._selectedIndex!=t&&(this._selectedIndex=t,this.changeSelectStatus(),this.event(e.Event.CHANGE),this.selectHandler&&this.selectHandler.runWith(t),this.startIndex=this._startIndex)}},{key:"selectedItem",get:function(){return-1!=this._selectedIndex?this._array[this._selectedIndex]:null},set:function(t){this.selectedIndex=this._array.indexOf(t)}},{key:"selection",get:function(){return this.getCell(this._selectedIndex)},set:function(t){this.selectedIndex=this._startIndex+this._cells.indexOf(t)}},{key:"startIndex",get:function(){return this._startIndex},set:function(t){this._startIndex=t>0?t:0,this.callLater(this.renderItems)}},{key:"array",get:function(){return this._array},set:function(t){this.runCallLater(this.changeCells),this._array=t||[],this._preLen=this._array.length;var e=this._array.length;if(this.totalPage=Math.ceil(e/(this.repeatX*this.repeatY)),this._selectedIndex=this._selectedIndex<e?this._selectedIndex:e-1,this.startIndex=this._startIndex,this._scrollBar){this._scrollBar.stopScroll();var i=this._isVertical?this.repeatX:this.repeatY,s=this._isVertical?this.repeatY:this.repeatX,n=Math.ceil(e/i);(this._cellOffset>0?this.totalPage+1:this.totalPage)>1&&n>=s?(this._scrollBar.scrollSize=this._cellSize,this._scrollBar.thumbPercent=s/n,this._scrollBar.setScroll(0,(n-s)*this._cellSize+this._cellOffset,this._scrollBar.value),this._scrollBar.target=this._content):(this._scrollBar.setScroll(0,0,0),this._scrollBar.target=this._content)}}},{key:"page",get:function(){return this._page},set:function(t){this._page=t,this._array&&(this._page=t>0?t:0,this._page=this._page<this.totalPage?this._page:this.totalPage-1,this.startIndex=this._page*this.repeatX*this.repeatY)}},{key:"length",get:function(){return this._array?this._array.length:0}},{key:"dataSource",set:function(t){this._dataSource=t,"number"==typeof t||"string"==typeof t?this.selectedIndex=parseInt(t):t instanceof Array?this.array=t:i(o(s.prototype),"dataSource",t,this,!0)},get:function(){return r(o(s.prototype),"dataSource",this)}},{key:"cells",get:function(){return this.runCallLater(this.changeCells),this._cells}},{key:"elasticEnabled",get:function(){return this._elasticEnabled},set:function(t){this._elasticEnabled=t,this._scrollBar&&(this._scrollBar.elasticDistance=t?200:0)}}]),s}();e.ILaya.regClass(B),e.ClassUtils.regClass("laya.ui.List",B),e.ClassUtils.regClass("Laya.List",B);var M=function(t){function s(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return c(this,s),(t=h(this,o(s).call(this)))._visibleNum=6,t._itemColors=l.comboBoxItemColors,t._itemSize=12,t._labels=[],t._selectedIndex=-1,t.itemRender=null,t.skin=e,t.labels=i,t}return u(s,y),n(s,[{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];r(o(s.prototype),"destroy",this).call(this,t),this._button&&this._button.destroy(t),this._list&&this._list.destroy(t),this._button=null,this._list=null,this._itemColors=null,this._labels=null,this._selectHandler=null}},{key:"createChildren",value:function(){this.addChild(this._button=new C),this._button.text.align="left",this._button.labelPadding="0,0,0,5",this._button.on(e.Event.MOUSE_DOWN,this,this.onButtonMouseDown)}},{key:"_createList",value:function(){this._list=new B,this._scrollBarSkin&&(this._list.vScrollBarSkin=this._scrollBarSkin),this._setListEvent(this._list)}},{key:"_setListEvent",value:function(t){this._list.selectEnable=!0,this._list.on(e.Event.MOUSE_DOWN,this,this.onListDown),this._list.mouseHandler=e.Handler.create(this,this.onlistItemMouse,null,!1),this._list.scrollBar&&this._list.scrollBar.on(e.Event.MOUSE_DOWN,this,this.onScrollBarDown)}},{key:"onListDown",value:function(t){t.stopPropagation()}},{key:"onScrollBarDown",value:function(t){t.stopPropagation()}},{key:"onButtonMouseDown",value:function(t){this.callLater(this.switchTo,[!this._isOpen])}},{key:"measureWidth",value:function(){return this._button.width}},{key:"measureHeight",value:function(){return this._button.height}},{key:"changeList",value:function(){this._listChanged=!1;var t=this.width-2,e=this._itemColors[2];this._itemHeight=this._itemSize+6,this._list.itemRender=this.itemRender||{type:"Box",child:[{type:"Label",props:{name:"label",x:1,padding:"3,3,3,3",width:t,height:this._itemHeight,fontSize:this._itemSize,color:e}}]},this._list.repeatY=this._visibleNum,this._list.refresh()}},{key:"onlistItemMouse",value:function(t,i){var s=t.type;if(s===e.Event.MOUSE_OVER||s===e.Event.MOUSE_OUT){if(this._isCustomList)return;var n=this._list.getCell(i);if(!n)return;var h=n.getChildByName("label");h&&(s===e.Event.ROLL_OVER?(h.bgColor=this._itemColors[0],h.color=this._itemColors[1]):(h.bgColor=null,h.color=this._itemColors[2]))}else s===e.Event.CLICK&&(this.selectedIndex=i,this.isOpen=!1)}},{key:"switchTo",value:function(t){this.isOpen=t}},{key:"changeOpen",value:function(){this.isOpen=!this._isOpen}},{key:"changeItem",value:function(){if(this._itemChanged=!1,this._listHeight=this._labels.length>0?Math.min(this._visibleNum,this._labels.length)*this._itemHeight:this._itemHeight,!this._isCustomList){var t=this._list.graphics;t.clear(!0),t.drawRect(0,0,this.width-1,this._listHeight,this._itemColors[4],this._itemColors[3])}var e=this._list.array||[];e.length=0;for(var i=0,s=this._labels.length;i<s;i++)e.push({label:this._labels[i]});this._list.height=this._listHeight,this._list.array=e}},{key:"changeSelected",value:function(){this._button.label=this.selectedLabel}},{key:"_onStageMouseWheel",value:function(t){this._list&&!this._list.contains(t.target)&&this.removeList(null)}},{key:"removeList",value:function(t){e.ILaya.stage.off(e.Event.MOUSE_DOWN,this,this.removeList),e.ILaya.stage.off(e.Event.MOUSE_WHEEL,this,this._onStageMouseWheel),this.isOpen=!1}},{key:"skin",get:function(){return this._button.skin},set:function(t){this._button.skin!=t&&(this._button.skin=t,this._listChanged=!0)}},{key:"width",set:function(t){i(o(s.prototype),"width",t,this,!0),this._button.width=this._width,this._itemChanged=!0,this._listChanged=!0},get:function(){return r(o(s.prototype),"width",this)}},{key:"height",set:function(t){i(o(s.prototype),"height",t,this,!0),this._button.height=this._height},get:function(){return r(o(s.prototype),"height",this)}},{key:"labels",get:function(){return this._labels.join(",")},set:function(t){this._labels.length>0&&(this.selectedIndex=-1),t?this._labels=t.split(","):this._labels.length=0,this._itemChanged=!0}},{key:"selectedIndex",get:function(){return this._selectedIndex},set:function(t){this._selectedIndex!=t&&(this._selectedIndex=t,this._labels.length>0?this.changeSelected():this.callLater(this.changeSelected),this.event(e.Event.CHANGE,[e.Event.EMPTY.setTo(e.Event.CHANGE,this,this)]),this._selectHandler&&this._selectHandler.runWith(this._selectedIndex))}},{key:"selectHandler",get:function(){return this._selectHandler},set:function(t){this._selectHandler=t}},{key:"selectedLabel",get:function(){return this._selectedIndex>-1&&this._selectedIndex<this._labels.length?this._labels[this._selectedIndex]:null},set:function(t){this.selectedIndex=this._labels.indexOf(t)}},{key:"visibleNum",get:function(){return this._visibleNum},set:function(t){this._visibleNum=t,this._listChanged=!0}},{key:"itemColors",get:function(){return String(this._itemColors)},set:function(t){this._itemColors=f.fillArray(this._itemColors,t,String),this._listChanged=!0}},{key:"itemSize",get:function(){return this._itemSize},set:function(t){this._itemSize=t,this._listChanged=!0}},{key:"isOpen",get:function(){return this._isOpen},set:function(t){if(this._isOpen!=t)if(this._isOpen=t,this._button.selected=this._isOpen,this._isOpen){this._list||this._createList(),this._listChanged&&!this._isCustomList&&this.changeList(),this._itemChanged&&this.changeItem();var i=this.localToGlobal(e.Point.TEMP.setTo(0,0)),s=i.y+this._button.height;s=s+this._listHeight<=e.ILaya.stage.height?s:i.y-this._listHeight,this._list.pos(i.x,s),this._list.zOrder=1001,e.ILaya.stage.addChild(this._list),e.ILaya.stage.once(e.Event.MOUSE_DOWN,this,this.removeList),e.ILaya.stage.on(e.Event.MOUSE_WHEEL,this,this._onStageMouseWheel),this._list.selectedIndex=this._selectedIndex}else this._list&&this._list.removeSelf()}},{key:"scrollBarSkin",get:function(){return this._scrollBarSkin},set:function(t){this._scrollBarSkin=t}},{key:"sizeGrid",get:function(){return this._button.sizeGrid},set:function(t){this._button.sizeGrid=t}},{key:"scrollBar",get:function(){return this.list.scrollBar}},{key:"button",get:function(){return this._button}},{key:"list",get:function(){return this._list||this._createList(),this._list},set:function(t){t&&(t.removeSelf(),this._isCustomList=!0,this._list=t,this._setListEvent(t),this._itemHeight=t.getCell(0).height+t.spaceY)}},{key:"dataSource",set:function(t){this._dataSource=t,"number"==typeof t||"string"==typeof t?this.selectedIndex=parseInt(t):t instanceof Array?this.labels=t.join(","):i(o(s.prototype),"dataSource",t,this,!0)},get:function(){return r(o(s.prototype),"dataSource",this)}},{key:"labelColors",get:function(){return this._button.labelColors},set:function(t){this._button.labelColors!=t&&(this._button.labelColors=t)}},{key:"labelPadding",get:function(){return this._button.text.padding.join(",")},set:function(t){this._button.text.padding=f.fillArray(l.labelPadding,t,Number)}},{key:"labelSize",get:function(){return this._button.text.fontSize},set:function(t){this._button.text.fontSize=t}},{key:"labelBold",get:function(){return this._button.text.bold},set:function(t){this._button.text.bold=t}},{key:"labelFont",get:function(){return this._button.text.font},set:function(t){this._button.text.font=t}},{key:"stateNum",get:function(){return this._button.stateNum},set:function(t){this._button.stateNum=t}}]),s}();e.ILaya.regClass(M),e.ClassUtils.regClass("laya.ui.ComboBox",M),e.ClassUtils.regClass("Laya.ComboBox",M);var O=function(t){function s(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return c(this,s),(t=h(this,o(s).call(this)))._value=.5,t.skin=e,t}return u(s,y),n(s,[{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];r(o(s.prototype),"destroy",this).call(this,t),this._bg&&this._bg.destroy(t),this._bar&&this._bar.destroy(t),this._bg=this._bar=null,this.changeHandler=null}},{key:"createChildren",value:function(){this.addChild(this._bg=new v),this.addChild(this._bar=new v),this._bar._bitmap.autoCacheCmd=!1}},{key:"_skinLoaded",value:function(){this._bg.skin=this._skin,this._bar.skin=this._skin.replace(".png","$bar.png"),this.callLater(this.changeValue),this._sizeChanged(),this.event(e.Event.LOADED)}},{key:"measureWidth",value:function(){return this._bg.width}},{key:"measureHeight",value:function(){return this._bg.height}},{key:"changeValue",value:function(){if(this.sizeGrid){var t=this.sizeGrid.split(","),e=Number(t[3]),i=Number(t[1]),s=(this.width-e-i)*this._value;this._bar.width=e+i+s,this._bar.visible=this._bar.width>e+i}else this._bar.width=this.width*this._value}},{key:"skin",get:function(){return this._skin},set:function(t){this._skin!=t&&(this._skin=t,this._skin&&!e.Loader.getRes(this._skin)?e.ILaya.loader.load(this._skin,e.Handler.create(this,this._skinLoaded),null,e.Loader.IMAGE,1):this._skinLoaded())}},{key:"value",get:function(){return this._value},set:function(t){this._value!=t&&(t=t>1?1:t<0?0:t,this._value=t,this.callLater(this.changeValue),this.event(e.Event.CHANGE),this.changeHandler&&this.changeHandler.runWith(t))}},{key:"bar",get:function(){return this._bar}},{key:"bg",get:function(){return this._bg}},{key:"sizeGrid",get:function(){return this._bg.sizeGrid},set:function(t){this._bg.sizeGrid=this._bar.sizeGrid=t}},{key:"width",set:function(t){i(o(s.prototype),"width",t,this,!0),this._bg.width=this._width,this.callLater(this.changeValue)},get:function(){return r(o(s.prototype),"width",this)}},{key:"height",set:function(t){i(o(s.prototype),"height",t,this,!0),this._bg.height=this._height,this._bar.height=this._height},get:function(){return r(o(s.prototype),"height",this)}},{key:"dataSource",set:function(t){this._dataSource=t,"number"==typeof t||"string"==typeof t?this.value=Number(t):i(o(s.prototype),"dataSource",t,this,!0)},get:function(){return r(o(s.prototype),"dataSource",this)}}]),s}();e.ILaya.regClass(O),e.ClassUtils.regClass("laya.ui.ProgressBar",O),e.ClassUtils.regClass("Laya.ProgressBar",O);var T=function(t){function i(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return c(this,i),(t=h(this,o(i).call(this,e,s))).toggle=!1,t._autoSize=!1,t}return u(i,C),n(i,[{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];r(o(i.prototype),"destroy",this).call(this,t),this._value=null}},{key:"preinitialize",value:function(){r(o(i.prototype),"preinitialize",this).call(this),this.toggle=!1,this._autoSize=!1}},{key:"initialize",value:function(){r(o(i.prototype),"initialize",this).call(this),this.createText(),this._text.align="left",this._text.valign="top",this._text.width=0,this.on(e.Event.CLICK,this,this.onClick)}},{key:"onClick",value:function(t){this.selected=!0}},{key:"value",get:function(){return null!=this._value?this._value:this.label},set:function(t){this._value=t}}]),i}();e.ILaya.regClass(T),e.ClassUtils.regClass("laya.ui.Radio",T),e.ClassUtils.regClass("Laya.Radio",T);var U=function(t){function s(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return c(this,s),(t=h(this,o(s).call(this)))._selectedIndex=-1,t._direction="horizontal",t._space=0,t.skin=i,t.labels=e,t}return u(s,k),n(s,[{key:"preinitialize",value:function(){this.mouseEnabled=!0}},{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];r(o(s.prototype),"destroy",this).call(this,t),this._items&&(this._items.length=0),this._items=null,this.selectHandler=null}},{key:"addItem",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=t,s=this._items.length;if(i.name="item"+s,this.addChild(i),this.initItems(),e&&s>0){var n=this._items[s-1];"horizontal"==this._direction?i.x=n._x+n.width+this._space:i.y=n._y+n.height+this._space}else e&&(i.x=0,i.y=0);return s}},{key:"delItem",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._items.indexOf(t);if(-1!=i){var s,n=t;this.removeChild(n);for(var h=i+1,a=this._items.length;h<a;h++){var r=this._items[h];r.name="item"+(h-1),e&&("horizontal"==this._direction?r.x-=n.width+this._space:r.y-=n.height+this._space)}this.initItems(),this._selectedIndex>-1&&(s=this._selectedIndex<this._items.length?this._selectedIndex:this._selectedIndex-1,this._selectedIndex=-1,this.selectedIndex=s)}}},{key:"_afterInited",value:function(){this.initItems()}},{key:"initItems",value:function(){this._items||(this._items=[]),this._items.length=0;for(var t=0;t<1e4;t++){var i=this.getChildByName("item"+t);if(null==i)break;this._items.push(i),i.selected=t===this._selectedIndex,i.clickHandler=e.Handler.create(this,this.itemClick,[t],!1)}}},{key:"itemClick",value:function(t){this.selectedIndex=t}},{key:"setSelect",value:function(t,e){this._items&&t>-1&&t<this._items.length&&(this._items[t].selected=e)}},{key:"_skinLoaded",value:function(){this._setLabelChanged(),this.event(e.Event.LOADED)}},{key:"createItem",value:function(t,e){return null}},{key:"changeLabels",value:function(){if(this._labelChanged=!1,this._items)for(var t=0,e=0,i=this._items.length;e<i;e++){var s=this._items[e];this._skin&&(s.skin=this._skin),this._labelColors&&(s.labelColors=this._labelColors),this._labelSize&&(s.labelSize=this._labelSize),this._labelStroke&&(s.labelStroke=this._labelStroke),this._labelStrokeColor&&(s.labelStrokeColor=this._labelStrokeColor),this._strokeColors&&(s.strokeColors=this._strokeColors),this._labelBold&&(s.labelBold=this._labelBold),this._labelPadding&&(s.labelPadding=this._labelPadding),this._labelAlign&&(s.labelAlign=this._labelAlign),this._stateNum&&(s.stateNum=this._stateNum),this._labelFont&&(s.labelFont=this._labelFont),"horizontal"===this._direction?(s.y=0,s.x=t,t+=s.width+this._space):(s.x=0,s.y=t,t+=s.height+this._space)}this._sizeChanged()}},{key:"commitMeasure",value:function(){this.runCallLater(this.changeLabels)}},{key:"_setLabelChanged",value:function(){this._labelChanged||(this._labelChanged=!0,this.callLater(this.changeLabels))}},{key:"selectedIndex",get:function(){return this._selectedIndex},set:function(t){this._selectedIndex!=t&&(this.setSelect(this._selectedIndex,!1),this._selectedIndex=t,this.setSelect(t,!0),this.event(e.Event.CHANGE),this.selectHandler&&this.selectHandler.runWith(this._selectedIndex))}},{key:"skin",get:function(){return this._skin},set:function(t){this._skin!=t&&(this._skin=t,this._skin&&!e.Loader.getRes(this._skin)?e.ILaya.loader.load(this._skin,e.Handler.create(this,this._skinLoaded),null,e.Loader.IMAGE,1):this._skinLoaded())}},{key:"labels",get:function(){return this._labels},set:function(t){if(this._labels!=t){if(this._labels=t,this.removeChildren(),this._setLabelChanged(),this._labels)for(var e=this._labels.split(","),i=0,s=e.length;i<s;i++){var n=this.createItem(this._skin,e[i]);n.name="item"+i,this.addChild(n)}this.initItems()}}},{key:"labelColors",get:function(){return this._labelColors},set:function(t){this._labelColors!=t&&(this._labelColors=t,this._setLabelChanged())}},{key:"labelStroke",get:function(){return this._labelStroke},set:function(t){this._labelStroke!=t&&(this._labelStroke=t,this._setLabelChanged())}},{key:"labelStrokeColor",get:function(){return this._labelStrokeColor},set:function(t){this._labelStrokeColor!=t&&(this._labelStrokeColor=t,this._setLabelChanged())}},{key:"strokeColors",get:function(){return this._strokeColors},set:function(t){this._strokeColors!=t&&(this._strokeColors=t,this._setLabelChanged())}},{key:"labelSize",get:function(){return this._labelSize},set:function(t){this._labelSize!=t&&(this._labelSize=t,this._setLabelChanged())}},{key:"stateNum",get:function(){return this._stateNum},set:function(t){this._stateNum!=t&&(this._stateNum=t,this._setLabelChanged())}},{key:"labelBold",get:function(){return this._labelBold},set:function(t){this._labelBold!=t&&(this._labelBold=t,this._setLabelChanged())}},{key:"labelFont",get:function(){return this._labelFont},set:function(t){this._labelFont!=t&&(this._labelFont=t,this._setLabelChanged())}},{key:"labelPadding",get:function(){return this._labelPadding},set:function(t){this._labelPadding!=t&&(this._labelPadding=t,this._setLabelChanged())}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction=t,this._setLabelChanged()}},{key:"space",get:function(){return this._space},set:function(t){this._space=t,this._setLabelChanged()}},{key:"items",get:function(){return this._items}},{key:"selection",get:function(){return this._selectedIndex>-1&&this._selectedIndex<this._items.length?this._items[this._selectedIndex]:null},set:function(t){this.selectedIndex=this._items.indexOf(t)}},{key:"dataSource",set:function(t){this._dataSource=t,"number"==typeof t||"string"==typeof t?this.selectedIndex=parseInt(t):t instanceof Array?this.labels=t.join(","):i(o(s.prototype),"dataSource",t,this,!0)},get:function(){return r(o(s.prototype),"dataSource",this)}}]),s}();e.ILaya.regClass(U),e.ClassUtils.regClass("laya.ui.UIGroup",U),e.ClassUtils.regClass("Laya.UIGroup",U);var z=function(t){function e(){return c(this,e),h(this,o(e).apply(this,arguments))}return u(e,U),n(e,[{key:"createItem",value:function(t,e){return new T(t,e)}}]),e}();e.ILaya.regClass(z),e.ClassUtils.regClass("laya.ui.RadioGroup",z),e.ClassUtils.regClass("Laya.RadioGroup",z);var D=function(t){function e(){return c(this,e),h(this,o(e).apply(this,arguments))}return u(e,U),n(e,[{key:"createItem",value:function(t,e){return new C(t,e)}}]),e}();e.ILaya.regClass(D),e.ClassUtils.regClass("laya.ui.Tab",D),e.ClassUtils.regClass("Laya.Tab",D);var A=function(t){function i(){var t;return c(this,i),(t=h(this,o(i).apply(this,arguments)))._setIndexHandler=e.Handler.create(a(t),t.setIndex,null,!1),t}return u(i,k),n(i,[{key:"setItems",value:function(t){this.removeChildren();for(var e=0,i=0,s=t.length;i<s;i++){var n=t[i];n&&(n.name="item"+e,this.addChild(n),e++)}this.initItems()}},{key:"addItem",value:function(t){t.name="item"+this._items.length,this.addChild(t),this.initItems()}},{key:"_afterInited",value:function(){this.initItems()}},{key:"initItems",value:function(){this._items=[];for(var t=0;t<1e4;t++){var e=this.getChildByName("item"+t);if(null==e)break;this._items.push(e),e.visible=t==this._selectedIndex}}},{key:"setSelect",value:function(t,e){this._items&&t>-1&&t<this._items.length&&(this._items[t].visible=e)}},{key:"setIndex",value:function(t){this.selectedIndex=t}},{key:"selectedIndex",get:function(){return this._selectedIndex},set:function(t){this._selectedIndex!=t&&(this.setSelect(this._selectedIndex,!1),this._selectedIndex=t,this.setSelect(this._selectedIndex,!0))}},{key:"selection",get:function(){return this._selectedIndex>-1&&this._selectedIndex<this._items.length?this._items[this._selectedIndex]:null},set:function(t){this.selectedIndex=this._items.indexOf(t)}},{key:"setIndexHandler",get:function(){return this._setIndexHandler},set:function(t){this._setIndexHandler=t}},{key:"items",get:function(){return this._items}},{key:"dataSource",set:function(t){if(this._dataSource=t,"number"==typeof t||"string"==typeof t)this.selectedIndex=parseInt(t);else for(var e in this._dataSource)e in this&&(this[e]=this._dataSource[e])},get:function(){return r(o(i.prototype),"dataSource",this)}}]),i}();e.ILaya.regClass(A),e.ClassUtils.regClass("laya.ui.ViewStack",A),e.ClassUtils.regClass("Laya.ViewStack",A);var H=function(t){function s(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return c(this,s),(t=h(this,o(s).call(this))).text=e,t.skin=t.skin,t}return u(s,w),n(s,[{key:"preinitialize",value:function(){this.mouseEnabled=!0}},{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];r(o(s.prototype),"destroy",this).call(this,t),this._bg&&this._bg.destroy(),this._bg=null}},{key:"createChildren",value:function(){this.addChild(this._tf=new e.Input),this._tf.padding=l.inputLabelPadding,this._tf.on(e.Event.INPUT,this,this._onInput),this._tf.on(e.Event.ENTER,this,this._onEnter),this._tf.on(e.Event.BLUR,this,this._onBlur),this._tf.on(e.Event.FOCUS,this,this._onFocus)}},{key:"_onFocus",value:function(){this.event(e.Event.FOCUS,this)}},{key:"_onBlur",value:function(){this.event(e.Event.BLUR,this)}},{key:"_onInput",value:function(){this.event(e.Event.INPUT,this)}},{key:"_onEnter",value:function(){this.event(e.Event.ENTER,this)}},{key:"initialize",value:function(){this.width=128,this.height=22}},{key:"_skinLoaded",value:function(){this._bg||(this.graphics=this._bg=new _),this._bg.source=e.Loader.getRes(this._skin),this._width&&(this._bg.width=this._width),this._height&&(this._bg.height=this._height),this._sizeChanged(),this.event(e.Event.LOADED)}},{key:"select",value:function(){this._tf.select()}},{key:"setSelection",value:function(t,e){this._tf.setSelection(t,e)}},{key:"bg",get:function(){return this._bg},set:function(t){this.graphics=this._bg=t}},{key:"skin",get:function(){return this._skin},set:function(t){this._skin!=t&&(this._skin=t,this._skin&&!e.Loader.getRes(this._skin)?e.ILaya.loader.load(this._skin,e.Handler.create(this,this._skinLoaded),null,e.Loader.IMAGE,1):this._skinLoaded())}},{key:"sizeGrid",get:function(){return this._bg&&this._bg.sizeGrid?this._bg.sizeGrid.join(","):null},set:function(t){this._bg||(this.graphics=this._bg=new _),this._bg.sizeGrid=f.fillArray(l.defaultSizeGrid,t,Number)}},{key:"text",set:function(t){this._tf.text!=t&&(t+="",this._tf.text=t,this.event(e.Event.CHANGE))},get:function(){return r(o(s.prototype),"text",this)}},{key:"width",set:function(t){i(o(s.prototype),"width",t,this,!0),this._bg&&(this._bg.width=t)},get:function(){return r(o(s.prototype),"width",this)}},{key:"height",set:function(t){i(o(s.prototype),"height",t,this,!0),this._bg&&(this._bg.height=t)},get:function(){return r(o(s.prototype),"height",this)}},{key:"multiline",get:function(){return this._tf.multiline},set:function(t){this._tf.multiline=t}},{key:"editable",set:function(t){this._tf.editable=t},get:function(){return this._tf.editable}},{key:"restrict",get:function(){return this._tf.restrict},set:function(t){this._tf.restrict=t}},{key:"prompt",get:function(){return this._tf.prompt},set:function(t){this._tf.prompt=t}},{key:"promptColor",get:function(){return this._tf.promptColor},set:function(t){this._tf.promptColor=t}},{key:"maxChars",get:function(){return this._tf.maxChars},set:function(t){this._tf.maxChars=t}},{key:"focus",get:function(){return this._tf.focus},set:function(t){this._tf.focus=t}},{key:"type",get:function(){return this._tf.type},set:function(t){this._tf.type=t}}]),s}();e.ILaya.regClass(H),e.ClassUtils.regClass("laya.ui.TextInput",H),e.ClassUtils.regClass("Laya.TextInput",H);var P=function(t){function s(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return c(this,s),(t=h(this,o(s).call(this,i))).on(e.Event.CHANGE,a(t),t._onTextChange),t}return u(s,H),n(s,[{key:"_onTextChange",value:function(){this.callLater(this.changeScroll)}},{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._vScrollBar&&this._vScrollBar.destroy(),this._hScrollBar&&this._hScrollBar.destroy(),this._vScrollBar=null,this._hScrollBar=null,r(o(s.prototype),"destroy",this).call(this,t)}},{key:"initialize",value:function(){this.width=180,this.height=150,this._tf.wordWrap=!0,this.multiline=!0}},{key:"onVBarChanged",value:function(t){this._tf.scrollY!=this._vScrollBar.value&&(this._tf.scrollY=this._vScrollBar.value)}},{key:"onHBarChanged",value:function(t){this._tf.scrollX!=this._hScrollBar.value&&(this._tf.scrollX=this._hScrollBar.value)}},{key:"changeScroll",value:function(){var t=this._vScrollBar&&this._tf.maxScrollY>0,e=this._hScrollBar&&this._tf.maxScrollX>0,i=t?this._width-this._vScrollBar.width:this._width,s=e?this._height-this._hScrollBar.height:this._height,n=this._tf.padding||l.labelPadding;this._tf.width=i,this._tf.height=s,this._vScrollBar&&(this._vScrollBar.x=this._width-this._vScrollBar.width-n[2],this._vScrollBar.y=n[1],this._vScrollBar.height=this._height-(e?this._hScrollBar.height:0)-n[1]-n[3],this._vScrollBar.scrollSize=1,this._vScrollBar.thumbPercent=s/Math.max(this._tf.textHeight,s),this._vScrollBar.setScroll(1,this._tf.maxScrollY,this._tf.scrollY),this._vScrollBar.visible=t),this._hScrollBar&&(this._hScrollBar.x=n[0],this._hScrollBar.y=this._height-this._hScrollBar.height-n[3],this._hScrollBar.width=this._width-(t?this._vScrollBar.width:0)-n[0]-n[2],this._hScrollBar.scrollSize=Math.max(.033*i,1),this._hScrollBar.thumbPercent=i/Math.max(this._tf.textWidth,i),this._hScrollBar.setScroll(0,this.maxScrollX,this.scrollX),this._hScrollBar.visible=e)}},{key:"scrollTo",value:function(t){this.commitMeasure(),this._tf.scrollY=t}},{key:"width",set:function(t){i(o(s.prototype),"width",t,this,!0),this.callLater(this.changeScroll)},get:function(){return r(o(s.prototype),"width",this)}},{key:"height",set:function(t){i(o(s.prototype),"height",t,this,!0),this.callLater(this.changeScroll)},get:function(){return r(o(s.prototype),"height",this)}},{key:"vScrollBarSkin",get:function(){return this._vScrollBar?this._vScrollBar.skin:null},set:function(t){null==this._vScrollBar&&(this.addChild(this._vScrollBar=new E),this._vScrollBar.on(e.Event.CHANGE,this,this.onVBarChanged),this._vScrollBar.target=this._tf,this.callLater(this.changeScroll)),this._vScrollBar.skin=t}},{key:"hScrollBarSkin",get:function(){return this._hScrollBar?this._hScrollBar.skin:null},set:function(t){null==this._hScrollBar&&(this.addChild(this._hScrollBar=new I),this._hScrollBar.on(e.Event.CHANGE,this,this.onHBarChanged),this._hScrollBar.mouseWheelEnable=!1,this._hScrollBar.target=this._tf,this.callLater(this.changeScroll)),this._hScrollBar.skin=t}},{key:"vScrollBar",get:function(){return this._vScrollBar}},{key:"hScrollBar",get:function(){return this._hScrollBar}},{key:"maxScrollY",get:function(){return this._tf.maxScrollY}},{key:"scrollY",get:function(){return this._tf.scrollY}},{key:"maxScrollX",get:function(){return this._tf.maxScrollX}},{key:"scrollX",get:function(){return this._tf.scrollX}}]),s}();e.ILaya.regClass(P),e.ClassUtils.regClass("laya.ui.TextArea",P),e.ClassUtils.regClass("Laya.TextArea",P);var N=function(t){function s(){var t;return c(this,s),(t=h(this,o(s).apply(this,arguments)))._oldW=0,t._oldH=0,t}return u(s,k),n(s,[{key:"onEnable",value:function(){e.ILaya.stage.on("resize",this,this.onResize),this.onResize()}},{key:"onDisable",value:function(){e.ILaya.stage.off("resize",this,this.onResize)}},{key:"onResize",value:function(){var t=e.ILaya.stage;if(this.width>0&&this.height>0){var n=Math.min(t.width/this._oldW,t.height/this._oldH);i(o(s.prototype),"width",t.width,this,!0),i(o(s.prototype),"height",t.height,this,!0),this.scale(n,n)}}},{key:"width",set:function(t){i(o(s.prototype),"width",t,this,!0),this._oldW=t},get:function(){return r(o(s.prototype),"width",this)}},{key:"height",set:function(t){i(o(s.prototype),"height",t,this,!0),this._oldH=t},get:function(){return r(o(s.prototype),"height",this)}}]),s}();e.ILaya.regClass(N),e.ClassUtils.regClass("laya.ui.ScaleBox",N),e.ClassUtils.regClass("Laya.ScaleBox",N);var R=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return c(this,e),(t=h(this,o(e).call(this,i))).isVertical=!1,t}return u(e,L),e}();e.ILaya.regClass(R),e.ClassUtils.regClass("laya.ui.HSlider",R),e.ClassUtils.regClass("Laya.HSlider",R);var Y=function(t){function s(){var t;return c(this,s),(t=h(this,o(s).call(this)))._usedCache=null,t._elasticEnabled=!1,t.width=t.height=100,t}return u(s,k),n(s,[{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];r(o(s.prototype),"destroy",this).call(this,t),this._content&&this._content.destroy(t),this._vScrollBar&&this._vScrollBar.destroy(t),this._hScrollBar&&this._hScrollBar.destroy(t),this._vScrollBar=null,this._hScrollBar=null,this._content=null}},{key:"destroyChildren",value:function(){this._content.destroyChildren()}},{key:"createChildren",value:function(){r(o(s.prototype),"addChild",this).call(this,this._content=new k)}},{key:"addChild",value:function(t){return t.on(e.Event.RESIZE,this,this.onResize),this._setScrollChanged(),this._content.addChild(t)}},{key:"onResize",value:function(){this._setScrollChanged()}},{key:"addChildAt",value:function(t,i){return t.on(e.Event.RESIZE,this,this.onResize),this._setScrollChanged(),this._content.addChildAt(t,i)}},{key:"removeChild",value:function(t){return t.off(e.Event.RESIZE,this,this.onResize),this._setScrollChanged(),this._content.removeChild(t)}},{key:"removeChildAt",value:function(t){return this.getChildAt(t).off(e.Event.RESIZE,this,this.onResize),this._setScrollChanged(),this._content.removeChildAt(t)}},{key:"removeChildren",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2147483647;return this._content.removeChildren(t,e),this._setScrollChanged(),this}},{key:"getChildAt",value:function(t){return this._content.getChildAt(t)}},{key:"getChildByName",value:function(t){return this._content.getChildByName(t)}},{key:"getChildIndex",value:function(t){return this._content.getChildIndex(t)}},{key:"changeScroll",value:function(){this._scrollChanged=!1;var t=this.contentWidth||1,e=this.contentHeight||1,i=this._vScrollBar,s=this._hScrollBar,n=i&&e>this._height,h=s&&t>this._width,a=n?this._width-i.width:this._width,r=h?this._height-s.height:this._height;i&&(i.x=this._width-i.width,i.y=0,i.height=this._height-(h?s.height:0),i.scrollSize=Math.max(.033*this._height,1),i.thumbPercent=r/e,i.setScroll(0,e-r,i.value)),s&&(s.x=0,s.y=this._height-s.height,s.width=this._width-(n?i.width:0),s.scrollSize=Math.max(.033*this._width,1),s.thumbPercent=a/t,s.setScroll(0,t-a,s.value))}},{key:"_sizeChanged",value:function(){r(o(s.prototype),"_sizeChanged",this).call(this),this.setContentSize(this._width,this._height)}},{key:"setContentSize",value:function(t,i){var s=this._content;s.width=t,s.height=i,s._style.scrollRect||(s.scrollRect=e.Rectangle.create()),s._style.scrollRect.setTo(0,0,t,i),s.scrollRect=s.scrollRect}},{key:"onScrollBarChange",value:function(t){var e=this._content._style.scrollRect;if(e){var i=Math.round(t.value);t.isVertical?e.y=i:e.x=i,this._content.scrollRect=e}}},{key:"scrollTo",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.vScrollBar&&(this.vScrollBar.value=e),this.hScrollBar&&(this.hScrollBar.value=t)}},{key:"refresh",value:function(){this.changeScroll()}},{key:"onScrollStart",value:function(){this._usedCache||(this._usedCache=r(o(s.prototype),"cacheAs",this)),i(o(s.prototype),"cacheAs","none",this,!0),this._hScrollBar&&this._hScrollBar.once(e.Event.END,this,this.onScrollEnd),this._vScrollBar&&this._vScrollBar.once(e.Event.END,this,this.onScrollEnd)}},{key:"onScrollEnd",value:function(){i(o(s.prototype),"cacheAs",this._usedCache,this,!0)}},{key:"_setScrollChanged",value:function(){this._scrollChanged||(this._scrollChanged=!0,this.callLater(this.changeScroll))}},{key:"numChildren",get:function(){return this._content.numChildren}},{key:"contentWidth",get:function(){for(var t=0,e=this._content.numChildren-1;e>-1;e--){var i=this._content.getChildAt(e);t=Math.max(i._x+i.width*i.scaleX-i.pivotX,t)}return t}},{key:"contentHeight",get:function(){for(var t=0,e=this._content.numChildren-1;e>-1;e--){var i=this._content.getChildAt(e);t=Math.max(i._y+i.height*i.scaleY-i.pivotY,t)}return t}},{key:"width",set:function(t){i(o(s.prototype),"width",t,this,!0),this._setScrollChanged()},get:function(){return r(o(s.prototype),"width",this)}},{key:"height",set:function(t){i(o(s.prototype),"height",t,this,!0),this._setScrollChanged()},get:function(){return r(o(s.prototype),"height",this)}},{key:"vScrollBarSkin",get:function(){return this._vScrollBar?this._vScrollBar.skin:null},set:function(t){null==this._vScrollBar&&(r(o(s.prototype),"addChild",this).call(this,this._vScrollBar=new E),this._vScrollBar.on(e.Event.CHANGE,this,this.onScrollBarChange,[this._vScrollBar]),this._vScrollBar.target=this._content,this._vScrollBar.elasticDistance=this._elasticEnabled?200:0,this._setScrollChanged()),this._vScrollBar.skin=t}},{key:"hScrollBarSkin",get:function(){return this._hScrollBar?this._hScrollBar.skin:null},set:function(t){null==this._hScrollBar&&(r(o(s.prototype),"addChild",this).call(this,this._hScrollBar=new I),this._hScrollBar.on(e.Event.CHANGE,this,this.onScrollBarChange,[this._hScrollBar]),this._hScrollBar.target=this._content,this._hScrollBar.elasticDistance=this._elasticEnabled?200:0,this._setScrollChanged()),this._hScrollBar.skin=t}},{key:"vScrollBar",get:function(){return this._vScrollBar}},{key:"hScrollBar",get:function(){return this._hScrollBar}},{key:"content",get:function(){return this._content}},{key:"cacheAs",set:function(t){i(o(s.prototype),"cacheAs",t,this,!0),this._usedCache=null,"none"!==t?(this._hScrollBar&&this._hScrollBar.on(e.Event.START,this,this.onScrollStart),this._vScrollBar&&this._vScrollBar.on(e.Event.START,this,this.onScrollStart)):(this._hScrollBar&&this._hScrollBar.off(e.Event.START,this,this.onScrollStart),this._vScrollBar&&this._vScrollBar.off(e.Event.START,this,this.onScrollStart))},get:function(){return r(o(s.prototype),"cacheAs",this)}},{key:"elasticEnabled",get:function(){return this._elasticEnabled},set:function(t){this._elasticEnabled=t,this._vScrollBar&&(this._vScrollBar.elasticDistance=t?200:0),this._hScrollBar&&(this._hScrollBar.elasticDistance=t?200:0)}}]),s}();e.ILaya.regClass(Y),e.ClassUtils.regClass("laya.ui.Panel",Y),e.ClassUtils.regClass("Laya.Panel",Y);var X=function(t){function e(){return c(this,e),h(this,o(e).apply(this,arguments))}return u(e,L),e}();e.ILaya.regClass(X),e.ClassUtils.regClass("laya.ui.VSlider",X),e.ClassUtils.regClass("Laya.VSlider",X);var W=function(t){function s(){var t;return c(this,s),(t=h(this,o(s).call(this)))._spaceLeft=10,t._spaceBottom=0,t._keepStatus=!0,t.width=t.height=200,t}return u(s,k),n(s,[{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];r(o(s.prototype),"destroy",this).call(this,t),this._list&&this._list.destroy(t),this._list=null,this._source=null,this._renderHandler=null}},{key:"createChildren",value:function(){this.addChild(this._list=new B),this._list.renderHandler=e.Handler.create(this,this.renderItem,null,!1),this._list.repeatX=1,this._list.on(e.Event.CHANGE,this,this.onListChange)}},{key:"onListChange",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0],this.event(e.Event.CHANGE)}},{key:"getArray",value:function(){var t=[];for(var e in this._source){var i=this._source[e];this.getParentOpenStatus(i)&&(i.x=this._spaceLeft*this.getDepth(i),t.push(i))}return t}},{key:"getDepth",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return null==t.nodeParent?e:this.getDepth(t.nodeParent,e+1)}},{key:"getParentOpenStatus",value:function(t){var e=t.nodeParent;return null==e||!!e.isOpen&&(null==e.nodeParent||this.getParentOpenStatus(e))}},{key:"renderItem",value:function(t,i){var s=t.dataSource;if(s){t.left=s.x;var n=t.getChildByName("arrow");n&&(s.hasChild?(n.visible=!0,n.index=s.isOpen?1:0,n.tag=i,n.off(e.Event.CLICK,this,this.onArrowClick),n.on(e.Event.CLICK,this,this.onArrowClick)):n.visible=!1);var h=t.getChildByName("folder");h&&(2==h.clipY?h.index=s.isDirectory?0:1:h.index=s.isDirectory?s.isOpen?1:0:2),this._renderHandler&&this._renderHandler.runWith([t,i])}}},{key:"onArrowClick",value:function(t){var i=t.currentTarget.tag;this._list.array[i].isOpen=!this._list.array[i].isOpen,this.event(e.Event.OPEN),this._list.array=this.getArray()}},{key:"setItemState",value:function(t,e){this._list.array[t]&&(this._list.array[t].isOpen=e,this._list.array=this.getArray())}},{key:"fresh",value:function(){this._list.array=this.getArray(),this.repaint()}},{key:"parseXml",value:function(t,e,i,s){var n,h=t.childNodes,a=h.length;if(!s){n={};var r=t.attributes;for(var l in r){var o=r[l],u=o.nodeName,c=o.nodeValue;n[u]="true"==c||"false"!=c&&c}n.nodeParent=i,a>0&&(n.isDirectory=!0),n.hasChild=a>0,e.push(n)}for(var _=0;_<a;_++){var d=h[_];this.parseXml(d,e,n,!1)}}},{key:"parseOpenStatus",value:function(t,e){for(var i=0,s=e.length;i<s;i++){var n=e[i];if(n.isDirectory)for(var h=0,a=t.length;h<a;h++){var r=t[h];if(r.isDirectory&&this.isSameParent(r,n)&&n.label==r.label){n.isOpen=r.isOpen;break}}}}},{key:"isSameParent",value:function(t,e){return null==t.nodeParent&&null==e.nodeParent||null!=t.nodeParent&&null!=e.nodeParent&&t.nodeParent.label==e.nodeParent.label&&this.isSameParent(t.nodeParent,e.nodeParent)}},{key:"filter",value:function(t){if(Boolean(t)){var e=[];this.getFilterSource(this._source,e,t),this._list.array=e}else this._list.array=this.getArray()}},{key:"getFilterSource",value:function(t,e,i){i=i.toLocaleLowerCase();var s=!0,n=!1,h=void 0;try{for(var a,r=t[Symbol.iterator]();!(s=(a=r.next()).done);s=!0){var l=a.value;!l.isDirectory&&String(l.label).toLowerCase().indexOf(i)>-1&&(l.x=0,e.push(l)),l.child&&l.child.length>0&&this.getFilterSource(l.child,e,i)}}catch(t){n=!0,h=t}finally{try{s||null==r.return||r.return()}finally{if(n)throw h}}}},{key:"keepStatus",get:function(){return this._keepStatus},set:function(t){this._keepStatus=t}},{key:"array",get:function(){return this._list.array},set:function(t){this._keepStatus&&this._list.array&&t&&this.parseOpenStatus(this._list.array,t),this._source=t,this._list.array=this.getArray()}},{key:"source",get:function(){return this._source}},{key:"list",get:function(){return this._list}},{key:"itemRender",get:function(){return this._list.itemRender},set:function(t){this._list.itemRender=t}},{key:"scrollBarSkin",get:function(){return this._list.vScrollBarSkin},set:function(t){this._list.vScrollBarSkin=t}},{key:"scrollBar",get:function(){return this._list.scrollBar}},{key:"mouseHandler",get:function(){return this._list.mouseHandler},set:function(t){this._list.mouseHandler=t}},{key:"renderHandler",get:function(){return this._renderHandler},set:function(t){this._renderHandler=t}},{key:"spaceLeft",get:function(){return this._spaceLeft},set:function(t){this._spaceLeft=t}},{key:"spaceBottom",get:function(){return this._list.spaceY},set:function(t){this._list.spaceY=t}},{key:"selectedIndex",get:function(){return this._list.selectedIndex},set:function(t){this._list.selectedIndex=t}},{key:"selectedItem",get:function(){return this._list.selectedItem},set:function(t){this._list.selectedItem=t}},{key:"width",set:function(t){i(o(s.prototype),"width",t,this,!0),this._list.width=t},get:function(){return r(o(s.prototype),"width",this)}},{key:"height",set:function(t){i(o(s.prototype),"height",t,this,!0),this._list.height=t},get:function(){return r(o(s.prototype),"height",this)}},{key:"dataSource",set:function(t){this._dataSource=t,i(o(s.prototype),"dataSource",t,this,!0)},get:function(){return r(o(s.prototype),"dataSource",this)}},{key:"xml",set:function(t){var e=[];this.parseXml(t.childNodes[0],e,null,!0),this.array=e}},{key:"selectedPath",get:function(){return this._list.selectedItem?this._list.selectedItem.path:null}}]),s}();e.ILaya.regClass(W),e.ClassUtils.regClass("laya.ui.Tree",W),e.ClassUtils.regClass("Laya.Tree",W);var G=function(t){function i(){var t;return c(this,i),(t=h(this,o(i).apply(this,arguments)))._space=0,t._align="none",t._itemChanged=!1,t}return u(i,k),n(i,[{key:"addChild",value:function(t){return t.on(e.Event.RESIZE,this,this.onResize),this._setItemChanged(),r(o(i.prototype),"addChild",this).call(this,t)}},{key:"onResize",value:function(t){this._setItemChanged()}},{key:"addChildAt",value:function(t,s){return t.on(e.Event.RESIZE,this,this.onResize),this._setItemChanged(),r(o(i.prototype),"addChildAt",this).call(this,t,s)}},{key:"removeChildAt",value:function(t){return this.getChildAt(t).off(e.Event.RESIZE,this,this.onResize),this._setItemChanged(),r(o(i.prototype),"removeChildAt",this).call(this,t)}},{key:"refresh",value:function(){this._setItemChanged()}},{key:"changeItems",value:function(){this._itemChanged=!1}},{key:"sortItem",value:function(t){t&&t.sort(function(t,e){return t.y-e.y})}},{key:"_setItemChanged",value:function(){this._itemChanged||(this._itemChanged=!0,this.callLater(this.changeItems))}},{key:"space",get:function(){return this._space},set:function(t){this._space=t,this._setItemChanged()}},{key:"align",get:function(){return this._align},set:function(t){this._align=t,this._setItemChanged()}}]),i}();e.ILaya.regClass(G),e.ClassUtils.regClass("laya.ui.LayoutBox",G),e.ClassUtils.regClass("Laya.LayoutBox",G);var V=function(t){function e(){return c(this,e),h(this,o(e).apply(this,arguments))}return u(e,G),n(e,[{key:"sortItem",value:function(t){t&&t.sort(function(t,e){return t.x-e.x})}},{key:"changeItems",value:function(){this._itemChanged=!1;for(var t=[],i=0,s=0,n=this.numChildren;s<n;s++){var h=this.getChildAt(s);h&&(t.push(h),i=this._height?this._height:Math.max(i,h.height*h.scaleY))}this.sortItem(t);var a=0;for(s=0,n=t.length;s<n;s++)(h=t[s]).x=a,a+=h.width*h.scaleX+this._space,this._align==e.TOP?h.y=0:this._align==e.MIDDLE?h.y=.5*(i-h.height*h.scaleY):this._align==e.BOTTOM&&(h.y=i-h.height*h.scaleY);this._sizeChanged()}},{key:"height",set:function(t){this._height!=t&&(i(o(e.prototype),"height",t,this,!0),this.callLater(this.changeItems))},get:function(){return r(o(e.prototype),"height",this)}}]),e}();V.NONE="none",V.TOP="top",V.MIDDLE="middle",V.BOTTOM="bottom",e.ILaya.regClass(V),e.ClassUtils.regClass("laya.ui.HBox",V),e.ClassUtils.regClass("Laya.HBox",V);var F=function(t){function e(){return c(this,e),h(this,o(e).apply(this,arguments))}return u(e,G),n(e,[{key:"changeItems",value:function(){this._itemChanged=!1;for(var t=[],i=0,s=0,n=this.numChildren;s<n;s++){var h=this.getChildAt(s);h&&(t.push(h),i=this._width?this._width:Math.max(i,h.width*h.scaleX))}this.sortItem(t);var a=0;for(s=0,n=t.length;s<n;s++)(h=t[s]).y=a,a+=h.height*h.scaleY+this._space,this._align==e.LEFT?h.x=0:this._align==e.CENTER?h.x=.5*(i-h.width*h.scaleX):this._align==e.RIGHT&&(h.x=i-h.width*h.scaleX);this._sizeChanged()}},{key:"width",set:function(t){this._width!=t&&(i(o(e.prototype),"width",t,this,!0),this.callLater(this.changeItems))},get:function(){return r(o(e.prototype),"width",this)}}]),e}();F.NONE="none",F.LEFT="left",F.CENTER="center",F.RIGHT="right",e.ILaya.regClass(F),e.ClassUtils.regClass("laya.ui.VBox",F),e.ClassUtils.regClass("Laya.VBox",F);var j=function(t){function s(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return c(this,s),(t=h(this,o(s).call(this)))._valueArr="",t._indexMap=null,t._sheet=null,t._direction="horizontal",t._spaceX=0,t._spaceY=0,t._align="left",t._wordsW=0,t._wordsH=0,e&&(t.skin=e),i&&(t.sheet=i),t}return u(s,S),n(s,[{key:"createChildren",value:function(){this._bitmap=new _,this.on(e.Event.LOADED,this,this._onClipLoaded)}},{key:"_onClipLoaded",value:function(){this.callLater(this.changeValue)}},{key:"changeValue",value:function(){var t;if(this._sources&&this._valueArr&&(this.graphics.clear(!0),t=this._sources[0])){var e="horizontal"===this._direction;e?(this._wordsW=this._valueArr.length*(t.sourceWidth+this.spaceX),this._wordsH=t.sourceHeight):(this._wordsW=t.sourceWidth,this._wordsH=(t.sourceHeight+this.spaceY)*this._valueArr.length);var i=0;if(this._width)switch(this._align){case"center":i=.5*(this._width-this._wordsW);break;case"right":i=this._width-this._wordsW;break;default:i=0}for(var s=0,n=this._valueArr.length;s<n;s++){var h=this._indexMap[this._valueArr.charAt(s)];this.sources[h]&&(t=this.sources[h],e?this.graphics.drawImage(t,i+s*(t.sourceWidth+this.spaceX),0,t.sourceWidth,t.sourceHeight):this.graphics.drawImage(t,0+i,s*(t.sourceHeight+this.spaceY),t.sourceWidth,t.sourceHeight))}this._width||(this._widget.resetLayoutX(),this.callLater(this._sizeChanged)),this._height||(this._widget.resetLayoutY(),this.callLater(this._sizeChanged))}}},{key:"measureWidth",value:function(){return this._wordsW}},{key:"measureHeight",value:function(){return this._wordsH}},{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._valueArr=null,this._indexMap=null,this.graphics.clear(!0),this.removeSelf(),this.off(e.Event.LOADED,this,this._onClipLoaded),r(o(s.prototype),"destroy",this).call(this,t)}},{key:"sheet",get:function(){return this._sheet},set:function(t){t+="",this._sheet=t;var e=t.split(" ");this._clipX=String(e[0]).length,this.clipY=e.length,this._indexMap={};for(var i=0;i<this._clipY;i++)for(var s=e[i].split(""),n=0,h=s.length;n<h;n++)this._indexMap[s[n]]=i*this._clipX+n}},{key:"value",get:function(){return this._valueArr?this._valueArr:""},set:function(t){t+="",this._valueArr=t,this.callLater(this.changeValue)}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction=t,this.callLater(this.changeValue)}},{key:"spaceX",get:function(){return this._spaceX},set:function(t){this._spaceX=t,"horizontal"===this._direction&&this.callLater(this.changeValue)}},{key:"spaceY",get:function(){return this._spaceY},set:function(t){this._spaceY=t,"horizontal"!==this._direction&&this.callLater(this.changeValue)}},{key:"align",set:function(t){this._align=t,this.callLater(this.changeValue)},get:function(){return this._align}},{key:"width",set:function(t){i(o(s.prototype),"width",t,this,!0),this.callLater(this.changeValue)},get:function(){return r(o(s.prototype),"width",this)}},{key:"height",set:function(t){i(o(s.prototype),"height",t,this,!0),this.callLater(this.changeValue)},get:function(){return r(o(s.prototype),"height",this)}}]),s}();e.ILaya.regClass(j),e.ClassUtils.regClass("laya.ui.FontClip",j),e.ClassUtils.regClass("Laya.FontClip",j);var $=function(t){function i(){var t;return c(this,i),(t=h(this,o(i).call(this,!1)))._watchMap={},t._anchorX=NaN,t._anchorY=NaN,t._widget=d.EMPTY,t.createChildren(),t}return u(i,e.Scene),n(i,[{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._watchMap=null,r(o(i.prototype),"destroy",this).call(this,t)}},{key:"changeData",value:function(t){var e=this._watchMap[t];if(e)for(var i=0,s=e.length;i<s;i++)e[i].exe(this)}},{key:"_sizeChanged",value:function(){isNaN(this._anchorX)||(this.pivotX=this.anchorX*this.width),isNaN(this._anchorY)||(this.pivotY=this.anchorY*this.height),this.event(e.Event.RESIZE)}},{key:"_getWidget",value:function(){return this._widget===d.EMPTY&&(this._widget=this.addComponent(d)),this._widget}},{key:"loadUI",value:function(t){var e=i.uiMap[t];i.uiMap&&this.createView(e)}},{key:"top",get:function(){return this._widget.top},set:function(t){t!=this._widget.top&&(this._getWidget().top=t)}},{key:"bottom",get:function(){return this._widget.bottom},set:function(t){t!=this._widget.bottom&&(this._getWidget().bottom=t)}},{key:"left",get:function(){return this._widget.left},set:function(t){t!=this._widget.left&&(this._getWidget().left=t)}},{key:"right",get:function(){return this._widget.right},set:function(t){t!=this._widget.right&&(this._getWidget().right=t)}},{key:"centerX",get:function(){return this._widget.centerX},set:function(t){t!=this._widget.centerX&&(this._getWidget().centerX=t)}},{key:"centerY",get:function(){return this._widget.centerY},set:function(t){t!=this._widget.centerY&&(this._getWidget().centerY=t)}},{key:"anchorX",get:function(){return this._anchorX},set:function(t){this._anchorX!=t&&(this._anchorX=t,this.callLater(this._sizeChanged))}},{key:"anchorY",get:function(){return this._anchorY},set:function(t){this._anchorY!=t&&(this._anchorY=t,this.callLater(this._sizeChanged))}},{key:"dataSource",get:function(){return this._dataSource},set:function(t){for(var e in this._dataSource=t,t){var i=this.getChildByName(e);i instanceof y?i.dataSource=t[e]:e in this&&!(this[e]instanceof Function)&&(this[e]=t[e])}}}],[{key:"__init__",value:function(){e.ILaya.ClassUtils.regShortClassName([A,C,P,b,k,N,m,S,M,y,I,R,v,w,B,Y,O,T,z,x,L,D,H,i,E,X,W,V,F,e.Animation,e.Text,j])}},{key:"regComponent",value:function(t,i){e.ILaya.ClassUtils.regClass(t,i)}},{key:"regViewRuntime",value:function(t,i){e.ILaya.ClassUtils.regClass(t,i)}},{key:"regUI",value:function(t,i){e.ILaya.loader.cacheRes(t,i)}}]),i}();$.uiMap={},e.ILaya.regClass($),e.ClassUtils.regClass("laya.ui.View",$),e.ClassUtils.regClass("Laya.View",$);var Z=function t(){c(this,t)};Z.Dialog=null;var K=function(t){function i(){var t;return c(this,i),(t=h(this,o(i).call(this))).maskLayer=new e.Sprite,t.popupEffect=function(i){i.scale(1,1),i._effectTween=e.Tween.from(i,{x:e.ILaya.stage.width/2,y:e.ILaya.stage.height/2,scaleX:0,scaleY:0},300,e.Ease.backOut,e.Handler.create(a(t),t.doOpen,[i]),0,!1,!1)},t.closeEffect=function(i){i._effectTween=e.Tween.to(i,{x:e.ILaya.stage.width/2,y:e.ILaya.stage.height/2,scaleX:0,scaleY:0},300,e.Ease.strongOut,e.Handler.create(a(t),t.doClose,[i]),0,!1,!1)},t.popupEffectHandler=new e.Handler(a(t),t.popupEffect),t.closeEffectHandler=new e.Handler(a(t),t.closeEffect),t.mouseEnabled=t.maskLayer.mouseEnabled=!0,t.zOrder=1e3,e.ILaya.stage.addChild(a(t)),e.ILaya.stage.on(e.Event.RESIZE,a(t),t._onResize),s.closeDialogOnSide&&t.maskLayer.on("click",a(t),t._closeOnSide),t._onResize(null),t}return u(i,e.Sprite),n(i,[{key:"_closeOnSide",value:function(){var t=this.getChildAt(this.numChildren-1);t instanceof Z.Dialog&&t.close()}},{key:"setLockView",value:function(t){this.lockLayer||(this.lockLayer=new k,this.lockLayer.mouseEnabled=!0,this.lockLayer.size(e.ILaya.stage.width,e.ILaya.stage.height)),this.lockLayer.removeChildren(),t&&(t.centerX=t.centerY=0,this.lockLayer.addChild(t))}},{key:"_onResize",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];var t=this.maskLayer.width=e.ILaya.stage.width,i=this.maskLayer.height=e.ILaya.stage.height;this.lockLayer&&this.lockLayer.size(t,i),this.maskLayer.graphics.clear(!0),this.maskLayer.graphics.drawRect(0,0,t,i,s.popupBgColor),this.maskLayer.alpha=s.popupBgAlpha;for(var n=this.numChildren-1;n>-1;n--){var h=this.getChildAt(n);h.isPopupCenter&&this._centerDialog(h)}}},{key:"_centerDialog",value:function(t){t.x=Math.round((e.ILaya.stage.width-t.width>>1)+t.pivotX),t.y=Math.round((e.ILaya.stage.height-t.height>>1)+t.pivotY)}},{key:"open",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];i&&this._closeAll(),this._clearDialogEffect(t),t.isPopupCenter&&this._centerDialog(t),this.addChild(t),(t.isModal||this._getBit(e.Const.HAS_ZORDER))&&e.ILaya.timer.callLater(this,this._checkMask),s&&null!=t.popupEffect?t.popupEffect.runWith(t):this.doOpen(t),this.event(e.Event.OPEN)}},{key:"_clearDialogEffect",value:function(t){t._effectTween&&(e.Tween.clear(t._effectTween),t._effectTween=null)}},{key:"doOpen",value:function(t){t.onOpened(t._param)}},{key:"lock",value:function(t){this.lockLayer&&(t?this.addChild(this.lockLayer):this.lockLayer.removeSelf())}},{key:"close",value:function(t){this._clearDialogEffect(t),t.isShowEffect&&null!=t.closeEffect?t.closeEffect.runWith([t]):this.doClose(t),this.event(e.Event.CLOSE)}},{key:"doClose",value:function(t){t.removeSelf(),t.isModal&&this._checkMask(),t.closeHandler&&t.closeHandler.runWith(t.closeType),t.onClosed(t.closeType),t.autoDestroyAtClosed&&t.destroy()}},{key:"closeAll",value:function(){this._closeAll(),this.event(e.Event.CLOSE)}},{key:"_closeAll",value:function(){for(var t=this.numChildren-1;t>-1;t--){var e=this.getChildAt(t);e&&null!=e.close&&this.doClose(e)}}},{key:"getDialogsByGroup",value:function(t){for(var e=[],i=this.numChildren-1;i>-1;i--){var s=this.getChildAt(i);s&&s.group===t&&e.push(s)}return e}},{key:"closeByGroup",value:function(t){for(var e=[],i=this.numChildren-1;i>-1;i--){var s=this.getChildAt(i);s&&s.group===t&&(s.close(),e.push(s))}return e}},{key:"_checkMask",value:function(){this.maskLayer.removeSelf();for(var t=this.numChildren-1;t>-1;t--){var e=this.getChildAt(t);if(e&&e.isModal)return void this.addChildAt(this.maskLayer,t)}}}]),i}();e.ClassUtils.regClass("laya.ui.DialogManager",K),e.ClassUtils.regClass("Laya.DialogManager",K);var q=function(t){function s(){var t;return c(this,s),(t=h(this,o(s).call(this))).isShowEffect=!0,t.isPopupCenter=!0,t.popupEffect=s.manager.popupEffectHandler,t.closeEffect=s.manager.closeEffectHandler,t._dealDragArea(),t.on(e.Event.CLICK,a(t),t._onClick),t}return u(s,$),n(s,[{key:"_dealDragArea",value:function(){var t=this.getChildByName("drag");t&&(this.dragArea=t._x+","+t._y+","+t.width+","+t.height,t.removeSelf())}},{key:"_onMouseDown",value:function(t){var e=this.getMousePoint();this._dragArea.contains(e.x,e.y)?this.startDrag():this.stopDrag()}},{key:"_onClick",value:function(t){var e=t.target;if(e)switch(e.name){case s.CLOSE:case s.CANCEL:case s.SURE:case s.NO:case s.OK:case s.YES:return void this.close(e.name)}}},{key:"open",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this._dealDragArea(),this._param=e,s.manager.open(this,t,this.isShowEffect),s.manager.lock(!1)}},{key:"close",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.closeType=t,s.manager.close(this)}},{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.closeHandler=null,this.popupEffect=null,this.closeEffect=null,this._dragArea=null,r(o(s.prototype),"destroy",this).call(this,t)}},{key:"show",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._open(!1,t,e)}},{key:"popup",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._open(!0,t,e)}},{key:"_open",value:function(t,e,i){this.isModal=t,this.isShowEffect=i,s.manager.lock(!0),this.open(e)}},{key:"dragArea",get:function(){return this._dragArea?this._dragArea.toString():null},set:function(t){if(t){var i=f.fillArray([0,0,0,0],t,Number);this._dragArea=new e.Rectangle(i[0],i[1],i[2],i[3]),this.on(e.Event.MOUSE_DOWN,this,this._onMouseDown)}else this._dragArea=null,this.off(e.Event.MOUSE_DOWN,this,this._onMouseDown)}},{key:"isPopup",get:function(){return null!=this.parent}},{key:"zOrder",set:function(t){i(o(s.prototype),"zOrder",t,this,!0),s.manager._checkMask()},get:function(){return r(o(s.prototype),"zOrder",this)}}],[{key:"setLockView",value:function(t){s.manager.setLockView(t)}},{key:"lock",value:function(t){s.manager.lock(t)}},{key:"closeAll",value:function(){s.manager.closeAll()}},{key:"getDialogsByGroup",value:function(t){return s.manager.getDialogsByGroup(t)}},{key:"closeByGroup",value:function(t){return s.manager.closeByGroup(t)}},{key:"manager",get:function(){return s._manager=s._manager||new K},set:function(t){s._manager=t}}]),s}();q.CLOSE="close",q.CANCEL="cancel",q.SURE="sure",q.NO="no",q.YES="yes",q.OK="ok",Z.Dialog=q,e.ILaya.regClass(q),e.ClassUtils.regClass("laya.ui.Dialog",q),e.ClassUtils.regClass("Laya.Dialog",q);var J=function(t){function i(){var t;return c(this,i),(t=h(this,o(i).call(this)))._tipBox=new y,t._tipBox.addChild(t._tipText=new e.Text),t._tipText.x=t._tipText.y=5,t._tipText.color=i.tipTextColor,t._defaultTipHandler=t._showDefaultTip,e.ILaya.stage.on(g.SHOW_TIP,a(t),t._onStageShowTip),e.ILaya.stage.on(g.HIDE_TIP,a(t),t._onStageHideTip),t.zOrder=1100,t}return u(i,y),n(i,[{key:"_onStageHideTip",value:function(t){e.ILaya.timer.clear(this,this._showTip),this.closeAll(),this.removeSelf()}},{key:"_onStageShowTip",value:function(t){e.ILaya.timer.once(i.tipDelay,this,this._showTip,[t],!0)}},{key:"_showTip",value:function(t){if("string"==typeof t){var i=String(t);Boolean(i)&&this._defaultTipHandler(i)}else t instanceof e.Handler?t.run():t instanceof Function&&t.apply();e.ILaya.stage.on(e.Event.MOUSE_MOVE,this,this._onStageMouseMove),e.ILaya.stage.on(e.Event.MOUSE_DOWN,this,this._onStageMouseDown),this._onStageMouseMove(null)}},{key:"_onStageMouseDown",value:function(t){this.closeAll()}},{key:"_onStageMouseMove",value:function(t){this._showToStage(this,i.offsetX,i.offsetY)}},{key:"_showToStage",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=t.getBounds();t.x=e.ILaya.stage.mouseX+i,t.y=e.ILaya.stage.mouseY+s,t._x+n.width>e.ILaya.stage.width&&(t.x-=n.width+i),t._y+n.height>e.ILaya.stage.height&&(t.y-=n.height+s)}},{key:"closeAll",value:function(){e.ILaya.timer.clear(this,this._showTip),e.ILaya.stage.off(e.Event.MOUSE_MOVE,this,this._onStageMouseMove),e.ILaya.stage.off(e.Event.MOUSE_DOWN,this,this._onStageMouseDown),this.removeChildren()}},{key:"showDislayTip",value:function(t){this.addChild(t),this._showToStage(this),e.ILaya.stage.addChild(this)}},{key:"_showDefaultTip",value:function(t){this._tipText.text=t;var s=this._tipBox.graphics;s.clear(!0),s.drawRect(0,0,this._tipText.width+10,this._tipText.height+10,i.tipBackColor),this.addChild(this._tipBox),this._showToStage(this),e.ILaya.stage.addChild(this)}},{key:"defaultTipHandler",get:function(){return this._defaultTipHandler},set:function(t){this._defaultTipHandler=t}}]),i}();J.offsetX=10,J.offsetY=15,J.tipTextColor="#ffffff",J.tipBackColor="#111111",J.tipDelay=200,e.ILaya.regClass(J),e.ClassUtils.regClass("laya.ui.TipManager",J),e.ClassUtils.regClass("Laya.TipManager",J);var Q=function(){function t(){c(this,t)}return n(t,null,[{key:"__init__",value:function(){}}]),t}(),tt=function(t){function s(){var t;c(this,s),(t=h(this,o(s).call(this)))._width=t._height=200;var i=new e.Texture;return i.bitmap=new e.Texture2D,t.texture=i,t}return u(s,y),n(s,[{key:"onEnable",value:function(){this.postMsg({type:"display",rate:e.Laya.stage.frameRate}),window.wx&&window.sharedCanvas&&e.Laya.timer.frameLoop(1,this,this._onLoop)}},{key:"onDisable",value:function(){this.postMsg({type:"undisplay"}),e.Laya.timer.clear(this,this._onLoop)}},{key:"_onLoop",value:function(){var t=window.sharedCanvas;this.texture.sourceWidth=t.width,this.texture.sourceHeight=t.height,this.texture.bitmap.loadImageSource(t)}},{key:"_postMsg",value:function(){var t=new e.Matrix;t.translate(this.x,this.y);var i=e.Laya.stage;t.scale(i._canvasTransform.getScaleX()*this.globalScaleX*i.transform.getScaleX(),i._canvasTransform.getScaleY()*this.globalScaleY*i.transform.getScaleY()),this.postMsg({type:"changeMatrix",a:t.a,b:t.b,c:t.c,d:t.d,tx:t.tx,ty:t.ty,w:this.width,h:this.height})}},{key:"postMsg",value:function(t){window.wx&&window.wx.getOpenDataContext&&window.wx.getOpenDataContext().postMessage(t)}},{key:"width",set:function(t){i(o(s.prototype),"width",t,this,!0),window.sharedCanvas&&(window.sharedCanvas.width=t),this.callLater(this._postMsg)},get:function(){return r(o(s.prototype),"width",this)}},{key:"height",set:function(t){i(o(s.prototype),"height",t,this,!0),window.sharedCanvas&&(window.sharedCanvas.height=t),this.callLater(this._postMsg)},get:function(){return r(o(s.prototype),"height",this)}},{key:"x",set:function(t){i(o(s.prototype),"x",t,this,!0),this.callLater(this._postMsg)},get:function(){return r(o(s.prototype),"x",this)}},{key:"y",set:function(t){i(o(s.prototype),"y",t,this,!0),this.callLater(this._postMsg)},get:function(){return r(o(s.prototype),"y",this)}}]),s}();e.ILaya.regClass(tt),e.ClassUtils.regClass("laya.ui.WXOpenDataViewer",tt),e.ClassUtils.regClass("Laya.WXOpenDataViewer",tt),t.AdvImage=p,t.AutoBitmap=_,t.Box=k,t.Button=C,t.CheckBox=m,t.Clip=S,t.ColorPicker=b,t.ComboBox=M,t.Dialog=q,t.DialogManager=K,t.FontClip=j,t.HBox=V,t.HScrollBar=I,t.HSlider=R,t.IUI=Z,t.Image=v,t.Label=w,t.LayoutBox=G,t.List=B,t.Panel=Y,t.ProgressBar=O,t.Radio=T,t.RadioGroup=z,t.ScaleBox=N,t.ScrollBar=x,t.Slider=L,t.Styles=l,t.Tab=D,t.TextArea=P,t.TextInput=H,t.TipManager=J,t.Tree=W,t.UIComponent=y,t.UIConfig=s,t.UIEvent=g,t.UIGroup=U,t.UILib=Q,t.UIUtils=f,t.VBox=F,t.VScrollBar=E,t.VSlider=X,t.View=$,t.ViewStack=A,t.WXOpenDataViewer=tt,t.Widget=d}(window.Laya=window.Laya||{},Laya)}(); 
 			}); 
	